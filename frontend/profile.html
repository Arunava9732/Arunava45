<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - BLACKONN | Manage Your Account</title>
    <meta name="description" content="Manage your BLACKONN account. View orders, track shipments, update profile settings and access your wishlist.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://blackonn.com/profile.html">
    <style>
        html { 
            background: #eef3f8;
            height: 100%;
        }
        body { 
            background: #eef3f8; 
            padding: 0 !important;
            min-height: 100%;
            overflow-x: hidden;
        }
        .nav {
            background: #eef3f8 !important;
        }
        .cart-count {
            display: none !important;
        }
        .cart-count.show {
            display: flex !important;
        }
        .logo img {
            width: 175px;
            height: 50px;
            margin-bottom: 15px;
        }
    </style>
    <link rel="shortcut icon" href="assets/img/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        /* Accessibility: Focus-visible states for keyboard navigation */
        *:focus-visible {
            outline: 2px solid #14b8a6;
            outline-offset: 2px;
        }
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #14b8a6;
            outline-offset: 2px;
        }
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #14b8a6;
            color: #fff;
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
            font-weight: 600;
            border-radius: 0 0 8px 0;
            transition: top 0.3s ease;
        }
        .skip-link:focus {
            top: 0;
        }
        
        .profile-container {
            min-height: 100vh;
            padding: 100px 5% 60px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 30px;
            padding: 40px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #666;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
        }

        .profile-avatar:hover .avatar-overlay {
            opacity: 1;
        }

        .profile-avatar .avatar-overlay i {
            font-size: 28px;
            color: #fff;
        }

        .profile-avatar input[type="file"] {
            display: none;
        }

        .profile-info h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }

        .profile-info p {
            color: #666;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .profile-info .member-since {
            font-size: 13px;
            color: #999;
        }

        .profile-actions {
            margin-left: auto;
            display: flex;
            gap: 15px;
        }

        .btn-edit {
            padding: 12px 25px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-edit:hover {
            background: #333;
            transform: translateY(-2px);
        }

        .btn-logout {
            padding: 12px 25px;
            background: #fff;
            color: #ff4444;
            border: 2px solid #ff4444;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #ff4444;
            color: #fff;
        }

        .btn-delete-account {
            padding: 12px 25px;
            background: #fff;
            color: #dc2626;
            border: 2px solid #dc2626;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete-account:hover {
            background: #dc2626;
            color: #fff;
        }

        /* Logout Popup */
        .logout-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .logout-popup-overlay.show {
            display: flex;
        }

        .logout-popup {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .logout-popup-icon {
            width: 70px;
            height: 70px;
            background: #fff3f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .logout-popup-icon i {
            font-size: 32px;
            color: #ff4444;
        }

        .logout-popup h3 {
            font-size: 22px;
            color: #000;
            margin-bottom: 10px;
        }

        .logout-popup p {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .logout-popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .logout-popup-buttons button {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm-logout {
            background: #ff4444;
            color: #fff;
            border: none;
        }

        .btn-confirm-logout:hover {
            background: #cc0000;
        }

        /* Success Popup */
        .success-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .success-popup-overlay.show {
            display: flex;
        }

        .success-popup {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease;
        }

        .success-popup-icon {
            width: 70px;
            height: 70px;
            background: #e8f5e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-popup-icon i {
            font-size: 32px;
            color: #4caf50;
        }

        .success-popup h3 {
            font-size: 22px;
            color: #000;
            margin-bottom: 10px;
        }

        .success-popup p {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .btn-success-ok {
            padding: 12px 40px;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success-ok:hover {
            background: #388e3c;
        }

        /* Address Modal */
        .address-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .address-modal-overlay.show {
            display: flex;
        }

        .address-modal {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .address-modal h3 {
            font-size: 20px;
            color: #000;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .address-modal .form-group {
            margin-bottom: 15px;
        }

        .address-modal .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 6px;
        }

        .address-modal .form-group input,
        .address-modal .form-group select,
        .address-modal .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .address-modal .form-group input:focus,
        .address-modal .form-group select:focus,
        .address-modal .form-group textarea:focus {
            outline: none;
            border-color: #000;
        }

        .address-modal .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .address-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .address-modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save-address {
            background: #000;
            color: #fff;
            border: none;
        }

        .btn-save-address:hover {
            background: #333;
        }

        /* Delete Confirmation Modal */
        .delete-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .delete-modal-overlay.show {
            display: flex;
        }

        .delete-modal {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease;
        }

        .delete-modal-icon {
            width: 70px;
            height: 70px;
            background: #fff3f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .delete-modal-icon i {
            font-size: 32px;
            color: #ff4444;
        }

        .delete-modal h3 {
            font-size: 20px;
            color: #000;
            margin-bottom: 10px;
        }

        .delete-modal p {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .delete-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .delete-modal-buttons button {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Return Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #000;
        }

        .modal-close {
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #000;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 25px;
            border-top: 1px solid #eee;
        }

        .return-order-info p {
            margin: 8px 0;
            font-size: 14px;
        }

        .return-items {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .return-item {
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .return-item:last-child {
            border-bottom: none;
        }

        .return-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .return-item-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .return-reason, .return-comments {
            margin-top: 20px;
        }

        .return-reason label, .return-comments label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000;
        }

        .return-reason select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .return-reason select:focus {
            border-color: #000;
            outline: none;
        }

        .return-comments textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
        }

        .return-comments textarea:focus {
            border-color: #000;
            outline: none;
        }

        .btn-cancel, .btn-submit {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #fff;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-cancel:hover {
            background: #f5f5f5;
        }

        .btn-submit {
            background: #000;
            color: #fff;
            border: none;
        }

        .btn-submit:hover {
            background: #333;
        }

        .address-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .address-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .address-label {
            font-weight: 600;
            font-size: 16px;
            color: #000;
            margin-bottom: 8px;
        }

        .address-details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .address-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit-address {
            padding: 8px 16px;
            background: #fff;
            color: #000;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit-address:hover {
            border-color: #000;
        }

        .btn-delete-address {
            padding: 8px 16px;
            background: #fff;
            color: #ff4444;
            border: 1px solid #ff4444;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete-address:hover {
            background: #ff4444;
            color: #fff;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        .profile-sidebar {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            color: #333;
            text-decoration: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover {
            background: #f5f5f5;
            color: #000;
        }

        .sidebar-menu a.active {
            background: #000;
            color: #fff;
        }

        .sidebar-menu a.active:hover {
            background: #333;
            color: #fff;
        }

        .sidebar-menu a.active:hover i {
            color: #fff;
        }

        .sidebar-menu a i {
            font-size: 20px;
        }

        .profile-main {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 24px;
        }

        /* Profile Section */
        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        .profile-form {
            display: grid;
            gap: 20px;
            max-width: 600px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .form-group input:disabled {
            background: #f5f5f5;
            color: #666;
        }

        .btn-save {
            padding: 14px 30px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: fit-content;
            margin: 10px 0 100px 0; /* Large bottom margin to clear bottom nav */
        }

        /* =====================================================
           BIOMETRIC SECTION - Modern Redesign
           ===================================================== */
        .bio-container {
            max-width: 640px;
            margin: 0 auto;
        }
        
        .bio-hero {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .bio-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 60%);
            pointer-events: none;
        }
        
        .bio-hero-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .bio-hero-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
        }
        
        .bio-hero-icon i {
            font-size: 36px;
            color: #fff;
        }
        
        .bio-hero-text h2 {
            color: #fff;
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px;
        }
        
        .bio-hero-text p {
            color: #94a3b8;
            font-size: 14px;
            margin: 0;
            line-height: 1.5;
        }
        
        .bio-status-card {
            background: #fff;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }
        
        .bio-status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .bio-status-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .bio-status-indicator {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .bio-status-indicator.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
        
        .bio-status-indicator.inactive {
            background: linear-gradient(135deg, #64748b, #475569);
        }
        
        .bio-status-indicator i {
            font-size: 24px;
            color: #fff;
        }
        
        .bio-status-text h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 4px;
        }
        
        .bio-status-text p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
        }
        
        .bio-toggle {
            position: relative;
            width: 60px;
            height: 32px;
        }
        
        .bio-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .bio-toggle-track {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #e2e8f0;
            border-radius: 32px;
            transition: all 0.3s ease;
        }
        
        .bio-toggle-track::before {
            content: '';
            position: absolute;
            height: 26px;
            width: 26px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .bio-toggle input:checked + .bio-toggle-track {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .bio-toggle input:checked + .bio-toggle-track::before {
            transform: translateX(28px);
        }
        
        .bio-devices-section {
            padding: 24px;
        }
        
        .bio-devices-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .bio-devices-header h5 {
            font-size: 15px;
            font-weight: 600;
            color: #334155;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bio-devices-count {
            background: #f1f5f9;
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .bio-devices-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .bio-device-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }
        
        .bio-device-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            transform: translateY(-1px);
        }
        
        .bio-device-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .bio-device-icon.fingerprint {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }
        
        .bio-device-icon.face {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .bio-device-icon i {
            font-size: 22px;
            color: #fff;
        }
        
        .bio-device-info {
            flex: 1;
            min-width: 0;
        }
        
        .bio-device-info h6 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .bio-device-info p {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }
        
        .bio-device-info .reauth-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fef3c7;
            color: #b45309;
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 6px;
            margin-top: 6px;
        }
        
        .bio-device-actions {
            display: flex;
            gap: 8px;
        }
        
        .bio-device-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .bio-device-btn.edit {
            background: #e0e7ff;
            color: #4f46e5;
        }
        
        .bio-device-btn.edit:hover {
            background: #c7d2fe;
        }
        
        .bio-device-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .bio-device-btn.delete:hover {
            background: #fecaca;
        }
        
        .bio-device-btn i {
            font-size: 16px;
        }
        
        .bio-empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .bio-empty-state i {
            font-size: 56px;
            color: #cbd5e1;
            margin-bottom: 16px;
        }
        
        .bio-empty-state p {
            color: #64748b;
            font-size: 14px;
            margin: 0;
        }
        
        .bio-add-section {
            padding: 0 24px 24px;
        }
        
        .bio-add-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        
        .bio-add-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        
        .bio-add-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .bio-add-btn i {
            font-size: 20px;
        }
        
        .bio-limit-text {
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .bio-limit-text i {
            color: #6366f1;
        }
        
        .bio-limit-text.warning {
            color: #dc2626;
        }
        
        .bio-limit-text.warning i {
            color: #dc2626;
        }
        
        .bio-tips-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
            border-radius: 16px;
            padding: 20px 24px;
        }
        
        .bio-tips-card h5 {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
            margin: 0 0 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bio-tips-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .bio-tips-list li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
            color: #0284c7;
            line-height: 1.4;
        }
        
        .bio-tips-list li i {
            color: #10b981;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 1px;
        }
        
        @media (max-width: 480px) {
            .bio-hero {
                padding: 24px;
            }
            
            .bio-hero-content {
                flex-direction: column;
                text-align: center;
            }
            
            .bio-hero-icon {
                width: 64px;
                height: 64px;
            }
            
            .bio-hero-icon i {
                font-size: 28px;
            }
            
            .bio-status-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .bio-status-left {
                justify-content: center;
            }
            
            .bio-toggle {
                align-self: center;
            }
            
            .bio-device-card {
                flex-wrap: wrap;
            }
            
            .bio-device-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 8px;
                padding-top: 12px;
                border-top: 1px solid #e2e8f0;
            }
        }

        /* =====================================================
           UNIVERSAL MODAL SYSTEM - Reusable for all dialogs
           ===================================================== */
        .uni-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        
        .uni-modal-overlay.show {
            display: flex;
            animation: uniModalFadeIn 0.25s ease;
        }
        
        @keyframes uniModalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .uni-modal {
            background: #fff;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            animation: uniModalSlideIn 0.3s ease;
        }
        
        @keyframes uniModalSlideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .uni-modal-header {
            padding: 24px 24px 0;
            text-align: center;
        }
        
        .uni-modal-icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        
        .uni-modal-icon.confirm {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }
        
        .uni-modal-icon.confirm i {
            color: #d97706;
            font-size: 32px;
        }
        
        .uni-modal-icon.danger {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
        }
        
        .uni-modal-icon.danger i {
            color: #dc2626;
            font-size: 32px;
        }
        
        .uni-modal-icon.input {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
        }
        
        .uni-modal-icon.input i {
            color: #6366f1;
            font-size: 32px;
        }
        
        .uni-modal-icon.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        }
        
        .uni-modal-icon.success i {
            color: #059669;
            font-size: 32px;
        }
        
        .uni-modal-icon.info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        }
        
        .uni-modal-icon.info i {
            color: #2563eb;
            font-size: 32px;
        }
        
        .uni-modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 8px;
        }
        
        .uni-modal-header p {
            font-size: 14px;
            color: #64748b;
            margin: 0;
            line-height: 1.5;
        }
        
        .uni-modal-body {
            padding: 20px 24px;
        }
        
        .uni-modal-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            color: #1e293b;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .uni-modal-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .uni-modal-input::placeholder {
            color: #94a3b8;
        }
        
        .uni-modal-footer {
            padding: 0 24px 24px;
            display: flex;
            gap: 12px;
        }
        
        .uni-modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .uni-modal-btn.cancel {
            background: #f1f5f9;
            color: #475569;
        }
        
        .uni-modal-btn.cancel:hover {
            background: #e2e8f0;
        }
        
        .uni-modal-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .uni-modal-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        
        .uni-modal-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .uni-modal-btn.danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        .uni-modal-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .uni-modal-btn.success:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        
        /* Mobile responsiveness for modal */
        @media (max-width: 480px) {
            .uni-modal-overlay {
                padding: 16px;
                align-items: flex-end;
            }
            
            .uni-modal {
                border-radius: 20px 20px 0 0;
                max-height: 85vh;
                animation: uniModalSlideUp 0.3s ease;
            }
            
            @keyframes uniModalSlideUp {
                from { 
                    opacity: 0;
                    transform: translateY(100%);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .uni-modal-header {
                padding: 20px 20px 0;
            }
            
            .uni-modal-icon {
                width: 64px;
                height: 64px;
            }
            
            .uni-modal-icon i {
                font-size: 28px !important;
            }
            
            .uni-modal-header h3 {
                font-size: 18px;
            }
            
            .uni-modal-body {
                padding: 16px 20px;
            }
            
            .uni-modal-footer {
                padding: 0 20px 20px;
                flex-direction: column-reverse;
            }
            
            .uni-modal-btn {
                padding: 16px 20px;
            }
        }

        /* Delete Account Modal */
        .delete-account-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .delete-account-modal-overlay.show {
            display: flex;
        }
        .delete-account-modal {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease;
        }
        .delete-account-modal-icon {
            width: 70px;
            height: 70px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        .delete-account-modal-icon i {
            font-size: 32px;
            color: #dc2626;
        }
        .delete-account-modal h3 {
            font-size: 22px;
            color: #dc2626;
            margin-bottom: 10px;
        }
        .delete-account-modal p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .delete-warning-list {
            text-align: left;
            background: #fef2f2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .delete-warning-list li {
            font-size: 13px;
            color: #991b1b;
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .delete-confirm-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .delete-confirm-input:focus {
            outline: none;
            border-color: #dc2626;
        }
        .delete-account-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .delete-account-buttons button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-cancel-delete {
            background: #f5f5f5;
            color: #333;
            border: none;
        }
        .btn-cancel-delete:hover {
            background: #e0e0e0;
        }
        .btn-confirm-delete {
            background: #dc2626;
            color: #fff;
            border: none;
        }
        .btn-confirm-delete:hover {
            background: #b91c1c;
        }
        .btn-confirm-delete:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* =====================================================
           PASSWORD CHANGE SECTION - Clean Minimal Design
           ===================================================== */
        .password-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            max-width: 520px;
            border: 1px solid #e5e7eb;
        }
        .password-card-header {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 50%, #2dd4bf 100%);
            padding: 24px;
            color: #fff;
        }
        .password-card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .password-card-header h3 i {
            font-size: 22px;
            background: rgba(255,255,255,0.15);
            padding: 8px;
            border-radius: 10px;
        }
        .password-card-header p {
            margin: 10px 0 0;
            font-size: 14px;
            opacity: 0.85;
        }
        .password-form {
            padding: 24px;
        }
        .password-form .form-group {
            margin-bottom: 20px;
        }
        .password-form .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        .password-form .input-wrapper {
            position: relative;
            width: 100%;
        }
        .password-form .input-wrapper input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            background: #fafafa;
            box-sizing: border-box;
        }
        .password-form .input-wrapper input:focus {
            outline: none;
            border-color: #14b8a6;
            background: #fff;
        }
        .password-form .input-wrapper input.valid {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .password-form .input-wrapper input.invalid {
            border-color: #ef4444;
            background: #fef2f2;
        }
        /* Toggle button - EXACT copy from login.html */
        .password-form .toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none !important;
            border: none !important;
            cursor: pointer;
            color: #9ca3af;
            font-size: 20px;
            padding: 8px;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: none !important;
            border-radius: 8px;
            box-shadow: none !important;
            outline: none !important;
            z-index: 10;
        }
        .password-form .toggle-btn:hover,
        .password-form .toggle-btn:focus,
        .password-form .toggle-btn:active {
            color: #9ca3af !important;
            background: none !important;
            transform: translateY(-50%) !important;
            box-shadow: none !important;
        }
        .password-form .toggle-btn i {
            font-size: 20px;
            pointer-events: none;
        }
        /* Strength bar */
        .strength-bar {
            height: 5px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .strength-fill {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .strength-fill.weak { width: 25%; background: #ef4444; }
        .strength-fill.fair { width: 50%; background: #f59e0b; }
        .strength-fill.good { width: 75%; background: #3b82f6; }
        .strength-fill.strong { width: 100%; background: #10b981; }
        .strength-text {
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
            color: #6b7280;
        }
        .strength-text.weak { color: #ef4444; }
        .strength-text.fair { color: #f59e0b; }
        .strength-text.good { color: #3b82f6; }
        .strength-text.strong { color: #10b981; }
        /* Mismatch error */
        .mismatch-error {
            color: #ef4444;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .mismatch-error.show {
            opacity: 1;
        }
        /* Requirements box */
        .requirements-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        .requirements-box h4 {
            margin: 0 0 12px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .requirements-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .req-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
            padding: 6px 10px;
            background: #fff;
            border-radius: 6px;
        }
        .req-item i {
            font-size: 14px;
            color: #d1d5db;
        }
        .req-item.valid {
            color: #059669;
            background: rgba(16, 185, 129, 0.1);
        }
        .req-item.valid i {
            color: #10b981;
        }
        /* Submit button */
        .password-form .submit-btn {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .password-form .submit-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .password-form .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            .password-card {
                border-radius: 12px;
            }
            .password-card-header {
                padding: 20px;
            }
            .password-form {
                padding: 20px;
            }
            .password-form .input-wrapper input {
                font-size: 16px;
            }
            .requirements-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Ensure all action buttons have bottom spacing on mobile */
        @media (max-width: 768px) {
            .btn-save,
            .btn-track,
            .btn-reorder,
            .btn-return,
            .btn-exchange,
            .btn-invoice,
            .btn-add-address,
            .btn-submit,
            .order-actions,
            .address-actions,
            .wishlist-item-actions,
            .tracking-search button {
                margin-bottom: 20px;
            }
            
            .profile-section {
                padding-bottom: 100px; /* Add padding to each section */
            }
            
            .profile-main {
                padding-bottom: 120px; /* Extra padding for main content area */
            }
            
            /* Exchange card mobile styles */
            .exchange-card .order-header,
            .exchange-card .order-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .exchange-info-box,
            .exchange-timeline-section {
                padding: 12px 15px !important;
            }
            
            .exchange-step {
                padding: 8px 0 !important;
            }
            
            .exchange-step > div:first-child {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px;
            }
            
            .exchange-step span {
                font-size: 13px !important;
            }
            
            .exchanges-list .order-actions {
                width: 100%;
            }
            
            .exchanges-list .btn-track {
                width: 100%;
            }
        }

        .btn-save:hover {
            background: #333;
            transform: translateY(-2px);
        }

        /* Orders Section */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .order-card {
            border: 1px solid #eee;
            border-radius: 12px;
            overflow: hidden;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .order-id {
            font-weight: 600;
            font-size: 16px;
            color: #000;
        }

        .order-date {
            color: #666;
            font-size: 14px;
        }

        .order-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .order-status.pending {
            background: #fff8e1;
            color: #ff8f00;
        }

        .order-status.confirmed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .order-status.processing {
            background: #fff3e0;
            color: #f57c00;
        }

        .order-status.shipped {
            background: #e3f2fd;
            color: #1976d2;
        }

        .order-status.delivered {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .order-status.cancelled, .order-status.canceled {
            background: #ffebee;
            color: #c62828;
        }

        .order-status.returned {
            background: #fce4ec;
            color: #ad1457;
        }

        .order-status.refunded {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Return Status Colors */
        .return-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .return-status.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .return-status.approved {
            background: #e3f2fd;
            color: #1565c0;
        }

        .return-status.rejected {
            background: #ffebee;
            color: #c62828;
        }

        .return-status.processing {
            background: #fff8e1;
            color: #f9a825;
        }

        .return-status.refunded, .return-status.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .return-status.pickup-scheduled {
            background: #e1f5fe;
            color: #0277bd;
        }

        .return-status.picked-up {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Exchange Status Colors */
        .exchange-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .exchange-status.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .exchange-status.approved {
            background: #d1fae5;
            color: #059669;
        }

        .exchange-status.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .exchange-status.processing {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .exchange-status.shipped {
            background: #cffafe;
            color: #0891b2;
        }

        .exchange-status.completed {
            background: #dcfce7;
            color: #16a34a;
        }

        .exchange-status.pickup-scheduled {
            background: #dbeafe;
            color: #2563eb;
        }

        .exchange-status.picked-up {
            background: #ede9fe;
            color: #7c3aed;
        }

        /* Exchange card styling */
        .exchange-card {
            border-left: 4px solid #f59e0b;
        }

        .exchange-card .order-id {
            color: #f59e0b !important;
        }

        .exchanges-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .order-items {
            padding: 20px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .order-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-item-image i {
            font-size: 32px;
            color: #ccc;
        }

        /* Product link styles */
        .product-link {
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .product-link:hover {
            opacity: 0.8;
        }

        a.order-item-name.product-link {
            display: block;
        }

        a.order-item-name.product-link:hover {
            color: #555;
        }

        .order-item-details {
            flex: 1;
        }

        .order-item-name {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 5px;
            color: #000;
        }

        .order-item-meta {
            font-size: 13px;
            color: #666;
        }

        .order-item-price {
            font-weight: 600;
            font-size: 16px;
            color: #000;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .order-total {
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .btn-track, .btn-reorder, .btn-return, .btn-exchange, .btn-invoice, .btn-cancel-order {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-track {
            background: #000;
            color: #fff;
            border: none;
        }

        .btn-track:hover {
            background: #333;
        }

        .btn-reorder {
            background: #fff;
            color: #000;
            border: 1px solid #ddd;
        }

        .btn-reorder:hover {
            border-color: #000;
        }

        .btn-return {
            background: #fff;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .btn-return:hover {
            background: #dc2626;
            color: #fff;
        }

        .btn-exchange {
            background: #fff;
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .btn-exchange:hover {
            background: #f59e0b;
            color: #fff;
        }

        .btn-cancel-order {
            background: #fff;
            color: #6b7280;
            border: 1px solid #6b7280;
        }

        .btn-cancel-order:hover {
            background: #6b7280;
            color: #fff;
        }

        .btn-invoice {
            background: #fff;
            color: #059669;
            border: 1px solid #059669;
        }

        .btn-invoice:hover {
            background: #059669;
            color: #fff;
        }

        .btn-invoice i {
            margin-right: 4px;
        }

        /* Tracking Section */
        .tracking-search {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .tracking-search input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }

        .tracking-search input:focus {
            outline: none;
            border-color: #000;
        }

        .tracking-search button {
            padding: 14px 25px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tracking-search button:hover {
            background: #333;
        }

        .tracking-result {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 30px;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tracking-order-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tracking-order-info p {
            color: #666;
            font-size: 14px;
        }

        .tracking-timeline {
            position: relative;
            padding-left: 30px;
        }

        .tracking-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #eee;
            transform: translateX(6px);
        }

        .tracking-step {
            position: relative;
            padding-bottom: 30px;
        }

        .tracking-step:last-child {
            padding-bottom: 0;
        }

        .tracking-step::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ddd;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #ddd;
            z-index: 1;
        }

        .tracking-step.completed::before {
            background: #4caf50;
            box-shadow: 0 0 0 2px #4caf50;
        }

        .tracking-step.rejected::before {
            background: #dc2626;
            box-shadow: 0 0 0 2px #dc2626;
        }

        .tracking-step.rejected .tracking-step-title,
        .tracking-step.rejected .tracking-step-desc,
        .tracking-step.rejected .tracking-step-time {
            color: #dc2626;
        }

        .tracking-step.current::before {
            background: #000;
            box-shadow: 0 0 0 2px #000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 2px #000; }
            50% { box-shadow: 0 0 0 6px rgba(0, 0, 0, 0.2); }
            100% { box-shadow: 0 0 0 2px #000; }
        }

        .tracking-step-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
            color: #000;
        }

        .tracking-step-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .tracking-step-time {
            font-size: 13px;
            color: #999;
        }

        .tracking-details {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .tracking-details h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
        }

        .tracking-items {
            margin-bottom: 15px;
        }

        .tracking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .tracking-item:last-child {
            border-bottom: none;
        }

        .tracking-total {
            text-align: right;
            font-size: 16px;
            color: #000;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
            display: block;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
        }

        .empty-state p {
            color: #666;
            margin-bottom: 25px;
            max-width: 300px;
            line-height: 1.5;
        }

        .empty-state a {
            display: inline-block;
            padding: 14px 30px;
            background: #000;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .empty-state a:hover {
            background: #333;
            transform: translateY(-2px);
        }

        /* Wishlist Items */
        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .wishlist-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .wishlist-item:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .wishlist-item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
        }

        .wishlist-item-info {
            padding: 15px;
        }

        .wishlist-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 5px;
        }

        .wishlist-item-price {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            margin-bottom: 12px;
        }

        .wishlist-item-actions {
            display: flex;
            gap: 10px;
        }

        .wishlist-item-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add-cart {
            background: #000;
            color: #fff;
            border: none;
        }

        .btn-add-cart:hover {
            background: #333;
        }

        .btn-remove-wishlist {
            background: #fff;
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        .btn-remove-wishlist:hover {
            background: #ff4444;
            color: #fff;
        }

        /* Raised Queries Styles */
        .query-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .query-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-color: #d1d5db;
        }

        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .query-subject {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .query-date {
            font-size: 12px;
            color: #9ca3af;
        }

        .query-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .query-status.solved {
            background: #d1fae5;
            color: #065f46;
        }

        .query-status.open {
            background: #dbeafe;
            color: #1e40af;
        }

        .query-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .query-message {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.6;
            margin: 12px 0;
            padding: 12px;
            background: #f9fafb;
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
        }

        .query-replies {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .reply-item {
            background: #f0fdf4;
            border-left: 3px solid #22c55e;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .reply-header strong {
            color: #059669;
        }

        .reply-header small {
            color: #9ca3af;
        }

        .reply-content {
            color: #1f2937;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .no-replies {
            color: #9ca3af;
            font-size: 13px;
            font-style: italic;
            padding: 8px;
        }

        /* User Reply Styles */
        .reply-item.user-reply {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .reply-item.user-reply .reply-header strong {
            color: #2563eb;
        }

        .query-actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }

        .btn-reply-query {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reply-query:hover {
            background: #333;
        }

        .query-reply-form {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .query-reply-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .query-reply-form textarea:focus {
            outline: none;
            border-color: #000;
        }
        
        .reply-image-upload {
            margin-top: 12px;
        }
        
        .reply-image-upload-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reply-image-upload-box:hover {
            border-color: #000;
            background: #f3f4f6;
        }
        
        .reply-image-upload-box i {
            font-size: 20px;
            color: #6b7280;
        }
        
        .reply-image-upload-box span {
            font-size: 13px;
            color: #6b7280;
        }
        
        .reply-image-previews {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .reply-image-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .reply-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .reply-image-preview .remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .reply-image-preview .remove-img:hover {
            background: #ef4444;
        }

        .query-reply-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        .btn-send-reply {
            padding: 10px 24px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-send-reply:hover {
            background: #333;
        }

        .btn-cancel-reply {
            padding: 10px 24px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel-reply:hover {
            background: #e5e7eb;
        }

        .queries-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Notification Badge Styles */
        .sidebar-menu a {
            position: relative;
        }
        .query-notification-dot {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            animation: pulse-badge 2s infinite;
        }
        @keyframes pulse-badge {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 2px 12px rgba(220, 38, 38, 0.5);
            }
        }

        /* ============ BUTTON ANIMATIONS & HOVER EFFECTS ============ */
        /* All Profile Page Buttons - Enhanced Animations */
        .btn-edit,
        .btn-logout,
        .btn-save,
        .btn-track,
        .btn-reorder,
        .btn-return,
        .btn-exchange,
        .btn-cancel-order,
        .btn-invoice,
        .btn-add-cart,
        .btn-remove-wishlist,
        .btn-add-address,
        .btn-edit-address,
        .btn-delete-address,
        .btn-cancel,
        .btn-submit,
        .btn-confirm-logout,
        .btn-confirm-delete,
        .btn-success-ok,
        .btn-save-address,
        .btn-reply-query,
        .btn-send-reply,
        .btn-cancel-reply,
        .tracking-search button,
        .empty-state a,
        .query-actions button,
        .wishlist-item-actions button,
        .address-modal-buttons button,
        .logout-popup-buttons button,
        .delete-modal-buttons button,
        .modal-footer button {
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, 
                        box-shadow 0.3s ease,
                        background-color 0.3s ease,
                        color 0.3s ease,
                        border-color 0.3s ease !important;
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Button Hover - Lift Effect */
        .btn-edit:hover,
        .btn-logout:hover,
        .btn-save:hover,
        .btn-track:hover,
        .btn-reorder:hover,
        .btn-return:hover,
        .btn-exchange:hover,
        .btn-cancel-order:hover,
        .btn-invoice:hover,
        .btn-add-cart:hover,
        .btn-add-address:hover,
        .btn-edit-address:hover,
        .btn-reply-query:hover,
        .btn-send-reply:hover,
        .tracking-search button:hover,
        .empty-state a:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }

        /* Button Active - Press Effect */
        .btn-edit:active,
        .btn-logout:active,
        .btn-save:active,
        .btn-track:active,
        .btn-reorder:active,
        .btn-return:active,
        .btn-exchange:active,
        .btn-cancel-order:active,
        .btn-invoice:active,
        .btn-add-cart:active,
        .btn-remove-wishlist:active,
        .btn-add-address:active,
        .btn-edit-address:active,
        .btn-delete-address:active,
        .btn-cancel:active,
        .btn-submit:active,
        .btn-confirm-logout:active,
        .btn-confirm-delete:active,
        .btn-success-ok:active,
        .btn-save-address:active,
        .btn-reply-query:active,
        .btn-send-reply:active,
        .btn-cancel-reply:active,
        .tracking-search button:active,
        .empty-state a:active {
            transform: translateY(-1px) scale(0.98) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

        /* Ripple Effect for Primary Buttons */
        .btn-edit::after,
        .btn-save::after,
        .btn-track::after,
        .btn-add-cart::after,
        .btn-submit::after,
        .btn-confirm-logout::after,
        .btn-confirm-delete::after,
        .btn-save-address::after,
        .btn-reply-query::after,
        .btn-send-reply::after,
        .tracking-search button::after,
        .empty-state a::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.25) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.5s ease;
            border-radius: inherit;
            pointer-events: none;
        }

        .btn-edit:hover::after,
        .btn-save:hover::after,
        .btn-track:hover::after,
        .btn-add-cart:hover::after,
        .btn-submit:hover::after,
        .btn-confirm-logout:hover::after,
        .btn-confirm-delete:hover::after,
        .btn-save-address:hover::after,
        .btn-reply-query:hover::after,
        .btn-send-reply:hover::after,
        .tracking-search button:hover::after,
        .empty-state a:hover::after {
            transform: scale(2.5);
        }

        /* Icon Animation in Buttons */
        .btn-track i,
        .btn-invoice i,
        .btn-return i,
        .btn-exchange i,
        .btn-reorder i,
        .btn-reply-query i {
            transition: transform 0.3s ease;
        }

        .btn-track:hover i,
        .btn-invoice:hover i,
        .btn-return:hover i,
        .btn-exchange:hover i,
        .btn-reorder:hover i,
        .btn-reply-query:hover i {
            transform: scale(1.15);
        }

        /* ============ TRACKING SYSTEM ANIMATIONS ============ */
        /* Tracking Search Input Animation */
        .tracking-search input {
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease !important;
        }

        .tracking-search input:focus {
            border-color: #000 !important;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08) !important;
            transform: translateY(-2px);
        }

        /* Tracking Result Card Animation */
        .tracking-result {
            transition: transform 0.4s ease, 
                        box-shadow 0.4s ease !important;
            animation: fadeInUp 0.6s ease-out;
        }

        .tracking-result:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tracking Header Animation */
        .tracking-header {
            animation: slideInFromLeft 0.5s ease-out 0.1s both;
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Tracking Timeline Animation */
        .tracking-timeline {
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Tracking Step Animation */
        .tracking-step {
            transition: all 0.3s ease !important;
            opacity: 0;
            animation: stepReveal 0.5s ease-out forwards;
        }

        .tracking-step:nth-child(1) { animation-delay: 0.1s; }
        .tracking-step:nth-child(2) { animation-delay: 0.2s; }
        .tracking-step:nth-child(3) { animation-delay: 0.3s; }
        .tracking-step:nth-child(4) { animation-delay: 0.4s; }
        .tracking-step:nth-child(5) { animation-delay: 0.5s; }
        .tracking-step:nth-child(6) { animation-delay: 0.6s; }

        @keyframes stepReveal {
            from {
                opacity: 0;
                transform: translateX(-15px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Tracking Step Hover Effect */
        .tracking-step:hover {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding-left: 10px;
            margin-left: -10px;
        }

        .tracking-step:hover .tracking-step-title {
            color: #000;
        }

        /* Tracking Step Circle Animation Enhancement */
        .tracking-step::before {
            transition: all 0.3s ease !important;
        }

        .tracking-step:hover::before {
            transform: scale(1.2);
        }

        .tracking-step.completed:hover::before {
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
        }

        .tracking-step.current:hover::before {
            box-shadow: 0 0 0 8px rgba(0, 0, 0, 0.15);
        }

        /* Tracking Details Animation */
        .tracking-details {
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }

        /* Tracking Item Hover */
        .tracking-item {
            transition: all 0.3s ease !important;
            padding: 10px 8px;
            margin: 0 -8px;
            border-radius: 6px;
        }

        .tracking-item:hover {
            background: #f8fafc;
            transform: translateX(5px);
        }

        /* Order Card Animations */
        .order-card {
            transition: transform 0.3s ease, 
                        box-shadow 0.3s ease !important;
        }

        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        /* Order Status Badge Animation */
        .order-status,
        .return-status,
        .exchange-status {
            transition: transform 0.3s ease, box-shadow 0.3s ease !important;
        }

        .order-status:hover,
        .return-status:hover,
        .exchange-status:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Sidebar Menu Animation */
        .sidebar-menu a {
            transition: all 0.3s ease !important;
        }

        .sidebar-menu a:hover {
            transform: translateX(5px);
            background: #f5f5f5;
        }

        .sidebar-menu a:hover i {
            transform: scale(1.1);
        }

        .sidebar-menu a i {
            transition: transform 0.3s ease;
        }

        /* Query Card Animation */
        .query-card {
            transition: transform 0.3s ease, 
                        box-shadow 0.3s ease,
                        border-color 0.3s ease !important;
        }

        .query-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        /* Address Card Animation */
        .address-card {
            transition: transform 0.3s ease, 
                        box-shadow 0.3s ease !important;
        }

        .address-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        /* Profile Avatar Hover Enhancement */
        .profile-avatar {
            transition: transform 0.4s ease, box-shadow 0.4s ease !important;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        /* Profile Header Card Animation */
        .profile-header {
            transition: transform 0.3s ease, 
                        box-shadow 0.3s ease !important;
        }

        .profile-header:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        /* Responsive - Minimal Aesthetic Mobile Layout */
        @media (max-width: 900px) {
            .profile-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .profile-sidebar {
                position: sticky;
                top: 80px;
                z-index: 99;
                background: #eef3f8;
                padding: 10px 0;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                margin-bottom: 16px;
            }

            .sidebar-menu {
                display: flex;
                overflow-x: auto;
                gap: 8px;
                padding: 12px 0;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                scroll-behavior: smooth;
            }
            
            .sidebar-menu::-webkit-scrollbar {
                display: none;
            }

            .sidebar-menu li {
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .sidebar-menu a {
                white-space: nowrap;
                padding: 10px 16px;
                background: #fff;
                border-radius: 20px;
                font-size: 13px;
                font-weight: 500;
                color: #555;
                border: 1px solid #e5e5e5;
            }

            .sidebar-menu a.active,
            .sidebar-menu a:hover {
                background: #000;
                color: #fff;
                border-color: #000;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 24px 20px;
                border-radius: 12px;
            }

            .profile-actions {
                margin-left: 0;
                margin-top: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .content-card {
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            }
        }

        @media (max-width: 600px) {
            .profile-container {
                padding: 80px 16px 32px;
            }

            .profile-header {
                padding: 20px 16px;
                gap: 12px;
                margin-bottom: 16px;
            }

            .profile-avatar {
                width: 72px;
                height: 72px;
                font-size: 28px;
                border: 3px solid #fff;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            .profile-info h1 {
                font-size: 20px;
                font-weight: 600;
            }

            .profile-info p {
                font-size: 13px;
                color: #777;
            }

            .order-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .order-footer {
                flex-direction: column;
                gap: 12px;
            }

            .order-actions {
                width: 100%;
                gap: 8px;
            }

            .order-actions button, .order-actions a {
                flex: 1;
                text-align: center;
                padding: 10px 12px;
                font-size: 13px;
                border-radius: 8px;
            }

            .tracking-search {
                flex-direction: column;
            }
            
            .order-item {
                flex-direction: row;
                gap: 12px;
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .order-item:last-child {
                border-bottom: none;
            }
            
            .order-item-image {
                width: 70px;
                height: 70px;
                border-radius: 8px;
                flex-shrink: 0;
            }
            
            .order-item-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .order-item-details {
                flex: 1;
                min-width: 0;
            }

            .order-card {
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 12px;
            }
        }

        /* Extra small screens (phones) - Minimal aesthetic */
        @media (max-width: 480px) {
            html, body {
                overflow-x: hidden;
            }

            .profile-container {
                padding: 76px 12px 24px;
            }

            .profile-header {
                padding: 16px;
                gap: 10px;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            }

            .profile-avatar {
                width: 64px;
                height: 64px;
                font-size: 24px;
            }

            .profile-info h1 {
                font-size: 18px;
                letter-spacing: -0.3px;
            }

            .profile-info p {
                font-size: 12px;
                margin-bottom: 2px;
            }

            .profile-actions {
                flex-direction: row;
                width: 100%;
                gap: 8px;
            }

            .btn-edit, .btn-logout {
                flex: 1;
                text-align: center;
                padding: 10px 16px;
                font-size: 13px;
                border-radius: 8px;
            }

            .btn-edit {
                background: #000;
            }

            .btn-logout {
                border-width: 1px;
            }

            .profile-sidebar {
                padding: 0;
                background: transparent;
            }

            .sidebar-menu {
                padding: 8px 0;
                gap: 6px;
            }

            .sidebar-menu a {
                padding: 8px 14px;
                font-size: 12px;
                border-radius: 16px;
            }

            .content-card {
                padding: 16px;
                border-radius: 12px;
                background: #fff;
            }

            .content-header {
                margin-bottom: 16px;
            }

            .content-header h2 {
                font-size: 16px;
                font-weight: 600;
            }

            .order-card {
                padding: 14px;
                border-radius: 10px;
                background: #fff;
                box-shadow: 0 1px 8px rgba(0,0,0,0.04);
            }

            .order-item {
                flex-direction: row;
                align-items: center;
            }

            .order-item-image {
                width: 60px;
                height: 60px;
                border-radius: 8px;
            }

            .order-item-details {
                width: auto;
                min-width: 0;
            }

            .order-item-name {
                font-size: 13px;
                font-weight: 500;
            }

            .order-item-meta {
                font-size: 11px;
            }

            .order-item-price {
                font-size: 14px;
                font-weight: 600;
            }

            .form-group {
                margin-bottom: 14px;
            }

            .form-group label {
                font-size: 12px;
                font-weight: 500;
                margin-bottom: 6px;
            }

            .form-group input, .form-group select, .form-group textarea {
                padding: 12px 14px;
                font-size: 14px;
                border-radius: 8px;
                border: 1px solid #e5e5e5;
            }

            .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
                border-color: #000;
                outline: none;
            }

            .btn-save {
                width: 100%;
                padding: 14px 20px;
                font-size: 14px;
                font-weight: 500;
                border-radius: 10px;
            }

            .order-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .order-actions button, .order-actions a {
                min-width: calc(50% - 4px);
                justify-content: center;
                font-size: 12px;
                padding: 8px 10px;
            }

            /* Empty states */
            .empty-state {
                padding: 32px 16px;
            }

            .empty-state i {
                font-size: 40px;
            }

            .empty-state p {
                font-size: 13px;
            }
        }

        /* ===========================================
           MOBILE BOTTOM NAVIGATION - Clean Rebuild
           =========================================== */
        
        /* Hide on desktop */
        .mobile-bottom-nav {
            display: none;
        }
        
        .mobile-more-menu-overlay {
            display: none !important;
        }
        
        .mobile-more-menu-overlay.show {
            display: none !important;
        }

        /* ===========================================
           MOBILE RESPONSIVE STYLES
           =========================================== */

        @media (max-width: 768px) {
            .profile-container {
                padding: 80px 15px 200px; /* Significantly increased bottom padding */
                min-height: calc(100vh - 60px);
            }

            /* Show sidebar on mobile as horizontal bar */
            .profile-sidebar {
                display: block !important;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                z-index: 98;
                position: sticky;
                top: 80px;
                background: #eef3f8;
                padding: 10px 0;
                margin-bottom: 20px;
                white-space: nowrap;
            }
            
            /* Hide scrollbar for sidebar */
            .profile-sidebar::-webkit-scrollbar {
                display: none;
            }
            .profile-sidebar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* ====================================
               MOBILE BOTTOM NAV - CLEAN REBUILD
               ==================================== */
            .mobile-bottom-nav {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: #fff !important;
                border-top: 1px solid #e5e7eb;
                box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
                z-index: 2147483647 !important; /* Maximum z-index */
                display: flex !important;
                justify-content: space-around;
                align-items: center;
                padding: 8px 0;
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
                min-height: 60px;
                transform: none !important; /* Prevent any transform inheritance */
                will-change: auto !important; /* Prevent stacking context issues */
            }
            
            /* Hide when keyboard is open */
            body.keyboard-open .mobile-bottom-nav {
                display: none;
            }

            .mobile-bottom-nav .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 8px 6px;
                text-decoration: none;
                color: #9ca3af;
                font-size: 10px;
                font-weight: 500;
                flex: 1;
                max-width: 70px;
                transition: color 0.2s ease;
                position: relative;
            }
            
            .mobile-bottom-nav .nav-item span {
                margin-top: 4px;
                white-space: nowrap;
            }

            .mobile-bottom-nav .nav-item i {
                font-size: 22px;
                transition: transform 0.2s ease;
            }

            .mobile-bottom-nav .nav-item.active {
                color: #000;
            }

            .mobile-bottom-nav .nav-item.active i {
                transform: scale(1.1);
            }

            .mobile-bottom-nav .nav-item:active {
                transform: scale(0.95);
            }

            /* Notification dot for mobile nav */
            .mobile-bottom-nav .nav-item .query-notification-dot {
                position: absolute;
                top: 0;
                right: 4px;
                background: #ef4444;
                color: #fff;
                border-radius: 10px;
                font-size: 9px;
                font-weight: 700;
                padding: 1px 4px;
                min-width: 14px;
                text-align: center;
                z-index: 1;
                box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            }
            
            /* Mobile More Menu Overlay - Override desktop hide for mobile */
            .mobile-more-menu-overlay {
                display: none !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 2147483648; /* Higher than bottom nav */
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
            }
            
            .mobile-more-menu-overlay.show {
                display: flex !important;
                align-items: flex-end;
                animation: fadeIn 0.2s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .mobile-more-menu {
                width: 100%;
                background: #fff;
                border-radius: 20px 20px 0 0;
                padding: 0 0 calc(80px + env(safe-area-inset-bottom)); /* Added padding to clear bottom nav */
                animation: slideUp 0.3s ease;
                max-height: 80vh;
                overflow-y: auto;
                position: absolute;
                bottom: 0;
            }
            
            @keyframes slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }
            
            .more-menu-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 20px 16px;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .more-menu-header h4 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #1f2937;
            }
            
            .more-menu-close {
                background: #f3f4f6;
                border: none;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .more-menu-close:hover {
                background: #e5e7eb;
            }
            
            .more-menu-close i {
                font-size: 20px;
                color: #6b7280;
            }
            
            .more-menu-items {
                padding: 12px 16px;
            }
            
            .more-menu-item {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 16px;
                text-decoration: none;
                color: #374151;
                border-radius: 12px;
                transition: all 0.2s ease;
                font-size: 15px;
                font-weight: 500;
            }
            
            .more-menu-item:hover, .more-menu-item:active {
                background: #f3f4f6;
            }
            
            .more-menu-item i {
                font-size: 22px;
                color: #6b7280;
                width: 28px;
                text-align: center;
            }

            /* Profile Header Mobile */
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
                padding: 25px 20px;
                margin-bottom: 20px;
            }

            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }

            .profile-info h1 {
                font-size: 24px;
            }

            .profile-info p {
                font-size: 14px;
            }

            .profile-actions {
                margin-left: 0;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .btn-edit, .btn-logout {
                padding: 10px 20px;
                font-size: 13px;
            }

            /* Mobile Layout - Full width content */
            .profile-content {
                display: block;
                gap: 0;
            }

            /* Hide mobile menu toggle since we have bottom nav */
            .mobile-menu-toggle {
                display: none !important;
            }

            /* Main Content Mobile */
            .profile-main {
                padding: 20px 0;
                border-radius: 0;
                margin-top: 0;
                box-shadow: none;
                background: transparent;
            }

            .section-title {
                font-size: 20px;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }

            .section-title i {
                font-size: 22px;
            }

            /* Mobile Sidebar */
            .profile-sidebar {
                position: fixed;
                top: 0;
                right: -300px;
                width: 280px;
                height: 100vh;
                background: #fff;
                box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                transition: right 0.3s ease;
                padding: 80px 0 20px;
                overflow-y: auto;
            }

            .profile-sidebar.open {
                right: 0;
            }

            .sidebar-menu {
                padding: 0 20px;
            }

            .sidebar-menu li {
                margin-bottom: 5px;
            }

            .sidebar-menu a {
                padding: 15px 20px;
                border-radius: 12px;
                font-size: 15px;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.3s ease;
            }

            .sidebar-menu a i {
                font-size: 18px;
            }

            /* Mobile Overlay */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .sidebar-overlay.show {
                display: block;
                opacity: 1;
            }

            /* Main Content Mobile */
            .profile-main {
                padding: 20px;
                border-radius: 12px;
                margin-top: 0;
            }

            .section-title {
                font-size: 20px;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }

            .section-title i {
                font-size: 22px;
            }

            /* Form Mobile Styles */
            .profile-form {
                gap: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-group input {
                padding: 12px 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .btn-save {
                width: 100%;
                padding: 14px;
                font-size: 16px;
                margin-top: 20px;
            }

            /* Orders Mobile */
            .order-card {
                margin-bottom: 15px;
                padding: 15px;
                border-radius: 12px;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .order-id {
                font-size: 14px;
            }

            .order-date {
                font-size: 13px;
                color: #666;
            }

            .order-status {
                align-self: flex-end;
                font-size: 12px;
                padding: 4px 8px;
            }

            .order-items {
                gap: 10px;
            }

            .order-item {
                flex-direction: row;
                gap: 12px;
                padding: 10px;
            }

            .order-item img {
                width: 60px;
                height: 60px;
            }

            .order-item-details {
                flex: 1;
            }

            .order-item-title {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .order-item-price {
                font-size: 13px;
            }

            .order-actions {
                flex-direction: column;
                gap: 8px;
                margin-top: 15px;
            }

            .order-actions button {
                padding: 8px 16px;
                font-size: 13px;
            }

            /* Tracking Mobile */
            .tracking-search {
                flex-direction: column;
                gap: 12px;
            }

            .tracking-search input {
                width: 100%;
                padding: 12px 14px;
                font-size: 16px;
            }

            .tracking-search button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            .tracking-result {
                margin-top: 20px;
            }

            .tracking-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .tracking-order-info h3 {
                font-size: 16px;
            }

            .tracking-timeline {
                margin-top: 20px;
            }

            .tracking-step {
                padding: 15px 0;
            }

            .tracking-step-title {
                font-size: 15px;
            }

            .tracking-step-desc {
                font-size: 14px;
            }

            .tracking-step-time {
                font-size: 12px;
            }

            /* Addresses Mobile */
            .addresses-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .address-card {
                padding: 20px;
            }

            .address-card h3 {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .address-details p {
                font-size: 14px;
                margin-bottom: 8px;
            }

            .address-actions {
                flex-direction: column;
                gap: 8px;
                margin-top: 15px;
            }

            .address-actions button {
                padding: 8px 16px;
                font-size: 13px;
            }

            /* Wishlist Mobile */
            .wishlist-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
            }

            .wishlist-item {
                padding: 15px;
            }

            .wishlist-item img {
                height: 200px;
            }

            .wishlist-item-details h3 {
                font-size: 16px;
            }

            .wishlist-item-price {
                font-size: 15px;
            }

            .wishlist-item-actions {
                gap: 8px;
            }

            .wishlist-item-actions button {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Modal Mobile Styles */
            .logout-popup, .success-popup, .address-modal, .delete-modal {
                width: 95%;
                max-width: 95%;
                margin: 20px;
                padding: 25px 20px;
            }

            .logout-popup h3, .success-popup h3, .delete-modal h3 {
                font-size: 18px;
            }

            .logout-popup-buttons, .delete-modal-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .logout-popup-buttons button, .delete-modal-buttons button {
                width: 100%;
                padding: 12px;
            }

            /* Loading States Mobile */
            .loading-orders, .loading-returns, .loading-addresses, .loading-wishlist {
                padding: 30px 20px;
            }

            .loading-orders p, .loading-returns p, .loading-addresses p, .loading-wishlist p {
                font-size: 14px;
            }

            /* Empty States Mobile */
            .empty-state {
                padding: 40px 20px;
            }

            .empty-state i {
                font-size: 48px;
            }

            .empty-state h3 {
                font-size: 18px;
            }

            .empty-state p {
                font-size: 14px;
            }

            /* Return Modal Mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }

            .modal-footer button {
                width: 100%;
                padding: 12px;
            }

            /* Query Items Mobile */
            .query-item {
                padding: 15px;
                margin-bottom: 15px;
            }

            .query-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .query-id {
                font-size: 14px;
            }

            .query-date {
                font-size: 13px;
            }

            .query-status {
                align-self: flex-end;
                font-size: 12px;
            }

            .query-content {
                margin-top: 12px;
            }

            .query-content p {
                font-size: 14px;
            }
        }

        /* Extra Small Screens */
        @media (max-width: 480px) {
            .profile-container {
                padding: 70px 10px 200px !important; /* Must match 768px padding */
            }

            .profile-header {
                padding: 20px 15px;
            }

            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }

            .profile-info h1 {
                font-size: 20px;
            }

            .profile-main {
                padding: 15px;
            }

            .section-title {
                font-size: 18px;
            }

            .wishlist-grid {
                grid-template-columns: 1fr;
            }

            .order-item {
                flex-direction: column;
                text-align: center;
            }

            .order-item img {
                width: 80px;
                height: 80px;
                align-self: center;
            }
        }
    </style>
    <script src="assets/js/api.js?v=20241224"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/security.js"></script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Premium Glass Hamburger Navbar -->
    <header class="nav">
        <div class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <img src="assets/img/BLACKONN 004_page-0001.png" alt="BLACKONN Logo" title="BLACKONN">
                </a>
            </div>

            <div class="nav-right">
                <div class="nav-icons">
                    <a href="login.html" class="nav-icon login-icon" id="loginIcon" title="Login" style="display: none;">
                        <i class="ri-user-line"></i>
                    </a>
                    <a href="profile.html" class="nav-user" id="navUser" aria-label="Profile">
                        <i class="ri-user-line" id="navUserIcon"></i>
                        <span class="user-name" id="navUserName"></span>
                    </a>
                    <a href="cart.html" class="nav-icon cart-icon" id="cartIcon" title="Shopping Cart">
                        <i class="ri-shopping-cart-line"></i>
                        <span class="cart-count" id="cartCount">0</span>
                    </a>
                </div>
                <button class="hamburger" id="menuBtn" aria-label="Open menu">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Fullscreen Menu -->
    <div class="fullscreen-menu" id="fullMenu">
        <button class="close-menu" id="closeMenu"></button>
        <ul>
            <li><a href="index.html#shop" title="Shop"><i class="ri-shopping-bag-line"></i></a></li>
            <li id="giftCardMenuItem"><a href="gift-cards.html" aria-label="Gift Cards" title="Gift Cards"><i class="ri-gift-line"></i></a></li>
            <li id="reviewsMenuItem"><a href="reviews.html" aria-label="Reviews" title="Customer Reviews"><i class="ri-star-smile-line"></i></a></li>
            <li><a href="index.html#about" title="About"><i class="ri-information-line"></i></a></li>
            <li><a href="index.html#contact" title="Contact"><i class="ri-mail-line"></i></a></li>
            <li><a href="cart.html" title="Cart"><i class="ri-shopping-cart-line"></i></a></li>
        </ul>
    </div>

    <script>
    (async function() {
      try {
        const res = await fetch('/api/marketing/feature-visibility?_=' + Date.now(), { cache: 'no-store' });
        const data = await res.json();
        if (data.success) {
          if (!data.features.giftCardsEnabled) {
            const el = document.getElementById('giftCardMenuItem');
            if (el) el.style.display = 'none';
          }
          if (!data.features.reviewsPageEnabled) {
            const el = document.getElementById('reviewsMenuItem');
            if (el) el.style.display = 'none';
          }
        }
      } catch(e) {}
    })();
    </script>

    <script>
        // Helper to normalize upload URLs - handles /api/uploads, /uploads, and bare filenames
        function normalizeUploadUrl(url) {
            if (!url || url === 'undefined') return '/assets/img/placeholder.png';
            if (url.startsWith('/api/uploads')) {
                return url.replace('/api/uploads', '/uploads');
            }
            if (url.startsWith('/uploads') || url.startsWith('http') || url.startsWith('data:') || url.startsWith('assets/')) {
                return url;
            }
            // Bare filename - assume it's a product image
            if (!url.includes('/') && /^[\w\-\.]+$/.test(url)) {
                return '/uploads/products/' + url;
            }
            return url;
        }

        // Menu Toggle
        const menuBtn = document.getElementById('menuBtn');
        const fullMenu = document.getElementById('fullMenu');
        const closeMenu = document.getElementById('closeMenu');

        menuBtn.addEventListener('click', () => {
            fullMenu.style.display = 'flex';
            fullMenu.classList.remove('closing');
            fullMenu.classList.add('open');
            menuBtn.classList.add('open');
        });

        closeMenu.addEventListener('click', () => {
            fullMenu.classList.remove('open');
            fullMenu.classList.add('closing');
            menuBtn.classList.remove('open');
            setTimeout(() => {
                fullMenu.style.display = 'none';
            }, 500);
        });

        const menuLinks = document.querySelectorAll('.fullscreen-menu a');
        menuLinks.forEach(link => {
            link.addEventListener('click', () => {
                fullMenu.classList.remove('open');
                fullMenu.classList.add('closing');
                menuBtn.classList.remove('open');
                setTimeout(() => {
                    fullMenu.style.display = 'none';
                }, 500);
            });
        });

        // Update cart count from API
        async function updateCartCount() {
            const cartCount = document.getElementById('cartCount');

            // Silently skip if not authenticated
            if (!window.blackonnAuth || !window.blackonnAuth.hasToken()) {
                if (cartCount) {
                    cartCount.textContent = '0';
                    cartCount.classList.remove('show');
                }
                return;
            }

            try {
                const cartData = await API.cart.get();
                const cart = cartData.cart || [];
                const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (cartCount) {
                    cartCount.textContent = totalQuantity;
                    if (totalQuantity > 0) {
                        cartCount.classList.add('show');
                    } else {
                        cartCount.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Failed to update cart count:', error);
                if (cartCount) {
                    cartCount.textContent = '0';
                    cartCount.classList.remove('show');
                }
            }
        }

        // Update navbar with user name
        async function updateNavUser() {
            try {
                const user = await window.blackonnAuth.getCurrentUser();
                const navUserName = document.getElementById('navUserName');
                const navUserIcon = document.getElementById('navUserIcon');
                const loginIcon = document.getElementById('loginIcon');
                const navUser = document.getElementById('navUser');
                
                if (user && user.name) {
                    // User is logged in - show user info, hide login icon
                    const firstName = user.name.split(' ')[0];
                    if (navUserName) navUserName.textContent = firstName;
                    if (loginIcon) loginIcon.style.display = 'none';
                    if (navUser) navUser.style.display = 'flex';
                    
                    if (user.avatar && navUserIcon) {
                        navUserIcon.outerHTML = '<img src="' + user.avatar + '" alt="" class="user-avatar">';
                    }
                } else {
                    // User is not logged in - show login icon, hide user info
                    if (loginIcon) loginIcon.style.display = 'flex';
                    if (navUser) navUser.style.display = 'none';
                }
            } catch (err) {
                console.error('Error updating nav user:', err);
            }
        }

        // Check if user is logged in and validate session (with rehydration retries)
        async function checkUserLogin() {
            try {
                // Use requireAuth which includes retry logic for transient cookie timing issues
                const auth = await window.blackonnAuth.requireAuth('login.html');
                if (!auth || !auth.authenticated) return; // requireAuth will redirect if needed
                
                // Check if admin is logged in - redirect to admin panel
                if (auth.user && auth.user.role === 'admin') {
                    window.location.href = 'admin.html';
                    return;
                }
                
                // Session is valid - user data is available from API
            } catch (err) {
                console.error('Error checking user login:', err);
                window.location.href = 'login.html';
            }
        }
        
        checkUserLogin();
        updateNavUser();
    </script>

    <main class="profile-container animate-fade-up" id="main-content" role="main" aria-label="Profile management">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatarContainer" title="Click to upload photo">
                <img src="" alt="Profile" id="avatarImage" style="display: none;">
                <i class="ri-user-line" id="avatarIcon"></i>
                <div class="avatar-overlay">
                    <i class="ri-camera-line"></i>
                </div>
                <input type="file" id="avatarInput" accept="image/*">
            </div>
            <div class="profile-info">
                <h1 id="userName">User</h1>
                <p id="userEmail">Loading...</p>
                <p id="userPhone"></p>
                <span class="member-since" id="memberSince">Member since ...</span>
            </div>
            <div class="profile-actions" id="profileActions">
                <button class="btn-edit" data-action="edit-profile">Edit Profile</button>
                <button class="btn-delete-account" data-action="delete-account" title="Delete Account">
                    <i class="ri-delete-bin-line"></i> Delete Account
                </button>
                <button class="btn-logout" data-action="show-logout">Logout</button>
            </div>
        </div>

        <!-- Logout Popup -->
        <div class="logout-popup-overlay" id="logoutPopup">
            <div class="logout-popup">
                <div class="logout-popup-icon">
                    <i class="ri-logout-box-r-line"></i>
                </div>
                <h3>Logout</h3>
                <p>Are you sure you want to logout from your account?</p>
                <div class="logout-popup-buttons">
                    <button class="btn-cancel" data-action="hide-logout">Cancel</button>
                    <button class="btn-confirm-logout" data-action="confirm-logout">Yes, Logout</button>
                </div>
            </div>
        </div>

        <!-- Delete Account Modal -->
        <div class="delete-account-modal-overlay" id="deleteAccountModal">
            <div class="delete-account-modal">
                <div class="delete-account-modal-icon">
                    <i class="ri-delete-bin-line"></i>
                </div>
                <h3>Delete Account</h3>
                <p>This action is <strong>permanent and cannot be undone</strong>. All your data will be deleted:</p>
                <ul class="delete-warning-list">
                    <li><i class="ri-close-circle-line"></i> Profile information and settings</li>
                    <li><i class="ri-close-circle-line"></i> Order history and tracking</li>
                    <li><i class="ri-close-circle-line"></i> Saved addresses and preferences</li>
                    <li><i class="ri-close-circle-line"></i> Wishlist and cart items</li>
                    <li><i class="ri-close-circle-line"></i> All biometric credentials</li>
                </ul>
                <p style="font-size: 13px; color: #666;">Type <strong>DELETE</strong> to confirm:</p>
                <input type="text" class="delete-confirm-input" id="deleteConfirmInput" placeholder="Type DELETE to confirm">
                <div class="delete-account-buttons">
                    <button class="btn-cancel-delete" data-action="hide-delete-modal">Cancel</button>
                    <button class="btn-confirm-delete" id="btnConfirmDelete" data-action="confirm-delete" disabled>Delete My Account</button>
                </div>
            </div>
        </div>

        <!-- Universal Modal System -->
        <div class="uni-modal-overlay" id="uniModal">
            <div class="uni-modal">
                <div class="uni-modal-header">
                    <div class="uni-modal-icon confirm" id="uniModalIcon">
                        <i class="ri-question-line" id="uniModalIconI"></i>
                    </div>
                    <h3 id="uniModalTitle">Confirm Action</h3>
                    <p id="uniModalMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="uni-modal-body" id="uniModalBody" style="display: none;">
                    <input type="text" class="uni-modal-input" id="uniModalInput" placeholder="Enter value">
                </div>
                <div class="uni-modal-footer">
                    <button class="uni-modal-btn cancel" id="uniModalCancel">Cancel</button>
                    <button class="uni-modal-btn primary" id="uniModalConfirm">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Address Modal -->
        <div class="address-modal-overlay" id="addressModal">
            <div class="address-modal">
                <h3><i class="ri-map-pin-add-line"></i> <span id="addressModalTitle">Add New Address</span></h3>
                <form id="addressForm">
                    <input type="hidden" id="addressIndex" value="-1">
                    <div class="form-group">
                        <label>Address Label *</label>
                        <select id="addressLabel" required>
                            <option value="">Select Label</option>
                            <option value="Home">Home</option>
                            <option value="Office">Office</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="addressName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="addressPhone" placeholder="Enter phone number" required>
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <textarea id="addressStreet" placeholder="House no., Building, Street, Area" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" id="addressCity" placeholder="Enter city" required>
                    </div>
                    <div class="form-group">
                        <label>State *</label>
                        <input type="text" id="addressState" placeholder="Enter state" required>
                    </div>
                    <div class="form-group">
                        <label>Pincode *</label>
                        <input type="text" id="addressPincode" placeholder="Enter pincode" required>
                    </div>
                    <div class="address-modal-buttons">
                        <button type="button" class="btn-cancel" data-action="close-address-modal">Cancel</button>
                        <button type="submit" class="btn-save-address">Save Address</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="delete-modal-overlay" id="deleteModal">
            <div class="delete-modal">
                <div class="delete-modal-icon">
                    <i class="ri-delete-bin-line"></i>
                </div>
                <h3>Delete Address</h3>
                <p>Are you sure you want to delete this address?</p>
                <input type="hidden" id="deleteAddressIndex" value="-1">
                <div class="delete-modal-buttons">
                    <button class="btn-cancel" data-action="close-delete-modal">Cancel</button>
                    <button class="btn-confirm-delete" data-action="confirm-delete">Yes, Delete</button>
                </div>
            </div>
        </div>

        <!-- Success Popup with Accessibility -->
        <div class="success-popup-overlay" id="successPopup" role="dialog" aria-modal="true" aria-labelledby="successTitle" aria-describedby="successMessage">
            <div class="success-popup" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="success-popup-icon" aria-hidden="true">
                    <i class="ri-check-line"></i>
                </div>
                <h3 id="successTitle">Success!</h3>
                <p id="successMessage">Your changes have been saved successfully.</p>
                <button class="btn-success-ok" data-action="close-success-popup" aria-label="Close notification">OK</button>
            </div>
        </div>

        <!-- Profile Content -->
        
        <div class="profile-content">
            <!-- Sidebar -->
            <aside class="profile-sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-section="profile"><i class="ri-user-settings-line"></i> My Profile</a></li>
                    <li><a href="#" data-section="orders"><i class="ri-shopping-bag-3-line"></i> My Orders</a></li>
                    <li><a href="#" data-section="returns" id="returnsMenuLink"><i class="ri-arrow-go-back-line"></i> My Returns</a></li>
                    <li><a href="#" data-section="exchanges" id="exchangesMenuLink"><i class="ri-exchange-line"></i> My Exchanges</a></li>
                    <li><a href="#" data-section="tracking"><i class="ri-truck-line"></i> Track Shipment</a></li>
                    <li><a href="#" data-section="addresses"><i class="ri-map-pin-line"></i> Addresses</a></li>
                    <li><a href="#" data-section="queries" id="queriesMenuLink"><i class="ri-question-line"></i> Raised Queries</a></li>
                    <li><a href="#" data-section="wishlist"><i class="ri-heart-line"></i> Wishlist</a></li>
                    <li><a href="#" data-section="giftcards"><i class="ri-gift-line"></i> Gift Cards</a></li>
                    <li><a href="#" data-section="biometric"><i class="ri-fingerprint-line"></i> Biometric Login</a></li>
                    <li><a href="#" data-section="password"><i class="ri-lock-password-line"></i> Change Password</a></li>
                </ul>
            </aside>

            <!-- Main Content -->
            <div class="profile-main">
                <!-- My Profile Section -->
                <section class="profile-section active" id="section-profile">
                    <h2 class="section-title"><i class="ri-user-settings-line"></i> My Profile</h2>
                    <form class="profile-form" id="profileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" value="">
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" value="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="profileEmail">Email Address</label>
                            <input type="email" id="profileEmail" value="" disabled>
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Phone Number</label>
                            <input type="tel" id="profilePhone" value="">
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth</label>
                            <input type="date" id="dob">
                        </div>
                        <button type="submit" class="btn-save">Save Changes</button>
                    </form>
                </section>

                <!-- My Orders Section -->
                <section class="profile-section" id="section-orders">
                    <h2 class="section-title"><i class="ri-shopping-bag-3-line"></i> My Orders</h2>
                    <div class="orders-list" id="ordersList">
                        <!-- Orders will be loaded dynamically -->
                        <div class="loading-orders" style="text-align:center;padding:40px;color:#666;">
                            <i class="ri-loader-4-line" style="font-size:2rem;animation:spin 1s linear infinite;display:inline-block;"></i>
                            <p style="margin-top:16px;">Loading your orders...</p>
                        </div>
                    </div>
                </section>

                <!-- Track Shipment Section -->
                <section class="profile-section" id="section-tracking">
                    <h2 class="section-title"><i class="ri-truck-line"></i> Track Shipment</h2>
                    <div class="tracking-search">
                        <input type="text" id="trackingInput" placeholder="Enter Order ID or Tracking Number">
                        <button onclick="searchTracking()">Track</button>
                    </div>
                    <div class="tracking-result" id="trackingResult" style="display: none;">
                        <div class="tracking-header">
                            <div class="tracking-order-info">
                                <h3 id="trackingOrderId">Order #BLK2024120002</h3>
                                <p>Expected Delivery: December 10, 2024</p>
                            </div>
                            <span class="order-status shipped" id="trackingStatus">Shipped</span>
                        </div>
                        <div class="tracking-timeline">
                            <div class="tracking-step completed">
                                <div class="tracking-step-title">Order Placed</div>
                                <div class="tracking-step-desc">Your order has been placed successfully</div>
                                <div class="tracking-step-time">Dec 6, 2024 - 10:30 AM</div>
                            </div>
                            <div class="tracking-step completed">
                                <div class="tracking-step-title">Order Confirmed</div>
                                <div class="tracking-step-desc">Seller has confirmed your order</div>
                                <div class="tracking-step-time">Dec 6, 2024 - 11:45 AM</div>
                            </div>
                            <div class="tracking-step completed">
                                <div class="tracking-step-title">Packed</div>
                                <div class="tracking-step-desc">Your order has been packed and ready for dispatch</div>
                                <div class="tracking-step-time">Dec 6, 2024 - 4:30 PM</div>
                            </div>
                            <div class="tracking-step current">
                                <div class="tracking-step-title">Shipped</div>
                                <div class="tracking-step-desc">Package is in transit - Mumbai Hub</div>
                                <div class="tracking-step-time">Dec 7, 2024 - 9:15 AM</div>
                            </div>
                            <div class="tracking-step">
                                <div class="tracking-step-title">Out for Delivery</div>
                                <div class="tracking-step-desc">Package will be delivered today</div>
                                <div class="tracking-step-time">Pending</div>
                            </div>
                            <div class="tracking-step">
                                <div class="tracking-step-title">Delivered</div>
                                <div class="tracking-step-desc">Package has been delivered</div>
                                <div class="tracking-step-time">Pending</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Addresses Section -->
                <section class="profile-section" id="section-addresses">
                    <h2 class="section-title"><i class="ri-map-pin-line"></i> Saved Addresses</h2>
                    <div id="addressesContent">
                        <!-- Addresses will be loaded here -->
                    </div>
                    <div class="empty-state" id="emptyAddresses" style="display: none;">
                        <i class="ri-map-pin-line"></i>
                        <h3>No saved addresses</h3>
                        <p>Add your addresses for faster checkout</p>
                    </div>
                    <div style="text-align: right; margin-top: 20px;" id="addAddressContainer">
                        <button class="btn-save" data-action="open-address-modal"><i class="ri-add-line"></i> Add New Address</button>
                    </div>
                </section>

                <!-- My Returns Section -->
                <section class="profile-section" id="section-returns">
                    <h2 class="section-title"><i class="ri-arrow-go-back-line"></i> My Returns</h2>
                    <div class="returns-list" id="returnsList">
                        <!-- Returns will be loaded dynamically -->
                        <div class="loading-orders" style="text-align:center;padding:40px;color:#666;">
                            <i class="ri-loader-4-line" style="font-size:2rem;animation:spin 1s linear infinite;display:inline-block;"></i>
                            <p style="margin-top:16px;">Loading your returns...</p>
                        </div>
                    </div>
                    <div class="empty-state" id="emptyReturns" style="display: none;">
                        <i class="ri-arrow-go-back-line"></i>
                        <h3>No returns yet</h3>
                        <p>You haven't requested any returns</p>
                    </div>
                </section>

                <!-- My Exchanges Section -->
                <section class="profile-section" id="section-exchanges">
                    <h2 class="section-title"><i class="ri-exchange-line"></i> My Exchanges</h2>
                    <div class="exchanges-list" id="exchangesList">
                        <!-- Exchanges will be loaded dynamically -->
                        <div class="loading-orders" style="text-align:center;padding:40px;color:#666;">
                            <i class="ri-loader-4-line" style="font-size:2rem;animation:spin 1s linear infinite;display:inline-block;"></i>
                            <p style="margin-top:16px;">Loading your exchanges...</p>
                        </div>
                    </div>
                    <div class="empty-state" id="emptyExchanges" style="display: none;">
                        <i class="ri-exchange-line"></i>
                        <h3>No exchanges yet</h3>
                        <p>You haven't requested any exchanges</p>
                    </div>
                </section>

                <!-- Raised Queries Section -->
                <section class="profile-section" id="section-queries">
                    <h2 class="section-title"><i class="ri-question-line"></i> Raised Queries</h2>
                    <div id="queriesContent">
                        <!-- Queries will be loaded here -->
                    </div>
                    <div class="empty-state" id="emptyQueries" style="display: none;">
                        <i class="ri-question-line"></i>
                        <h3>No queries yet</h3>
                        <p>You haven't submitted any inquiries yet</p>
                        <a href="contact.html">Contact Us</a>
                    </div>
                </section>

                <!-- Wishlist Section -->
                <section class="profile-section" id="section-wishlist">
                    <h2 class="section-title"><i class="ri-heart-line"></i> My Wishlist</h2>
                    <div id="wishlistContent">
                        <!-- Wishlist items will be loaded here -->
                    </div>
                    <div class="empty-state" id="emptyWishlist" style="display: none;">
                        <i class="ri-heart-line"></i>
                        <h3>Your wishlist is empty</h3>
                        <p>Save your favorite items here to buy them later</p>
                        <a href="index.html#shop">Start Shopping</a>
                    </div>
                </section>

                <!-- Gift Cards Section -->
                <section class="profile-section" id="section-giftcards">
                    <h2 class="section-title"><i class="ri-gift-line"></i> My Gift Cards</h2>
                    
                    <!-- Summary Cards -->
                    <div class="giftcard-summary" id="giftcardSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="giftcard-stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Available Balance</div>
                            <div id="gcTotalBalance" style="font-size: 1.75rem; font-weight: 700; margin-top: 4px;">0</div>
                        </div>
                        <div class="giftcard-stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Total Purchased</div>
                            <div id="gcTotalPurchased" style="font-size: 1.75rem; font-weight: 700; margin-top: 4px;">0</div>
                        </div>
                        <div class="giftcard-stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Received as Gift</div>
                            <div id="gcTotalReceived" style="font-size: 1.75rem; font-weight: 700; margin-top: 4px;">0</div>
                        </div>
                        <div class="giftcard-stat-card" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.75rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Total Used</div>
                            <div id="gcTotalUsed" style="font-size: 1.75rem; font-weight: 700; margin-top: 4px;">0</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                        <button onclick="showBuyGiftCardModal()" class="btn-primary" style="padding: 12px 24px; background: #000; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="ri-shopping-cart-line"></i> Buy Gift Card
                        </button>
                        <button onclick="showRedeemGiftCardModal()" class="btn-secondary" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="ri-add-circle-line"></i> Add Gift Card
                        </button>
                        <button onclick="showCheckBalanceModal()" class="btn-secondary" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="ri-search-line"></i> Check Balance
                        </button>
                    </div>

                    <!-- Gift Cards List -->
                    <div class="giftcards-tabs" style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 12px;">
                        <button class="gc-tab active" data-filter="all" onclick="filterGiftCards('all', this)" style="padding: 8px 16px; border: none; background: #000; color: white; border-radius: 20px; cursor: pointer; font-size: 0.875rem;">All Cards</button>
                        <button class="gc-tab" data-filter="active" onclick="filterGiftCards('active', this)" style="padding: 8px 16px; border: none; background: #f3f4f6; color: #374151; border-radius: 20px; cursor: pointer; font-size: 0.875rem;">Active</button>
                        <button class="gc-tab" data-filter="used" onclick="filterGiftCards('used', this)" style="padding: 8px 16px; border: none; background: #f3f4f6; color: #374151; border-radius: 20px; cursor: pointer; font-size: 0.875rem;">Used</button>
                    </div>

                    <div id="giftcardsList" class="giftcards-list">
                        <!-- Gift cards will be loaded here -->
                        <div class="loading-orders" style="text-align:center;padding:40px;color:#666;">
                            <i class="ri-loader-4-line" style="font-size:2rem;animation:spin 1s linear infinite;display:inline-block;"></i>
                            <p style="margin-top:16px;">Loading your gift cards...</p>
                        </div>
                    </div>

                    <!-- Usage History -->
                    <div id="giftcardHistory" style="margin-top: 32px; display: none;">
                        <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="ri-history-line"></i> Usage History
                        </h3>
                        <div id="giftcardTransactions" class="transactions-list">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>

                    <div class="empty-state" id="emptyGiftcards" style="display: none;">
                        <i class="ri-gift-line"></i>
                        <h3>No gift cards yet</h3>
                        <p>Purchase a gift card for yourself or share one with a friend!</p>
                        <a href="gift-cards.html">Buy Gift Card</a>
                    </div>
                </section>

                <!-- Biometric Login Section -->
                <section class="profile-section" id="section-biometric">
                    <h2 class="section-title"><i class="ri-fingerprint-line"></i> Biometric Login</h2>
                    <div class="bio-container">
                        <!-- Hero Card -->
                        <div class="bio-hero">
                            <div class="bio-hero-content">
                                <div class="bio-hero-icon">
                                    <i class="ri-fingerprint-line"></i>
                                </div>
                                <div class="bio-hero-text">
                                    <h2>Biometric Authentication</h2>
                                    <p>Enable fingerprint or Face ID for quick, secure access to your account</p>
                                </div>
                            </div>
                        </div>

                        <!-- Status Card -->
                        <div class="bio-status-card">
                            <div class="bio-status-header" id="biometricStatusBox">
                                <div class="bio-status-left">
                                    <div class="bio-status-indicator active" id="bioIndicator">
                                        <i class="ri-shield-check-line"></i>
                                    </div>
                                    <div class="bio-status-text">
                                        <h4 id="biometricStatusTitle">Biometric Login</h4>
                                        <p id="biometricStatusDesc"><span id="biometricCredentialCount">0</span>/3 credentials registered</p>
                                    </div>
                                </div>
                                <label class="bio-toggle">
                                    <input type="checkbox" id="biometricToggle">
                                    <span class="bio-toggle-track"></span>
                                </label>
                            </div>

                            <!-- Devices Section -->
                            <div class="bio-devices-section" id="biometricCredentialsSection">
                                <div class="bio-devices-header">
                                    <h5><i class="ri-device-line"></i> Registered Devices</h5>
                                    <span class="bio-devices-count" id="devicesCount">0 devices</span>
                                </div>
                                <div class="bio-devices-list" id="biometricCredentialsList">
                                    <!-- Credentials loaded dynamically -->
                                    <div class="bio-empty-state" id="bioEmptyState">
                                        <i class="ri-fingerprint-line"></i>
                                        <p>No biometric credentials registered yet</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Button Section -->
                            <div class="bio-add-section" id="biometricAddSection">
                                <button class="bio-add-btn" id="btnAddBiometric" onclick="addNewBiometric()">
                                    <i class="ri-fingerprint-fill"></i> Register New Biometric
                                </button>
                                <p class="bio-limit-text" id="biometricLimitText">
                                    <i class="ri-information-line"></i> You can register up to 3 devices
                                </p>
                            </div>
                        </div>

                        <!-- Tips Card -->
                        <div class="bio-tips-card">
                            <h5><i class="ri-lightbulb-flash-line"></i> Security Tips</h5>
                            <ul class="bio-tips-list">
                                <li><i class="ri-check-double-line"></i> Your biometric data stays securely on your device</li>
                                <li><i class="ri-check-double-line"></i> Each device gets its own unique credential</li>
                                <li><i class="ri-check-double-line"></i> Remove unused devices for better security</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Change Password Section -->
                <section class="profile-section" id="section-password">
                    <h2 class="section-title"><i class="ri-lock-password-line"></i> Change Password</h2>
                    <div class="password-card">
                        <div class="password-card-header">
                            <h3><i class="ri-shield-check-line"></i> Update Your Password</h3>
                            <p>Keep your account secure with a strong password</p>
                        </div>
                        <form class="password-form" id="passwordChangeForm">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <div class="input-wrapper">
                                    <input type="password" id="currentPassword" placeholder="Enter your current password" required>
                                    <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('currentPassword', this)">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <div class="input-wrapper">
                                    <input type="password" id="newPassword" placeholder="Enter new password" required>
                                    <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('newPassword', this)">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strengthFill"></div>
                                </div>
                                <div class="strength-text" id="strengthText"></div>
                            </div>
                            <div class="form-group">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <div class="input-wrapper">
                                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
                                    <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('confirmNewPassword', this)">
                                        <i class="ri-eye-line"></i>
                                    </button>
                                </div>
                                <div class="mismatch-error" id="passwordMismatchError">
                                    <i class="ri-error-warning-line"></i> Passwords do not match
                                </div>
                            </div>
                            <div class="requirements-box">
                                <h4><i class="ri-information-line"></i> Password Requirements</h4>
                                <div class="requirements-grid">
                                    <div class="req-item" id="req-length"><i class="ri-checkbox-blank-circle-line"></i><span>At least 8 characters</span></div>
                                    <div class="req-item" id="req-uppercase"><i class="ri-checkbox-blank-circle-line"></i><span>One uppercase letter (A-Z)</span></div>
                                    <div class="req-item" id="req-lowercase"><i class="ri-checkbox-blank-circle-line"></i><span>One lowercase letter (a-z)</span></div>
                                    <div class="req-item" id="req-number"><i class="ri-checkbox-blank-circle-line"></i><span>One number (0-9)</span></div>
                                    <div class="req-item" id="req-special"><i class="ri-checkbox-blank-circle-line"></i><span>One special character (@$!%*?&)</span></div>
                                </div>
                            </div>
                            <button type="submit" class="submit-btn" id="btnChangePassword">
                                <i class="ri-lock-password-line"></i> Update Password
                            </button>
                        </form>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" style="display: none;">
        <i class="ri-menu-line"></i>
    </button>

    <!-- Mobile Bottom Navigation - App Style -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <a href="#" class="nav-item active" data-section="profile">
            <i class="ri-user-3-line"></i>
            <span>Profile</span>
        </a>
        <a href="#" class="nav-item" data-section="orders">
            <i class="ri-shopping-bag-3-line"></i>
            <span>Orders</span>
        </a>
        <a href="#" class="nav-item" data-section="tracking">
            <i class="ri-truck-line"></i>
            <span>Track</span>
        </a>
        <a href="#" class="nav-item" data-section="wishlist">
            <i class="ri-heart-3-line"></i>
            <span>Wishlist</span>
        </a>
        <a href="#" class="nav-item" data-section="more" id="mobileMoreBtn">
            <i class="ri-menu-line"></i>
            <span>More</span>
        </a>
    </nav>
    
    <!-- Mobile More Menu Popup -->
    <div class="mobile-more-menu-overlay" id="mobileMoreMenuOverlay">
        <div class="mobile-more-menu" id="mobileMoreMenu">
            <div class="more-menu-header">
                <h4>More Options</h4>
                <button class="more-menu-close" id="moreMenuClose" title="Close menu" aria-label="Close menu">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="more-menu-items">
                <a href="#" class="more-menu-item" data-section="returns">
                    <i class="ri-arrow-go-back-line"></i>
                    <span>My Returns</span>
                </a>
                <a href="#" class="more-menu-item" data-section="exchanges">
                    <i class="ri-exchange-line"></i>
                    <span>My Exchanges</span>
                </a>
                <a href="#" class="more-menu-item" data-section="addresses">
                    <i class="ri-map-pin-line"></i>
                    <span>Saved Addresses</span>
                </a>
                <a href="#" class="more-menu-item" data-section="queries">
                    <i class="ri-question-answer-line"></i>
                    <span>Raised Queries</span>
                </a>
                <a href="#" class="more-menu-item" data-section="giftcards">
                    <i class="ri-gift-line"></i>
                    <span>Gift Cards</span>
                </a>
                <a href="#" class="more-menu-item" data-section="biometric">
                    <i class="ri-fingerprint-line"></i>
                    <span>Biometric Login</span>
                </a>
                <a href="#" class="more-menu-item" data-section="password">
                    <i class="ri-lock-password-line"></i>
                    <span>Change Password</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script>
        // Local SVG placeholder generator - no external service needed
        function getPlaceholder(width = 100, height = 100, text = 'No Image') {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                <rect fill="#f0f0f0" width="${width}" height="${height}"/>
                <text fill="#999" font-family="Arial,sans-serif" font-size="${Math.min(width, height) / 8}" text-anchor="middle" x="${width/2}" y="${height/2}" dy=".3em">${text}</text>
            </svg>`;
            return 'data:image/svg+xml,' + encodeURIComponent(svg);
        }

        // Feature visibility settings (fetched from server)
        let featureVisibility = { 
            invoiceEnabled: false, 
            giftCardsEnabled: false,
            returnsEnabled: true,
            exchangesEnabled: true
        };
        let featureVisibilityLoaded = false;
        
        async function loadFeatureVisibility(forceReload = false) {
            if (featureVisibilityLoaded && !forceReload) return;
            try {
                // Load marketing features (with cache busting)
                const marketingResponse = await fetch('/api/marketing/feature-visibility?_=' + Date.now(), { 
                    cache: 'no-store',
                    credentials: 'include'
                });
                const marketingContentType = marketingResponse.headers.get('content-type');
                if (marketingContentType && marketingContentType.includes('application/json')) {
                    const marketingData = await marketingResponse.json();
                    if (marketingData.success && marketingData.features) {
                        // Merge marketing features
                        Object.assign(featureVisibility, marketingData.features);
                    }
                }
                
                // Load tax settings for invoice visibility - THIS IS THE AUTHORITATIVE SOURCE
                const taxResponse = await fetch('/api/tax/feature-visibility?_=' + Date.now(), { 
                    cache: 'no-store',
                    credentials: 'include'
                });
                const taxContentType = taxResponse.headers.get('content-type');
                if (taxContentType && taxContentType.includes('application/json')) {
                    const taxData = await taxResponse.json();
                    console.log('[Profile] Tax feature visibility:', taxData);
                    if (taxData.success && taxData.features) {
                        // Authoritatively set invoiceEnabled from tax data
                        featureVisibility.invoiceEnabled = taxData.features.invoiceEnabled === true;
                        console.log('[Profile] Resulting invoiceEnabled status:', featureVisibility.invoiceEnabled);
                    }
                }
                featureVisibilityLoaded = true;
            } catch (e) {
                console.warn('Could not load feature visibility:', e);
                featureVisibilityLoaded = true;
            }
        }
        
        // Load feature visibility immediately
        const featureVisibilityPromise = loadFeatureVisibility();

        // Check if user is logged in
        async function checkLogin() {
            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                // Update profile with user data
                if (user.name) {
                    document.getElementById('userName').textContent = user.name;
                    const names = user.name.split(' ');
                    document.getElementById('firstName').value = names[0] || '';
                    document.getElementById('lastName').value = names.slice(1).join(' ') || '';
                }
                if (user.email) {
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('profileEmail').value = user.email;
                }
                if (user.phone) {
                    document.getElementById('userPhone').textContent = user.phone;
                    document.getElementById('profilePhone').value = user.phone;
                }
                
                // Set member since date
                if (user.createdAt) {
                    const joinDate = new Date(user.createdAt);
                    const memberSince = joinDate.toLocaleDateString('en-US', { 
                        month: 'long', 
                        year: 'numeric' 
                    });
                    document.getElementById('memberSince').textContent = `Member since ${memberSince}`;
                }

                // Initialize query notification badge and check every 5 seconds
                updateQueryNotificationBadge();
                setInterval(updateQueryNotificationBadge, 5000);
            } catch (err) {
                console.error('Error checking login:', err);
                window.location.href = 'login.html';
            }
        }

        async function updateQueryNotificationBadge() {
            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) return;
                
                // Fetch contact messages from API
                let allMessages = [];
                try {
                    const result = await API.contact.getMine();
                    allMessages = result.messages || [];
                } catch (e) {
                    console.error('Failed to fetch messages:', e);
                    return;
                }
                
                // Get last read timestamp
                const lastReadTime = parseInt(localStorage.getItem('blackonn_queries_last_read') || '0');
                
                // Count queries with unread replies (replies after last read time)
                const queriesWithUnreadReplies = allMessages.filter(msg => {
                    if (!msg.replies || msg.replies.length === 0) return false;
                    // Check if any reply is newer than last read time
                    return msg.replies.some(reply => {
                        const replyTime = new Date(reply.createdAt || reply.timestamp).getTime();
                        return replyTime > lastReadTime && !reply.isUserReply;
                    });
                });
                
                const queriesLink = document.getElementById('queriesMenuLink');
                // Check both desktop sidebar and mobile "more menu" items
                const mobileQueriesLink = document.querySelector('.mobile-bottom-nav .nav-item[data-section="queries"], .more-menu-item[data-section="queries"]');
                
                // Remove existing notification dots
                const existingDots = document.querySelectorAll('.query-notification-dot');
                existingDots.forEach(dot => dot.remove());

                // Add notification dot only if there are unread replies
                if (queriesWithUnreadReplies.length > 0) {
                    const dotText = queriesWithUnreadReplies.length > 9 ? '9+' : queriesWithUnreadReplies.length;
                    
                    // Add to desktop sidebar
                    if (queriesLink) {
                        const dot = document.createElement('span');
                        dot.className = 'query-notification-dot';
                        dot.textContent = dotText;
                        queriesLink.appendChild(dot);
                    }
                    
                    // Add to mobile nav
                    if (mobileQueriesLink) {
                        const dot = document.createElement('span');
                        dot.className = 'query-notification-dot';
                        dot.textContent = dotText;
                        mobileQueriesLink.appendChild(dot);
                    }
                }
            } catch (error) {
                console.error('Error updating query notification:', error);
            }
        }

        // Section navigation - Desktop sidebar and mobile bottom nav
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const mobileNavLinks = document.querySelectorAll('.mobile-bottom-nav .nav-item');
        const moreMenuOverlay = document.getElementById('mobileMoreMenuOverlay');
        const moreMenuClose = document.getElementById('moreMenuClose');
        const moreMenuItems = document.querySelectorAll('.more-menu-item');
        
        // Function to open More menu
        function openMoreMenu() {
            moreMenuOverlay.classList.add('show');
            // document.body.style.overflow = 'hidden'; // Removed to prevent scroll jump
        }
        
        // Function to close More menu
        function closeMoreMenu() {
            moreMenuOverlay.classList.remove('show');
            // document.body.style.overflow = ''; // Removed
        }
        
        // Handle sidebar clicks
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                showSection(section);
                
                // Update active state for both desktop and mobile
                updateNavActiveState(section);
            });
        });

        // Handle mobile bottom nav clicks
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                
                // Handle "More" button
                if (section === 'more') {
                    openMoreMenu();
                    return;
                }
                
                showSection(section);
                
                // Update active state for both desktop and mobile
                updateNavActiveState(section);
            });
        });
        
        // Handle More menu close
        if (moreMenuClose) {
            moreMenuClose.addEventListener('click', closeMoreMenu);
        }
        
        // Handle More menu overlay click to close
        if (moreMenuOverlay) {
            moreMenuOverlay.addEventListener('click', (e) => {
                if (e.target === moreMenuOverlay) {
                    closeMoreMenu();
                }
            });
        }
        
        // Handle More menu item clicks
        moreMenuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                closeMoreMenu();
                showSection(section);
                updateNavActiveState(section);
            });
        });

        // Function to update active state for both desktop sidebar and mobile nav
        function updateNavActiveState(activeSection) {
            // Update sidebar active state
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === activeSection) {
                    link.classList.add('active');
                }
            });
            
            // Update mobile nav active state (only for main nav items, not More menu items)
            mobileNavLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === activeSection) {
                    link.classList.add('active');
                }
            });
            
            // If active section is in More menu, highlight More button
            const moreMenuSections = ['returns', 'addresses', 'queries'];
            const moreBtn = document.getElementById('mobileMoreBtn');
            if (moreMenuSections.includes(activeSection)) {
                moreBtn?.classList.add('active');
            }
        }

        function showSection(sectionName) {
            // Check visibility based on admin settings
            if (sectionName === 'giftcards' && sectionVisibility.giftCards === false) {
                sectionName = 'profile';
            } else if (sectionName === 'returns' && sectionVisibility.returns === false) {
                sectionName = 'profile';
            } else if (sectionName === 'exchanges' && sectionVisibility.exchanges === false) {
                sectionName = 'profile';
            }

            document.querySelectorAll('.profile-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('section-' + sectionName).classList.add('active');
            
            // Load section-specific data
            if (sectionName === 'orders') {
                loadUserOrders();
            } else if (sectionName === 'returns') {
                loadUserReturns();
            } else if (sectionName === 'exchanges') {
                loadUserExchanges();
            } else if (sectionName === 'queries') {
                loadUserQueries();
                // Mark queries as read when opening the section
                markQueriesAsRead();
            } else if (sectionName === 'wishlist') {
                loadWishlist();
            } else if (sectionName === 'giftcards') {
                loadUserGiftCards();
            }
            
            // Update active state for both desktop and mobile navigation
            updateNavActiveState(sectionName);
        }

        // Profile form submit - Save to API
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('profilePhone').value;
            const dob = document.getElementById('dob').value;
            
            const user = await window.blackonnAuth.getCurrentUser();
            if (!user) {
                showSuccessPopup('Error', 'Please login to update your profile');
                return;
            }
            const fullName = firstName + ' ' + lastName;

            try {
                // Update profile via API
                const response = await API.users.update(user.id, {
                    name: fullName,
                    phone: phone,
                    dob: dob
                });

                if (response.success) {
                    // Update UI directly - no localStorage needed, data is on server
                    document.getElementById('userName').textContent = fullName;
                    document.getElementById('userPhone').textContent = phone;
                    
                    // Clear cached user to force refresh
                    window.blackonnAuth._cachedUser = null;
                    
                    showSuccessPopup('Profile Updated!', 'Your profile has been saved successfully.');
                } else {
                    showSuccessPopup('Error', response.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showSuccessPopup('Error', 'Failed to save profile. Please try again.');
            }
        });

        // =====================================================
        // PASSWORD CHANGE FUNCTIONALITY (Clean Rebuild)
        // =====================================================
        
        // Toggle password visibility - simple and static
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'ri-eye-off-line';
            } else {
                input.type = 'password';
                icon.className = 'ri-eye-line';
            }
        }

        // Password validation
        function validatePasswordRequirements(password) {
            return {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[@$!%*?&]/.test(password)
            };
        }

        // Update requirement indicators
        function updateRequirementIndicators(requirements) {
            Object.entries(requirements).forEach(([key, valid]) => {
                const el = document.getElementById(`req-${key}`);
                if (el) {
                    el.classList.toggle('valid', valid);
                    el.querySelector('i').className = valid ? 'ri-checkbox-circle-fill' : 'ri-checkbox-blank-circle-line';
                }
            });
        }

        // Calculate password strength
        function getPasswordStrength(password) {
            const reqs = validatePasswordRequirements(password);
            const count = Object.values(reqs).filter(Boolean).length;
            if (count <= 1) return { level: 'weak', text: 'Weak password' };
            if (count <= 2) return { level: 'fair', text: 'Fair password' };
            if (count <= 4) return { level: 'good', text: 'Good password' };
            return { level: 'strong', text: 'Strong password' };
        }

        // Update password strength display
        function updatePasswordStrength(password) {
            const fill = document.getElementById('strengthFill');
            const text = document.getElementById('strengthText');
            if (!password) {
                fill.className = 'strength-fill';
                text.className = 'strength-text';
                text.textContent = '';
                return;
            }
            const strength = getPasswordStrength(password);
            fill.className = `strength-fill ${strength.level}`;
            text.className = `strength-text ${strength.level}`;
            text.textContent = strength.text;
        }

        // Check passwords match
        function checkPasswordsMatch() {
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmNewPassword').value;
            const confirmInput = document.getElementById('confirmNewPassword');
            const errorEl = document.getElementById('passwordMismatchError');
            
            if (confirmPwd && newPwd !== confirmPwd) {
                errorEl.classList.add('show');
                confirmInput.classList.add('invalid');
                confirmInput.classList.remove('valid');
                return false;
            } else if (confirmPwd && newPwd === confirmPwd) {
                errorEl.classList.remove('show');
                confirmInput.classList.remove('invalid');
                confirmInput.classList.add('valid');
                return true;
            } else {
                errorEl.classList.remove('show');
                confirmInput.classList.remove('invalid', 'valid');
                return !confirmPwd;
            }
        }

        // Initialize password change form
        function initPasswordChangeForm() {
            const currentPwdInput = document.getElementById('currentPassword');
            const newPwdInput = document.getElementById('newPassword');
            const confirmPwdInput = document.getElementById('confirmNewPassword');
            const form = document.getElementById('passwordChangeForm');
            
            if (!newPwdInput || !form) return;

            if (currentPwdInput) {
                currentPwdInput.addEventListener('input', (e) => {
                    e.target.classList.toggle('valid', e.target.value.length > 0);
                });
            }

            newPwdInput.addEventListener('input', (e) => {
                const pwd = e.target.value;
                const reqs = validatePasswordRequirements(pwd);
                const allValid = Object.values(reqs).every(Boolean);
                updateRequirementIndicators(reqs);
                updatePasswordStrength(pwd);
                checkPasswordsMatch();
                newPwdInput.classList.toggle('valid', allValid);
                if (!allValid && pwd.length > 0) newPwdInput.classList.remove('valid');
                if (!pwd) newPwdInput.classList.remove('valid', 'invalid');
            });

            confirmPwdInput.addEventListener('input', checkPasswordsMatch);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPwd = currentPwdInput.value;
                const newPwd = newPwdInput.value;
                const confirmPwd = confirmPwdInput.value;
                const submitBtn = document.getElementById('btnChangePassword');

                if (!currentPwd) {
                    showSuccessPopup('Error', 'Please enter your current password');
                    currentPwdInput.classList.add('invalid');
                    currentPwdInput.focus();
                    return;
                }

                const reqs = validatePasswordRequirements(newPwd);
                if (!Object.values(reqs).every(Boolean)) {
                    showSuccessPopup('Error', 'Please meet all password requirements');
                    newPwdInput.classList.add('invalid');
                    newPwdInput.focus();
                    return;
                }

                if (newPwd !== confirmPwd) {
                    showSuccessPopup('Error', 'Passwords do not match');
                    confirmPwdInput.classList.add('invalid');
                    confirmPwdInput.focus();
                    return;
                }

                if (currentPwd === newPwd) {
                    showSuccessPopup('Error', 'New password must be different from current password');
                    newPwdInput.classList.add('invalid');
                    return;
                }

                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) {
                    showSuccessPopup('Error', 'Please login to change your password');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="ri-loader-4-line"></i> Updating...';

                try {
                    const response = await API.users.changePassword(user.id, currentPwd, newPwd);
                    
                    if (response.success) {
                        showSuccessPopup('Password Updated!', 'Your password has been changed successfully');
                        form.reset();
                        updateRequirementIndicators({ length: false, uppercase: false, lowercase: false, number: false, special: false });
                        updatePasswordStrength('');
                        currentPwdInput.classList.remove('valid', 'invalid');
                        newPwdInput.classList.remove('valid', 'invalid');
                        confirmPwdInput.classList.remove('valid', 'invalid');
                    } else {
                        showSuccessPopup('Error', response.error || 'Failed to change password');
                        if (response.error && response.error.toLowerCase().includes('current password')) {
                            currentPwdInput.classList.add('invalid');
                            currentPwdInput.focus();
                        }
                    }
                } catch (error) {
                    console.error('Password change error:', error);
                    const errMsg = error.message || 'Failed to change password. Please try again.';
                    showSuccessPopup('Error', errMsg);
                    if (errMsg.toLowerCase().includes('current') || errMsg.toLowerCase().includes('incorrect')) {
                        currentPwdInput.classList.add('invalid');
                        currentPwdInput.focus();
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="ri-lock-password-line"></i> Update Password';
                }
            });
        }

        initPasswordChangeForm();
        // =====================================================
        // END PASSWORD CHANGE FUNCTIONALITY
        // =====================================================

        // Success popup functions - now uses Dynamic Island toast
        function showSuccessPopup(title, message) {
            // Determine notification type based on title
            let type = 'info';
            const titleLower = title.toLowerCase();
            if (titleLower.includes('error') || titleLower.includes('failed') || titleLower.includes('cannot') || titleLower.includes('expired')) {
                type = 'error';
            } else if (titleLower.includes('success') || titleLower.includes('updated') || titleLower.includes('submitted') || titleLower.includes('added') || titleLower.includes('cancelled') || titleLower.includes('sent')) {
                type = 'success';
            } else if (titleLower.includes('warning') || titleLower.includes('not available')) {
                type = 'warning';
            }
            
            // Use global showToast for Dynamic Island style notification
            if (window.showToast) {
                window.showToast(`${title}: ${message}`, type, 5000);
            } else {
                // Fallback to old popup if showToast not available
                document.getElementById('successTitle').textContent = title;
                document.getElementById('successMessage').textContent = message;
                document.getElementById('successPopup').classList.add('show');
            }
        }

        function closeSuccessPopup() {
            document.getElementById('successPopup').classList.remove('show');
        }

        // Close success popup when clicking outside or OK button (kept for fallback)
        document.getElementById('successPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessPopup();
                return;
            }
            
            const button = e.target.closest('button[data-action]');
            if (button && button.dataset.action === 'close-success-popup') {
                closeSuccessPopup();
            }
        });

        // Load user orders from API
        async function loadUserOrders() {
            try {
                // Ensure feature visibility is loaded before rendering orders
                await featureVisibilityPromise;
                
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user || !user.email) {
                    document.getElementById('ordersList').innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#666;"><i class="ri-shopping-bag-3-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i><p>No orders found. Start shopping to see your orders here.</p></div>';
                    return;
                }

                // Fetch orders from API
                const response = await API.orders.getMine();
                const userOrders = response.orders || [];

                if (userOrders.length === 0) {
                    document.getElementById('ordersList').innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#666;"><i class="ri-shopping-bag-3-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i><p>No orders found. Start shopping to see your orders here.</p></div>';
                    return;
                }

                // Sort orders by date (newest first)
                userOrders.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                const ordersHtml = userOrders.map(order => {
                    const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Unknown date';

                    const statusClass = order.status?.toLowerCase() || 'pending';
                    const statusText = order.status || 'Pending';

                    const itemsHtml = order.items?.map(item => `
                        <div class="order-item">
                            <a href="products.html?id=${item.id || item.productId || ''}" class="order-item-image product-link">
                                <img src="${normalizeUploadUrl(item.image || item.thumbImage) || getPlaceholder(80,80,'Product')}" 
                                     alt="${item.name || 'Product'}" 
                                     onerror="this.src=getPlaceholder(80,80,'Product')">
                            </a>
                            <div class="order-item-details">
                                <a href="products.html?id=${item.id || item.productId || ''}" class="order-item-name product-link">${item.name || 'Product'}</a>
                                <div class="order-item-meta">Size: ${item.size || '-'} | Color: ${item.color || '-'} | Qty: ${item.quantity || 1}</div>
                            </div>
                            <div class="order-item-price">${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</div>
                        </div>
                    `).join('') || '<div class="order-item"><div class="order-item-details"><div class="order-item-name">No items</div></div></div>';

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">Order #${order.id}</div>
                                <div class="order-date">Placed on ${orderDate}</div>
                            </div>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        <div class="order-footer">
                            <div class="order-total">Total: ${(order.total || order.amount || 0).toLocaleString()}</div>
                            <div class="order-actions">
                                <button class="btn-track" data-action="track" data-order-id="${order.id}">Track Order</button>
                                ${featureVisibility.invoiceEnabled ? `<button class="btn-invoice" data-action="invoice" data-order-id="${order.id}"><i class="ri-file-pdf-line"></i>Invoice</button>` : ''}
                                <button class="btn-reorder" data-action="reorder" data-order-id="${order.id}">Reorder</button>
                                ${order.status === 'Delivered' ? `<button class="btn-exchange" data-action="exchange" data-order-id="${order.id}">Exchange</button>` : ''}
                                ${order.status === 'Exchange Requested' ? `<span class="btn-status-info" style="color:#f59e0b;font-size:12px;"><i class="ri-exchange-line"></i> Exchange Requested</span>` : ''}
                                ${!['Shipped', 'Delivered', 'Cancelled', 'Return Requested', 'Exchange Requested'].includes(order.status) ? `<button class="btn-cancel-order" data-action="cancel-order" data-order-id="${order.id}">Cancel</button>` : ''}
                                ${order.status === 'Delivered' ? `<button class="btn-return" data-action="return" data-order-id="${order.id}">Return</button>` : ''}
                                ${order.status === 'Return Requested' ? `<span class="btn-status-info" style="color:#3b82f6;font-size:12px;"><i class="ri-arrow-go-back-line"></i> Return Requested</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('ordersList').innerHTML = ordersHtml;
            } catch (error) {
                console.error('Failed to load orders:', error);
                document.getElementById('ordersList').innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#e74c3c;"><i class="ri-error-warning-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i><p>Failed to load orders. Please try again.</p><button data-action="retry" style="margin-top:16px;padding:10px 20px;background:#000;color:#fff;border:none;border-radius:8px;cursor:pointer;">Retry</button></div>';
            }
        }

        // Load user returns from API
        async function loadUserReturns() {
            try {
                const response = await API.returns.getMine();
                const userReturns = response.returns || [];

                if (userReturns.length === 0) {
                    document.getElementById('returnsList').innerHTML = '';
                    document.getElementById('emptyReturns').style.display = 'flex';
                    return;
                }

                document.getElementById('emptyReturns').style.display = 'none';

                const returnsHtml = userReturns.map(returnReq => {
                    const returnDate = returnReq.createdAt 
                        ? new Date(returnReq.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) 
                        : 'Unknown';
                    
                    const status = returnReq.status || 'Pending';
                    const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                    
                    const itemsHtml = (returnReq.items || []).map(item => `
                        <div class="order-item">
                            <a href="products.html?id=${item.id || item.productId || ''}" class="order-item-image product-link">
                                <img src="${normalizeUploadUrl(item.image) || getPlaceholder(80,80,'Product')}" alt="${item.name || 'Product'}" onerror="this.parentElement.innerHTML='<i class=\\'ri-image-line\\'></i>'">
                            </a>
                            <div class="order-item-details">
                                <a href="products.html?id=${item.id || item.productId || ''}" class="order-item-name product-link">${item.name || 'Unknown Product'}</a>
                                <div class="order-item-meta">Size: ${item.size || '-'} | Color: ${item.color || '-'}</div>
                                <div class="order-item-price">${(item.price || 0).toLocaleString()} x ${item.quantity || 1}</div>
                            </div>
                        </div>
                    `).join('');

                    // Return tracking timeline
                    const timelineHtml = getReturnTimeline(status);

                    return `
                        <div class="order-card return-card">
                            <div class="order-header">
                                <div>
                                    <div class="order-id">Return #${returnReq.id}</div>
                                    <div class="order-date">Requested on ${returnDate}</div>
                                    <div class="order-date" style="color:#666;font-size:12px;">Order: #${returnReq.orderId}</div>
                                </div>
                                <span class="return-status ${statusClass}">${status}</span>
                            </div>
                            <div class="order-items">
                                ${itemsHtml}
                            </div>
                            <div class="return-info-box" style="padding:15px 20px;background:#f8f9fa;border-top:1px solid #eee;">
                                <p style="margin:0 0 8px 0;font-size:14px;"><strong>Reason:</strong> ${(returnReq.reason || 'Not specified').replace(/_/g, ' ')}</p>
                                ${returnReq.description ? `<p style="margin:0;font-size:13px;color:#666;"><strong>Details:</strong> ${returnReq.description}</p>` : ''}
                                ${returnReq.adminNotes ? `<p style="margin:8px 0 0 0;font-size:13px;color:#1565c0;"><strong>Admin Note:</strong> ${returnReq.adminNotes}</p>` : ''}
                            </div>
                            <div class="return-timeline-section" style="padding:20px;border-top:1px solid #eee;">
                                <h4 style="margin:0 0 15px 0;font-size:14px;color:#333;">Return Progress</h4>
                                <div class="return-tracking-timeline">
                                    ${timelineHtml}
                                </div>
                            </div>
                            <div class="order-footer">
                                <div class="order-total">Refund Amount: ${(returnReq.refundAmount || 0).toLocaleString()}</div>
                                <div class="order-actions">
                                    <button class="btn-track" data-action="track-return" data-return-id="${returnReq.id}">Track Return</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('returnsList').innerHTML = returnsHtml;
            } catch (error) {
                console.error('Failed to load returns:', error);
                document.getElementById('returnsList').innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#e74c3c;"><i class="ri-error-warning-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i><p>Failed to load returns. Please try again.</p></div>';
            }
        }

        // Get return timeline HTML based on status
        function getReturnTimeline(status) {
            const steps = [
                { key: 'Pending', label: 'Request Submitted', icon: 'ri-file-list-3-line' },
                { key: 'Approved', label: 'Approved', icon: 'ri-checkbox-circle-line' },
                { key: 'Pickup Scheduled', label: 'Pickup Scheduled', icon: 'ri-calendar-check-line' },
                { key: 'Picked Up', label: 'Item Picked Up', icon: 'ri-truck-line' },
                { key: 'Processing', label: 'Processing', icon: 'ri-loop-left-line' },
                { key: 'Refunded', label: 'Refunded', icon: 'ri-money-dollar-circle-line' }
            ];

            const statusOrder = ['Pending', 'Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'Refunded', 'Completed'];
            const currentIndex = statusOrder.indexOf(status);
            const isRejected = status === 'Rejected';

            if (isRejected) {
                return `
                    <div class="return-step completed" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:#e8f5e9;display:flex;align-items:center;justify-content:center;color:#2e7d32;">
                            <i class="ri-file-list-3-line"></i>
                        </div>
                        <span style="font-size:14px;">Request Submitted</span>
                    </div>
                    <div class="return-step rejected" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:#ffebee;display:flex;align-items:center;justify-content:center;color:#c62828;">
                            <i class="ri-close-circle-line"></i>
                        </div>
                        <span style="font-size:14px;color:#c62828;font-weight:500;">Request Rejected</span>
                    </div>
                `;
            }

            return steps.map((step, index) => {
                const stepIndex = statusOrder.indexOf(step.key);
                const isCompleted = stepIndex <= currentIndex;
                const isCurrent = stepIndex === currentIndex;
                
                const bgColor = isCompleted ? '#e8f5e9' : '#f5f5f5';
                const iconColor = isCompleted ? '#2e7d32' : '#999';
                const textColor = isCurrent ? '#000' : (isCompleted ? '#2e7d32' : '#999');
                const fontWeight = isCurrent ? '600' : '400';

                return `
                    <div class="return-step ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:${bgColor};display:flex;align-items:center;justify-content:center;color:${iconColor};">
                            <i class="${step.icon}"></i>
                        </div>
                        <span style="font-size:14px;color:${textColor};font-weight:${fontWeight};">${step.label}</span>
                    </div>
                `;
            }).join('');
        }

        // Load user exchanges from API
        async function loadUserExchanges() {
            try {
                const response = await API.exchanges.getMine();
                const userExchanges = response.exchanges || [];

                if (userExchanges.length === 0) {
                    document.getElementById('exchangesList').innerHTML = '';
                    document.getElementById('emptyExchanges').style.display = 'flex';
                    return;
                }

                document.getElementById('emptyExchanges').style.display = 'none';

                const exchangesHtml = userExchanges.map(exchange => {
                    const exchangeDate = exchange.createdAt 
                        ? new Date(exchange.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) 
                        : 'Unknown';
                    
                    const status = exchange.status || 'Pending';
                    const statusClass = status.toLowerCase().replace(/\s+/g, '-');
                    
                    const itemsHtml = (exchange.items || []).map(item => `
                        <div class="order-item">
                            <a href="products.html?id=${item.productId || item.id || ''}" class="order-item-image product-link">
                                <img src="${normalizeUploadUrl(item.image) || getPlaceholder(80,80,'Product')}" alt="${item.name || 'Product'}" onerror="this.parentElement.innerHTML='<i class=\\'ri-image-line\\'></i>'">
                            </a>
                            <div class="order-item-details">
                                <a href="products.html?id=${item.productId || item.id || ''}" class="order-item-name product-link">${item.name || 'Unknown Product'}</a>
                                <div class="order-item-meta">Size: ${item.size || '-'} | Color: ${item.color || '-'}</div>
                                <div class="order-item-price">${(item.price || 0).toLocaleString()} x ${item.quantity || 1}</div>
                            </div>
                        </div>
                    `).join('');

                    // Exchange tracking timeline
                    const timelineHtml = getExchangeTimeline(status);

                    // Exchange for info
                    const exchangeForText = {
                        'different_size': 'Different Size',
                        'different_color': 'Different Color',
                        'different_product': 'Different Product'
                    }[exchange.exchangeFor] || exchange.exchangeFor || 'Not specified';

                    return `
                        <div class="order-card exchange-card">
                            <div class="order-header">
                                <div>
                                    <div class="order-id" style="color:#f59e0b;">Exchange #${exchange.id}</div>
                                    <div class="order-date">Requested on ${exchangeDate}</div>
                                    <div class="order-date" style="color:#666;font-size:12px;">Order: #${exchange.orderId}</div>
                                </div>
                                <span class="exchange-status ${statusClass}">${status}</span>
                            </div>
                            <div class="order-items">
                                ${itemsHtml}
                            </div>
                            <div class="exchange-info-box" style="padding:15px 20px;background:#fffbeb;border-top:1px solid #fef3c7;">
                                <p style="margin:0 0 8px 0;font-size:14px;"><strong><i class="ri-exchange-line" style="color:#f59e0b;"></i> Exchange For:</strong> ${exchangeForText}</p>
                                <p style="margin:0 0 8px 0;font-size:14px;"><strong>Reason:</strong> ${(exchange.reason || 'Not specified').replace(/_/g, ' ')}</p>
                                ${exchange.newSize || exchange.newColor ? `
                                <div style="margin:10px 0;padding:10px;background:#f0fdf4;border-radius:8px;border-left:3px solid #22c55e;">
                                    <p style="margin:0;font-size:13px;font-weight:600;color:#15803d;"><i class="ri-arrow-right-circle-line"></i> Requested New:</p>
                                    ${exchange.newSize ? `<p style="margin:4px 0 0 0;font-size:13px;"><strong>Size:</strong> <span style="color:#15803d;font-weight:600;">${exchange.newSize}</span></p>` : ''}
                                    ${exchange.newColor ? `<p style="margin:4px 0 0 0;font-size:13px;"><strong>Color:</strong> <span style="color:#15803d;font-weight:600;">${exchange.newColor}</span></p>` : ''}
                                </div>
                                ` : ''}
                                ${exchange.description ? `<p style="margin:8px 0 0 0;font-size:13px;color:#666;"><strong>Details:</strong> ${exchange.description}</p>` : ''}
                                ${exchange.adminNotes ? `<p style="margin:8px 0 0 0;font-size:13px;color:#d97706;"><strong>Admin Note:</strong> ${exchange.adminNotes}</p>` : ''}
                            </div>
                            <div class="exchange-timeline-section" style="padding:20px;border-top:1px solid #eee;">
                                <h4 style="margin:0 0 15px 0;font-size:14px;color:#333;"><i class="ri-exchange-line" style="color:#f59e0b;"></i> Exchange Progress</h4>
                                <div class="exchange-tracking-timeline">
                                    ${timelineHtml}
                                </div>
                            </div>
                            <div class="order-footer">
                                <div class="order-total" style="color:#f59e0b;">Exchange ID: ${exchange.id}</div>
                                <div class="order-actions">
                                    <button class="btn-track" style="background:#f59e0b;" data-action="track-exchange" data-exchange-id="${exchange.id}">Track Exchange</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('exchangesList').innerHTML = exchangesHtml;
            } catch (error) {
                console.error('Failed to load exchanges:', error);
                document.getElementById('exchangesList').innerHTML = '<div class="empty-state" style="text-align:center;padding:40px;color:#e74c3c;"><i class="ri-error-warning-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i><p>Failed to load exchanges. Please try again.</p></div>';
            }
        }

        // Get exchange status color
        function getExchangeStatusColor(status) {
            const colors = {
                'Pending': '#f59e0b',
                'Approved': '#10b981',
                'Rejected': '#ef4444',
                'Pickup Scheduled': '#3b82f6',
                'Picked Up': '#8b5cf6',
                'Processing': '#6366f1',
                'Shipped': '#0ea5e9',
                'Completed': '#22c55e'
            };
            return colors[status] || '#6b7280';
        }

        // Get exchange timeline HTML based on status
        function getExchangeTimeline(status) {
            const steps = [
                { key: 'Pending', label: 'Request Submitted', icon: 'ri-file-list-3-line' },
                { key: 'Approved', label: 'Approved', icon: 'ri-checkbox-circle-line' },
                { key: 'Pickup Scheduled', label: 'Pickup Scheduled', icon: 'ri-calendar-check-line' },
                { key: 'Picked Up', label: 'Item Picked Up', icon: 'ri-truck-line' },
                { key: 'Processing', label: 'Processing Exchange', icon: 'ri-loop-left-line' },
                { key: 'Shipped', label: 'New Item Shipped', icon: 'ri-truck-line' },
                { key: 'Completed', label: 'Exchange Completed', icon: 'ri-checkbox-circle-fill' }
            ];

            const statusOrder = ['Pending', 'Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'Shipped', 'Completed'];
            const currentIndex = statusOrder.indexOf(status);
            const isRejected = status === 'Rejected';

            if (isRejected) {
                return `
                    <div class="exchange-step completed" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;color:#f59e0b;">
                            <i class="ri-file-list-3-line"></i>
                        </div>
                        <span style="font-size:14px;">Request Submitted</span>
                    </div>
                    <div class="exchange-step rejected" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;color:#dc2626;">
                            <i class="ri-close-circle-line"></i>
                        </div>
                        <span style="font-size:14px;color:#dc2626;font-weight:500;">Exchange Rejected</span>
                    </div>
                `;
            }

            return steps.map((step, index) => {
                const stepIndex = statusOrder.indexOf(step.key);
                const isCompleted = stepIndex <= currentIndex;
                const isCurrent = stepIndex === currentIndex;
                
                const bgColor = isCompleted ? '#fef3c7' : '#f5f5f5';
                const iconColor = isCompleted ? '#f59e0b' : '#999';
                const textColor = isCurrent ? '#000' : (isCompleted ? '#d97706' : '#999');
                const fontWeight = isCurrent ? '600' : '400';

                return `
                    <div class="exchange-step ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}" style="display:flex;align-items:center;gap:12px;padding:10px 0;">
                        <div style="width:32px;height:32px;border-radius:50%;background:${bgColor};display:flex;align-items:center;justify-content:center;color:${iconColor};">
                            <i class="${step.icon}"></i>
                        </div>
                        <span style="font-size:14px;color:${textColor};font-weight:${fontWeight};">${step.label}</span>
                    </div>
                `;
            }).join('');
        }

        // Track exchange by ID
        function trackExchange(exchangeId) {
            // Find and navigate to the tracking section with the exchange info
            showSection('tracking');
            const trackingInput = document.getElementById('trackingInput');
            if (trackingInput) {
                trackingInput.value = exchangeId;
                // Trigger the search
                searchTracking();
            }
        }

        // Mark queries as read (remove notification)
        async function markQueriesAsRead() {
            try {
                // Store read timestamp in localStorage
                localStorage.setItem('blackonn_queries_last_read', Date.now().toString());
                
                // Remove notification dots from both desktop and mobile nav
                const existingDots = document.querySelectorAll('.query-notification-dot');
                existingDots.forEach(dot => dot.remove());
            } catch (error) {
                console.error('Error marking queries as read:', error);
            }
        }

        // Reorder items from a previous order via API
        async function reorderItems(orderId) {
            try {
                const response = await API.orders.get(orderId);
                const order = response.order;
                if (!order || !order.items) {
                    showSuccessPopup('Error', 'Could not find order details.');
                    return;
                }

                // Add each item to cart via API
                for (const item of order.items) {
                    await API.cart.add({
                        id: item.id,
                        productId: item.id,
                        name: item.name,
                        selectedSize: item.size || item.selectedSize,
                        selectedColor: item.color || item.selectedColor,
                        price: item.price,
                        quantity: item.quantity || 1,
                        image: item.image || getPlaceholder(100,100,'Product')
                    });
                }
                
                showSuccessPopup('Items Added!', 'Items from this order have been added to your cart.');
                updateCartCount();
            } catch (error) {
                console.error('Failed to reorder:', error);
                showSuccessPopup('Error', 'Failed to add items to cart. Please try again.');
            }
        }

        // Download PDF invoice for an order
        async function downloadInvoice(orderId) {
            if (!orderId || orderId === 'undefined') {
                showSuccessPopup('Error', 'Invalid order ID.');
                return;
            }

            try {
                // Check API availability first
                if (window.blackonnAuth && typeof window.blackonnAuth.checkApi === 'function') {
                    const isApiAvailable = await window.blackonnAuth.checkApi();
                    if (!isApiAvailable) {
                        showSuccessPopup('Connection Error', 'Cannot connect to server. Please ensure the backend is running.');
                        return;
                    }
                }

                // Use absolute API path via global helper for environment compatibility
                const baseApiUrl = (window.BlackonnAPI?.baseUrl || '') + '/api';
                const response = await fetch(`/api/tax/invoice/${orderId}`, { 
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Received non-JSON response:', contentType);
                    // If we got HTML (likely 404 from Live Server), show specific error
                    if (contentType && contentType.includes('text/html')) {
                         showSuccessPopup('Configuration Error', 'Backend API not reachable. If using Live Server, please use the Node.js server (port 3000) instead.');
                         return;
                    }
                    throw new Error('Invalid server response');
                }

                const data = await response.json();
                
                if (!data.success || !data.invoice) {
                    showSuccessPopup('Error', data.error || 'Could not generate invoice.');
                    return;
                }
                
                // Generate professional PDF invoice
                generateProfessionalInvoice(data.invoice, data.settings);
                
            } catch (error) {
                console.error('Failed to download invoice:', error);
                showSuccessPopup('Error', 'Failed to generate invoice. Please try again.');
            }
        }
        
        // Generate Professional Invoice PDF (Amazon-style)
        function generateProfessionalInvoice(invoice, settings) {
            // Fix logo path for printable window - handle both absolute and relative paths
            let logo = invoice.invoiceLogo || settings?.logo || '/assets/img/logo.png';
            if (logo.startsWith('/') && !logo.startsWith('//')) {
                logo = window.location.origin + logo;
            } else if (!logo.startsWith('http')) {
                // If it's a relative path without leading slash
                logo = window.location.origin + '/' + logo;
            }

            const showGst = settings?.showGst !== false;
            const businessPan = invoice.businessPan || settings?.businessPan || '';
            const gstin = invoice.gstNumber || settings?.gstNumber || '';
            
            const invoiceDate = new Date(invoice.createdAt || invoice.invoiceDate).toLocaleDateString('en-IN', { 
                day: 'numeric', month: 'long', year: 'numeric' 
            });
            
            const shipping = invoice.shippingAddress || {};
            const billing = invoice.billingAddress || shipping;
            const items = invoice.items || [];
            const baseSubtotal = invoice.subtotal || 0;
            
            // Format address helper
            const formatAddress = (addr) => {
                if (!addr) return '';
                const parts = [
                    addr.address || addr.street || addr.streetAddress || '',
                    addr.landmark ? `Near: ${addr.landmark}` : '',
                    [addr.city, addr.state, addr.pincode || addr.zip].filter(Boolean).join(', '),
                    addr.phone ? `Phone: ${addr.phone}` : ''
                ].filter(Boolean);
                return parts.join('<br>');
            };
            
            // Build items table
            const itemsHtml = items.map((item, index) => `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px;">${index + 1}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-weight: 500; font-size: 13px;">${item.name || 'Product'}</div>
                        <div style="color: #6b7280; font-size: 11px; margin-top: 2px;">
                            ${item.size ? `Size: ${item.size}` : ''} ${item.color ? `| Color: ${item.color}` : ''}
                        </div>
                        <div style="color: #6b7280; font-size: 10px; margin-top: 2px;">
                            HSN: ${item.hsnCode || '6109'}
                        </div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 13px;">${item.quantity || 1}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 13px;">${(item.unitPrice || item.price || 0).toLocaleString('en-IN')}</td>
                    ${showGst ? `
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 12px; color: #6b7280;">${item.taxRate || 0}%</td>
                    ` : ''}
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 13px; font-weight: 500;">${(item.totalAmount || item.lineTotal || 0).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');
            
            // Build payment details HTML
            let paymentModeHtml = '';
            const pm = (invoice.paymentMethod || '').toLowerCase();
            
            let paymentValue = 'Paid';

            if (pm === 'upi') {
                paymentValue = 'UPI Transfer';
            } else if (pm === 'card') {
                paymentValue = 'Credit/Debit Card';
            } else if (pm === 'wallet') {
                paymentValue = 'Digital Wallet';
            } else if (pm === 'bank' || pm === 'bank_transfer' || pm === 'netbanking') {
                paymentValue = 'Bank Transfer';
            } else if (pm === 'cod') {
                paymentValue = 'Cash on Delivery';
            }

            if (invoice.razorpayPaymentId) {
                paymentValue = 'Online Payment (Razorpay)';
            }

            paymentModeHtml = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                    <div style="font-size: 11px; text-transform: uppercase; color: #64748b; margin-bottom: 8px; font-weight: 700; letter-spacing: 0.5px;">Payment Details</div>
                    <div style="display: flex; gap: 40px; align-items: flex-start; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 9px; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px;">Payment Method</div>
                            <div style="font-size: 13px; font-weight: 600; color: #1e293b;">${paymentValue}</div>
                        </div>
                        <div>
                            <div style="font-size: 9px; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px;">Status</div>
                            <div style="font-size: 10px; padding: 2px 8px; background: ${invoice.paymentStatus === 'Completed' || invoice.paymentStatus === 'Paid' ? '#dcfce7' : '#fef9c3'}; color: ${invoice.paymentStatus === 'Completed' || invoice.paymentStatus === 'Paid' ? '#15803d' : '#92400e'}; border-radius: 4px; display: inline-block; font-weight: 700; border: 1px solid ${invoice.paymentStatus === 'Completed' || invoice.paymentStatus === 'Paid' ? '#bbf7d0' : '#fef08a'};">
                                ${invoice.paymentStatus === 'Completed' || invoice.paymentStatus === 'Paid' ? 'DONE' : (invoice.paymentStatus || 'PENDING')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${invoice.invoiceNumber}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: #fff; color: #1f2937; line-height: 1.5; }
        .invoice-container { max-width: 800px; margin: 0 auto; background: #fff; border: 1px solid #e5e7eb; padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid #f3f4f6; margin-bottom: 25px; }
        .logo-section { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        .logo-section img { height: 60px; width: auto; max-width: 200px; object-fit: contain; }
        .logo-text { font-size: 24px; font-weight: 800; letter-spacing: -1px; color: #000; }
        .invoice-meta { text-align: right; }
        .invoice-meta h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #111827; }
        .invoice-meta p { font-size: 13px; color: #4b5563; margin: 2px 0; }
        .invoice-number { font-size: 15px; font-weight: 700; color: #000; margin-top: 5px !important; }
        
        .addresses-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
        .address-box h4 { font-size: 12px; text-transform: uppercase; color: #6b7280; margin-bottom: 10px; letter-spacing: 1px; border-bottom: 1px solid #f3f4f6; padding-bottom: 5px; }
        .address-box p { font-size: 13px; line-height: 1.6; color: #374151; }
        .address-box .company-name { font-weight: 700; font-size: 15px; color: #000; margin-bottom: 4px; }
        
        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .items-table th { background: #f9fafb; color: #374151; padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-top: 1px solid #e5e7eb; border-bottom: 2px solid #e5e7eb; }
        .items-table th:last-child, .items-table td:last-child { text-align: right; }
        
        .summary-section { display: flex; justify-content: space-between; gap: 40px; margin-bottom: 30px; }
        .gst-breakdown { flex: 1; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #f3f4f6; }
        .gst-breakdown h4 { font-size: 12px; text-transform: uppercase; color: #6b7280; margin-bottom: 12px; letter-spacing: 0.5px; }
        .gst-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; color: #4b5563; }
        .gst-row.total-tax { border-top: 1px solid #e5e7eb; margin-top: 10px; padding-top: 10px; font-weight: 700; color: #000; }
        
        .totals-box { width: 300px; }
        .total-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 14px; color: #4b5563; }
        .total-row.grand-total { border-top: 2px solid #111827; border-bottom: 2px solid #111827; padding: 15px 0; margin-top: 10px; font-size: 18px; font-weight: 800; color: #000; }
        
        .bank-details { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 30px; }
        .bank-details h4 { font-size: 12px; text-transform: uppercase; color: #6b7280; margin-bottom: 10px; letter-spacing: 0.5px; }
        .bank-details p { font-size: 13px; margin: 4px 0; color: #374151; }
        
        .footer { border-top: 1px solid #f3f4f6; padding-top: 30px; }
        .footer-message { font-size: 14px; color: #111827; font-weight: 500; text-align: center; margin-bottom: 20px; }
        .terms { font-size: 11px; color: #6b7280; margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; line-height: 1.8; }
        
        .signature-section { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; padding-top: 24px; border-top: 1px solid #f3f4f6; }

        .print-btn { position: fixed; bottom: 30px; right: 30px; background: #000; color: #fff; border: none; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; z-index: 100; }
        .print-btn:hover { background: #333; transform: translateY(-2px); }

        @media print { 
            body { padding: 0; background: #fff; } 
            .invoice-container { border: none; max-width: 100%; padding: 0; }
            .print-btn { display: none !important; }
        }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
        Print Invoice
    </button>

    <div class="invoice-container">
        <div class="header">
            <div class="logo-section">
                ${logo ? `<img src="${logo}" alt="Logo" style="display: block; max-height: 80px; width: auto;" onerror="this.onerror=null; this.src='/assets/img/logo.png';">` : `<div class="logo-text">BLACKONN</div>`}
                <div style="font-size: 13px; font-weight: 700; color: #000; margin-top: 12px;">${invoice.businessName || settings?.businessName || 'BLACKONN'}</div>
                <div style="font-size: 11px; color: #4b5563; max-width: 250px; white-space: pre-line; line-height: 1.4;">${invoice.businessAddress || settings?.businessAddress || ''}</div>
            </div>
            <div class="invoice-meta">
                <h1>TAX INVOICE</h1>
                <p class="invoice-number">${invoice.invoiceNumber}</p>
                <p>Date: ${invoiceDate}</p>
                <p>Order ID: #${invoice.orderNumber || invoice.orderId}</p>
                ${gstin ? `<p style="font-weight: 700; color: #000; margin-top: 5px;">GSTIN: ${gstin}</p>` : ''}
                ${businessPan ? `<p style="font-weight: 700; color: #000;">PAN: ${businessPan}</p>` : ''}
            </div>
        </div>
        
        <div class="addresses-grid">
            <div class="address-box">
                <h4>Billing Address</h4>
                <p class="company-name">${billing.name || 'Customer'}</p>
                <p>${formatAddress(billing)}</p>
                ${invoice.buyer?.gstin ? `<p style="margin-top: 5px;"><strong>GSTIN:</strong> ${invoice.buyer.gstin}</p>` : ''}
            </div>
            <div class="address-box">
                <h4>Shipping Address</h4>
                <p class="company-name">${shipping.name || 'Customer'}</p>
                <p>${formatAddress(shipping)}</p>
            </div>
        </div>

        ${paymentModeHtml}
        
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 40px;">#</th>
                    <th>Description</th>
                    <th style="width: 60px; text-align: center;">Qty</th>
                    <th style="width: 100px; text-align: right;">Unit Price</th>
                    ${showGst ? '<th style="width: 70px; text-align: right;">Tax Rate</th>' : ''}
                    <th style="width: 100px; text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody>
                ${itemsHtml}
            </tbody>
        </table>
        
        <div class="summary-section">
            <div class="gst-breakdown">
                <h4>Tax Summary</h4>
                ${invoice.isInterstate ? `
                <div class="gst-row"><span>IGST (Integrated Tax)</span><span>${(invoice.igst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                ` : `
                <div class="gst-row"><span>CGST (Central Tax)</span><span>${(invoice.cgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                <div class="gst-row"><span>SGST (State Tax)</span><span>${(invoice.sgst || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                `}
                <div class="gst-row total-tax" style="border-top: 2px solid #e5e7eb; margin-top: 10px; padding-top: 10px;">
                    <span>Total Tax Amount</span>
                    <span>${(invoice.isInterstate ? (invoice.igst || 0) : ((invoice.cgst || 0) + (invoice.sgst || 0))).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                </div>
                <p style="font-size: 10px; color: #6b7280; margin-top: 15px; font-style: italic; line-height: 1.4;">
                    * All rates are inclusive of GST as per Indian laws.<br>
                    * This is a computer generated invoice and does not require a physical signature.
                </p>
            </div>
            
            <div class="totals-box">
                <div class="total-row"><span>Subtotal (Exc. Tax)</span><span>${(baseSubtotal).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                <div class="total-row"><span>Taxable Value</span><span>${(baseSubtotal).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                <div class="total-row"><span>Total GST</span><span>${(invoice.totalTax || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>
                ${(invoice.shippingCharge || 0) > 0 ? `<div class="total-row"><span>Shipping</span><span>${(invoice.shippingCharge).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div>` : ''}
                ${(invoice.discount || 0) > 0 ? `
                <div class="total-row" style="color: #059669; font-weight: 500;">
                    <span>Discount ${invoice.promoCode ? `(${invoice.promoCode})` : ''}</span>
                    <span>-${(invoice.discount).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                </div>` : ''}
                <div class="total-row grand-total">
                    <span>Grand Total</span>
                    <span>${(invoice.total || invoice.grandTotal || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
                </div>
                <p style="text-align: right; font-size: 11px; color: #6b7280; margin-top: 10px;">
                    Amount in words: <strong>${numberToWords(invoice.total || invoice.grandTotal)} Rupees Only</strong>
                </p>
            </div>
        </div>

        <div class="signature-section">
            <!-- Minimal Verified Badge -->
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa;">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="15" stroke="#10b981" stroke-width="1.5"/>
                    <path d="M10 16.5L14 20.5L22 12.5" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                    <div style="font-size: 11px; font-weight: 600; color: #111827; letter-spacing: 0.5px;">VERIFIED</div>
                    <div style="font-size: 9px; color: #6b7280;">Authentic Invoice</div>
                </div>
            </div>
            
            <!-- Digital Signature Electronic (DSE) - Minimalist -->
            <div style="text-align: right;">
                <p style="font-size: 10px; margin-bottom: 8px; color: #9ca3af;">For ${invoice.businessName || 'BLACKONN'}</p>
                <div style="border-top: 1px solid #e5e7eb; width: 180px; margin-left: auto; padding-top: 8px;">
                    <div style="font-size: 11px; font-weight: 500; color: #374151; margin-bottom: 4px;">${invoice.dseSignature?.signedBy || invoice.signature || 'Authorized Signatory'}</div>
                    ${invoice.dseSignature ? `
                    <div style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 3px; margin-top: 4px;">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none"><path d="M12 22C12 22 20 18 20 12V5L12 2L4 5V12C4 18 12 22 12 22Z" fill="#22c55e"/><path d="M9 12L11 14L15 10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span style="font-size: 8px; font-weight: 600; color: #15803d; letter-spacing: 0.3px;">DSE VERIFIED</span>
                    </div>
                    <div style="font-size: 7px; color: #9ca3af; margin-top: 4px; font-family: monospace;">${invoice.dseSignature.verificationCode}</div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p class="footer-message">Thank you for shopping with BLACKONN!</p>
            ${settings?.invoiceTerms ? `<div class="terms"><strong>Terms & Conditions:</strong><br>${settings.invoiceTerms}</div>` : `
            <div class="terms">
                1. This is a computer generated invoice.<br>
                2. Goods once sold cannot be returned without original packaging.<br>
                3. All disputes are subject to the jurisdiction of the company's registered state.
            </div>`}
        </div>
    </div>
</body>
</html>`;
            
            const win = window.open('', '_blank');
            win.document.write(invoiceHTML);
            win.document.close();
        }
        
        // Helper to convert number to words (simplified)
        function numberToWords(num) {
            const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            const format = (n) => {
                if (n < 20) return a[n];
                if (n < 100) return b[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + a[n % 10] : '');
                if (n < 1000) return a[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' and ' + format(n % 100) : '');
                if (n < 100000) return format(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 !== 0 ? ' ' + format(n % 1000) : '');
                if (n < 10000000) return format(Math.floor(n / 100000)) + ' Lakh' + (n % 100000 !== 0 ? ' ' + format(n % 100000) : '');
                return n;
            };
            
            return format(Math.floor(num));
        }

        // Return items from a previous order
        async function returnItems(orderId) {
            try {
                const response = await API.orders.get(orderId);
                const order = response.order;
                if (!order) {
                    showSuccessPopup('Error', 'Could not find order details.');
                    return;
                }

                // Check if order is eligible for return (delivered and within 7 days)
                const deliveryDate = order.deliveredAt ? new Date(order.deliveredAt) : (order.createdAt ? new Date(order.createdAt) : null);
                const now = new Date();
                const daysSinceDelivery = deliveryDate ? Math.floor((now - deliveryDate) / (1000 * 60 * 60 * 24)) : 0;
                
                if (order.status !== 'Delivered') {
                    showSuccessPopup('Return Not Available', 'You can only return delivered orders.');
                    return;
                }
                
                if (daysSinceDelivery > 7) {
                    showSuccessPopup('Return Period Expired', 'Returns are only accepted within 7 days of delivery.');
                    return;
                }

                // Show return request modal
                showReturnModal(order);
            } catch (error) {
                console.error('Failed to get order for return:', error);
                showSuccessPopup('Error', 'Failed to load order details. Please try again.');
            }
        }

        // Show return request modal
        function showReturnModal(order) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'returnModal';
            
            // Safely encode items data to avoid HTML injection issues
            const itemsHtml = order.items?.map((item, index) => {
                const itemData = encodeURIComponent(JSON.stringify(item));
                return `
                    <div class="return-item">
                        <label>
                            <input type="checkbox" value="${item.id || index}" data-item="${itemData}">
                            <div class="return-item-info">
                                <img src="${normalizeUploadUrl(item.image || item.thumbImage) || getPlaceholder(50,50,'Product')}" 
                                     alt="${(item.name || 'Product').replace(/"/g, '&quot;')}" 
                                     onerror="this.src=getPlaceholder(50,50,'Product')"
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 14px;">${item.name || 'Product'} (${item.size || '-'}/${item.color || '-'})</div>
                                    <div style="font-size: 12px; color: #666;">Qty: ${item.quantity || 1}</div>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('') || '<p>No items found</p>';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Request Return</h3>
                        <span class="modal-close" data-action="close-return-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="return-order-info">
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Order Date:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'Unknown'}</p>
                            <p><strong>Items:</strong></p>
                            <div class="return-items">
                                ${itemsHtml}
                            </div>
                        </div>
                        <div class="return-reason">
                            <label for="returnReason"><strong>Return Reason:</strong></label>
                            <select id="returnReason" required>
                                <option value="">Select a reason</option>
                                <option value="defective">Defective Product</option>
                                <option value="wrong_item">Wrong Item Received</option>
                                <option value="not_as_described">Not as Described</option>
                                <option value="size_issue">Size/Fit Issue</option>
                                <option value="color_issue">Color Issue</option>
                                <option value="changed_mind">Changed Mind</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="return-comments">
                            <label for="returnComments"><strong>Additional Comments:</strong></label>
                            <textarea id="returnComments" rows="3" placeholder="Please provide any additional details..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" data-action="close-return-modal">Cancel</button>
                        <button class="btn-submit" data-action="submit-return" data-order-id="${order.id}">Submit Return Request</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.add('show');
            
            // Add event delegation for the modal
            modal.addEventListener('click', function(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                if (action === 'close-return-modal') {
                    closeReturnModal();
                } else if (action === 'submit-return') {
                    const orderId = target.dataset.orderId;
                    submitReturnRequest(orderId);
                }
            });
        }

        // Close return modal
        function closeReturnModal() {
            const modal = document.getElementById('returnModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Submit return request via API
        async function submitReturnRequest(orderId) {
            const selectedItems = Array.from(document.querySelectorAll('#returnModal input[type="checkbox"]:checked'));
            const reason = document.getElementById('returnReason').value;
            const comments = document.getElementById('returnComments').value;

            if (selectedItems.length === 0) {
                showSuccessPopup('Warning', 'Please select at least one item to return.');
                return;
            }

            if (!reason) {
                showSuccessPopup('Warning', 'Please select a return reason.');
                return;
            }

            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) {
                    showSuccessPopup('Warning', 'Please login to submit a return request.');
                    return;
                }
                
                // Create return request via API
                // Map items to backend expected format
                const itemsForReturn = selectedItems.map(checkbox => {
                    // Decode the URI-encoded item data
                    const item = JSON.parse(decodeURIComponent(checkbox.dataset.item));
                    return {
                        productId: item.id || item.productId,
                        name: item.name,
                        size: item.size,
                        color: item.color,
                        quantity: item.quantity || 1,
                        price: item.price || 0,
                        image: item.image || item.thumbImage
                    };
                });
                
                const returnData = {
                    orderId: orderId,
                    items: itemsForReturn,
                    reason: reason,
                    description: comments,
                    customerName: user.name,
                    customerEmail: user.email,
                    customerPhone: user.phone
                };

                const response = await API.returns.create(returnData);

                if (response.success) {
                    closeReturnModal();
                    showSuccessPopup('Return Request Submitted', 'Your return request has been submitted successfully. We will process it within 2-3 business days.');
                    
                    // Refresh orders display
                    loadUserOrders();
                } else {
                    showSuccessPopup('Error', response.error || 'Failed to submit return request');
                }
            } catch (error) {
                console.error('Return submission error:', error);
                showSuccessPopup('Error', 'Failed to submit return request. Please try again.');
            }
        }

        // Exchange items from a previous order
        async function exchangeItems(orderId) {
            try {
                const response = await API.orders.get(orderId);
                const order = response.order;
                if (!order) {
                    showSuccessPopup('Error', 'Could not find order details.');
                    return;
                }

                // Check if order is eligible for exchange (delivered and within 2 days)
                const deliveryDate = order.deliveredAt ? new Date(order.deliveredAt) : (order.createdAt ? new Date(order.createdAt) : null);
                const now = new Date();
                const daysSinceDelivery = deliveryDate ? Math.floor((now - deliveryDate) / (1000 * 60 * 60 * 24)) : 0;
                
                if (order.status !== 'Delivered') {
                    showSuccessPopup('Exchange Not Available', 'You can only exchange delivered orders.');
                    return;
                }
                
                if (daysSinceDelivery > 2) {
                    showSuccessPopup('Exchange Period Expired', 'Exchanges are only accepted within 2 days of delivery.');
                    return;
                }

                // Show exchange request modal
                showExchangeModal(order);
            } catch (error) {
                console.error('Failed to get order for exchange:', error);
                showSuccessPopup('Error', 'Failed to load order details. Please try again.');
            }
        }

        // Show exchange request modal
        function showExchangeModal(order) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'exchangeModal';
            
            // Safely encode items data to avoid HTML injection issues
            const itemsHtml = order.items?.map((item, index) => {
                const itemData = encodeURIComponent(JSON.stringify(item));
                return `
                    <div class="return-item">
                        <label>
                            <input type="checkbox" value="${item.id || index}" data-item="${itemData}">
                            <div class="return-item-info">
                                <img src="${normalizeUploadUrl(item.image || item.thumbImage) || getPlaceholder(50,50,'Product')}" 
                                     alt="${(item.name || 'Product').replace(/"/g, '&quot;')}" 
                                     onerror="this.src=getPlaceholder(50,50,'Product')"
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 14px;">${item.name || 'Product'} (${item.size || '-'}/${item.color || '-'})</div>
                                    <div style="font-size: 12px; color: #666;">Qty: ${item.quantity || 1}</div>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('') || '<p>No items found</p>';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Request Exchange</h3>
                        <span class="modal-close" data-action="close-exchange-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="return-order-info">
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Order Date:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'Unknown'}</p>
                            <p><strong>Items to Exchange:</strong></p>
                            <div class="return-items">
                                ${itemsHtml}
                            </div>
                        </div>
                        <div class="return-reason">
                            <label for="exchangeReason"><strong>Exchange Reason:</strong></label>
                            <select id="exchangeReason" required>
                                <option value="">Select a reason</option>
                                <option value="size_issue">Size/Fit Issue</option>
                                <option value="color_issue">Color Issue</option>
                                <option value="defective">Defective Product</option>
                                <option value="wrong_item">Wrong Item Received</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="return-reason" style="margin-top: 15px;">
                            <label for="exchangeFor"><strong>Exchange For:</strong></label>
                            <select id="exchangeFor" required>
                                <option value="">What do you want instead?</option>
                                <option value="different_size">Different Size</option>
                                <option value="different_color">Different Color</option>
                                <option value="different_size_color">Different Size & Color</option>
                                <option value="different_product">Different Product</option>
                            </select>
                        </div>
                        <div class="exchange-new-options" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="return-reason">
                                <label for="exchangeNewSize"><strong>New Size:</strong></label>
                                <select id="exchangeNewSize">
                                    <option value="">Select new size</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="Free Size">Free Size</option>
                                </select>
                            </div>
                            <div class="return-reason">
                                <label for="exchangeNewColor"><strong>New Color:</strong></label>
                                <input type="text" id="exchangeNewColor" placeholder="e.g., Black, Navy Blue" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;">
                            </div>
                        </div>
                        <div class="return-comments" style="margin-top: 15px;">
                            <label for="exchangeComments"><strong>Additional Comments:</strong></label>
                            <textarea id="exchangeComments" rows="3" placeholder="Any additional details about your exchange request..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" data-action="close-exchange-modal">Cancel</button>
                        <button class="btn-submit" style="background: #f59e0b;" data-action="submit-exchange" data-order-id="${order.id}">Submit Exchange Request</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.add('show');
            
            // Add event delegation for the modal
            modal.addEventListener('click', function(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                if (action === 'close-exchange-modal') {
                    closeExchangeModal();
                } else if (action === 'submit-exchange') {
                    const orderId = target.dataset.orderId;
                    submitExchangeRequest(orderId);
                }
            });
        }

        // Close exchange modal
        function closeExchangeModal() {
            const modal = document.getElementById('exchangeModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Submit exchange request via API
        async function submitExchangeRequest(orderId) {
            const selectedItems = Array.from(document.querySelectorAll('#exchangeModal input[type="checkbox"]:checked'));
            const reason = document.getElementById('exchangeReason').value;
            const exchangeFor = document.getElementById('exchangeFor').value;
            const newSize = document.getElementById('exchangeNewSize').value;
            const newColor = document.getElementById('exchangeNewColor').value.trim();
            const comments = document.getElementById('exchangeComments').value;

            if (selectedItems.length === 0) {
                showSuccessPopup('Warning', 'Please select at least one item to exchange.');
                return;
            }

            if (!reason) {
                showSuccessPopup('Warning', 'Please select an exchange reason.');
                return;
            }

            if (!exchangeFor) {
                showSuccessPopup('Warning', 'Please select what you want to exchange for.');
                return;
            }

            // Validate new size/color based on exchange type
            if ((exchangeFor === 'different_size' || exchangeFor === 'different_size_color') && !newSize) {
                showSuccessPopup('Warning', 'Please select the new size you want.');
                return;
            }
            if ((exchangeFor === 'different_color' || exchangeFor === 'different_size_color') && !newColor) {
                showSuccessPopup('Warning', 'Please enter the new color you want.');
                return;
            }

            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) {
                    showSuccessPopup('Warning', 'Please login to submit an exchange request.');
                    return;
                }
                
                const itemsForExchange = selectedItems.map(checkbox => {
                    // Decode the URI-encoded item data
                    const item = JSON.parse(decodeURIComponent(checkbox.dataset.item));
                    return {
                        productId: item.id || item.productId,
                        name: item.name,
                        size: item.size,
                        color: item.color,
                        quantity: item.quantity || 1,
                        price: item.price || 0,
                        image: item.image || item.thumbImage
                    };
                });
                
                const exchangeData = {
                    orderId: orderId,
                    items: itemsForExchange,
                    reason: reason,
                    exchangeFor: exchangeFor,
                    newSize: newSize || null,
                    newColor: newColor || null,
                    description: comments
                };

                const response = await API.exchanges.create(exchangeData);

                if (response.success) {
                    closeExchangeModal();
                    showSuccessPopup('Exchange Request Submitted', 'Your exchange request has been submitted and is pending admin approval. We will review and process it within 2-3 business days.');
                    loadUserOrders();
                } else {
                    showSuccessPopup('Error', response.error || 'Failed to submit exchange request');
                }
            } catch (error) {
                console.error('Exchange submission error:', error);
                showSuccessPopup('Error', 'Failed to submit exchange request. Please try again.');
            }
        }

        // Cancel order
        async function cancelOrder(orderId) {
            try {
                const response = await API.orders.get(orderId);
                const order = response.order;
                if (!order) {
                    showSuccessPopup('Error', 'Could not find order details.');
                    return;
                }

                // Check if order is eligible for cancellation
                const nonCancellableStatuses = ['Shipped', 'Delivered', 'Cancelled', 'Return Requested', 'Exchange Requested'];
                if (nonCancellableStatuses.includes(order.status)) {
                    showSuccessPopup('Cannot Cancel', 'This order cannot be cancelled. It may have already been shipped or delivered.');
                    return;
                }

                // Show cancellation request modal
                showCancelModal(order);
            } catch (error) {
                console.error('Failed to get order for cancellation:', error);
                showSuccessPopup('Error', 'Failed to load order details. Please try again.');
            }
        }

        // Show cancellation request modal
        function showCancelModal(order) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'cancelModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Cancel Order</h3>
                        <span class="modal-close" data-action="close-cancel-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="return-order-info">
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Order Date:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'Unknown'}</p>
                            <p><strong>Order Total:</strong> ${(order.total || 0).toLocaleString()}</p>
                            <p><strong>Payment Method:</strong> ${order.paymentMethod || 'Unknown'}</p>
                            <p style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                                <i class="ri-information-line"></i> If you paid online, the refund will be processed within 5-7 business days.
                            </p>
                        </div>
                        <div class="return-reason">
                            <label for="cancelReason"><strong>Cancellation Reason:</strong></label>
                            <select id="cancelReason" required>
                                <option value="">Select a reason</option>
                                <option value="changed_mind">Changed Mind</option>
                                <option value="found_better_price">Found Better Price</option>
                                <option value="ordered_by_mistake">Ordered by Mistake</option>
                                <option value="delivery_too_slow">Delivery Taking Too Long</option>
                                <option value="duplicate_order">Duplicate Order</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="return-comments">
                            <label for="cancelComments"><strong>Additional Comments (Optional):</strong></label>
                            <textarea id="cancelComments" rows="3" placeholder="Any additional details..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-cancel" data-action="close-cancel-modal">Keep Order</button>
                        <button class="btn-submit" style="background: #6b7280;" data-action="submit-cancel" data-order-id="${order.id}">Cancel Order</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.classList.add('show');
            
            // Add event delegation for the modal
            modal.addEventListener('click', function(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                if (action === 'close-cancel-modal') {
                    closeCancelModal();
                } else if (action === 'submit-cancel') {
                    const orderId = target.dataset.orderId;
                    submitCancelRequest(orderId);
                }
            });
        }

        // Close cancel modal
        function closeCancelModal() {
            const modal = document.getElementById('cancelModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Submit cancellation request via API
        async function submitCancelRequest(orderId) {
            const reason = document.getElementById('cancelReason').value;
            const comments = document.getElementById('cancelComments').value;

            if (!reason) {
                showSuccessPopup('Warning', 'Please select a cancellation reason.');
                return;
            }

            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user) {
                    showSuccessPopup('Warning', 'Please login to cancel this order.');
                    return;
                }
                
                const cancellationData = {
                    orderId: orderId,
                    reason: reason,
                    description: comments
                };

                const response = await API.cancellations.create(cancellationData);

                if (response.success) {
                    closeCancelModal();
                    // Check if auto-approved
                    const message = response.cancellation?.autoApproved 
                        ? 'Your order has been cancelled successfully. Stock has been restored and refund will be processed if applicable.'
                        : 'Your cancellation request has been submitted and is pending review. This order may have already shipped.';
                    showSuccessPopup('Order Cancelled', message);
                    loadUserOrders();
                } else {
                    showSuccessPopup('Error', response.error || 'Failed to submit cancellation request');
                }
            } catch (error) {
                console.error('Cancellation submission error:', error);
                showSuccessPopup('Error', 'Failed to submit cancellation request. Please try again.');
            }
        }

        // Search tracking via API
        async function searchTracking() {
            const trackingInput = document.getElementById('trackingInput').value.trim();
            if (!trackingInput) {
                document.getElementById('trackingResult').style.display = 'none';
                return;
            }

            try {
                let returnRequest = null;
                let exchangeRequest = null;
                let order = null;
                let courierTracking = null;
                
                // Check if courier tracking is enabled and try to fetch from shipping API
                // Note: 404s are expected if order not shipped yet - use { _skipErrorTracking: true }
                try {
                    // First try by tracking number
                    let shippingResponse = await fetch(`/api/shipping/track/${trackingInput}`, { 
                        headers: { 'X-Skip-Error-Track': 'true' }
                    });
                    
                    // If not found by tracking number and input looks like an order ID, try by order ID
                    if (!shippingResponse.ok && (trackingInput.toUpperCase().startsWith('ORD') || /^\d+$/.test(trackingInput))) {
                        shippingResponse = await fetch(`/api/shipping/track-order/${trackingInput}`, {
                            headers: { 'X-Skip-Error-Track': 'true' }
                        });
                    }
                    
                    if (shippingResponse.ok) {
                        const shippingData = await shippingResponse.json();
                        if (shippingData.success && shippingData.tracking) {
                            courierTracking = shippingData.tracking;
                        }
                    }
                } catch (e) {
                    // Silently ignore - tracking not available
                }
                
                // Check if input is a return ID (starts with RET- or ret-)
                if (trackingInput.toUpperCase().startsWith('RET-')) {
                    // Tracking a return by return ID
                    try {
                        const returnResponse = await API.returns.getById(trackingInput);
                        returnRequest = returnResponse.return;
                        if (returnRequest && returnRequest.orderId) {
                            const orderResponse = await API.orders.get(returnRequest.orderId);
                            order = orderResponse.order;
                        }
                    } catch (e) {
                        console.log('Return not found by ID');
                    }
                } else if (trackingInput.toUpperCase().startsWith('EXC-')) {
                    // Tracking an exchange by exchange ID
                    try {
                        const exchangeResponse = await API.exchanges.getById(trackingInput);
                        exchangeRequest = exchangeResponse.exchange;
                        if (exchangeRequest && exchangeRequest.orderId) {
                            const orderResponse = await API.orders.get(exchangeRequest.orderId);
                            order = orderResponse.order;
                        }
                    } catch (e) {
                        console.log('Exchange not found by ID');
                    }
                } else {
                    // Tracking an order by order ID
                    try {
                        const orderResponse = await API.orders.get(trackingInput);
                        order = orderResponse.order;
                        
                        // Check if order has return request
                        if (order && (order.status === 'Return Requested' || order.status?.includes('Return'))) {
                            try {
                                const myReturns = await API.returns.getMine();
                                returnRequest = myReturns.returns?.find(r => r.orderId === order.id);
                            } catch (e) {
                                console.log('No returns found');
                            }
                        }
                        
                        // Check if order has exchange request
                        if (order && (order.status === 'Exchange Requested' || order.status?.includes('Exchange'))) {
                            try {
                                const myExchanges = await API.exchanges.getMine();
                                exchangeRequest = myExchanges.exchanges?.find(e => e.orderId === order.id);
                            } catch (e) {
                                console.log('No exchanges found');
                            }
                        }
                    } catch (e) {
                        console.log('Order not found');
                    }
                }

                if (!order && !returnRequest && !exchangeRequest) {
                    document.getElementById('trackingResult').innerHTML = `
                        <div class="empty-state" style="text-align:center;padding:40px;color:#666;">
                            <i class="ri-error-warning-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>
                            <p>Order, Return or Exchange not found. Please check your ID and try again.</p>
                        </div>
                    `;
                    document.getElementById('trackingResult').style.display = 'block';
                    return;
                }

                // Determine if this is a return or exchange tracking
                const isReturnTracking = returnRequest && trackingInput.toUpperCase().startsWith('RET-');
                const isExchangeTracking = exchangeRequest && trackingInput.toUpperCase().startsWith('EXC-');
                const currentStatus = isReturnTracking ? returnRequest.status : (isExchangeTracking ? exchangeRequest.status : (order?.status || 'Pending'));
                const statusClass = currentStatus.toLowerCase().replace(' ', '-');
                const orderDate = order?.createdAt ? new Date(order.createdAt).toLocaleDateString('en-IN') : 'Unknown';

                let timelineSteps;

                if (isExchangeTracking) {
                    // Exchange tracking timeline
                    const isRejected = exchangeRequest.status === 'Rejected';
                    
                    if (isRejected) {
                        // Rejected exchange - show red tracker
                        timelineSteps = [
                            {
                                title: 'Exchange Requested',
                                desc: 'Your exchange request has been submitted',
                                completed: true,
                                time: exchangeRequest.requestedAt || exchangeRequest.createdAt ? new Date(exchangeRequest.requestedAt || exchangeRequest.createdAt).toLocaleString('en-IN') : '',
                                rejected: false
                            },
                            {
                                title: 'Exchange Rejected',
                                desc: 'Your exchange request has been rejected',
                                completed: true,
                                time: exchangeRequest.statusUpdatedAt ? new Date(exchangeRequest.statusUpdatedAt).toLocaleString('en-IN') : 'Rejected',
                                rejected: true
                            }
                        ];
                    } else {
                        timelineSteps = [
                            {
                                title: 'Exchange Requested',
                                desc: 'Your exchange request has been submitted',
                                completed: true,
                                time: exchangeRequest.requestedAt || exchangeRequest.createdAt ? new Date(exchangeRequest.requestedAt || exchangeRequest.createdAt).toLocaleString('en-IN') : ''
                            },
                            {
                                title: 'Exchange Approved',
                                desc: 'Your exchange request has been approved',
                                completed: ['Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status),
                                time: ['Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status) ? 'Approved' : ''
                            },
                            {
                                title: 'Pickup Scheduled',
                                desc: 'Pickup has been scheduled for your item',
                                completed: ['Pickup Scheduled', 'Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status),
                                time: ['Pickup Scheduled', 'Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status) ? 'Scheduled' : ''
                            },
                            {
                                title: 'Item Picked Up',
                                desc: 'Your item has been picked up',
                                completed: ['Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status),
                                time: ['Picked Up', 'Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status) ? 'Picked Up' : ''
                            },
                            {
                                title: 'Processing',
                                desc: 'Your exchange is being processed',
                                completed: ['Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status),
                                time: ['Processing', 'New Item Dispatched', 'Completed'].includes(exchangeRequest.status) ? 'Processing' : ''
                            },
                            {
                                title: 'New Item Dispatched',
                                desc: 'Your replacement item has been dispatched',
                                completed: ['New Item Dispatched', 'Completed'].includes(exchangeRequest.status),
                                time: ['New Item Dispatched', 'Completed'].includes(exchangeRequest.status) ? 'Dispatched' : ''
                            },
                            {
                                title: 'Exchange Completed',
                                desc: 'Your exchange has been completed successfully',
                                completed: exchangeRequest.status === 'Completed',
                                time: exchangeRequest.status === 'Completed' ? 'Completed' : ''
                            }
                        ];
                    }
                } else if (isReturnTracking) {
                    // Return tracking timeline
                    const isRejected = returnRequest.status === 'Rejected';
                    
                    if (isRejected) {
                        // Rejected return - show red tracker
                        timelineSteps = [
                            {
                                title: 'Return Requested',
                                desc: 'Your return request has been submitted',
                                completed: true,
                                time: returnRequest.requestedAt || returnRequest.createdAt ? new Date(returnRequest.requestedAt || returnRequest.createdAt).toLocaleString('en-IN') : '',
                                rejected: false
                            },
                            {
                                title: 'Return Rejected',
                                desc: 'Your return request has been rejected',
                                completed: true,
                                time: returnRequest.statusUpdatedAt ? new Date(returnRequest.statusUpdatedAt).toLocaleString('en-IN') : 'Rejected',
                                rejected: true
                            }
                        ];
                    } else {
                        timelineSteps = [
                            {
                                title: 'Return Requested',
                                desc: 'Your return request has been submitted',
                                completed: true,
                                time: returnRequest.requestedAt || returnRequest.createdAt ? new Date(returnRequest.requestedAt || returnRequest.createdAt).toLocaleString('en-IN') : ''
                            },
                            {
                                title: 'Return Approved',
                                desc: 'Your return request has been approved',
                                completed: ['Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status),
                                time: ['Approved', 'Pickup Scheduled', 'Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status) ? 'Approved' : ''
                            },
                            {
                                title: 'Pickup Scheduled',
                                desc: 'Pickup has been scheduled for your return',
                                completed: ['Pickup Scheduled', 'Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status),
                                time: ['Pickup Scheduled', 'Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status) ? 'Scheduled' : ''
                            },
                            {
                                title: 'Item Picked Up',
                                desc: 'Your item has been picked up',
                                completed: ['Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status),
                                time: ['Picked Up', 'Processing', 'Refunded', 'Completed'].includes(returnRequest.status) ? 'Picked Up' : ''
                            },
                            {
                                title: 'Processing',
                                desc: 'Your return is being processed',
                                completed: ['Processing', 'Refunded', 'Completed'].includes(returnRequest.status),
                                time: ['Processing', 'Refunded', 'Completed'].includes(returnRequest.status) ? 'Processing' : ''
                            },
                            {
                                title: 'Refund Processed',
                                desc: 'Refund has been processed to your account',
                                completed: ['Refunded', 'Completed'].includes(returnRequest.status),
                                time: ['Refunded', 'Completed'].includes(returnRequest.status) ? 'Refunded' : ''
                            }
                        ];
                    }
                } else {
                    // Regular order tracking timeline
                    const isReturnRequest = currentStatus === 'Return Requested' || currentStatus.includes('Return');
                    const isExchangeRequest = currentStatus === 'Exchange Requested' || currentStatus.includes('Exchange');
                    const isCancelled = currentStatus === 'Cancelled' || currentStatus === 'Canceled';
                    
                    if (isCancelled) {
                        // Cancelled order - show red tracker
                        timelineSteps = [
                            {
                                title: 'Order Placed',
                                desc: 'Your order was placed',
                                completed: true,
                                time: order?.createdAt ? new Date(order.createdAt).toLocaleString('en-IN') : '',
                                cancelled: false
                            },
                            {
                                title: 'Order Cancelled',
                                desc: 'Your order has been cancelled',
                                completed: true,
                                time: order?.cancelledAt ? new Date(order.cancelledAt).toLocaleString('en-IN') : 'Cancelled',
                                cancelled: true
                            }
                        ];
                    } else {
                        timelineSteps = [
                            {
                                title: 'Order Placed',
                                desc: 'Your order has been placed successfully',
                                completed: true,
                                time: order?.createdAt ? new Date(order.createdAt).toLocaleString('en-IN') : ''
                            },
                            {
                                title: 'Order Confirmed',
                                desc: 'Seller has confirmed your order',
                                completed: ['Processing', 'Shipped', 'Delivered'].includes(currentStatus) || isReturnRequest || isExchangeRequest,
                                time: ['Processing', 'Shipped', 'Delivered'].includes(currentStatus) || isReturnRequest || isExchangeRequest ? 'Confirmed' : ''
                            },
                            {
                                title: 'Packed',
                                desc: 'Your order has been packed and ready for dispatch',
                                completed: ['Shipped', 'Delivered'].includes(currentStatus) || isReturnRequest || isExchangeRequest,
                                time: ['Shipped', 'Delivered'].includes(currentStatus) || isReturnRequest || isExchangeRequest ? 'Packed' : ''
                            },
                            {
                                title: 'Shipped',
                                desc: 'Package is in transit',
                                completed: ['Shipped', 'Delivered'].includes(currentStatus) || isReturnRequest || isExchangeRequest,
                                time: currentStatus === 'Shipped' ? 'In transit' : (currentStatus === 'Delivered' ? 'Delivered' : ((isReturnRequest || isExchangeRequest) ? 'Delivered' : ''))
                            },
                            {
                                title: 'Delivered',
                                desc: 'Package has been delivered successfully',
                                completed: currentStatus === 'Delivered' || isReturnRequest || isExchangeRequest,
                                time: currentStatus === 'Delivered' ? 'Delivered' : ((isReturnRequest || isExchangeRequest) ? 'Delivered' : '')
                            },
                            ...(isReturnRequest ? [{
                                title: 'Return Requested',
                                desc: 'Return request has been submitted',
                                completed: true,
                                time: returnRequest ? new Date(returnRequest.requestedAt || returnRequest.createdAt).toLocaleString('en-IN') : 'Requested'
                            }] : []),
                            ...(isExchangeRequest ? [{
                                title: 'Exchange Requested',
                                desc: 'Exchange request has been submitted',
                                completed: true,
                                time: exchangeRequest ? new Date(exchangeRequest.requestedAt || exchangeRequest.createdAt).toLocaleString('en-IN') : 'Requested'
                            }] : [])
                        ];
                    }
                }

                const timelineHtml = timelineSteps.map((step, index) => {
                    const isRejectedStep = step.rejected === true;
                    const isCancelledStep = step.cancelled === true;
                    const isNegativeStep = isRejectedStep || isCancelledStep;
                    const stepClass = isNegativeStep ? 'rejected' : (step.completed ? 'completed' : (index === timelineSteps.findIndex(s => !s.completed) ? 'current' : ''));
                    const negativeStyle = isNegativeStep ? 'style="--step-color: #dc2626; --step-bg: #fef2f2;"' : '';
                    return `
                        <div class="tracking-step ${stepClass}" ${negativeStyle}>
                            <div class="tracking-step-title" ${isNegativeStep ? 'style="color:#dc2626;"' : ''}>${step.title}</div>
                            <div class="tracking-step-desc" ${isNegativeStep ? 'style="color:#dc2626;"' : ''}>${step.desc}</div>
                            ${step.time ? `<div class="tracking-step-time" ${isNegativeStep ? 'style="color:#dc2626;"' : ''}>${step.time}</div>` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('trackingResult').innerHTML = `
                    <div class="tracking-header">
                        <div class="tracking-order-info">
                            <h3 id="trackingOrderId">${isExchangeTracking ? 'Exchange' : (isReturnTracking ? 'Return' : 'Order')} #${isExchangeTracking ? exchangeRequest.id : (isReturnTracking ? returnRequest.id : order.id)}</h3>
                            <p>${isExchangeTracking ? 'Exchange requested' : (isReturnTracking ? 'Return requested' : 'Ordered')} on ${orderDate}</p>
                            ${isExchangeTracking ? `<p><strong>Original Order:</strong> #${order?.id || exchangeRequest.orderId}</p>` : ''}
                            ${isReturnTracking ? `<p><strong>Original Order:</strong> #${order?.id || returnRequest.orderId}</p>` : ''}
                        </div>
                        <span class="order-status ${statusClass}" id="trackingStatus">${currentStatus}</span>
                    </div>
                    ${courierTracking && courierTracking.source === 'courier_api' ? `
                    <div class="courier-tracking-info" style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; border: 1px solid #bae6fd;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="ri-truck-line" style="font-size: 1.5rem; color: #0284c7;"></i>
                            <div>
                                <div style="font-weight: 600; color: #0369a1;">${courierTracking.courierName || courierTracking.courier}</div>
                                <div style="font-size: 0.85rem; color: #0284c7;">Tracking #: ${courierTracking.trackingNumber}</div>
                            </div>
                        </div>
                        ${courierTracking.currentLocation ? `<p style="margin: 8px 0; color: #0369a1;"><i class="ri-map-pin-line"></i> Current Location: <strong>${courierTracking.currentLocation}</strong></p>` : ''}
                        ${courierTracking.courierUpdatedAt ? `<p style="font-size: 0.8rem; color: #0284c7;">Last Updated: ${new Date(courierTracking.courierUpdatedAt).toLocaleString('en-IN')}</p>` : ''}
                    </div>
                    ` : ''}
                    <div class="tracking-timeline">
                        ${timelineHtml}
                    </div>
                    ${courierTracking && courierTracking.courierHistory && courierTracking.courierHistory.length > 0 ? `
                    <div class="courier-history" style="margin: 20px 0; padding: 16px; background: #f8fafc; border-radius: 12px;">
                        <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;"><i class="ri-history-line"></i> Courier Updates</h4>
                        <div class="courier-history-list" style="max-height: 200px; overflow-y: auto;">
                            ${courierTracking.courierHistory.map(h => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem;">
                                    <div style="font-weight: 500;">${h.status || h.scan || 'Update'}</div>
                                    <div style="color: #6b7280; font-size: 0.8rem;">${h.location || ''} ${h.timestamp ? ' ' + new Date(h.timestamp).toLocaleString('en-IN') : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    <div class="tracking-details">
                        <h4>${isExchangeTracking ? 'Exchange Details' : (isReturnTracking ? 'Return Details' : 'Order Details')}</h4>
                        ${isExchangeTracking ? `
                            <div class="exchange-info" style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <p><strong>Exchange Reason:</strong> ${exchangeRequest.reason?.replace(/_/g, ' ') || 'Not specified'}</p>
                                <p><strong>Exchange For:</strong> ${(exchangeRequest.exchangeFor || 'Not specified').replace(/_/g, ' ')}</p>
                                ${exchangeRequest.description || exchangeRequest.comments ? `<p><strong>Comments:</strong> ${exchangeRequest.description || exchangeRequest.comments}</p>` : ''}
                            </div>
                            ${exchangeRequest.newSize || exchangeRequest.newColor ? `
                            <div class="new-variant-info" style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 8px; border-left: 4px solid #22c55e;">
                                <h5 style="margin: 0 0 10px 0; color: #15803d; display: flex; align-items: center; gap: 8px;"><i class="ri-arrow-right-circle-line"></i> Requested New Variant:</h5>
                                ${exchangeRequest.newSize ? `<p style="margin: 5px 0;"><strong>New Size:</strong> <span style="color: #15803d; font-weight: 600; font-size: 1.1em;">${exchangeRequest.newSize}</span></p>` : ''}
                                ${exchangeRequest.newColor ? `<p style="margin: 5px 0;"><strong>New Color:</strong> <span style="color: #15803d; font-weight: 600; font-size: 1.1em;">${exchangeRequest.newColor}</span></p>` : ''}
                            </div>
                            ` : ''}
                            <div class="tracking-items">
                                <h5 style="display: flex; align-items: center; gap: 8px;"><i class="ri-arrow-left-right-line" style="color: #f59e0b;"></i> Items Being Exchanged:</h5>
                                ${exchangeRequest.items?.map(item => `
                                    <div class="tracking-item">
                                        <span>${item.name} (${item.size}/${item.color}) x${item.quantity}</span>
                                        <span>${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</span>
                                    </div>
                                `).join('') || '<div class="tracking-item">No items found</div>'}
                            </div>
                            ${exchangeRequest.newItem ? `
                            <div class="tracking-items" style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e5e7eb;">
                                <h5 style="display: flex; align-items: center; gap: 8px;"><i class="ri-gift-line" style="color: #22c55e;"></i> New Item You'll Receive:</h5>
                                <div class="tracking-item" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 10px; border-radius: 6px;">
                                    <span style="font-weight: 600; color: #15803d;">${exchangeRequest.newItem.name || 'Same product'} (${exchangeRequest.newItem.size || 'Same'}/${exchangeRequest.newItem.color || 'Same'})</span>
                                </div>
                            </div>
                            ` : ''}
                        ` : isReturnTracking ? `
                            <div class="return-info" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <p><strong>Return Reason:</strong> ${returnRequest.reason?.replace('_', ' ') || 'Not specified'}</p>
                                ${returnRequest.comments ? `<p><strong>Comments:</strong> ${returnRequest.comments}</p>` : ''}
                            </div>
                            <div class="tracking-items">
                                <h5>Items Being Returned:</h5>
                                ${returnRequest.items?.map(item => `
                                    <div class="tracking-item">
                                        <span>${item.name} (${item.size}/${item.color}) x${item.quantity}</span>
                                        <span>${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</span>
                                    </div>
                                `).join('') || '<div class="tracking-item">No items found</div>'}
                            </div>
                        ` : `
                            <div class="tracking-items">
                                ${order?.items?.map(item => `
                                    <div class="tracking-item">
                                        <span>${item.name} (${item.size}/${item.color}) x${item.quantity}</span>
                                        <span>${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</span>
                                    </div>
                                `).join('') || '<div class="tracking-item">No items found</div>'}
                            </div>
                        `}
                        <div class="tracking-total">
                            <strong>Total: ${(order?.total || order?.amount || 0).toLocaleString()}</strong>
                        </div>
                    </div>
                `;
                document.getElementById('trackingResult').style.display = 'block';
            } catch (error) {
                console.error('Tracking search error:', error);
                document.getElementById('trackingResult').innerHTML = `
                    <div class="empty-state" style="text-align:center;padding:40px;color:#e74c3c;">
                        <i class="ri-error-warning-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>
                        <p>Failed to search tracking. Please try again.</p>
                    </div>
                `;
                document.getElementById('trackingResult').style.display = 'block';
            }
        }

        // Track order from orders list
        function trackOrder(orderId) {
            // Switch to tracking section
            showSection('tracking');
            
            // Update sidebar active state
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === 'tracking') {
                    link.classList.add('active');
                }
            });
            
            // Pre-fill tracking input and search
            const trackingInput = document.getElementById('trackingInput');
            if (trackingInput) {
                trackingInput.value = orderId;
                searchTracking();
            }
        }

        // Track return from returns list
        function trackReturn(returnId) {
            // Switch to tracking section
            showSection('tracking');
            
            // Update sidebar active state
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === 'tracking') {
                    link.classList.add('active');
                }
            });
            
            // Pre-fill tracking input with return ID and search
            const trackingInput = document.getElementById('trackingInput');
            if (trackingInput) {
                trackingInput.value = returnId;
                searchTracking();
            }
        }

        // Logout Popup
        function showLogoutPopup() {
            document.getElementById('logoutPopup').classList.add('show');
        }

        function hideLogoutPopup() {
            document.getElementById('logoutPopup').classList.remove('show');
        }

        async function confirmLogout() {
            // Use API-based logout and wait for it to complete
            if (window.blackonnAuth) {
                await window.blackonnAuth.logout();
            }
            window.location.href = 'login.html';
        }

        // =====================================================
        // DELETE ACCOUNT FUNCTIONALITY
        // =====================================================
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.add('show');
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('btnConfirmDelete').disabled = true;
        }

        function hideDeleteAccountModal() {
            document.getElementById('deleteAccountModal').classList.remove('show');
        }

        // Enable delete button only when user types "DELETE"
        document.getElementById('deleteConfirmInput')?.addEventListener('input', function(e) {
            const confirmBtn = document.getElementById('btnConfirmDelete');
            confirmBtn.disabled = e.target.value !== 'DELETE';
        });

        async function confirmDeleteAccount() {
            const confirmInput = document.getElementById('deleteConfirmInput');
            if (confirmInput.value !== 'DELETE') {
                showToast('Please type DELETE to confirm', 'error');
                return;
            }

            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (!user || !user.id) {
                    showToast('User not found. Please login again.', 'error');
                    return;
                }

                const response = await fetch(`/api/users/${user.id}/self-delete`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    hideDeleteAccountModal();
                    showToast('Your account has been deleted. Goodbye!', 'success');
                    
                    // Logout and redirect
                    if (window.blackonnAuth) {
                        await window.blackonnAuth.logout();
                    }
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    showToast(data.error || 'Failed to delete account', 'error');
                }
            } catch (error) {
                console.error('Delete account error:', error);
                showToast('An error occurred while deleting your account', 'error');
            }
        }

        // =====================================================
        // UNIVERSAL MODAL SYSTEM - Replace native dialogs
        // =====================================================
        const UniModal = {
            overlay: null,
            resolvePromise: null,
            
            init() {
                this.overlay = document.getElementById('uniModal');
                if (!this.overlay) return;
                
                // Cancel button
                document.getElementById('uniModalCancel')?.addEventListener('click', () => {
                    this.hide();
                    if (this.resolvePromise) this.resolvePromise(null);
                });
                
                // Confirm button
                document.getElementById('uniModalConfirm')?.addEventListener('click', () => {
                    const input = document.getElementById('uniModalInput');
                    const body = document.getElementById('uniModalBody');
                    const value = body.style.display !== 'none' ? input.value : true;
                    this.hide();
                    if (this.resolvePromise) this.resolvePromise(value);
                });
                
                // Close on overlay click
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.hide();
                        if (this.resolvePromise) this.resolvePromise(null);
                    }
                });
                
                // Enter key for input
                document.getElementById('uniModalInput')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('uniModalConfirm').click();
                    }
                });
            },
            
            show(options = {}) {
                const {
                    type = 'confirm',
                    icon = 'ri-question-line',
                    title = 'Confirm',
                    message = 'Are you sure?',
                    inputPlaceholder = '',
                    inputValue = '',
                    confirmText = 'Confirm',
                    cancelText = 'Cancel',
                    confirmClass = 'primary'
                } = options;
                
                // Set icon
                const iconEl = document.getElementById('uniModalIcon');
                const iconI = document.getElementById('uniModalIconI');
                iconEl.className = `uni-modal-icon ${type}`;
                iconI.className = icon;
                
                // Set text
                document.getElementById('uniModalTitle').textContent = title;
                document.getElementById('uniModalMessage').textContent = message;
                
                // Handle input
                const body = document.getElementById('uniModalBody');
                const input = document.getElementById('uniModalInput');
                if (type === 'input') {
                    body.style.display = 'block';
                    input.placeholder = inputPlaceholder;
                    input.value = inputValue;
                    setTimeout(() => input.focus(), 100);
                } else {
                    body.style.display = 'none';
                }
                
                // Set buttons
                document.getElementById('uniModalCancel').textContent = cancelText;
                const confirmBtn = document.getElementById('uniModalConfirm');
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `uni-modal-btn ${confirmClass}`;
                
                // Show modal
                this.overlay.classList.add('show');
                
                return new Promise(resolve => {
                    this.resolvePromise = resolve;
                });
            },
            
            hide() {
                this.overlay?.classList.remove('show');
            },
            
            // Shorthand methods
            async confirm(title, message, options = {}) {
                return this.show({
                    type: 'confirm',
                    icon: 'ri-question-line',
                    title,
                    message,
                    confirmText: options.confirmText || 'Yes',
                    cancelText: options.cancelText || 'Cancel',
                    confirmClass: options.danger ? 'danger' : 'primary'
                });
            },
            
            async prompt(title, message, defaultValue = '', placeholder = '') {
                return this.show({
                    type: 'input',
                    icon: 'ri-edit-line',
                    title,
                    message,
                    inputValue: defaultValue,
                    inputPlaceholder: placeholder || 'Enter value',
                    confirmText: 'Save',
                    confirmClass: 'primary'
                });
            },
            
            async danger(title, message, confirmText = 'Delete') {
                return this.show({
                    type: 'danger',
                    icon: 'ri-error-warning-line',
                    title,
                    message,
                    confirmText,
                    confirmClass: 'danger'
                });
            },
            
            async info(title, message) {
                return this.show({
                    type: 'info',
                    icon: 'ri-information-line',
                    title,
                    message,
                    confirmText: 'OK',
                    cancelText: 'Close',
                    confirmClass: 'primary'
                });
            }
        };
        
        // Initialize modal on DOM ready
        document.addEventListener('DOMContentLoaded', () => UniModal.init());

        // =====================================================
        // BIOMETRIC AUTHENTICATION MANAGEMENT - New Design
        // =====================================================
        let biometricState = {
            enabled: false,
            credentials: [],
            maxCredentials: 3
        };

        // Initialize biometric module
        function initBiometricModule() {
            const toggle = document.getElementById('biometricToggle');
            if (toggle) {
                toggle.addEventListener('change', handleBiometricToggle);
            }
            loadBiometricData();
        }

        // Load biometric data from server
        async function loadBiometricData() {
            try {
                const user = await window.blackonnAuth?.getCurrentUser();
                if (!user?.id) return;

                const response = await fetch(`/api/users/${user.id}/biometric`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                if (data.success) {
                    biometricState.enabled = data.biometricEnabled || false;
                    biometricState.credentials = data.credentials || [];
                    
                    // Sync local biometric storage with server data
                    // This handles admin reset - clears local cache if server has no credentials
                    if (window.biometricAuth && typeof window.biometricAuth.syncWithServer === 'function') {
                        await window.biometricAuth.syncWithServer(user.id);
                    }

                    // Also try to sync any pending credentials that failed during signup
                    if (window.biometricAuth && typeof window.biometricAuth.syncPendingCredentials === 'function') {
                        await window.biometricAuth.syncPendingCredentials();
                    }
                    
                    renderBiometricUI();
                }
            } catch (error) {
                console.error('Biometric load error:', error);
                renderBiometricUI();
            }
        }

        // Main render function
        function renderBiometricUI() {
            updateStatusIndicator();
            updateToggleState();
            renderCredentialsList();
            updateAddButton();
        }

        // Update the status indicator
        function updateStatusIndicator() {
            const indicator = document.getElementById('bioIndicator');
            const title = document.getElementById('biometricStatusTitle');
            const desc = document.getElementById('biometricStatusDesc');
            const count = document.getElementById('biometricCredentialCount');
            const devicesCount = document.getElementById('devicesCount');

            if (indicator) {
                indicator.className = `bio-status-indicator ${biometricState.enabled ? 'active' : 'inactive'}`;
                indicator.innerHTML = biometricState.enabled 
                    ? '<i class="ri-shield-check-line"></i>' 
                    : '<i class="ri-shield-cross-line"></i>';
            }

            if (title) {
                title.textContent = biometricState.enabled ? 'Enabled' : 'Disabled';
            }

            if (count) {
                count.textContent = biometricState.credentials.length;
            }

            if (devicesCount) {
                const len = biometricState.credentials.length;
                devicesCount.textContent = `${len} device${len !== 1 ? 's' : ''}`;
            }
        }

        // Update toggle state
        function updateToggleState() {
            const toggle = document.getElementById('biometricToggle');
            if (toggle) {
                toggle.checked = biometricState.enabled;
            }
        }

        // Render credentials list
        function renderCredentialsList() {
            const list = document.getElementById('biometricCredentialsList');
            const empty = document.getElementById('bioEmptyState');
            
            if (!list) return;

            if (biometricState.credentials.length === 0) {
                list.innerHTML = '';
                if (empty) {
                    empty.style.display = 'block';
                    list.appendChild(empty);
                } else {
                    list.innerHTML = `
                        <div class="bio-empty-state">
                            <i class="ri-fingerprint-line"></i>
                            <p>No biometric credentials registered yet</p>
                        </div>`;
                }
                return;
            }

            if (empty) empty.style.display = 'none';
            
            list.innerHTML = biometricState.credentials.map((cred, idx) => {
                const isFace = cred.type === 'face' || cred.type === 'faceID';
                const iconClass = isFace ? 'face' : 'fingerprint';
                const iconName = isFace ? 'user-smile-line' : 'fingerprint-line';
                const createdDate = formatDate(cred.createdAt);
                const lastUsed = cred.lastUsed ? formatDate(cred.lastUsed) : null;

                return `
                    <div class="bio-device-card" data-id="${cred.id}">
                        <div class="bio-device-icon ${iconClass}">
                            <i class="ri-${iconName}"></i>
                        </div>
                        <div class="bio-device-info">
                            <h6>${escapeHtml(cred.name || `Device ${idx + 1}`)}</h6>
                            <p>Added ${createdDate}${lastUsed ? `  Used ${lastUsed}` : ''}</p>
                            ${cred.requiresReauth ? '<span class="reauth-badge"><i class="ri-error-warning-line"></i> Re-auth needed</span>' : ''}
                        </div>
                        <div class="bio-device-actions">
                            <button class="bio-device-btn edit" onclick="editBiometricCredential('${cred.id}')" title="Rename">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button class="bio-device-btn delete" onclick="deleteBiometricCredential('${cred.id}')" title="Delete">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('');
        }

        // Update add button state
        function updateAddButton() {
            const btn = document.getElementById('btnAddBiometric');
            const limitText = document.getElementById('biometricLimitText');
            const remaining = biometricState.maxCredentials - biometricState.credentials.length;

            if (btn) {
                btn.disabled = remaining <= 0;
            }

            if (limitText) {
                if (remaining <= 0) {
                    limitText.innerHTML = '<i class="ri-error-warning-line"></i> Maximum limit reached. Remove a device to add new.';
                    limitText.className = 'bio-limit-text warning';
                } else {
                    limitText.innerHTML = `<i class="ri-information-line"></i> ${remaining} slot${remaining !== 1 ? 's' : ''} remaining`;
                    limitText.className = 'bio-limit-text';
                }
            }
        }

        // Handle toggle change
        async function handleBiometricToggle(e) {
            const newState = e.target.checked;
            const toggle = e.target;

            try {
                const user = await window.blackonnAuth?.getCurrentUser();
                if (!user?.id) {
                    toggle.checked = !newState;
                    showToast('Please log in first', 'error');
                    return;
                }

                const response = await fetch(`/api/users/${user.id}/biometric`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ biometricEnabled: newState })
                });

                const data = await response.json();

                if (data.success) {
                    biometricState.enabled = newState;
                    renderBiometricUI();
                    showToast(`Biometric login ${newState ? 'enabled' : 'disabled'}`, 'success');
                } else {
                    toggle.checked = !newState;
                    showToast(data.error || 'Failed to update', 'error');
                }
            } catch (error) {
                console.error('Toggle error:', error);
                toggle.checked = !newState;
                showToast('Connection error', 'error');
            }
        }

        // Add new biometric credential
        async function addNewBiometric() {
            if (biometricState.credentials.length >= biometricState.maxCredentials) {
                showToast('Maximum credentials reached', 'error');
                return;
            }

            const user = await window.blackonnAuth?.getCurrentUser();
            if (!user?.id) {
                showToast('Please log in first', 'error');
                return;
            }

            // Get device name via modal
            const deviceName = await UniModal.prompt(
                'Name Your Device',
                'Give this device a recognizable name for easy identification',
                `My Device ${biometricState.credentials.length + 1}`,
                'e.g., My Phone, Work Laptop'
            );
            if (!deviceName) return;

            // Check WebAuthn support
            const hasWebAuthn = window.PublicKeyCredential && 
                typeof window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';

            if (hasWebAuthn) {
                try {
                    const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                    // Fix: Check for both instance and class
                    if (available && (window.biometricAuth || window.BiometricAuth)) {
                        await registerWithWebAuthn(user, deviceName);
                        return;
                    }
                } catch (e) {
                    console.warn('WebAuthn check failed:', e);
                }
            }

            // Fallback registration
            await registerFallback(user.id, deviceName);
        }

        // WebAuthn registration
        async function registerWithWebAuthn(user, deviceName) {
            try {
                // Use the global biometricAuth instance
                const bio = window.biometricAuth || new BiometricAuth();
                
                // Pass user.id to skip redundant /auth/me call
                const result = await bio.register(user.email, user.id);

                if (result?.id) {
                    // The register() function already syncs to server via syncCredentialToServer()
                    // Just check if we need to update the device name
                    if (deviceName && deviceName !== bio.getDeviceName()) {
                        try {
                            // Update the credential name on the server
                            await fetch(`/api/users/${user.id}/biometric/${result.id}`, {
                                method: 'PUT',
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: deviceName })
                            });
                        } catch (e) {
                            console.warn('Could not update device name:', e);
                        }
                    }
                    
                    showToast('Biometric registered successfully', 'success');
                    await loadBiometricData();
                } else {
                    throw new Error('No credential returned');
                }
            } catch (error) {
                console.error('WebAuthn error:', error);
                // Only fallback if WebAuthn truly failed (not user cancellation)
                if (error.name !== 'NotAllowedError' && error.name !== 'AbortError') {
                    await registerFallback(user.id, deviceName);
                } else {
                    showToast('Biometric registration was cancelled', 'info');
                }
            }
        }

        // Fallback registration (simulated)
        async function registerFallback(userId, deviceName) {
            await saveCredential(userId, {
                credentialId: crypto.randomUUID(),
                name: deviceName,
                type: 'fingerprint'
            });
        }

        // Save credential to server
        async function saveCredential(userId, credData) {
            try {
                const response = await fetch(`/api/users/${userId}/biometric`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Biometric registered successfully', 'success');
                    await loadBiometricData();
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Save credential error:', error);
                showToast('Failed to save credential', 'error');
            }
        }

        // Edit credential name
        async function editBiometricCredential(credentialId) {
            const cred = biometricState.credentials.find(c => c.id === credentialId);
            if (!cred) return;

            const newName = await UniModal.prompt(
                'Rename Device',
                'Enter a new name for this biometric credential',
                cred.name,
                'Enter device name'
            );
            if (!newName || newName === cred.name) return;

            try {
                const user = await window.blackonnAuth?.getCurrentUser();
                if (!user?.id) return;

                const response = await fetch(`/api/users/${user.id}/biometric/${credentialId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Device renamed', 'success');
                    await loadBiometricData();
                } else {
                    showToast(data.error || 'Update failed', 'error');
                }
            } catch (error) {
                console.error('Edit error:', error);
                showToast('Failed to update', 'error');
            }
        }

        // Delete credential
        async function deleteBiometricCredential(credentialId) {
            const cred = biometricState.credentials.find(c => c.id === credentialId);
            
            const confirmed = await UniModal.danger(
                'Remove Device',
                `Are you sure you want to remove "${cred?.name || 'this device'}" from biometric login?`,
                'Yes, Remove'
            );
            if (!confirmed) return;

            try {
                const user = await window.blackonnAuth?.getCurrentUser();
                if (!user?.id) return;

                const response = await fetch(`/api/users/${user.id}/biometric/${credentialId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Device removed', 'success');
                    await loadBiometricData();
                } else {
                    showToast(data.error || 'Delete failed', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete', 'error');
            }
        }

        // Helper: Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) return 'today';
            if (diff < 172800000) return 'yesterday';
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} days ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Helper: Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[c]);
        }

        // Legacy function aliases for backwards compatibility
        function toggleBiometric() {
            const toggle = document.getElementById('biometricToggle');
            if (toggle) toggle.click();
        }

        function updateBiometricUI() {
            renderBiometricUI();
        }

        // Load and display user queries/messages with admin replies
        async function loadUserQueries() {
            const queriesContent = document.getElementById('queriesContent');
            const emptyQueries = document.getElementById('emptyQueries');
            
            try {
                const response = await API.contact.getMine();
                const userQueries = response.messages || [];
                
                if (userQueries.length === 0) {
                    queriesContent.innerHTML = '';
                    emptyQueries.style.display = 'flex';
                    return;
                }
                
                emptyQueries.style.display = 'none';
                
                queriesContent.innerHTML = userQueries.map(query => {
                    const hasReplies = query.replies && query.replies.length > 0;
                    const hasAdminReply = hasReplies && query.replies.some(r => !r.isUserReply);
                    
                    // Determine status: pending (no replies), open (has conversation), solved (marked as resolved)
                    let status, statusLabel;
                    if (query.status === 'solved' || query.resolved) {
                        status = 'solved';
                        statusLabel = 'Solved';
                    } else if (hasAdminReply || hasReplies) {
                        status = 'open';
                        statusLabel = 'Open';
                    } else {
                        status = 'pending';
                        statusLabel = 'Pending';
                    }
                    
                    let repliesHTML = '';
                    if (hasReplies) {
                        repliesHTML = `
                            <div class="query-replies">
                                <strong style="font-size: 14px; color: #1f2937;">Conversation:</strong>
                                ${query.replies.map(reply => `
                                    <div class="reply-item ${reply.isUserReply ? 'user-reply' : ''}">
                                        <div class="reply-header">
                                            <strong>${reply.isUserReply ? 'You' : 'Admin Response'}</strong>
                                            <small>${new Date(reply.createdAt || reply.timestamp).toLocaleString()}</small>
                                        </div>
                                        <p class="reply-content">${reply.text}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        repliesHTML = `
                            <div class="query-replies">
                                <p class="no-replies">No replies yet. We will get back to you soon.</p>
                            </div>
                        `;
                    }
                    
                    const queryDate = new Date(query.createdAt || query.timestamp).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const isClosed = status === 'solved';
                    
                    return `
                        <div class="query-card" data-query-id="${query.id}">
                            <div class="query-header">
                                <div>
                                    <span class="query-id" style="font-size: 0.7rem; color: #6b7280; font-family: monospace; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 4px;">${query.queryNumber || query.id}</span>
                                    <h3 class="query-subject">${query.subject || 'No Subject'}</h3>
                                    <p class="query-date">${queryDate}</p>
                                </div>
                                <span class="query-status ${status}">${statusLabel}</span>
                            </div>
                            <div class="query-message">
                                ${query.message}
                            </div>
                            ${repliesHTML}
                            ${isClosed ? `
                                <div class="query-closed-notice" style="padding: 12px 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; margin-top: 12px; color: #166534; font-size: 14px;">
                                    <i class="ri-checkbox-circle-line" style="margin-right: 6px;"></i>
                                    This query has been resolved and closed.
                                </div>
                                <div class="query-actions" style="margin-top: 12px;">
                                    <a href="contact.html?subject=Follow-up: ${encodeURIComponent(query.subject || 'Previous Query')}" class="btn-raise-query" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: #000; color: #fff; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; transition: background 0.2s;">
                                        <i class="ri-add-line"></i> Raise a New Query
                                    </a>
                                </div>
                            ` : `
                                <div class="query-actions">
                                    <button class="btn-reply-query" data-action="show-reply-form" data-query-id="${query.id}">
                                        <i class="ri-reply-line"></i> Reply
                                    </button>
                                </div>
                                <div class="query-reply-form" id="reply-form-${query.id}" style="display: none;">
                                    <textarea placeholder="Type your reply here..." id="reply-text-${query.id}"></textarea>
                                    <div class="reply-image-upload">
                                        <div class="reply-image-upload-box" data-query-id="${query.id}">
                                            <input type="file" id="reply-images-${query.id}" accept="image/*" multiple hidden>
                                            <i class="ri-image-add-line"></i>
                                            <span>Add images (max 3, 5MB each)</span>
                                        </div>
                                        <div class="reply-image-previews" id="reply-previews-${query.id}"></div>
                                    </div>
                                    <div class="query-reply-form-actions">
                                        <button class="btn-cancel-reply" data-action="cancel-reply" data-query-id="${query.id}">Cancel</button>
                                        <button class="btn-send-reply" data-action="send-reply" data-query-id="${query.id}">Send Reply</button>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
                
                // Attach event delegation for queries content
                if (!queriesContent.dataset.handlerAttached) {
                    queriesContent.dataset.handlerAttached = 'true';
                    queriesContent.addEventListener('click', handleQueryAction);
                }
                
            } catch (error) {
                console.error('Error loading queries:', error);
                queriesContent.innerHTML = '<p style="color: #dc2626;">Error loading your queries. Please try again.</p>';
            }
        }

        // Store reply images per query
        const replyImages = {};
        
        // Handle query actions (reply button, send reply, cancel)
        async function handleQueryAction(e) {
            // Handle upload box click
            const uploadBox = e.target.closest('.reply-image-upload-box');
            if (uploadBox) {
                const queryId = uploadBox.dataset.queryId;
                const fileInput = document.getElementById(`reply-images-${queryId}`);
                if (fileInput) fileInput.click();
                return;
            }
            
            // Handle remove image button
            if (e.target.classList.contains('remove-img')) {
                const queryId = e.target.dataset.queryId;
                const index = parseInt(e.target.dataset.index);
                if (replyImages[queryId]) {
                    replyImages[queryId].splice(index, 1);
                    renderReplyImagePreviews(queryId);
                }
                return;
            }
            
            // Handle file input change
            if (e.target.type === 'file' && e.target.id.startsWith('reply-images-')) {
                const queryId = e.target.id.replace('reply-images-', '');
                handleReplyImageSelect(e.target, queryId);
                return;
            }
            
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            
            const action = button.dataset.action;
            const queryId = button.dataset.queryId;
            
            if (action === 'show-reply-form') {
                // Show the reply form
                const form = document.getElementById(`reply-form-${queryId}`);
                if (form) {
                    form.style.display = 'block';
                    const textarea = document.getElementById(`reply-text-${queryId}`);
                    if (textarea) textarea.focus();
                    // Initialize images array
                    if (!replyImages[queryId]) replyImages[queryId] = [];
                }
            } else if (action === 'cancel-reply') {
                // Hide the reply form
                const form = document.getElementById(`reply-form-${queryId}`);
                if (form) {
                    form.style.display = 'none';
                    const textarea = document.getElementById(`reply-text-${queryId}`);
                    if (textarea) textarea.value = '';
                    // Clear images
                    replyImages[queryId] = [];
                    renderReplyImagePreviews(queryId);
                }
            } else if (action === 'send-reply') {
                // Send the reply
                const textarea = document.getElementById(`reply-text-${queryId}`);
                const replyText = textarea ? textarea.value.trim() : '';
                
                if (!replyText) {
                    showToast('Please enter a reply message', 'warning');
                    return;
                }
                
                // Disable button while sending
                button.disabled = true;
                button.textContent = 'Sending...';
                
                try {
                    // Upload images if any
                    let attachments = [];
                    if (replyImages[queryId] && replyImages[queryId].length > 0) {
                        try {
                            const uploadResult = await fetch('/api/uploads/contact-attachments', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ images: replyImages[queryId].map(img => img.base64) })
                            });
                            const uploadData = await uploadResult.json();
                            if (uploadData.success && uploadData.attachments) {
                                attachments = uploadData.attachments;
                            }
                        } catch (uploadError) {
                            console.error('Image upload failed:', uploadError);
                        }
                    }
                    
                    const response = await API.contact.userReply(queryId, replyText, attachments);
                    
                    if (response.success) {
                        showSuccessPopup('Reply Sent', 'Your reply has been sent successfully.');
                        // Clear images
                        replyImages[queryId] = [];
                        // Reload queries to show the new reply
                        loadUserQueries();
                    } else {
                        showToast(response.error || 'Failed to send reply', 'error');
                        button.disabled = false;
                        button.textContent = 'Send Reply';
                    }
                } catch (error) {
                    console.error('Error sending reply:', error);
                    showToast('Failed to send reply. Please try again.', 'error');
                    button.disabled = false;
                    button.textContent = 'Send Reply';
                }
            }
        }
        
        function handleReplyImageSelect(input, queryId) {
            const files = Array.from(input.files);
            if (!replyImages[queryId]) replyImages[queryId] = [];
            
            if (replyImages[queryId].length + files.length > 3) {
                showToast('Maximum 3 images allowed', 'warning');
                return;
            }
            
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`${file.name} is too large. Maximum 5MB`, 'warning');
                    return;
                }
                if (!['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type)) {
                    showToast(`${file.name} is not a valid image`, 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    replyImages[queryId].push({ base64: e.target.result, name: file.name });
                    renderReplyImagePreviews(queryId);
                };
                reader.readAsDataURL(file);
            });
            
            input.value = '';
        }
        
        function renderReplyImagePreviews(queryId) {
            const container = document.getElementById(`reply-previews-${queryId}`);
            if (!container) return;
            
            const images = replyImages[queryId] || [];
            container.innerHTML = images.map((img, index) => `
                <div class="reply-image-preview">
                    <img src="${img.base64}" alt="${img.name}">
                    <button type="button" class="remove-img" data-query-id="${queryId}" data-index="${index}"></button>
                </div>
            `).join('');
            
            // Hide upload box if 3 images
            const uploadBox = document.querySelector(`.reply-image-upload-box[data-query-id="${queryId}"]`);
            if (uploadBox) {
                uploadBox.style.display = images.length >= 3 ? 'none' : 'flex';
            }
        }

        // Load and display wishlist items
        // Global wishlist array for reference by index
        let wishlistItems = [];

        async function loadWishlist() {
            const wishlistContent = document.getElementById('wishlistContent');
            const emptyWishlist = document.getElementById('emptyWishlist');

            try {
                const response = await API.wishlist.get();
                wishlistItems = response.wishlist || [];

                if (wishlistItems.length === 0) {
                    wishlistContent.innerHTML = '';
                    emptyWishlist.style.display = 'flex';
                    return;
                }

                emptyWishlist.style.display = 'none';
                wishlistContent.innerHTML = `
                    <div class="wishlist-grid">
                        ${wishlistItems.map((item, index) => `
                            <div class="wishlist-item" data-index="${index}" data-item-id="${item.id}">
                                <img src="${normalizeUploadUrl(item.image)}" alt="${item.name}" class="wishlist-item-image">
                                <div class="wishlist-item-info">
                                    <div class="wishlist-item-name">${item.name}</div>
                                    <div class="wishlist-item-price">${item.price}</div>
                                    <div class="wishlist-item-actions">
                                        <button class="btn-add-cart" data-action="add-to-cart" data-index="${index}">
                                            <i class="ri-shopping-cart-line"></i> Add to Cart
                                        </button>
                                        <button class="btn-remove-wishlist" data-action="remove" data-item-id="${item.id}">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading wishlist:', error);
                wishlistContent.innerHTML = '<p style="color:#e74c3c;text-align:center;">Failed to load wishlist</p>';
            }
        }

        // Remove item from wishlist via API
        async function removeFromWishlist(itemId) {
            try {
                await API.wishlist.remove(itemId);
                showSuccessPopup('Item Removed!', 'Item has been removed from your wishlist.');
                loadWishlist();
            } catch (error) {
                console.error('Error removing from wishlist:', error);
                showSuccessPopup('Error', 'Failed to remove item from wishlist');
            }
        }

        // Add to cart from wishlist
        function addToCartFromWishlist(index) {
            const item = wishlistItems[index];
            
            if (!item) return;
            
            // Redirect to product page to select size and color - Use 'id' parameter as expected by products.html
            window.location.href = `products.html?id=${item.id || item.productId || item.productIndex}`;
        }

        // Load wishlist on page load
        loadWishlist();

        // ===== GIFT CARDS FUNCTIONS =====
        
        let userGiftCards = [];
        let giftCardTransactions = [];

        async function loadUserGiftCards() {
            const giftcardsList = document.getElementById('giftcardsList');
            const emptyGiftcards = document.getElementById('emptyGiftcards');
            const giftcardHistory = document.getElementById('giftcardHistory');
            
            try {
                const response = await fetch('/api/gift-cards/my-cards', { credentials: 'include' });
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load gift cards');
                }

                userGiftCards = data.cards || [];
                giftCardTransactions = data.transactions || [];
                const summary = data.summary || {};

                // Update summary stats
                document.getElementById('gcTotalBalance').textContent = '' + (summary.totalBalance || 0).toLocaleString();
                document.getElementById('gcTotalPurchased').textContent = '' + (summary.totalPurchased || 0).toLocaleString();
                document.getElementById('gcTotalReceived').textContent = '' + (summary.totalReceived || 0).toLocaleString();
                document.getElementById('gcTotalUsed').textContent = '' + (summary.totalUsed || 0).toLocaleString();

                if (userGiftCards.length === 0) {
                    giftcardsList.innerHTML = '';
                    emptyGiftcards.style.display = 'flex';
                    document.getElementById('giftcardSummary').style.display = 'none';
                    giftcardHistory.style.display = 'none';
                    return;
                }

                document.getElementById('giftcardSummary').style.display = 'grid';
                emptyGiftcards.style.display = 'none';
                
                renderGiftCards(userGiftCards);
                renderGiftCardTransactions(giftCardTransactions);
                
            } catch (error) {
                console.error('Error loading gift cards:', error);
                giftcardsList.innerHTML = '<p style="color:#e74c3c;text-align:center;padding:40px;">Failed to load gift cards. Please try again.</p>';
            }
        }

        function renderGiftCards(cards) {
            const giftcardsList = document.getElementById('giftcardsList');
            
            if (cards.length === 0) {
                giftcardsList.innerHTML = '<p style="text-align:center;padding:40px;color:#6b7280;">No gift cards match this filter.</p>';
                return;
            }

            giftcardsList.innerHTML = cards.map(card => {
                const isExpired = new Date(card.expiresAt) < new Date();
                const isFullyUsed = card.balance <= 0;
                const statusClass = isExpired ? 'expired' : (isFullyUsed ? 'redeemed' : 'active');
                const statusText = isExpired ? 'Expired' : (isFullyUsed ? 'Fully Used' : 'Active');
                const statusColor = isExpired ? '#ef4444' : (isFullyUsed ? '#6b7280' : '#10b981');
                
                const cardType = card.isReceived && !card.isPurchased ? 'Received as Gift' : (card.isPurchased ? 'Purchased' : 'Gift Card');
                const typeColor = card.isReceived && !card.isPurchased ? '#f59e0b' : '#3b82f6';

                return `
                    <div class="giftcard-item" data-status="${card.status}" data-balance="${card.balance}" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 16px; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                        <div style="position: absolute; bottom: -40px; left: -40px; width: 100px; height: 100px; background: rgba(255,255,255,0.03); border-radius: 50%;"></div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: relative;">
                            <div>
                                <span style="font-size: 0.7rem; background: ${typeColor}; padding: 4px 10px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px;">${cardType}</span>
                                <div style="font-size: 1.5rem; font-weight: 700; margin-top: 12px; font-family: monospace; letter-spacing: 2px;">${card.code}</div>
                            </div>
                            <span style="font-size: 0.75rem; background: ${statusColor}; padding: 4px 12px; border-radius: 12px;">${statusText}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase;">Original Value</div>
                                <div style="font-size: 1.1rem; font-weight: 600;">${(card.value || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase;">Remaining Balance</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: ${card.balance > 0 ? '#4ade80' : '#f87171'};">${(card.balance || 0).toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 0.75rem; opacity: 0.7;">
                                <i class="ri-calendar-line"></i> Expires: ${new Date(card.expiresAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}
                            </div>
                            ${card.balance > 0 && !isExpired ? `
                                <button onclick="copyGiftCardCode('${card.code}')" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
                                    <i class="ri-file-copy-line"></i> Copy Code
                                </button>
                            ` : ''}
                        </div>
                        
                        ${card.senderName && card.isReceived && !card.isPurchased ? `
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <i class="ri-gift-line"></i> From: ${card.senderName}
                                ${card.message ? `<div style="font-style: italic; margin-top: 4px;">"${card.message}"</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderGiftCardTransactions(transactions) {
            const historyContainer = document.getElementById('giftcardHistory');
            const transactionsList = document.getElementById('giftcardTransactions');
            
            if (!transactions || transactions.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }

            historyContainer.style.display = 'block';
            
            transactionsList.innerHTML = transactions.map(tx => {
                const isRedeem = tx.type === 'redeem';
                const icon = isRedeem ? 'ri-arrow-right-up-line' : 'ri-add-line';
                const color = isRedeem ? '#ef4444' : '#10b981';
                const sign = isRedeem ? '-' : '+';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f3f4f6;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${color}15; display: flex; align-items: center; justify-content: center;">
                                <i class="${icon}" style="color: ${color};"></i>
                            </div>
                            <div>
                                <div style="font-weight: 500; font-size: 0.9rem;">${tx.type === 'redeem' ? 'Redeemed' : 'Purchased'}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${tx.details || ''}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: ${color};">${sign}${(tx.amount || 0).toLocaleString()}</div>
                            <div style="font-size: 0.7rem; color: #9ca3af;">${new Date(tx.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterGiftCards(filter, btn) {
            // Update tab styles
            document.querySelectorAll('.gc-tab').forEach(tab => {
                tab.style.background = '#f3f4f6';
                tab.style.color = '#374151';
                tab.classList.remove('active');
            });
            btn.style.background = '#000';
            btn.style.color = 'white';
            btn.classList.add('active');
            
            // Filter cards
            let filteredCards = userGiftCards;
            if (filter === 'active') {
                filteredCards = userGiftCards.filter(c => c.status === 'active' && c.balance > 0 && new Date(c.expiresAt) >= new Date());
            } else if (filter === 'used') {
                filteredCards = userGiftCards.filter(c => c.balance <= 0 || c.status === 'redeemed');
            }
            
            renderGiftCards(filteredCards);
        }

        function copyGiftCardCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showSuccessPopup('Code Copied!', 'Gift card code has been copied to clipboard.');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showSuccessPopup('Code Copied!', 'Gift card code has been copied to clipboard.');
            });
        }

        function showBuyGiftCardModal() {
            const modalHtml = `
                <div id="buyGiftCardModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100000; overflow-y: auto; padding: 20px;">
                    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); margin: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0; font-size: 1.25rem;"><i class="ri-gift-line"></i> Buy Gift Card</h3>
                            <button onclick="document.getElementById('buyGiftCardModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        
                        <!-- Amount Selection -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 12px;">Select Amount</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;" id="gcAmountGrid">
                                <button type="button" class="gc-amount-btn" data-amount="500" onclick="selectGiftCardAmount(500, this)" style="padding: 16px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">500</button>
                                <button type="button" class="gc-amount-btn" data-amount="1000" onclick="selectGiftCardAmount(1000, this)" style="padding: 16px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">1,000</button>
                                <button type="button" class="gc-amount-btn" data-amount="2000" onclick="selectGiftCardAmount(2000, this)" style="padding: 16px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">2,000</button>
                                <button type="button" class="gc-amount-btn" data-amount="5000" onclick="selectGiftCardAmount(5000, this)" style="padding: 16px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">5,000</button>
                                <button type="button" class="gc-amount-btn" data-amount="10000" onclick="selectGiftCardAmount(10000, this)" style="padding: 16px 8px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">10,000</button>
                                <input type="number" id="gcCustomAmount" placeholder="Custom" min="100" max="50000" style="padding: 16px 8px; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; font-weight: 600;" onchange="selectGiftCardAmount(this.value, null)" />
                            </div>
                            <input type="hidden" id="selectedGcAmount" value="" />
                        </div>
                        
                        <!-- Gift For -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Gift For</label>
                            <div style="display: flex; gap: 12px;">
                                <label style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="gcForSelfLabel">
                                    <input type="radio" name="gcFor" value="self" style="display: none;" onchange="toggleGiftRecipient(false)" />
                                    <i class="ri-user-line" style="font-size: 1.25rem; display: block; margin-bottom: 4px;"></i>
                                    <span style="font-size: 0.875rem; font-weight: 500;">For Myself</span>
                                </label>
                                <label style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" id="gcForOtherLabel">
                                    <input type="radio" name="gcFor" value="other" style="display: none;" onchange="toggleGiftRecipient(true)" />
                                    <i class="ri-gift-2-line" style="font-size: 1.25rem; display: block; margin-bottom: 4px;"></i>
                                    <span style="font-size: 0.875rem; font-weight: 500;">Gift Someone</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Recipient Details (hidden by default) -->
                        <div id="gcRecipientDetails" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Recipient's Name</label>
                                <input type="text" id="gcRecipientName" placeholder="Enter recipient's name" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" />
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Recipient's Email</label>
                                <input type="email" id="gcRecipientEmail" placeholder="Enter recipient's email" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;" />
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Personal Message (Optional)</label>
                                <textarea id="gcMessage" placeholder="Write a personal message..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <div id="gcPurchaseError" style="display: none; padding: 12px; background: #fef2f2; color: #dc2626; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;"></div>
                        
                        <button onclick="purchaseGiftCard()" id="gcPurchaseBtn" style="width: 100%; padding: 16px; background: #000; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                            <i class="ri-shopping-cart-line"></i> Add to Cart
                        </button>
                        
                        <p style="text-align: center; margin-top: 12px; font-size: 0.75rem; color: #6b7280;">Gift cards are valid for 1 year from purchase date</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        let selectedGiftCardAmount = 0;

        function selectGiftCardAmount(amount, btn) {
            selectedGiftCardAmount = parseInt(amount) || 0;
            document.getElementById('selectedGcAmount').value = selectedGiftCardAmount;
            
            // Update button styles
            document.querySelectorAll('.gc-amount-btn').forEach(b => {
                b.style.borderColor = '#e5e7eb';
                b.style.background = 'white';
            });
            
            if (btn) {
                btn.style.borderColor = '#000';
                btn.style.background = '#f0f0f0';
                document.getElementById('gcCustomAmount').value = '';
            }
        }

        function toggleGiftRecipient(showRecipient) {
            const recipientDetails = document.getElementById('gcRecipientDetails');
            const selfLabel = document.getElementById('gcForSelfLabel');
            const otherLabel = document.getElementById('gcForOtherLabel');
            
            if (showRecipient) {
                recipientDetails.style.display = 'block';
                otherLabel.style.borderColor = '#000';
                otherLabel.style.background = '#f0f0f0';
                selfLabel.style.borderColor = '#e5e7eb';
                selfLabel.style.background = 'white';
            } else {
                recipientDetails.style.display = 'none';
                selfLabel.style.borderColor = '#000';
                selfLabel.style.background = '#f0f0f0';
                otherLabel.style.borderColor = '#e5e7eb';
                otherLabel.style.background = 'white';
            }
        }

        async function purchaseGiftCard() {
            const amount = selectedGiftCardAmount || parseInt(document.getElementById('gcCustomAmount').value) || 0;
            const errorDiv = document.getElementById('gcPurchaseError');
            const purchaseBtn = document.getElementById('gcPurchaseBtn');
            
            // Validate amount
            if (!amount || amount < 100 || amount > 50000) {
                errorDiv.textContent = 'Please select an amount between 100 and 50,000';
                errorDiv.style.display = 'block';
                return;
            }
            
            const isForOther = document.querySelector('input[name="gcFor"][value="other"]')?.checked;
            let recipientEmail = '';
            let recipientName = '';
            let message = '';
            
            if (isForOther) {
                recipientName = document.getElementById('gcRecipientName').value.trim();
                recipientEmail = document.getElementById('gcRecipientEmail').value.trim();
                message = document.getElementById('gcMessage').value.trim();
                
                if (!recipientEmail) {
                    errorDiv.textContent = 'Please enter recipient\'s email address';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                if (!isValidEmail(recipientEmail)) {
                    errorDiv.textContent = 'Please enter a valid email address';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            errorDiv.style.display = 'none';
            purchaseBtn.disabled = true;
            purchaseBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Processing...';
            
            try {
                // Add to cart as gift card item
                const cartItem = {
                    type: 'gift-card',
                    name: 'BLACKONN Gift Card',
                    value: amount,
                    recipientName: recipientName || 'Self',
                    recipientEmail: recipientEmail || '',
                    message: message,
                    isGift: isForOther
                };
                
                const response = await fetch('/api/cart/add-gift-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(cartItem)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('buyGiftCardModal').remove();
                    showSuccessPopup('Added to Cart!', `${amount.toLocaleString()} Gift Card added to your cart.`);
                    // Update cart count if available
                    if (typeof updateCartCount === 'function') updateCartCount();
                } else {
                    throw new Error(result.error || 'Failed to add gift card to cart');
                }
            } catch (error) {
                console.error('Error adding gift card to cart:', error);
                errorDiv.textContent = error.message || 'Failed to add gift card. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                purchaseBtn.disabled = false;
                purchaseBtn.innerHTML = '<i class="ri-shopping-cart-line"></i> Add to Cart';
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showRedeemGiftCardModal() {
            const modalHtml = `
                <div id="redeemGiftCardModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100000;">
                    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0; font-size: 1.25rem;"><i class="ri-add-circle-line"></i> Add Gift Card</h3>
                            <button onclick="document.getElementById('redeemGiftCardModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 20px;">Enter your gift card code to add it to your account. You can use it during checkout.</p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Gift Card Code</label>
                            <input type="text" id="redeemGcCode" placeholder="e.g., BLK-XXXX-XXXX" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; text-transform: uppercase; font-family: monospace; letter-spacing: 1px;" oninput="this.value = this.value.toUpperCase()" />
                        </div>
                        
                        <div id="redeemResult" style="display: none; padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
                        
                        <button onclick="addGiftCardToAccount()" id="redeemBtn" style="width: 100%; padding: 14px; background: #000; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Add Gift Card
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            setTimeout(() => document.getElementById('redeemGcCode')?.focus(), 100);
        }

        async function addGiftCardToAccount() {
            const code = document.getElementById('redeemGcCode').value.trim();
            const resultDiv = document.getElementById('redeemResult');
            const redeemBtn = document.getElementById('redeemBtn');
            
            if (!code) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '<p style="color: #dc2626; margin: 0;"><i class="ri-error-warning-line"></i> Please enter a gift card code</p>';
                return;
            }
            
            redeemBtn.disabled = true;
            redeemBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Verifying...';
            
            try {
                const response = await fetch('/api/gift-cards/add-to-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ code })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    resultDiv.style.background = '#f0fdf4';
                    resultDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 8px;"></div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 4px;">${(data.balance || 0).toLocaleString()}</div>
                            <div style="font-size: 0.875rem; color: #059669;">Gift card added successfully!</div>
                        </div>
                    `;
                    // Refresh the gift cards list
                    setTimeout(() => {
                        document.getElementById('redeemGiftCardModal').remove();
                        loadUserGiftCards();
                    }, 2000);
                } else {
                    resultDiv.style.background = '#fef2f2';
                    resultDiv.innerHTML = `<p style="color: #dc2626; margin: 0;"><i class="ri-error-warning-line"></i> ${data.error || 'Gift card not found or already used'}</p>`;
                }
            } catch (error) {
                console.error('Error adding gift card:', error);
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '<p style="color: #dc2626; margin: 0;"><i class="ri-error-warning-line"></i> Failed to add gift card. Please try again.</p>';
            } finally {
                redeemBtn.disabled = false;
                redeemBtn.innerHTML = 'Add Gift Card';
            }
        }

        function showCheckBalanceModal() {
            const modalHtml = `
                <div id="checkBalanceModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100000;">
                    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0; font-size: 1.25rem;"><i class="ri-search-line"></i> Check Gift Card Balance</h3>
                            <button onclick="document.getElementById('checkBalanceModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 8px;">Gift Card Code</label>
                            <input type="text" id="balanceCheckCode" placeholder="e.g., BLK-XXXX-XXXX" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; text-transform: uppercase;" />
                        </div>
                        <div id="balanceResult" style="display: none; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 16px;"></div>
                        <button onclick="checkGiftCardBalance()" style="width: 100%; padding: 14px; background: #000; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Check Balance
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            setTimeout(() => document.getElementById('balanceCheckCode')?.focus(), 100);
        }

        async function checkGiftCardBalance() {
            const code = document.getElementById('balanceCheckCode').value.trim();
            const resultDiv = document.getElementById('balanceResult');
            
            if (!code) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0;"><i class="ri-error-warning-line"></i> Please enter a gift card code</p>';
                return;
            }

            try {
                const response = await fetch(`/api/gift-cards/balance/${encodeURIComponent(code)}`, { credentials: 'include' });
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    const statusColor = data.status === 'active' ? '#10b981' : (data.status === 'expired' ? '#ef4444' : '#6b7280');
                    resultDiv.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #10b981; margin-bottom: 8px;">${(data.balance || 0).toLocaleString()}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Available Balance</div>
                            <div style="margin-top: 12px; display: flex; justify-content: center; gap: 16px; font-size: 0.75rem; color: #9ca3af;">
                                <span>Original: ${(data.originalValue || 0).toLocaleString()}</span>
                                <span style="color: ${statusColor}; font-weight: 600; text-transform: uppercase;">${data.status}</span>
                            </div>
                            ${data.expiresAt ? `<div style="margin-top: 8px; font-size: 0.75rem; color: #9ca3af;">Expires: ${new Date(data.expiresAt).toLocaleDateString('en-IN')}</div>` : ''}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<p style="color: #ef4444; margin: 0; text-align: center;"><i class="ri-error-warning-line"></i> ${data.error || 'Gift card not found'}</p>`;
                }
            } catch (error) {
                console.error('Error checking balance:', error);
                resultDiv.innerHTML = '<p style="color: #ef4444; margin: 0; text-align: center;"><i class="ri-error-warning-line"></i> Failed to check balance. Please try again.</p>';
            }
        }

        // ===== ADDRESS FUNCTIONS =====
        
        // Global addresses array for reference
        let userAddresses = [];

        // Load and display addresses via API
        async function loadAddresses() {
            const addressesContent = document.getElementById('addressesContent');
            const emptyAddresses = document.getElementById('emptyAddresses');
            
            try {
                const response = await API.users.getAddresses();
                userAddresses = response.addresses || [];

                if (userAddresses.length === 0) {
                    addressesContent.innerHTML = '';
                    emptyAddresses.style.display = 'flex';
                    return;
                }

                emptyAddresses.style.display = 'none';
                addressesContent.innerHTML = userAddresses.map((addr, index) => `
                    <div class="address-card" data-address-id="${addr.id}">
                        <div class="address-card-header">
                            <div>
                                <div class="address-label">${addr.label}</div>
                                <div class="address-details">
                                    ${addr.name}<br>
                                    ${addr.street}<br>
                                    ${addr.city}, ${addr.state} - ${addr.pincode}<br>
                                    Phone: ${addr.phone}
                                </div>
                            </div>
                            <div class="address-actions">
                                <button class="btn-edit-address" data-action="edit" data-address-id="${addr.id}">Edit</button>
                                <button class="btn-delete-address" data-action="delete" data-address-id="${addr.id}">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading addresses:', error);
                addressesContent.innerHTML = '<p style="color:#e74c3c;text-align:center;">Failed to load addresses</p>';
            }
        }

        // Open address modal for adding new address
        function openAddressModal() {
            document.getElementById('addressModalTitle').textContent = 'Add New Address';
            document.getElementById('addressForm').reset();
            document.getElementById('addressIndex').value = '';
            document.getElementById('addressModal').classList.add('show');
        }

        // Close address modal
        function closeAddressModal() {
            document.getElementById('addressModal').classList.remove('show');
        }

        // Edit address
        function editAddress(addressId) {
            const addr = userAddresses.find(a => a.id === addressId);
            
            if (!addr) return;

            document.getElementById('addressModalTitle').textContent = 'Edit Address';
            document.getElementById('addressIndex').value = addressId;
            document.getElementById('addressLabel').value = addr.label;
            document.getElementById('addressName').value = addr.name;
            document.getElementById('addressPhone').value = addr.phone;
            document.getElementById('addressStreet').value = addr.street;
            document.getElementById('addressCity').value = addr.city;
            document.getElementById('addressState').value = addr.state;
            document.getElementById('addressPincode').value = addr.pincode;
            
            document.getElementById('addressModal').classList.add('show');
        }

        // Save address (add or update) via API
        document.getElementById('addressForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const addressId = document.getElementById('addressIndex').value;
            const newAddress = {
                label: document.getElementById('addressLabel').value,
                name: document.getElementById('addressName').value,
                phone: document.getElementById('addressPhone').value,
                street: document.getElementById('addressStreet').value,
                city: document.getElementById('addressCity').value,
                state: document.getElementById('addressState').value,
                pincode: document.getElementById('addressPincode').value
            };

            try {
                if (!addressId) {
                    // Add new address
                    await API.users.addAddress(newAddress);
                    showSuccessPopup('Address Added!', 'Your new address has been saved successfully.');
                } else {
                    // Update existing address
                    await API.users.updateAddress(addressId, newAddress);
                    showSuccessPopup('Address Updated!', 'Your address has been updated successfully.');
                }
                
                closeAddressModal();
                loadAddresses();
            } catch (error) {
                console.error('Error saving address:', error);
                showSuccessPopup('Error', 'Failed to save address. Please try again.');
            }
        });

        // Open delete confirmation modal
        function openDeleteModal(addressId) {
            document.getElementById('deleteAddressIndex').value = addressId;
            document.getElementById('deleteModal').classList.add('show');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        // Confirm delete address via API
        async function confirmDeleteAddress() {
            const addressId = document.getElementById('deleteAddressIndex').value;
            
            if (!addressId || addressId === '-1') {
                showSuccessPopup('Error', 'No address selected to delete');
                closeDeleteModal();
                return;
            }
            
            try {
                const result = await API.users.deleteAddress(addressId);
                if (result && result.success) {
                    closeDeleteModal();
                    showSuccessPopup('Address Deleted!', 'Your address has been removed successfully.');
                    loadAddresses();
                } else {
                    throw new Error(result?.error || 'Failed to delete address');
                }
            } catch (error) {
                console.error('Error deleting address:', error);
                showSuccessPopup('Error', 'Failed to delete address. Please try again.');
                closeDeleteModal();
            }
        }

        // Load addresses on page load
        loadAddresses();

        // Upload avatar via API
        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image size should be less than 5MB', 'warning');
                    return;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                    const imageData = e.target.result;
                    
                    try {
                        const user = await window.blackonnAuth.getCurrentUser();
                        if (!user) {
                            showToast('Please login to update your profile picture', 'warning');
                            return;
                        }
                        
                        // Update avatar via API
                        const response = await API.users.update(user.id, { avatar: imageData });
                        
                        if (response.success) {
                            // Update avatar display
                            const avatarImage = document.getElementById('avatarImage');
                            const avatarIcon = document.getElementById('avatarIcon');
                            
                            avatarImage.src = imageData;
                            avatarImage.style.display = 'block';
                            avatarIcon.style.display = 'none';
                            
                            showToast('Profile picture updated successfully!', 'success');
                        } else {
                            showToast('Failed to update profile picture', 'error');
                        }
                        } catch (error) {
                        console.error('Error uploading avatar:', error);
                        showToast('Failed to upload profile picture. Please try again.', 'error');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Load saved avatar on page load
        async function loadAvatar() {
            try {
                const user = await window.blackonnAuth.getCurrentUser();
                if (user && user.avatar) {
                    const avatarImage = document.getElementById('avatarImage');
                    const avatarIcon = document.getElementById('avatarIcon');
                    
                    avatarImage.src = user.avatar;
                    avatarImage.style.display = 'block';
                    avatarIcon.style.display = 'none';
                }
            } catch (err) {
                console.error('Error loading avatar:', err);
            }
        }

        // ===== EVENT DELEGATION FOR DYNAMIC CONTENT =====
        
        // Avatar upload handlers
        const avatarContainer = document.getElementById('profileAvatarContainer');
        const avatarInput = document.getElementById('avatarInput');
        
        if (avatarContainer) {
            avatarContainer.addEventListener('click', function(e) {
                // Don't trigger if clicking on the file input itself
                if (e.target !== avatarInput) {
                    avatarInput.click();
                }
            });
        }
        
        if (avatarInput) {
            avatarInput.addEventListener('change', function(e) {
                uploadAvatar(e);
            });
        }
        
        // Profile actions (Edit Profile & Logout buttons)
        const profileActions = document.getElementById('profileActions');
        if (profileActions && !profileActions.dataset.handlerAttached) {
            profileActions.dataset.handlerAttached = 'true';
            profileActions.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                if (action === 'edit-profile') {
                    showSection('profile');
                } else if (action === 'show-logout') {
                    showLogoutPopup();
                } else if (action === 'delete-account') {
                    showDeleteAccountModal();
                }
            });
        }
        
        // Logout popup buttons
        const logoutPopup = document.getElementById('logoutPopup');
        if (logoutPopup && !logoutPopup.dataset.handlerAttached) {
            logoutPopup.dataset.handlerAttached = 'true';
            logoutPopup.addEventListener('click', function(e) {
                // Close when clicking overlay
                if (e.target === this) {
                    hideLogoutPopup();
                    return;
                }
                
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                if (action === 'hide-logout') {
                    hideLogoutPopup();
                } else if (action === 'confirm-logout') {
                    confirmLogout();
                }
            });
        }

        // Delete account modal buttons
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        if (deleteAccountModal && !deleteAccountModal.dataset.handlerAttached) {
            deleteAccountModal.dataset.handlerAttached = 'true';
            deleteAccountModal.addEventListener('click', function(e) {
                // Close when clicking overlay
                if (e.target === this) {
                    hideDeleteAccountModal();
                    return;
                }
                
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                if (action === 'hide-delete-modal') {
                    hideDeleteAccountModal();
                } else if (action === 'confirm-delete') {
                    confirmDeleteAccount();
                }
            });
        }
        
        // Orders list event delegation
        const ordersList = document.getElementById('ordersList');
        if (ordersList && !ordersList.dataset.ordersHandlerAttached) {
            ordersList.dataset.ordersHandlerAttached = 'true';
            ordersList.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const orderId = button.dataset.orderId;
                
                if (action === 'track' && orderId) {
                    trackOrder(orderId);
                } else if (action === 'reorder' && orderId) {
                    reorderItems(orderId);
                } else if (action === 'return' && orderId) {
                    returnItems(orderId);
                } else if (action === 'exchange' && orderId) {
                    exchangeItems(orderId);
                } else if (action === 'cancel-order' && orderId) {
                    cancelOrder(orderId);
                } else if (action === 'invoice' && orderId) {
                    downloadInvoice(orderId);
                } else if (action === 'retry') {
                    loadUserOrders();
                }
            });
        }
        
        // Returns list event delegation
        const returnsList = document.getElementById('returnsList');
        if (returnsList && !returnsList.dataset.returnsHandlerAttached) {
            returnsList.dataset.returnsHandlerAttached = 'true';
            returnsList.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const returnId = button.dataset.returnId;
                
                if (action === 'track-return' && returnId) {
                    trackReturn(returnId);
                }
            });
        }
        
        // Exchanges list event delegation
        const exchangesList = document.getElementById('exchangesList');
        if (exchangesList && !exchangesList.dataset.exchangesHandlerAttached) {
            exchangesList.dataset.exchangesHandlerAttached = 'true';
            exchangesList.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const exchangeId = button.dataset.exchangeId;
                
                if (action === 'track-exchange' && exchangeId) {
                    trackExchange(exchangeId);
                }
            });
        }
        
        // Addresses list event delegation
        const addressesContent = document.getElementById('addressesContent');
        if (addressesContent && !addressesContent.dataset.addressesHandlerAttached) {
            addressesContent.dataset.addressesHandlerAttached = 'true';
            addressesContent.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const addressId = button.dataset.addressId;
                
                if (action === 'edit' && addressId) {
                    editAddress(addressId);
                } else if (action === 'delete' && addressId) {
                    openDeleteModal(addressId);
                }
            });
        }
        
        // Add New Address button
        const addAddressContainer = document.getElementById('addAddressContainer');
        if (addAddressContainer && !addAddressContainer.dataset.handlerAttached) {
            addAddressContainer.dataset.handlerAttached = 'true';
            addAddressContainer.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action="open-address-modal"]');
                if (button) {
                    openAddressModal();
                }
            });
        }
        
        // Address modal event delegation
        const addressModal = document.getElementById('addressModal');
        if (addressModal && !addressModal.dataset.handlerAttached) {
            addressModal.dataset.handlerAttached = 'true';
            addressModal.addEventListener('click', function(e) {
                // Close when clicking overlay
                if (e.target === this) {
                    closeAddressModal();
                    return;
                }
                
                const button = e.target.closest('button[data-action]');
                if (button && button.dataset.action === 'close-address-modal') {
                    closeAddressModal();
                }
            });
        }
        
        // Delete modal event delegation
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal && !deleteModal.dataset.handlerAttached) {
            deleteModal.dataset.handlerAttached = 'true';
            deleteModal.addEventListener('click', function(e) {
                // Close when clicking overlay
                if (e.target === this) {
                    closeDeleteModal();
                    return;
                }
                
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                if (action === 'close-delete-modal') {
                    closeDeleteModal();
                } else if (action === 'confirm-delete') {
                    confirmDeleteAddress();
                }
            });
        }
        
        // Wishlist event delegation
        const wishlistContent = document.getElementById('wishlistContent');
        if (wishlistContent && !wishlistContent.dataset.wishlistHandlerAttached) {
            wishlistContent.dataset.wishlistHandlerAttached = 'true';
            wishlistContent.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                
                if (action === 'add-to-cart') {
                    const index = parseInt(button.dataset.index, 10);
                    if (!isNaN(index)) {
                        addToCartFromWishlist(index);
                    }
                } else if (action === 'remove') {
                    const itemId = button.dataset.itemId;
                    if (itemId) {
                        removeFromWishlist(itemId);
                    }
                }
            });
        }

        // Initialize
        loadAvatar();
        checkLogin();
        
        // Check URL parameters for section
        const urlParams = new URLSearchParams(window.location.search);
        const sectionParam = urlParams.get('section');
        if (sectionParam) {
            showSection(sectionParam);
        } else {
            loadUserOrders();
        }

        // ============ MOBILE MENU FUNCTIONALITY ============

        // Mobile menu toggle
        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.querySelector('.profile-sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (!mobileMenuToggle || !sidebar || !overlay) return;

            // Toggle menu
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');

                // Change icon
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('open')) {
                    icon.className = 'ri-close-line';
                } else {
                    icon.className = 'ri-menu-line';
                }
            });

            // Close menu when clicking overlay
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
                mobileMenuToggle.querySelector('i').className = 'ri-menu-line';
            });

            // Close menu when clicking a menu item
            const menuLinks = sidebar.querySelectorAll('.sidebar-menu a');
            menuLinks.forEach(link => {
                link.addEventListener('click', function() {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                    mobileMenuToggle.querySelector('i').className = 'ri-menu-line';
                });
            });

            // Show/hide mobile menu based on screen size
            function checkScreenSize() {
                if (window.innerWidth <= 768) {
                    mobileMenuToggle.style.display = 'block';
                } else {
                    mobileMenuToggle.style.display = 'none';
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                    mobileMenuToggle.querySelector('i').className = 'ri-menu-line';
                }
            }

            // Check on load and resize
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);
        }

        // Initialize mobile bottom nav visibility and keyboard handling
        function initMobileNav() {
            const mobileNav = document.getElementById('mobileBottomNav');
            if (!mobileNav) return;
            
            function checkScreenSize() {
                if (window.innerWidth <= 768) {
                    mobileNav.style.display = 'flex';
                } else {
                    mobileNav.style.display = 'none';
                }
            }
            
            // Check on load and resize
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);

            // Handle keyboard open/close (hide bottom nav)
            const inputs = document.querySelectorAll('input, textarea, select');
            
            function handleFocus() {
                if (window.innerWidth <= 768) {
                    document.body.classList.add('keyboard-open');
                }
            }
            
            function handleBlur() {
                document.body.classList.remove('keyboard-open');
            }
            
            // Attach to existing inputs
            inputs.forEach(input => {
                input.addEventListener('focus', handleFocus);
                input.addEventListener('blur', handleBlur);
            });
            
            // Observe DOM for new inputs (dynamic content)
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) { // Element node
                                const newInputs = node.querySelectorAll ? node.querySelectorAll('input, textarea, select') : [];
                                if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA' || node.tagName === 'SELECT') {
                                    node.addEventListener('focus', handleFocus);
                                    node.addEventListener('blur', handleBlur);
                                }
                                newInputs.forEach(input => {
                                    input.addEventListener('focus', handleFocus);
                                    input.addEventListener('blur', handleBlur);
                                });
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }

        // Initialize mobile nav when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMobileMenu();
            initMobileNav();
            // Initialize biometric module
            initBiometricModule();
            
            // Check for biometric reset notification from admin
            checkBiometricResetNotification();

            // Initialize section visibility based on admin settings
            initSectionsVisibility();
        });

        // Initialize section visibility based on admin settings
        let sectionVisibility = {};

        async function initSectionsVisibility() {
            try {
                const response = await fetch('/api/settings/sections/visibility');
                const data = await response.json();
                
                if (data && data.success && data.sections) {
                    sectionVisibility = data.sections;
                    
                    // Sections to check (match with data-section attributes and admin settings keys)
                    const sectionCheckList = [
                        { key: 'giftCards', dataSection: 'giftcards' },
                        { key: 'returns', dataSection: 'returns' },
                        { key: 'exchanges', dataSection: 'exchanges' }
                    ];
                    
                    sectionCheckList.forEach(item => {
                        const isEnabled = sectionVisibility[item.key] !== false;
                        
                        if (!isEnabled) {
                            // Hide sidebar link
                            const sidebarLinks = document.querySelectorAll(`.sidebar-menu a[data-section="${item.dataSection}"]`);
                            sidebarLinks.forEach(link => {
                                const parentLi = link.closest('li');
                                if (parentLi) parentLi.style.display = 'none';
                            });

                            // Hide mobile menu items
                            const mobileLinks = document.querySelectorAll(`[data-section="${item.dataSection}"]`);
                            mobileLinks.forEach(link => {
                                if (link.classList.contains('more-menu-item') || link.classList.contains('nav-item')) {
                                    link.style.display = 'none';
                                }
                            });

                            // If user is currently on a disabled section, redirect to profile
                            const currentUrl = new URLSearchParams(window.location.search);
                            if (currentUrl.get('section') === item.dataSection) {
                                showSection('profile');
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing section visibility:', error);
            }
        }
        
        // Check and display biometric reset notification
        function checkBiometricResetNotification() {
            try {
                const notificationData = sessionStorage.getItem('biometricResetNotification');
                if (notificationData) {
                    const notification = JSON.parse(notificationData);
                    // Clear the notification from storage
                    sessionStorage.removeItem('biometricResetNotification');
                    
                    // Show a prominent notification to the user
                    if (notification.type === 'biometric_reset') {
                        // Use the existing showSuccessPopup or showToast
                        setTimeout(() => {
                            if (window.showToast) {
                                window.showToast(
                                    'Biometric Reset: ' + notification.message,
                                    'warning',
                                    10000
                                );
                            } else {
                                showSuccessPopup('Biometric Reset', notification.message);
                            }
                            
                            // Navigate to biometric section
                            setTimeout(() => {
                                const biometricLink = document.querySelector('[data-section="biometric"]');
                                if (biometricLink) {
                                    biometricLink.click();
                                }
                            }, 1000);
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Error checking biometric reset notification:', error);
            }
        }
    </script>

    <!--  NEXT-GENERATION ADVANCED SYSTEMS -->
    <!-- Real-time & Communication -->
    <script src="assets/js/realtime-manager.js"></script>

    <!-- Security & Error Tracking -->
    <script src="assets/js/security-manager.js"></script>
    <script src="assets/js/error-tracker.js"></script>

    <!-- Machine Learning & Personalization -->
    <script src="assets/js/ml-engine.js"></script>

    <!-- User Experience -->
    <script src="assets/js/form-manager.js"></script>
    <script src="assets/js/i18n-manager.js"></script>

    <script src="assets/js/advanced-cache.js"></script>
    <script src="assets/js/state-manager.js"></script>
    
    <!--  WORLD-FIRST CUTTING-EDGE TECHNOLOGIES -->
    <!-- AI & Biometrics -->
    <script src="assets/js/biometric-auth.js"></script>
    
    <!-- security.js already loaded in head -->
    <script src="assets/js/console-block.js"></script>
    <script src="assets/js/auto-debugger.js"></script>
    <script src="assets/js/ai-analytics.js"></script>
    <script src="assets/js/analytics.js"></script>
    <script src="assets/js/main.js"></script>
</body>
</html>

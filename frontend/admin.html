<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BLACKONN Admin Dashboard</title>
    <link rel="shortcut icon" href="assets/img/favicon.png" type="image/x-icon" />

    <!-- High-Priority Resource Hints -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.min.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background: #eef3f8;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
      }
      .admin-header {
        background: #fff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      }
      .admin-header .nav-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 5%;
        max-width: 1800px;
        margin: 0 auto;
      }
      .admin-header .nav-logo img {
        width: 130px;
        height: 38px;
        object-fit: contain;
      }
      .admin-header .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .admin-header .header-actions .logout-btn {
        background: #fee2e2;
        color: #dc2626;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }
      .admin-header .header-actions .logout-btn:hover {
        background: #fecaca;
      }
      .admin-header .header-actions .view-store-btn {
        background: #f1f5f9;
        color: #475569;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }
      .admin-header .header-actions .view-store-btn:hover {
        background: #e2e8f0;
        color: #0f172a;
      }
      .admin-header nav {
        display: none;
      }
      
      /* ========================================
         NEW PROFILE-STYLE SIDEBAR LAYOUT
         ======================================== */
      .admin-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
        max-width: 1800px;
        margin: 32px auto 80px;
        padding: 0 5%;
        min-height: calc(100vh - 150px);
      }
      
      /* Hide old floating nav */
      .admin-side-nav {
        display: none !important;
      }
      
      /* New Sidebar Styles */
      .admin-sidebar {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 90px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }
      
      .admin-sidebar::-webkit-scrollbar {
        width: 4px;
      }
      
      .admin-sidebar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      
      .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .sidebar-menu-group {
        margin-bottom: 16px;
      }
      
      .sidebar-menu-group:last-child {
        margin-bottom: 0;
      }
      
      .sidebar-group-title {
        font-size: 0.7rem;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 14px 6px;
        margin-bottom: 4px;
      }
      
      .sidebar-menu li {
        margin-bottom: 2px;
      }
      
      .sidebar-menu a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        color: #475569;
        text-decoration: none;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }
      
      .sidebar-menu a:hover {
        background: #f1f5f9 !important;
        color: #0f172a !important;
        transform: translateX(6px);
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      }
      
      .sidebar-menu a.active {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
      }
      
      .sidebar-menu a.active:hover {
        background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
        color: #fff !important;
        transform: translateX(6px);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.35);
      }
      
      .sidebar-menu a i {
        font-size: 1.15rem;
        width: 22px;
        text-align: center;
        flex-shrink: 0;
      }
      
      .sidebar-menu a .menu-text {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .sidebar-menu a .badge {
        background: #ef4444;
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
      }
      
      /* Admin Main Content */
      .admin-main {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.08);
        padding: 30px;
        min-height: 500px;
      }
      
      /* Section visibility - only show active section */
      .admin-section {
        display: none;
      }
      
      .admin-section.active {
        display: block;
      }
      
      /* Smooth Hover Effects */
      .insight-card, .stat-card {
        transition: all 0.3s ease !important;
      }
      
      .insight-card:hover, .stat-card:hover {
        transform: translateY(-5px) scale(1.02) !important;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12) !important;
      }

      /* Mobile Responsive */
      @media (max-width: 1024px) {
        .admin-layout {
          grid-template-columns: 240px 1fr;
          gap: 20px;
        }
        
        .admin-sidebar {
          padding: 16px;
        }
        
        .sidebar-menu a {
          padding: 10px 12px;
          font-size: 0.85rem;
        }
      }
      
      @media (max-width: 768px) {
        .admin-layout {
          grid-template-columns: 1fr;
          gap: 0;
          padding: 0 4%;
          margin-top: 20px;
        }
        
        /* Hide desktop sidebar on mobile */
        .admin-sidebar {
          display: none;
        }
        
        .admin-main {
          padding: 20px;
          border-radius: 16px;
          margin-bottom: 100px;
        }
      }
      
      /* Mobile Floating Menu */
      .mobile-fab {
        display: none;
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 10001;
      }
      
      .mobile-fab-btn {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
      }
      
      .mobile-fab-btn:hover {
        transform: scale(1.05);
      }
      
      .mobile-fab-btn.active {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: rotate(0deg);
      }
      
      .mobile-fab-btn i {
        transition: transform 0.3s ease;
      }
      
      /* Toggle icons when FAB is active */
      .mobile-fab-btn.active .fab-icon-open {
        display: none !important;
      }
      
      .mobile-fab-btn.active .fab-icon-close {
        display: block !important;
      }
      
      /* Floating Quick Menu */
      .mobile-quick-menu {
        position: absolute;
        bottom: 70px;
        right: 0;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        padding: 12px;
        width: 280px;
        max-height: 70vh;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px) scale(0.95);
        transition: all 0.3s ease;
        z-index: 1;
      }
      
      .mobile-quick-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }
      
      .mobile-quick-menu::-webkit-scrollbar {
        width: 4px;
      }
      
      .mobile-quick-menu::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      
      .mobile-menu-group {
        margin-bottom: 8px;
      }
      
      .mobile-menu-group:last-child {
        margin-bottom: 0;
      }
      
      .mobile-menu-group-title {
        font-size: 0.65rem;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 6px 10px 4px;
      }
      
      .mobile-menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        color: #475569;
        text-decoration: none;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
      }
      
      .mobile-menu-item:hover {
        background: #f1f5f9;
        color: #0f172a;
      }
      
      .mobile-menu-item.active {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
      }
      
      .mobile-menu-item i {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
      }
      
      /* Mobile menu overlay */
      .mobile-menu-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 10000;
        backdrop-filter: blur(2px);
      }
      
      .mobile-menu-overlay.active {
        display: block;
      }
      
      /* ========================================
         BACK TO TOP BUTTON
         ======================================== */
      .back-to-top {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 9999;
      }
      
      .back-to-top.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      
      .back-to-top:hover {
        background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.35);
      }
      
      .back-to-top:active {
        transform: translateY(0);
      }
      
      /* Mobile adjustments for back to top */
      @media (max-width: 768px) {
        .back-to-top {
          bottom: 100px;
          right: 20px;
          width: 44px;
          height: 44px;
          font-size: 1.2rem;
        }
      }
      
      /* When mobile FAB is open, hide back to top */
      .mobile-quick-menu.open ~ .back-to-top,
      .mobile-menu-overlay.active ~ .back-to-top {
        opacity: 0;
        visibility: hidden;
      }
      
      /* Show mobile FAB on smaller screens */
      @media (max-width: 768px) {
        .mobile-fab {
          display: block;
        }
      }
      
      /* Legacy admin-page class - hide it */
      .admin-page {
        display: none;
      }
      /* Dropdown for Management sections */
      .nav-dropdown {
        position: relative;
      }
      .nav-dropdown-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #374151;
        font-weight: 500;
        font-size: 0.82rem;
        padding: 6px 10px;
        border-radius: 6px;
        transition: all 0.2s ease;
        background: none;
        border: none;
        font-family: inherit;
      }
      .nav-dropdown-toggle:hover {
        background: #f3f4f6;
        color: #0f172a;
      }
      .nav-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        min-width: 180px;
        padding: 8px 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease;
        z-index: 1000;
        border: 1px solid rgba(0,0,0,0.08);
      }
      .nav-dropdown:hover .nav-dropdown-menu,
      .nav-dropdown.active .nav-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(4px);
      }
      .nav-dropdown-menu a {
        display: flex !important;
        align-items: center;
        gap: 10px;
        padding: 10px 16px !important;
        color: #374151;
        font-size: 0.85rem;
        border-radius: 0 !important;
      }
      .nav-dropdown-menu a:hover {
        background: #f8fafc;
      }
      .nav-dropdown-menu a i {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
      }
      .nav-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 6px 0;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }
      .section-header-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .section-header-right {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .section-header h2 {
        margin: 0;
        font-size: 1.35rem;
        font-weight: 600;
        color: #0f172a;
      }
      .section-header small {
        color: #6b7280;
        font-size: 0.85rem;
      }
      /* ========================================
         PERFORMANCE INSIGHTS - STAT CARDS
         ======================================== */
      .insights-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 12px;
      }
      .insight-card {
        flex: 1 1 220px;
        min-width: 200px;
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 14px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
        border: 1px solid #e5e7eb;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
      }
      .insight-card:hover {
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
        transform: translateY(-2px);
      }
      .insight-card.highlight {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border: none;
      }
      .insight-card.highlight .insight-label { color: rgba(255,255,255,0.7); }
      .insight-card.highlight .insight-value { color: #fff; }
      .insight-card.highlight .insight-icon { background: rgba(255,255,255,0.15); color: #fff; }
      
      .insight-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      .insight-icon.success { background: #d1fae5; color: #059669; }
      .insight-icon.warning { background: #fef3c7; color: #d97706; }
      .insight-icon.danger { background: #fee2e2; color: #dc2626; }
      .insight-icon.primary { background: #e0e7ff; color: #4f46e5; }
      .insight-icon.info { background: #dbeafe; color: #2563eb; }
      .insight-icon.muted { background: #f3f4f6; color: #6b7280; }
      
      .insight-content {
        flex: 1;
        min-width: 0;
      }
      .insight-label {
        display: block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #6b7280;
        margin-bottom: 2px;
      }
      .insight-value {
        font-size: 1.35rem;
        font-weight: 700;
        color: #0f172a;
        line-height: 1.2;
      }
      
      /* Border accent colors */
      .insight-card.border-success { border-left: 3px solid #10b981; }
      .insight-card.border-warning { border-left: 3px solid #f59e0b; }
      .insight-card.border-danger { border-left: 3px solid #ef4444; }
      .insight-card.border-primary { border-left: 3px solid #6366f1; }
      .insight-card.border-info { border-left: 3px solid #3b82f6; }
      .insight-card.border-muted { border-left: 3px solid #9ca3af; }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .insights-grid {
          gap: 12px;
        }
        .insight-card {
          flex: 1 1 calc(50% - 8px);
          max-width: none;
          padding: 14px 16px;
        }
        .insight-icon {
          width: 38px;
          height: 38px;
          font-size: 1.1rem;
        }
        .insight-value {
          font-size: 1.15rem;
        }
      }
      @media (max-width: 480px) {
        .insight-card {
          flex: 1 1 100%;
        }
      }
      
      /* ========================================
         GENERIC STAT CARDS (for other sections)
         ======================================== */
      .stats-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
      }
      .stat-card {
        flex: 1 1 180px;
        max-width: 250px;
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
        border: 1px solid #e5e7eb;
      }
      .stat-icon-wrapper {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }
      .stat-icon-wrapper.success { background: #d1fae5; color: #059669; }
      .stat-icon-wrapper.warning { background: #fef3c7; color: #d97706; }
      .stat-icon-wrapper.danger { background: #fee2e2; color: #dc2626; }
      .stat-icon-wrapper.primary { background: #e0e7ff; color: #4f46e5; }
      .stat-icon-wrapper.info { background: #dbeafe; color: #2563eb; }
      .stat-icon-wrapper.muted { background: #f3f4f6; color: #6b7280; }
      .stat-content {
        flex: 1;
        min-width: 0;
      }
      .stat-content small {
        display: block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #6b7280;
        margin-bottom: 2px;
      }
      .stat-content strong {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0f172a;
      }
      
      /* Responsive grid for feature cards (authenticators, recommendations, etc.) */
      .responsive-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      @media (max-width: 480px) {
        .responsive-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (max-width: 360px) {
        .responsive-grid {
          grid-template-columns: 1fr;
        }
      }

      .admin-panel {
        background: #fff;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.04);
      }
      .admin-panel form {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f9fafb;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
      }
      .admin-panel label {
        display: flex;
        flex-direction: column;
        font-size: 0.8rem;
        font-weight: 600;
        gap: 6px;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .admin-panel input,
      .admin-panel select,
      .admin-panel textarea {
        font-size: 0.95rem;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1.5px solid #e5e7eb;
        background: #fff;
        transition: all 0.2s ease;
        font-weight: 400;
        color: #1f2937;
      }
      .admin-panel input:focus,
      .admin-panel select:focus,
      .admin-panel textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }
      .admin-panel input::placeholder {
        color: #9ca3af;
      }
      .admin-panel .form-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        padding-top: 8px;
        border-top: 1px solid #e5e7eb;
        margin-top: 8px;
      }
      .admin-panel button {
        font-size: 0.9rem;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }
      .admin-panel button.primary {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
      }
      .admin-panel button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.35);
      }
      .admin-panel button.secondary {
        background: #fff;
        border: 1.5px solid #d1d5db;
        color: #374151;
      }
      .admin-panel button.secondary:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
      }
      .admin-panel button.danger {
        background: #dc2626;
        color: #fff;
      }
      .admin-panel button.danger:hover {
        background: #b91c1c;
      }
      .admin-panel button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      /* Mobile Responsive Styles for Advanced Systems */
      @media (max-width: 768px) {
        .insights-grid {
          gap: 12px !important;
        }
        
        .insight-card {
          flex: 1 1 150px !important;
          max-width: none !important;
          padding: 12px !important;
        }
        
        .insight-label {
          font-size: 0.65rem !important;
        }
        
        .insight-value {
          font-size: 1.1rem !important;
        }
        
        .section-header {
          flex-direction: column !important;
          align-items: flex-start !important;
          gap: 12px !important;
        }
        
        .section-header-right {
          width: 100%;
          display: flex;
          flex-wrap: wrap;
          gap: 8px !important;
        }
        
        .section-header-right button {
          flex: 1;
          min-width: 120px;
          font-size: 0.85rem !important;
          padding: 10px 16px !important;
        }
        
        .admin-panel .panel-body {
          padding: 16px !important;
        }
        
        .table-wrapper {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
          min-width: 600px;
        }
        
        .toggle-switch-label {
          font-size: 0.85rem !important;
        }
        
        /* Insight icon size reduction */
        .insight-icon {
          width: 36px !important;
          height: 36px !important;
          font-size: 1rem !important;
        }
        
        /* Products table fix for mobile */
        #products .table-wrapper, 
        #product-costs .table-wrapper,
        #product-costs .table-container,
        #sku-management .table-wrapper, 
        #inventory-management .table-wrapper, 
        #error-tracker .table-wrapper,
        #gift-cards .table-wrapper,
        #marketing-management .table-wrapper,
        #company-tax .table-wrapper,
        #messages .table-responsive {
          margin: 0 -16px !important;
          padding: 0 16px !important;
          width: calc(100% + 32px) !important;
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch !important;
        }
        
        /* Contact messages grid/list fix */
        #messages .message-card {
          width: 100% !important;
          margin-bottom: 12px !important;
        }
        
        /* Biometric user list row fix */
        #biometricUsersList > div {
          flex-direction: column !important;
          align-items: stretch !important;
          gap: 16px !important;
          padding: 20px !important;
        }
        
        #biometricUsersList .biometric-actions {
          justify-content: space-between !important;
        }
        
        #biometricUsersList .biometric-actions button {
          flex: 1 !important;
          justify-content: center !important;
        }
      }
      
      @media (max-width: 480px) {
        .insights-grid {
          flex-direction: column !important;
        }
        
        .insight-card {
          flex: 1 1 100% !important;
        }
      }

      /* ========================================
         MOBILE RESPONSIVE - ALL SECTIONS VISIBLE
         Like Performance Optimizer section
         ======================================== */
      @media (max-width: 768px) {
        /* Global mobile fix - prevent all horizontal overflow */
        .admin-section,
        .admin-section .panel-body,
        .admin-section .panel-header {
          max-width: 100% !important;
          overflow-x: hidden !important;
          box-sizing: border-box !important;
        }
        
        /* Panel body proper padding */
        .admin-section .panel-body {
          padding: 16px !important;
        }
        
        /* Stats grid & Summary Grids - 2 columns on tablet, stacks nicely */
        .stats-grid, 
        #product-costs .default-costs-grid,
        #tax-settings .tax-grid,
        #gift-cards .stats-grid,
        #inventory-management .stats-grid,
        #sku-management .stats-grid,
        #marketing-management .stats-grid,
        #error-tracker .stats-grid,
        #biometric-auth .stats-grid,
        #messages .message-card-grid,
        .product-costs-container {
          display: grid !important;
          grid-template-columns: repeat(2, 1fr) !important;
          gap: 12px !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Product costs container - single column on mobile */
        .product-costs-container {
          grid-template-columns: 1fr !important;
        }
        
        /* Sales summary cards full width */
        .sales-summary-card {
          grid-column: 1 / -1 !important;
          min-width: 0 !important;
          width: 100% !important;
        }
        
        .stat-card, 
        .summary-item,
        .cost-input-group,
        .tax-input-group {
          max-width: none !important;
          min-width: 0 !important;
          padding: 14px !important;
          flex: none !important;
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Responsive grid for authenticators, features etc */
        .responsive-grid {
          grid-template-columns: repeat(2, 1fr) !important;
          gap: 10px !important;
        }
        
        .responsive-grid > div {
          min-width: 0 !important;
          padding: 12px !important;
        }
        
        .stat-card .stat-content strong {
          font-size: 1.1rem !important;
        }
        
        .stat-card .stat-content small {
          font-size: 0.65rem !important;
        }
        
        .stat-icon-wrapper {
          width: 38px !important;
          height: 38px !important;
          font-size: 1rem !important;
        }
        
        /* Marketing & Shipping tabs - scrollable on mobile */
        .marketing-tabs, .shipping-tabs {
          display: flex !important;
          overflow-x: auto !important;
          gap: 8px !important;
          padding-bottom: 8px !important;
          -webkit-overflow-scrolling: touch !important;
          border-bottom: 1px solid #e2e8f0;
        }
        
        .marketing-tabs .tab-btn, .shipping-tabs .tab-btn {
          flex: 0 0 auto !important;
          font-size: 0.75rem !important;
          padding: 10px 12px !important;
          white-space: nowrap !important;
        }
        
        /* Form inputs full width on mobile */
        .admin-section form label,
        .admin-section .slide-form-group,
        .admin-section .input-group {
          display: flex !important;
          flex-direction: column !important;
          width: 100% !important;
        }
        
        .admin-section form input,
        .admin-section form select,
        .admin-section form textarea {
          width: 100% !important;
          max-width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Section header on mobile - all sections */
        .section-header {
          flex-direction: column !important;
          align-items: stretch !important;
          gap: 12px !important;
          padding: 16px !important;
        }
        
        .section-header-right {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 8px !important;
          width: 100% !important;
        }
        
        .section-header-right button,
        .section-header-right .toggle-switch-label {
          flex: 1 1 auto !important;
          min-width: 130px !important;
          font-size: 0.8rem !important;
          padding: 8px 12px !important;
        }
        
        /* Tables - allow horizontal scroll but keep visible */
        .table-wrapper, .table-container {
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch !important;
          margin: 0 -16px !important;
          padding: 0 16px !important;
          width: calc(100% + 32px) !important;
        }
        
        /* Modal responsiveness */
        .modal-content {
          width: 95% !important;
          max-width: 100% !important;
          margin: 10px !important;
          max-height: 90vh !important;
          overflow-y: auto !important;
          padding: 16px !important;
        }
        
        .modal-actions {
          flex-direction: column !important;
          gap: 8px !important;
        }
        
        .modal-actions button {
          width: 100% !important;
          margin: 0 !important;
        }

        /* Biometric actions on mobile */
        .biometric-actions {
          flex-direction: column !important;
          gap: 8px !important;
        }
        
        .biometric-actions button {
          width: 100% !important;
          margin: 0 !important;
        }
        
        /* ========================================
           ENHANCED MOBILE RESPONSIVE - ALL SECTIONS
           Override inline styles with !important
           ======================================== */
        
        /* GLOBAL: Override ALL inline grid styles on mobile */
        [style*="grid-template-columns: repeat(auto-fit, minmax"] {
          grid-template-columns: 1fr !important;
        }
        
        [style*="grid-template-columns: repeat(auto-fit"] {
          grid-template-columns: 1fr !important;
        }
        
        /* Override inline flex containers */
        [style*="display: flex"][style*="gap: 16px"] {
          flex-wrap: wrap !important;
        }
        
        /* Make all form elements full width */
        .admin-section form[style*="display: grid"] {
          display: block !important;
        }
        
        .admin-section form[style*="display: grid"] > * {
          width: 100% !important;
          margin-bottom: 12px !important;
        }
        
        /* Section headers stack vertically */
        .admin-section .section-header {
          flex-direction: column !important;
          align-items: stretch !important;
          gap: 12px !important;
        }
        
        .admin-section .section-header-left,
        .admin-section .section-header-right {
          width: 100% !important;
        }
        
        .admin-section .section-header-right {
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 8px !important;
        }
        
        .admin-section .section-header-right > * {
          flex: 1 1 calc(50% - 4px) !important;
          min-width: 100px !important;
        }
        
        /* Stats grid - 2 columns max */
        .admin-section .stats-grid {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px !important;
        }
        
        .admin-section .stats-grid .stat-card {
          min-width: 0 !important;
          padding: 12px !important;
        }
        
        /* Product Cost Settings - Full width on mobile */
        #product-costs .product-costs-container,
        #product-costs [style*="display: grid"] {
          display: block !important;
          width: 100% !important;
        }
        
        #product-costs .default-costs-grid,
        #product-costs [class*="costs-grid"] {
          display: block !important;
          width: 100% !important;
        }
        
        #product-costs .sales-summary-card,
        #product-costs [class*="summary-card"] {
          width: 100% !important;
          margin-bottom: 16px !important;
          box-sizing: border-box !important;
        }
        #product-costs .default-costs-grid {
          display: block !important;
          width: 100% !important;
        }
        
        #product-costs .sales-summary-card {
          width: 100% !important;
          margin-bottom: 16px !important;
          box-sizing: border-box !important;
        }
        
        #product-costs .cost-input-group {
          width: 100% !important;
          margin-bottom: 12px !important;
        }
        
        #product-costs .input-with-prefix {
          width: 100% !important;
        }
        
        #product-costs .input-with-prefix input {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Contact Messages - Full width cards */
        #messages .search-container {
          width: 100% !important;
        }
        
        #messages .search-input-wrapper {
          width: 100% !important;
        }
        
        #messages .search-input {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        #messages table {
          font-size: 12px !important;
        }
        
        #messages th, #messages td {
          padding: 8px 6px !important;
          white-space: nowrap !important;
        }
        
        /* SKU & Barcode Management */
        #sku-management .panel-body {
          padding: 12px !important;
        }
        
        #sku-management .stats-grid {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px !important;
        }
        
        #sku-management .table-wrapper {
          margin: 0 -12px !important;
          padding: 0 12px !important;
          width: calc(100% + 24px) !important;
        }
        
        /* Inventory & Stock Management */
        #inventory-management .stats-grid {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px !important;
        }
        
        #inventory-management .section-header {
          flex-direction: column !important;
          gap: 12px !important;
        }
        
        #inventory-management .section-header-right {
          width: 100% !important;
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 8px !important;
        }
        
        #inventory-management .section-header-right button,
        #inventory-management .section-header-right select {
          flex: 1 1 calc(50% - 4px) !important;
          min-width: 100px !important;
        }
        
        /* Marketing & Promotions */
        #marketing-management .marketing-tabs {
          display: flex !important;
          overflow-x: auto !important;
          flex-wrap: nowrap !important;
          gap: 6px !important;
          padding-bottom: 10px !important;
          -webkit-overflow-scrolling: touch !important;
        }
        
        #marketing-management .marketing-tabs .tab-btn {
          flex: 0 0 auto !important;
          white-space: nowrap !important;
          padding: 8px 12px !important;
          font-size: 12px !important;
        }
        
        #marketing-management .stats-grid {
          grid-template-columns: 1fr 1fr !important;
        }
        
        #marketing-management form {
          width: 100% !important;
        }
        
        #marketing-management form input,
        #marketing-management form select,
        #marketing-management form textarea {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Company Tax Section */
        #company-tax .panel-body {
          padding: 12px !important;
        }
        
        #company-tax .stats-grid,
        #company-tax .tax-summary-grid {
          grid-template-columns: 1fr !important;
          gap: 12px !important;
        }
        
        #company-tax .deadline-card,
        #company-tax .tax-card {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        #company-tax [style*="display: flex"] {
          flex-wrap: wrap !important;
        }
        
        #company-tax input,
        #company-tax select {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* Gift Cards Management */
        #gift-cards .stats-grid {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px !important;
        }
        
        #gift-cards .section-header {
          flex-direction: column !important;
          gap: 12px !important;
        }
        
        #gift-cards .section-header-right {
          width: 100% !important;
          display: flex !important;
          flex-wrap: wrap !important;
          gap: 8px !important;
        }
        
        #gift-cards .section-header-right button {
          flex: 1 1 calc(50% - 4px) !important;
        }
        
        #gift-cards .table-wrapper {
          margin: 0 -12px !important;
          padding: 0 12px !important;
        }
        
        /* Error Tracker Section */
        #error-tracker .stats-grid {
          grid-template-columns: 1fr 1fr !important;
          gap: 10px !important;
        }
        
        #error-tracker .error-list,
        #error-tracker .error-card {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        #error-tracker .error-card {
          padding: 12px !important;
          margin-bottom: 10px !important;
        }
        
        #error-tracker .error-header {
          flex-direction: column !important;
          gap: 8px !important;
          align-items: flex-start !important;
        }
        
        #error-tracker .error-meta {
          flex-wrap: wrap !important;
          gap: 6px !important;
        }
        
        #error-tracker pre,
        #error-tracker code {
          max-width: 100% !important;
          overflow-x: auto !important;
          font-size: 11px !important;
          white-space: pre-wrap !important;
          word-break: break-all !important;
        }
        
        /* Shipping Settings Form */
        #shippingSettingsForm,
        #taxSettingsForm,
        #invoiceSettingsForm,
        #giftCardForm {
          display: block !important;
          width: 100% !important;
          padding: 16px !important;
          box-sizing: border-box !important;
        }
        
        #shippingSettingsForm > div,
        #taxSettingsForm > div,
        #invoiceSettingsForm > div,
        #giftCardForm > div {
          width: 100% !important;
          margin-bottom: 12px !important;
        }
        
        #shippingSettingsForm input,
        #shippingSettingsForm select,
        #shippingSettingsForm textarea,
        #taxSettingsForm input,
        #taxSettingsForm select,
        #taxSettingsForm textarea,
        #invoiceSettingsForm input,
        #invoiceSettingsForm select,
        #invoiceSettingsForm textarea,
        #giftCardForm input,
        #giftCardForm select,
        #giftCardForm textarea {
          width: 100% !important;
          box-sizing: border-box !important;
        }
        
        /* AI Engines Grid */
        .ai-engines-grid,
        .payment-ai-stats {
          display: block !important;
          width: 100% !important;
        }
        
        .ai-engines-grid > *,
        .payment-ai-stats > * {
          width: 100% !important;
          margin-bottom: 12px !important;
        }
        
        /* Table responsive - horizontal scroll */
        .admin-section .table-wrapper,
        .admin-section table {
          display: block !important;
          width: 100% !important;
          overflow-x: auto !important;
          -webkit-overflow-scrolling: touch !important;
        }
        
        .admin-section table {
          min-width: 600px !important;
        }
        
        /* Panel body padding on mobile */
        .admin-section .panel-body {
          padding: 12px !important;
        }
      }
      
      @media (max-width: 480px) {
        /* Stats grid - single column on small phones */
        .stats-grid, 
        #product-costs .default-costs-grid,
        #tax-settings .tax-grid,
        .product-costs-container {
          grid-template-columns: 1fr !important;
        }
        
        .insights-grid {
          flex-direction: column !important;
          grid-template-columns: 1fr !important;
        }
        
        /* Default costs grid */
        .default-costs-grid {
          grid-template-columns: 1fr !important;
        }
        
        /* Company tax deadline cards */
        #company-tax [style*="display: flex"][style*="gap: 16px"][style*="padding: 16px"] {
          flex-direction: column !important;
          gap: 8px !important;
        }
        
        #company-tax [style*="min-width: 100px"] {
          min-width: auto !important;
          text-align: left !important;
        }
        
        /* Multi-select - 2 columns on very small screens */
        .multi-select-group {
          grid-template-columns: repeat(2, 1fr) !important;
        }
        
        /* Marketing tabs - horizontal scroll on small screens */
        .marketing-tabs {
          display: flex !important;
          flex-wrap: nowrap !important;
          overflow-x: auto !important;
          gap: 8px !important;
        }
        
        .marketing-tabs .tab-btn {
          flex-shrink: 0 !important;
          white-space: nowrap !important;
        }
        
        /* Responsive grid - single column */
        .responsive-grid {
          grid-template-columns: repeat(2, 1fr) !important;
        }
        
        /* Biometric user search */
        #biometricUserSearch {
          max-width: 100% !important;
          width: 100% !important;
        }
        
        /* Gift cards, company tax inline flex items */
        #gift-cards [style*="display: flex"],
        #company-tax [style*="display: flex"] {
          flex-wrap: wrap !important;
        }
        
        /* Product costs inline styles fix */
        #product-costs [style*="display: grid"][style*="minmax(300px"] {
          grid-template-columns: 1fr !important;
        }
      }

      /* Modal Button Styles */
      button.primary {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
      }

      button.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.35);
      }

      button.secondary {
        background: #fff;
        border: 1.5px solid #d1d5db;
        color: #374151;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      button.secondary:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
      }

      button.delete-btn {
        background: #fee2e2;
        border: 1.5px solid #fecaca;
        color: #dc2626;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      button.delete-btn:hover {
        background: #fecaca;
        border-color: #f87171;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
      }

      button.delete-btn i {
        font-size: 1rem;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 20px;
      }

      /* Traffic Analytics Section */
      .traffic-section {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .traffic-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }
      .traffic-stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        border: 1px solid #e2e8f0;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .traffic-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
      }
      .traffic-stat-card.highlight {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        border: none;
      }
      .traffic-stat-card.highlight .stat-label {
        color: rgba(255,255,255,0.7);
      }
      .traffic-stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
      }
      .traffic-stat-card .stat-label {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 500;
      }
      .traffic-stat-card .stat-change {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .traffic-stat-card .stat-change.up {
        color: #10b981;
      }
      .traffic-stat-card .stat-change.down {
        color: #ef4444;
      }
      .traffic-chart-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
      }
      .traffic-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .traffic-chart-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #374151;
      }
      .chart-period-selector {
        display: flex;
        gap: 8px;
      }
      .chart-period-selector button {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        background: #fff;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chart-period-selector button.active {
        background: #0f172a;
        color: #fff;
        border-color: #0f172a;
      }
      .traffic-chart {
        height: 200px;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        padding: 10px 0;
      }
      .chart-bar {
        flex: 1;
        background: linear-gradient(to top, #8b5cf6, #a78bfa, #c4b5fd);
        border-radius: 4px 4px 0 0;
        min-height: 4px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chart-bar:hover {
        background: linear-gradient(to top, #7c3aed, #8b5cf6, #a78bfa);
        transform: scaleY(1.05);
      }
      .chart-bar::after {
        content: attr(data-visits);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        color: #64748b;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .chart-bar:hover::after {
        opacity: 1;
      }
      .chart-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 0.7rem;
        color: #94a3b8;
      }
      .traffic-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .traffic-detail-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
      }
      .traffic-detail-card h4 {
        margin: 0 0 16px 0;
        font-size: 0.95rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .traffic-detail-card h4 i {
        color: #3b82f6;
      }
      .detail-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .detail-item:last-child {
        border-bottom: none;
      }
      .detail-item .label {
        font-size: 0.85rem;
        color: #475569;
      }
      .detail-item .value {
        font-weight: 600;
        color: #0f172a;
      }
      .detail-item .bar-wrapper {
        flex: 1;
        margin: 0 12px;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
      }
      .detail-item .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d);
        border-radius: 3px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 4px rgba(245, 158, 11, 0.3);
      }
      .detail-item:hover .bar-fill {
        background: linear-gradient(90deg, #d97706, #f59e0b, #fbbf24);
        box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
      }
      .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #ecfdf5;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #059669;
      }
      .realtime-indicator .pulse {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
      }

      /* Sales Insights Section */
      .sales-section {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .sales-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .sales-stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        border: 1px solid #e2e8f0;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .sales-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
      }
      .sales-stat-card.highlight {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        color: #fff;
        border: none;
      }
      .sales-stat-card.highlight .stat-label {
        color: rgba(255,255,255,0.8);
      }
      .sales-stat-card.highlight .stat-value {
        color: #fff;
      }
      .sales-stat-card.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        color: #fff;
        border: none;
      }
      .sales-stat-card.warning .stat-label {
        color: rgba(255,255,255,0.9);
      }
      .sales-stat-card .stat-value {
        font-size: 1.6rem;
        font-weight: 700;
        color: #0f172a;
      }
      .sales-stat-card .stat-label {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .sales-stat-card .stat-change {
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 4px;
      }
      .sales-stat-card .stat-change.up {
        color: #059669;
      }
      .sales-stat-card .stat-change.down {
        color: #dc2626;
      }
      .sales-charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
      }
      @media (max-width: 900px) {
        .sales-charts-row {
          grid-template-columns: 1fr;
        }
      }
      .sales-chart-container {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
      }
      .sales-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .sales-chart-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sales-chart-header h3 i {
        color: #059669;
      }
      .sales-period-selector {
        display: flex;
        gap: 4px;
        background: #e2e8f0;
        padding: 3px;
        border-radius: 8px;
      }
      .sales-period-selector button {
        padding: 6px 12px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        color: #64748b;
        transition: all 0.2s ease;
      }
      .sales-period-selector button.active {
        background: #fff;
        color: #0f172a;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .sales-bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 8px;
        height: 200px;
        padding: 0 8px;
      }
      .sales-bar-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        max-width: 50px;
      }
      .sales-bar {
        width: 100%;
        min-height: 4px;
        background: linear-gradient(180deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
        border-radius: 4px 4px 0 0;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }
      .sales-bar:hover {
        transform: scaleX(1.08) scaleY(1.02);
        background: linear-gradient(180deg, #059669 0%, #10b981 50%, #34d399 100%);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }
      .sales-bar::after {
        content: attr(data-value);
        position: absolute;
        top: -24px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7rem;
        font-weight: 600;
        color: #374151;
        opacity: 0;
        transition: opacity 0.2s ease;
        white-space: nowrap;
      }
      .sales-bar:hover::after {
        opacity: 1;
      }
      .sales-bar-label {
        font-size: 0.65rem;
        color: #94a3b8;
        text-align: center;
      }
      .top-products-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .top-product-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #fff;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .top-product-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      }
      .top-product-rank {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
      }
      .top-product-rank.gold {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        color: #fff;
      }
      .top-product-rank.silver {
        background: linear-gradient(135deg, #94a3b8, #cbd5e1);
        color: #fff;
      }
      .top-product-rank.bronze {
        background: linear-gradient(135deg, #c2410c, #ea580c);
        color: #fff;
      }
      .top-product-rank.default {
        background: #f1f5f9;
        color: #64748b;
      }
      .top-product-info {
        flex: 1;
        min-width: 0;
      }
      .top-product-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.9rem;
      }
      .top-product-stats {
        display: flex;
        gap: 12px;
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 2px;
      }
      .top-product-stats span {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .top-product-revenue {
        font-weight: 700;
        color: #059669;
        font-size: 0.9rem;
      }
      .sales-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .sales-summary-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
      }
      .sales-summary-card h4 {
        margin: 0 0 16px 0;
        font-size: 0.95rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sales-summary-card h4 i {
        color: #059669;
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .summary-item:last-child {
        border-bottom: none;
      }
      .summary-item .label {
        font-size: 0.85rem;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .summary-item .label i {
        font-size: 1rem;
      }
      .summary-item .value {
        font-weight: 600;
        color: #0f172a;
      }
      .summary-item .value.success {
        color: #059669;
      }
      .summary-item .value.warning {
        color: #f59e0b;
      }
      .summary-item .value.danger {
        color: #dc2626;
      }

      /* Search and Filters */
      .search-container {
        position: relative;
        display: flex;
        align-items: center;
      }
      .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 300px;
      }
      .search-input-wrapper .search-input {
        width: 100%;
        padding: 8px 40px 8px 36px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }
      .search-input-wrapper .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .search-input-wrapper .search-icon {
        position: absolute;
        left: 12px;
        color: #6b7280;
        font-size: 16px;
        z-index: 1;
      }
      .search-input-wrapper .clear-search-btn {
        position: absolute;
        right: 8px;
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        font-size: 18px;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s ease;
        z-index: 1;
      }
      .search-input-wrapper .clear-search-btn:hover {
        color: #374151;
        background: #f3f4f6;
      }

      .filters-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 0;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
      }
      .filter-group select {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: #fff;
        min-width: 120px;
      }
      .filter-group select:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .bulk-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .bulk-actions button {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
      }

      /* Enhanced Table */
      .orders-table th:first-child,
      .orders-table td:first-child {
        width: 40px;
        text-align: center;
        padding: 12px 8px;
      }
      .orders-table th:nth-child(2),
      .orders-table td:nth-child(2) {
        width: 100px;
        word-break: break-word;
      }
      .orders-table th:nth-child(3),
      .orders-table td:nth-child(3) {
        width: 120px;
        word-break: break-word;
      }
      .orders-table th:nth-child(4),
      .orders-table td:nth-child(4) {
        width: 90px;
        text-align: right;
        padding-right: 24px;
      }
      .orders-table th:nth-child(5),
      .orders-table td:nth-child(5) {
        width: 100px;
      }
      .orders-table th:nth-child(6),
      .orders-table td:nth-child(6) {
        width: 100px;
      }
      .orders-table th:nth-child(7),
      .orders-table td:nth-child(7) {
        width: 100px;
      }
      .orders-table th:nth-child(8),
      .orders-table td:nth-child(8) {
        width: 120px;
      }
      .orders-table th:nth-child(9),
      .orders-table td:nth-child(9) {
        width: 80px;
        text-align: center;
      }
      .orders-table th:first-child input[type="checkbox"] {
        margin: 0;
      }
      .orders-table td:first-child input[type="checkbox"] {
        margin: 0;
      }
      .orders-table tr.selected {
        background: #fef3c7;
      }

      /* Loading States */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }


      .quick-action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }
      .quick-action-btn:active {
        transform: scale(0.95);
      }

      /* Enhanced Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }
      .modal-close:hover {
        background: #f3f4f6;
        color: #374151;
      }
      .modal-body {
        margin-bottom: 20px;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 15px;
        border-top: 1px solid #e5e7eb;
      }

      /* =====================================================
         UNIVERSAL CONFIRM/PROMPT MODAL - Admin Enhancement
         ===================================================== */
      .admin-uni-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        z-index: 10002;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
      }
      
      .admin-uni-modal.show {
        display: flex;
        animation: adminModalFadeIn 0.25s ease;
      }
      
      @keyframes adminModalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .admin-uni-modal-box {
        background: #fff;
        border-radius: 20px;
        width: 100%;
        max-width: 420px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
        animation: adminModalSlideIn 0.3s ease;
      }
      
      @keyframes adminModalSlideIn {
        from { 
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
        to { 
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      
      .admin-uni-modal-header {
        padding: 24px 24px 0;
        text-align: center;
      }
      
      .admin-uni-modal-icon {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
      }
      
      .admin-uni-modal-icon.confirm {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
      }
      .admin-uni-modal-icon.confirm i { color: #d97706; }
      
      .admin-uni-modal-icon.danger {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
      }
      .admin-uni-modal-icon.danger i { color: #dc2626; }
      
      .admin-uni-modal-icon.input {
        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      }
      .admin-uni-modal-icon.input i { color: #6366f1; }
      
      .admin-uni-modal-icon.success {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      }
      .admin-uni-modal-icon.success i { color: #059669; }
      
      .admin-uni-modal-icon.info {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      }
      .admin-uni-modal-icon.info i { color: #2563eb; }
      
      .admin-uni-modal-icon i {
        font-size: 32px;
      }
      
      .admin-uni-modal-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px;
      }
      
      .admin-uni-modal-header p {
        font-size: 14px;
        color: #64748b;
        margin: 0;
        line-height: 1.5;
      }
      
      .admin-uni-modal-body {
        padding: 20px 24px;
      }
      
      .admin-uni-modal-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        color: #1e293b;
        transition: all 0.2s ease;
        box-sizing: border-box;
      }
      
      .admin-uni-modal-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }
      
      .admin-uni-modal-footer {
        padding: 0 24px 24px;
        display: flex;
        gap: 12px;
      }
      
      .admin-uni-modal-btn {
        flex: 1;
        padding: 14px 20px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .admin-uni-modal-btn.cancel {
        background: #f1f5f9;
        color: #475569;
      }
      .admin-uni-modal-btn.cancel:hover { background: #e2e8f0; }
      
      .admin-uni-modal-btn.primary {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: #fff;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }
      .admin-uni-modal-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
      }
      
      .admin-uni-modal-btn.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }
      .admin-uni-modal-btn.danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      }
      
      .admin-uni-modal-btn.success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
      }
      
      /* Info content area for details modals */
      .admin-uni-modal-info {
        padding: 20px 24px;
        max-height: 300px;
        overflow-y: auto;
      }
      
      .admin-uni-modal-info pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
        line-height: 1.6;
        margin: 0;
        padding: 16px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }
      
      /* Mobile responsiveness for admin modal */
      @media (max-width: 640px) {
        .admin-uni-modal {
          padding: 16px;
          align-items: flex-end;
        }
        
        .admin-uni-modal-box {
          border-radius: 20px 20px 0 0;
          max-height: 85vh;
          animation: adminModalSlideUp 0.3s ease;
        }
        
        @keyframes adminModalSlideUp {
          from { 
            opacity: 0;
            transform: translateY(100%);
          }
          to { 
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .admin-uni-modal-header {
          padding: 20px 20px 0;
        }
        
        .admin-uni-modal-icon {
          width: 64px;
          height: 64px;
        }
        
        .admin-uni-modal-icon i {
          font-size: 28px;
        }
        
        .admin-uni-modal-header h3 {
          font-size: 18px;
        }
        
        .admin-uni-modal-body {
          padding: 16px 20px;
        }
        
        .admin-uni-modal-footer {
          padding: 0 20px 20px;
          flex-direction: column-reverse;
        }
        
        .admin-uni-modal-btn {
          padding: 16px 20px;
        }
      }

      /* Modal Overlay & General Modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-header .modal-title {
        margin: 0;
        font-size: 1.1rem;
        color: #1f2937;
      }

      .form-group {
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group small {
        color: #6b7280;
        font-size: 0.85rem;
        margin-top: 6px;
      }

      .table-wrap {
        overflow-x: auto;
        margin-top: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
        table-layout: fixed;
      }
      table thead th {
        text-align: left;
        padding: 12px 16px;
        color: #6b7280;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #f9fafb;
        border-bottom: 2px solid #e5e7eb;
      }
      table thead th:first-child {
        border-radius: 10px 0 0 0;
      }
      table thead th:last-child {
        border-radius: 0 10px 0 0;
      }
      table tbody td {
        padding: 14px 16px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        color: #374151;
      }
      table tbody tr:hover {
        background: #f9fafb;
      }
      table tbody tr:last-child td {
        border-bottom: none;
      }
      .product-label {
        display: flex;
        gap: 14px;
        align-items: center;
      }
      .product-label strong {
        display: block;
        font-weight: 600;
        color: #1f2937;
      }
      .product-table img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }
      
      /* Compact product table styling */
      .product-table tbody td {
        padding: 8px 12px;
      }
      .product-table thead th {
        padding: 8px 12px;
      }
      .product-table .product-label {
        gap: 10px;
      }
      .product-table .product-label strong {
        font-size: 0.85rem;
        line-height: 1.2;
      }
      .product-table .product-label small {
        font-size: 0.7rem;
        line-height: 1.2;
        display: block;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .product-table .pill {
        padding: 4px 8px;
        font-size: 0.7rem;
      }
      .product-table .actions button {
        width: 28px;
        height: 28px;
        font-size: 0.85rem;
      }

      /* ============ AESTHETIC MINIMAL PRODUCT SECTION ============ */
      #products.admin-panel {
        background: linear-gradient(180deg, #fafbfc 0%, #ffffff 100%);
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 6px 16px rgba(0, 0, 0, 0.04);
      }

      #products .section-header {
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
        margin-bottom: 24px;
      }

      #products .section-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #products .section-header h2 i {
        font-size: 1.3rem;
        color: #555;
      }

      #products .section-header small {
        color: #888;
        font-size: 0.85rem;
        font-weight: 400;
      }

      /* Clean Form Styling */
      #products form {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 16px;
        padding: 28px;
        box-shadow: none;
      }

      #products form label {
        color: #333;
        font-weight: 500;
        font-size: 0.85rem;
        text-transform: none;
        letter-spacing: 0;
      }

      #products form input,
      #products form select,
      #products form textarea {
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 12px 14px;
        font-size: 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: #fafafa;
      }

      #products form input:focus,
      #products form select:focus,
      #products form textarea:focus {
        border-color: #333;
        box-shadow: none;
        background: #fff;
      }

      #products form input::placeholder {
        color: #aaa;
      }

      /* Checkbox Group Styling */
      #products .multi-select-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
      }

      #products .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #444;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      #products .checkbox-item:hover {
        background: #f0f0f0;
        border-color: #ddd;
      }

      #products .checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #111;
      }

      #products .color-swatch {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* Image Upload Group */
      #products .image-upload-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      #products .image-upload-group label {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 20px;
        background: #fafafa;
        border: 2px dashed #ddd;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      #products .image-upload-group label:hover {
        background: #f5f5f5;
        border-color: #bbb;
      }

      #products .image-upload-group i {
        font-size: 1.5rem;
        color: #888;
      }

      #products .image-upload-hint {
        font-size: 0.75rem;
        color: #999;
        font-weight: 400;
      }

      /* Product Image Preview Boxes */
      .product-preview-box {
        width: 100%;
        min-height: 120px;
        background: #1f2937;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-size: 0.8rem;
      }
      .product-preview-box img {
        width: 100%;
        height: 100%;
        max-height: 150px;
        object-fit: contain;
      }
      .product-preview-box.thumbnails {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
        justify-content: center;
        align-items: center;
      }
      .product-preview-box.thumbnails img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid #374151;
      }

      /* Form Actions */
      #products .form-actions {
        border-top: 1px solid #f0f0f0;
        padding-top: 20px;
        margin-top: 12px;
      }

      #products .form-actions button.primary {
        background: #111;
        color: #fff;
        border: none;
        padding: 12px 28px;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: none;
      }

      #products .form-actions button.primary:hover {
        background: #333;
        transform: none;
        box-shadow: none;
      }

      #products .form-actions button.secondary {
        background: #fff;
        border: 1px solid #ddd;
        color: #555;
      }

      #products .form-actions button.secondary:hover {
        background: #f8f8f8;
        border-color: #ccc;
      }

      /* Product Search Container */
      #products .search-container {
        margin: 24px 0 16px;
        padding: 20px;
        background: #fafafa;
        border-radius: 12px;
        border: 1px solid #eee;
      }

      #products .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      #products .search-icon {
        position: absolute;
        left: 14px;
        color: #999;
        font-size: 1.1rem;
      }

      #products .search-input {
        width: 100%;
        padding: 12px 40px 12px 42px;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        font-size: 0.9rem;
        background: #fff;
      }

      #products .search-input:focus {
        border-color: #333;
        outline: none;
      }

      #products .clear-search-btn {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #products .clear-search-btn:hover {
        color: #555;
      }

      /* Product Table Minimal Style */
      #products .table-wrap {
        margin-top: 0;
      }

      #products .product-table {
        border-collapse: separate;
        border-spacing: 0;
      }

      #products .product-table thead th {
        background: #f8f8f8;
        color: #555;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 14px 12px;
        border-bottom: 1px solid #eee;
      }

      #products .product-table thead th:first-child {
        border-radius: 8px 0 0 0;
      }

      #products .product-table thead th:last-child {
        border-radius: 0 8px 0 0;
      }

      #products .product-table tbody td {
        padding: 16px 12px;
        border-bottom: 1px solid #f5f5f5;
        color: #333;
        font-size: 0.875rem;
      }

      #products .product-table tbody tr {
        transition: background 0.15s ease;
      }

      #products .product-table tbody tr:hover {
        background: #fafafa;
      }

      #products .product-table tbody tr:last-child td {
        border-bottom: none;
      }

      #products .product-table img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
      }

      #products .product-table .product-label {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      #products .product-table .product-label strong {
        color: #111;
        font-weight: 600;
        font-size: 0.9rem;
      }

      #products .product-table .product-label small {
        color: #888;
        font-size: 0.75rem;
        max-width: 200px;
      }

      #products .product-table .pill {
        background: #f0f0f0;
        color: #555;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      #products .product-table .actions button {
        background: #f5f5f5;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        color: #666;
        transition: all 0.15s ease;
      }

      #products .product-table .actions button:hover {
        background: #eee;
        color: #333;
      }

      #products .product-table .actions button[data-action="edit"]:hover {
        background: #e8f4ff;
        color: #0066cc;
      }

      #products .product-table .actions button[data-action="delete"]:hover {
        background: #ffebeb;
        color: #cc0000;
      }

      /* Low Stock Notification Minimal */
      #products .low-stock-notification {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 14px 18px;
        margin-bottom: 20px;
      }

      #products .notification-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      #products .notification-content i {
        color: #d97706;
        font-size: 1.2rem;
      }

      #products .notification-text strong {
        color: #92400e;
        font-size: 0.9rem;
      }

      #products .notification-text p {
        color: #b45309;
        font-size: 0.8rem;
        margin: 2px 0 0;
      }

      #products .notification-close {
        background: none;
        border: none;
        color: #d97706;
        cursor: pointer;
        margin-left: auto;
        padding: 4px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 12px;
        border-radius: 999px;
        background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
        color: #1e40af;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .actions {
        display: flex;
        gap: 6px;
      }
      .actions button {
        border: none;
        background: #f3f4f6;
        cursor: pointer;
        font-size: 1rem;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        color: #6b7280;
      }
      .actions button:hover {
        background: #e5e7eb;
        color: #1f2937;
      }
      .actions button[data-action="delete"]:hover {
        background: #fee2e2;
        color: #dc2626;
      }
      .actions button[data-action="edit"]:hover {
        background: #dbeafe;
        color: #2563eb;
      }
      .orders-table .status select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1.5px solid #e5e7eb;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        background: #fff;
        transition: all 0.2s ease;
      }
      .orders-table .status select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }
      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-pending { background: #fef3c7; color: #92400e; }
      .status-processing { background: #dbeafe; color: #1e40af; }
      .status-shipped { background: #e0e7ff; color: #3730a3; }
      .status-delivered { background: #d1fae5; color: #065f46; }
      .status-cancelled { background: #fee2e2; color: #991b1b; }
      .refresh-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: #6b7280;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 20px;
      }
      .refresh-indicator.active {
        color: #059669;
        background: #d1fae5;
      }
      .refresh-indicator i {
        animation: none;
      }
      .refresh-indicator.loading i {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .auto-refresh-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: #374151;
        cursor: pointer;
      }
      .auto-refresh-toggle input {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      .order-items-detail {
        font-size: 0.8rem;
        color: #6b7280;
        max-width: 200px;
      }
      .order-items-detail .item {
        margin-bottom: 4px;
        padding: 4px 8px;
        background: #f9fafb;
        border-radius: 6px;
      }
      .order-address {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 4px;
      }
      .section-header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .user-role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .user-role-customer {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #3730a3;
        border: 1px solid #a5b4fc;
      }
      .user-role-admin {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        border: 1px solid #f59e0b;
        font-weight: 700;
      }
      .user-row-admin {
        background: linear-gradient(90deg, rgba(254, 243, 199, 0.1) 0%, rgba(254, 243, 199, 0.05) 100%);
        border-left: 4px solid #f59e0b;
      }
      .user-row-customer {
        background: linear-gradient(90deg, rgba(224, 231, 255, 0.1) 0%, rgba(224, 231, 255, 0.05) 100%);
        border-left: 4px solid #3730a3;
      }
      .last-activity {
        font-size: 0.7rem;
        color: #9ca3af;
      }
      .users-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .users-section .info-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }
      .users-section .info-row #userCount {
        font-weight: 600;
        color: #374151;
        font-size: 0.95rem;
      }
      
      /* Password Reset Management Styles */
      .password-reset-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .password-reset-section .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-radius: 12px;
        border: 1px solid #fbbf24;
      }
      .password-reset-section .section-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .password-reset-section .search-box {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        padding: 8px 14px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        flex: 1;
        max-width: 300px;
        min-width: 200px;
      }
      .password-reset-section .search-box input {
        border: none;
        outline: none;
        flex: 1;
        font-size: 0.9rem;
        background: transparent;
      }
      .password-reset-section .search-box i {
        color: #9ca3af;
      }
      .password-reset-section .card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
      }
      .password-reset-section .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
      }
      .password-reset-section .card-header h4 {
        margin: 0;
        font-size: 0.95rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .password-reset-section .card-header .badge {
        background: #ef4444;
        color: #fff;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .password-reset-section .card-header .badge.success {
        background: #10b981;
      }
      .password-reset-section .reset-table {
        width: 100%;
        border-collapse: collapse;
      }
      .password-reset-section .reset-table th,
      .password-reset-section .reset-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
      }
      .password-reset-section .reset-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .password-reset-section .reset-table tr:hover {
        background: #f9fafb;
      }
      .password-reset-section .reset-table .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .password-reset-section .reset-table .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
      }
      .password-reset-section .reset-table .user-details {
        display: flex;
        flex-direction: column;
      }
      .password-reset-section .reset-table .user-name {
        font-weight: 600;
        color: #1f2937;
      }
      .password-reset-section .reset-table .user-email {
        font-size: 0.8rem;
        color: #6b7280;
      }
      .password-reset-section .otp-code {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        font-size: 1rem;
        color: #1f2937;
        background: #f3f4f6;
        padding: 6px 12px;
        border-radius: 6px;
        letter-spacing: 2px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .password-reset-section .otp-code .copy-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #6b7280;
        transition: color 0.2s;
      }
      .password-reset-section .otp-code .copy-btn:hover {
        color: #1f2937;
      }
      .password-reset-section .expires-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .password-reset-section .expires-badge.urgent {
        background: #fef2f2;
        color: #dc2626;
      }
      .password-reset-section .expires-badge.warning {
        background: #fffbeb;
        color: #d97706;
      }
      .password-reset-section .expires-badge.safe {
        background: #f0fdf4;
        color: #16a34a;
      }
      .password-reset-section .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .password-reset-section .status-badge.active {
        background: #dcfce7;
        color: #16a34a;
      }
      .password-reset-section .status-badge.blocked {
        background: #fef2f2;
        color: #dc2626;
      }
      .password-reset-section .status-badge.admin {
        background: #fef3c7;
        color: #d97706;
      }
      .password-reset-section .action-btns {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .password-reset-section .btn-action {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease;
      }
      .password-reset-section .btn-action.generate {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
      }
      .password-reset-section .btn-action.generate:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .password-reset-section .btn-action.direct {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
      }
      .password-reset-section .btn-action.direct:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      .password-reset-section .btn-action.invalidate {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
      }
      .password-reset-section .btn-action.invalidate:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }
      .password-reset-section .btn-action.view {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
      }
      .password-reset-section .btn-action.view:hover {
        background: #e5e7eb;
      }
      .password-reset-section .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
      }
      .password-reset-section .empty-state i {
        font-size: 3rem;
        margin-bottom: 12px;
        opacity: 0.5;
      }
      .password-reset-section .table-wrapper {
        overflow-x: auto;
      }
      
      /* Direct Reset Modal */
      .direct-reset-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .direct-reset-modal.active {
        display: flex;
      }
      .direct-reset-modal .modal-content {
        background: #fff;
        border-radius: 16px;
        max-width: 420px;
        width: 100%;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      }
      .direct-reset-modal .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .direct-reset-modal .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #1f2937;
      }
      .direct-reset-modal .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #9ca3af;
        padding: 4px;
      }
      .direct-reset-modal .modal-close:hover {
        color: #374151;
      }
      .direct-reset-modal .form-group {
        margin-bottom: 16px;
      }
      .direct-reset-modal .form-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
      }
      .direct-reset-modal .form-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }
      .direct-reset-modal .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      .direct-reset-modal .form-group .password-wrapper {
        position: relative;
      }
      .direct-reset-modal .form-group .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #9ca3af;
      }
      .direct-reset-modal .form-group .generate-password {
        margin-top: 8px;
        font-size: 0.8rem;
        color: #3b82f6;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .direct-reset-modal .form-group .generate-password:hover {
        text-decoration: underline;
      }
      .direct-reset-modal .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .direct-reset-modal .modal-actions button {
        flex: 1;
        padding: 12px 16px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .direct-reset-modal .modal-actions .btn-cancel {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #374151;
      }
      .direct-reset-modal .modal-actions .btn-cancel:hover {
        background: #e5e7eb;
      }
      .direct-reset-modal .modal-actions .btn-reset {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: #fff;
      }
      .direct-reset-modal .modal-actions .btn-reset:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      .direct-reset-modal .modal-actions .btn-reset:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      /* Mobile Responsive for Password Reset */
      @media (max-width: 768px) {
        .password-reset-section .section-header {
          flex-direction: column;
          align-items: stretch;
        }
        .password-reset-section .search-box {
          max-width: 100%;
        }
        .password-reset-section .reset-table th,
        .password-reset-section .reset-table td {
          padding: 10px 12px;
          font-size: 0.8rem;
        }
        .password-reset-section .reset-table .user-avatar {
          width: 32px;
          height: 32px;
          font-size: 0.75rem;
        }
        .password-reset-section .otp-code {
          font-size: 0.9rem;
          padding: 4px 8px;
        }
        .password-reset-section .action-btns {
          flex-direction: column;
        }
        .password-reset-section .btn-action {
          width: 100%;
          justify-content: center;
        }
        .password-reset-section .hide-mobile {
          display: none;
        }
        .direct-reset-modal .modal-content {
          padding: 20px;
        }
      }
      
      @media (max-width: 480px) {
        .password-reset-section .reset-table {
          font-size: 0.75rem;
        }
        .password-reset-section .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
      
      .btn-export {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
      }
      .btn-export:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.3);
      }
      .btn-export i {
        font-size: 1rem;
      }
      
      /* Save Changes Button Styles */
      #saveOrderChangesBtn,
      #saveReturnChangesBtn,
      #saveExchangeChangesBtn,
      #saveCancellationChangesBtn {
        display: none;
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        animation: pulse-save 2s infinite;
      }
      #saveOrderChangesBtn.visible,
      #saveReturnChangesBtn.visible,
      #saveExchangeChangesBtn.visible,
      #saveCancellationChangesBtn.visible {
        display: inline-flex;
      }
      #saveOrderChangesBtn:hover,
      #saveReturnChangesBtn:hover,
      #saveExchangeChangesBtn:hover,
      #saveCancellationChangesBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
      }
      #saveOrderChangesBtn:disabled,
      #saveReturnChangesBtn:disabled,
      #saveExchangeChangesBtn:disabled,
      #saveCancellationChangesBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        animation: none;
      }
      .pending-count {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 4px;
      }
      @keyframes pulse-save {
        0%, 100% { box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(5, 150, 105, 0.5); }
      }
      .status-changed {
        outline: 2px solid #f59e0b;
        outline-offset: 2px;
        border-radius: 6px;
      }

      #productMessage {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-top: 8px;
        display: none;
      }
      #productMessage:not(:empty) {
        display: block;
      }
      .image-upload-group {
        display: flex;
        gap: 16px;
        grid-column: 1 / -1;
      }
      .image-upload-group label {
        flex: 1;
      }
      .product-images {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .product-images > img {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 6px;
      }
      .product-images .thumbs-container {
        display: flex;
        align-items: center;
      }
      .product-images .thumb-img {
        width: 28px;
        height: 28px;
        border: 1px dashed #d1d5db;
        border-radius: 4px;
        object-fit: cover;
      }
      .product-images .more-thumbs {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: #e5e7eb;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        color: #4b5563;
        margin-left: -6px;
      }
      .product-id {
        font-size: 0.7rem;
        color: #9ca3af;
        display: block;
        margin-top: 1px;
      }
      .color-size-badge {
        display: inline-block;
        padding: 3px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        font-size: 0.8rem;
        color: #4b5563;
      }

      /* Policy Table Styling */
      .policy-name-col {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .policy-name-col strong {
        display: block;
        color: #1f2937;
        font-weight: 600;
      }

      .policy-name-col small {
        display: block;
        color: #9ca3af;
        font-size: 0.8rem;
        font-family: 'Courier New', monospace;
      }

      .type-badge {
        display: inline-block;
        padding: 6px 12px;
        background: #f3f4f6;
        color: #374151;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .type-badge.type-terms {
        background: #dbeafe;
        color: #1e40af;
      }

      .type-badge.type-privacy {
        background: #dcfce7;
        color: #166534;
      }

      .type-badge.type-return {
        background: #fed7aa;
        color: #92400e;
      }

      .type-badge.type-refund {
        background: #fecaca;
        color: #dc2626;
      }

      .type-badge.type-shipping {
        background: #c7d2fe;
        color: #3730a3;
      }

      .type-badge.type-payment {
        background: #e9d5ff;
        color: #6b21a8;
      }

      .type-badge.type-cancellation {
        background: #fae8ff;
        color: #7c2d12;
      }

      .type-badge.type-custom {
        background: #f0fdf4;
        color: #15803d;
      }

      .actions-col {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .action-btn.edit-btn {
        background: #dbeafe;
        color: #1e40af;
      }

      .action-btn.edit-btn:hover {
        background: #bfdbfe;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(30, 64, 175, 0.2);
      }

      .action-btn.delete-btn {
        background: #fee2e2;
        color: #dc2626;
      }

      .action-btn.delete-btn:hover {
        background: #fecaca;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
      }

      .action-btn i {
        font-size: 1rem;
      }

      .stock-badge {
        display: inline-block;
        padding: 3px 8px;
        background: #dcfce7;
        color: #166534;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .stock-badge.low-stock {
        background: #fef3c7;
        color: #92400e;
      }
      
      /* Stock Status Badge (In Stock / Out of Stock) */
      .stock-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 4px;
      }
      .stock-status-badge.in-stock {
        background: #d1fae5;
        color: #065f46;
      }
      .stock-status-badge.out-of-stock {
        background: #fee2e2;
        color: #991b1b;
      }
      .stock-status-badge i {
        font-size: 0.8rem;
      }
      
      /* Out of stock row styling */
      tr.out-of-stock-row {
        background: #fef2f2 !important;
      }
      tr.out-of-stock-row:hover {
        background: #fee2e2 !important;
      }
      
      .position-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: #fff;
        border-radius: 50%;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .position-badge.empty {
        background: #f3f4f6;
        color: #9ca3af;
      }

      /* Low Stock Notification */
      .low-stock-notification {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        margin-bottom: 20px;
        padding: 0;
        overflow: hidden;
      }

      .notification-content {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: linear-gradient(135deg, rgba(254, 243, 199, 0.8), rgba(253, 230, 138, 0.8));
      }

      .notification-content i {
        font-size: 1.5rem;
        color: #92400e;
        flex-shrink: 0;
      }

      .notification-text {
        flex: 1;
      }

      .notification-text strong {
        display: block;
        color: #92400e;
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .notification-text p {
        color: #78350f;
        font-size: 0.9rem;
        margin: 0;
      }

      .notification-close {
        background: none;
        border: none;
        color: #92400e;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 8px;
        flex-shrink: 0;
        transition: all 0.2s ease;
      }

      .notification-close:hover {
        color: #b45309;
        transform: scale(1.2);
      }

      .position-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: #fff;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }
      .position-badge.empty {
        background: #e5e7eb;
        color: #9ca3af;
        box-shadow: none;
      }
      .image-upload-hint {
        color: #9ca3af;
        font-size: 0.7rem;
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0;
        margin-top: 4px;
      }
      
      /* Input with generate button */
      .input-with-btn {
        display: flex;
        gap: 8px;
        align-items: stretch;
      }
      .input-with-btn input {
        flex: 1;
        margin: 0;
      }
      .generate-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        transition: all 0.2s;
      }
      .generate-btn:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      .generate-btn:active {
        transform: translateY(0);
      }
      .generate-btn i {
        font-size: 1rem;
      }
      
      /* Mobile responsive for input with generate button */
      @media (max-width: 480px) {
        .input-with-btn {
          flex-direction: column;
          gap: 8px;
        }
        .input-with-btn input {
          width: 100%;
        }
        .generate-btn {
          width: 100%;
          justify-content: center;
          padding: 12px 16px;
        }
      }

      /* Multi-select checkbox group styles */
      .multi-select-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-top: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
        font-weight: 500;
        color: #374151;
      }

      .checkbox-item:hover {
        border-color: #000;
        background: #f8f9fa;
      }

      .checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #000;
      }

      .checkbox-item input[type="checkbox"]:checked + .color-swatch,
      .checkbox-item:has(input[type="checkbox"]:checked) {
        border-color: #000;
      }

      .color-swatch {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
      }

      /* Returns specific styles */
      .returns-table th:first-child,
      .returns-table td:first-child {
        width: 40px;
        text-align: center;
        padding: 12px 8px;
      }
      .returns-table th:nth-child(2),
      .returns-table td:nth-child(2) {
        width: 100px;
        word-break: break-word;
      }
      .returns-table th:nth-child(3),
      .returns-table td:nth-child(3) {
        width: 100px;
        word-break: break-word;
      }
      .returns-table th:nth-child(4),
      .returns-table td:nth-child(4) {
        width: 120px;
        word-break: break-word;
      }
      .returns-table th:nth-child(5),
      .returns-table td:nth-child(5) {
        width: 110px;
      }
      .returns-table th:nth-child(6),
      .returns-table td:nth-child(6) {
        width: 110px;
      }
      .returns-table th:nth-child(7),
      .returns-table td:nth-child(7) {
        width: 100px;
      }
      .returns-table th:nth-child(8),
      .returns-table td:nth-child(8) {
        width: 100px;
      }
      .returns-table th:nth-child(9),
      .returns-table td:nth-child(9) {
        width: 80px;
        text-align: center;
      }
      .returns-table th:first-child input[type="checkbox"] {
        margin: 0;
      }
      .returns-table td:first-child input[type="checkbox"] {
        margin: 0;
      }
      .returns-table tr.selected {
        background: #fef3c7;
      }
      .returns-table .status select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1.5px solid #e5e7eb;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        background: #fff;
        transition: all 0.2s ease;
      }
      .returns-table .status select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }
      .return-status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .return-status-pending { background: #fef3c7; color: #92400e; }
      .return-status-approved { background: #dbeafe; color: #1e40af; }
      .return-status-rejected { background: #fee2e2; color: #991b1b; }
      .return-status-pickup-scheduled { background: #e0f2fe; color: #0369a1; }
      .return-status-picked-up { background: #f3e8ff; color: #7c3aed; }
      .return-status-processing { background: #e0e7ff; color: #3730a3; }
      .return-status-refunded { background: #dcfce7; color: #166534; }
      .return-status-completed { background: #d1fae5; color: #065f46; }
      .return-items-summary {
        font-size: 0.8rem;
        color: #6b7280;
        max-width: 200px;
      }
      .return-items-summary .item {
        margin-bottom: 4px;
        padding: 4px 8px;
        background: #f9fafb;
        border-radius: 6px;
      }
      .return-reason-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 0.75rem;
        color: #4b5563;
        text-transform: capitalize;
      }
      
      /* Exchanges table specific column widths (10 columns) */
      .exchanges-table th:first-child,
      .exchanges-table td:first-child {
        width: 40px;
        text-align: center;
        padding: 12px 8px;
      }
      .exchanges-table th:nth-child(2),
      .exchanges-table td:nth-child(2) {
        width: 90px;
        word-break: break-word;
      }
      .exchanges-table th:nth-child(3),
      .exchanges-table td:nth-child(3) {
        width: 90px;
        word-break: break-word;
      }
      .exchanges-table th:nth-child(4),
      .exchanges-table td:nth-child(4) {
        width: 130px;
        word-break: break-word;
      }
      .exchanges-table th:nth-child(5),
      .exchanges-table td:nth-child(5) {
        width: 120px;
      }
      .exchanges-table th:nth-child(6),
      .exchanges-table td:nth-child(6) {
        width: 100px;
      }
      .exchanges-table th:nth-child(7),
      .exchanges-table td:nth-child(7) {
        width: 100px;
      }
      .exchanges-table th:nth-child(8),
      .exchanges-table td:nth-child(8) {
        width: 130px;
      }
      .exchanges-table th:nth-child(9),
      .exchanges-table td:nth-child(9) {
        width: 90px;
      }
      .exchanges-table th:nth-child(10),
      .exchanges-table td:nth-child(10) {
        width: 80px;
        text-align: center;
      }
      
      /* Table scroll wrapper for mobile */
      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }
      
      @media (max-width: 1024px) {
        .admin-panel form {
          grid-template-columns: repeat(2, 1fr);
        }
        .section-header-actions {
          flex-wrap: wrap;
          gap: 8px;
        }
        .filters-bar {
          flex-wrap: wrap;
          gap: 10px;
        }
        .bulk-actions {
          width: 100%;
          justify-content: flex-start;
        }
      }
      @media (max-width: 768px) {
        /* Hide old admin-side-nav on mobile - use FAB menu instead */
        .admin-side-nav {
          display: none !important;
        }
        /* Hide tooltips on mobile */
        .nav-tooltip {
          display: none !important;
          opacity: 0 !important;
          visibility: hidden !important;
          pointer-events: none !important;
        }
        .admin-page {
          padding: 0 4%;
          margin-top: 20px;
          margin-bottom: 100px; /* Space for toggle button */
        }
        .admin-panel {
          padding: 16px;
        }
        .admin-panel form {
          grid-template-columns: 1fr;
          padding: 16px;
          gap: 14px;
        }
        .admin-panel .form-actions {
          flex-direction: column;
        }
        .admin-panel button {
          width: 100%;
          justify-content: center;
        }
        .section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .insights-grid {
          gap: 12px;
        }
        .insight-card {
          flex: 1 1 150px;
          max-width: none;
          padding: 12px;
        }
        .insight-icon {
          width: 36px;
          height: 36px;
          font-size: 1rem;
          border-radius: 8px;
        }
        .insight-label {
          font-size: 0.65rem;
        }
        .insight-value {
          font-size: 1.1rem;
        }
        table thead {
          display: none;
        }
        table tbody td {
          display: block;
          width: 100%;
          padding: 8px 12px;
          text-align: left;
        }
        table tbody td::before {
          content: attr(data-label);
          font-weight: 600;
          display: block;
          margin-bottom: 4px;
          color: #6b7280;
          font-size: 0.75rem;
          text-transform: uppercase;
        }
        table tbody tr {
          display: block;
          margin-bottom: 16px;
          background: #f9fafb;
          border-radius: 12px;
          padding: 8px;
          border: 1px solid #e5e7eb;
        }
        /* Product images larger on mobile for better visibility */
        .product-table img {
          width: 80px;
          height: 80px;
          object-fit: cover;
          border-radius: 8px;
          aspect-ratio: 1/1;
        }
        .product-label {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .actions-col {
          flex-direction: column;
        }
        .action-btn {
          width: 100%;
          justify-content: center;
        }
        .actions {
          justify-content: flex-start;
          margin-top: 8px;
        }
        .users-section .info-row {
          flex-direction: column;
          align-items: flex-start;
        }
        .btn-export {
          width: 100%;
          justify-content: center;
        }
        .image-upload-group {
          flex-direction: column;
        }
      }
      @media (max-width: 480px) {
        .admin-page {
          margin-bottom: 100px;
        }
        .insights-grid {
          flex-direction: column;
        }
        .insight-card {
          flex: 1 1 100%;
        }
        /* Fix admin page overflow on mobile */
        .admin-page {
          padding: 0 3%;
          max-width: 100vw;
          overflow-x: hidden;
        }
        .admin-panel {
          padding: 12px;
          border-radius: 12px;
          max-width: 100%;
          overflow-x: hidden;
        }
        .admin-panel form {
          padding: 12px;
          gap: 12px;
          max-width: 100%;
        }
        /* Fix product management section on small screens */
        #products .image-upload-group {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }
        #products .image-upload-group label {
          width: 100%;
          min-width: 0;
        }
        .product-preview-box {
          min-height: 80px;
          max-width: 100%;
        }
        .product-preview-box.thumbnails {
          flex-wrap: wrap;
          padding: 8px;
          gap: 6px;
        }
        .product-preview-box.thumbnails img {
          width: 50px;
          height: 50px;
        }
        /* Fix multi-select group overflow */
        .multi-select-group {
          max-width: 100%;
          padding: 8px;
          gap: 6px;
        }
        .checkbox-item {
          padding: 6px 10px;
          font-size: 0.8rem;
          flex-shrink: 0;
        }
        /* Fix table wrapper scroll */
        .table-wrap {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 0 -12px;
          padding: 0 12px;
          max-width: calc(100% + 24px);
        }
        .product-table {
          min-width: auto;
          width: 100%;
        }
        /* Product images in mobile view */
        .product-images {
          flex-wrap: wrap;
          gap: 4px;
        }
        .product-images > img {
          width: 60px;
          height: 60px;
        }
        .product-images .thumbs-container {
          flex-wrap: wrap;
        }
        .product-images .thumb-img {
          width: 40px;
          height: 40px;
        }
        /* Fix search container */
        .search-container {
          padding: 12px;
          max-width: 100%;
        }
        .search-input-wrapper {
          width: 100%;
        }
        .search-input-wrapper .search-input {
          width: 100%;
          font-size: 14px;
        }
        /* Fix slide cards grid */
        .slide-cards {
          grid-template-columns: 1fr;
        }
        /* Fix section header on mobile */
        .section-header-right,
        .section-header-actions {
          width: 100%;
          flex-direction: column;
          gap: 8px;
        }
        .section-header-actions button,
        .section-header-right button {
          width: 100%;
        }
      }

      /* Slider Management Styles */
      .slider-management {
        margin-bottom: 24px;
      }
      .slide-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .slide-card {
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
      }
      .slide-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
      }
      .slide-card.inactive {
        opacity: 0.6;
      }
      .slide-preview {
        width: 100%;
        height: 160px;
        background: #1f2937;
        position: relative;
        overflow: hidden;
      }
      .slide-preview video,
      .slide-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .slide-type-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .slide-position-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #3b82f6;
        color: #fff;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
      }
      .slide-info {
        padding: 16px;
      }
      .slide-info h4 {
        margin: 0 0 8px;
        font-size: 1rem;
        color: #1f2937;
      }
      .slide-info p {
        margin: 0;
        font-size: 0.85rem;
        color: #6b7280;
        word-break: break-all;
      }
      .slide-actions {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
      }
      .slide-actions button {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      .slide-btn-edit {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .slide-btn-edit:hover {
        background: #bfdbfe;
      }
      .slide-btn-toggle {
        background: #d1fae5;
        color: #065f46;
      }
      .slide-btn-toggle.inactive {
        background: #fef3c7;
        color: #92400e;
      }
      .slide-btn-toggle:hover {
        opacity: 0.85;
      }
      .slide-btn-delete {
        background: #fee2e2;
        color: #dc2626;
      }
      .slide-btn-delete:hover {
        background: #fecaca;
      }
      .add-slide-card {
        border: 2px dashed #d1d5db;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 280px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .add-slide-card:hover {
        border-color: #3b82f6;
        background: #eff6ff;
      }
      .add-slide-card i {
        font-size: 3rem;
        color: #9ca3af;
        margin-bottom: 12px;
      }
      .add-slide-card span {
        color: #6b7280;
        font-weight: 500;
      }
      
      /* Slide Modal Form */
      .slide-form-group {
        margin-bottom: 16px;
      }
      .slide-form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: #374151;
        font-size: 0.9rem;
      }
      .slide-form-group input,
      .slide-form-group select {
        width: 100%;
        padding: 12px;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }
      .slide-form-group input:focus,
      .slide-form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }
      .slide-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .slide-form-hint {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 4px;
      }
      .slide-preview-box {
        width: 100%;
        height: 150px;
        background: #1f2937;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
      }
      .slide-preview-box video,
      .slide-preview-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Policy Management Styles */
      .policy-modal .modal-content {
        max-width: 800px;
        width: 90vw;
      }
      .policy-modal textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        min-height: 300px;
      }
      .policy-modal textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Policy Status Indicator */
      #policyStatus {
        font-weight: 500;
        font-size: 0.9rem;
        transition: color 0.3s ease;
      }
      .status-active { background: #d1fae5; color: #065f46; }
      .status-draft { background: #fef3c7; color: #92400e; }
      .status-inactive { background: #fee2e2; color: #991b1b; }

      /* Table Responsive Wrapper */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Messages/Contact Section Styles */
      #messagesTable {
        table-layout: fixed;
        width: 100%;
        min-width: 900px;
      }
      #messagesTable thead th:nth-child(1) { width: 12%; } /* Query # */
      #messagesTable thead th:nth-child(2) { width: 10%; } /* Name */
      #messagesTable thead th:nth-child(3) { width: 14%; } /* Email */
      #messagesTable thead th:nth-child(4) { width: 10%; } /* Phone */
      #messagesTable thead th:nth-child(5) { width: 16%; } /* Subject */
      #messagesTable thead th:nth-child(6) { width: 12%; } /* Date */
      #messagesTable thead th:nth-child(7) { width: 10%; } /* Status */
      #messagesTable thead th:nth-child(8) { width: 16%; } /* Actions */
      #messagesTable tbody td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 0;
      }
      #messagesTable tbody td:last-child {
        overflow: hidden;
        white-space: normal;
        max-width: none;
      }
      #messagesTable tbody td:hover {
        overflow: visible;
        white-space: normal;
        word-break: break-word;
      }
      #messagesTable tbody tr.status-unread {
        background-color: #fef9f3;
        font-weight: 500;
      }
      #messagesTable tbody tr.status-read {
        background-color: #fff;
        opacity: 0.8;
      }
      .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
      }
      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }
      .badge-success {
        background: #d1fae5;
        color: #065f46;
      }
      .message-detail {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .detail-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .detail-row.full-width {
        grid-column: 1 / -1;
      }
      .detail-row label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
      }
      .detail-row p {
        margin: 0;
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
        border-left: 3px solid #3b82f6;
        word-break: break-word;
      }
      .detail-row a {
        color: #3b82f6;
        text-decoration: none;
      }
      .detail-row a:hover {
        text-decoration: underline;
      }
      .message-content {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
      }
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        color: #9ca3af;
        text-align: center;
      }
      .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      .empty-state p {
        margin: 0;
        font-size: 1.1rem;
      }

      /* Reply Section Styles */
      .replies-section {
        margin: 20px 0;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #22c55e;
      }
      .replies-section h4 {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        color: #1f2937;
      }
      .replies-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .reply-item {
        background: #fff;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #22c55e;
      }
      .reply-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 12px;
      }
      .reply-header strong {
        color: #059669;
      }
      .reply-header small {
        color: #9ca3af;
      }
      .reply-content {
        color: #374151;
        font-size: 14px;
        line-height: 1.5;
        margin: 0;
      }

      .reply-form-section {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }
      .reply-form-section h4 {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        color: #1f2937;
      }
      .reply-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        min-height: 100px;
        box-sizing: border-box;
      }
      .reply-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      /* Message Modal Specific Styles */
      .modal-overlay .modal-body {
        padding: 24px 28px;
        overflow-y: auto;
      }
      .modal-overlay .modal-content {
        max-width: 700px;
      }

      /* Notification Badge Styles */
      .notification-badge {
        position: relative;
        display: inline-block;
      }
      .notification-dot {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        animation: pulse-badge 2s infinite;
      }
      @keyframes pulse-badge {
        0%, 100% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 2px 12px rgba(220, 38, 38, 0.5);
        }
      }
      .notification-badge.has-notification a {
        color: #dc2626;
        font-weight: 600;
      }
      
      /* API Status Indicator */
      .api-status {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .api-status.online {
        background: #d1fae5;
        color: #059669;
      }
      .api-status.offline {
        background: #fee2e2;
        color: #dc2626;
      }
      .api-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse-status 2s infinite;
      }
      .api-status.online .status-dot {
        background: #059669;
      }
      .api-status.offline .status-dot {
        background: #dc2626;
      }
      @keyframes pulse-status {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Health Monitoring Section Styles */
      .health-section { margin-top: 24px; }
      
      .health-status-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border: 1px solid #d1d5db;
        transition: all 0.3s ease;
      }
      .health-status-badge.healthy {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        border-color: #10b981;
        color: #065f46;
      }
      .health-status-badge.degraded {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-color: #f59e0b;
        color: #92400e;
      }
      .health-status-badge.error {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        border-color: #ef4444;
        color: #991b1b;
      }
      .health-status-badge .pulse-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6b7280;
        animation: pulse-status 2s infinite;
      }
      .health-status-badge.healthy .pulse-dot { background: #10b981; }
      .health-status-badge.degraded .pulse-dot { background: #f59e0b; }
      .health-status-badge.error .pulse-dot { background: #ef4444; }

      .health-overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }
      .health-card {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        display: flex;
        gap: 16px;
        align-items: flex-start;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
      }
      .health-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      .health-card.healthy { border-left: 4px solid #10b981; }
      .health-card.degraded { border-left: 4px solid #f59e0b; }
      .health-card.error { border-left: 4px solid #ef4444; }
      
      .health-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }
      .health-card.server-status .health-card-icon { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }
      .health-card.database-status .health-card-icon { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #db2777; }
      .health-card.uploads-status .health-card-icon { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669; }
      .health-card.response-time .health-card-icon { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
      
      .health-card-content h4 {
        margin: 0 0 4px;
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
      }
      .health-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 4px;
      }
      .health-meta {
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .health-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin: 28px 0 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      .health-section-title i {
        font-size: 1.2rem;
        color: #6b7280;
      }

      .system-resources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .resource-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e7eb;
      }
      .resource-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .resource-header span:first-child {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #374151;
      }
      .resource-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
      }
      .resource-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      .resource-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        border-radius: 4px;
        transition: width 0.5s ease;
      }
      .resource-fill.heap { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
      .resource-fill.warning { background: linear-gradient(90deg, #f59e0b, #d97706); }
      .resource-fill.critical { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .resource-details {
        font-size: 0.8rem;
        color: #6b7280;
      }

      .api-endpoints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .endpoint-card {
        background: #fff;
        border-radius: 10px;
        padding: 14px 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .endpoint-card:hover { border-color: #3b82f6; }
      .endpoint-card.healthy { border-left: 3px solid #10b981; }
      .endpoint-card.checking { border-left: 3px solid #6b7280; opacity: 0.7; }
      .endpoint-card.error { border-left: 3px solid #ef4444; }
      .endpoint-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .endpoint-status-dot.healthy { background: #10b981; }
      .endpoint-status-dot.checking { background: #6b7280; animation: pulse-status 1s infinite; }
      .endpoint-status-dot.error { background: #ef4444; }
      .endpoint-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #374151;
        font-family: 'Courier New', monospace;
      }
      .endpoint-latency {
        margin-left: auto;
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 500;
      }

      .database-files-grid, .upload-folders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .file-card, .folder-card {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        text-align: center;
        transition: all 0.2s ease;
      }
      .file-card:hover, .folder-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      }
      .file-card.ok, .folder-card.ok { border-top: 3px solid #10b981; }
      .file-card.error, .folder-card.error { border-top: 3px solid #ef4444; background: #fef2f2; }
      .file-card.missing, .folder-card.missing { border-top: 3px solid #f59e0b; background: #fffbeb; }
      .file-card-icon, .folder-card-icon {
        font-size: 1.8rem;
        margin-bottom: 8px;
      }
      .file-card.ok .file-card-icon { color: #10b981; }
      .file-card.error .file-card-icon { color: #ef4444; }
      .file-card.missing .file-card-icon { color: #f59e0b; }
      .folder-card.ok .folder-card-icon { color: #3b82f6; }
      .file-card-name, .folder-card-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        word-break: break-all;
      }
      .file-card-meta, .folder-card-meta {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .server-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }
      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .info-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }
      .info-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1f2937;
      }
      
      /* Uptime badge with live indicator */
      .info-value.uptime-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        padding: 6px 12px;
        border-radius: 8px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 0.9rem;
        font-weight: 600;
        position: relative;
      }
      
      .info-value.uptime-badge::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse-live 2s ease-in-out infinite;
      }
      
      @keyframes pulse-live {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(0.9); }
      }

      @media (max-width: 768px) {
        .health-overview-grid { grid-template-columns: 1fr 1fr; }
        .system-resources-grid { grid-template-columns: 1fr; }
        .api-endpoints-grid { grid-template-columns: 1fr; }
        .database-files-grid, .upload-folders-grid { grid-template-columns: repeat(2, 1fr); }
        .server-info-grid { grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 480px) {
        .health-overview-grid { grid-template-columns: 1fr; }
        .database-files-grid, .upload-folders-grid { grid-template-columns: 1fr; }
        .server-info-grid { grid-template-columns: 1fr; }
      }

      /* ========== AI ANALYTICS & SEO STYLES ========== */
      .ai-section { margin-top: 24px; }
      .ai-status-badge, .seo-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: #fff;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }
      .seo-status-badge {
        background: linear-gradient(135deg, #10b981, #059669);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      
      /* AI Insights Grid */
      .ai-insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .ai-insight-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        gap: 16px;
        align-items: flex-start;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .ai-insight-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      .ai-insight-card.positive { border-left: 4px solid #10b981; }
      .ai-insight-card.warning { border-left: 4px solid #f59e0b; }
      .ai-insight-card.critical { border-left: 4px solid #ef4444; }
      .ai-insight-card.loading { opacity: 0.6; }
      .insight-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }
      .ai-insight-card.positive .insight-icon { background: #d1fae5; color: #059669; }
      .ai-insight-card.warning .insight-icon { background: #fef3c7; color: #d97706; }
      .ai-insight-card.critical .insight-icon { background: #fee2e2; color: #dc2626; }
      .ai-insight-card.loading .insight-icon { background: #f3f4f6; color: #6b7280; }
      .insight-content h4 { margin: 0 0 6px; font-size: 1rem; color: #1f2937; }
      .insight-content p { margin: 0 0 8px; font-size: 0.85rem; color: #6b7280; }
      .insight-confidence {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: #9ca3af;
        background: #f3f4f6;
        padding: 4px 10px;
        border-radius: 12px;
      }
      
      /* AI Section Blocks */
      .ai-section-block {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
      }
      .ai-block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f3f4f6;
      }
      .ai-block-header h3 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #1f2937;
      }
      .ai-badge {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: #fff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      
      /* Predictions Chart */
      .predictions-chart {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        height: 200px;
        padding: 20px 0;
      }
      .prediction-bar {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .prediction-bar .bar {
        width: 100%;
        max-width: 60px;
        background: linear-gradient(180deg, #8b5cf6, #6366f1);
        border-radius: 6px 6px 0 0;
        position: relative;
        min-height: 10px;
        transition: height 0.5s ease;
      }
      .prediction-bar .bar.actual {
        background: linear-gradient(180deg, #10b981, #059669);
      }
      .prediction-bar .value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
      }
      .prediction-bar .date {
        font-size: 0.7rem;
        color: #9ca3af;
      }
      .prediction-loading {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
      }
      
      /* Anomalies List */
      .anomalies-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .anomaly-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #fef2f2;
        border-radius: 10px;
        border-left: 4px solid #ef4444;
      }
      .anomaly-item.warning {
        background: #fffbeb;
        border-left-color: #f59e0b;
      }
      .anomaly-item i { font-size: 1.3rem; color: #ef4444; }
      .anomaly-item.warning i { color: #f59e0b; }
      .anomaly-info { flex: 1; }
      .anomaly-info .metric { font-weight: 600; color: #1f2937; }
      .anomaly-info .details { font-size: 0.85rem; color: #6b7280; }
      .no-anomalies {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 20px;
        color: #10b981;
        background: #d1fae5;
        border-radius: 10px;
      }
      .no-anomalies i { font-size: 1.5rem; }
      .anomaly-count {
        background: #fee2e2;
        color: #dc2626;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      
      /* Segments Grid */
      .segments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 16px;
      }
      .segment-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
      }
      .segment-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .segment-card i { font-size: 2rem; margin-bottom: 10px; }
      .segment-card.champions { border-top: 4px solid #f59e0b; }
      .segment-card.champions i { color: #f59e0b; }
      .segment-card.loyal { border-top: 4px solid #ef4444; }
      .segment-card.loyal i { color: #ef4444; }
      .segment-card.at-risk { border-top: 4px solid #8b5cf6; }
      .segment-card.at-risk i { color: #8b5cf6; }
      .segment-card.new { border-top: 4px solid #10b981; }
      .segment-card.new i { color: #10b981; }
      .segment-name { display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 6px; }
      .segment-count { display: block; font-size: 1.5rem; font-weight: 700; color: #1f2937; }
      
      /* Conversion Funnel */
      .funnel-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .funnel-stage {
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        color: #fff;
        padding: 16px 20px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: var(--width, 100%);
        margin: 0 auto;
        transition: width 0.5s ease;
      }
      .stage-name { font-weight: 500; }
      .stage-count { font-weight: 700; font-size: 1.1rem; }
      .funnel-bottleneck {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #fef3c7;
        border-radius: 8px;
        margin-top: 16px;
        color: #92400e;
      }
      .funnel-bottleneck i { color: #f59e0b; }
      .conversion-rate {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      
      /* SEO Score Card */
      .seo-score-card {
        display: flex;
        align-items: center;
        gap: 30px;
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 24px;
        border: 1px solid #bbf7d0;
      }
      .score-circle {
        position: relative;
        width: 120px;
        height: 120px;
        flex-shrink: 0;
      }
      .score-circle svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }
      .score-bg {
        fill: none;
        stroke: #d1fae5;
        stroke-width: 8;
      }
      .score-fill {
        fill: none;
        stroke: #10b981;
        stroke-width: 8;
        stroke-linecap: round;
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 1s ease;
      }
      .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: 700;
        color: #065f46;
      }
      .score-details h3 { margin: 0 0 8px; font-size: 1.3rem; color: #065f46; }
      .score-details p { margin: 0; color: #047857; font-size: 0.95rem; }
      
      /* Keyword Categories */
      .keyword-categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }
      .keyword-category {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
      }
      .keyword-category:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .keyword-category i { font-size: 2rem; color: #6366f1; margin-bottom: 10px; display: block; }
      .cat-name { display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 6px; }
      .cat-count { display: block; font-size: 1.5rem; font-weight: 700; color: #1f2937; }
      
      /* Trending Keywords */
      .trending-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .keyword-tag {
        background: linear-gradient(135deg, #ede9fe, #ddd6fe);
        color: #6d28d9;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: default;
      }
      .keyword-tag:hover { transform: scale(1.05); }
      .keyword-tag.hot {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
      }
      .keyword-tag.loading { background: #f3f4f6; color: #9ca3af; }
      
      /* SEO Recommendations */
      .seo-recommendations {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .recommendation-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: #f8fafc;
        border-radius: 10px;
        border-left: 4px solid #6366f1;
      }
      .recommendation-item i { font-size: 1.3rem; color: #6366f1; }
      .recommendation-item.success { border-left-color: #10b981; }
      .recommendation-item.success i { color: #10b981; }
      .recommendation-item.warning { border-left-color: #f59e0b; }
      .recommendation-item.warning i { color: #f59e0b; }
      .spinning { animation: spin 1s linear infinite; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      
      /* AI Mobile Responsive */
      @media (max-width: 768px) {
        .ai-insights-grid { grid-template-columns: 1fr; }
        .segments-grid { grid-template-columns: repeat(2, 1fr); }
        .keyword-categories-grid { grid-template-columns: repeat(2, 1fr); }
        .seo-score-card { flex-direction: column; text-align: center; padding: 24px; }
        .score-circle { margin: 0 auto; }
        .predictions-chart { height: 160px; overflow-x: auto; }
        .funnel-stage { width: 100% !important; }
        .ai-block-header { flex-direction: column; align-items: flex-start; gap: 10px; }
      }
      @media (max-width: 480px) {
        .segments-grid { grid-template-columns: 1fr; }
        .keyword-categories-grid { grid-template-columns: 1fr; }
        .ai-status-badge, .seo-status-badge { font-size: 0.75rem; padding: 6px 12px; }
      }
      /* ========== END AI STYLES ========== */

      /* Toggle Switch Styles */
      .toggle-switch-label {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #374151;
      }
      .toggle-switch-label input {
        display: none;
      }
      .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        background: #e5e7eb;
        border-radius: 24px;
        transition: all 0.3s ease;
      }
      .toggle-switch::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
      }
      .toggle-switch-label input:checked + .toggle-switch {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .toggle-switch-label input:checked + .toggle-switch::before {
        transform: translateX(20px);
      }
      
      /* Master Section Toggle */
      .master-toggle {
        background: rgba(255,255,255,0.9);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-right: 12px;
      }
      .master-toggle span:last-child {
        font-size: 0.8rem;
        color: #6b7280;
      }
      .section-disabled {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
      }
      .section-disabled::after {
        content: 'Section Disabled';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 16px 32px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 100;
      }

      /* Marketing & Shipping & Tax Tabs */
      .marketing-tabs, .shipping-tabs, .tax-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
        flex-wrap: wrap;
      }
      .tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        background: transparent;
        border: none;
        border-radius: 8px 8px 0 0;
        font-size: 0.85rem;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tab-btn:hover {
        background: #f3f4f6;
        color: #374151;
      }
      .tab-btn.active {
        background: #0f172a;
        color: #fff;
      }
      .marketing-tab-content, .shipping-tab-content, .tax-tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
      }
      .marketing-tab-content.active, .shipping-tab-content.active, .tax-tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Data Table */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th, .data-table td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.85rem;
      }
      .data-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
      }
      .data-table tr:hover {
        background: #fafbfc;
      }
      .data-table .status-active {
        display: inline-block;
        padding: 4px 10px;
        background: #d1fae5;
        color: #065f46;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .data-table .status-inactive {
        display: inline-block;
        padding: 4px 10px;
        background: #fee2e2;
        color: #991b1b;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .data-table .status-expired {
        display: inline-block;
        padding: 4px 10px;
        background: #f3f4f6;
        color: #6b7280;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* Couriers Grid */
      .couriers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
      }
      .courier-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
      }
      .courier-card.active {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      }
      .courier-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .courier-card-header h4 {
        margin: 0;
        font-size: 1rem;
        color: #1f2937;
      }
      .courier-priority {
        font-size: 0.75rem;
        color: #6b7280;
        background: #f3f4f6;
        padding: 2px 8px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header class="admin-header">
      <div class="nav-container">
        <div class="nav-logo">
          <a href="index.html">
            <img src="assets/img/BLACKONN 004_page-0001.png" alt="BLACKONN" />
          </a>
        </div>
        <div class="header-actions">
          <div id="apiStatusIndicator" class="api-status offline" title="Backend connection status">
            <span class="status-dot"></span>
            <span class="status-text">Offline</span>
          </div>
          <a href="index.html" class="view-store-btn" target="_blank"><i class="ri-external-link-line"></i> View Store</a>
          <a href="#" class="logout-btn" id="adminLogoutBtn"><i class="ri-logout-box-r-line"></i> Logout</a>
        </div>
      </div>
    </header>

    <!-- API Client for Full-Stack Mode -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/security.js"></script>
    <script>
      // Global Notification Helper Fallback
      window.showNotification = window.showNotification || window.showToast || function(m, t) { 
        console.log(`[Notification] ${t}: ${m}`);
        if (typeof AdminUniModal !== 'undefined' && AdminUniModal.show) {
          // If no toast system, we can't show anything here safely without recursion
        } else {
          alert(m);
        }
      };

      // Ensure a generic notification helper is available for admin UI
      // Use the global showNotification from api.js for consistent Dynamic Island style
      if (!window.showNotification && window.showToast) {
        window.showNotification = window.showToast;
      }

      // Reusable confirm modal function (replaces native confirm dialogs)
      window.showConfirmModal = function(options) {
        return new Promise((resolve) => {
          const {
            title = 'Confirm Action',
            message = 'Are you sure you want to proceed?',
            confirmText = 'Yes, Confirm',
            cancelText = 'Cancel',
            type = 'warning', // 'warning', 'danger', 'info'
            icon = null,
            event = null
          } = typeof options === 'string' ? { message: options } : options;
          
          const iconMap = {
            warning: 'ri-alert-line',
            danger: 'ri-delete-bin-line',
            info: 'ri-information-line'
          };
          const colorMap = {
            warning: { bg: '#fef3c7', border: '#f59e0b', icon: '#d97706' },
            danger: { bg: '#fee2e2', border: '#f87171', icon: '#dc2626' },
            info: { bg: '#dbeafe', border: '#60a5fa', icon: '#2563eb' }
          };
          const colors = colorMap[type] || colorMap.warning;
          const modalIcon = icon || iconMap[type] || iconMap.warning;
          
          const modal = document.createElement('div');
          modal.className = 'modal-overlay confirm-modal-overlay';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100000;animation:fadeIn 0.2s ease;';
          
          modal.innerHTML = `
            <div class="confirm-modal-content" style="background:#fff;border-radius:16px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideUp 0.3s ease;overflow:hidden;position:relative;">
              <div style="padding:24px 24px 16px;text-align:center;">
                <div style="width:64px;height:64px;background:${colors.bg};border:2px solid ${colors.border};border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                  <i class="${modalIcon}" style="font-size:28px;color:${colors.icon};"></i>
                </div>
                <h3 style="margin:0 0 8px;font-size:1.25rem;color:#1f2937;font-weight:600;">${title}</h3>
                <p style="color:#6b7280;margin:0;font-size:0.95rem;line-height:1.5;">${message}</p>
              </div>
              <div style="display:flex;gap:12px;padding:16px 24px 24px;justify-content:center;">
                <button type="button" class="confirm-modal-cancel" style="padding:12px 24px;border-radius:8px;font-weight:600;background:#fff;border:1.5px solid #d1d5db;color:#374151;cursor:pointer;transition:all 0.2s ease;min-width:100px;">
                  ${cancelText}
                </button>
                <button type="button" class="confirm-modal-confirm" style="padding:12px 24px;border-radius:8px;font-weight:600;background:${type === 'danger' ? 'linear-gradient(135deg, #dc2626, #b91c1c)' : 'linear-gradient(135deg, #0f172a, #1e293b)'};border:none;color:#fff;cursor:pointer;transition:all 0.2s ease;min-width:100px;box-shadow:0 4px 12px ${type === 'danger' ? 'rgba(220,38,38,0.3)' : 'rgba(15,23,42,0.25)'};">
                  ${confirmText}
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const cancelBtn = modal.querySelector('.confirm-modal-cancel');
          const confirmBtn = modal.querySelector('.confirm-modal-confirm');
          
          // Hover effects
          cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f3f4f6';
            cancelBtn.style.borderColor = '#9ca3af';
          });
          cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = '#fff';
            cancelBtn.style.borderColor = '#d1d5db';
          });
          confirmBtn.addEventListener('mouseenter', () => {
            confirmBtn.style.transform = 'translateY(-2px)';
            confirmBtn.style.boxShadow = type === 'danger' ? '0 6px 20px rgba(220,38,38,0.4)' : '0 6px 20px rgba(15,23,42,0.35)';
          });
          confirmBtn.addEventListener('mouseleave', () => {
            confirmBtn.style.transform = 'translateY(0)';
            confirmBtn.style.boxShadow = type === 'danger' ? '0 4px 12px rgba(220,38,38,0.3)' : '0 4px 12px rgba(15,23,42,0.25)';
          });
          
          // Event handlers
          cancelBtn.addEventListener('click', () => {
            modal.remove();
            resolve(false);
          });
          
          confirmBtn.addEventListener('click', () => {
            modal.remove();
            resolve(true);
          });
          
          // Close on overlay click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
              resolve(false);
            }
          });
          
          // Close on Escape key
          const handleEscape = (e) => {
            if (e.key === 'Escape') {
              modal.remove();
              resolve(false);
              document.removeEventListener('keydown', handleEscape);
            }
          };
          document.addEventListener('keydown', handleEscape);
          
          // Focus confirm button
          confirmBtn.focus();
        });
      };
    </script>
    <script>
        // Define logoutAdmin function first before using it
        async function logoutAdmin() {
          try {
            showNotification('Logging out...', 'info');
            await fetch('/api/auth/logout', {
              method: 'POST',
              credentials: 'include'
            });
          } catch (e) {
            console.error('Logout error:', e);
          }
          window.location.href = 'login.html';
        }
        
        // Initialize authentication
        window.blackonnAuth = new BlackonnAuth();
        try { window.blackonnAuth._initAuth(); } catch (e) { /* ignore */ }
        
        // Auto-logout for admin after 24 hours of inactivity
        let lastAdminActivity = Date.now();
        function resetAdminActivityTimer() {
          lastAdminActivity = Date.now();
        }
        ['click','mousemove','keydown','scroll','touchstart'].forEach(evt => {
          window.addEventListener(evt, resetAdminActivityTimer, true);
        });
        setInterval(() => {
          if (Date.now() - lastAdminActivity > 24 * 60 * 60 * 1000) { // 24 hours
            logoutAdmin();
          }
        }, 10000); // check every 10 seconds
        
        // API-only admin access check (uses BlackonnAuth and a small retry when a recent login marker exists)
        (async function enforceAdminAccess() {
          try {
            // Prefer BlackonnAuth which caches and uses httpOnly cookies
            const user = await (window.blackonnAuth && window.blackonnAuth.getCurrentUser ? window.blackonnAuth.getCurrentUser(true) : null);
            if (!user || user.role !== 'admin') {
              throw new Error('Not authorized');
            }
          } catch (error) {
            // If a recent login marker exists, retry once (covers brief timing issues during navigation)
            try {
              const marker = (() => { try { return localStorage.getItem('blackonn_logged_in'); } catch(e) { return null; } })();
              if (marker && window.blackonnAuth && window.blackonnAuth.getCurrentUser) {
                // short delay then retry
                await new Promise(res => setTimeout(res, 300));
                try {
                  const user2 = await window.blackonnAuth.getCurrentUser(true);
                  if (user2 && user2.role === 'admin') return;
                } catch (e) {
                  // continue to redirect below
                }
              }
            } catch (e) {
              // ignore
            }

            console.error('Admin access denied:', error);
            window.location.href = 'login.html';
          }
        })();
        
        // Show logout confirmation modal
        function showLogoutModal() {
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.id = 'logoutModal';
          modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center;">
              <div class="modal-header" style="justify-content: center; border-bottom: none; padding-bottom: 0;">
                <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                  <i class="ri-logout-box-r-line" style="font-size: 32px; color: #dc2626;"></i>
                </div>
              </div>
              <div class="modal-body" style="padding-top: 0;">
                <h3 style="margin: 0 0 8px; font-size: 1.4rem; color: #1f2937;">Logout Confirmation</h3>
                <p style="color: #6b7280; margin: 0 0 24px;">Are you sure you want to logout from the admin panel?</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                  <button type="button" class="secondary" id="logoutCancelBtn" style="padding: 12px 32px; border-radius: 8px; font-weight: 600;">
                    <i class="ri-close-line"></i> No, Stay
                  </button>
                  <button type="button" class="primary" id="logoutConfirmBtn" style="padding: 12px 32px; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #dc2626, #b91c1c);">
                    <i class="ri-logout-box-r-line"></i> Yes, Logout
                  </button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Attach event listeners
          document.getElementById('logoutCancelBtn').addEventListener('click', () => {
            modal.remove();
          });
          
          document.getElementById('logoutConfirmBtn').addEventListener('click', () => {
            modal.remove();
            logoutAdmin();
          });
          
          // Close on overlay click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }
        
        // Attach logout button event listener
        document.getElementById('adminLogoutBtn')?.addEventListener('click', (e) => {
          e.preventDefault();
          showLogoutModal();
        });
    </script>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    
    <!-- Mobile Floating Action Button with Quick Menu -->
    <div class="mobile-fab" id="mobileFab">
      <div class="mobile-quick-menu" id="mobileQuickMenu">
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">Main</div>
          <button class="mobile-menu-item active" data-section="dashboard"><i class="ri-dashboard-line"></i> Dashboard</button>
          <button class="mobile-menu-item" data-section="products"><i class="ri-shopping-bag-line"></i> Products</button>
          <button class="mobile-menu-item" data-section="orders"><i class="ri-file-list-3-line"></i> Orders</button>
          <button class="mobile-menu-item" data-section="product-costs"><i class="ri-coins-line"></i> Product Costs</button>
          <button class="mobile-menu-item" data-section="slider"><i class="ri-slideshow-line"></i> Slider</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">RMA</div>
          <button class="mobile-menu-item" data-section="returns"><i class="ri-arrow-go-back-line"></i> Returns</button>
          <button class="mobile-menu-item" data-section="exchanges"><i class="ri-exchange-line"></i> Exchanges</button>
          <button class="mobile-menu-item" data-section="cancellations"><i class="ri-close-circle-line"></i> Cancellations</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">CRM</div>
          <button class="mobile-menu-item" data-section="users"><i class="ri-user-line"></i> Users</button>
          <button class="mobile-menu-item" data-section="deleted-users"><i class="ri-user-unfollow-line"></i> Deleted Users</button>
          <button class="mobile-menu-item" data-section="password-reset-management"><i class="ri-key-2-line"></i> Password Resets</button>
          <button class="mobile-menu-item" data-section="messages"><i class="ri-mail-line"></i> Messages</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">Manage</div>
          <button class="mobile-menu-item" data-section="sku-management"><i class="ri-barcode-line"></i> SKU & Barcode</button>
          <button class="mobile-menu-item" data-section="inventory-management"><i class="ri-stock-line"></i> Inventory</button>
          <button class="mobile-menu-item" data-section="marketing-management"><i class="ri-megaphone-line"></i> Marketing</button>
          <button class="mobile-menu-item" data-section="shipping-management"><i class="ri-truck-line"></i> Shipping</button>
          <button class="mobile-menu-item" data-section="tax-management"><i class="ri-percent-line"></i> Tax & GST</button>
          <button class="mobile-menu-item" data-section="company-tax"><i class="ri-building-line"></i> Company Tax</button>
          <button class="mobile-menu-item" data-section="gift-cards"><i class="ri-gift-line"></i> Gift Cards</button>
          <button class="mobile-menu-item" data-section="newsletter"><i class="ri-mail-send-line"></i> Newsletter</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">Analytics</div>
          <button class="mobile-menu-item" data-section="traffic-analytics"><i class="ri-line-chart-line"></i> Traffic</button>
          <button class="mobile-menu-item" data-section="sales-insights"><i class="ri-money-dollar-circle-line"></i> Sales Insights</button>
          <button class="mobile-menu-item" data-section="health"><i class="ri-heart-pulse-line"></i> System Health</button>
          <button class="mobile-menu-item" data-section="ai-health-dashboard"><i class="ri-pulse-line"></i> AI Health</button>
          <button class="mobile-menu-item" data-section="ai-analytics"><i class="ri-robot-2-line"></i> AI Analytics</button>
          <button class="mobile-menu-item" data-section="ai-seo"><i class="ri-seo-line"></i> AI SEO</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">Advanced</div>
          <button class="mobile-menu-item" data-section="realtime-manager"><i class="ri-live-line"></i> Real-Time</button>
          <button class="mobile-menu-item" data-section="security-manager"><i class="ri-shield-check-line"></i> Security</button>
          <button class="mobile-menu-item" data-section="ml-engine"><i class="ri-brain-line"></i> ML Engine</button>
          <button class="mobile-menu-item" data-section="error-tracker"><i class="ri-bug-line"></i> Error Tracker</button>
          <button class="mobile-menu-item" data-section="ab-testing"><i class="ri-test-tube-line"></i> A/B Testing</button>
          <button class="mobile-menu-item" data-section="performance-optimizer"><i class="ri-speed-line"></i> Performance</button>
          <button class="mobile-menu-item" data-section="pwa-manager"><i class="ri-smartphone-line"></i> PWA Manager</button>
        </div>
        <div class="mobile-menu-group">
          <div class="mobile-menu-group-title">AI Tech</div>
          <button class="mobile-menu-item" data-section="emotion-ai"><i class="ri-emotion-line"></i> Emotion AI</button>
          <button class="mobile-menu-item" data-section="biometric-auth"><i class="ri-fingerprint-line"></i> Biometric Auth</button>
          <button class="mobile-menu-item" data-section="neural-commerce"><i class="ri-brain-line"></i> Neural Commerce</button>
        </div>
      </div>
      <button class="mobile-fab-btn" id="mobileFabBtn">
        <i class="ri-apps-2-line fab-icon-open"></i>
        <i class="ri-close-line fab-icon-close" style="display: none;"></i>
      </button>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" title="Back to Top" onclick="scrollToTop()">
      <i class="ri-arrow-up-line"></i>
    </button>

    <div class="admin-layout">
      <!-- Admin Sidebar -->
      <aside class="admin-sidebar" id="adminSidebar">
        <ul class="sidebar-menu">
          <!-- Main Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">Main</div>
            <li><a href="#" class="active" data-section="dashboard"><i class="ri-dashboard-line"></i><span class="menu-text">Dashboard</span></a></li>
            <li><a href="#" data-section="products"><i class="ri-shopping-bag-line"></i><span class="menu-text">Products</span></a></li>
            <li><a href="#" data-section="orders"><i class="ri-file-list-3-line"></i><span class="menu-text">Orders</span></a></li>
            <li><a href="#" data-section="product-costs"><i class="ri-coins-line"></i><span class="menu-text">Product Costs</span></a></li>
            <li><a href="#" data-section="slider"><i class="ri-slideshow-line"></i><span class="menu-text">Slider</span></a></li>
          </div>
          
          <!-- RMA Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">RMA</div>
            <li><a href="#" data-section="returns"><i class="ri-arrow-go-back-line"></i><span class="menu-text">Returns</span></a></li>
            <li><a href="#" data-section="exchanges"><i class="ri-exchange-line"></i><span class="menu-text">Exchanges</span></a></li>
            <li><a href="#" data-section="cancellations"><i class="ri-close-circle-line"></i><span class="menu-text">Cancellations</span></a></li>
          </div>
          
          <!-- CRM Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">CRM</div>
            <li><a href="#" data-section="users"><i class="ri-user-line"></i><span class="menu-text">Users</span></a></li>
            <li><a href="#" data-section="deleted-users"><i class="ri-user-unfollow-line"></i><span class="menu-text">Deleted Users</span></a></li>
            <li><a href="#" data-section="password-reset-management"><i class="ri-key-2-line"></i><span class="menu-text">Password Resets</span></a></li>
            <li><a href="#" data-section="messages" id="sidebarMessages"><i class="ri-mail-line"></i><span class="menu-text">Messages</span><span class="badge" id="messagesBadge" style="display:none;">0</span></a></li>
          </div>
          
          <!-- Manage Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">Manage</div>
            <li><a href="#" data-section="sku-management"><i class="ri-barcode-line"></i><span class="menu-text">SKU & Barcode</span></a></li>
            <li><a href="#" data-section="inventory-management"><i class="ri-stock-line"></i><span class="menu-text">Inventory</span></a></li>
            <li><a href="#" data-section="marketing-management"><i class="ri-megaphone-line"></i><span class="menu-text">Marketing</span></a></li>
            <li><a href="#" data-section="shipping-management"><i class="ri-truck-line"></i><span class="menu-text">Shipping</span></a></li>
            <li><a href="#" data-section="tax-management"><i class="ri-percent-line"></i><span class="menu-text">Tax & GST</span></a></li>
            <li><a href="#" data-section="company-tax"><i class="ri-building-line"></i><span class="menu-text">Company Tax</span></a></li>
            <li><a href="#" data-section="gift-cards"><i class="ri-gift-line"></i><span class="menu-text">Gift Cards</span></a></li>
            <li><a href="#" data-section="newsletter"><i class="ri-mail-send-line"></i><span class="menu-text">Newsletter</span></a></li>
          </div>
          
          <!-- Analytics Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">Analytics</div>
            <li><a href="#" data-section="traffic-analytics"><i class="ri-line-chart-line"></i><span class="menu-text">Traffic</span></a></li>
            <li><a href="#" data-section="sales-insights"><i class="ri-money-dollar-circle-line"></i><span class="menu-text">Sales Insights</span></a></li>
            <li><a href="#" data-section="health"><i class="ri-heart-pulse-line"></i><span class="menu-text">System Health</span></a></li>
            <li><a href="#" data-section="ai-analytics"><i class="ri-robot-2-line"></i><span class="menu-text">AI Analytics</span></a></li>
            <li><a href="#" data-section="ai-seo"><i class="ri-seo-line"></i><span class="menu-text">AI SEO</span></a></li>
            <li><a href="#" data-section="ai-health-dashboard"><i class="ri-pulse-line"></i><span class="menu-text">AI Health</span></a></li>
          </div>
          
          <!-- Advanced Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">Advanced</div>
            <li><a href="#" data-section="realtime-manager"><i class="ri-live-line"></i><span class="menu-text">Real-Time</span></a></li>
            <li><a href="#" data-section="security-manager"><i class="ri-shield-check-line"></i><span class="menu-text">Security</span></a></li>
            <li><a href="#" data-section="ml-engine"><i class="ri-brain-line"></i><span class="menu-text">ML Engine</span></a></li>
            <li><a href="#" data-section="error-tracker"><i class="ri-bug-line"></i><span class="menu-text">Error Tracker</span></a></li>
            <li><a href="#" data-section="ab-testing"><i class="ri-test-tube-line"></i><span class="menu-text">A/B Testing</span></a></li>
            <li><a href="#" data-section="performance-optimizer"><i class="ri-speed-line"></i><span class="menu-text">Performance</span></a></li>
            <li><a href="#" data-section="pwa-manager"><i class="ri-smartphone-line"></i><span class="menu-text">PWA Manager</span></a></li>
          </div>
          
          <!-- AI Tech Group -->
          <div class="sidebar-menu-group">
            <div class="sidebar-group-title">AI Tech</div>
            <li><a href="#" data-section="emotion-ai"><i class="ri-emotion-line"></i><span class="menu-text">Emotion AI</span></a></li>
            <li><a href="#" data-section="biometric-auth"><i class="ri-fingerprint-line"></i><span class="menu-text">Biometric Auth</span></a></li>
            <li><a href="#" data-section="neural-commerce"><i class="ri-brain-line"></i><span class="menu-text">Neural Commerce</span></a></li>
          </div>
        </ul>
      </aside>

      <!-- Admin Main Content -->
      <div class="admin-main">
        <section id="dashboard" class="admin-section active">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-bar-chart-box-line"></i> Performance Insights</h2>
            <small>Real-time overview of your store metrics</small>
          </div>
          <span class="pill" id="statsUpdated">Updated now</span>
        </div>
        <div class="insights-grid" id="insightsGrid"></div>
      </section>

      <!-- Traffic Analytics Section -->
      <section id="traffic-analytics" class="admin-section traffic-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-line-chart-line"></i> Website Traffic</h2>
            <small>Monitor your website visitors and page views</small>
          </div>
          <div class="section-header-right">
            <div class="realtime-indicator">
              <span class="pulse"></span>
              <span id="realtimeVisitors">0</span> active now
            </div>
            <button class="btn-export hover-lift" id="refreshTrafficBtn" title="Refresh traffic data">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Traffic Stats Cards -->
        <div class="traffic-stats-grid" id="trafficStatsGrid">
          <div class="traffic-stat-card highlight">
            <span class="stat-value" id="todayVisits">0</span>
            <span class="stat-label">Today's Visits</span>
            <span class="stat-change up" id="todayChange"><i class="ri-arrow-up-line"></i> 0%</span>
          </div>
          <div class="traffic-stat-card">
            <span class="stat-value" id="totalVisits">0</span>
            <span class="stat-label">Total Visits (7 days)</span>
          </div>
          <div class="traffic-stat-card">
            <span class="stat-value" id="uniqueVisitors">0</span>
            <span class="stat-label">Unique Visitors</span>
          </div>
          <div class="traffic-stat-card">
            <span class="stat-value" id="avgVisits">0</span>
            <span class="stat-label">Avg. Visits/Day</span>
          </div>
        </div>

        <!-- Traffic Chart -->
        <div class="traffic-chart-container">
          <div class="traffic-chart-header">
            <h3><i class="ri-bar-chart-2-line"></i> Daily Visits</h3>
            <div class="chart-period-selector">
              <button class="active" data-days="7">7 Days</button>
              <button data-days="14">14 Days</button>
              <button data-days="30">30 Days</button>
            </div>
          </div>
          <div class="traffic-chart" id="trafficChart">
            <!-- Chart bars will be rendered here -->
          </div>
          <div class="chart-labels" id="chartLabels">
            <!-- Date labels will be rendered here -->
          </div>
        </div>

        <!-- Traffic Details -->
        <div class="traffic-details-grid">
          <!-- Top Pages -->
          <div class="traffic-detail-card">
            <h4><i class="ri-pages-line"></i> Top Pages</h4>
            <div class="detail-list" id="topPagesList">
              <div class="detail-item">
                <span class="label">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Devices -->
          <div class="traffic-detail-card">
            <h4><i class="ri-device-line"></i> Devices</h4>
            <div class="detail-list" id="devicesList">
              <div class="detail-item">
                <span class="label">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Browsers -->
          <div class="traffic-detail-card">
            <h4><i class="ri-global-line"></i> Browsers</h4>
            <div class="detail-list" id="browsersList">
              <div class="detail-item">
                <span class="label">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Traffic Sources -->
          <div class="traffic-detail-card">
            <h4><i class="ri-share-forward-line"></i> Traffic Sources</h4>
            <div class="detail-list" id="referrersList">
              <div class="detail-item">
                <span class="label">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Sales Insights Section -->
      <section id="sales-insights" class="admin-section sales-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-money-dollar-circle-line"></i> Sales Insights</h2>
            <small>Comprehensive overview of your store's sales performance</small>
          </div>
          <div class="section-header-right">
            <button class="btn-export" id="refreshSalesBtn" title="Refresh sales data">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="btn-export" id="exportSalesBtn" title="Export sales report">
              <i class="ri-download-line"></i> Export
            </button>
          </div>
        </div>

        <!-- Sales Stats Cards -->
        <div class="sales-stats-grid" id="salesStatsGrid">
          <div class="sales-stat-card highlight">
            <span class="stat-value" id="totalRevenue">0</span>
            <span class="stat-label">Total Revenue</span>
            <span class="stat-change up" id="revenueChange"><i class="ri-arrow-up-line"></i> 0%</span>
          </div>
          <div class="sales-stat-card">
            <span class="stat-value" id="totalOrders">0</span>
            <span class="stat-label">Total Orders</span>
            <span class="stat-change" id="ordersChange"></span>
          </div>
          <div class="sales-stat-card">
            <span class="stat-value" id="avgOrderValue">0</span>
            <span class="stat-label">Avg. Order Value</span>
          </div>
          <div class="sales-stat-card">
            <span class="stat-value" id="todaySales">0</span>
            <span class="stat-label">Today's Sales</span>
          </div>
          <div class="sales-stat-card">
            <span class="stat-value" id="weekSales">0</span>
            <span class="stat-label">This Week</span>
          </div>
          <div class="sales-stat-card">
            <span class="stat-value" id="monthSales">0</span>
            <span class="stat-label">This Month</span>
          </div>
        </div>

        <!-- Sales Chart & Top Products Row -->
        <div class="sales-charts-row">
          <!-- Revenue Chart -->
          <div class="sales-chart-container">
            <div class="sales-chart-header">
              <h3><i class="ri-line-chart-line"></i> Revenue Trend</h3>
              <div class="sales-period-selector" id="salesPeriodSelector">
                <button class="active" data-days="7">7 Days</button>
                <button data-days="14">14 Days</button>
                <button data-days="30">30 Days</button>
              </div>
            </div>
            <div class="sales-bar-chart" id="salesBarChart">
              <!-- Chart bars will be rendered here -->
            </div>
            <div class="chart-labels" id="salesChartLabels">
              <!-- Date labels will be rendered here -->
            </div>
          </div>

          <!-- Top Selling Products -->
          <div class="sales-chart-container">
            <div class="sales-chart-header">
              <h3><i class="ri-trophy-line"></i> Top Selling Products</h3>
            </div>
            <div class="top-products-list" id="topProductsList">
              <!-- Top products will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Sales Summary Cards -->
        <div class="sales-summary-grid">
          <!-- Order Status Breakdown -->
          <div class="sales-summary-card">
            <h4><i class="ri-shopping-bag-3-line"></i> Order Status</h4>
            <div id="orderStatusList">
              <div class="summary-item">
                <span class="label"><i class="ri-time-line"></i> Pending</span>
                <span class="value" id="pendingOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-checkbox-circle-line"></i> Confirmed</span>
                <span class="value success" id="confirmedOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-truck-line"></i> Shipped</span>
                <span class="value" id="shippedOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-check-double-line"></i> Delivered</span>
                <span class="value success" id="deliveredOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-close-circle-line"></i> Cancelled</span>
                <span class="value danger" id="cancelledOrders">0</span>
              </div>
            </div>
          </div>

          <!-- Payment Summary -->
          <div class="sales-summary-card">
            <h4><i class="ri-bank-card-line"></i> Payment Summary</h4>
            <div id="paymentSummaryList">
              <div class="summary-item">
                <span class="label"><i class="ri-check-line"></i> Paid Orders</span>
                <span class="value success" id="paidOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-time-line"></i> Awaiting Payment</span>
                <span class="value warning" id="unpaidOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-qr-code-line"></i> UPI Orders</span>
                <span class="value" id="upiOrders">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-money-rupee-circle-line"></i> COD Orders</span>
                <span class="value" id="codOrders">0</span>
              </div>
            </div>
          </div>

          <!-- Revenue Breakdown -->
          <div class="sales-summary-card">
            <h4><i class="ri-pie-chart-line"></i> Revenue Breakdown</h4>
            <div id="revenueBreakdownList">
              <div class="summary-item">
                <span class="label"><i class="ri-wallet-3-line"></i> Subtotal</span>
                <span class="value" id="totalSubtotal">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-truck-line"></i> Shipping Revenue</span>
                <span class="value" id="totalShipping">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-arrow-go-back-line"></i> Returns Value</span>
                <span class="value danger" id="totalReturns">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-funds-line"></i> Net Revenue</span>
                <span class="value success" id="netRevenue">0</span>
              </div>
            </div>
          </div>

          <!-- Profit/Loss Analysis -->
          <div class="sales-summary-card">
            <h4><i class="ri-line-chart-line"></i> Profit / Loss Analysis</h4>
            <div id="profitLossList">
              <div class="summary-item">
                <span class="label"><i class="ri-money-rupee-circle-line"></i> Total Revenue</span>
                <span class="value" id="plTotalRevenue">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-shopping-basket-2-line"></i> Cost of Goods <span id="plCostMode" style="font-size: 0.65rem; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">Est.</span></span>
                <span class="value" id="plCostOfGoods">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-stack-line"></i> Items Sold</span>
                <span class="value" id="plItemsSold">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-building-2-line"></i> Operational Costs</span>
                <span class="value" id="plOperationalCosts">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-arrow-go-back-line"></i> Refunds/Returns</span>
                <span class="value danger" id="plRefunds">0</span>
              </div>
              <div class="summary-item" style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 8px;">
                <span class="label"><i class="ri-bar-chart-grouped-line"></i> <strong>Gross Profit</strong></span>
                <span class="value success" id="plGrossProfit" style="font-size: 1.1rem;">0</span>
              </div>
              <div class="summary-item">
                <span class="label"><i class="ri-percent-line"></i> Profit Margin</span>
                <span class="value" id="plProfitMargin">0%</span>
              </div>
            </div>
            <small style="display: block; margin-top: 12px; color: #9ca3af; font-size: 0.75rem;">
              <i class="ri-information-line"></i> Cost estimation uses your configured product costs. <a href="#product-costs" style="color: #3b82f6;">Configure costs</a>
            </small>
          </div>

          <!-- Sales by Location -->
          <div class="sales-summary-card">
            <h4><i class="ri-map-pin-line"></i> Top Locations</h4>
            <div id="topLocationsList">
              <!-- Top locations will be rendered here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Product Cost Settings Section -->
      <section id="product-costs" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-money-rupee-circle-line"></i> Product Cost Settings</h2>
            <small>Configure actual costs per product for accurate profit/loss analysis</small>
          </div>
          <div class="section-header-right">
            <button class="btn-secondary" id="refreshProductCostsBtn" title="Refresh">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="btn-export" id="addNewProductCostBtn" title="Add Product Cost Profile">
              <i class="ri-add-line"></i> Add Product
            </button>
          </div>
        </div>

        <!-- Product Cost Profiles Table -->
        <div class="table-container" style="margin-top: 20px;">
          <table class="data-table" id="productCostProfilesTable">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Selling Price</th>
                <th>Total Cost</th>
                <th>Profit/Unit</th>
                <th>Margin %</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productCostProfilesBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                  <i class="ri-inbox-line" style="font-size: 2rem; display: block; margin-bottom: 8px;"></i>
                  No product cost profiles found. Click "Add Product" to create one.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Default Costs for Unassigned Products -->
        <div class="product-costs-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
          <div class="sales-summary-card" style="grid-column: 1 / -1; background: #fefce8; border: 1px solid #fde047;">
            <h4><i class="ri-settings-3-line"></i> Default Costs (Fallback)</h4>
            <p style="font-size: 0.85rem; color: #713f12; margin-top: 8px;">
              These costs will be used for products that don't have a specific cost profile configured.
            </p>
            <div class="default-costs-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 16px;">
              <div class="cost-input-group">
                <label for="defaultProductCost">Product Cost</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultProductCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultExportPrice">Export Price</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultExportPrice" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultPackagingCost">Box/Bag</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultPackagingCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultThankYouCardCost">Thank You Card</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultThankYouCardCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultRoundStickerCost">Round Sticker</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultRoundStickerCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultParcelEnvelopeCost">Parcel Envelope</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultParcelEnvelopeCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultBillPrintingCost">Bill Printing</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultBillPrintingCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultShippingCharges">Shipping</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultShippingCharges" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
              <div class="cost-input-group">
                <label for="defaultMiscCost">Misc</label>
                <div class="input-with-prefix">
                  <span class="prefix"></span>
                  <input type="number" id="defaultMiscCost" value="0" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
            </div>
            <button class="btn-secondary" id="saveDefaultCostsBtn" style="margin-top: 16px;">
              <i class="ri-save-line"></i> Save Default Costs
            </button>
          </div>

          <!-- Cost Summary Stats -->
          <div class="sales-summary-card" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white;">
            <h4 style="color: white;"><i class="ri-pie-chart-line"></i> Cost Profile Statistics</h4>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
              <div class="summary-item" style="justify-content: space-between; display: flex;">
                <span>Total Products Configured:</span>
                <span id="statsTotalProfiles" style="font-weight: 600;">0</span>
              </div>
              <div class="summary-item" style="justify-content: space-between; display: flex;">
                <span>Average Cost Per Product:</span>
                <span id="statsAvgCost" style="font-weight: 600;">0</span>
              </div>
              <div class="summary-item" style="justify-content: space-between; display: flex;">
                <span>Average Profit Margin:</span>
                <span id="statsAvgMargin" style="font-weight: 600; color: #4ade80;">0%</span>
              </div>
              <div class="summary-item" style="justify-content: space-between; display: flex; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; margin-top: 4px;">
                <span>Highest Margin Product:</span>
                <span id="statsHighestMargin" style="font-weight: 600; color: #4ade80;">-</span>
              </div>
              <div class="summary-item" style="justify-content: space-between; display: flex;">
                <span>Lowest Margin Product:</span>
                <span id="statsLowestMargin" style="font-weight: 600; color: #f87171;">-</span>
              </div>
            </div>
          </div>

          <!-- Quick Tips -->
          <div class="sales-summary-card">
            <h4><i class="ri-lightbulb-line"></i> Tips for Accurate Profit Analysis</h4>
            <ul style="margin-top: 12px; padding-left: 20px; font-size: 0.85rem; color: #4b5563; line-height: 1.8;">
              <li>Add a cost profile for each unique product you sell</li>
              <li>Include all costs: product purchase, packaging, stickers, cards</li>
              <li>Update costs when your suppliers change prices</li>
              <li>Products without a profile will use default costs</li>
              <li>Profit/Loss analysis will automatically use these costs</li>
            </ul>
          </div>
        </div>

        <!-- Product Cost Profile Modal - Spacious & Mobile Responsive -->
        <div class="pcp-modal-overlay" id="productCostProfileModal">
          <div class="pcp-modal">
            <!-- Modal Header -->
            <div class="pcp-modal-header">
              <div class="pcp-modal-title">
                <i class="ri-add-line"></i>
                <span id="productCostProfileModalTitle">Add Product Cost Profile</span>
              </div>
              <button type="button" class="pcp-modal-close" onclick="closeProductCostProfileModal()">
                <i class="ri-close-line"></i>
              </button>
            </div>
            
            <!-- Modal Content -->
            <form id="productCostProfileForm">
              <div class="pcp-modal-body">
                <input type="hidden" id="profileId" value="">
                <input type="hidden" id="profileProductId" value="">
                
                <!-- Product Info Card -->
                <div class="pcp-card pcp-card-primary">
                  <div class="pcp-card-header">
                    <i class="ri-price-tag-3-line"></i>
                    <span>Select Product</span>
                  </div>
                  <div class="pcp-card-body">
                    <div class="pcp-form-group">
                      <label for="profileProductSelect">Choose Product <span class="pcp-required">*</span></label>
                      <div class="pcp-select-wrapper">
                        <select id="profileProductSelect" class="pcp-select" required onchange="onProductSelect(this)">
                          <option value="">-- Select a product --</option>
                        </select>
                        <i class="ri-arrow-down-s-line pcp-select-arrow"></i>
                      </div>
                      <span class="pcp-hint">Select from your existing products or enter custom name below</span>
                    </div>
                    <div class="pcp-form-row">
                      <div class="pcp-form-group">
                        <label for="profileProductName">Product Name <span class="pcp-required">*</span></label>
                        <input type="text" id="profileProductName" class="pcp-input" required placeholder="Product name will auto-fill or enter custom">
                      </div>
                      <div class="pcp-form-group">
                        <label for="profileSellingPrice">Selling Price (MRP) <span class="pcp-required">*</span></label>
                        <div class="pcp-input-wrapper">
                          <span class="pcp-input-icon"></span>
                          <input type="number" id="profileSellingPrice" class="pcp-input pcp-input-icon-left" required min="0" step="0.01" placeholder="0.00" oninput="updateLivePreview()">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Cost Categories Grid -->
                <div class="pcp-costs-container">
                  <!-- Product Purchase Costs -->
                  <div class="pcp-card">
                    <div class="pcp-card-header pcp-card-header-blue">
                      <i class="ri-shopping-bag-3-line"></i>
                      <span>Purchase Costs</span>
                    </div>
                    <div class="pcp-card-body">
                      <div class="pcp-form-row">
                        <div class="pcp-form-group">
                          <label for="profileProductCost">Product Cost</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileProductCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                          <span class="pcp-hint">Buying price from supplier</span>
                        </div>
                        <div class="pcp-form-group">
                          <label for="profileExportPrice">Export / Import Price</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileExportPrice" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Packaging Costs -->
                  <div class="pcp-card">
                    <div class="pcp-card-header pcp-card-header-purple">
                      <i class="ri-gift-2-line"></i>
                      <span>Packaging</span>
                    </div>
                    <div class="pcp-card-body">
                      <div class="pcp-form-row">
                        <div class="pcp-form-group">
                          <label for="profilePackagingCost">Box / Bag</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profilePackagingCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                        <div class="pcp-form-group">
                          <label for="profileThankYouCardCost">Thank You Card</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileThankYouCardCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                      </div>
                      <div class="pcp-form-row">
                        <div class="pcp-form-group">
                          <label for="profileRoundStickerCost">Round Sticker</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileRoundStickerCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                        <div class="pcp-form-group">
                          <label for="profileParcelEnvelopeCost">Envelope / Wrap</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileParcelEnvelopeCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Operations Costs -->
                  <div class="pcp-card">
                    <div class="pcp-card-header pcp-card-header-green">
                      <i class="ri-truck-line"></i>
                      <span>Operations</span>
                    </div>
                    <div class="pcp-card-body">
                      <div class="pcp-form-row">
                        <div class="pcp-form-group">
                          <label for="profileBillPrintingCost">Bill Printing</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileBillPrintingCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                        <div class="pcp-form-group">
                          <label for="profileShippingCharges">Shipping Charges</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileShippingCharges" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                      </div>
                      <div class="pcp-form-row">
                        <div class="pcp-form-group">
                          <label for="profileMiscCost">Miscellaneous</label>
                          <div class="pcp-input-wrapper">
                            <span class="pcp-input-icon"></span>
                            <input type="number" id="profileMiscCost" class="pcp-input pcp-input-icon-left" value="0" min="0" step="0.01" oninput="updateLivePreview()">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Live Calculation Preview -->
                <div class="pcp-live-preview">
                  <div class="pcp-preview-title">
                    <i class="ri-calculator-line"></i>
                    Live Calculation
                  </div>
                  <div class="pcp-preview-grid">
                    <div class="pcp-preview-box pcp-preview-cost">
                      <span class="pcp-preview-label">Total Cost</span>
                      <span class="pcp-preview-value" id="livePreviewTotalCost">0</span>
                    </div>
                    <div class="pcp-preview-box pcp-preview-profit">
                      <span class="pcp-preview-label">Profit per Unit</span>
                      <span class="pcp-preview-value" id="livePreviewProfit">0</span>
                    </div>
                    <div class="pcp-preview-box pcp-preview-margin">
                      <span class="pcp-preview-label">Margin %</span>
                      <span class="pcp-preview-value" id="livePreviewMargin">0%</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal Actions -->
              <div class="pcp-modal-actions">
                <button type="button" class="pcp-btn pcp-btn-secondary" onclick="closeProductCostProfileModal()">
                  <i class="ri-close-line"></i>
                  <span>Cancel</span>
                </button>
                <button type="submit" class="pcp-btn pcp-btn-primary" id="saveProfileBtn">
                  <i class="ri-save-line"></i>
                  <span>Save Profile</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <style>
          /* ================================================
             PRODUCT COST PROFILE - SPACIOUS & MOBILE DESIGN
             ================================================ */
          
          /* Modal Overlay */
          .pcp-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
            animation: pcpFadeIn 0.25s ease-out;
          }
          
          @keyframes pcpFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          
          @keyframes pcpSlideUp {
            from { 
              opacity: 0; 
              transform: translateY(30px);
            }
            to { 
              opacity: 1; 
              transform: translateY(0);
            }
          }
          
          /* Modal Container */
          .pcp-modal {
            background: #ffffff;
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 
              0 0 0 1px rgba(0, 0, 0, 0.05),
              0 20px 50px -10px rgba(0, 0, 0, 0.3);
            animation: pcpSlideUp 0.35s ease-out;
          }
          
          #productCostProfileForm {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
          }
          
          /* Modal Header */
          .pcp-modal-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #ffffff;
          }
          
          .pcp-modal-title {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: -0.02em;
          }
          
          .pcp-modal-title i {
            font-size: 1.6rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 12px;
          }
          
          .pcp-modal-close {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
          }
          
          .pcp-modal-close:hover {
            background: rgba(239, 68, 68, 0.9);
            transform: scale(1.05);
          }
          
          .pcp-modal-close i {
            font-size: 1.4rem;
          }
          
          /* Modal Body - Scrollable */
          .pcp-modal-body {
            flex: 1;
            padding: 24px;
            background: #f8fafc;
            overflow-y: auto;
          }
          
          /* Card Styles */
          .pcp-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            overflow: visible;
            margin-bottom: 20px;
            transition: box-shadow 0.2s ease;
          }
          
          .pcp-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
          }
          
          .pcp-card-primary {
            border: 2px solid #3b82f6;
            background: linear-gradient(to bottom, #eff6ff, #ffffff);
          }
          
          .pcp-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px;
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.95rem;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
          }
          
          .pcp-card-header i {
            font-size: 1.25rem;
            color: #64748b;
          }
          
          .pcp-card-primary .pcp-card-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            border-bottom: none;
          }
          
          .pcp-card-primary .pcp-card-header i {
            color: #ffffff;
          }
          
          .pcp-card-header-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
            color: #ffffff !important;
            border-bottom: none !important;
          }
          .pcp-card-header-blue i { color: #ffffff !important; }
          
          .pcp-card-header-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
            color: #ffffff !important;
            border-bottom: none !important;
          }
          .pcp-card-header-purple i { color: #ffffff !important; }
          
          .pcp-card-header-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border-bottom: none !important;
          }
          .pcp-card-header-green i { color: #ffffff !important; }
          
          .pcp-card-body {
            padding: 20px;
          }
          
          /* Costs Grid */
          .pcp-costs-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
          }
          
          .pcp-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
          }
          
          /* Grid adjustments for mobile inside pcp-form-row */
          @media (max-width: 640px) {
            .pcp-form-row {
              grid-template-columns: 1fr;
              gap: 0;
            }
          }
          
          .pcp-card-body .pcp-form-group {
            margin-bottom: 16px;
          }
          
          .pcp-card-body .pcp-form-row:last-child .pcp-form-group {
            margin-bottom: 0;
          }
          
          .pcp-card-primary .pcp-card-body .pcp-form-group {
            width: 100%;
          }
          
          /* Form Elements */
          .pcp-form-group {
            margin-bottom: 20px;
          }
          
          .pcp-form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
          }
          
          .pcp-required {
            color: #ef4444;
            margin-left: 2px;
          }
          
          .pcp-hint {
            display: block;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 6px;
          }
          
          /* Select Dropdown Styles */
          .pcp-select-wrapper {
            position: relative;
          }
          
          .pcp-select {
            width: 100%;
            padding: 14px 45px 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            color: #1f2937;
            background: #ffffff;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            transition: all 0.2s ease;
          }
          
          .pcp-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
          }
          
          .pcp-select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.25rem;
            pointer-events: none;
          }
          
          /* Input Styles */
          .pcp-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            color: #1f2937;
            background: #ffffff;
            transition: all 0.2s ease;
          }
          
          .pcp-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12);
          }
          
          .pcp-input::placeholder {
            color: #9ca3af;
          }
          
          .pcp-input-wrapper {
            position: relative;
            display: flex;
            align-items: stretch;
          }
          
          .pcp-input-icon {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            color: #6b7280;
            font-weight: 700;
            font-size: 1rem;
            border: 2px solid #e5e7eb;
            border-right: none;
            border-radius: 12px 0 0 12px;
          }
          
          .pcp-input-icon-left {
            padding-left: 60px;
          }
          
          /* Remove number input spinners */
          .pcp-input[type="number"]::-webkit-outer-spin-button,
          .pcp-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
          }
          .pcp-input[type="number"] {
            -moz-appearance: textfield;
          }
          
          /* Live Preview */
          .pcp-live-preview {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 8px;
          }
          
          .pcp-preview-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 20px;
          }
          
          .pcp-preview-title i {
            font-size: 1.1rem;
          }
          
          .pcp-preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
          }
          
          .pcp-preview-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          .pcp-preview-label {
            display: block;
            color: #94a3b8;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 8px;
          }
          
          .pcp-preview-value {
            display: block;
            font-size: 1.75rem;
            font-weight: 800;
            color: #ffffff;
          }
          
          .pcp-preview-cost .pcp-preview-value {
            color: #f87171;
          }
          
          .pcp-preview-profit .pcp-preview-value {
            color: #4ade80;
          }
          
          .pcp-preview-margin .pcp-preview-value {
            color: #60a5fa;
          }
          
          /* Modal Actions */
          .pcp-modal-actions {
            flex-shrink: 0;
            display: flex;
            justify-content: flex-end;
            gap: 14px;
            padding: 20px 24px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
          }
          
          .pcp-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
          }
          
          .pcp-btn i {
            font-size: 1.2rem;
          }
          
          .pcp-btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #e2e8f0;
          }
          
          .pcp-btn-secondary:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
          }
          
          .pcp-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.35);
          }
          
          .pcp-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.45);
          }
          
          /* ============================
             RESPONSIVE DESIGN - MOBILE
             ============================ */
          @media (max-width: 640px) {
            .pcp-modal-overlay {
              padding: 0;
              align-items: stretch;
            }
            
            .pcp-modal {
              margin: 0;
              border-radius: 0;
              max-height: 100vh;
              min-height: 100vh;
              max-width: 100%;
            }
            
            .pcp-modal-header {
              padding: 16px;
            }
            
            .pcp-modal-title {
              font-size: 1.1rem;
              gap: 10px;
            }
            
            .pcp-modal-title i {
              font-size: 1.3rem;
              padding: 8px;
              border-radius: 10px;
            }
            
            .pcp-modal-close {
              width: 40px;
              height: 40px;
            }
            
            .pcp-modal-body {
              padding: 16px;
            }
            
            .pcp-card-body {
              padding: 16px;
            }
            
            .pcp-input {
              padding: 12px 14px;
              font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .pcp-input-icon-left {
              padding-left: 54px;
            }
            
            .pcp-input-icon {
              width: 44px;
            }
            
            .pcp-preview-grid {
              grid-template-columns: 1fr;
              gap: 12px;
            }
            
            .pcp-preview-box {
              padding: 16px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              text-align: left;
            }
            
            .pcp-preview-label {
              margin-bottom: 0;
            }
            
            .pcp-preview-value {
              font-size: 1.4rem;
            }
            
            .pcp-modal-actions {
              padding: 16px;
              flex-direction: column;
              gap: 10px;
            }
            
            .pcp-btn {
              width: 100%;
              padding: 16px;
              justify-content: center;
            }
          }
          
          /* ========================================
             PRODUCT COST SECTION - RESPONSIVE
             ======================================== */
          #product-costs .section-header {
            flex-wrap: wrap;
            gap: 12px;
          }
          
          #product-costs .section-header-right {
            flex-wrap: wrap;
            gap: 8px;
          }
          
          @media (max-width: 640px) {
            #product-costs .section-header {
              flex-direction: column;
              align-items: flex-start;
            }
            
            #product-costs .section-header-right {
              width: 100%;
            }
            
            #product-costs .section-header-right button {
              flex: 1;
              justify-content: center;
            }
          }
          
          /* Responsive Table */
          #productCostProfilesTable {
            font-size: 0.9rem;
          }
          
          @media (max-width: 768px) {
            #productCostProfilesTable thead {
              display: none;
            }
            
            #productCostProfilesTable tbody tr {
              display: block;
              margin-bottom: 16px;
              background: #ffffff;
              border-radius: 12px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              border: 1px solid #e5e7eb;
              padding: 16px;
            }
            
            #productCostProfilesTable tbody td {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 10px 0;
              border-bottom: 1px solid #f3f4f6;
            }
            
            #productCostProfilesTable tbody td:last-child {
              border-bottom: none;
              padding-top: 16px;
              margin-top: 8px;
            }
            
            #productCostProfilesTable tbody td::before {
              content: attr(data-label);
              font-weight: 600;
              color: #6b7280;
              font-size: 0.8rem;
            }
            
            #productCostProfilesTable .action-btns {
              width: 100%;
              justify-content: stretch;
            }
            
            #productCostProfilesTable .action-btns button {
              flex: 1;
            }
          }
          
          /* Default Costs Section Responsive */
          .product-costs-container {
            gap: 16px !important;
          }
          
          @media (max-width: 768px) {
            .product-costs-container {
              grid-template-columns: 1fr !important;
            }
            
            .product-costs-container > div {
              grid-column: span 1 !important;
            }
            
            .default-costs-grid {
              grid-template-columns: 1fr 1fr !important;
            }
          }
          
          @media (max-width: 480px) {
            .default-costs-grid {
              grid-template-columns: 1fr !important;
            }
          }
          
          /* Fix for original field styles (don't conflict) */
          .pcp-field input[type="text"],
          .pcp-field input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #1e293b;
            background: #ffffff;
            transition: all 0.2s ease;
          }
          
          /* Table Styles */
          .cost-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
          }
          .cost-input-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
          }
          .input-with-prefix {
            display: flex;
            align-items: stretch;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
          }
          .input-with-prefix:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
          }
          .input-with-prefix .prefix {
            background: #f3f4f6;
            padding: 8px 12px;
            font-weight: 500;
            color: #6b7280;
            display: flex;
            align-items: center;
          }
          .input-with-prefix input {
            border: none;
            padding: 8px 12px;
            width: 100%;
            font-size: 0.9rem;
            outline: none;
          }
          .input-with-prefix input::-webkit-outer-spin-button,
          .input-with-prefix input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
          }
          #productCostProfilesTable .action-btns {
            display: flex;
            gap: 8px;
            justify-content: center;
          }
          #productCostProfilesTable .action-btns button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
          }
          #productCostProfilesTable .edit-btn {
            background: #dbeafe;
            color: #1d4ed8;
          }
          #productCostProfilesTable .edit-btn:hover {
            background: #bfdbfe;
          }
          #productCostProfilesTable .delete-btn {
            background: #fee2e2;
            color: #dc2626;
          }
          #productCostProfilesTable .delete-btn:hover {
            background: #fecaca;
          }
          .profit-positive {
            color: #16a34a;
            font-weight: 600;
          }
          .profit-negative {
            color: #dc2626;
            font-weight: 600;
          }
        </style>
      </section>

      <!-- Slider Management Section -->
      <section id="slider" class="admin-section admin-panel slider-management">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-slideshow-3-line"></i> Hero Slider Management</h2>
            <small>Manage videos and images for the home page slider</small>
          </div>
          <div class="section-header-actions">
            <span class="refresh-indicator" id="slidesRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="slidesLastUpdate">--</span>
            </span>
            <button class="btn-export" id="refreshSlidesBtn" title="Refresh slides">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>

        <div class="slide-cards" id="slideCards">
          <!-- Slides will be loaded here -->
        </div>
      </section>

      <!-- Slide Modal -->
      <div class="modal" id="slideModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3 id="slideModalTitle"><i class="ri-add-line"></i> Add New Slide</h3>
            <button class="modal-close" id="slideModalCloseBtn">&times;</button>
          </div>
          <form id="slideForm" class="modal-body">
            <input type="hidden" id="slideId" />
            
            <div class="slide-form-group">
              <label for="slideType">Media Type</label>
              <select id="slideType" required>
                <option value="video">Video</option>
                <option value="image">Image</option>
              </select>
            </div>
            
            <div class="slide-form-group">
              <label for="slideFile">Upload File (Optional)</label>
              <input type="file" id="slideFile" accept="image/*,video/*" />
              <p class="slide-form-hint">Upload an image or video file directly</p>
            </div>
            
            <div class="slide-form-group">
              <label for="slideSrc">Or Enter Source URL / File Path</label>
              <input type="text" id="slideSrc" placeholder="e.g., video.mp4 or assets/img/hero.jpg" />
              <p class="slide-form-hint">Enter the video/image filename or full URL</p>
            </div>

            <div class="slide-form-group">
              <label for="slideTitle">Title (Optional)</label>
              <input type="text" id="slideTitle" placeholder="Hero Video 1" />
            </div>

            <div class="slide-form-row">
              <div class="slide-form-group">
                <label for="slidePosition">Position</label>
                <input type="number" id="slidePosition" min="1" value="1" required />
              </div>
              <div class="slide-form-group">
                <label for="slideActive">Status</label>
                <select id="slideActive">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
            </div>

            <div class="slide-form-group">
              <label>Preview</label>
              <div class="slide-preview-box" id="slidePreviewBox">
                <span>Enter a source to preview</span>
              </div>
            </div>

            <div class="modal-actions">
              <button type="submit" class="primary" id="slideSubmitBtn">Add Slide</button>
              <button type="button" class="secondary" id="slideCancelBtn">Cancel</button>
              <button type="button" class="delete-btn" id="slideDeleteBtn" style="display: none; margin-left: auto;">
                <i class="ri-delete-bin-line"></i> Delete Slide
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Newsletter Create/Edit Modal -->
      <div class="modal" id="newsletterModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h3 id="newsletterModalTitle"><i class="ri-mail-add-line"></i> Create Newsletter</h3>
            <button class="modal-close" id="newsletterModalCloseBtn">&times;</button>
          </div>
          <form id="newsletterForm" class="modal-body">
            <input type="hidden" id="newsletterId" />
            
            <div class="slide-form-group">
              <label for="newsletterSubject">Subject *</label>
              <input type="text" id="newsletterSubject" required placeholder="Enter newsletter subject" maxlength="200" />
            </div>
            
            <div class="slide-form-group">
              <label for="newsletterContent">Content *</label>
              <textarea id="newsletterContent" rows="12" required placeholder="Write your newsletter content here... (HTML supported)"></textarea>
              <p class="slide-form-hint">You can use HTML for formatting: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;a href=""&gt;link&lt;/a&gt;</p>
            </div>

            <div class="slide-form-group">
              <label for="newsletterStatus">Status</label>
              <select id="newsletterStatus">
                <option value="draft">Draft</option>
                <option value="scheduled">Scheduled</option>
              </select>
              <p class="slide-form-hint">Save as draft or schedule for later. Use "Send" button to send immediately.</p>
            </div>

            <div class="modal-actions">
              <button type="submit" class="primary" id="newsletterSubmitBtn">
                <i class="ri-save-line"></i> Save Newsletter
              </button>
              <button type="button" class="secondary" id="newsletterSendBtn" style="background: #10b981;">
                <i class="ri-send-plane-line"></i> Save & Send Now
              </button>
              <button type="button" class="secondary" id="newsletterCancelBtn">Cancel</button>
              <button type="button" class="delete-btn" id="newsletterDeleteBtn" style="display: none; margin-left: auto;">
                <i class="ri-delete-bin-line"></i> Delete
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Newsletter Preview Modal -->
      <div class="modal" id="newsletterPreviewModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3><i class="ri-eye-line"></i> Newsletter Preview</h3>
            <button class="modal-close" id="newsletterPreviewCloseBtn">&times;</button>
          </div>
          <div class="modal-body">
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 16px;">
              <div style="margin-bottom: 12px;">
                <strong>Subject:</strong>
                <div id="previewSubject" style="font-size: 18px; margin-top: 6px;"></div>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                <strong>Recipients:</strong> <span id="previewRecipients">0</span> active subscribers
              </div>
            </div>
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; background: white; min-height: 200px;" id="previewContent">
              <!-- Content will be rendered here -->
            </div>
            <div class="modal-actions">
              <button type="button" class="primary" id="confirmSendBtn">
                <i class="ri-send-plane-line"></i> Confirm & Send
              </button>
              <button type="button" class="secondary" id="cancelSendBtn">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <section id="products" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-shopping-bag-line"></i> Product Management</h2>
            <small>Upload images, set pricing, colors, sizes, and stock</small>
          </div>
          <div class="section-header-right">
            <button class="secondary" id="refreshProductsBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>

        <!-- Low Stock Notification -->
        <div id="lowStockNotification" class="low-stock-notification" style="display: none;">
          <div class="notification-content">
            <i class="ri-alert-line"></i>
            <div class="notification-text">
              <strong>Low Stock Alert</strong>
              <p id="lowStockMessage">Some products are running low on inventory</p>
            </div>
            <button type="button" class="notification-close" onclick="this.parentElement.parentElement.style.display='none';">
              <i class="ri-close-line"></i>
            </button>
          </div>
        </div>

        <form id="productForm">
          <label>
            Product Name
            <input type="text" id="productName" required placeholder="E.g. Noir blazer" />
          </label>
          <label>
            Price ()
            <input type="number" id="productPrice" min="0" required placeholder="1499" />
          </label>
          <label>
            Available Colors
            <div class="multi-select-group" id="colorCheckboxes">
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="Black" checked>
                <span class="color-swatch" style="background: #000;"></span> Black
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="White">
                <span class="color-swatch" style="background: #fff; border: 1px solid #ddd;"></span> White
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="Red">
                <span class="color-swatch" style="background: #dc2626;"></span> Red
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="Blue">
                <span class="color-swatch" style="background: #2563eb;"></span> Blue
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="Navy">
                <span class="color-swatch" style="background: #1e3a5f;"></span> Navy
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productColors" value="Grey">
                <span class="color-swatch" style="background: #6b7280;"></span> Grey
              </label>
            </div>
            <span class="image-upload-hint">Select all available colors for this product</span>
          </label>
          <label>
            Available Sizes
            <div class="multi-select-group" id="sizeCheckboxes">
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="XS"> XS
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="S"> S
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="M" checked> M
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="L" checked> L
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="XL" checked> XL
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="productSizes" value="XXL"> XXL
              </label>
            </div>
            <span class="image-upload-hint">Select all available sizes for this product</span>
          </label>
          <label>
            Description
            <textarea id="productDescription" rows="3" placeholder="Describe the product features, materials, care instructions, etc."></textarea>
          </label>
          <label>
            Inventory
            <input type="number" id="productStock" min="0" required placeholder="20" />
          </label>
          <label>
            SKU Code
            <div class="input-with-btn">
              <input type="text" id="productSku" placeholder="E.g. BLK-TSH-001" />
              <button type="button" class="generate-btn" onclick="generateSkuForProduct()">
                <i class="ri-magic-line"></i> Generate
              </button>
            </div>
            <span class="image-upload-hint">Unique Stock Keeping Unit code - Click Generate to auto-create</span>
          </label>
          <label>
            Barcode
            <div class="input-with-btn">
              <input type="text" id="productBarcode" placeholder="E.g. 123456789012" />
              <button type="button" class="generate-btn" onclick="generateBarcodeForProduct()">
                <i class="ri-barcode-line"></i> Generate
              </button>
            </div>
            <span class="image-upload-hint">Universal Product Code / EAN - Click Generate to auto-create</span>
          </label>
          <label>
            Stock Status
            <select id="productStockStatus" required>
              <option value="in-stock">In Stock</option>
              <option value="out-of-stock">Out of Stock</option>
            </select>
            <span class="image-upload-hint">Set product availability on the storefront</span>
          </label>
          <label>
            Position (1-6)
            <select id="productPosition">
              <option value="">Not on Home Page</option>
              <option value="1">1 - First Position</option>
              <option value="2">2 - Second Position</option>
              <option value="3">3 - Third Position</option>
              <option value="4">4 - Fourth Position</option>
              <option value="5">5 - Fifth Position</option>
              <option value="6">6 - Sixth Position</option>
            </select>
            <span class="image-upload-hint">Select position to show on home page</span>
          </label>
          <div class="image-upload-group">
            <label>
              <i class="ri-image-line"></i> Main Image
              <input type="file" id="productImage" accept="image/*" />
              <span class="image-upload-hint">Primary product image (large view)</span>
              <div class="product-preview-box" id="mainImagePreviewBox">
                <span>Select an image to preview</span>
              </div>
            </label>
            <label>
              <i class="ri-image-2-line"></i> Thumbnail Images
              <input type="file" id="productThumb" accept="image/*" multiple />
              <span class="image-upload-hint">Select multiple images for product gallery (hold Ctrl to select multiple)</span>
              <div class="product-preview-box thumbnails" id="thumbImagesPreviewBox">
                <span>Select images to preview</span>
              </div>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary" id="productSubmit">Add Product</button>
            <button type="button" class="secondary" id="productReset">Reset</button>
          </div>
        </form>
        <div id="productMessage" role="status"></div>

        <!-- Product Search and Filters -->
        <div class="search-container">
          <div class="search-input-wrapper">
            <i class="ri-search-line search-icon"></i>
            <input type="text" id="productSearch" placeholder="Search products by name, description, or category..." class="search-input">
            <button id="clearProductSearch" class="clear-search-btn" title="Clear search">
              <i class="ri-close-line"></i>
            </button>
          </div>
          <div class="filters-bar">
            <div class="filter-group">
              <label for="productCategoryFilter">Category:</label>
              <select id="productCategoryFilter" class="filter-select">
                <option value="">All Categories</option>
                <option value="T-Shirts">T-Shirts</option>
                <option value="Hoodies">Hoodies</option>
                <option value="Accessories">Accessories</option>
              </select>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="product-table">
            <thead>
              <tr>
                <th>Position</th>
                <th>Product</th>
                <th>Price</th>
                <th>SKU / Barcode</th>
                <th>Color / Size</th>
                <th>Inventory</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productBody"></tbody>
          </table>
        </div>
      </section>

      <section id="orders" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-file-list-3-line"></i> Orders Overview</h2>
            <small>Complete order history with size, color, and location</small>
          </div>
          <div class="section-header-actions">
            <div class="search-container">
              <input type="text" id="orderSearch" placeholder="Search orders by ID, customer, or status..." />
              <button id="clearSearch" title="Clear search"></button>
            </div>
            <span class="refresh-indicator" id="ordersRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="ordersLastUpdate">--</span>
            </span>
            <label class="auto-refresh-toggle">
              <input type="checkbox" id="ordersAutoRefresh" checked />
              Auto-refresh
            </label>
            <button class="btn-export" id="exportOrdersBtn" title="Export orders to CSV">
              <i class="ri-file-download-line"></i> Export
            </button>
            <button class="btn-export" id="refreshOrdersBtn" title="Refresh now">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="saveOrderChangesBtn" title="Save all pending changes">
              <i class="ri-save-line"></i> Save Changes <span id="orderPendingCount" class="pending-count"></span>
            </button>
          </div>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Processing">Processing</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="dateFilter">Date:</label>
            <select id="dateFilter">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
          <div class="bulk-actions">
            <button id="selectAllBtn" class="btn-secondary">Select All</button>
            <button id="bulkStatusBtn" class="btn-secondary" disabled>Bulk Update Status</button>
            <button id="bulkDeleteBtn" class="btn-danger" disabled>Delete Selected</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="orders-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllOrders" aria-label="Select all orders" /></th>
                <th>Order #</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Status</th>
                <th>Items</th>
                <th>Address</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
      </section>

      <section id="returns" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-arrow-go-back-line"></i> Return Requests</h2>
            <small>Manage customer return requests and process refunds</small>
          </div>
          <div class="section-header-actions">
            <div class="search-container">
              <input type="text" id="returnSearch" placeholder="Search returns by ID, order ID, or customer..." />
              <button id="clearReturnSearch" title="Clear search"></button>
            </div>
            <span class="refresh-indicator" id="returnsRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="returnsLastUpdate">--</span>
            </span>
            <label class="auto-refresh-toggle">
              <input type="checkbox" id="returnsAutoRefresh" checked />
              Auto-refresh
            </label>
            <button class="btn-export" id="exportReturnsBtn" title="Export returns to CSV">
              <i class="ri-download-2-line"></i> Export
            </button>
            <button class="btn-export" id="refreshReturnsBtn" title="Refresh now">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="saveReturnChangesBtn" title="Save all pending changes">
              <i class="ri-save-line"></i> Save Changes <span id="returnPendingCount" class="pending-count"></span>
            </button>
          </div>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label for="returnStatusFilter">Status:</label>
            <select id="returnStatusFilter">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="Pickup Scheduled">Pickup Scheduled</option>
              <option value="Picked Up">Picked Up</option>
              <option value="Processing">Processing</option>
              <option value="Refunded">Refunded</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="returnReasonFilter">Reason:</label>
            <select id="returnReasonFilter">
              <option value="">All Reasons</option>
              <option value="defective">Defective Product</option>
              <option value="wrong_item">Wrong Item Received</option>
              <option value="not_as_described">Not as Described</option>
              <option value="size_issue">Size/Fit Issue</option>
              <option value="color_issue">Color Issue</option>
              <option value="changed_mind">Changed Mind</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="bulk-actions">
            <button id="selectAllReturnsBtn" class="btn-secondary">Select All</button>
            <button id="bulkReturnStatusBtn" class="btn-secondary" disabled>Bulk Update Status</button>
            <button id="bulkReturnDeleteBtn" class="btn-danger" disabled>Delete Selected</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="returns-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllReturns" aria-label="Select all returns" /></th>
                <th>Return ID</th>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="returnsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Exchanges Section -->
      <section id="exchanges" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-exchange-line"></i> Exchange Requests</h2>
            <small>Manage customer exchange requests and process replacements</small>
          </div>
          <div class="section-header-actions">
            <div class="search-container">
              <input type="text" id="exchangeSearch" placeholder="Search exchanges by ID, order ID, or customer..." />
              <button id="clearExchangeSearch" title="Clear search"></button>
            </div>
            <span class="refresh-indicator" id="exchangesRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="exchangesLastUpdate">--</span>
            </span>
            <label class="auto-refresh-toggle">
              <input type="checkbox" id="exchangesAutoRefresh" checked />
              Auto-refresh
            </label>
            <button class="btn-export" id="exportExchangesBtn" title="Export exchanges to CSV">
              <i class="ri-download-2-line"></i> Export
            </button>
            <button class="btn-export" id="refreshExchangesBtn" title="Refresh now">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="saveExchangeChangesBtn" title="Save all pending changes">
              <i class="ri-save-line"></i> Save Changes <span id="exchangePendingCount" class="pending-count"></span>
            </button>
          </div>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label for="exchangeStatusFilter">Status:</label>
            <select id="exchangeStatusFilter">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="Pickup Scheduled">Pickup Scheduled</option>
              <option value="Picked Up">Picked Up</option>
              <option value="Processing">Processing</option>
              <option value="Shipped">New Item Shipped</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="exchangeReasonFilter">Reason:</label>
            <select id="exchangeReasonFilter">
              <option value="">All Reasons</option>
              <option value="size_issue">Size/Fit Issue</option>
              <option value="color_issue">Color Issue</option>
              <option value="defective">Defective Product</option>
              <option value="wrong_item">Wrong Item Received</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="bulk-actions">
            <button id="selectAllExchangesBtn" class="btn-secondary">Select All</button>
            <button id="bulkExchangeStatusBtn" class="btn-secondary" disabled>Bulk Update Status</button>
            <button id="bulkExchangeDeleteBtn" class="btn-danger" disabled>Delete Selected</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="returns-table exchanges-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllExchanges" aria-label="Select all exchanges" /></th>
                <th>Exchange ID</th>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Exchange For</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="exchangesBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Cancellations Section -->
      <section id="cancellations" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-close-circle-line"></i> Cancellation Requests</h2>
            <small>Manage customer order cancellations and process refunds</small>
          </div>
          <div class="section-header-actions">
            <div class="search-container">
              <input type="text" id="cancellationSearch" placeholder="Search cancellations by ID, order ID, or customer..." />
              <button id="clearCancellationSearch" title="Clear search"></button>
            </div>
            <span class="refresh-indicator" id="cancellationsRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="cancellationsLastUpdate">--</span>
            </span>
            <label class="auto-refresh-toggle">
              <input type="checkbox" id="cancellationsAutoRefresh" checked />
              Auto-refresh
            </label>
            <button class="btn-export" id="exportCancellationsBtn" title="Export cancellations to CSV">
              <i class="ri-download-2-line"></i> Export
            </button>
            <button class="btn-export" id="refreshCancellationsBtn" title="Refresh now">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="saveCancellationChangesBtn" title="Save all pending changes">
              <i class="ri-save-line"></i> Save Changes <span id="cancellationPendingCount" class="pending-count"></span>
            </button>
          </div>
        </div>

        <div class="filters-bar">
          <div class="filter-group">
            <label for="cancellationStatusFilter">Status:</label>
            <select id="cancellationStatusFilter">
              <option value="">All Statuses</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="Refunded">Refunded</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="cancellationReasonFilter">Reason:</label>
            <select id="cancellationReasonFilter">
              <option value="">All Reasons</option>
              <option value="changed_mind">Changed Mind</option>
              <option value="found_better_price">Found Better Price</option>
              <option value="ordered_by_mistake">Ordered by Mistake</option>
              <option value="delivery_too_slow">Delivery Taking Too Long</option>
              <option value="duplicate_order">Duplicate Order</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="bulk-actions">
            <button id="selectAllCancellationsBtn" class="btn-secondary">Select All</button>
            <button id="bulkCancellationStatusBtn" class="btn-secondary" disabled>Bulk Update Status</button>
            <button id="bulkCancellationDeleteBtn" class="btn-danger" disabled>Delete Selected</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="returns-table cancellations-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllCancellationsCheckbox" aria-label="Select all cancellations" /></th>
                <th>Cancel ID</th>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Order Total</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cancellationsBody"></tbody>
          </table>
        </div>
      </section>

      <section id="users" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-user-line"></i> User Data & Export</h2>
            <small>Download CSV with contact and registration info</small>
          </div>
          <div class="section-header-actions">
            <span class="refresh-indicator" id="usersRefreshIndicator">
              <i class="ri-refresh-line"></i>
              <span id="usersLastUpdate">--</span>
            </span>
            <label class="auto-refresh-toggle">
              <input type="checkbox" id="usersAutoRefresh" checked />
              Auto-refresh
            </label>
            <button class="btn-export" id="refreshUsersBtn" title="Refresh now">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="users-section">
          <!-- User Filters -->
          <div class="search-container">
            <div class="search-input-wrapper">
              <i class="ri-search-line search-icon"></i>
              <input type="text" id="userSearch" placeholder="Search users by name, email, or phone..." class="search-input">
              <button id="clearUserSearch" class="clear-search-btn" title="Clear search">
                <i class="ri-close-line"></i>
              </button>
            </div>
            <div class="filters-bar">
              <div class="filter-group">
                <label for="userRoleFilter">Filter by Role:</label>
                <select id="userRoleFilter" class="filter-select">
                  <option value="">All Users</option>
                  <option value="customer">Customers Only</option>
                  <option value="admin">Admins Only</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="userSortBy">Sort by:</label>
                <select id="userSortBy" class="filter-select">
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                  <option value="name">Name A-Z</option>
                  <option value="email">Email A-Z</option>
                </select>
              </div>
            </div>
          </div>

          <div class="info-row">
            <div id="userCount"><i class="ri-group-line"></i> Users tracked: 0</div>
            <div id="userStats" style="display:flex;gap:16px;flex-wrap:wrap;">
              <span id="customerCount" style="color:#3730a3;background:linear-gradient(135deg,rgba(224,231,255,0.8),rgba(199,210,254,0.8));padding:8px 12px;border-radius:20px;border:1px solid #a5b4fc;">
                <i class="ri-user-heart-line"></i> <strong>Customers: 0</strong>
              </span>
              <span id="adminCount" style="color:#92400e;background:linear-gradient(135deg,rgba(254,243,199,0.8),rgba(253,230,138,0.8));padding:8px 12px;border-radius:20px;border:1px solid #f59e0b;">
                <i class="ri-admin-line"></i> <strong>Admins: 0</strong>
              </span>
            </div>
            <button class="btn-export" id="downloadUsers"><i class="ri-download-2-line"></i> Download Users CSV</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Role</th>
                  <th>Registered</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Deleted Users Section -->
      <section id="deleted-users" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-user-unfollow-line"></i> Deleted Users Archive</h2>
            <small>View and manage deleted user accounts and their data</small>
          </div>
          <div class="section-header-actions">
            <button class="btn-export" id="refreshDeletedUsersBtn" onclick="loadDeletedUsers()" title="Refresh">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="users-section">
          <div class="search-container">
            <div class="search-input-wrapper">
              <i class="ri-search-line search-icon"></i>
              <input type="text" id="deletedUserSearch" placeholder="Search deleted users by name, email..." class="search-input" onkeyup="filterDeletedUsers()">
            </div>
          </div>
          <div class="info-row">
            <div id="deletedUserCount"><i class="ri-user-unfollow-line"></i> Deleted users: 0</div>
            <button class="btn-export" id="downloadDeletedUsers" onclick="downloadDeletedUsersCSV()">
              <i class="ri-download-2-line"></i> Download CSV
            </button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Original ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Deleted On</th>
                  <th>Reason</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="deletedUsersBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                    <i class="ri-loader-4-line" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p style="margin: 16px 0 0;">Loading deleted users...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Password Reset Management Section -->
      <section id="password-reset-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-lock-password-line"></i> Password Reset Management</h2>
            <small>Generate OTPs and manage password resets for users</small>
          </div>
          <div class="section-header-actions">
            <button class="btn-export" id="refreshPasswordResetBtn" title="Refresh data">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        
        <div class="password-reset-section">
          <!-- Search Box -->
          <div class="section-header" style="padding: 16px 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fbbf24;">
            <h3 style="margin: 0; font-size: 1rem; color: #92400e; display: flex; align-items: center; gap: 8px;">
              <i class="ri-key-2-line"></i> Manage User Password Resets
            </h3>
            <div class="search-box">
              <i class="ri-search-line"></i>
              <input type="text" id="passwordResetSearch" placeholder="Search users by name or email...">
              <button id="clearPasswordResetSearch" style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 4px;" title="Clear search">
                <i class="ri-close-line"></i>
              </button>
            </div>
          </div>

          <!-- Pending OTPs Section -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h4>
                <i class="ri-time-line" style="color: #f59e0b;"></i>
                Active Password Reset OTPs
                <span id="pendingOtpCount" class="badge">0</span>
              </h4>
            </div>
            <div class="table-wrapper">
              <table class="reset-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>OTP Code</th>
                    <th>Expires In</th>
                    <th class="hide-mobile">Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="pendingOtpBody">
                  <tr><td colspan="5" class="empty-state"><i class="ri-shield-check-line"></i><p>No active OTPs</p></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- User List for Password Reset -->
          <div class="card">
            <div class="card-header">
              <h4>
                <i class="ri-user-line" style="color: #3b82f6;"></i>
                All Users
                <span id="passwordResetUserCount" class="badge success">0</span>
              </h4>
            </div>
            <div class="table-wrapper">
              <table class="reset-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th class="hide-mobile">Status</th>
                    <th class="hide-mobile">Last Reset</th>
                    <th class="hide-mobile">Pending OTP</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="passwordResetUsersBody">
                  <tr><td colspan="5" class="empty-state"><i class="ri-loader-4-line ri-spin"></i><p>Loading users...</p></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact Messages Section -->
      <section id="messages" class="admin-section admin-panel">
        <div class="panel-header">
          <div class="section-header">
            <div class="section-header-left">
              <h2><i class="ri-mail-line"></i> Contact Messages</h2>
              <small>View and manage contact form submissions from users</small>
            </div>
            <div class="section-header-right">
              <button class="secondary" id="refreshMessagesBtn">
                <i class="ri-refresh-line"></i> Refresh
              </button>
            </div>
          </div>
          <!-- Query Number Search -->
          <div class="search-container" style="margin-top: 16px;">
            <div class="search-input-wrapper">
              <i class="ri-search-line search-icon"></i>
              <input type="text" id="querySearch" placeholder="Search by Query Number (e.g., QRY-20240115-0001), name, email..." class="search-input">
              <button id="clearQuerySearch" class="clear-search-btn" title="Clear search">
                <i class="ri-close-line"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="panel-body">
          <div class="table-responsive">
            <table id="messagesTable">
              <thead>
                <tr>
                  <th>Query #</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Subject</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="messagesTableBody">
                <!-- Messages will be loaded here -->
              </tbody>
            </table>
            <div id="noMessagesMsg" class="empty-state">
              <p><i class="ri-mail-unread-line"></i> No messages yet</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Website Health Monitoring Section -->
      <section id="health" class="admin-section admin-panel health-section">
        <div class="panel-header">
          <div class="section-header">
            <div class="section-header-left">
              <h2><i class="ri-heart-pulse-line"></i> Website Health Monitor</h2>
              <small>Real-time server status, API health, and system metrics</small>
            </div>
            <div class="section-header-right">
              <div class="health-status-badge" id="healthStatusBadge">
                <span class="pulse-dot"></span>
                <span class="status-text">Checking...</span>
              </div>
              <button class="secondary" id="refreshHealthBtn">
                <i class="ri-refresh-line"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="panel-body">
          <!-- Health Overview Cards -->
          <div class="health-overview-grid">
            <div class="health-card server-status" id="serverStatusCard">
              <div class="health-card-icon">
                <i class="ri-server-line"></i>
              </div>
              <div class="health-card-content">
                <h4>Server Status</h4>
                <div class="health-value" id="serverStatus">Loading...</div>
                <div class="health-meta" id="serverUptime">Uptime: --</div>
              </div>
            </div>
            <div class="health-card database-status" id="databaseStatusCard">
              <div class="health-card-icon">
                <i class="ri-database-2-line"></i>
              </div>
              <div class="health-card-content">
                <h4>Database</h4>
                <div class="health-value" id="databaseStatus">Loading...</div>
                <div class="health-meta" id="databaseSize">Size: --</div>
              </div>
            </div>
            <div class="health-card uploads-status" id="uploadsStatusCard">
              <div class="health-card-icon">
                <i class="ri-upload-cloud-2-line"></i>
              </div>
              <div class="health-card-content">
                <h4>Uploads</h4>
                <div class="health-value" id="uploadsStatus">Loading...</div>
                <div class="health-meta" id="uploadsCount">Files: --</div>
              </div>
            </div>
            <div class="health-card response-time" id="responseTimeCard">
              <div class="health-card-icon">
                <i class="ri-speed-line"></i>
              </div>
              <div class="health-card-content">
                <h4>Response Time</h4>
                <div class="health-value" id="responseTime">--</div>
                <div class="health-meta">API latency</div>
              </div>
            </div>
          </div>

          <!-- System Resources -->
          <div class="health-section-title">
            <i class="ri-cpu-line"></i> System Resources
          </div>
          <div class="system-resources-grid">
            <div class="resource-card">
              <div class="resource-header">
                <span><i class="ri-cpu-line"></i> CPU</span>
                <span class="resource-value" id="cpuUsage">--%</span>
              </div>
              <div class="resource-bar">
                <div class="resource-fill" id="cpuBar" style="width: 0%"></div>
              </div>
              <div class="resource-details" id="cpuDetails">Cores: -- | Model: --</div>
            </div>
            <div class="resource-card">
              <div class="resource-header">
                <span><i class="ri-ram-line"></i> Memory</span>
                <span class="resource-value" id="memoryUsage">--%</span>
              </div>
              <div class="resource-bar">
                <div class="resource-fill" id="memoryBar" style="width: 0%"></div>
              </div>
              <div class="resource-details" id="memoryDetails">Used: -- / Total: --</div>
            </div>
            <div class="resource-card">
              <div class="resource-header">
                <span><i class="ri-stack-line"></i> Heap Memory</span>
                <span class="resource-value" id="heapUsage">--%</span>
              </div>
              <div class="resource-bar">
                <div class="resource-fill heap" id="heapBar" style="width: 0%"></div>
              </div>
              <div class="resource-details" id="heapDetails">Used: -- / Total: --</div>
            </div>
          </div>

          <!-- API Endpoints Status -->
          <div class="health-section-title">
            <i class="ri-links-line"></i> API Endpoints Status
          </div>
          <div class="api-endpoints-grid" id="apiEndpointsGrid">
            <!-- Endpoints will be rendered here -->
          </div>

          <!-- Database Files Status -->
          <div class="health-section-title">
            <i class="ri-file-list-3-line"></i> Database Files
          </div>
          <div class="database-files-grid" id="databaseFilesGrid">
            <!-- Database files will be rendered here -->
          </div>

          <!-- Upload Folders Status -->
          <div class="health-section-title">
            <i class="ri-folder-upload-line"></i> Upload Folders
          </div>
          <div class="upload-folders-grid" id="uploadFoldersGrid">
            <!-- Upload folders will be rendered here -->
          </div>

          <!-- Server Info -->
          <div class="health-section-title">
            <i class="ri-information-line"></i> Server Information
          </div>
          <div class="server-info-grid" id="serverInfoGrid">
            <div class="info-item">
              <span class="info-label">Platform</span>
              <span class="info-value" id="infoPlatform">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Architecture</span>
              <span class="info-value" id="infoArch">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Node.js Version</span>
              <span class="info-value" id="infoNodeVersion">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Environment</span>
              <span class="info-value" id="infoEnv">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Server Started</span>
              <span class="info-value" id="infoStartedAt">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Uptime Duration</span>
              <span class="info-value uptime-badge" id="infoUptimeDuration">--</span>
            </div>
            <div class="info-item">
              <span class="info-label">Last Checked</span>
              <span class="info-value" id="infoLastChecked">--</span>
            </div>
          </div>
        </div>
      </section>

      <!-- AI Analytics Section -->
      <section id="ai-analytics" class="admin-section admin-panel ai-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-robot-2-line"></i> AI Analytics Engine</h2>
            <small>AI-powered insights, predictions, and anomaly detection</small>
          </div>
          <div class="section-header-right">
            <div class="ai-status-badge" id="aiStatusBadge">
              <i class="ri-sparkling-line"></i>
              <span>AI Engine v3.0</span>
            </div>
            <button class="secondary" id="refreshAiAnalyticsBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body">
          <!-- AI Insights Cards -->
          <div class="ai-insights-grid" id="aiInsightsGrid">
            <div class="ai-insight-card loading">
              <div class="insight-icon"><i class="ri-lightbulb-flash-line"></i></div>
              <div class="insight-content">
                <h4>Loading AI Insights...</h4>
                <p>Analyzing your data</p>
              </div>
            </div>
          </div>

          <!-- AI Predictions -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-line-chart-line"></i> Traffic Predictions</h3>
              <span class="ai-badge">7-Day Forecast</span>
            </div>
            <div class="predictions-chart" id="predictionsChart">
              <div class="prediction-loading">Generating predictions...</div>
            </div>
          </div>

          <!-- Anomaly Detection -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-error-warning-line"></i> Anomaly Detection</h3>
              <span class="anomaly-count" id="anomalyCount">0 detected</span>
            </div>
            <div class="anomalies-list" id="anomaliesList">
              <div class="no-anomalies">
                <i class="ri-checkbox-circle-line"></i>
                <span>No anomalies detected</span>
              </div>
            </div>
          </div>

          <!-- Customer Segments -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-group-line"></i> Customer Segments</h3>
              <span class="ai-badge">RFM Analysis</span>
            </div>
            <div class="segments-grid" id="segmentsGrid">
              <div class="segment-card champions">
                <i class="ri-vip-crown-line"></i>
                <span class="segment-name">Champions</span>
                <span class="segment-count" id="championsCount">0</span>
              </div>
              <div class="segment-card loyal">
                <i class="ri-heart-line"></i>
                <span class="segment-name">Loyal</span>
                <span class="segment-count" id="loyalCount">0</span>
              </div>
              <div class="segment-card at-risk">
                <i class="ri-alarm-warning-line"></i>
                <span class="segment-name">At Risk</span>
                <span class="segment-count" id="atRiskCount">0</span>
              </div>
              <div class="segment-card new">
                <i class="ri-user-star-line"></i>
                <span class="segment-name">New</span>
                <span class="segment-count" id="newCustomersCount">0</span>
              </div>
            </div>
          </div>

          <!-- Conversion Funnel -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-filter-3-line"></i> Conversion Funnel</h3>
              <span class="conversion-rate" id="conversionRate">0%</span>
            </div>
            <div class="funnel-container" id="funnelContainer">
              <div class="funnel-stage" style="--width: 100%">
                <span class="stage-name">Page Views</span>
                <span class="stage-count" id="funnelPageViews">0</span>
              </div>
              <div class="funnel-stage" style="--width: 70%">
                <span class="stage-name">Product Views</span>
                <span class="stage-count" id="funnelProductViews">0</span>
              </div>
              <div class="funnel-stage" style="--width: 40%">
                <span class="stage-name">Add to Cart</span>
                <span class="stage-count" id="funnelAddToCart">0</span>
              </div>
              <div class="funnel-stage" style="--width: 25%">
                <span class="stage-name">Checkout</span>
                <span class="stage-count" id="funnelCheckout">0</span>
              </div>
              <div class="funnel-stage" style="--width: 15%">
                <span class="stage-name">Purchase</span>
                <span class="stage-count" id="funnelPurchase">0</span>
              </div>
            </div>
            <div class="funnel-bottleneck" id="funnelBottleneck">
              <i class="ri-error-warning-line"></i>
              <span>Bottleneck: <strong id="bottleneckStage">--</strong></span>
            </div>
          </div>
        </div>
      </section>

      <!-- AI SEO Section -->
      <section id="ai-seo" class="admin-section admin-panel ai-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-seo-line"></i> AI SEO Engine</h2>
            <small>Smart keyword analysis and SEO optimization</small>
          </div>
          <div class="section-header-right">
            <div class="seo-status-badge" id="seoStatusBadge">
              <i class="ri-search-eye-line"></i>
              <span id="seoKeywordCount">0</span> Keywords
            </div>
            <button class="secondary" id="refreshSeoBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body">
          <!-- SEO Score Card -->
          <div class="seo-score-card" id="seoScoreCard">
            <div class="score-circle">
              <svg viewBox="0 0 100 100">
                <circle class="score-bg" cx="50" cy="50" r="45"/>
                <circle class="score-fill" cx="50" cy="50" r="45" id="seoScoreCircle"/>
              </svg>
              <div class="score-value" id="seoScore">--</div>
            </div>
            <div class="score-details">
              <h3>SEO Health Score</h3>
              <p id="seoScoreDesc">Analyzing your SEO performance...</p>
            </div>
          </div>

          <!-- Keyword Categories -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-hashtag"></i> Keyword Categories</h3>
            </div>
            <div class="keyword-categories-grid" id="keywordCategoriesGrid">
              <div class="keyword-category">
                <i class="ri-t-shirt-line"></i>
                <span class="cat-name">Product Keywords</span>
                <span class="cat-count" id="productKeywords">0</span>
              </div>
              <div class="keyword-category">
                <i class="ri-map-pin-line"></i>
                <span class="cat-name">Local SEO</span>
                <span class="cat-count" id="localKeywords">0</span>
              </div>
              <div class="keyword-category">
                <i class="ri-calendar-event-line"></i>
                <span class="cat-name">Seasonal</span>
                <span class="cat-count" id="seasonalKeywords">0</span>
              </div>
              <div class="keyword-category">
                <i class="ri-flashlight-line"></i>
                <span class="cat-name">Intent-Based</span>
                <span class="cat-count" id="intentKeywords">0</span>
              </div>
            </div>
          </div>

          <!-- Trending Keywords -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-fire-line"></i> Trending Keywords</h3>
            </div>
            <div class="trending-keywords" id="trendingKeywords">
              <span class="keyword-tag loading">Loading...</span>
            </div>
          </div>

          <!-- SEO Recommendations -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-lightbulb-line"></i> SEO Recommendations</h3>
            </div>
            <div class="seo-recommendations" id="seoRecommendations">
              <div class="recommendation-item">
                <i class="ri-loader-4-line spinning"></i>
                <span>Analyzing your content...</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI Health Dashboard Section -->
      <section id="ai-health-dashboard" class="admin-section admin-panel ai-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-pulse-line"></i> AI Health Dashboard</h2>
            <small>Monitor AI engines, auto-debugging, and system health</small>
          </div>
          <div class="section-header-right">
            <div class="ai-status-badge" id="aiHealthStatusBadge">
              <i class="ri-shield-check-line"></i>
              <span id="aiHealthStatus">Checking...</span>
            </div>
            <button class="secondary" id="refreshAiHealthBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="runDiagnosticsBtn">
              <i class="ri-stethoscope-line"></i> Run Diagnostics
            </button>
          </div>
        </div>
        <div class="panel-body">
          <!-- Overall System Status -->
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card" id="systemCpuCard">
              <div class="stat-icon-wrapper info"><i class="ri-cpu-line"></i></div>
              <div class="stat-content">
                <small>CPU USAGE</small>
                <strong id="systemCpuUsage">--%</strong>
              </div>
            </div>
            <div class="stat-card" id="systemMemoryCard">
              <div class="stat-icon-wrapper warning"><i class="ri-ram-line"></i></div>
              <div class="stat-content">
                <small>MEMORY USAGE</small>
                <strong id="systemMemoryUsage">--%</strong>
              </div>
            </div>
            <div class="stat-card" id="systemDiskCard">
              <div class="stat-icon-wrapper success"><i class="ri-hard-drive-2-line"></i></div>
              <div class="stat-content">
                <small>DISK USAGE</small>
                <strong id="systemDiskUsage">--%</strong>
              </div>
            </div>
            <div class="stat-card" id="aiEnginesCard">
              <div class="stat-icon-wrapper info"><i class="ri-robot-2-line"></i></div>
              <div class="stat-content">
                <small>AI ENGINES</small>
                <strong id="aiEnginesStatus">0/0</strong>
              </div>
            </div>
          </div>

          <!-- AI Engines Status Grid -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-robot-2-line"></i> AI Engines Status</h3>
              <span class="ai-badge" id="aiEnginesHealthBadge">All Systems</span>
            </div>
            <div class="ai-engines-grid" id="aiEnginesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
              <!-- Engine cards will be loaded here -->
              <div class="engine-card loading">
                <div class="engine-icon"><i class="ri-loader-4-line spinning"></i></div>
                <div class="engine-info">
                  <h4>Loading Engines...</h4>
                  <p>Checking AI systems</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Auto-Debug Console -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-bug-line"></i> Auto-Debug Console</h3>
              <button class="secondary" id="analyzeErrorsBtn" style="padding: 6px 12px; font-size: 0.85rem;">
                <i class="ri-search-line"></i> Analyze Errors
              </button>
            </div>
            <div class="debug-console" id="debugConsole" style="background: #1e1e2e; border-radius: 12px; padding: 16px; max-height: 300px; overflow-y: auto;">
              <div class="debug-output" id="debugOutput" style="font-family: 'Consolas', monospace; font-size: 0.85rem; color: #a6adc8;">
                <div class="debug-line" style="color: #89b4fa;">> AI Auto-Debugger initialized</div>
                <div class="debug-line" style="color: #a6e3a1;">> Ready to analyze errors</div>
              </div>
            </div>
          </div>

          <!-- Recent Diagnostics -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-file-list-3-line"></i> Recent Diagnostics</h3>
            </div>
            <div class="diagnostics-list" id="diagnosticsList">
              <div class="diagnostic-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
                <i class="ri-time-line" style="color: #64748b;"></i>
                <span style="color: #64748b;">No recent diagnostics. Click "Run Diagnostics" to start.</span>
              </div>
            </div>
          </div>

          <!-- Payment Verification Stats -->
          <div class="ai-section-block">
            <div class="ai-block-header">
              <h3><i class="ri-bank-card-line"></i> Payment Verification AI</h3>
              <span class="ai-badge success" id="paymentAiBadge">Active</span>
            </div>
            <div class="payment-ai-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
              <div class="payment-stat" style="text-align: center; padding: 16px; background: #f0fdf4; border-radius: 12px;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;" id="paymentsApproved">0</div>
                <div style="font-size: 0.85rem; color: #4ade80;">Approved</div>
              </div>
              <div class="payment-stat" style="text-align: center; padding: 16px; background: #fef3c7; border-radius: 12px;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #d97706;" id="paymentsFlagged">0</div>
                <div style="font-size: 0.85rem; color: #fbbf24;">Flagged</div>
              </div>
              <div class="payment-stat" style="text-align: center; padding: 16px; background: #fef2f2; border-radius: 12px;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #dc2626;" id="paymentsBlocked">0</div>
                <div style="font-size: 0.85rem; color: #f87171;">Blocked</div>
              </div>
              <div class="payment-stat" style="text-align: center; padding: 16px; background: #eff6ff; border-radius: 12px;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #2563eb;" id="paymentsReview">0</div>
                <div style="font-size: 0.85rem; color: #60a5fa;">Manual Review</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SKU & Barcode Management Section -->
      <section id="sku-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-barcode-line"></i> SKU & Barcode Management</h2>
            <small>Generate unique product identifiers and barcodes</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleSku" class="master-section-toggle" data-section="skuManagement" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshSkuBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="secondary" id="generateAllSkuBtn">
              <i class="ri-barcode-line"></i> Generate All SKUs
            </button>
          </div>
        </div>
        <div class="panel-body" id="skuSectionBody">
          <!-- SKU Stats -->
          <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card stat-info">
              <div class="stat-icon-wrapper info"><i class="ri-qr-code-line"></i></div>
              <div class="stat-content">
                <small>PRODUCTS WITH SKU</small>
                <strong id="skuProductCount">0</strong>
              </div>
            </div>
            <div class="stat-card stat-warning">
              <div class="stat-icon-wrapper warning"><i class="ri-alert-line"></i></div>
              <div class="stat-content">
                <small>WITHOUT SKU</small>
                <strong id="noSkuCount">0</strong>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-barcode-box-line"></i></div>
              <div class="stat-content">
                <small>BARCODES GENERATED</small>
                <strong id="barcodeCount">0</strong>
              </div>
            </div>
          </div>

          <!-- SKU List -->
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>SKU Code</th>
                  <th>Barcode</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="skuTableBody">
                <tr><td colspan="5" style="text-align:center; color:#6b7280;">Loading SKU data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Inventory & Stock Management Section -->
      <section id="inventory-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-stock-line"></i> Inventory & Stock Management</h2>
            <small>Track stock levels, set alerts, and manage inventory</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleInventory" class="master-section-toggle" data-section="inventory" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshInventoryBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="secondary" id="exportInventoryBtn">
              <i class="ri-download-line"></i> Export
            </button>
          </div>
        </div>
        <div class="panel-body" id="inventorySectionBody">
          <!-- Inventory Stats -->
          <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-check-line"></i></div>
              <div class="stat-content">
                <small>IN STOCK</small>
                <strong id="inStockCount">0</strong>
              </div>
            </div>
            <div class="stat-card stat-warning">
              <div class="stat-icon-wrapper warning"><i class="ri-alert-line"></i></div>
              <div class="stat-content">
                <small>LOW STOCK</small>
                <strong id="lowStockCount">0</strong>
              </div>
            </div>
            <div class="stat-card stat-danger">
              <div class="stat-icon-wrapper danger"><i class="ri-close-circle-line"></i></div>
              <div class="stat-content">
                <small>OUT OF STOCK</small>
                <strong id="outOfStockCount">0</strong>
              </div>
            </div>
            <div class="stat-card stat-info">
              <div class="stat-icon-wrapper info"><i class="ri-stack-line"></i></div>
              <div class="stat-content">
                <small>TOTAL UNITS</small>
                <strong id="totalUnitsCount">0</strong>
              </div>
            </div>
          </div>

          <!-- Low Stock Threshold -->
          <div style="background: #f8fafc; padding: 16px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #374151;">
              <i class="ri-alert-line"></i> Low Stock Alert Threshold:
              <input type="number" id="lowStockThreshold" value="10" min="1" style="width: 70px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px;" />
            </label>
            <button class="secondary" id="updateThresholdBtn" style="padding: 8px 16px;">
              <i class="ri-save-line"></i> Save
            </button>
          </div>

          <!-- Inventory Table -->
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>SKU</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody">
                <tr><td colspan="6" style="text-align:center; color:#6b7280;">Loading inventory...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Stock Update Modal -->
          <div id="stockUpdateModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 400px;">
              <div class="modal-header">
                <h3><i class="ri-edit-line"></i> Update Stock</h3>
                <button type="button" class="modal-close" onclick="closeStockModal()">&times;</button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="stockProductId" />
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Product
                  <input type="text" id="stockProductName" readonly style="padding: 10px; background: #f3f4f6; border: none; border-radius: 8px;" />
                </label>
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  New Stock Quantity
                  <input type="number" id="newStockValue" min="0" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </label>
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Reason
                  <select id="stockUpdateReason" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <option value="restock">Restock</option>
                    <option value="sale">Sale</option>
                    <option value="return">Return</option>
                    <option value="adjustment">Adjustment</option>
                    <option value="damaged">Damaged</option>
                  </select>
                </label>
              </div>
              <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="secondary" onclick="closeStockModal()">Cancel</button>
                <button type="button" class="primary" id="saveStockBtn">Save</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Marketing & Promotions Section -->
      <section id="marketing-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-megaphone-line"></i> Marketing & Promotions</h2>
            <small>Manage coupons, sales, bundles, gift cards, and popups</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleMarketing" class="master-section-toggle" data-section="marketing" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshMarketingBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body" id="marketingSectionBody">
          <!-- Marketing Feature Toggles -->
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <h4 style="margin: 0 0 16px 0; font-size: 0.95rem; color: #0f172a;"><i class="ri-toggle-line"></i> Feature Toggles</h4>
            <div class="responsive-grid" style="gap: 16px;">
              <label class="toggle-switch-label">
                <input type="checkbox" id="toggleCoupons" class="marketing-toggle" data-feature="couponsEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Coupons</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="toggleSales" class="marketing-toggle" data-feature="salesEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Seasonal Sales</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="toggleBundles" class="marketing-toggle" data-feature="bundlesEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Bundles</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="togglePopups" class="marketing-toggle" data-feature="popupsEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Homepage Popups</span>
              </label>
            </div>
          </div>

          <!-- Marketing Tabs -->
          <div class="marketing-tabs">
            <button class="tab-btn active" data-tab="coupons"><i class="ri-coupon-3-line"></i> Coupons</button>
            <button class="tab-btn" data-tab="sales"><i class="ri-price-tag-3-line"></i> Sales</button>
            <button class="tab-btn" data-tab="bundles"><i class="ri-stack-line"></i> Bundles</button>
            <button class="tab-btn" data-tab="popups"><i class="ri-window-line"></i> Popups</button>
          </div>

          <!-- Coupons Tab -->
          <div id="coupons-tab" class="marketing-tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-coupon-3-line"></i> Coupon Codes</h4>
              <button class="primary" id="addCouponBtn"><i class="ri-add-line"></i> Add Coupon</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Min Order</th>
                    <th>Usage</th>
                    <th>Expires</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="couponsTableBody">
                  <tr><td colspan="8" style="text-align:center; color:#6b7280;">No coupons created yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Sales Tab -->
          <div id="sales-tab" class="marketing-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-price-tag-3-line"></i> Seasonal Sales</h4>
              <button class="primary" id="addSaleBtn"><i class="ri-add-line"></i> Create Sale</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Sale Name</th>
                    <th>Discount</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Products</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="salesTableBody">
                  <tr><td colspan="7" style="text-align:center; color:#6b7280;">No sales created yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Bundles Tab -->
          <div id="bundles-tab" class="marketing-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-stack-line"></i> Product Bundles</h4>
              <button class="primary" id="addBundleBtn"><i class="ri-add-line"></i> Create Bundle</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Bundle Name</th>
                    <th>Products</th>
                    <th>Bundle Price</th>
                    <th>Savings</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bundlesTableBody">
                  <tr><td colspan="6" style="text-align:center; color:#6b7280;">No bundles created yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Popups Tab -->
          <div id="popups-tab" class="marketing-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-window-line"></i> Homepage Popups</h4>
              <button class="primary" id="addPopupBtn"><i class="ri-add-line"></i> Create Popup</button>
            </div>
            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 16px;">
              <i class="ri-information-line"></i> Popups appear 5 seconds after page load on homepage
            </p>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Delay (s)</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="popupsTableBody">
                  <tr><td colspan="7" style="text-align:center; color:#6b7280;">No popups created yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Shipping & Logistics Section -->
      <section id="shipping-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-truck-line"></i> Shipping & Logistics</h2>
            <small>Configure shipping rates, zones, couriers, and tracking</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleShipping" class="master-section-toggle" data-section="shipping" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshShippingBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body" id="shippingSectionBody">
          <!-- Shipping Tabs -->
          <div class="shipping-tabs">
            <button class="tab-btn active" data-tab="shipping-settings"><i class="ri-settings-3-line"></i> Settings</button>
            <button class="tab-btn" data-tab="shipping-zones"><i class="ri-map-pin-line"></i> Zones</button>
            <button class="tab-btn" data-tab="shipping-couriers"><i class="ri-truck-line"></i> Couriers</button>
            <button class="tab-btn" data-tab="shipping-tracking"><i class="ri-route-line"></i> Tracking</button>
            <button class="tab-btn" data-tab="shipping-sla"><i class="ri-bar-chart-line"></i> SLA</button>
            <button class="tab-btn" data-tab="shipping-rto"><i class="ri-arrow-go-back-line"></i> RTO</button>
          </div>

          <!-- Shipping Settings Tab -->
          <div id="shipping-settings-tab" class="shipping-tab-content active">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-settings-3-line"></i> Shipping Configuration</h4>
            <form id="shippingSettingsForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; background: #f8fafc; padding: 20px; border-radius: 12px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Free Shipping Threshold ()
                <input type="number" id="freeShippingThreshold" value="999" min="0" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Standard Shipping Rate ()
                <input type="number" id="defaultShippingRate" value="49" min="0" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Express Shipping Rate ()
                <input type="number" id="expressShippingRate" value="99" min="0" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                COD Charges ()
                <input type="number" id="codCharges" value="40" min="0" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Standard Delivery (days)
                <input type="text" id="estimatedDaysStandard" value="5-7" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Express Delivery (days)
                <input type="text" id="estimatedDaysExpress" value="2-3" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <div style="grid-column: 1 / -1;">
                <button type="submit" class="primary"><i class="ri-save-line"></i> Save Settings</button>
              </div>
            </form>
          </div>

          <!-- Shipping Zones Tab -->
          <div id="shipping-zones-tab" class="shipping-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-map-pin-line"></i> Delivery Zones</h4>
              <button class="primary" id="addZoneBtn"><i class="ri-add-line"></i> Add Zone</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Zone Name</th>
                    <th>States</th>
                    <th>Rate ()</th>
                    <th>Est. Days</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="zonesTableBody">
                  <tr><td colspan="6" style="text-align:center; color:#6b7280;">No zones created yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Couriers Tab -->
          <div id="shipping-couriers-tab" class="shipping-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-truck-line"></i> Courier Partners</h4>
            <div class="couriers-grid" id="couriersGrid">
              <!-- Couriers will be loaded here -->
            </div>
          </div>

          <!-- Tracking Tab -->
          <div id="shipping-tracking-tab" class="shipping-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-route-line"></i> Shipment Tracking</h4>
              <button class="primary" id="createShipmentBtn"><i class="ri-add-line"></i> Create Shipment</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Tracking #</th>
                    <th>Order ID</th>
                    <th>Courier</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="shipmentsTableBody">
                  <tr><td colspan="6" style="text-align:center; color:#6b7280;">No shipments yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- SLA Tab -->
          <div id="shipping-sla-tab" class="shipping-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-bar-chart-line"></i> SLA Performance</h4>
            <div class="stats-grid" id="slaStatsGrid">
              <div class="stat-card stat-info">
                <div class="stat-icon-wrapper info"><i class="ri-truck-line"></i></div>
                <div class="stat-content">
                  <small>TOTAL SHIPMENTS</small>
                  <strong id="slaTotalShipments">0</strong>
                </div>
              </div>
              <div class="stat-card stat-success">
                <div class="stat-icon-wrapper success"><i class="ri-checkbox-circle-line"></i></div>
                <div class="stat-content">
                  <small>DELIVERED</small>
                  <strong id="slaDelivered">0</strong>
                </div>
              </div>
              <div class="stat-card stat-primary">
                <div class="stat-icon-wrapper primary"><i class="ri-percent-line"></i></div>
                <div class="stat-content">
                  <small>ON-TIME RATE</small>
                  <strong id="slaOnTimeRate">0%</strong>
                </div>
              </div>
              <div class="stat-card stat-warning">
                <div class="stat-icon-wrapper warning"><i class="ri-time-line"></i></div>
                <div class="stat-content">
                  <small>AVG DELIVERY</small>
                  <strong id="slaAvgDays">0 days</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- RTO Tab -->
          <div id="shipping-rto-tab" class="shipping-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-arrow-go-back-line"></i> Return to Origin (RTO)</h4>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Reason</th>
                    <th>Status</th>
                    <th>Initiated</th>
                    <th>Resolved</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="rtoTableBody">
                  <tr><td colspan="6" style="text-align:center; color:#6b7280;">No RTO records</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Tax & GST Settings Section -->
      <section id="tax-management" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-percent-line"></i> Tax & GST Settings</h2>
            <small>Configure Indian GST rates for fashion products</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleTax" class="master-section-toggle" data-section="tax" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshTaxBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body" id="taxSectionBody">
          <!-- Tax Tabs -->
          <div class="tax-tabs">
            <button class="tab-btn active" data-tab="tax-settings"><i class="ri-settings-3-line"></i> Settings</button>
            <button class="tab-btn" data-tab="tax-invoice-config"><i class="ri-file-settings-line"></i> Invoice Setup</button>
            <button class="tab-btn" data-tab="tax-slabs"><i class="ri-price-tag-3-line"></i> Tax Slabs</button>
            <button class="tab-btn" data-tab="tax-hsn"><i class="ri-file-list-3-line"></i> HSN Codes</button>
            <button class="tab-btn" data-tab="tax-invoices"><i class="ri-file-text-line"></i> Invoices</button>
            <button class="tab-btn" data-tab="tax-report"><i class="ri-bar-chart-box-line"></i> GST Report</button>
          </div>

          <!-- Tax Settings Tab -->
          <div id="tax-settings-tab" class="tax-tab-content active">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-settings-3-line"></i> GST Configuration</h4>
            <form id="taxSettingsForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; background: #f8fafc; padding: 20px; border-radius: 12px;">
              <label class="toggle-switch-label" style="grid-column: 1 / -1;">
                <input type="checkbox" id="gstEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Enable GST Calculation</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Business Name
                <input type="text" id="businessName" value="Blackonn" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                GSTIN Number
                <input type="text" id="gstNumber" placeholder="22AAAAA0000A1Z5" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Business State
                <select id="businessStateCode" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <option value="">Loading states...</option>
                </select>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; grid-column: 1 / -1;">
                Business Address
                <textarea id="businessAddress" rows="2" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;"></textarea>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="inclusiveGst" checked>
                <span class="toggle-switch"></span>
                <span>Prices Include GST</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="showGstOnInvoice" checked>
                <span class="toggle-switch"></span>
                <span>Show GST on Invoice</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="toggleInvoice" class="tax-toggle" data-feature="invoiceEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Enable Invoice Download</span>
              </label>
              <div style="grid-column: 1 / -1;">
                <button type="submit" class="primary"><i class="ri-save-line"></i> Save Settings</button>
              </div>
            </form>
            <div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <h5 style="margin: 0 0 8px 0; color: #92400e;"><i class="ri-information-line"></i> Indian GST for Fashion Products</h5>
              <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: #78350f;">
                <li><strong>5% GST</strong> (2.5% CGST + 2.5% SGST) for apparel priced <strong>below 1000</strong></li>
                <li><strong>12% GST</strong> (6% CGST + 6% SGST) for apparel priced <strong>1000 and above</strong></li>
                <li>For interstate sales, IGST applies instead of CGST+SGST</li>
              </ul>
            </div>
          </div>

          <!-- Invoice Setup Tab -->
          <div id="tax-invoice-config-tab" class="tax-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-file-settings-line"></i> Invoice Customization</h4>
            <form id="invoiceSettingsForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; background: #f8fafc; padding: 20px; border-radius: 12px;">
              <label style="display: flex; align-items: center; gap: 10px; grid-column: 1 / -1; margin-bottom: 10px; padding: 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="invoiceEnabled" checked style="width: 18px; height: 18px;">
                <div style="display: flex; flex-direction: column;">
                  <strong style="font-size: 0.9rem; color: #1f2937;">Enable Invoice Download for Customers</strong>
                  <small style="color: #6b7280;">Allow customers to download invoices from their profile page</small>
                </div>
              </label>
              <div style="grid-column: 1 / -1;">
                <h5 style="margin: 0 0 12px 0; color: #374151;"><i class="ri-numbers-line"></i> Invoice Numbering</h5>
              </div>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Invoice Prefix
                <input type="text" id="invoicePrefix" value="INV" placeholder="INV" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                <small style="color: #6b7280;">e.g., INV, BILL, BLKN</small>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Last Invoice Number
                <input type="number" id="lastInvoiceNumber" value="0" readonly style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f3f4f6;" />
                <small style="color: #6b7280;">Auto-incremented</small>
              </label>
              
              <div style="grid-column: 1 / -1; margin-top: 16px;">
                <h5 style="margin: 0 0 12px 0; color: #374151;"><i class="ri-text"></i> Invoice Content</h5>
              </div>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Company Logo URL
                <input type="text" id="invoiceLogo" placeholder="/assets/img/logo.png" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Business PAN
                <input type="text" id="businessPan" placeholder="ABCDE1234F" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; grid-column: 1 / -1;">
                Invoice Footer Message
                <textarea id="invoiceFooter" rows="2" placeholder="Thank you for shopping with Blackonn!" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;"></textarea>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; grid-column: 1 / -1;">
                Terms & Conditions
                <textarea id="invoiceTerms" rows="3" placeholder="All products are subject to our return policy..." style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;"></textarea>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Authorized Signatory Name
                <input type="text" id="invoiceSignature" placeholder="Authorized Signatory" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              
              <div style="grid-column: 1 / -1; margin-top: 16px;">
                <h5 style="margin: 0 0 12px 0; color: #374151;"><i class="ri-bank-line"></i> Bank Details (Optional)</h5>
              </div>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Bank Name
                <input type="text" id="bankName" placeholder="Bank Name" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Account Number
                <input type="text" id="bankAccountNumber" placeholder="Account Number" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                IFSC Code
                <input type="text" id="bankIfsc" placeholder="IFSC Code" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Account Holder Name
                <input type="text" id="bankAccountHolder" placeholder="Account Holder Name" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              
              <div style="grid-column: 1 / -1; margin-top: 12px;">
                <button type="submit" class="primary"><i class="ri-save-line"></i> Save Invoice Settings</button>
              </div>
            </form>
            
            <div style="margin-top: 24px; padding: 16px; background: #ecfdf5; border-radius: 12px; border-left: 4px solid #10b981;">
              <h5 style="margin: 0 0 8px 0; color: #065f46;"><i class="ri-information-line"></i> Invoice Preview</h5>
              <p style="margin: 0; font-size: 0.85rem; color: #047857;">
                Next invoice number will be: <strong id="nextInvoicePreview">INV-2501-00001</strong>
              </p>
            </div>
          </div>

          <!-- Tax Slabs Tab -->
          <div id="tax-slabs-tab" class="tax-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-price-tag-3-line"></i> GST Tax Slabs</h4>
              <button class="primary" id="addTaxSlabBtn"><i class="ri-add-line"></i> Add Slab</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Slab Name</th>
                    <th>Price Range</th>
                    <th>CGST</th>
                    <th>SGST</th>
                    <th>IGST</th>
                    <th>HSN</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="taxSlabsTableBody">
                  <tr><td colspan="8" style="text-align:center; color:#6b7280;">Loading tax slabs...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- HSN Codes Tab -->
          <div id="tax-hsn-tab" class="tax-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-file-list-3-line"></i> HSN Codes</h4>
              <button class="primary" id="addHsnBtn"><i class="ri-add-line"></i> Add HSN</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>HSN Code</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="hsnTableBody">
                  <tr><td colspan="4" style="text-align:center; color:#6b7280;">Loading HSN codes...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Invoices Tab -->
          <div id="tax-invoices-tab" class="tax-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-file-text-line"></i> GST Invoices</h4>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Invoice #</th>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Taxable</th>
                    <th>GST</th>
                    <th>Total</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="invoicesTableBody">
                  <tr><td colspan="8" style="text-align:center; color:#6b7280;">No invoices generated yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- GST Report Tab -->
          <div id="tax-report-tab" class="tax-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-bar-chart-box-line"></i> GST Summary Report</h4>
            <div style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
              <label style="display: flex; align-items: center; gap: 8px;">
                From: <input type="date" id="gstReportStart" style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                To: <input type="date" id="gstReportEnd" style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <button class="secondary" id="generateGstReportBtn"><i class="ri-refresh-line"></i> Generate Report</button>
            </div>
            <div class="stats-grid" id="gstReportGrid">
              <div class="stat-card stat-info">
                <div class="stat-icon-wrapper info"><i class="ri-file-list-3-line"></i></div>
                <div class="stat-content">
                  <small>TOTAL INVOICES</small>
                  <strong id="reportTotalInvoices">0</strong>
                </div>
              </div>
              <div class="stat-card stat-success">
                <div class="stat-icon-wrapper success"><i class="ri-money-rupee-circle-line"></i></div>
                <div class="stat-content">
                  <small>TOTAL SALES</small>
                  <strong id="reportTotalSales">0</strong>
                </div>
              </div>
              <div class="stat-card stat-primary">
                <div class="stat-icon-wrapper primary"><i class="ri-percent-line"></i></div>
                <div class="stat-content">
                  <small>TOTAL GST</small>
                  <strong id="reportTotalGst">0</strong>
                </div>
              </div>
              <div class="stat-card stat-warning">
                <div class="stat-icon-wrapper warning"><i class="ri-arrow-left-right-line"></i></div>
                <div class="stat-content">
                  <small>CGST / SGST</small>
                  <strong id="reportCgstSgst">0 / 0</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Company Tax & Financial Section -->
      <section id="company-tax" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-building-line"></i> Blackonn Company Tax</h2>
            <small>Track company tax obligations, profit/loss, and yearly tax liability</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleCompanyTax" class="master-section-toggle" data-section="companyTax" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshCompanyTaxBtnAlt">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body" id="companyTaxSectionBody">
          <!-- Financial Year Selector -->
          <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 24px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
              <i class="ri-calendar-line"></i> Financial Year:
              <select id="financialYearSelect" style="padding: 10px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                <option value="2023-24">FY 2023-24 (Apr 2023 - Mar 2024)</option>
                <option value="2024-25" selected>FY 2024-25 (Apr 2024 - Mar 2025)</option>
                <option value="2025-26">FY 2025-26 (Apr 2025 - Mar 2026)</option>
                <option value="2026-27">FY 2026-27 (Apr 2026 - Mar 2027)</option>
                <option value="2027-28">FY 2027-28 (Apr 2027 - Mar 2028)</option>
                <option value="2028-29">FY 2028-29 (Apr 2028 - Mar 2029)</option>
                <option value="2029-30">FY 2029-30 (Apr 2029 - Mar 2030)</option>
                <option value="2030-31">FY 2030-31 (Apr 2030 - Mar 2031)</option>
              </select>
            </label>
            <button class="secondary" id="refreshCompanyTaxBtn"><i class="ri-refresh-line"></i> Refresh Data</button>
            <button class="primary" id="exportTaxReportBtn"><i class="ri-download-2-line"></i> Export Report</button>
          </div>

          <!-- Financial Summary Cards -->
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div class="stat-icon-wrapper success"><i class="ri-money-rupee-circle-line"></i></div>
              <div class="stat-content">
                <small>GROSS REVENUE</small>
                <strong id="companyGrossRevenue">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-shopping-bag-line"></i></div>
              <div class="stat-content">
                <small>TOTAL EXPENSES</small>
                <strong id="companyTotalExpenses">0</strong>
              </div>
            </div>
            <div class="stat-card stat-highlight">
              <div class="stat-icon-wrapper"><i class="ri-line-chart-line"></i></div>
              <div class="stat-content">
                <small>NET PROFIT / LOSS</small>
                <strong id="companyNetProfit">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper danger"><i class="ri-government-line"></i></div>
              <div class="stat-content">
                <small>TAX LIABILITY</small>
                <strong id="companyTaxLiability">0</strong>
              </div>
            </div>
          </div>

          <!-- Tax Tabs -->
          <div class="tax-tabs">
            <button class="tab-btn active" data-tab="company-income"><i class="ri-arrow-up-circle-line"></i> Income</button>
            <button class="tab-btn" data-tab="company-expenses"><i class="ri-arrow-down-circle-line"></i> Expenses</button>
            <button class="tab-btn" data-tab="company-taxes"><i class="ri-percent-line"></i> Tax Calculation</button>
            <button class="tab-btn" data-tab="company-timeline"><i class="ri-calendar-check-line"></i> Timeline</button>
          </div>

          <!-- Income Tab -->
          <div id="company-income-tab" class="tax-tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-arrow-up-circle-line"></i> Income Sources</h4>
              <button class="primary" id="addIncomeBtn"><i class="ri-add-line"></i> Add Income</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>GST Collected</th>
                    <th>Net Amount</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="incomeTableBody">
                  <tr><td colspan="7" style="text-align: center; color: #6b7280;">No income entries. Click "Add Income" to start.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Expenses Tab -->
          <div id="company-expenses-tab" class="tax-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 style="margin: 0;"><i class="ri-arrow-down-circle-line"></i> Business Expenses</h4>
              <button class="primary" id="addExpenseBtn"><i class="ri-add-line"></i> Add Expense</button>
            </div>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>GST Paid (ITC)</th>
                    <th>Net Expense</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="expensesTableBody">
                  <tr><td colspan="7" style="text-align: center; color: #6b7280;">No expense entries. Click "Add Expense" to start.</td></tr>
                </tbody>
              </table>
            </div>
            <div style="margin-top: 16px; padding: 16px; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #22c55e;">
              <h5 style="margin: 0 0 8px 0; color: #166534;"><i class="ri-information-line"></i> Expense Categories for Tax Deductions</h5>
              <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: #15803d; columns: 2;">
                <li>Inventory/Stock Purchase</li>
                <li>Website & Hosting</li>
                <li>Marketing & Advertising</li>
                <li>Shipping & Logistics</li>
                <li>Employee Salaries</li>
                <li>Office Rent</li>
                <li>Utilities (Electricity, Internet)</li>
                <li>Professional Fees (CA, Legal)</li>
              </ul>
            </div>
          </div>

          <!-- Tax Calculation Tab -->
          <div id="company-taxes-tab" class="tax-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-calculator-line"></i> Income Tax Calculation (India)</h4>
            
            <!-- Business Type Selection -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                <span style="font-weight: 500;">Business Type</span>
                <select id="businessTypeSelect" style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; max-width: 400px;">
                  <option value="proprietorship">Sole Proprietorship</option>
                  <option value="partnership">Partnership Firm</option>
                  <option value="llp">LLP (Limited Liability Partnership)</option>
                  <option value="pvt-ltd">Private Limited Company</option>
                  <option value="opc">One Person Company (OPC)</option>
                </select>
              </label>
              <label style="display: flex; flex-direction: column; gap: 8px;">
                <span style="font-weight: 500;">Tax Regime</span>
                <select id="taxRegimeSelect" style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; max-width: 400px;">
                  <option value="new">New Tax Regime (Lower rates, no deductions)</option>
                  <option value="old">Old Tax Regime (With deductions)</option>
                </select>
              </label>
            </div>

            <!-- Tax Breakdown -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon-wrapper info"><i class="ri-money-rupee-circle-line"></i></div>
                <div class="stat-content">
                  <small>TAXABLE INCOME</small>
                  <strong id="taxableIncome">0</strong>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon-wrapper warning"><i class="ri-percent-line"></i></div>
                <div class="stat-content">
                  <small>TAX RATE</small>
                  <strong id="effectiveTaxRate">0%</strong>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon-wrapper danger"><i class="ri-government-line"></i></div>
                <div class="stat-content">
                  <small>INCOME TAX</small>
                  <strong id="incomeTaxAmount">0</strong>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon-wrapper primary"><i class="ri-add-circle-line"></i></div>
                <div class="stat-content">
                  <small>CESS (4%)</small>
                  <strong id="cessAmount">0</strong>
                </div>
              </div>
            </div>

            <!-- GST Summary -->
            <div style="margin-top: 24px; padding: 20px; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <h5 style="margin: 0 0 12px 0; color: #92400e;"><i class="ri-file-list-3-line"></i> GST Liability Summary</h5>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                  <small style="color: #92400e;">Output GST (Collected)</small>
                  <div style="font-size: 1.3rem; font-weight: 700; color: #78350f;" id="outputGst">0</div>
                </div>
                <div>
                  <small style="color: #92400e;">Input GST Credit (ITC)</small>
                  <div style="font-size: 1.3rem; font-weight: 700; color: #78350f;" id="inputGst">0</div>
                </div>
                <div>
                  <small style="color: #92400e;">Net GST Payable</small>
                  <div style="font-size: 1.3rem; font-weight: 700; color: #dc2626;" id="netGstPayable">0</div>
                </div>
              </div>
            </div>

            <!-- Total Tax Summary -->
            <div style="margin-top: 24px; padding: 24px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 16px; color: #fff;">
              <h4 style="margin: 0 0 16px 0;"><i class="ri-calculator-line"></i> Total Yearly Tax Liability</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                <div>
                  <small style="opacity: 0.7;">Income Tax + Cess</small>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="totalIncomeTax">0</div>
                </div>
                <div>
                  <small style="opacity: 0.7;">GST Payable</small>
                  <div style="font-size: 1.5rem; font-weight: 700;" id="totalGstPayable">0</div>
                </div>
                <div style="border-left: 2px solid rgba(255,255,255,0.3); padding-left: 20px;">
                  <small style="opacity: 0.7;">TOTAL TAX</small>
                  <div style="font-size: 2rem; font-weight: 800; color: #fbbf24;" id="grandTotalTax">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline Tab -->
          <div id="company-timeline-tab" class="tax-tab-content">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-calendar-check-line"></i> Tax Compliance Timeline</h4>
            <div style="display: grid; gap: 16px;">
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">10th</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Every Month</div>
                </div>
                <div>
                  <strong>GST Payment Due</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">Monthly GST payment deadline for businesses with turnover > 5 Cr</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">11th</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Every Month</div>
                </div>
                <div>
                  <strong>GSTR-1 Filing</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">Outward supplies return for the previous month</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">20th</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Every Month</div>
                </div>
                <div>
                  <strong>GSTR-3B Filing</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">Summary return and tax payment for the previous month</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">15th Jun</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Quarterly</div>
                </div>
                <div>
                  <strong>Advance Tax - Q1</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">15% of estimated annual tax liability</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">15th Sep</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Quarterly</div>
                </div>
                <div>
                  <strong>Advance Tax - Q2</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">45% of estimated annual tax liability (cumulative)</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">15th Dec</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Quarterly</div>
                </div>
                <div>
                  <strong>Advance Tax - Q3</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">75% of estimated annual tax liability (cumulative)</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">15th Mar</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Quarterly</div>
                </div>
                <div>
                  <strong>Advance Tax - Q4</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">100% of estimated annual tax liability (final)</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #ef4444; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">31st Jul</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Yearly</div>
                </div>
                <div>
                  <strong>ITR Filing Deadline</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">Annual income tax return filing for individuals & HUFs (non-audit)</p>
                </div>
              </div>
              <div style="display: flex; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border-left: 4px solid #ef4444; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="min-width: 100px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">31st Oct</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Yearly</div>
                </div>
                <div>
                  <strong>ITR Filing (Audit)</strong>
                  <p style="margin: 4px 0 0; font-size: 0.85rem; color: #6b7280;">Annual income tax return filing for businesses requiring audit</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Gift Cards Management Section -->
      <section id="gift-cards" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-gift-line"></i> Gift Cards Management</h2>
            <small>Create and manage gift cards for customers</small>
          </div>
          <div class="section-header-right">
            <label class="toggle-switch-label master-toggle" title="Enable/Disable this section">
              <input type="checkbox" id="masterToggleGiftCards" class="master-section-toggle" data-section="giftCards" checked>
              <span class="toggle-switch"></span>
              <span>Section Enabled</span>
            </label>
            <button class="secondary" id="refreshGiftCardsBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="createGiftCardBtn"><i class="ri-add-line"></i> Create Gift Card</button>
          </div>
        </div>
        <div class="panel-body" id="giftCardsSectionBody">
          <!-- Gift Card Stats -->
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-gift-2-line"></i></div>
              <div class="stat-content">
                <small>TOTAL GIFT CARDS</small>
                <strong id="totalGiftCards">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper success"><i class="ri-checkbox-circle-line"></i></div>
              <div class="stat-content">
                <small>ACTIVE CARDS</small>
                <strong id="activeGiftCards">0</strong>
              </div>
            </div>
            <div class="stat-card stat-highlight">
              <div class="stat-icon-wrapper"><i class="ri-money-rupee-circle-line"></i></div>
              <div class="stat-content">
                <small>TOTAL VALUE</small>
                <strong id="totalGiftCardValue">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-shopping-cart-2-line"></i></div>
              <div class="stat-content">
                <small>REDEEMED</small>
                <strong id="redeemedGiftCards">0</strong>
              </div>
            </div>
          </div>

          <!-- Gift Cards Table -->
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Value</th>
                  <th>Balance</th>
                  <th>Recipient</th>
                  <th>Sender</th>
                  <th>Created</th>
                  <th>Expires</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="giftCardsTableBody">
                <tr><td colspan="9" style="text-align: center; color: #6b7280;">No gift cards found. Click "Create Gift Card" to start.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Create Gift Card Form (Hidden by default) -->
          <div id="giftCardFormContainer" style="display: none; margin-top: 24px; padding: 24px; background: #f8fafc; border-radius: 12px;">
            <h4 style="margin: 0 0 16px 0;"><i class="ri-gift-line"></i> Create New Gift Card</h4>
            <form id="giftCardForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Card Value ()
                <input type="number" id="giftCardValue" min="100" step="100" value="500" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Quantity
                <input type="number" id="giftCardQty" min="1" max="100" value="1" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px;">
                Expiry (Days from now)
                <input type="number" id="giftCardExpiry" min="30" max="365" value="365" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
              </label>
              <div style="grid-column: 1 / -1; display: flex; gap: 12px;">
                <button type="submit" class="primary"><i class="ri-check-line"></i> Generate Cards</button>
                <button type="button" class="secondary" id="cancelGiftCardBtn"><i class="ri-close-line"></i> Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!--  ADVANCED SYSTEMS MANAGEMENT -->
      
      <!-- Real-Time Manager Section -->
      <section id="realtime-manager" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-live-line"></i> Real-Time Manager</h2>
            <small>Monitor live connections and WebSocket status</small>
          </div>
          <div class="section-header-right">
            <button class="secondary" id="refreshRealtimeBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-radio-line"></i></div>
              <div class="stat-content">
                <small>ACTIVE CONNECTIONS</small>
                <strong id="realtimeConnections">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-message-3-line"></i></div>
              <div class="stat-content">
                <small>MESSAGES SENT</small>
                <strong id="realtimeMessages">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-time-line"></i></div>
              <div class="stat-content">
                <small>UPTIME</small>
                <strong id="realtimeUptime">N/A</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-database-2-line"></i></div>
              <div class="stat-content">
                <small>EVENTS</small>
                <strong id="realtimeEvents">0</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 12px; color: #374151;"><i class="ri-information-line"></i> WebSocket Status</h4>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="pill" id="wsStatus">Disconnected</span>
              <button class="secondary" id="reconnectRealtimeBtn">
                <i class="ri-restart-line"></i> Reconnect
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Newsletter Management Section -->
      <section id="newsletter" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-mail-send-line"></i> Newsletter Management</h2>
            <small>Create and send newsletters to subscribers</small>
          </div>
          <div class="section-header-right">
            <button class="secondary" id="refreshNewsletterBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
            <button class="primary" id="createNewsletterBtn"><i class="ri-add-line"></i> Create Newsletter</button>
          </div>
        </div>
        <div class="panel-body">
          <!-- Newsletter Stats -->
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-mail-line"></i></div>
              <div class="stat-content">
                <small>TOTAL NEWSLETTERS</small>
                <strong id="totalNewsletters">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper success"><i class="ri-send-plane-line"></i></div>
              <div class="stat-content">
                <small>SENT</small>
                <strong id="sentNewsletters">0</strong>
              </div>
            </div>
            <div class="stat-card stat-highlight">
              <div class="stat-icon-wrapper"><i class="ri-user-follow-line"></i></div>
              <div class="stat-content">
                <small>ACTIVE SUBSCRIBERS</small>
                <strong id="activeSubscribers">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-bar-chart-line"></i></div>
              <div class="stat-content">
                <small>OPEN RATE</small>
                <strong id="newsletterOpenRate">0%</strong>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="tabs-container" style="margin-bottom: 20px;">
            <div class="tabs-nav">
              <button class="tab-btn active" data-tab="newsletters-tab">Newsletters</button>
              <button class="tab-btn" data-tab="subscribers-tab">Subscribers</button>
            </div>
          </div>

          <!-- Newsletters Tab -->
          <div id="newsletters-tab" class="tab-content active">
            <div class="table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Recipients</th>
                    <th>Opens</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="newslettersTableBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                      <i class="ri-mail-line" style="font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.3;"></i>
                      No newsletters yet. Create your first newsletter!
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Subscribers Tab -->
          <div id="subscribers-tab" class="tab-content">
            <div class="table-wrapper">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Subscribed</th>
                    <th>Source</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="subscribersTableBody">
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                      <i class="ri-user-follow-line" style="font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.3;"></i>
                      No subscribers yet
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Security Manager Section -->
      <section id="security-manager" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-shield-check-line"></i> Security Manager</h2>
            <small>Monitor security events and threats <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="secondary" id="refreshSecurityBtn">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-danger">
              <div class="stat-icon-wrapper danger"><i class="ri-alert-line"></i></div>
              <div class="stat-content">
                <small>BLOCKED ATTEMPTS</small>
                <strong id="blockedAttempts">0</strong>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-check-line"></i></div>
              <div class="stat-content">
                <small>SECURE REQUESTS</small>
                <strong id="secureRequests">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-spam-line"></i></div>
              <div class="stat-content">
                <small>SPAM DETECTED</small>
                <strong id="spamDetected">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-shield-line"></i></div>
              <div class="stat-content">
                <small>SECURITY SCORE</small>
                <strong id="securityScore">95%</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 12px; color: #374151;"><i class="ri-settings-3-line"></i> Security Settings</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="toggle-switch-label">
                <input type="checkbox" id="allowDevConsoleEnabled">
                <span class="toggle-switch"></span>
                <span>Allow Developer Console Access</span>
                <small style="display: block; color: #6b7280; font-size: 11px; margin-left: 52px;">When disabled, DevTools will be blocked for regular users</small>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="rateLimitEnabled" checked>
                <span class="toggle-switch"></span>
                <span>Rate Limiting</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="csrfProtectionEnabled" checked>
                <span class="toggle-switch"></span>
                <span>CSRF Protection</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="xssProtectionEnabled" checked>
                <span class="toggle-switch"></span>
                <span>XSS Protection</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- ML Engine Section -->
      <section id="ml-engine" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-brain-line"></i> ML Engine</h2>
            <small>Machine learning models and predictions <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="primary" id="trainModelsBtn">
              <i class="ri-refresh-line"></i> Train Models
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-pie-chart-line"></i></div>
              <div class="stat-content">
                <small>MODEL ACCURACY</small>
                <strong id="mlAccuracy">87%</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-flashlight-line"></i></div>
              <div class="stat-content">
                <small>PREDICTIONS TODAY</small>
                <strong id="mlPredictions">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-database-line"></i></div>
              <div class="stat-content">
                <small>TRAINING DATA</small>
                <strong id="mlTrainingData">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-cpu-line"></i></div>
              <div class="stat-content">
                <small>ACTIVE MODELS</small>
                <strong id="mlModels">4</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-list-check"></i> Available Models</h4>
            <div style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="ri-shopping-cart-line"></i> Purchase Prediction</span>
                <span class="pill success">Active</span>
              </div>
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="ri-user-heart-line"></i> Churn Prediction</span>
                <span class="pill success">Active</span>
              </div>
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="ri-star-line"></i> Recommendation Engine</span>
                <span class="pill success">Active</span>
              </div>
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="ri-price-tag-3-line"></i> Price Optimization</span>
                <span class="pill success">Active</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Error Tracker Section -->
      <section id="error-tracker" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-bug-line"></i> Error Tracker</h2>
            <small>Monitor and track application errors <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="secondary" id="clearErrorsBtn">
              <i class="ri-delete-bin-line"></i> Clear All
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-danger">
              <div class="stat-icon-wrapper danger"><i class="ri-error-warning-line"></i></div>
              <div class="stat-content">
                <small>TOTAL ERRORS</small>
                <strong id="totalErrors">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-time-line"></i></div>
              <div class="stat-content">
                <small>ERRORS TODAY</small>
                <strong id="errorsToday">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-group-line"></i></div>
              <div class="stat-content">
                <small>AFFECTED USERS</small>
                <strong id="affectedUsers">0</strong>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-check-line"></i></div>
              <div class="stat-content">
                <small>ERROR RATE</small>
                <strong id="errorRate">0.1%</strong>
              </div>
            </div>
          </div>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Message</th>
                  <th>Page</th>
                  <th>User</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="errorsTableBody">
                <tr><td colspan="6" style="text-align: center; color: #6b7280;">No errors tracked</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- A/B Testing Section -->
      <section id="ab-testing" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-test-tube-line"></i> A/B Testing</h2>
            <small>Manage and monitor A/B tests <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="primary" id="createTestBtn">
              <i class="ri-add-line"></i> Create Test
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-flask-line"></i></div>
              <div class="stat-content">
                <small>ACTIVE TESTS</small>
                <strong id="activeTests">0</strong>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-checkbox-circle-line"></i></div>
              <div class="stat-content">
                <small>COMPLETED</small>
                <strong id="completedTests">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-user-line"></i></div>
              <div class="stat-content">
                <small>PARTICIPANTS</small>
                <strong id="testParticipants">0</strong>
              </div>
            </div>
            <div class="stat-card stat-warning">
              <div class="stat-icon-wrapper warning"><i class="ri-bar-chart-line"></i></div>
              <div class="stat-content">
                <small>AVG LIFT</small>
                <strong id="avgLift">+0%</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-list-check"></i> Recent Tests</h4>
            <div id="abTestsList" style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: white; border-radius: 8px; text-align: center; color: #6b7280;">
                No A/B tests configured
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Performance Optimizer Section -->
      <section id="performance-optimizer" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-speed-line"></i> Performance Optimizer</h2>
            <small>Monitor and optimize site performance <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="primary" onclick="window.performanceOptimizer?.analyzePerformance()">
              <i class="ri-search-line"></i> Analyze
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-dashboard-line"></i></div>
              <div class="stat-content">
                <small>PERFORMANCE SCORE</small>
                <strong id="perfScore">92</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-time-line"></i></div>
              <div class="stat-content">
                <small>AVG LOAD TIME</small>
                <strong id="avgLoadTime">1.2s</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-download-line"></i></div>
              <div class="stat-content">
                <small>PAGE SIZE</small>
                <strong id="pageSize">2.5 MB</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-file-line"></i></div>
              <div class="stat-content">
                <small>REQUESTS</small>
                <strong id="numRequests">45</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-flashlight-line"></i> Optimization Recommendations</h4>
            <div style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                <i class="ri-image-line" style="color: #10b981; font-size: 1.5rem;"></i>
                <span>Image optimization active</span>
              </div>
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                <i class="ri-flashlight-line" style="color: #10b981; font-size: 1.5rem;"></i>
                <span>Lazy loading enabled</span>
              </div>
              <div style="padding: 12px; background: white; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                <i class="ri-database-line" style="color: #10b981; font-size: 1.5rem;"></i>
                <span>Advanced caching active</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PWA Manager Section -->
      <section id="pwa-manager" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-smartphone-line"></i> PWA Manager</h2>
            <small>Progressive Web App status and settings <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-install-line"></i></div>
              <div class="stat-content">
                <small>INSTALLS</small>
                <strong id="pwaInstalls">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-notification-line"></i></div>
              <div class="stat-content">
                <small>PUSH SUBSCRIBERS</small>
                <strong id="pushSubscribers">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-wifi-off-line"></i></div>
              <div class="stat-content">
                <small>OFFLINE READY</small>
                <strong id="offlineReady">Yes</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper warning"><i class="ri-cache-line"></i></div>
              <div class="stat-content">
                <small>CACHE SIZE</small>
                <strong id="cacheSize">5.2 MB</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-settings-3-line"></i> PWA Features</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="toggle-switch-label">
                <input type="checkbox" id="pwaEnabled" checked>
                <span class="toggle-switch"></span>
                <span>PWA Enabled</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="pushNotifications" checked>
                <span class="toggle-switch"></span>
                <span>Push Notifications</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="offlineMode" checked>
                <span class="toggle-switch"></span>
                <span>Offline Mode</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="autoUpdate" checked>
                <span class="toggle-switch"></span>
                <span>Auto Update</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!--  WORLD-FIRST TECHNOLOGIES -->
      
      <!-- Emotion AI Section -->
      <section id="emotion-ai" class="admin-section admin-panel ai-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-emotion-line"></i> Emotion AI</h2>
            <small>Real-time emotion detection and adaptive UX <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="secondary" onclick="window.emotionAI?.startDetection()">
              <i class="ri-play-line"></i> Start Detection
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-emotion-happy-line"></i></div>
              <div class="stat-content">
                <small>HAPPY USERS</small>
                <strong id="happyUsers">68%</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-heart-pulse-line"></i></div>
              <div class="stat-content">
                <small>SENTIMENT SCORE</small>
                <strong id="sentimentScore">+0.7</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-user-smile-line"></i></div>
              <div class="stat-content">
                <small>DETECTIONS</small>
                <strong id="emotionDetections">0</strong>
              </div>
            </div>
            <div class="stat-card stat-warning">
              <div class="stat-icon-wrapper warning"><i class="ri-palette-line"></i></div>
              <div class="stat-content">
                <small>UX ADAPTATIONS</small>
                <strong id="uxAdaptations">0</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-settings-3-line"></i> Detection Settings</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="toggle-switch-label">
                <input type="checkbox" id="facialDetection" checked>
                <span class="toggle-switch"></span>
                <span>Facial Emotion Detection</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="textSentiment" checked>
                <span class="toggle-switch"></span>
                <span>Text Sentiment Analysis</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="behaviorAnalysis" checked>
                <span class="toggle-switch"></span>
                <span>Behavior Pattern Analysis</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="adaptiveUx" checked>
                <span class="toggle-switch"></span>
                <span>Adaptive UX</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- Biometric Auth Section -->
      <section id="biometric-auth" class="admin-section admin-panel">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-fingerprint-line"></i> Biometric Authentication</h2>
            <small>WebAuthn and passwordless login management</small>
          </div>
          <button class="btn btn-primary" onclick="loadBiometricUsers()">
            <i class="ri-refresh-line"></i> Refresh
          </button>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-shield-check-line"></i></div>
              <div class="stat-content">
                <small>BIOMETRIC USERS</small>
                <strong id="biometricUsers">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-login-box-line"></i></div>
              <div class="stat-content">
                <small>LOGINS TODAY</small>
                <strong id="biometricLogins">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-time-line"></i></div>
              <div class="stat-content">
                <small>AVG LOGIN TIME</small>
                <strong id="avgLoginTime">0.8s</strong>
              </div>
            </div>
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-percent-line"></i></div>
              <div class="stat-content">
                <small>SUCCESS RATE</small>
                <strong id="biometricSuccess">98.5%</strong>
              </div>
            </div>
          </div>

          <!-- User Biometric Management Section -->
          <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 24px;">
            <div class="biometric-header" style="padding: 16px 20px; border-bottom: 1px solid #e5e7eb;">
              <h4 style="margin: 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                <i class="ri-user-settings-line" style="color: #6366f1;"></i> User Biometric Management
              </h4>
              <div style="margin-top: 12px;">
                <input type="text" id="biometricUserSearch" placeholder="Search users..." style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; width: 100%; max-width: 300px;" onkeyup="filterBiometricUsers()">
              </div>
            </div>
            <div id="biometricUsersList" style="max-height: 400px; overflow-y: auto;">
              <div style="padding: 40px; text-align: center; color: #6b7280;">
                <i class="ri-loader-4-line" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                <p style="margin: 16px 0 0;">Loading biometric users...</p>
              </div>
            </div>
          </div>

          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-device-line"></i> Supported Authenticators</h4>
            <div class="responsive-grid">
              <div style="padding: 16px; background: white; border-radius: 8px; text-align: center;">
                <i class="ri-smartphone-line" style="font-size: 2rem; color: #3b82f6; margin-bottom: 8px;"></i>
                <div style="font-weight: 600;">Face ID</div>
                <div style="font-size: 0.85rem; color: #6b7280;">iOS Devices</div>
              </div>
              <div style="padding: 16px; background: white; border-radius: 8px; text-align: center;">
                <i class="ri-fingerprint-line" style="font-size: 2rem; color: #10b981; margin-bottom: 8px;"></i>
                <div style="font-weight: 600;">Touch ID</div>
                <div style="font-size: 0.85rem; color: #6b7280;">macOS/iOS</div>
              </div>
              <div style="padding: 16px; background: white; border-radius: 8px; text-align: center;">
                <i class="ri-fingerprint-2-line" style="font-size: 2rem; color: #f59e0b; margin-bottom: 8px;"></i>
                <div style="font-weight: 600;">Fingerprint</div>
                <div style="font-size: 0.85rem; color: #6b7280;">Android/Windows</div>
              </div>
              <div style="padding: 16px; background: white; border-radius: 8px; text-align: center;">
                <i class="ri-key-line" style="font-size: 2rem; color: #8b5cf6; margin-bottom: 8px;"></i>
                <div style="font-weight: 600;">Security Key</div>
                <div style="font-size: 0.85rem; color: #6b7280;">FIDO2 Keys</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Neural Commerce Section -->
      <section id="neural-commerce" class="admin-section admin-panel ai-section">
        <div class="section-header">
          <div class="section-header-left">
            <h2><i class="ri-brain-line"></i> Neural Commerce</h2>
            <small>AI-powered intent prediction and BCI-ready interface <span class="badge demo-badge" style="background: #dbeafe; color: #1d4ed8; font-size: 10px; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">DEMO</span></small>
          </div>
          <div class="section-header-right">
            <button class="secondary" onclick="window.neuralCommerce?.init()">
              <i class="ri-refresh-line"></i> Initialize
            </button>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card stat-success">
              <div class="stat-icon-wrapper success"><i class="ri-lightbulb-line"></i></div>
              <div class="stat-content">
                <small>INTENT PREDICTIONS</small>
                <strong id="intentPredictions">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper primary"><i class="ri-shopping-cart-line"></i></div>
              <div class="stat-content">
                <small>PURCHASE INTENTS</small>
                <strong id="purchaseIntents">0</strong>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-wrapper info"><i class="ri-focus-line"></i></div>
              <div class="stat-content">
                <small>AVG ATTENTION</small>
                <strong id="avgAttention">75%</strong>
              </div>
            </div>
            <div class="stat-card stat-warning">
              <div class="stat-icon-wrapper warning"><i class="ri-percent-line"></i></div>
              <div class="stat-content">
                <small>ACCURACY</small>
                <strong id="neuralAccuracy">82%</strong>
              </div>
            </div>
          </div>
          <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: #374151;"><i class="ri-settings-3-line"></i> Neural Features</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <label class="toggle-switch-label">
                <input type="checkbox" id="intentPrediction" checked>
                <span class="toggle-switch"></span>
                <span>Intent Prediction</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="eyeTracking" checked>
                <span class="toggle-switch"></span>
                <span>Eye Tracking (Experimental)</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="brainState" checked>
                <span class="toggle-switch"></span>
                <span>Brain State Tracking</span>
              </label>
              <label class="toggle-switch-label">
                <input type="checkbox" id="bciReady" checked>
                <span class="toggle-switch"></span>
                <span>BCI Integration (Future)</span>
              </label>
            </div>
          </div>
          <div style="background: #e0f2fe; padding: 20px; border-radius: 12px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px; color: #0c4a6e;"><i class="ri-information-line"></i> BCI Status</h4>
            <p style="margin: 0; color: #075985; font-size: 0.9rem;">
              Brain-Computer Interface integration is ready for future devices like Neuralink. 
              The system monitors behavioral patterns and prepares for direct neural input.
            </p>
          </div>
        </div>
      </section>
      </div><!-- /.admin-main -->
    </div><!-- /.admin-layout -->

    <script>
      // Server-only API configuration
      const API_BASE = '/api';
      
      // Local SVG placeholder generator - no external service needed
      function getPlaceholder(width = 100, height = 100, text = 'No Image') {
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
          <rect fill="#f0f0f0" width="${width}" height="${height}"/>
          <text fill="#999" font-family="Arial,sans-serif" font-size="${Math.min(width, height) / 8}" text-anchor="middle" x="${width/2}" y="${height/2}" dy=".3em">${text}</text>
        </svg>`;
        return 'data:image/svg+xml,' + encodeURIComponent(svg);
      }
      
      // Normalize upload URLs - converts /api/uploads/... to /uploads/... 
      // and handles relative paths for proper display
      function normalizeUploadUrl(url) {
        if (!url || url === 'undefined') return '/assets/img/placeholder.png';
        // Strip /api prefix from upload paths
        if (url.startsWith('/api/uploads')) {
          url = url.replace('/api/uploads', '/uploads');
        }
        // If it's a root-relative path, return as-is (browser will resolve)
        if (url.startsWith('/')) {
          return url;
        }
        // If it looks like just a filename (no slashes), assume it's in uploads/slides
        if (!url.includes('/') && /^[\w\-\.]+$/.test(url)) {
          return '/uploads/slides/' + url;
        }
        return url;
      }
      
      // Check API availability and show status
      async function checkApiAvailability() {
        const indicator = document.getElementById('apiStatusIndicator');
        const statusText = indicator?.querySelector('.status-text');
        
        try {
          const response = await fetch(`${API_BASE}/health`, { 
            method: 'GET',
            credentials: 'include',
            signal: AbortSignal.timeout(5000)
          });
          
          if (!response.ok) {
            throw new Error('API not available');
          }
          
          if (indicator) {
            indicator.className = 'api-status online';
            if (statusText) statusText.textContent = 'API Connected';
          }
          
          console.log('[Admin] API connected successfully');
          return true;
        } catch (e) {
          console.error('[Admin] API connection failed:', e);
          if (indicator) {
            indicator.className = 'api-status offline';
            if (statusText) statusText.textContent = 'Not Connected';
          }
          showNotification('Server connection failed. Please ensure the backend is running.', 'error');
          return false;
        }
      }

      // Handle authentication state changes
      window.addEventListener('auth:logout', () => {
        window.location.href = 'login.html?session=expired';
      });

      // API request helper with httpOnly cookie auth and timeout
      async function apiRequest(endpoint, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };
        
        // Use relative path for API requests to avoid CORS/domain issues
        const url = endpoint.startsWith('/api/') ? endpoint : (endpoint.startsWith('/') ? `/api${endpoint}` : `/api/${endpoint}`);
        
        try {
          const response = await fetch(url, { 
            ...options, 
            headers,
            signal: controller.signal,
            credentials: 'include' // Use httpOnly cookies for auth
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            const error = await response.json().catch(() => ({ message: 'Request failed' }));
            throw new Error(error.message || error.error || 'Request failed');
          }
          return response.json();
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timed out after 10 seconds');
          }
          throw error;
        }
      }

      // DOM element references (initialized when ready)
      let insightsGrid = null;
      let ordersBody = null;
      let productBody = null;
      let usersBody = null;
      let returnsBody = null;
      let exchangesBody = null;
      let cancellationsBody = null;
      let userCountLabel = null;
      let statsUpdatedEl = null;
      
      // Initialize DOM element references
      function initDOMElements() {
        insightsGrid = document.getElementById('insightsGrid');
        ordersBody = document.getElementById('ordersBody');
        productBody = document.getElementById('productBody');
        usersBody = document.getElementById('usersBody');
        returnsBody = document.getElementById('returnsBody');
        exchangesBody = document.getElementById('exchangesBody');
        cancellationsBody = document.getElementById('cancellationsBody');
        userCountLabel = document.getElementById('userCount');
        statsUpdatedEl = document.getElementById('statsUpdated');
      }
      
      // Ensure DOM elements are initialized
      function ensureDOMElements() {
        if (!insightsGrid) initDOMElements();
      }

      let products = [];
      let orders = [];
      let users = [];
      let returns = [];
      let exchanges = [];
      let cancellations = [];
      let editingProductId = null;

      // Fetch stats from API only
      async function fetchStats() {
        try {
          const [ordersData, usersData, returnsData, productsData] = await Promise.all([
            apiRequest('/orders').catch(() => ({ orders: [] })),
            apiRequest('/users').catch(() => ({ users: [] })),
            apiRequest('/returns').catch(() => ({ returns: [] })),
            apiRequest('/products').catch(() => ({ products: [] }))
          ]);
          
          const allOrders = ordersData.orders || [];
          const allUsers = usersData.users || [];
          const allReturns = returnsData.returns || [];
          const allProducts = productsData.products || [];
          
          // Calculate today's date range
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          // Calculate yesterday for sales trend
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          
          // Orders metrics
          const totalSales = allOrders.reduce((sum, o) => sum + (o.total || 0), 0);
          const todaysOrders = allOrders.filter(o => {
            const orderDate = new Date(o.createdAt);
            return orderDate >= today && orderDate < tomorrow;
          });
          const todaysRevenue = todaysOrders.reduce((sum, o) => sum + (o.total || 0), 0);
          
          // Calculate yesterday's revenue for trend
          const yesterdaysOrders = allOrders.filter(o => {
            const orderDate = new Date(o.createdAt);
            return orderDate >= yesterday && orderDate < today;
          });
          const yesterdaysRevenue = yesterdaysOrders.reduce((sum, o) => sum + (o.total || 0), 0);
          const isSaleDrop = todaysRevenue < yesterdaysRevenue;

          const pendingOrders = allOrders.filter(o => o.status === 'Pending').length;
          const completedOrders = allOrders.filter(o => o.status === 'Delivered' || o.status === 'Completed').length;
          const cancelledOrders = allOrders.filter(o => o.status === 'Cancelled').length;
          const processingOrders = allOrders.filter(o => o.status === 'Processing' || o.status === 'Shipped').length;
          const avgOrderValue = allOrders.length > 0 ? Math.round(totalSales / allOrders.length) : 0;
          
          // Returns metrics
          const pendingReturns = allReturns.filter(r => r.status === 'Pending').length;
          const approvedReturns = allReturns.filter(r => r.status === 'Approved' || r.status === 'Completed').length;
          
          // Products metrics
          const inventoryValue = allProducts.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
          const lowStockProducts = allProducts.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 10).length;
          const healthyStockProducts = allProducts.filter(p => (p.stock || 0) > 10).length;
          const outOfStockProducts = allProducts.filter(p => (p.stock || 0) === 0).length;
          const activeProducts = allProducts.filter(p => p.active !== false).length;
          
          // Users metrics
          const todaysUsers = allUsers.filter(u => {
            const userDate = new Date(u.createdAt);
            return userDate >= today && userDate < tomorrow;
          }).length;
          const customers = allUsers.filter(u => u.role !== 'admin').length;
          
          return [
            { label: "Today's Revenue", value: `${todaysRevenue.toLocaleString()}`, icon: 'ri-coin-line', color: 'success', highlight: true },
            { label: 'Sales Trend', value: isSaleDrop ? 'Dropping' : 'Growing', icon: isSaleDrop ? 'ri-arrow-right-down-line' : 'ri-arrow-right-up-line', color: isSaleDrop ? 'danger' : 'success' },
            { label: 'Total Sales', value: `${totalSales.toLocaleString()}`, icon: 'ri-money-dollar-circle-line', color: 'primary' },
            { label: 'Avg Order Value', value: `${avgOrderValue.toLocaleString()}`, icon: 'ri-scales-3-line', color: 'info' },
            { label: "Today's Orders", value: todaysOrders.length, icon: 'ri-shopping-cart-2-line', color: 'success' },
            { label: 'Total Orders', value: allOrders.length, icon: 'ri-shopping-cart-line', color: 'primary' },
            { label: 'Pending Orders', value: pendingOrders, icon: 'ri-time-line', color: pendingOrders > 0 ? 'warning' : 'success' },
            { label: 'Processing/Shipped', value: processingOrders, icon: 'ri-truck-line', color: 'info' },
            { label: 'Completed Orders', value: completedOrders, icon: 'ri-checkbox-circle-line', color: 'success' },
            { label: 'Cancelled Orders', value: cancelledOrders, icon: 'ri-close-circle-line', color: cancelledOrders > 0 ? 'danger' : 'muted' },
            { label: 'Pending Returns', value: pendingReturns, icon: 'ri-arrow-go-back-line', color: pendingReturns > 0 ? 'warning' : 'success' },
            { label: 'Completed Returns', value: approvedReturns, icon: 'ri-checkbox-circle-line', color: 'muted' },
            { label: 'Total Products', value: allProducts.length, icon: 'ri-shopping-bag-line', color: 'primary' },
            { label: 'Active Products', value: activeProducts, icon: 'ri-checkbox-line', color: 'success' },
            { label: 'Low Stock', value: lowStockProducts, icon: 'ri-alarm-warning-line', color: lowStockProducts > 0 ? 'danger' : 'success' },
            { label: 'Healthy Stock', value: healthyStockProducts, icon: 'ri-stack-line', color: 'success' },
            { label: 'Out of Stock', value: outOfStockProducts, icon: 'ri-error-warning-line', color: outOfStockProducts > 0 ? 'danger' : 'success' },
            { label: 'Inventory Value', value: `${inventoryValue.toLocaleString()}`, icon: 'ri-store-2-line', color: 'primary' },
            { label: 'Total Users', value: allUsers.length, icon: 'ri-group-line', color: 'primary' },
            { label: 'Customers', value: customers, icon: 'ri-user-star-line', color: 'info' },
            { label: 'New Users Today', value: todaysUsers, icon: 'ri-user-add-line', color: todaysUsers > 0 ? 'success' : 'muted' },
            { label: 'Total Returns', value: allReturns.length, icon: 'ri-exchange-line', color: 'muted' }
          ];
        } catch (error) {
          console.error('Failed to fetch stats:', error);
          showNotification('Failed to load statistics', 'error');
          return [];
        }
      }

      async function renderStats() {
        // Ensure DOM elements are initialized
        if (!insightsGrid) {
          insightsGrid = document.getElementById('insightsGrid');
        }
        if (!statsUpdatedEl) {
          statsUpdatedEl = document.getElementById('statsUpdated');
        }
        
        if (!insightsGrid) {
          console.error('[Admin] insightsGrid element not found in renderStats');
          return;
        }
        
        const stats = await fetchStats();
        
        if (!stats || stats.length === 0) {
          console.warn('[Admin] No stats data in renderStats');
          return;
        }
        
        // Border classes for insight cards
        const borderClasses = {
          'success': 'border-success',
          'warning': 'border-warning',
          'danger': 'border-danger',
          'primary': 'border-primary',
          'info': 'border-info',
          'muted': 'border-muted'
        };
        
        insightsGrid.innerHTML = stats
          .map(stat => {
            const borderClass = stat.color ? (borderClasses[stat.color] || '') : '';
            const highlightClass = stat.highlight ? 'highlight' : '';
            const iconColor = stat.color || 'primary';
            return `
              <div class="insight-card ${borderClass} ${highlightClass}">
                <div class="insight-icon ${iconColor}">
                  <i class="${stat.icon || 'ri-bar-chart-line'}"></i>
                </div>
                <div class="insight-content">
                  <span class="insight-label">${stat.label}</span>
                  <span class="insight-value">${stat.value}</span>
                </div>
              </div>
            `;
          })
          .join('');
        if (statsUpdatedEl) statsUpdatedEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      }

      // Products - Load from API only
      async function fetchProducts() {
        try {
          const data = await apiRequest('/products');
          products = data.products || data || [];
          renderProducts();
        } catch (e) {
          console.error('Failed to fetch products:', e);
          showNotification('Failed to load products from server', 'error');
          products = [];
          renderProducts();
        }
      }

      function renderProducts() {
        if (!products.length) {
          productBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No products added yet</td></tr>';
          return;
        }
        productBody.innerHTML = products
          .map(product => {
            const positionBadge = product.position 
              ? `<span class="position-badge">${product.position}</span>` 
              : `<span class="position-badge empty">-</span>`;
            // Handle both old thumbImage (string) and new thumbImages (array)
            const thumbnails = product.thumbImages && product.thumbImages.length > 0 
              ? product.thumbImages 
              : (product.thumbImage ? [product.thumbImage] : [product.image]);
            const thumbsHtml = thumbnails.filter(t => t).slice(0, 3).map((thumb, i) => 
              `<img src="${normalizeUploadUrl(thumb)}" alt="${product.name} thumb ${i+1}" title="Thumbnail ${i+1}" class="thumb-img" style="${i > 0 ? 'margin-left: -8px;' : ''}" onerror="this.src=getPlaceholder(36,36,'Thumb')" />`
            ).join('') + (thumbnails.length > 3 ? `<span class="more-thumbs">+${thumbnails.length - 3}</span>` : '') || `<img src="${getPlaceholder(36,36,'Thumb')}" alt="No thumbnail" class="thumb-img" />`;
            
            // Stock status badge
            const isOutOfStock = product.isOutOfStock || product.stockStatus === 'out-of-stock';
            const stockStatusBadge = isOutOfStock 
              ? '<span class="stock-status-badge out-of-stock"><i class="ri-close-circle-line"></i> Out of Stock</span>'
              : '<span class="stock-status-badge in-stock"><i class="ri-checkbox-circle-line"></i> In Stock</span>';
            
            // SKU and Barcode display
            const skuDisplay = product.sku ? `<code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:0.75rem;">${product.sku}</code>` : '<span style="color:#9ca3af;font-size:0.75rem;">Not set</span>';
            const barcodeDisplay = product.barcode ? `<span style="font-size:0.7rem;color:#6b7280;">${product.barcode}</span>` : '';
            
            return `
            <tr class="${isOutOfStock ? 'out-of-stock-row' : ''}">
              <td data-label="Position">${positionBadge}</td>
              <td data-label="Product">
                <div class="product-label">
                  <div class="product-images">
                    <img src="${product.image ? normalizeUploadUrl(product.image) : getPlaceholder(56,56,'Main')}" alt="${product.name}" title="Main Image" onerror="this.src=getPlaceholder(56,56,'Main')" />
                    <div class="thumbs-container">${thumbsHtml}</div>
                  </div>
                  <div>
                    <strong>${product.name}</strong>
                    <span class="product-id">ID: ${product.id.slice(0, 8)}...</span>
                    ${stockStatusBadge}
                  </div>
                </div>
              </td>
              <td data-label="Price"><strong>${(product.price || 0).toLocaleString()}</strong></td>
              <td data-label="SKU / Barcode">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  ${skuDisplay}
                  ${barcodeDisplay}
                </div>
              </td>
              <td data-label="Color / Size"><span class="color-size-badge">${product.color || '-'}  ${product.size || '-'}</span></td>
              <td data-label="Inventory"><span class="stock-badge ${(product.stock || 0) < 10 ? 'low-stock' : ''}">${product.stock || 0} units</span></td>
              <td data-label="Actions" class="actions">
                <button type="button" data-action="edit" data-id="${product.id}" aria-label="Edit" title="Edit product">
                  <i class="ri-pencil-line"></i>
                </button>
                <button type="button" data-action="delete" data-id="${product.id}" aria-label="Delete" title="Delete product">
                  <i class="ri-delete-bin-6-line"></i>
                </button>
              </td>
            </tr>
          `;
          })
          .join('');
        
        // Check and display low stock notification
        checkAndDisplayLowStockNotification();
      }

      function checkAndDisplayLowStockNotification() {
        const LOW_STOCK_THRESHOLD = 10;
        const lowStockProducts = products.filter(p => (p.stock || 0) < LOW_STOCK_THRESHOLD && (p.stock || 0) > 0);
        const outOfStockProducts = products.filter(p => (p.stock || 0) === 0);
        
        const notificationEl = document.getElementById('lowStockNotification');
        const messageEl = document.getElementById('lowStockMessage');
        
        if (!notificationEl) return;
        
        if (lowStockProducts.length > 0 || outOfStockProducts.length > 0) {
          let message = '';
          if (outOfStockProducts.length > 0 && lowStockProducts.length > 0) {
            message = `${outOfStockProducts.length} product(s) out of stock, ${lowStockProducts.length} product(s) low on stock`;
          } else if (outOfStockProducts.length > 0) {
            message = `${outOfStockProducts.length} product(s) out of stock`;
          } else {
            message = `${lowStockProducts.length} product(s) low on stock`;
          }
          messageEl.textContent = message;
          notificationEl.style.display = 'block';
        } else {
          notificationEl.style.display = 'none';
        }
      }

      // ===============================
      // SLIDER MANAGEMENT FUNCTIONS
      // ===============================
      
      let slidesData = [];

      async function loadSlides() {
        const slidesIndicator = document.getElementById('slidesRefreshIndicator');
        const slidesLastUpdate = document.getElementById('slidesLastUpdate');
        
        if (slidesIndicator) slidesIndicator.classList.add('loading');
        
        try {
          const response = await apiRequest('/slides/all');
          slidesData = response.slides || [];
          renderSlides();
          
          if (slidesLastUpdate) {
            slidesLastUpdate.textContent = new Date().toLocaleTimeString();
          }
        } catch (error) {
          console.error('Failed to load slides:', error);
          showNotification('Failed to load slides from server', 'error');
          slidesData = [];
          renderSlides();
        } finally {
          if (slidesIndicator) slidesIndicator.classList.remove('loading');
        }
      }

      function renderSlides() {
        const container = document.getElementById('slideCards');
        if (!container) return;

        const slidesHtml = slidesData
          .sort((a, b) => (a.position || 0) - (b.position || 0))
          .map(slide => {
            const isVideo = slide.type === 'video';
            const isActive = slide.active !== false;
            const normalizedSrc = normalizeUploadUrl(slide.src);
            
            const previewHtml = isVideo 
              ? `<video src="${normalizedSrc}" muted playsinline preload="metadata"></video>`
              : `<img src="${normalizedSrc}" alt="${slide.title || 'Slide'}" onerror="this.style.opacity='0.3'" />`;
            
            return `
              <div class="slide-card ${!isActive ? 'inactive' : ''}" data-id="${slide.id}">
                <div class="slide-preview">
                  ${previewHtml}
                  <span class="slide-type-badge">
                    <i class="${isVideo ? 'ri-video-line' : 'ri-image-line'}"></i>
                    ${slide.type}
                  </span>
                  <span class="slide-position-badge">${slide.position || '-'}</span>
                </div>
                <div class="slide-info">
                  <h4>${slide.title || 'Untitled Slide'}</h4>
                  <p>${slide.src}</p>
                </div>
                <div class="slide-actions">
                  <button type="button" class="slide-btn-edit" data-action="edit" data-slide-id="${slide.id}">
                    <i class="ri-edit-line"></i> Edit
                  </button>
                  <button type="button" class="slide-btn-toggle ${!isActive ? 'inactive' : ''}" data-action="toggle" data-slide-id="${slide.id}" data-new-state="${!isActive}">
                    <i class="${isActive ? 'ri-eye-off-line' : 'ri-eye-line'}"></i> ${isActive ? 'Hide' : 'Show'}
                  </button>
                  <button type="button" class="slide-btn-delete" data-action="delete" data-slide-id="${slide.id}">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </div>
              </div>
            `;
          }).join('');

        // Add "Add New Slide" card
        const addCardHtml = `
          <div class="slide-card add-slide-card" data-action="add-slide">
            <i class="ri-add-circle-line"></i>
            <span>Add New Slide</span>
          </div>
        `;

        container.innerHTML = slidesHtml + addCardHtml;
      }

      function openSlideModal(slide = null) {
        const modal = document.getElementById('slideModal');
        const title = document.getElementById('slideModalTitle');
        const submitBtn = document.getElementById('slideSubmitBtn');
        const deleteBtn = document.getElementById('slideDeleteBtn');
        
        // Reset form
        document.getElementById('slideForm').reset();
        document.getElementById('slideId').value = '';
        
        if (slide) {
          // Edit mode
          title.innerHTML = '<i class="ri-edit-line"></i> Edit Slide';
          submitBtn.textContent = 'Save Changes';
          
          document.getElementById('slideId').value = slide.id;
          document.getElementById('slideType').value = slide.type || 'video';
          document.getElementById('slideSrc').value = slide.src || '';
          document.getElementById('slideTitle').value = slide.title || '';
          document.getElementById('slidePosition').value = slide.position || 1;
          document.getElementById('slideActive').value = slide.active !== false ? 'true' : 'false';
          
          // Show delete button in edit mode
          if (deleteBtn) {
            deleteBtn.style.display = 'inline-flex';
            deleteBtn.dataset.id = slide.id;
          }
        } else {
          // Add mode
          title.innerHTML = '<i class="ri-add-line"></i> Add New Slide';
          submitBtn.textContent = 'Add Slide';
          document.getElementById('slidePosition').value = slidesData.length + 1;
          
          // Hide delete button in add mode
          if (deleteBtn) {
            deleteBtn.style.display = 'none';
          }
        }
        
        updateSlidePreview();
        modal.style.display = 'flex';
      }

      function closeSlideModal() {
        document.getElementById('slideModal').style.display = 'none';
      }

      function updateSlidePreview() {
        const type = document.getElementById('slideType').value;
        const src = document.getElementById('slideSrc').value;
        const previewBox = document.getElementById('slidePreviewBox');
        
        if (!src) {
          previewBox.innerHTML = '<span>Enter a source to preview</span>';
          return;
        }
        
        const normalizedSrc = normalizeUploadUrl(src);
        
        if (type === 'video') {
          previewBox.innerHTML = `<video src="${normalizedSrc}" muted playsinline preload="metadata" controls></video>`;
        } else {
          previewBox.innerHTML = `<img src="${normalizedSrc}" alt="Preview" onerror="this.parentElement.innerHTML='<span>Image not found</span>'" />`;
        }
      }

      function editSlide(id) {
        const slide = slidesData.find(s => s.id === id);
        if (slide) {
          openSlideModal(slide);
        }
      }

      async function toggleSlide(id, newActiveState) {
        try {
          await apiRequest(`/slides/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ active: newActiveState })
          });
          
          // Update local data
          const slide = slidesData.find(s => s.id === id);
          if (slide) slide.active = newActiveState;
          
          renderSlides();
          showNotification(`Slide ${newActiveState ? 'activated' : 'hidden'} successfully`, 'success');
        } catch (error) {
          console.error('Failed to toggle slide:', error);
          showNotification('Failed to update slide status', 'error');
        }
      }

      async function deleteSlide(id, skipConfirm = false, e = null) {
        if (!skipConfirm) {
          const confirmed = await showConfirmModal({
            title: 'Delete Slide',
            message: 'Are you sure you want to delete this slide? This action cannot be undone.',
            confirmText: 'Yes, Delete',
            cancelText: 'Cancel',
            type: 'danger',
            event: e
          });
          if (!confirmed) return;
        }
        
        try {
          await apiRequest(`/slides/${id}`, { method: 'DELETE' });
          slidesData = slidesData.filter(s => s.id !== id);
          renderSlides();
          showNotification('Slide deleted successfully', 'success');
        } catch (error) {
          console.error('Failed to delete slide:', error);
          showNotification('Failed to delete slide', 'error');
        }
      }

      // Slide form submission
      
      // Handle slide file upload
      async function handleSlideFileUpload() {
        const fileInput = document.getElementById('slideFile');
        const srcInput = document.getElementById('slideSrc');
        const typeSelect = document.getElementById('slideType');
        
        if (!fileInput.files || fileInput.files.length === 0) return;
        
        const file = fileInput.files[0];
        
        // Auto-detect media type
        if (file.type.startsWith('video/')) {
          typeSelect.value = 'video';
        } else if (file.type.startsWith('image/')) {
          typeSelect.value = 'image';
        }
        
        // Set placeholder text while uploading
        srcInput.value = 'Uploading file...';
        srcInput.disabled = true;
        
        try {
          // Upload using multipart/form-data (streamed)
          const fd = new FormData();
          fd.append('media', file);
          fd.append('type', typeSelect.value);
          fd.append('slideId', document.getElementById('slideId').value || 'slide');

          const resp = await fetch(API_BASE + '/uploads/slide-media', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          });

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || 'Upload failed');
          }

          const response = await resp.json();
          if (response && response.url) {
            srcInput.value = response.url;
            updateSlidePreview();
            // Refresh slides list so uploaded media appears in admin UI immediately
            try { loadSlides(); } catch (e) { /* ignore if not available */ }
          } else {
            throw new Error('Upload did not return a URL');
          }
        } catch (error) {
          console.error('Failed to upload slide file:', error);
          srcInput.value = '';
          showNotification('Failed to upload file', 'error');
        } finally {
          srcInput.disabled = false;
        }
      }
      
      // Slide form submit and refresh listeners are attached on DOMContentLoaded

      // ===============================
      // END SLIDER MANAGEMENT
      // ===============================

      // Orders - Real-time tracking
      let ordersAutoRefreshInterval = null;
      let usersAutoRefreshInterval = null;
      const REFRESH_INTERVAL = 30000; // 30 seconds

      function updateRefreshIndicator(type, loading = false) {
        const indicator = document.getElementById(`${type}RefreshIndicator`);
        const lastUpdate = document.getElementById(`${type}LastUpdate`);
        if (indicator) {
          indicator.classList.toggle('loading', loading);
          indicator.classList.toggle('active', !loading);
        }
        if (lastUpdate && !loading) {
          lastUpdate.textContent = new Date().toLocaleTimeString();
        }
      }

      function getStatusBadgeClass(status) {
        const statusMap = {
          'Pending': 'status-pending',
          'Processing': 'status-processing',
          'Shipped': 'status-shipped',
          'Delivered': 'status-delivered',
          'Cancelled': 'status-cancelled'
        };
        return statusMap[status] || 'status-pending';
      }

      async function fetchOrders() {
        updateRefreshIndicator('orders', true);
        try {
          const data = await apiRequest('/orders');
          orders = data.orders || [];
        } catch (e) {
          console.error('Failed to fetch orders:', e);
          showNotification('Failed to load orders from server', 'error');
          orders = [];
        }
        renderOrders();
        updateRefreshIndicator('orders', false);
      }

      function renderOrders() {
        if (!orders.length) {
          ordersBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No orders yet</td></tr>';
          return;
        }
        ordersBody.innerHTML = orders
          .map(order => {
            const dateStr = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-';
            const timeStr = order.createdAt ? new Date(order.createdAt).toLocaleTimeString() : '';
            
            // Build items detail with images
            const itemsHtml = order.items?.map(i => {
              const product = products.find(p => p.id === i.id || p.id === i.productId);
              const imageUrl = i.image || i.thumbImage || (product && (product.image || product.thumbImages?.[0])) || '';
              const hasImage = imageUrl && imageUrl !== '' && !imageUrl.includes('placeholder');
              const imgSrc = hasImage ? normalizeUploadUrl(imageUrl) : '';
              return `<div class="item" style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                ${hasImage ? `<img src="${imgSrc}" alt="" style="width: 24px; height: 24px; object-fit: cover; border-radius: 3px;" onerror="this.style.display='none'">` : ''}
                <span>${i.name || 'Product'} <small>(${i.selectedSize || i.size || '-'}/${i.selectedColor || i.color || '-'}) x${i.quantity || 1}</small></span>
              </div>`;
            }).join('') || '<div class="item">-</div>';
            
            // Build address
            const addr = order.address || {};
            const addressStr = [addr.street, addr.city, addr.state, addr.postal].filter(Boolean).join(', ') || '-';
            
            return `
              <tr>
                <td><input type="checkbox" class="order-checkbox" data-id="${order.id}" aria-label="Select order ${order.id}" /></td>
                <td data-label="Order #">
                  <strong>${order.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Customer">
                  <strong>${order.shippingInfo?.name || order.userName || order.customer?.name || '-'}</strong>
                  <div style="font-size:0.75rem;color:#6b7280;">${order.shippingInfo?.email || order.userEmail || order.customer?.email || ''}</div>
                  <div style="font-size:0.75rem;color:#9ca3af;">${order.shippingInfo?.phone || order.customer?.phone || ''}</div>
                </td>
                <td data-label="Amount"><strong>${(order.total || order.amount || 0).toLocaleString()}</strong></td>
                <td data-label="Date">${dateStr}</td>
                <td data-label="Status">
                  <select class="order-status" data-id="${order.id}" aria-label="Order ${order.id} status">
                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}> Processing</option>
                    <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}> Shipped</option>
                    <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}> Delivered</option>
                    <option value="Return Requested" ${order.status === 'Return Requested' ? 'selected' : ''}> Return Requested</option>
                    <option value="Exchange Requested" ${order.status === 'Exchange Requested' ? 'selected' : ''}> Exchange Requested</option>
                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}> Cancelled</option>
                  </select>
                </td>
                <td data-label="Items">
                  <div class="order-items-detail">${itemsHtml}</div>
                </td>
                <td data-label="Address">
                  <div class="order-address" title="${order.shippingInfo?.address || ''}, ${order.shippingInfo?.city || ''}, ${order.shippingInfo?.state || ''} ${order.shippingInfo?.postalCode || ''}">${(() => {
                    const addr = order.shippingInfo || order.address || {};
                    const fullAddr = [addr.address || addr.street, addr.city, addr.state, addr.postalCode || addr.postal].filter(Boolean).join(', ');
                    return fullAddr.length > 40 ? fullAddr.slice(0, 40) + '...' : (fullAddr || '-');
                  })()}</div>
                </td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-order" data-id="${order.id}" aria-label="View" title="View order details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-order" data-id="${order.id}" aria-label="Delete" title="Delete order">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        // Attach status change handlers - track pending changes
        document.querySelectorAll('.order-status').forEach(select => {
          // Store original value for comparison
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const orderId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              // Add to pending changes
              pendingOrderChanges.set(orderId, newStatus);
              e.target.classList.add('status-changed');
            } else {
              // Remove from pending if reverted to original
              pendingOrderChanges.delete(orderId);
              e.target.classList.remove('status-changed');
            }
            updatePendingOrderUI();
          });
        });

        // Attach order action handlers
        document.querySelectorAll('[data-action="view-order"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const orderId = btn.dataset.id;
            const order = orders.find(o => o.id === orderId);
            if (order) {
              // Get customer info from shippingInfo, order fields, or customer object
              const customerName = order.shippingInfo?.name || order.userName || order.customer?.name || '-';
              const customerEmail = order.shippingInfo?.email || order.userEmail || order.customer?.email || '-';
              const customerPhone = order.shippingInfo?.phone || order.userPhone || order.customer?.phone || '-';
              const addressStreet = order.shippingInfo?.address || order.address?.street || '-';
              const addressCity = order.shippingInfo?.city || order.address?.city || '';
              const addressState = order.shippingInfo?.state || order.address?.state || '';
              const addressPostal = order.shippingInfo?.pincode || order.shippingInfo?.postal || order.address?.postal || '';
              const orderTotal = order.total || order.amount || 0;
              
              const details = `
Order ID: ${order.id}
Status: ${order.status}
Date: ${order.createdAt ? new Date(order.createdAt).toLocaleString() : '-'}

Customer:
  Name: ${customerName}
  Email: ${customerEmail}
  Phone: ${customerPhone}

Items:
${order.items?.map(i => `  - ${i.name} (${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1} = ${((i.price || 0) * (i.quantity || 1)).toLocaleString()}`).join('\n') || '  No items'}

Shipping Address:
  ${addressStreet}
  ${addressCity} ${addressState} ${addressPostal}

Amount: ${orderTotal.toLocaleString()}
Payment: ${order.paymentMethod || 'COD'} ${order.paymentStatus === 'paid' ? '(Paid)' : '(Pending)'}
              `;
              // Show details in modal instead of blocking alert
              showModal('Order Details', '<pre style="white-space:pre-wrap;">' + details.replace(/</g, '&lt;') + '</pre>', null, e);
            }
          });
        });

        document.querySelectorAll('[data-action="delete-order"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = btn.dataset.id;
            const confirmed = await AdminUniModal.danger('Delete Order', `Are you sure you want to delete order ${orderId}? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
              await apiRequest(`/orders/${orderId}`, { method: 'DELETE' });
              showNotification('Order deleted successfully', 'success');
              await fetchOrders();
              await renderStats();
            } catch (e) {
              console.error('Failed to delete order:', e);
              showNotification('Failed to delete order', 'error');
            }
          });
        });
      }

      // Returns table rendering
      function renderReturnsTable(returnsList) {
        if (!returnsList || !returnsList.length) {
          returnsBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No returns yet</td></tr>';
          return;
        }

        returnsBody.innerHTML = returnsList
          .map(ret => {
            const dateStr = ret.requestedAt ? new Date(ret.requestedAt).toLocaleDateString() : '-';
            const timeStr = ret.requestedAt ? new Date(ret.requestedAt).toLocaleTimeString() : '';

            const itemsHtml = ret.items?.map(i =>
              `<div class="item">${i.name || 'Product'} <small>(${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1}</small></div>`
            ).join('') || '<div class="item">-</div>';

            // Get customer details from order or return data
            const order = orders.find(o => o.id === ret.orderId) || {};
            const customerName = order.shippingInfo?.name || order.userName || ret.customer?.name || '-';
            const customerEmail = order.shippingInfo?.email || order.userEmail || ret.customer?.email || '';
            const customerPhone = order.shippingInfo?.phone || ret.customer?.phone || '';
            const customerHtml = `<strong>${customerName}</strong><div style="font-size:0.75rem;color:#6b7280;">${customerEmail}</div><div style="font-size:0.75rem;color:#9ca3af;">${customerPhone}</div>`;

            const reason = ret.reason || ret.reasonText || '-';
            const status = ret.status || 'Pending';

            return `
              <tr>
                <td><input type="checkbox" class="return-checkbox" data-id="${ret.id}" aria-label="Select return ${ret.id}" /></td>
                <td data-label="Return ID">
                  <strong>${ret.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Order ID"><strong>${ret.orderId || '-'}</strong></td>
                <td data-label="Customer">${customerHtml}</td>
                <td data-label="Items">
                  <div class="order-items-detail">${itemsHtml}</div>
                </td>
                <td data-label="Reason">${reason}</td>
                <td data-label="Status">
                  <select class="return-status" data-id="${ret.id}" aria-label="Return ${ret.id} status">
                    <option value="Pending" ${status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Approved" ${status === 'Approved' ? 'selected' : ''}> Approved</option>
                    <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}> Rejected</option>
                    <option value="Pickup Scheduled" ${status === 'Pickup Scheduled' ? 'selected' : ''}> Pickup Scheduled</option>
                    <option value="Picked Up" ${status === 'Picked Up' ? 'selected' : ''}> Picked Up</option>
                    <option value="Processing" ${status === 'Processing' ? 'selected' : ''}> Processing</option>
                    <option value="Refunded" ${status === 'Refunded' ? 'selected' : ''}> Refunded</option>
                    <option value="Completed" ${status === 'Completed' ? 'selected' : ''}> Completed</option>
                  </select>
                </td>
                <td data-label="Requested">${dateStr}</td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-return" data-id="${ret.id}" aria-label="View" title="View return details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-return" data-id="${ret.id}" aria-label="Delete" title="Delete return">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        // Attach status change handlers - track pending changes
        document.querySelectorAll('.return-status').forEach(select => {
          // Store original value for comparison
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const returnId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              // Add to pending changes
              pendingReturnChanges.set(returnId, { status: newStatus, adminNotes: '' });
              e.target.classList.add('status-changed');
            } else {
              // Remove from pending if reverted to original
              pendingReturnChanges.delete(returnId);
              e.target.classList.remove('status-changed');
            }
            updatePendingReturnUI();
          });
        });

        // Attach view/delete handlers
        document.querySelectorAll('[data-action="view-return"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const returnId = btn.dataset.id;
            const r = returns.find(x => x.id === returnId);
            if (r) {
              // Look up the order to get customer info
              const order = orders.find(o => o.id === r.orderId) || {};
              const customerName = order.shippingInfo?.name || order.userName || r.customer?.name || '-';
              const customerEmail = order.shippingInfo?.email || order.userEmail || r.customer?.email || '-';
              const customerPhone = order.shippingInfo?.phone || r.customer?.phone || '-';
              const details = `Return ID: ${r.id}\nOrder ID: ${r.orderId || '-'}\nStatus: ${r.status || '-'}\nRequested: ${r.requestedAt ? new Date(r.requestedAt).toLocaleString() : '-'}\n\nCustomer:\n  Name: ${customerName}\n  Email: ${customerEmail}\n  Phone: ${customerPhone}\n\nItems:\n${r.items?.map(i => `  - ${i.name} (${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1} = ${((i.price||0) * (i.quantity||1)).toLocaleString()}`).join('\n') || '  No items'}\n\nReason:\n  ${r.reason || r.reasonText || '-'}\n\nComments:\n  ${r.comments || '-'} `;
              showModal('Return Details', '<pre style="white-space:pre-wrap;">' + details.replace(/</g, '&lt;') + '</pre>', null, e);
            }
          });
        });

        document.querySelectorAll('[data-action="delete-return"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const returnId = btn.dataset.id;
            const confirmed = await AdminUniModal.danger('Delete Return Request', `Are you sure you want to delete return ${returnId}? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
              await apiRequest(`/returns/${returnId}`, { method: 'DELETE' });
              showNotification('Return request deleted', 'success');
              await fetchReturns();
              await renderStats();
            } catch (e) {
              console.error('Failed to delete return:', e);
              showNotification('Failed to delete return request', 'error');
            }
          });
        });
      }

      // Users - Real-time tracking from API
      async function fetchUsers() {
        updateRefreshIndicator('users', true);
        try {
          const data = await apiRequest('/users');
          users = data.users || [];
        } catch (e) {
          console.error('Failed to fetch users:', e);
          showNotification('Failed to load users from server', 'error');
          users = [];
        }
        renderUsers();
        updateRefreshIndicator('users', false);
      }

      function renderUsers() {
        const customerCountEl = document.getElementById('customerCount');
        const adminCountEl = document.getElementById('adminCount');
        const roleFilter = document.getElementById('userRoleFilter')?.value || '';
        const sortBy = document.getElementById('userSortBy')?.value || 'newest';
        const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';

        // Filter users
        let filteredUsers = users.filter(user => {
          // Role filter
          if (roleFilter && user.role !== roleFilter) {
            return false;
          }

          // Search filter
          if (searchTerm) {
            const name = (user.name || '').toLowerCase();
            const email = (user.email || '').toLowerCase();
            const phone = (user.phone || '').toLowerCase();

            if (!name.includes(searchTerm) && !email.includes(searchTerm) && !phone.includes(searchTerm)) {
              return false;
            }
          }

          return true;
        });

        if (!filteredUsers.length) {
          const hasFilters = roleFilter || searchTerm;
          const message = hasFilters
            ? 'No users found matching your search and filter criteria'
            : 'No users registered yet';
          const icon = hasFilters ? 'ri-search-line' : 'ri-user-unfollow-line';
          usersBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:#9ca3af;"><i class="${icon}" style="font-size:2rem;display:block;margin-bottom:8px;"></i>${message}</td></tr>`;
          return;
        }

        // Sort users
        filteredUsers.sort((a, b) => {
          switch (sortBy) {
            case 'oldest':
              return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
            case 'name':
              return (a.name || '').localeCompare(b.name || '');
            case 'email':
              return (a.email || '').localeCompare(b.email || '');
            case 'newest':
            default:
              return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          }
        });

        const customers = users.filter(u => u.role !== 'admin');
        const admins = users.filter(u => u.role === 'admin');

        usersBody.innerHTML = filteredUsers
          .map(user => {
            const isAdmin = user.role === 'admin';
            const roleClass = isAdmin ? 'user-role-admin' : 'user-role-customer';
            const rowClass = isAdmin ? 'user-row-admin' : 'user-row-customer';
            const roleIcon = isAdmin ? 'ri-admin-line' : 'ri-user-heart-line';
            const roleText = isAdmin ? 'Admin' : 'Customer';
            const registeredDate = user.createdAt ? new Date(user.createdAt) : null;
            const dateStr = registeredDate ? registeredDate.toLocaleDateString() : '-';
            const timeStr = registeredDate ? registeredDate.toLocaleTimeString() : '';

            return `
              <tr class="${rowClass}">
                <td data-label="Name">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="${roleIcon}" style="font-size: 1.1rem; color: ${isAdmin ? '#92400e' : '#3730a3'};"></i>
                    <strong>${user.name || '-'}</strong>
                  </div>
                </td>
                <td data-label="Email">${user.email || '-'}</td>
                <td data-label="Phone">${user.phone || '-'}</td>
                <td data-label="Role">
                  <span class="user-role-badge ${roleClass}">
                    <i class="${roleIcon}"></i>
                    ${roleText}
                  </span>
                </td>
                <td data-label="Registered">
                  ${dateStr}
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-user" data-id="${user.id}" aria-label="View ${roleText}" title="View ${roleText} details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="edit-user-role" data-id="${user.id}" aria-label="Change Role" title="Change user role">
                    <i class="ri-user-settings-line"></i>
                  </button>
                  <button type="button" data-action="delete-user" data-id="${user.id}" aria-label="Delete ${roleText}" title="Delete user">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        userCountLabel.innerHTML = `<i class="ri-group-line"></i> Users tracked: ${users.length}`;
        if (customerCountEl) customerCountEl.innerHTML = `<i class="ri-user-heart-line"></i> Customers: ${customers.length}`;
        if (adminCountEl) adminCountEl.innerHTML = `<i class="ri-admin-line"></i> Admins: ${admins.length}`;

        // Attach view user handlers
        document.querySelectorAll('[data-action="view-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = btn.dataset.id;
            const user = users.find(u => u.id === userId);
            if (user) {
              const isAdmin = user.role === 'admin';
              const roleIcon = isAdmin ? '' : '';
              const roleText = isAdmin ? 'Administrator' : 'Customer';
              
              // Get user's orders
              const userOrders = orders.filter(o => o.userId === userId || o.customer?.email === user.email);
              const totalSpent = userOrders.reduce((sum, o) => sum + (o.total || o.amount || 0), 0);
              
              const userDetails = `
<div class="message-detail">
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 16px; background: ${isAdmin ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : 'linear-gradient(135deg, #e0e7ff, #c7d2fe)'}; border-radius: 8px;">
    <span style="font-size: 2rem;">${roleIcon}</span>
    <div>
      <strong style="font-size: 1.2rem;">${user.name || 'Unknown'}</strong>
      <div style="color: ${isAdmin ? '#92400e' : '#3730a3'}; font-weight: 600;">${roleText}</div>
    </div>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
    <div class="detail-row">
      <label>User ID:</label>
      <p style="font-family: monospace; font-size: 0.8rem;">${user.id}</p>
    </div>
    <div class="detail-row">
      <label>Email:</label>
      <p><a href="mailto:${user.email}">${user.email || '-'}</a></p>
    </div>
    <div class="detail-row">
      <label>Phone:</label>
      <p>${user.phone || 'Not provided'}</p>
    </div>
    <div class="detail-row">
      <label>Registered:</label>
      <p>${user.createdAt ? new Date(user.createdAt).toLocaleString() : '-'}</p>
    </div>
    <div class="detail-row">
      <label>Last Login:</label>
      <p>${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never'}</p>
    </div>
    <div class="detail-row">
      <label>Total Orders:</label>
      <p><strong>${userOrders.length}</strong></p>
    </div>
  </div>
  
  <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 8px; color: white; text-align: center;">
    <div style="font-size: 0.85rem; opacity: 0.8;">Total Spent</div>
    <div style="font-size: 1.5rem; font-weight: bold;">${totalSpent.toLocaleString()}</div>
  </div>
  
  ${userOrders.length > 0 ? `
  <div style="margin-top: 16px;">
    <label style="font-weight: 600; margin-bottom: 8px; display: block;"><i class="ri-shopping-cart-line"></i> Recent Orders:</label>
    <div style="max-height: 200px; overflow-y: auto;">
      ${userOrders.slice(0, 5).map(o => `
        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: #f9fafb; border-radius: 6px; margin-bottom: 4px;">
          <div>
            <strong>${o.id}</strong>
            <small style="color: #6b7280; display: block;">${o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '-'}</small>
          </div>
          <div style="text-align: right;">
            <span class="status-badge ${getStatusBadgeClass(o.status)}">${o.status || 'Pending'}</span>
            <strong style="display: block;">${(o.total || o.amount || 0).toLocaleString()}</strong>
          </div>
        </div>
      `).join('')}
      ${userOrders.length > 5 ? `<p style="text-align: center; color: #6b7280; font-size: 0.85rem;">+ ${userOrders.length - 5} more orders</p>` : ''}
    </div>
  </div>
  ` : ''}
</div>
              `;
              showModal(`${roleText} Details`, userDetails, null, e);
            }
          });
        });

        // Attach promote user handlers
        document.querySelectorAll('[data-action="promote-user"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = btn.dataset.id;
            const user = users.find(u => u.id === userId);
            if (user) {
              showModal(
                'Promote to Admin',
                `Are you sure you want to promote "${user.name}" to administrator? This will give them full access to the admin panel.`,
                async () => {
                  try {
                    await apiRequest(`/users/${userId}`, {
                      method: 'PUT',
                      body: JSON.stringify({ role: 'admin' })
                    });
                    showNotification(`${user.name} promoted to Admin successfully!`, 'success');
                    closeModal();
                    await fetchUsers();
                    await renderStats();
                  } catch (e) {
                    console.error('Failed to promote user:', e);
                    showNotification('Failed to promote user', 'error');
                    closeModal();
                  }
                },
                e
              );
            }
          });
        });

        // Attach edit user role handlers
        document.querySelectorAll('[data-action="edit-user-role"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const userId = btn.dataset.id;
            const user = users.find(u => u.id === userId);
            if (user) {
              const roleOptions = `
                <label for="newUserRole" style="font-weight:600; display:block; margin-bottom:6px;">Role:</label>
                <select id="newUserRole" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 10px;">
                  <option value="customer" ${user.role !== 'admin' ? 'selected' : ''}>Customer</option>
                  <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrator</option>
                </select>
              `;

              showModal(
                `Change Role for ${user.name}`,
                `Select new role for ${user.name}:${roleOptions}`,
                async () => {
                  const newRole = document.getElementById('newUserRole').value;
                  
                  try {
                    await apiRequest(`/users/${userId}`, {
                      method: 'PUT',
                      body: JSON.stringify({ role: newRole })
                    });
                    showNotification(`Role for ${user.name} updated to ${newRole}`, 'success');
                    closeModal();
                    await fetchUsers();
                    await renderStats();
                  } catch (e) {
                    console.error('Failed to update user role:', e);
                    showNotification('Failed to update user role', 'error');
                    closeModal();
                  }
                },
                e
              );
            }
          });
        });

        // Attach delete user handlers
        document.querySelectorAll('[data-action="delete-user"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const userId = btn.dataset.id;
            const user = users.find(u => u.id === userId);
            if (user) {
              // Prevent self-deletion
              let currentUser = null;
              try {
                const data = await apiRequest('/auth/me');
                currentUser = data.user;
              } catch (e) {}
              if (currentUser && currentUser.id === userId) {
                showModal('Cannot Delete', 'You cannot delete your own account while logged in.', null, e);
                return;
              }

              showModal(
                'Delete User',
                `Are you sure you want to delete <strong>${user.name}</strong> (${user.email})? This action cannot be undone and will remove all their data.`,
                async () => {
                  try {
                    await apiRequest(`/users/${userId}`, { method: 'DELETE' });
                    showNotification('User deleted successfully', 'success');
                    closeModal();
                    await fetchUsers();
                    await renderStats();
                  } catch (e) {
                    console.error('Failed to delete user:', e);
                    showNotification('Failed to delete user', 'error');
                    closeModal();
                  }
                },
                e
              );
            }
          });
        });
      }

      // =====================================================
      // PASSWORD RESET MANAGEMENT FUNCTIONS
      // =====================================================
      
      let passwordResetUsers = [];
      let pendingOtps = [];
      let selectedResetUserId = null;

      async function loadPasswordResetData() {
        await Promise.all([
          loadPasswordResetUsers(),
          loadPendingOtps()
        ]);
      }

      async function loadPasswordResetUsers() {
        try {
          const data = await apiRequest('/users/password-resets/users-summary');
          passwordResetUsers = data.users || [];
          renderPasswordResetUsers();
        } catch (e) {
          console.error('Failed to load password reset users:', e);
          showNotification('Failed to load users for password reset', 'error');
        }
      }

      async function loadPendingOtps() {
        try {
          const data = await apiRequest('/users/password-resets/pending');
          pendingOtps = data.resets || [];
          renderPendingOtps();
        } catch (e) {
          console.error('Failed to load pending OTPs:', e);
        }
      }

      function renderPendingOtps() {
        const tbody = document.getElementById('pendingOtpBody');
        const countEl = document.getElementById('pendingOtpCount');
        
        if (!tbody) return;
        
        if (countEl) {
          countEl.textContent = pendingOtps.length;
          countEl.className = 'badge ' + (pendingOtps.length > 0 ? '' : 'success');
        }
        
        if (!pendingOtps.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                <i class="ri-shield-check-line"></i>
                <p>No pending OTPs</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = pendingOtps.map(reset => {
          const expiresAt = new Date(reset.expiresAt);
          const now = new Date();
          const minutesLeft = Math.max(0, Math.floor((expiresAt - now) / 60000));
          
          let expiresClass = 'safe';
          if (minutesLeft <= 5) expiresClass = 'urgent';
          else if (minutesLeft <= 10) expiresClass = 'warning';
          
          const userName = reset.userName || 'Unknown';
          const initials = userName.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          
          return `
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar">${initials}</div>
                  <div class="user-details">
                    <span class="user-name">${userName}</span>
                    <span class="user-email">${reset.email || '-'}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="otp-code">
                  ${reset.otp}
                  <button class="copy-btn" onclick="copyOtpToClipboard('${reset.otp}')" title="Copy OTP">
                    <i class="ri-file-copy-line"></i>
                  </button>
                </span>
              </td>
              <td>
                <span class="expires-badge ${expiresClass}">
                  ${minutesLeft > 0 ? `${minutesLeft} min left` : 'Expired'}
                </span>
              </td>
              <td class="hide-mobile">
                ${new Date(reset.createdAt).toLocaleString()}
              </td>
              <td>
                <div class="action-btns" style="display: flex; gap: 8px;">
                  <button class="btn-action invalidate" onclick="invalidateOtp('${reset.id}')" title="Invalidate OTP" style="background: #fee2e2; color: #dc2626; border: 1px solid #f87171; padding: 6px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                    <i class="ri-close-circle-line"></i> Invalidate
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      function renderPasswordResetUsers() {
        const tbody = document.getElementById('passwordResetUsersBody');
        const countEl = document.getElementById('passwordResetUserCount');
        const searchInput = document.getElementById('passwordResetSearch');
        const searchTerm = searchInput?.value.toLowerCase() || '';
        
        if (!tbody) return;
        
        // Filter users
        let filteredUsers = passwordResetUsers.filter(user => {
          if (!searchTerm) return true;
          const name = (user.name || '').toLowerCase();
          const email = (user.email || '').toLowerCase();
          return name.includes(searchTerm) || email.includes(searchTerm);
        });
        
        if (countEl) {
          countEl.textContent = filteredUsers.length;
        }
        
        if (!filteredUsers.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="empty-state">
                <i class="ri-user-search-line"></i>
                <p>${searchTerm ? 'No users found matching your search' : 'No users available'}</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = filteredUsers.map(user => {
          const initials = (user.name || 'U').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          const isAdmin = user.role === 'admin';
          const statusClass = user.isBlocked ? 'blocked' : (isAdmin ? 'admin' : 'active');
          const statusText = user.isBlocked ? 'Blocked' : (isAdmin ? 'Admin' : 'Active');
          const hasPendingReset = user.hasPendingReset;
          
          return `
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar" style="${isAdmin ? 'background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);' : ''}">${initials}</div>
                  <div class="user-details">
                    <span class="user-name">${user.name || 'Unknown'}</span>
                    <span class="user-email">${user.email || '-'}</span>
                  </div>
                </div>
              </td>
              <td class="hide-mobile">
                <span class="status-badge ${statusClass}">${statusText}</span>
              </td>
              <td class="hide-mobile">
                ${user.lastResetDate ? new Date(user.lastResetDate).toLocaleDateString() : 'Never'}
              </td>
              <td class="hide-mobile">
                ${hasPendingReset ? '<span class="expires-badge warning">OTP Active</span>' : '-'}
              </td>
              <td>
                <div class="action-btns" style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button class="btn-action generate" onclick="generateOtpForUser('${user.id}')" title="Generate OTP" ${hasPendingReset ? 'disabled style="opacity:0.5; cursor: not-allowed;"' : 'style="background: #ecfdf5; color: #059669; border: 1px solid #10b981; padding: 6px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;"'}>
                    <i class="ri-key-line"></i> Generate OTP
                  </button>
                  <button class="btn-action direct" onclick="showDirectResetModal('${user.id}', '${(user.name || '').replace(/'/g, "\\'")}', '${user.email || ''}')" title="Direct Reset" style="background: #eff6ff; color: #2563eb; border: 1px solid #3b82f6; padding: 6px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                    <i class="ri-lock-unlock-line"></i> Direct Reset
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      async function generateOtpForUser(userId) {
        const confirmed = await AdminUniModal.confirm(
          'Generate OTP',
          'This will generate a 6-digit OTP valid for 20 minutes. The user will receive it via email. Continue?',
          { confirmText: 'Generate OTP' }
        );
        
        if (!confirmed) return;

        try {
          const data = await apiRequest('/users/password-resets/generate', {
            method: 'POST',
            body: JSON.stringify({ userId })
          });
          
          showNotification(`OTP generated successfully!`, 'success');
          
          // Show OTP in a modal for easy copying
          const otpHtml = `
            <div style="text-align: center; padding: 10px;">
              <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 12px;">One-Time Password</div>
              <div style="font-family: 'Courier New', monospace; font-size: 2.5rem; font-weight: bold; letter-spacing: 8px; padding: 20px; background: #f3f4f6; border-radius: 12px; display: inline-block; margin-bottom: 20px; border: 2px dashed #3b82f6; color: #1e40af;">
                ${data.otp}
              </div>
              <div style="color: #ef4444; font-size: 0.85rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="ri-time-line"></i> Valid for 20 minutes
              </div>
              <button onclick="copyOtpToClipboard('${data.otp}')" class="admin-uni-modal-btn primary" style="width: auto; padding: 10px 24px;">
                <i class="ri-file-copy-line"></i> Copy OTP
              </button>
              <div style="color: #6b7280; font-size: 0.85rem; margin-top: 20px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                ${data.emailSent ? ' Email notification sent to user successfully' : ' Email notification failed. Please provide the OTP manually.'}
              </div>
            </div>
          `;
          
          await AdminUniModal.info('OTP Generated', otpHtml);
          await loadPasswordResetData();
        } catch (e) {
          console.error('Failed to generate OTP:', e);
          showNotification(e.message || 'Failed to generate OTP', 'error');
        }
      }

      function showDirectResetModal(userId, userName, userEmail) {
        selectedResetUserId = userId;
        const modal = document.getElementById('directResetModal');
        const userNameEl = document.getElementById('directResetUserName');
        const userEmailEl = document.getElementById('directResetUserEmail');
        const passwordInput = document.getElementById('directResetPassword');
        const confirmInput = document.getElementById('directResetConfirm');
        
        if (userNameEl) userNameEl.textContent = userName;
        if (userEmailEl) userEmailEl.textContent = userEmail;
        if (passwordInput) passwordInput.value = '';
        if (confirmInput) confirmInput.value = '';
        
        if (modal) modal.classList.add('active');
      }

      function closeDirectResetModal() {
        const modal = document.getElementById('directResetModal');
        if (modal) modal.classList.remove('active');
        selectedResetUserId = null;
      }

      function generateRandomPassword() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%';
        let password = '';
        for (let i = 0; i < 12; i++) {
          password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        const passwordInput = document.getElementById('directResetPassword');
        const confirmInput = document.getElementById('directResetConfirm');
        
        if (passwordInput) passwordInput.value = password;
        if (confirmInput) confirmInput.value = password;
        
        // Show the password
        passwordInput.type = 'text';
        confirmInput.type = 'text';
        
        showNotification('Random password generated', 'info');
      }

      function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
          input.type = input.type === 'password' ? 'text' : 'password';
        }
      }

      async function executeDirectReset() {
        if (!selectedResetUserId) return;
        
        const passwordInput = document.getElementById('directResetPassword');
        const confirmInput = document.getElementById('directResetConfirm');
        const password = passwordInput?.value;
        const confirm = confirmInput?.value;
        
        // Match backend requirement (8 characters)
        if (!password || password.length < 8) {
          showNotification('Password must be at least 8 characters long as per security policy', 'error');
          passwordInput?.focus();
          return;
        }
        
        if (password !== confirm) {
          showNotification('Passwords do not match', 'error');
          confirmInput?.focus();
          return;
        }
        
        const resetBtn = document.getElementById('executeDirectResetBtn');
        if (resetBtn) {
          resetBtn.disabled = true;
          resetBtn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Resetting...';
        }
        
        try {
          await apiRequest('/users/password-resets/direct-reset', {
            method: 'POST',
            body: JSON.stringify({ userId: selectedResetUserId, newPassword: password })
          });
          
          showNotification('Password reset successfully!', 'success');
          closeDirectResetModal();
          await loadPasswordResetData();
        } catch (e) {
          console.error('Failed to reset password:', e);
          showNotification(e.message || 'Failed to reset password', 'error');
        } finally {
          if (resetBtn) {
            resetBtn.disabled = false;
            resetBtn.innerHTML = '<i class="ri-lock-unlock-line"></i> Reset Password';
          }
        }
      }

      async function invalidateOtp(resetId) {
        const confirmed = await AdminUniModal.confirm(
          'Invalidate OTP',
          'Are you sure you want to cancel this reset OTP? The user will need to generate a new one to reset their password.',
          { confirmText: 'Invalidate', danger: true }
        );
        
        if (!confirmed) return;

        try {
          await apiRequest(`/users/password-resets/${resetId}`, {
            method: 'DELETE'
          });
          
          showNotification('OTP invalidated successfully', 'success');
          await loadPasswordResetData();
        } catch (e) {
          console.error('Failed to invalidate OTP:', e);
          showNotification('Failed to invalidate OTP', 'error');
        }
      }

      function copyOtpToClipboard(otp) {
        navigator.clipboard.writeText(otp).then(() => {
          showNotification('OTP copied to clipboard!', 'success');
        }).catch(() => {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = otp;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showNotification('OTP copied to clipboard!', 'success');
        });
      }

      function refreshPasswordResetSection() {
        loadPasswordResetData();
        showNotification('Password reset data refreshed', 'info');
      }

      // Setup password reset event listeners
      function setupPasswordResetListeners() {
        // Search input
        const searchInput = document.getElementById('passwordResetSearch');
        if (searchInput) {
          searchInput.addEventListener('input', () => {
            renderPasswordResetUsers();
          });
        }
        
        // Clear search button
        const clearSearchBtn = document.getElementById('clearPasswordResetSearch');
        if (clearSearchBtn) {
          clearSearchBtn.addEventListener('click', () => {
            const searchInput = document.getElementById('passwordResetSearch');
            if (searchInput) searchInput.value = '';
            renderPasswordResetUsers();
          });
        }
        
        // Refresh button
        const refreshBtn = document.getElementById('refreshPasswordResetBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', refreshPasswordResetSection);
        }
        
        // Modal close handlers
        const modal = document.getElementById('directResetModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeDirectResetModal();
          });
        }
      }
      // =====================================================
      // END PASSWORD RESET MANAGEMENT FUNCTIONS
      // =====================================================

      // Auto-refresh setup
      function setupAutoRefresh() {
        const ordersAutoRefreshCheckbox = document.getElementById('ordersAutoRefresh');
        const usersAutoRefreshCheckbox = document.getElementById('usersAutoRefresh');
        const returnsAutoRefreshCheckbox = document.getElementById('returnsAutoRefresh');
        const refreshOrdersBtn = document.getElementById('refreshOrdersBtn');
        const refreshUsersBtn = document.getElementById('refreshUsersBtn');
        const refreshReturnsBtn = document.getElementById('refreshReturnsBtn');

        // Orders auto-refresh
        if (ordersAutoRefreshCheckbox) {
          ordersAutoRefreshCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              ordersAutoRefreshInterval = setInterval(fetchOrders, REFRESH_INTERVAL);
            } else {
              clearInterval(ordersAutoRefreshInterval);
            }
          });
          // Start auto-refresh by default
          ordersAutoRefreshInterval = setInterval(fetchOrders, REFRESH_INTERVAL);
        }

        // Users auto-refresh
        if (usersAutoRefreshCheckbox) {
          usersAutoRefreshCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              usersAutoRefreshInterval = setInterval(fetchUsers, REFRESH_INTERVAL);
            } else {
              clearInterval(usersAutoRefreshInterval);
            }
          });
          // Start auto-refresh by default
          usersAutoRefreshInterval = setInterval(fetchUsers, REFRESH_INTERVAL);
        }

        // Returns auto-refresh
        if (returnsAutoRefreshCheckbox) {
          returnsAutoRefreshCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              returnsAutoRefreshInterval = setInterval(fetchReturns, RETURNS_REFRESH_INTERVAL);
            } else {
              clearInterval(returnsAutoRefreshInterval);
            }
          });
          // Start auto-refresh by default
          returnsAutoRefreshInterval = setInterval(fetchReturns, RETURNS_REFRESH_INTERVAL);
        }

        // Manual refresh buttons
        if (refreshOrdersBtn) {
          refreshOrdersBtn.addEventListener('click', () => {
            fetchOrders();
            showNotification('Orders refreshed', 'info');
          });
        }
        if (refreshUsersBtn) {
          refreshUsersBtn.addEventListener('click', () => {
            fetchUsers();
            showNotification('Users refreshed', 'info');
          });
        }
        if (refreshReturnsBtn) {
          refreshReturnsBtn.addEventListener('click', () => {
            fetchReturns();
            showNotification('Returns refreshed', 'info');
          });
        }
      }

      function readImageFile(file) {
        return new Promise((resolve) => {
          if (!file) return resolve('');
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => resolve('');
          reader.readAsDataURL(file);
        });
      }

      // Read multiple image files and return array of base64 strings
      async function readMultipleImageFiles(fileList) {
        if (!fileList || fileList.length === 0) return [];
        const promises = Array.from(fileList).map(file => readImageFile(file));
        return Promise.all(promises);
      }

      // Upload image to server and return URL
      async function uploadProductImage(base64Image, productId, type = 'main') {
        if (!base64Image) return base64Image;
        
        try {
          const response = await apiRequest('/uploads/product-image', {
            method: 'POST',
            body: JSON.stringify({ image: base64Image, productId, type })
          });
          return response.url || base64Image;
        } catch (e) {
          console.error('Image upload failed:', e);
          throw new Error('Failed to upload image');
        }
      }

      // Upload a File object using multipart/form-data (streams)
      async function uploadProductImageFile(file, productId, type = 'main') {
        if (!file) return '';
        const fd = new FormData();
        fd.append('image', file);
        fd.append('productId', productId);
        fd.append('type', type);

        const resp = await fetch(API_BASE + '/uploads/product-image', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || 'Upload failed');
        }

        const json = await resp.json();
        return json.url || '';
      }

      // Upload multiple thumbnails to server
      async function uploadProductThumbnails(base64Images, productId) {
        if (!base64Images || base64Images.length === 0) return base64Images;
        
        try {
          const response = await apiRequest('/uploads/product-thumbnails', {
            method: 'POST',
            body: JSON.stringify({ images: base64Images, productId })
          });
          return response.urls || base64Images;
        } catch (e) {
          console.error('Thumbnails upload failed:', e);
          throw new Error('Failed to upload thumbnails');
        }
      }

      // Upload file list (FileList) using multipart/form-data
      async function uploadProductThumbnailsFiles(fileList, productId) {
        if (!fileList || fileList.length === 0) return [];
        const fd = new FormData();
        for (let i = 0; i < fileList.length; i++) {
          fd.append('images', fileList[i]);
        }
        fd.append('productId', productId);

        const resp = await fetch(API_BASE + '/uploads/product-thumbnails', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || 'Upload failed');
        }

        const json = await resp.json();
        return json.urls || [];
      }

      // Generate SKU for product - creates a unique code based on product name, color, and category
      function generateSkuForProduct() {
        const nameInput = document.getElementById('productName');
        const name = nameInput ? nameInput.value.trim() : '';
        const categoryInput = document.getElementById('productCategory');
        const category = categoryInput ? categoryInput.value : '';
        const colorCheckboxes = document.querySelectorAll('input[name="productColors"]:checked');
        const color = colorCheckboxes.length > 0 ? colorCheckboxes[0].value : '';
        
        // Create SKU parts
        const brandPrefix = 'BLK'; // Brand prefix
        let categoryCode = '';
        let colorCode = '';
        let nameCode = '';
        
        // Generate category code
        if (category) {
          const catParts = category.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 3);
          categoryCode = catParts || 'GEN';
        } else {
          categoryCode = 'GEN';
        }
        
        // Generate color code
        if (color) {
          const colorMap = {
            'Black': 'BK', 'White': 'WH', 'Blue': 'BL', 'Red': 'RD', 'Green': 'GR',
            'Yellow': 'YL', 'Orange': 'OR', 'Pink': 'PK', 'Purple': 'PR', 'Brown': 'BR',
            'Grey': 'GY', 'Navy': 'NV', 'Beige': 'BG', 'Maroon': 'MR', 'Olive': 'OL'
          };
          colorCode = colorMap[color] || color.substring(0, 2).toUpperCase();
        } else {
          colorCode = 'XX';
        }
        
        // Generate name code (first 3 consonants or chars)
        if (name) {
          const consonants = name.toUpperCase().replace(/[^A-Z]/g, '').replace(/[AEIOU]/g, '');
          nameCode = (consonants.substring(0, 3) || name.toUpperCase().substring(0, 3)).padEnd(3, 'X');
        } else {
          nameCode = 'XXX';
        }
        
        // Generate unique suffix (timestamp based)
        const timestamp = Date.now().toString(36).toUpperCase().slice(-4);
        
        // Construct SKU: BLK-CAT-CLR-NAME-XXXX
        const sku = `${brandPrefix}-${categoryCode}-${colorCode}-${nameCode}-${timestamp}`;
        document.getElementById('productSku').value = sku;
        
        // Show success feedback
        showToast('SKU generated: ' + sku, 'success');
      }

      // Generate Barcode for product - creates EAN-13 compatible code
      function generateBarcodeForProduct() {
        // EAN-13 structure: Country (3) + Company (4) + Product (5) + Check (1)
        // Using 800 as country code (for custom/internal use)
        const countryCode = '800';
        const companyCode = '0001'; // Company identifier
        
        // Generate 5 random digits for product code
        const productCode = String(Math.floor(Math.random() * 100000)).padStart(5, '0');
        
        // Combine first 12 digits
        const first12 = countryCode + companyCode + productCode;
        
        // Calculate EAN-13 check digit
        let sum = 0;
        for (let i = 0; i < 12; i++) {
          const digit = parseInt(first12[i]);
          sum += digit * (i % 2 === 0 ? 1 : 3);
        }
        const checkDigit = (10 - (sum % 10)) % 10;
        
        const barcode = first12 + checkDigit;
        document.getElementById('productBarcode').value = barcode;
        
        // Show success feedback
        showToast('Barcode generated: ' + barcode, 'success');
      }

      function attachProductHandlers() {
        const form = document.getElementById('productForm');
        const reset = document.getElementById('productReset');
        const message = document.getElementById('productMessage');
        const submit = document.getElementById('productSubmit');

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          
          // Show loading state
          submit.disabled = true;
          const originalText = submit.textContent;
          submit.textContent = 'Uploading...';
          
          const name = document.getElementById('productName').value.trim();
          const price = Number(document.getElementById('productPrice').value);
          
          // Get selected colors from checkboxes
          const colorCheckboxes = document.querySelectorAll('input[name="productColors"]:checked');
          const selectedColors = Array.from(colorCheckboxes).map(cb => cb.value);
          const color = selectedColors.length > 0 ? selectedColors[0] : 'Black'; // Primary color
          const availableColors = selectedColors;
          
          // Get selected sizes from checkboxes
          const sizeCheckboxes = document.querySelectorAll('input[name="productSizes"]:checked');
          const selectedSizes = Array.from(sizeCheckboxes).map(cb => cb.value);
          const size = selectedSizes.length > 0 ? selectedSizes[0] : 'M'; // Primary size
          const availableSizes = selectedSizes;
          
          const description = document.getElementById('productDescription').value.trim();
          const stock = Number(document.getElementById('productStock').value);
          const sku = document.getElementById('productSku').value.trim();
          const barcode = document.getElementById('productBarcode').value.trim();
          const stockStatus = document.getElementById('productStockStatus').value;
          const isOutOfStock = stockStatus === 'out-of-stock';
          const position = document.getElementById('productPosition').value;
          const mainFile = document.getElementById('productImage').files[0];
          const thumbFiles = document.getElementById('productThumb').files;
          
          if (!name || !price) {
            showNotification('Name and price are required.', 'error');
            submit.disabled = false;
            submit.textContent = originalText;
            return;
          }
          
          if (selectedColors.length === 0) {
            showNotification('Please select at least one color.', 'error');
            submit.disabled = false;
            submit.textContent = originalText;
            return;
          }
          
          if (selectedSizes.length === 0) {
            showNotification('Please select at least one size.', 'warning');
            submit.disabled = false;
            submit.textContent = originalText;
            return;
          }

          // Convert position to number or null
          const positionNum = position ? Number(position) : null;
          const productId = editingProductId || 'prod-' + Date.now();

          try {
            // Read and upload images
            let imageUrl = '';
            let thumbUrls = [];
            
            if (mainFile) {
              showNotification('Uploading main image...', 'info');
              imageUrl = await uploadProductImageFile(mainFile, productId, 'main');
            }
            
            if (thumbFiles && thumbFiles.length > 0) {
              showNotification('Uploading thumbnails...', 'info');
              thumbUrls = await uploadProductThumbnailsFiles(thumbFiles, productId);
            }

            const productData = {
              name, price, color, size, description, stock,
              sku, barcode,
              availableColors: availableColors,
              availableSizes: availableSizes,
              stockStatus: stockStatus,
              isOutOfStock: isOutOfStock,
              position: positionNum,
              image: imageUrl || undefined,
              thumbImages: thumbUrls.length > 0 ? thumbUrls : undefined
            };

          if (editingProductId) {
            // Update product via API
            try {
              // Auto-generate SKU and barcode if not set during edit
              if (!productData.sku) {
                const timestamp = Date.now();
                const namePrefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
                productData.sku = `SKU-${namePrefix}-${timestamp.toString(36).toUpperCase()}`;
                productData.skuCreatedAt = new Date().toISOString();
              }
              if (!productData.barcode) {
                const timestamp = Date.now();
                productData.barcode = `${timestamp}${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
                productData.barcodeCreatedAt = new Date().toISOString();
              }
              
              await apiRequest(`/products/${editingProductId}`, {
                method: 'PUT',
                body: JSON.stringify(productData)
              });
              showNotification(`${name} updated successfully!`, 'success');
              editingProductId = null;
              submit.disabled = false;
              submit.textContent = 'Add Product';
              form.reset();
              await fetchProducts();
              await renderStats();
              
              // Refresh SKU and Inventory sections if they exist
              if (typeof loadSkuData === 'function') {
                try { await loadSkuData(); } catch(e) { console.log('SKU section will refresh on visit'); }
              }
              if (typeof loadInventoryData === 'function') {
                try { await loadInventoryData(); } catch(e) { console.log('Inventory section will refresh on visit'); }
              }
            } catch (e) {
              console.error('Failed to update product:', e);
              showNotification('Failed to update product. Please try again.', 'error');
              submit.disabled = false;
              submit.textContent = originalText;
            }
          } else {
            // Add new product via API
            try {
              // Auto-generate SKU and barcode for new products
              const timestamp = Date.now();
              const namePrefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
              const autoSku = productData.sku || `SKU-${namePrefix}-${timestamp.toString(36).toUpperCase()}`;
              const autoBarcode = productData.barcode || `${timestamp}${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
              
              // Add auto-generated SKU and barcode to product data
              productData.sku = autoSku;
              productData.barcode = autoBarcode;
              productData.skuCreatedAt = new Date().toISOString();
              productData.barcodeCreatedAt = new Date().toISOString();
              
              await apiRequest('/products', {
                method: 'POST',
                body: JSON.stringify(productData)
              });
              showNotification(`${name} added successfully! SKU: ${autoSku}`, 'success');
              form.reset();
              await fetchProducts();
              await renderStats();
              
              // Refresh SKU and Inventory sections if they exist
              if (typeof loadSkuData === 'function') {
                try { await loadSkuData(); } catch(e) { console.log('SKU section will refresh on visit'); }
              }
              if (typeof loadInventoryData === 'function') {
                try { await loadInventoryData(); } catch(e) { console.log('Inventory section will refresh on visit'); }
              }
              
              submit.disabled = false;
              submit.textContent = 'Add Product';
            } catch (e) {
              console.error('Failed to add product:', e);
              showNotification('Failed to add product. Please try again.', 'error');
              submit.disabled = false;
              submit.textContent = originalText;
            }
          }
          
          } catch (error) {
            console.error('Product save error:', error);
            showNotification('Error saving product. Please try again.', 'error');
            submit.disabled = false;
            submit.textContent = originalText;
          }
        });

        reset.addEventListener('click', () => {
          editingProductId = null;
          submit.textContent = 'Add Product';
          submit.disabled = false;
          form.reset();
          
          // Reset color checkboxes to default (Black only)
          const colorCheckboxes = document.querySelectorAll('input[name="productColors"]');
          colorCheckboxes.forEach(cb => {
            cb.checked = cb.value === 'Black';
          });
          
          // Reset size checkboxes to default (M, L, XL)
          const sizeCheckboxes = document.querySelectorAll('input[name="productSizes"]');
          sizeCheckboxes.forEach(cb => {
            cb.checked = ['M', 'L', 'XL'].includes(cb.value);
          });
          
          // Clear image previews
          clearProductImagePreviews();
        });

        productBody.addEventListener('click', async (event) => {
          const target = event.target.closest('button');
          if (!target) return;
          const action = target.dataset.action;
          const id = target.dataset.id;

          if (action === 'delete') {
            const confirmed = await showConfirmModal({
              title: 'Delete Product',
              message: 'Are you sure you want to delete this product? This action cannot be undone.',
              confirmText: 'Yes, Delete',
              cancelText: 'Cancel',
              type: 'danger'
            });
            if (!confirmed) return;
            
            try {
              await apiRequest(`/products/${id}`, { method: 'DELETE' });
              showNotification('Product deleted successfully', 'success');
              await fetchProducts();
              await renderStats();
            } catch (e) {
              console.error('Failed to delete product:', e);
              showNotification('Failed to delete product', 'error');
            }
            return;
          }

          if (action === 'edit') {
            const product = products.find(p => p.id === id);
            if (!product) return;
            editingProductId = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productPrice').value = product.price || '';
            
            showNotification(`Editing ${product.name}. Upload new images to replace existing ones.`, 'info');
            
            // Set color checkboxes
            const colorCheckboxes = document.querySelectorAll('input[name="productColors"]');
            const productColors = product.availableColors || [product.color] || ['Black'];
            colorCheckboxes.forEach(cb => {
              cb.checked = productColors.includes(cb.value);
            });
            
            // Set size checkboxes
            const sizeCheckboxes = document.querySelectorAll('input[name="productSizes"]');
            const productSizes = product.availableSizes || [product.size] || ['M'];
            sizeCheckboxes.forEach(cb => {
              cb.checked = productSizes.includes(cb.value);
            });
            
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productSku').value = product.sku || '';
            document.getElementById('productBarcode').value = product.barcode || '';
            document.getElementById('productStockStatus').value = product.isOutOfStock ? 'out-of-stock' : (product.stockStatus || 'in-stock');
            document.getElementById('productPosition').value = product.position || '';
            submit.textContent = 'Save Changes';
            
            // Show existing product images in preview boxes
            updateProductMainImagePreview(product.image);
            updateProductThumbImagesPreview(product.thumbImages || []);
            
            window.scrollTo({ top: document.getElementById('products').offsetTop - 100, behavior: 'smooth' });
          }
        });
        
        // Product image preview handlers
        const productImageInput = document.getElementById('productImage');
        const productThumbInput = document.getElementById('productThumb');
        
        if (productImageInput) {
          productImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                updateProductMainImagePreview(e.target.result);
              };
              reader.readAsDataURL(file);
            } else {
              updateProductMainImagePreview(null);
            }
          });
        }
        
        if (productThumbInput) {
          productThumbInput.addEventListener('change', function() {
            const files = this.files;
            if (files && files.length > 0) {
              const previews = [];
              let loaded = 0;
              Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                  previews[index] = e.target.result;
                  loaded++;
                  if (loaded === files.length) {
                    updateProductThumbImagesPreview(previews);
                  }
                };
                reader.readAsDataURL(file);
              });
            } else {
              updateProductThumbImagesPreview([]);
            }
          });
        }
      }
      
      // Update main image preview box
      function updateProductMainImagePreview(src) {
        const previewBox = document.getElementById('mainImagePreviewBox');
        if (!previewBox) return;
        
        if (src) {
          const normalizedSrc = normalizeUploadUrl(src);
          previewBox.innerHTML = `<img src="${normalizedSrc}" alt="Main Image Preview" onerror="this.parentElement.innerHTML='<span>Image not found</span>'" />`;
        } else {
          previewBox.innerHTML = '<span>Select an image to preview</span>';
        }
      }
      
      // Update thumbnail images preview box
      function updateProductThumbImagesPreview(images) {
        const previewBox = document.getElementById('thumbImagesPreviewBox');
        if (!previewBox) return;
        
        if (images && images.length > 0) {
          previewBox.innerHTML = images.map(src => {
            const normalizedSrc = normalizeUploadUrl(src);
            return `<img src="${normalizedSrc}" alt="Thumbnail Preview" onerror="this.style.display='none'" />`;
          }).join('');
        } else {
          previewBox.innerHTML = '<span>Select images to preview</span>';
        }
      }
      
      // Clear product image previews on form reset
      function clearProductImagePreviews() {
        updateProductMainImagePreview(null);
        updateProductThumbImagesPreview([]);
      }

      function handleDownload() {
        const button = document.getElementById('downloadUsers');
        button.addEventListener('click', async () => {
          // Use users from state (which comes from API)
          let usersToExport = users;
          
          // If no users in state, try to fetch fresh data from API
          if (!usersToExport.length) {
            try {
              const data = await apiRequest('/users');
              usersToExport = data.users || [];
            } catch (e) {
              console.error('Failed to fetch users for export:', e);
              showNotification('Failed to fetch users', 'error');
              return;
            }
          }
          
          if (!usersToExport.length) {
              showToast('No users to export', 'info');
              return;
            }
          
          // Create CSV
          const headers = ['Name', 'Email', 'Phone', 'Role', 'Registered', 'Last Login'];
          const rows = usersToExport.map(u => [
            u.name || '',
            u.email || '',
            u.phone || '',
            u.role || 'customer',
            u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '',
            u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : 'Never'
          ]);
          const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `blackonn-users-${new Date().toISOString().slice(0, 10)}.csv`;
          link.click();
          URL.revokeObjectURL(url);
        });
      }

      // Returns - Real-time tracking
      let returnsAutoRefreshInterval = null;
      const RETURNS_REFRESH_INTERVAL = 30000; // 30 seconds

      function updateReturnsRefreshIndicator(type, loading = false) {
        const indicator = document.getElementById(`${type}RefreshIndicator`);
        const lastUpdate = document.getElementById(`${type}LastUpdate`);
        if (indicator) {
          indicator.classList.toggle('loading', loading);
          indicator.classList.toggle('active', !loading);
        }
        if (lastUpdate && !loading) {
          lastUpdate.textContent = new Date().toLocaleTimeString();
        }
      }

      function getReturnStatusBadgeClass(status) {
        const statusMap = {
          'Pending': 'return-status-pending',
          'Approved': 'return-status-approved',
          'Rejected': 'return-status-rejected',
          'Pickup Scheduled': 'return-status-pickup-scheduled',
          'Picked Up': 'return-status-picked-up',
          'Processing': 'return-status-processing',
          'Refunded': 'return-status-refunded',
          'Completed': 'return-status-completed'
        };
        return statusMap[status] || 'return-status-pending';
      }

      async function fetchReturns() {
        updateReturnsRefreshIndicator('returns', true);
        try {
          const data = await apiRequest('/returns');
          returns = data.returns || [];
        } catch (e) {
          console.error('Failed to fetch returns:', e);
          showNotification('Failed to load returns from server', 'error');
          returns = [];
        }
        renderReturns();
        updateReturnsRefreshIndicator('returns', false);
      }

      function renderReturns() {
        renderReturnsTable(returns);
      }

      // =====================
      // EXCHANGES FUNCTIONS
      // =====================

      async function fetchExchanges() {
        updateRefreshIndicator('exchanges', true);
        try {
          const data = await apiRequest('/exchanges');
          exchanges = data.exchanges || [];
        } catch (e) {
          console.error('Failed to fetch exchanges:', e);
          showNotification('Failed to load exchanges from server', 'error');
          exchanges = [];
        }
        renderExchanges();
        updateRefreshIndicator('exchanges', false);
      }

      function renderExchanges() {
        renderExchangesTable(exchanges);
      }

      function renderExchangesTable(exchangesList) {
        if (!exchangesList || !exchangesList.length) {
          exchangesBody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No exchange requests yet</td></tr>';
          return;
        }

        exchangesBody.innerHTML = exchangesList
          .map(exc => {
            const dateStr = exc.requestedAt ? new Date(exc.requestedAt).toLocaleDateString() : '-';
            const timeStr = exc.requestedAt ? new Date(exc.requestedAt).toLocaleTimeString() : '';

            const itemsHtml = exc.items?.map(i =>
              `<div class="item">${i.name || 'Product'} <small>(${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1}</small></div>`
            ).join('') || '<div class="item">-</div>';

            // Get customer details from order or exchange data
            const order = orders.find(o => o.id === exc.orderId) || {};
            const customerName = order.shippingInfo?.name || order.userName || exc.customer?.name || '-';
            const customerEmail = order.shippingInfo?.email || order.userEmail || exc.customer?.email || '';
            const customerPhone = order.shippingInfo?.phone || exc.customer?.phone || '';
            const customerHtml = `<strong>${customerName}</strong><div style="font-size:0.75rem;color:#6b7280;">${customerEmail}</div><div style="font-size:0.75rem;color:#9ca3af;">${customerPhone}</div>`;

            const reason = exc.reason || '-';
            const exchangeFor = exc.exchangeFor || '-';
            const newSize = exc.newSize || '';
            const newColor = exc.newColor || '';
            const status = exc.status || 'Pending';

            // Build new size/color display
            const newVariantHtml = (newSize || newColor) ? `
              <div style="margin-top:6px;padding:4px 8px;background:#f0fdf4;border-radius:4px;font-size:0.75rem;">
                <strong style="color:#15803d;">New:</strong>
                ${newSize ? `<span style="color:#15803d;"> Size: ${newSize}</span>` : ''}
                ${newColor ? `<span style="color:#15803d;"> Color: ${newColor}</span>` : ''}
              </div>
            ` : '';

            return `
              <tr>
                <td><input type="checkbox" class="exchange-checkbox" data-id="${exc.id}" aria-label="Select exchange ${exc.id}" /></td>
                <td data-label="Exchange ID">
                  <strong>${exc.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Order ID"><strong>${exc.orderId || '-'}</strong></td>
                <td data-label="Customer">${customerHtml}</td>
                <td data-label="Items">
                  <div class="order-items-detail">${itemsHtml}</div>
                  ${newVariantHtml}
                </td>
                <td data-label="Exchange For">${exchangeFor.replace(/_/g, ' ')}</td>
                <td data-label="Reason">${reason.replace(/_/g, ' ')}</td>
                <td data-label="Status">
                  <select class="exchange-status" data-id="${exc.id}" aria-label="Exchange ${exc.id} status">
                    <option value="Pending" ${status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Approved" ${status === 'Approved' ? 'selected' : ''}> Approved</option>
                    <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}> Rejected</option>
                    <option value="Pickup Scheduled" ${status === 'Pickup Scheduled' ? 'selected' : ''}> Pickup Scheduled</option>
                    <option value="Picked Up" ${status === 'Picked Up' ? 'selected' : ''}> Picked Up</option>
                    <option value="Processing" ${status === 'Processing' ? 'selected' : ''}> Processing</option>
                    <option value="Shipped" ${status === 'Shipped' ? 'selected' : ''}> New Item Shipped</option>
                    <option value="Completed" ${status === 'Completed' ? 'selected' : ''}> Completed</option>
                  </select>
                </td>
                <td data-label="Requested">${dateStr}</td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-exchange" data-id="${exc.id}" aria-label="View" title="View exchange details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-exchange" data-id="${exc.id}" aria-label="Delete" title="Delete exchange">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        // Attach status change handlers
        document.querySelectorAll('.exchange-status').forEach(select => {
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const exchangeId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              pendingExchangeChanges.set(exchangeId, { status: newStatus, adminNotes: '' });
              e.target.classList.add('status-changed');
            } else {
              pendingExchangeChanges.delete(exchangeId);
              e.target.classList.remove('status-changed');
            }
            updatePendingExchangeUI();
          });
        });

        // Attach view/delete handlers
        document.querySelectorAll('[data-action="view-exchange"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const exchangeId = btn.dataset.id;
            const exc = exchanges.find(x => x.id === exchangeId);
            if (exc) {
              const order = orders.find(o => o.id === exc.orderId) || {};
              const customerName = order.shippingInfo?.name || order.userName || exc.customer?.name || '-';
              const customerEmail = order.shippingInfo?.email || order.userEmail || exc.customer?.email || '-';
              const customerPhone = order.shippingInfo?.phone || exc.customer?.phone || '-';
              const newVariant = (exc.newSize || exc.newColor) ? `\n\nRequested New Variant:\n  Size: ${exc.newSize || 'Same'}\n  Color: ${exc.newColor || 'Same'}` : '';
              const details = `Exchange ID: ${exc.id}\nOrder ID: ${exc.orderId || '-'}\nStatus: ${exc.status || '-'}\nRequested: ${exc.requestedAt ? new Date(exc.requestedAt).toLocaleString() : '-'}\n\nCustomer:\n  Name: ${customerName}\n  Email: ${customerEmail}\n  Phone: ${customerPhone}\n\nItems:\n${exc.items?.map(i => `  - ${i.name} (${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1}`).join('\n') || '  No items'}\n\nExchange For: ${exc.exchangeFor || '-'}${newVariant}\nReason: ${exc.reason || '-'}\n\nComments:\n  ${exc.description || '-'}`;
              showModal('Exchange Details', '<pre style="white-space:pre-wrap;">' + details.replace(/</g, '&lt;') + '</pre>', null, e);
            }
          });
        });

        document.querySelectorAll('[data-action="delete-exchange"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const exchangeId = btn.dataset.id;
            const confirmed = await AdminUniModal.danger('Delete Exchange Request', `Are you sure you want to delete exchange ${exchangeId}? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
              await apiRequest(`/exchanges/${exchangeId}`, { method: 'DELETE' });
              showNotification('Exchange request deleted', 'success');
              await fetchExchanges();
            } catch (e) {
              console.error('Failed to delete exchange:', e);
              showNotification('Failed to delete exchange request', 'error');
            }
          });
        });
      }

      function updatePendingExchangeUI() {
        const btn = document.getElementById('saveExchangeChangesBtn');
        const countEl = document.getElementById('exchangePendingCount');
        if (pendingExchangeChanges.size > 0) {
          if (btn) btn.classList.add('visible');
          if (countEl) countEl.textContent = `(${pendingExchangeChanges.size})`;
        } else {
          if (btn) btn.classList.remove('visible');
          if (countEl) countEl.textContent = '';
        }
      }

      async function saveExchangeChanges() {
        if (pendingExchangeChanges.size === 0) return;
        
        const total = pendingExchangeChanges.size;
        let success = 0;
        let failed = 0;
        
        for (const [exchangeId, changes] of pendingExchangeChanges.entries()) {
          try {
            await apiRequest(`/exchanges/${exchangeId}/status`, {
              method: 'PATCH',
              body: JSON.stringify({ status: changes.status, adminNotes: changes.adminNotes })
            });
            success++;
          } catch (e) {
            console.error(`Failed to update exchange ${exchangeId}:`, e);
            failed++;
          }
        }
        
        pendingExchangeChanges.clear();
        updatePendingExchangeUI();
        
        if (failed === 0) {
          showNotification(`Successfully updated ${success} exchange(s)`, 'success');
        } else {
          showNotification(`Updated ${success}, failed ${failed}`, 'warning');
        }
        
        await fetchExchanges();
      }

      // =====================
      // CANCELLATIONS FUNCTIONS
      // =====================

      async function fetchCancellations() {
        updateRefreshIndicator('cancellations', true);
        try {
          const data = await apiRequest('/cancellations');
          cancellations = data.cancellations || [];
        } catch (e) {
          console.error('Failed to fetch cancellations:', e);
          showNotification('Failed to load cancellations from server', 'error');
          cancellations = [];
        }
        renderCancellations();
        updateRefreshIndicator('cancellations', false);
      }

      function renderCancellations() {
        renderCancellationsTable(cancellations);
      }

      function renderCancellationsTable(cancellationsList) {
        if (!cancellationsList || !cancellationsList.length) {
          cancellationsBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No cancellation requests yet</td></tr>';
          return;
        }

        cancellationsBody.innerHTML = cancellationsList
          .map(canc => {
            const dateStr = canc.requestedAt ? new Date(canc.requestedAt).toLocaleDateString() : '-';
            const timeStr = canc.requestedAt ? new Date(canc.requestedAt).toLocaleTimeString() : '';

            // Get customer details from order or cancellation data
            const order = orders.find(o => o.id === canc.orderId) || {};
            const customerName = order.shippingInfo?.name || order.userName || canc.customer?.name || '-';
            const customerEmail = order.shippingInfo?.email || order.userEmail || canc.customer?.email || '';
            const customerPhone = order.shippingInfo?.phone || canc.customer?.phone || '';
            const customerHtml = `<strong>${customerName}</strong><div style="font-size:0.75rem;color:#6b7280;">${customerEmail}</div><div style="font-size:0.75rem;color:#9ca3af;">${customerPhone}</div>`;

            const reason = canc.reason || '-';
            const status = canc.status || 'Pending';
            const orderTotal = canc.orderTotal || order.total || 0;

            return `
              <tr>
                <td><input type="checkbox" class="cancellation-checkbox" data-id="${canc.id}" aria-label="Select cancellation ${canc.id}" /></td>
                <td data-label="Cancel ID">
                  <strong>${canc.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Order ID"><strong>${canc.orderId || '-'}</strong></td>
                <td data-label="Customer">${customerHtml}</td>
                <td data-label="Order Total">${orderTotal.toLocaleString()}</td>
                <td data-label="Reason">${reason.replace(/_/g, ' ')}</td>
                <td data-label="Status">
                  <select class="cancellation-status" data-id="${canc.id}" aria-label="Cancellation ${canc.id} status">
                    <option value="Pending" ${status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Approved" ${status === 'Approved' ? 'selected' : ''}> Approved</option>
                    <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}> Rejected</option>
                    <option value="Refunded" ${status === 'Refunded' ? 'selected' : ''}> Refunded</option>
                    <option value="Completed" ${status === 'Completed' ? 'selected' : ''}> Completed</option>
                  </select>
                </td>
                <td data-label="Requested">${dateStr}</td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-cancellation" data-id="${canc.id}" aria-label="View" title="View cancellation details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-cancellation" data-id="${canc.id}" aria-label="Delete" title="Delete cancellation">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        // Attach status change handlers
        document.querySelectorAll('.cancellation-status').forEach(select => {
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const cancellationId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              pendingCancellationChanges.set(cancellationId, { status: newStatus, adminNotes: '' });
              e.target.classList.add('status-changed');
            } else {
              pendingCancellationChanges.delete(cancellationId);
              e.target.classList.remove('status-changed');
            }
            updatePendingCancellationUI();
          });
        });

        // Attach view/delete handlers
        document.querySelectorAll('[data-action="view-cancellation"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const cancellationId = btn.dataset.id;
            const canc = cancellations.find(x => x.id === cancellationId);
            if (canc) {
              const order = orders.find(o => o.id === canc.orderId) || {};
              const customerName = order.shippingInfo?.name || order.userName || canc.customer?.name || '-';
              const customerEmail = order.shippingInfo?.email || order.userEmail || canc.customer?.email || '-';
              const customerPhone = order.shippingInfo?.phone || canc.customer?.phone || '-';
              const details = `Cancellation ID: ${canc.id}\nOrder ID: ${canc.orderId || '-'}\nStatus: ${canc.status || '-'}\nRequested: ${canc.requestedAt ? new Date(canc.requestedAt).toLocaleString() : '-'}\n\nCustomer:\n  Name: ${customerName}\n  Email: ${customerEmail}\n  Phone: ${customerPhone}\n\nOrder Total: ${(canc.orderTotal || 0).toLocaleString()}\nPayment Method: ${canc.paymentMethod || '-'}\n\nReason: ${canc.reason || '-'}\n\nComments:\n  ${canc.description || '-'}`;
              showModal('Cancellation Details', '<pre style="white-space:pre-wrap;">' + details.replace(/</g, '&lt;') + '</pre>', null, e);
            }
          });
        });

        document.querySelectorAll('[data-action="delete-cancellation"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const cancellationId = btn.dataset.id;
            const confirmed = await AdminUniModal.danger('Delete Cancellation Request', `Are you sure you want to delete cancellation ${cancellationId}? This action cannot be undone.`);
            if (!confirmed) return;
            
            try {
              await apiRequest(`/cancellations/${cancellationId}`, { method: 'DELETE' });
              showNotification('Cancellation request deleted', 'success');
              await fetchCancellations();
            } catch (e) {
              console.error('Failed to delete cancellation:', e);
              showNotification('Failed to delete cancellation request', 'error');
            }
          });
        });
      }

      function updatePendingCancellationUI() {
        const btn = document.getElementById('saveCancellationChangesBtn');
        const countEl = document.getElementById('cancellationPendingCount');
        if (pendingCancellationChanges.size > 0) {
          if (btn) btn.classList.add('visible');
          if (countEl) countEl.textContent = `(${pendingCancellationChanges.size})`;
        } else {
          if (btn) btn.classList.remove('visible');
          if (countEl) countEl.textContent = '';
        }
      }

      async function saveCancellationChanges() {
        if (pendingCancellationChanges.size === 0) return;
        
        const total = pendingCancellationChanges.size;
        let success = 0;
        let failed = 0;
        
        for (const [cancellationId, changes] of pendingCancellationChanges.entries()) {
          try {
            await apiRequest(`/cancellations/${cancellationId}/status`, {
              method: 'PATCH',
              body: JSON.stringify({ status: changes.status, adminNotes: changes.adminNotes })
            });
            success++;
          } catch (e) {
            console.error(`Failed to update cancellation ${cancellationId}:`, e);
            failed++;
          }
        }
        
        pendingCancellationChanges.clear();
        updatePendingCancellationUI();
        
        if (failed === 0) {
          showNotification(`Successfully updated ${success} cancellation(s)`, 'success');
        } else {
          showNotification(`Updated ${success}, failed ${failed}`, 'warning');
        }
        
        await fetchCancellations();
      }

      // =====================
      // API HELPER FUNCTIONS
      // =====================

      // Pending changes tracking
      const pendingOrderChanges = new Map(); // orderId -> newStatus
      const pendingReturnChanges = new Map(); // returnId -> { status, adminNotes }
      const pendingExchangeChanges = new Map(); // exchangeId -> { status, adminNotes }
      const pendingCancellationChanges = new Map(); // cancellationId -> { status, adminNotes }

      function updatePendingOrderUI() {
        const btn = document.getElementById('saveOrderChangesBtn');
        const countEl = document.getElementById('orderPendingCount');
        if (pendingOrderChanges.size > 0) {
          if (btn) btn.classList.add('visible');
          if (countEl) countEl.textContent = `(${pendingOrderChanges.size})`;
        } else {
          if (btn) btn.classList.remove('visible');
          if (countEl) countEl.textContent = '';
        }
      }

      function updatePendingReturnUI() {
        const btn = document.getElementById('saveReturnChangesBtn');
        const countEl = document.getElementById('returnPendingCount');
        if (pendingReturnChanges.size > 0) {
          if (btn) btn.classList.add('visible');
          if (countEl) countEl.textContent = `(${pendingReturnChanges.size})`;
        } else {
          if (btn) btn.classList.remove('visible');
          if (countEl) countEl.textContent = '';
        }
      }

      // Update order status via API
      async function updateOrderStatus(orderId, newStatus) {
        try {
          await apiRequest(`/orders/${orderId}/status`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus })
          });
          return true;
        } catch (e) {
          console.error('Failed to update order status:', e);
          showNotification('Failed to update order status', 'error');
          return false;
        }
      }

      // Update return status via API
      async function updateReturnStatus(returnId, newStatus, adminNotes = '') {
        try {
          await apiRequest(`/returns/${returnId}/status`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus, adminNotes })
          });
          return true;
        } catch (e) {
          console.error('Failed to update return status:', e);
          showNotification('Failed to update return status', 'error');
          return false;
        }
      }

      // Save all pending order changes
      async function saveAllOrderChanges() {
        const btn = document.getElementById('saveOrderChangesBtn');
        if (pendingOrderChanges.size === 0) return;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Saving...';
        
        let successCount = 0;
        let failCount = 0;
        
        for (const [orderId, newStatus] of pendingOrderChanges) {
          const success = await updateOrderStatus(orderId, newStatus);
          if (success) {
            successCount++;
            // Update local state
            const idx = orders.findIndex(o => o.id === orderId);
            if (idx !== -1) orders[idx].status = newStatus;
            // Remove highlight
            const select = document.querySelector(`.order-status[data-id="${orderId}"]`);
            if (select) select.classList.remove('status-changed');
          } else {
            failCount++;
          }
        }
        
        pendingOrderChanges.clear();
        updatePendingOrderUI();
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-save-line"></i> Save Changes <span id="orderPendingCount" class="pending-count"></span>';
        
        if (successCount > 0) {
          showNotification(`${successCount} order(s) updated successfully!`, 'success');
        }
        if (failCount > 0) {
          showNotification(`${failCount} order(s) failed to update`, 'error');
        }
        
        await renderStatsAsync();
      }

      // Save all pending return changes
      async function saveAllReturnChanges() {
        const btn = document.getElementById('saveReturnChangesBtn');
        if (pendingReturnChanges.size === 0) return;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Saving...';
        
        let successCount = 0;
        let failCount = 0;
        
        for (const [returnId, data] of pendingReturnChanges) {
          const success = await updateReturnStatus(returnId, data.status, data.adminNotes || '');
          if (success) {
            successCount++;
            // Update local state
            const idx = returns.findIndex(r => r.id === returnId);
            if (idx !== -1) returns[idx].status = data.status;
            // Remove highlight
            const select = document.querySelector(`.return-status[data-id="${returnId}"]`);
            if (select) select.classList.remove('status-changed');
          } else {
            failCount++;
          }
        }
        
        pendingReturnChanges.clear();
        updatePendingReturnUI();
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-save-line"></i> Save Changes <span id="returnPendingCount" class="pending-count"></span>';
        
        if (successCount > 0) {
          showNotification(`${successCount} return(s) updated successfully!`, 'success');
        }
        if (failCount > 0) {
          showNotification(`${failCount} return(s) failed to update`, 'error');
        }
        
        await renderStatsAsync();
      }

      // Note: Save and refresh button handlers are now attached in DOMContentLoaded below

      // Fetch messages from API
      async function fetchMessagesFromAPI() {
        try {
          const data = await apiRequest('/contact');
          return data.messages || [];
        } catch (e) {
          console.error('Failed to fetch messages:', e);
          showNotification('Failed to load messages', 'error');
          return [];
        }
      }

      // Render stats asynchronously
      async function renderStatsAsync() {
        if (!insightsGrid) {
          insightsGrid = document.getElementById('insightsGrid');
        }
        if (!statsUpdatedEl) {
          statsUpdatedEl = document.getElementById('statsUpdated');
        }
        if (!insightsGrid) {
          console.error('[Admin] insightsGrid element not found');
          return;
        }
        
        try {
          const stats = await fetchStats();
          
          if (!stats || stats.length === 0) {
            insightsGrid.innerHTML = `
              <div class="insight-card">
                <div class="insight-icon muted">
                  <i class="ri-refresh-line"></i>
                </div>
                <div class="insight-content">
                  <span class="insight-label">Loading...</span>
                  <span class="insight-value">--</span>
                </div>
              </div>
            `;
            console.warn('[Admin] No stats data available');
            return;
          }
          
          const borderClasses = {
            'success': 'border-success',
            'warning': 'border-warning',
            'danger': 'border-danger',
            'primary': 'border-primary',
            'info': 'border-info',
            'muted': 'border-muted'
          };
          
          insightsGrid.innerHTML = stats
            .map(stat => `
              <div class="insight-card ${borderClasses[stat.color] || ''} ${stat.highlight ? 'highlight' : ''}">
                <div class="insight-icon ${stat.color || 'primary'}">
                  <i class="${stat.icon || 'ri-bar-chart-line'}"></i>
                </div>
                <div class="insight-content">
                  <span class="insight-label">${stat.label}</span>
                  <span class="insight-value">${stat.value}</span>
                </div>
              </div>
            `)
            .join('');
          if (statsUpdatedEl) statsUpdatedEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          console.error('[Admin] Failed to render stats:', error);
          insightsGrid.innerHTML = `
            <div class="insight-card border-danger">
              <div class="insight-icon danger">
                <i class="ri-error-warning-line"></i>
              </div>
              <div class="insight-content">
                <span class="insight-label">Error</span>
                <span class="insight-value">Failed to load</span>
              </div>
            </div>
          `;
        }
      }

      // =====================
      // ENHANCED FETCH FUNCTIONS
      // =====================
      async function fetchOrdersEnhanced() {
        updateRefreshIndicator('orders', true);
        await fetchOrdersData();
        renderOrders();
        updateRefreshIndicator('orders', false);
      }
      
      // Helper to fetch orders data from API
      async function fetchOrdersData() {
        try {
          const data = await apiRequest('/orders');
          orders = data.orders || [];
        } catch (e) {
          console.error('Failed to fetch orders:', e);
          showNotification('Failed to load orders', 'error');
          orders = [];
        }
      }

      // Enhanced fetchUsers with API support
      async function fetchUsersEnhanced() {
        updateRefreshIndicator('users', true);
        await fetchUsersData();
        renderUsers();
        updateRefreshIndicator('users', false);
      }
      
      // Helper to fetch users data from API
      async function fetchUsersData() {
        try {
          const data = await apiRequest('/users');
          users = data.users || [];
        } catch (e) {
          console.error('Failed to fetch users:', e);
          showNotification('Failed to load users', 'error');
          users = [];
        }
      }

      // Enhanced fetchReturns with API support
      async function fetchReturnsEnhanced() {
        updateReturnsRefreshIndicator('returns', true);
        await fetchReturnsData();
        renderReturns();
        updateReturnsRefreshIndicator('returns', false);
      }
      
      // Helper to fetch returns data from API
      async function fetchReturnsData() {
        try {
          const data = await apiRequest('/returns');
          returns = data.returns || [];
        } catch (e) {
          console.error('Failed to fetch returns:', e);
          showNotification('Failed to load returns', 'error');
          returns = [];
        }
      }

      // Replace original fetch functions
      fetchOrders = fetchOrdersEnhanced;
      fetchUsers = fetchUsersEnhanced;
      fetchReturns = fetchReturnsEnhanced;

      // Initialize dashboard
      async function initDashboard() {
        // Initialize DOM element references first
        initDOMElements();
        
        // Check if API is available first
        await checkApiAvailability();
        
        await renderStatsAsync();
        await fetchProducts();
        fetchOrders();
        fetchUsers();
        fetchReturns();
        fetchExchanges();
        fetchCancellations();
        loadPasswordResetData(); // Load password reset management data
        attachProductHandlers();
        handleDownload();
        setupAutoRefresh();
      }

      // Initialize dashboard when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDashboard);
      } else {
        initDashboard();
      }
    </script>
    <!-- contextmenu blocking removed for admin page -->

    <!-- Enhanced Modal -->
    <div id="adminModal" class="modal" onclick="if(event.target === this) closeModal()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3 id="modalTitle">Confirm Action</h3>
          <button type="button" class="modal-close" id="modalCloseBtn" aria-label="Close modal"></button>
        </div>
        <div class="modal-body" id="modalBody">
          Are you sure you want to perform this action?
        </div>
        <div class="modal-footer">
          <button type="button" class="secondary" id="modalCancelBtn">Cancel</button>
          <button type="button" class="primary" id="modalConfirmBtn">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Universal Confirm/Prompt Modal -->
    <div class="admin-uni-modal" id="adminUniModal">
      <div class="admin-uni-modal-box">
        <div class="admin-uni-modal-header">
          <div class="admin-uni-modal-icon confirm" id="adminUniModalIcon">
            <i class="ri-question-line" id="adminUniModalIconI"></i>
          </div>
          <h3 id="adminUniModalTitle">Confirm Action</h3>
          <p id="adminUniModalMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="admin-uni-modal-body" id="adminUniModalBody" style="display: none;">
          <input type="text" class="admin-uni-modal-input" id="adminUniModalInput" placeholder="Enter value">
        </div>
        <div class="admin-uni-modal-info" id="adminUniModalInfo" style="display: none;">
          <pre id="adminUniModalInfoContent"></pre>
        </div>
        <div class="admin-uni-modal-footer">
          <button class="admin-uni-modal-btn cancel" id="adminUniModalCancel">Cancel</button>
          <button class="admin-uni-modal-btn primary" id="adminUniModalConfirm">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Direct Password Reset Modal -->
    <div id="directResetModal" class="direct-reset-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="ri-lock-unlock-line"></i> Direct Password Reset</h3>
          <button class="modal-close" onclick="closeDirectResetModal()"></button>
        </div>
        <div style="margin-bottom: 20px; padding: 14px; background: #f0f9ff; border-radius: 12px; border: 1px solid #bae6fd; display: flex; align-items: center; gap: 12px;">
          <div style="width: 44px; height: 44px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">
            <i class="ri-user-follow-line"></i>
          </div>
          <div>
            <div style="font-weight: 700; color: #0c4a6e; font-size: 1rem;" id="directResetUserName">User Name</div>
            <div style="font-size: 0.85rem; color: #0ea5e9; font-family: monospace;" id="directResetUserEmail">user@email.com</div>
          </div>
        </div>
        <div class="form-group">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">New Password</label>
          <div class="password-wrapper" style="position: relative;">
            <input type="password" id="directResetPassword" placeholder="Minimum 8 characters" style="width: 100%; padding: 12px 40px 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 0.95rem;">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('directResetPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer;">
              <i class="ri-eye-line"></i>
            </button>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
            <span style="font-size: 0.75rem; color: #6b7280;"><i class="ri-information-line"></i> Use a strong mix of characters</span>
            <span class="generate-password" onclick="generateRandomPassword()" style="font-size: 0.8rem; color: #3b82f6; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 4px;">
              <i class="ri-refresh-line"></i> Generate Strong Password
            </span>
          </div>
        </div>
        <div class="form-group" style="margin-top: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Confirm New Password</label>
          <div class="password-wrapper" style="position: relative;">
            <input type="password" id="directResetConfirm" placeholder="Repeat new password" style="width: 100%; padding: 12px 40px 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 0.95rem;">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('directResetConfirm')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer;">
              <i class="ri-eye-line"></i>
            </button>
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 24px; display: flex; gap: 12px;">
          <button class="btn-cancel" onclick="closeDirectResetModal()" style="flex: 1; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff; color: #4b5563; font-weight: 600; cursor: pointer;">Cancel</button>
          <button class="btn-reset" id="executeDirectResetBtn" onclick="executeDirectReset()" style="flex: 2; padding: 12px; border: none; border-radius: 10px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="ri-lock-unlock-line"></i> Reset Password
          </button>
        </div>
      </div>
    </div>

    <script>
      // Enhanced Admin Functionality

      // Modal functions
      function showModal(title, body, confirmCallback, clickEvent) {
        const modal = document.getElementById('adminModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');
        const closeBtn = document.getElementById('modalCloseBtn');
        const modalContent = modal.querySelector('.modal-content');
        
        modalTitle.textContent = title;
        modalBody.innerHTML = body;
        
        // Always center positioning in view as requested
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modalContent.style.position = 'relative';
        modalContent.style.top = 'auto';
        modalContent.style.left = 'auto';
        modalContent.style.transform = 'none';
        
        // Setup confirm button
        if (confirmCallback && typeof confirmCallback === 'function') {
          confirmBtn.style.display = 'inline-block';
          confirmBtn.onclick = confirmCallback;
        } else {
          // Hide confirm button for info-only modals
          confirmBtn.style.display = 'none';
          confirmBtn.onclick = null;
        }
        
        // Setup close/cancel buttons
        closeBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;
        
        // Show modal
        modal.classList.add('show');
        
        // Focus trap - focus the first focusable element
        setTimeout(() => {
          const focusable = modal.querySelectorAll('button, input, select, textarea');
          if (focusable.length > 0) focusable[0].focus();
        }, 100);
      }

      function closeModal() {
        const modal = document.getElementById('adminModal');
        modal.classList.remove('show');
        
        // Clean up onclick handlers
        const confirmBtn = document.getElementById('modalConfirmBtn');
        if (confirmBtn) confirmBtn.onclick = null;
      }

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('adminModal');
          if (modal && modal.classList.contains('show')) {
            closeModal();
          }
          // Also close uni modal
          if (AdminUniModal.overlay?.classList.contains('show')) {
            AdminUniModal.hide();
            if (AdminUniModal.resolvePromise) AdminUniModal.resolvePromise(null);
          }
        }
      });

      // =====================================================
      // ADMIN UNIVERSAL MODAL SYSTEM - Replace native dialogs
      // =====================================================
      const AdminUniModal = {
        overlay: null,
        resolvePromise: null,
        
        init() {
          this.overlay = document.getElementById('adminUniModal');
          if (!this.overlay) return;
          
          // Cancel button
          document.getElementById('adminUniModalCancel')?.addEventListener('click', () => {
            this.hide();
            if (this.resolvePromise) this.resolvePromise(null);
          });
          
          // Confirm button
          document.getElementById('adminUniModalConfirm')?.addEventListener('click', () => {
            const input = document.getElementById('adminUniModalInput');
            const body = document.getElementById('adminUniModalBody');
            const value = body.style.display !== 'none' ? input.value : true;
            
            this.hide();
            if (this.resolvePromise) this.resolvePromise(value);
          });
          
          // Close on overlay click
          this.overlay.addEventListener('click', (e) => {
            if (e.target === this.overlay) {
              this.hide();
              if (this.resolvePromise) this.resolvePromise(null);
            }
          });
          
          // Enter key for input
          document.getElementById('adminUniModalInput')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              document.getElementById('adminUniModalConfirm').click();
            }
          });
        },
        
        show(options = {}) {
          const {
            type = 'confirm',
            icon = 'ri-question-line',
            title = 'Confirm',
            message = 'Are you sure?',
            inputPlaceholder = '',
            inputValue = '',
            confirmText = 'Confirm',
            cancelText = 'Cancel',
            confirmClass = 'primary',
            infoContent = ''
          } = options;
          
          // Set icon
          const iconEl = document.getElementById('adminUniModalIcon');
          const iconI = document.getElementById('adminUniModalIconI');
          iconEl.className = `admin-uni-modal-icon ${type}`;
          iconI.className = icon;
          
          // Set text
          document.getElementById('adminUniModalTitle').textContent = title;
          const messageEl = document.getElementById('adminUniModalMessage');
          messageEl.textContent = message;
          messageEl.style.display = message ? 'block' : 'none';
          
          // Handle input
          const body = document.getElementById('adminUniModalBody');
          const input = document.getElementById('adminUniModalInput');
          const infoDiv = document.getElementById('adminUniModalInfo');
          const infoContentEl = document.getElementById('adminUniModalInfoContent');
          
          body.style.display = 'none';
          infoDiv.style.display = 'none';
          
          if (type === 'input') {
            body.style.display = 'block';
            input.placeholder = inputPlaceholder;
            input.value = inputValue;
            setTimeout(() => input.focus(), 100);
          } else if (type === 'info' && infoContent) {
            infoDiv.style.display = 'block';
            infoContentEl.innerHTML = infoContent;
          }
          
          // Set buttons
          document.getElementById('adminUniModalCancel').textContent = cancelText;
          const confirmBtn = document.getElementById('adminUniModalConfirm');
          confirmBtn.textContent = confirmText;
          confirmBtn.className = `admin-uni-modal-btn ${confirmClass}`;
          
          // Show modal
          this.overlay.classList.add('show');
          
          return new Promise(resolve => {
            this.resolvePromise = resolve;
          });
        },
        
        hide() {
          this.overlay?.classList.remove('show');
        },
        
        // Shorthand methods
        async confirm(title, message, options = {}) {
          return this.show({
            type: 'confirm',
            icon: 'ri-question-line',
            title,
            message,
            confirmText: options.confirmText || 'Yes',
            cancelText: options.cancelText || 'Cancel',
            confirmClass: options.danger ? 'danger' : 'primary'
          });
        },
        
        async prompt(title, message, defaultValue = '', placeholder = '') {
          return this.show({
            type: 'input',
            icon: 'ri-edit-line',
            title,
            message,
            inputValue: defaultValue,
            inputPlaceholder: placeholder || 'Enter value',
            confirmText: 'Save',
            confirmClass: 'primary'
          });
        },
        
        async danger(title, message, confirmText = 'Delete') {
          return this.show({
            type: 'danger',
            icon: 'ri-error-warning-line',
            title,
            message,
            confirmText,
            confirmClass: 'danger'
          });
        },
        
        async info(title, htmlContent) {
          return this.show({
            type: 'info',
            icon: 'ri-information-line',
            title,
            message: '',
            infoContent: htmlContent,
            confirmText: 'OK',
            cancelText: 'Close',
            confirmClass: 'primary'
          });
        }
      };
      
      // Initialize admin modal on DOM ready
      document.addEventListener('DOMContentLoaded', () => AdminUniModal.init());

      // Search and Filter functionality
      let currentFilters = {
        search: '',
        status: '',
        date: ''
      };

      function initializeSearchAndFilters() {
        const searchInput = document.getElementById('orderSearch');
        const clearSearchBtn = document.getElementById('clearSearch');
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');

        // Search functionality
        searchInput.addEventListener('input', debounce(() => {
          currentFilters.search = searchInput.value.toLowerCase();
          renderFilteredOrders();
        }, 300));

        clearSearchBtn.addEventListener('click', () => {
          searchInput.value = '';
          currentFilters.search = '';
          renderFilteredOrders();
        });

        // Filter functionality
        statusFilter.addEventListener('change', () => {
          currentFilters.status = statusFilter.value;
          renderFilteredOrders();
        });

        dateFilter.addEventListener('change', () => {
          currentFilters.date = dateFilter.value;
          renderFilteredOrders();
        });
      }

      function renderFilteredOrders() {
        const filteredOrders = orders.filter(order => {
          // Search filter
          if (currentFilters.search) {
            const searchTerm = currentFilters.search;
            const matchesSearch =
              order.id.toLowerCase().includes(searchTerm) ||
              (order.customer?.name || '').toLowerCase().includes(searchTerm) ||
              (order.customer?.email || '').toLowerCase().includes(searchTerm) ||
              (order.status || '').toLowerCase().includes(searchTerm);
            if (!matchesSearch) return false;
          }

          // Status filter
          if (currentFilters.status && order.status !== currentFilters.status) {
            return false;
          }

          // Date filter
          if (currentFilters.date) {
            const orderDate = new Date(order.createdAt || 0);
            const now = new Date();
            let dateMatch = false;

            switch (currentFilters.date) {
              case 'today':
                dateMatch = orderDate.toDateString() === now.toDateString();
                break;
              case 'week':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                dateMatch = orderDate >= weekAgo;
                break;
              case 'month':
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                dateMatch = orderDate >= monthAgo;
                break;
            }
            if (!dateMatch) return false;
          }

          return true;
        });

        renderOrdersTable(filteredOrders);
      }

      // Bulk actions functionality
      let selectedOrders = new Set();

      function initializeBulkActions() {
        const selectAllCheckbox = document.getElementById('selectAllOrders');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const bulkStatusBtn = document.getElementById('bulkStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

        selectAllCheckbox.addEventListener('change', () => {
          const checkboxes = document.querySelectorAll('.order-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
            updateOrderSelection(cb.dataset.id, cb.checked);
          });
          updateBulkActionsState();
        });

        selectAllBtn.addEventListener('click', () => {
          const allCheckboxes = document.querySelectorAll('.order-checkbox');
          const allSelected = selectedOrders.size === allCheckboxes.length;
          const newState = !allSelected;

          allCheckboxes.forEach(cb => {
            cb.checked = newState;
            updateOrderSelection(cb.dataset.id, newState);
          });
          selectAllCheckbox.checked = newState;
          updateBulkActionsState();
        });

        bulkStatusBtn.addEventListener('click', (e) => {
          if (selectedOrders.size === 0) return;

          const statusOptions = `
            <label for="bulkStatusSelect" style="font-weight:600; display:block; margin-bottom:6px;">Status:</label>
            <select id="bulkStatusSelect" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 10px;">
              <option value="Processing">Processing</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          `;

          showModal(
            `Update ${selectedOrders.size} Order${selectedOrders.size > 1 ? 's' : ''}`,
            `Select new status for ${selectedOrders.size} selected order${selectedOrders.size > 1 ? 's' : ''}: ${statusOptions}`,
            () => {
              const newStatus = document.getElementById('bulkStatusSelect').value;
              bulkUpdateStatus(newStatus);
              closeModal();
            },
            e
          );
        });

        bulkDeleteBtn.addEventListener('click', (e) => {
          if (selectedOrders.size === 0) return;

          showModal(
            `Delete ${selectedOrders.size} Order${selectedOrders.size > 1 ? 's' : ''}`,
            `Are you sure you want to delete ${selectedOrders.size} selected order${selectedOrders.size > 1 ? 's' : ''}? This action cannot be undone.`,
            () => {
              bulkDeleteOrders();
              closeModal();
            },
            e
          );
        });
      }

      function updateOrderSelection(orderId, selected) {
        if (selected) {
          selectedOrders.add(orderId);
        } else {
          selectedOrders.delete(orderId);
        }
        updateBulkActionsState();
      }

      function updateBulkActionsState() {
        const bulkStatusBtn = document.getElementById('bulkStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

        const hasSelection = selectedOrders.size > 0;
        bulkStatusBtn.disabled = !hasSelection;
        bulkDeleteBtn.disabled = !hasSelection;

        bulkStatusBtn.textContent = hasSelection ? `Update ${selectedOrders.size}` : 'Bulk Update Status';
        bulkDeleteBtn.textContent = hasSelection ? `Delete ${selectedOrders.size}` : 'Delete Selected';
      }

      async function bulkUpdateStatus(newStatus) {
        for (const orderId of selectedOrders) {
          await updateOrderStatus(orderId, newStatus);
        }
        selectedOrders.clear();
        updateBulkActionsState();
        await fetchOrders();
        await renderStatsAsync();
      }

      async function bulkDeleteOrders() {
        try {
          for (const orderId of selectedOrders) {
            await apiRequest(`/orders/${orderId}`, { method: 'DELETE' });
          }
          showNotification('Orders deleted successfully', 'success');
        } catch (e) {
          console.error('Failed to delete orders:', e);
          showNotification('Failed to delete some orders', 'error');
        }
        selectedOrders.clear();
        updateBulkActionsState();
        await fetchOrders();
        await renderStatsAsync();
      }

      // Export functionality
      function initializeExport() {
        const exportBtn = document.getElementById('exportOrdersBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportOrdersToCSV);
        
        const exportReturnsBtn = document.getElementById('exportReturnsBtn');
        if (exportReturnsBtn) exportReturnsBtn.addEventListener('click', exportReturnsToCSV);
        
        const exportExchangesBtn = document.getElementById('exportExchangesBtn');
        if (exportExchangesBtn) exportExchangesBtn.addEventListener('click', exportExchangesToCSV);
        
        const exportCancellationsBtn = document.getElementById('exportCancellationsBtn');
        if (exportCancellationsBtn) exportCancellationsBtn.addEventListener('click', exportCancellationsToCSV);
      }

      async function exportOrdersToCSV() {
        // Use orders from state
        let ordersToExport = orders;
        
        // If no orders in state, try to fetch fresh data
        if (!ordersToExport.length) {
          try {
            const data = await apiRequest('/orders');
            ordersToExport = data.orders || [];
          } catch (e) {
            console.error('Failed to fetch orders for export:', e);
            showNotification('Failed to fetch orders', 'error');
            return;
          }
        }
        
        if (!ordersToExport.length) {
          showToast('No orders to export', 'info');
          return;
        }

        const csvContent = [
          // Header
          ['Order ID', 'Customer Name', 'Email', 'Phone', 'Total Amount', 'Status', 'Date', 'Items Count', 'Address'].join(','),
          // Data
          ...ordersToExport.map(order => [
            order.id,
            order.customer?.name || '',
            order.customer?.email || '',
            order.customer?.phone || '',
            order.total || order.amount || 0,
            order.status || 'Pending',
            order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '',
            order.items?.length || 0,
            `"${(order.address?.street || '') + ', ' + (order.address?.city || '') + ', ' + (order.address?.state || '')}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `orders_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function exportReturnsToCSV() {
        // Use returns from state
        let returnsToExport = returns;
        
        // If no returns in state, try to fetch fresh data
        if (!returnsToExport.length) {
          try {
            const data = await apiRequest('/returns');
            returnsToExport = data.returns || [];
          } catch (e) {
            console.error('Failed to fetch returns for export:', e);
            showNotification('Failed to fetch returns', 'error');
            return;
          }
        }
        
        if (!returnsToExport.length) {
          showToast('No returns to export', 'info');
          return;
        }

        const csvContent = [
          // Header
          ['Return ID', 'Order ID', 'Customer Name', 'Email', 'Product', 'Reason', 'Status', 'Refund Amount', 'Date', 'Notes'].join(','),
          // Data
          ...returnsToExport.map(ret => [
            ret.id || '',
            ret.orderId || '',
            ret.customer?.name || ret.customerName || '',
            ret.customer?.email || ret.email || '',
            `"${ret.productName || ''}"`,
            ret.reason || '',
            ret.status || 'Pending',
            ret.refundAmount || 0,
            ret.createdAt ? new Date(ret.createdAt).toLocaleDateString() : '',
            `"${(ret.adminNotes || ret.notes || '').replace(/"/g, '""')}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `returns_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function exportExchangesToCSV() {
        let exchangesToExport = exchanges;
        
        if (!exchangesToExport.length) {
          try {
            const data = await apiRequest('/exchanges');
            exchangesToExport = data.exchanges || [];
          } catch (e) {
            console.error('Failed to fetch exchanges for export:', e);
            showNotification('Failed to fetch exchanges', 'error');
            return;
          }
        }
        
        if (!exchangesToExport.length) {
          showToast('No exchanges to export', 'info');
          return;
        }

        const csvContent = [
          ['Exchange ID', 'Order ID', 'Customer Name', 'Email', 'Phone', 'Items', 'Exchange For', 'Reason', 'Status', 'Requested Date'].join(','),
          ...exchangesToExport.map(exc => [
            exc.id || '',
            exc.orderId || '',
            exc.customer?.name || '',
            exc.customer?.email || '',
            exc.customer?.phone || '',
            `"${exc.items?.map(i => `${i.name || 'Product'} (${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1}`).join('; ') || ''}"`,
            exc.exchangeFor || '',
            exc.reason || '',
            exc.status || 'Pending',
            exc.requestedAt ? new Date(exc.requestedAt).toLocaleDateString() : ''
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `exchanges_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Exchanges exported successfully', 'success');
      }

      async function exportCancellationsToCSV() {
        let cancellationsToExport = cancellations;
        
        if (!cancellationsToExport.length) {
          try {
            const data = await apiRequest('/cancellations');
            cancellationsToExport = data.cancellations || [];
          } catch (e) {
            console.error('Failed to fetch cancellations for export:', e);
            showNotification('Failed to fetch cancellations', 'error');
            return;
          }
        }
        
        if (!cancellationsToExport.length) {
          showToast('No cancellations to export', 'info');
          return;
        }

        const csvContent = [
          ['Cancellation ID', 'Order ID', 'Customer Name', 'Email', 'Phone', 'Order Total', 'Payment Method', 'Reason', 'Status', 'Requested Date'].join(','),
          ...cancellationsToExport.map(canc => [
            canc.id || '',
            canc.orderId || '',
            canc.customer?.name || '',
            canc.customer?.email || '',
            canc.customer?.phone || '',
            canc.orderTotal || 0,
            canc.paymentMethod || '',
            canc.reason || '',
            canc.status || 'Pending',
            canc.requestedAt ? new Date(canc.requestedAt).toLocaleDateString() : ''
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `cancellations_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Cancellations exported successfully', 'success');
      }

      // Enhanced renderOrders to include checkboxes
      function renderOrdersTable(ordersToRender = orders) {
        if (!ordersToRender.length) {
          ordersBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>No orders found matching your filters</td></tr>';
          return;
        }

        ordersBody.innerHTML = ordersToRender
          .map(order => {
            const dateStr = order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-';
            const timeStr = order.createdAt ? new Date(order.createdAt).toLocaleTimeString() : '';

            // Build items detail with images
            const itemsHtml = order.items?.map(i => {
              const product = products.find(p => p.id === i.id || p.id === i.productId);
              const imageUrl = i.image || i.thumbImage || (product && (product.image || product.thumbImages?.[0])) || '';
              const hasImage = imageUrl && imageUrl !== '' && !imageUrl.includes('placeholder');
              const imgSrc = hasImage ? normalizeUploadUrl(imageUrl) : '';
              return `<div class="item" style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                ${hasImage ? `<img src="${imgSrc}" alt="" style="width: 24px; height: 24px; object-fit: cover; border-radius: 3px;" onerror="this.style.display='none'">` : ''}
                <span>${i.name || 'Product'} <small>(${i.selectedSize || i.size || '-'}/${i.selectedColor || i.color || '-'}) x${i.quantity || 1}</small></span>
              </div>`;
            }).join('') || '<div class="item">-</div>';

            // Build address
            const addr = order.address || order.shippingInfo || {};
            const addressStr = [addr.street, addr.city, addr.state, addr.postal].filter(Boolean).join(', ') || '-';

            return `
              <tr class="${selectedOrders.has(order.id) ? 'selected' : ''}">
                <td data-label="Select">
                  <input type="checkbox" class="order-checkbox" data-id="${order.id}" ${selectedOrders.has(order.id) ? 'checked' : ''} aria-label="Select order ${order.id}" />
                </td>
                <td data-label="Order #">
                  <strong>${order.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Customer">
                  <strong>${order.customer?.name || order.userName || '-'}</strong>
                  <div style="font-size:0.75rem;color:#6b7280;">${order.customer?.email || order.userEmail || ''}</div>
                  <div style="font-size:0.75rem;color:#9ca3af;">${order.customer?.phone || ''}</div>
                </td>
                <td data-label="Amount"><strong>${(order.total || order.amount || 0).toLocaleString()}</strong></td>
                <td data-label="Date">${dateStr}</td>
                <td data-label="Status">
                  <select class="order-status" data-id="${order.id}" aria-label="Order ${order.id} status">
                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}> Processing</option>
                    <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}> Shipped</option>
                    <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}> Delivered</option>
                    <option value="Return Requested" ${order.status === 'Return Requested' ? 'selected' : ''}> Return Requested</option>
                    <option value="Exchange Requested" ${order.status === 'Exchange Requested' ? 'selected' : ''}> Exchange Requested</option>
                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}> Cancelled</option>
                  </select>
                </td>
                <td data-label="Items">
                  <div class="order-items-detail">${itemsHtml}</div>
                </td>
                <td data-label="Address">
                  <div class="order-address" title="${addressStr}">${addressStr.length > 40 ? addressStr.slice(0, 40) + '...' : addressStr}</div>
                </td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-order" data-id="${order.id}" aria-label="View" title="View order details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-order" data-id="${order.id}" aria-label="Delete" title="Delete order">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        // Attach event listeners
        attachOrderEventListeners();
      }

      function attachOrderEventListeners() {
        // Status change handlers - track pending changes
        document.querySelectorAll('.order-status').forEach(select => {
          // Store original value for comparison
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const orderId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              // Add to pending changes
              pendingOrderChanges.set(orderId, newStatus);
              e.target.classList.add('status-changed');
            } else {
              // Remove from pending if reverted to original
              pendingOrderChanges.delete(orderId);
              e.target.classList.remove('status-changed');
            }
            updatePendingOrderUI();
          });
        });

        // Checkbox handlers
        document.querySelectorAll('.order-checkbox').forEach(cb => {
          cb.addEventListener('change', (e) => {
            updateOrderSelection(e.target.dataset.id, e.target.checked);
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.order-checkbox');
            const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
            document.getElementById('selectAllOrders').checked = allCheckboxes.length === checkedBoxes.length;
          });
        });

        // Action handlers
        document.querySelectorAll('[data-action="view-order"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const orderId = btn.dataset.id;
            const order = orders.find(o => o.id === orderId);
            if (order) {
              const addr = order.shippingInfo || order.address || {};
              const addressStr = [addr.name, addr.address || addr.street, addr.city, addr.state, addr.postal || addr.postalCode, addr.country].filter(Boolean).join(', ') || 'Not provided';
              const itemsTotal = order.items?.reduce((sum, i) => sum + ((i.price || 0) * (i.quantity || 1)), 0) || 0;
              
              const orderDetails = `
<div class="message-detail">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div class="detail-row">
      <label>Order ID:</label>
      <p><strong>${order.id}</strong></p>
    </div>
    <div class="detail-row">
      <label>Status:</label>
      <p><span class="status-badge ${getStatusBadgeClass(order.status)}">${order.status || 'Pending'}</span></p>
    </div>
    <div class="detail-row">
      <label>Date:</label>
      <p>${order.createdAt ? new Date(order.createdAt).toLocaleString() : '-'}</p>
    </div>
    <div class="detail-row">
      <label>Payment:</label>
      <p>${order.paymentMethod || 'COD'} <span style="color: ${order.paymentStatus === 'paid' || order.paymentStatus === 'Paid' ? '#059669' : '#d97706'};">(${order.paymentStatus || 'Pending'})</span></p>
    </div>
  </div>
  
  <div class="detail-row" style="margin-top: 16px;">
    <label><i class="ri-user-line"></i> Customer Information:</label>
    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6;">
      <strong>${order.shippingInfo?.name || order.customer?.name || order.userName || '-'}</strong><br>
      <a href="mailto:${order.shippingInfo?.email || order.customer?.email || order.userEmail}">${order.shippingInfo?.email || order.customer?.email || order.userEmail || '-'}</a><br>
      <a href="tel:${order.shippingInfo?.phone || order.customer?.phone || ''}">${order.shippingInfo?.phone || order.customer?.phone || 'No phone'}</a>
    </div>
  </div>

  <div class="detail-row" style="margin-top: 16px;">
    <label><i class="ri-map-pin-line"></i> Shipping Address:</label>
    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; border-left: 3px solid #10b981;">
      ${addressStr}
    </div>
  </div>

  <div class="detail-row" style="margin-top: 16px;">
    <label><i class="ri-shopping-bag-line"></i> Order Items (${order.items?.length || 0}):</label>
    <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
      ${order.items?.map(i => {
        // Try to find product image from products array or use stored image
        const product = products.find(p => p.id === i.id || p.id === i.productId);
        const imageUrl = i.image || i.thumbImage || (product && (product.image || product.thumbImages?.[0])) || '';
        const hasImage = imageUrl && imageUrl !== '' && !imageUrl.includes('placeholder');
        return `
        <div style="display: flex; align-items: center; gap: 12px; padding: 8px; margin-bottom: 4px; background: white; border-radius: 4px;">
          ${hasImage ? `<img src="${normalizeUploadUrl(imageUrl)}" alt="${i.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb;" onerror="this.style.display='none'">` : `<div style="width: 50px; height: 50px; background: #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb;"><i class="ri-image-line" style="color: #9ca3af;"></i></div>`}
          <div style="flex: 1;">
            <strong>${i.name || 'Product'}</strong>
            <small style="display: block; color: #6b7280;">Size: ${i.selectedSize || i.size || '-'} | Color: ${i.selectedColor || i.color || '-'}</small>
          </div>
          <div style="text-align: right;">
            <span style="display: block; color: #6b7280;">x${i.quantity || 1}</span>
            <strong>${((i.price || 0) * (i.quantity || 1)).toLocaleString()}</strong>
          </div>
        </div>
      `}).join('') || '<p style="color: #9ca3af;">No items</p>'}
    </div>
  </div>

  <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 8px; color: white;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
      <span>Subtotal:</span>
      <span>${(order.subtotal || itemsTotal).toLocaleString()}</span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
      <span>Shipping:</span>
      <span>${(order.shipping || 0).toLocaleString()}</span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
      <span>Total:</span>
      <span>${(order.total || order.amount || 0).toLocaleString()}</span>
    </div>
  </div>
</div>
              `;
              showModal('Order Details', orderDetails, null, e);
            }
          });
        });

        document.querySelectorAll('[data-action="delete-order"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = btn.dataset.id;
            showModal(
              'Delete Order',
              `Are you sure you want to delete order <strong>${orderId}</strong>? This action cannot be undone.`,
              async () => {
                try {
                  await apiRequest(`/orders/${orderId}`, { method: 'DELETE' });
                  showNotification('Order deleted successfully', 'success');
                } catch (e) {
                  console.error('Failed to delete order:', e);
                  showNotification('Failed to delete order', 'error');
                }
                closeModal();
                await fetchOrders();
                await renderStatsAsync();
              }
            );
          });
        });
      }

      // Utility functions
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function showSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Product search and filters
      let productFilters = {
        search: '',
        category: ''
      };

      function initializeProductSearch() {
        const searchInput = document.getElementById('productSearch');
        const clearSearchBtn = document.getElementById('clearProductSearch');
        const categoryFilter = document.getElementById('productCategoryFilter');

        if (searchInput) {
          searchInput.addEventListener('input', debounce(() => {
            productFilters.search = searchInput.value.toLowerCase();
            renderFilteredProductsList();
          }, 300));
        }

        if (clearSearchBtn) {
          clearSearchBtn.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';
            productFilters.search = '';
            renderFilteredProductsList();
          });
        }

        if (categoryFilter) {
          categoryFilter.addEventListener('change', () => {
            productFilters.category = categoryFilter.value;
            renderFilteredProductsList();
          });
        }
      }

      function renderFilteredProductsList() {
        const filteredProducts = products.filter(product => {
          // Search filter
          if (productFilters.search) {
            const searchTerm = productFilters.search;
            const matchesSearch =
              (product.name || '').toLowerCase().includes(searchTerm) ||
              (product.description || '').toLowerCase().includes(searchTerm) ||
              (product.color || '').toLowerCase().includes(searchTerm) ||
              (product.id || '').toLowerCase().includes(searchTerm);
            if (!matchesSearch) return false;
          }

          // Category filter - match against product name for category-like filtering
          if (productFilters.category) {
            const category = productFilters.category.toLowerCase();
            const productName = (product.name || '').toLowerCase();
            const productDesc = (product.description || '').toLowerCase();
            
            // Check if product belongs to category
            if (category === 't-shirts' && !productName.includes('t-shirt') && !productName.includes('tee') && !productName.includes('shirt')) {
              return false;
            }
            if (category === 'hoodies' && !productName.includes('hoodie') && !productName.includes('sweatshirt')) {
              return false;
            }
            if (category === 'accessories' && !productName.includes('cap') && !productName.includes('bag') && !productName.includes('hat') && !productName.includes('accessory')) {
              return false;
            }
          }

          return true;
        });

        renderProductsFiltered(filteredProducts);
      }

      function renderProductsFiltered(productsToRender) {
        if (!productsToRender || !productsToRender.length) {
          const hasFilters = productFilters.search || productFilters.category;
          const message = hasFilters ? 'No products found matching your filters' : 'No products added yet';
          productBody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>${message}</td></tr>`;
          return;
        }

        productBody.innerHTML = productsToRender
          .map(product => {
            const positionBadge = product.position 
              ? `<span class="position-badge">${product.position}</span>` 
              : `<span class="position-badge empty">-</span>`;
            // Handle both old thumbImage (string) and new thumbImages (array)
            const thumbnails = product.thumbImages && product.thumbImages.length > 0 
              ? product.thumbImages 
              : (product.thumbImage ? [product.thumbImage] : [product.image]);
            const thumbsHtml = thumbnails.filter(t => t).slice(0, 3).map((thumb, i) => 
              `<img src="${normalizeUploadUrl(thumb)}" alt="${product.name} thumb ${i+1}" title="Thumbnail ${i+1}" class="thumb-img" style="${i > 0 ? 'margin-left: -8px;' : ''}" onerror="this.src=getPlaceholder(36,36,'Thumb')" />`
            ).join('') + (thumbnails.length > 3 ? `<span class="more-thumbs">+${thumbnails.length - 3}</span>` : '') || `<img src="${getPlaceholder(36,36,'Thumb')}" alt="No thumbnail" class="thumb-img" />`;
            
            // SKU and Barcode display
            const skuDisplay = product.sku ? `<code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:0.75rem;">${product.sku}</code>` : '<span style="color:#9ca3af;font-size:0.75rem;">Not set</span>';
            const barcodeDisplay = product.barcode ? `<span style="font-size:0.7rem;color:#6b7280;">${product.barcode}</span>` : '';
            
            // Stock status badge
            const isOutOfStock = product.isOutOfStock || product.stockStatus === 'out-of-stock';
            const stockStatusBadge = isOutOfStock 
              ? '<span class="stock-status-badge out-of-stock"><i class="ri-close-circle-line"></i> Out of Stock</span>'
              : '<span class="stock-status-badge in-stock"><i class="ri-checkbox-circle-line"></i> In Stock</span>';
            
            return `
            <tr class="${isOutOfStock ? 'out-of-stock-row' : ''}">
              <td data-label="Position">${positionBadge}</td>
              <td data-label="Product">
                <div class="product-label">
                  <div class="product-images">
                    <img src="${product.image ? normalizeUploadUrl(product.image) : getPlaceholder(56,56,'Main')}" alt="${product.name}" title="Main Image" onerror="this.src=getPlaceholder(56,56,'Main')" />
                    <div class="thumbs-container">${thumbsHtml}</div>
                  </div>
                  <div>
                    <strong>${product.name}</strong>
                    <span class="product-id">ID: ${(product.id || '').slice(0, 8)}...</span>
                    ${stockStatusBadge}
                  </div>
                </div>
              </td>
              <td data-label="Price"><strong>${(product.price || 0).toLocaleString()}</strong></td>
              <td data-label="SKU / Barcode">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  ${skuDisplay}
                  ${barcodeDisplay}
                </div>
              </td>
              <td data-label="Color / Size"><span class="color-size-badge">${product.color || '-'}  ${product.size || '-'}</span></td>
              <td data-label="Inventory"><span class="stock-badge ${(product.stock || 0) < 10 ? 'low-stock' : ''}">${product.stock || 0} units</span></td>
              <td data-label="Actions" class="actions">
                <button type="button" data-action="edit" data-id="${product.id}" aria-label="Edit" title="Edit product">
                  <i class="ri-pencil-line"></i>
                </button>
                <button type="button" data-action="delete" data-id="${product.id}" aria-label="Delete" title="Delete product">
                  <i class="ri-delete-bin-6-line"></i>
                </button>
              </td>
            </tr>
          `;
          })
          .join('');
        
        // Check and display low stock notification
        checkAndDisplayLowStockNotification();
      }

      // Override renderProducts to use filtered version when filters are active
      (function() {
        const originalRenderProducts = typeof renderProducts !== 'undefined' ? renderProducts : null;
        if (originalRenderProducts) {
          window.renderProducts = function() {
            if (productFilters.search || productFilters.category) {
              renderFilteredProductsList();
            } else {
              originalRenderProducts();
            }
          };
        }
      })();

      // ===============================
      // TRAFFIC ANALYTICS FUNCTIONS
      // ===============================

      let trafficData = null;
      let currentTrafficPeriod = 7;

      async function initializeTrafficAnalytics() {
        await loadTrafficData();
        setupTrafficEventListeners();
        startRealtimeUpdates();
      }

      async function loadTrafficData(days = 7) {
        try {
          currentTrafficPeriod = days;
          const response = await fetch(`/api/analytics/stats?days=${days}`, {
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            trafficData = data.stats;
            renderTrafficStats();
            renderTrafficChart();
            renderTrafficDetails();
          }
        } catch (error) {
          console.error('Failed to load traffic data:', error);
        }
      }

      async function loadRealtimeData() {
        try {
          const response = await fetch('/api/analytics/realtime', {
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            document.getElementById('realtimeVisitors').textContent = data.realtime.activeNow || 0;
          }
        } catch (error) {
          console.debug('Realtime update failed');
        }
      }

      function renderTrafficStats() {
        if (!trafficData) return;

        // Today's visits
        const todayVisits = trafficData.today?.visits || 0;
        document.getElementById('todayVisits').textContent = compactFormatNumber(todayVisits);
        
        // Calculate change from yesterday
        const yesterdayVisits = trafficData.yesterday?.visits || 1;
        const change = ((todayVisits - yesterdayVisits) / yesterdayVisits * 100).toFixed(0);
        const changeEl = document.getElementById('todayChange');
        if (change >= 0) {
          changeEl.innerHTML = `<i class="ri-arrow-up-line"></i> ${change}%`;
          changeEl.className = 'stat-change up';
        } else {
          changeEl.innerHTML = `<i class="ri-arrow-down-line"></i> ${Math.abs(change)}%`;
          changeEl.className = 'stat-change down';
        }

        // Total visits
        document.getElementById('totalVisits').textContent = compactFormatNumber(trafficData.totalVisits || 0);
        
        // Unique visitors
        document.getElementById('uniqueVisitors').textContent = compactFormatNumber(trafficData.uniqueVisitors || 0);
        
        // Average visits per day
        document.getElementById('avgVisits').textContent = compactFormatNumber(trafficData.avgVisitsPerDay || 0);
      }

      function renderTrafficChart() {
        if (!trafficData || !trafficData.dailyVisits) return;

        const chartContainer = document.getElementById('trafficChart');
        const labelsContainer = document.getElementById('chartLabels');
        
        const visits = trafficData.dailyVisits;
        const maxVisits = Math.max(...visits.map(d => d.visits), 1);
        
        // Render bars
        chartContainer.innerHTML = visits.map(day => {
          const height = (day.visits / maxVisits) * 100;
          return `<div class="chart-bar" style="height: ${Math.max(height, 2)}%" data-visits="${day.visits} visits" title="${day.date}: ${day.visits} visits"></div>`;
        }).join('');
        
        // Render labels (show first, middle, last)
        const labels = [];
        if (visits.length > 0) {
          labels.push(formatDateShort(visits[0].date));
          if (visits.length > 2) {
            const midIndex = Math.floor(visits.length / 2);
            labels.push(formatDateShort(visits[midIndex].date));
          }
          if (visits.length > 1) {
            labels.push(formatDateShort(visits[visits.length - 1].date));
          }
        }
        labelsContainer.innerHTML = labels.map(l => `<span>${l}</span>`).join('');
      }

      function renderTrafficDetails() {
        if (!trafficData) return;

        // Top Pages
        const topPagesList = document.getElementById('topPagesList');
        const topPages = trafficData.topPages || [];
        const maxPageViews = Math.max(...topPages.map(p => p.views), 1);
        
        topPagesList.innerHTML = topPages.length > 0 ? topPages.slice(0, 5).map(page => `
          <div class="detail-item">
            <span class="label">${page.page === '/' ? 'Home' : page.page.replace(/\.html$/, '').replace(/^\//, '')}</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(page.views / maxPageViews) * 100}%"></div>
            </div>
            <span class="value">${compactFormatNumber(page.views)}</span>
          </div>
        `).join('') : '<div class="detail-item"><span class="label">No data yet</span></div>';

        // Devices
        const devicesList = document.getElementById('devicesList');
        const devices = trafficData.devices || { desktop: 0, mobile: 0, tablet: 0 };
        const totalDevices = devices.desktop + devices.mobile + devices.tablet || 1;
        
        devicesList.innerHTML = `
          <div class="detail-item">
            <span class="label"><i class="ri-computer-line"></i> Desktop</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(devices.desktop / totalDevices) * 100}%"></div>
            </div>
            <span class="value">${Math.round((devices.desktop / totalDevices) * 100)}%</span>
          </div>
          <div class="detail-item">
            <span class="label"><i class="ri-smartphone-line"></i> Mobile</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(devices.mobile / totalDevices) * 100}%"></div>
            </div>
            <span class="value">${Math.round((devices.mobile / totalDevices) * 100)}%</span>
          </div>
          <div class="detail-item">
            <span class="label"><i class="ri-tablet-line"></i> Tablet</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(devices.tablet / totalDevices) * 100}%"></div>
            </div>
            <span class="value">${Math.round((devices.tablet / totalDevices) * 100)}%</span>
          </div>
        `;

        // Browsers
        const browsersList = document.getElementById('browsersList');
        const browsers = Object.entries(trafficData.browsers || {}).sort((a, b) => b[1] - a[1]).slice(0, 4);
        const totalBrowsers = browsers.reduce((sum, [_, count]) => sum + count, 0) || 1;
        
        browsersList.innerHTML = browsers.length > 0 ? browsers.map(([browser, count]) => `
          <div class="detail-item">
            <span class="label">${browser}</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(count / totalBrowsers) * 100}%"></div>
            </div>
            <span class="value">${Math.round((count / totalBrowsers) * 100)}%</span>
          </div>
        `).join('') : '<div class="detail-item"><span class="label">No data yet</span></div>';

        // Referrers
        const referrersList = document.getElementById('referrersList');
        const referrers = Object.entries(trafficData.referrers || {}).sort((a, b) => b[1] - a[1]).slice(0, 4);
        const totalReferrers = referrers.reduce((sum, [_, count]) => sum + count, 0) || 1;
        
        referrersList.innerHTML = referrers.length > 0 ? referrers.map(([source, count]) => `
          <div class="detail-item">
            <span class="label">${source}</span>
            <div class="bar-wrapper">
              <div class="bar-fill" style="width: ${(count / totalReferrers) * 100}%"></div>
            </div>
            <span class="value">${compactFormatNumber(count)}</span>
          </div>
        `).join('') : '<div class="detail-item"><span class="label">No data yet</span></div>';
      }

      function setupTrafficEventListeners() {
        // Refresh button
        const refreshBtn = document.getElementById('refreshTrafficBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            loadTrafficData(currentTrafficPeriod);
            showNotification('Traffic data refreshed', 'info');
          });
        }

        // Period selector buttons
        const periodButtons = document.querySelectorAll('.chart-period-selector button');
        periodButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            periodButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadTrafficData(parseInt(btn.dataset.days));
          });
        });
      }

      function startRealtimeUpdates() {
        // Update realtime visitors every 30 seconds
        loadRealtimeData();
        setInterval(loadRealtimeData, 30000);
      }

      function compactFormatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      function formatDateShort(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      // ===============================
      // PRODUCT COST PROFILES FUNCTIONS
      // ===============================

      let productCostProfiles = [];
      let allProductsForCostProfile = []; // Store products from Product Management
      let defaultProductCosts = {
        productCost: 0,
        exportPrice: 0,
        packagingCost: 0,
        thankYouCardCost: 0,
        roundStickerCost: 0,
        parcelEnvelopeCost: 0,
        billPrintingCost: 0,
        miscCost: 0,
        shippingCharges: 0
      };
      let editingProfileId = null;

      // Load products for the dropdown
      async function loadProductsForCostProfile() {
        try {
          const response = await apiRequest('/products');
          if (response.success && response.products) {
            allProductsForCostProfile = response.products;
            populateProductDropdown();
          }
        } catch (error) {
          console.log('Could not load products for cost profile dropdown');
        }
      }

      // Populate the product dropdown
      function populateProductDropdown() {
        const select = document.getElementById('profileProductSelect');
        if (!select) return;
        
        // Clear existing options except the first one
        select.innerHTML = '<option value="">-- Select a product --</option>';
        
        // Add products sorted by name
        const sortedProducts = [...allProductsForCostProfile].sort((a, b) => 
          (a.name || '').localeCompare(b.name || '')
        );
        
        sortedProducts.forEach(product => {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = `${product.name} - ${product.price || 0}`;
          option.dataset.name = product.name;
          option.dataset.price = product.price || 0;
          select.appendChild(option);
        });
      }

      // Handle product selection from dropdown
      function onProductSelect(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (selectedOption.value) {
          document.getElementById('profileProductName').value = selectedOption.dataset.name || '';
          document.getElementById('profileSellingPrice').value = selectedOption.dataset.price || 0;
          document.getElementById('profileProductId').value = selectedOption.value;
          updateLivePreview();
        }
      }

      // Load all product cost profiles
      async function loadProductCostProfiles() {
        try {
          const response = await apiRequest('/settings/product-cost-profiles');
          if (response.success) {
            productCostProfiles = response.profiles || [];
            defaultProductCosts = response.defaultCosts || defaultProductCosts;
            renderProductCostProfilesTable();
            updateCostProfileStats();
            populateDefaultCostsForm();
          }
        } catch (error) {
          console.log('Product cost profiles not loaded yet, using defaults');
        }
      }

      // Render the profiles table
      function renderProductCostProfilesTable() {
        const tbody = document.getElementById('productCostProfilesBody');
        if (!tbody) return;

        if (productCostProfiles.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                <i class="ri-inbox-line" style="font-size: 2rem; display: block; margin-bottom: 8px;"></i>
                No product cost profiles found. Click "Add Product" to create one.
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = productCostProfiles.map(profile => {
          const profitClass = profile.profitPerUnit >= 0 ? 'profit-positive' : 'profit-negative';
          const marginClass = parseFloat(profile.profitMargin) >= 20 ? 'profit-positive' : 
                              (parseFloat(profile.profitMargin) >= 0 ? '' : 'profit-negative');
          return `
            <tr data-profile-id="${profile.id}">
              <td data-label="Product">
                <strong>${escapeHtml(profile.productName)}</strong>
              </td>
              <td data-label="Selling Price">${profile.sellingPrice.toLocaleString()}</td>
              <td data-label="Total Cost">${profile.totalCost.toLocaleString()}</td>
              <td data-label="Profit/Unit" class="${profitClass}">${profile.profitPerUnit.toLocaleString()}</td>
              <td data-label="Margin %" class="${marginClass}">${profile.profitMargin}%</td>
              <td data-label="Actions">
                <div class="action-btns">
                  <button class="edit-btn" onclick="editProductCostProfile('${profile.id}')" title="Edit">
                    <i class="ri-edit-line"></i> Edit
                  </button>
                  <button class="delete-btn" onclick="deleteProductCostProfile('${profile.id}')" title="Delete">
                    <i class="ri-delete-bin-line"></i> Delete
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Update statistics
      function updateCostProfileStats() {
        const totalProfiles = productCostProfiles.length;
        const avgCost = totalProfiles > 0 
          ? productCostProfiles.reduce((sum, p) => sum + p.totalCost, 0) / totalProfiles 
          : 0;
        const avgMargin = totalProfiles > 0 
          ? productCostProfiles.reduce((sum, p) => sum + parseFloat(p.profitMargin), 0) / totalProfiles 
          : 0;

        document.getElementById('statsTotalProfiles').textContent = totalProfiles;
        document.getElementById('statsAvgCost').textContent = '' + Math.round(avgCost).toLocaleString();
        document.getElementById('statsAvgMargin').textContent = avgMargin.toFixed(1) + '%';

        if (totalProfiles > 0) {
          const sorted = [...productCostProfiles].sort((a, b) => parseFloat(b.profitMargin) - parseFloat(a.profitMargin));
          document.getElementById('statsHighestMargin').textContent = 
            `${sorted[0].productName.substring(0, 15)}... (${sorted[0].profitMargin}%)`;
          document.getElementById('statsLowestMargin').textContent = 
            `${sorted[sorted.length - 1].productName.substring(0, 15)}... (${sorted[sorted.length - 1].profitMargin}%)`;
        } else {
          document.getElementById('statsHighestMargin').textContent = '-';
          document.getElementById('statsLowestMargin').textContent = '-';
        }
      }

      // Populate default costs form
      function populateDefaultCostsForm() {
        document.getElementById('defaultProductCost').value = defaultProductCosts.productCost || 0;
        document.getElementById('defaultExportPrice').value = defaultProductCosts.exportPrice || 0;
        document.getElementById('defaultPackagingCost').value = defaultProductCosts.packagingCost || 0;
        document.getElementById('defaultThankYouCardCost').value = defaultProductCosts.thankYouCardCost || 0;
        document.getElementById('defaultRoundStickerCost').value = defaultProductCosts.roundStickerCost || 0;
        document.getElementById('defaultParcelEnvelopeCost').value = defaultProductCosts.parcelEnvelopeCost || 0;
        document.getElementById('defaultBillPrintingCost').value = defaultProductCosts.billPrintingCost || 0;
        document.getElementById('defaultShippingCharges').value = defaultProductCosts.shippingCharges || 0;
        document.getElementById('defaultMiscCost').value = defaultProductCosts.miscCost || 0;
      }

      // Open modal for adding new profile
      async function openAddProductCostProfileModal() {
        editingProfileId = null;
        document.getElementById('productCostProfileModalTitle').textContent = 'Add Product Cost Profile';
        document.querySelector('#productCostProfileModal .pcp-modal-title i').className = 'ri-add-line';
        document.getElementById('saveProfileBtn').innerHTML = '<i class="ri-save-line"></i> <span>Save Profile</span>';
        document.getElementById('productCostProfileForm').reset();
        document.getElementById('profileId').value = '';
        document.getElementById('profileProductId').value = '';
        
        // Reset all cost fields to 0
        document.getElementById('profileProductCost').value = 0;
        document.getElementById('profileExportPrice').value = 0;
        document.getElementById('profilePackagingCost').value = 0;
        document.getElementById('profileThankYouCardCost').value = 0;
        document.getElementById('profileRoundStickerCost').value = 0;
        document.getElementById('profileParcelEnvelopeCost').value = 0;
        document.getElementById('profileBillPrintingCost').value = 0;
        document.getElementById('profileMiscCost').value = 0;
        document.getElementById('profileShippingCharges').value = 0;
        
        // Load products for dropdown
        await loadProductsForCostProfile();
        
        updateLivePreview();
        document.getElementById('productCostProfileModal').style.display = 'flex';
      }

      // Close modal
      function closeProductCostProfileModal() {
        document.getElementById('productCostProfileModal').style.display = 'none';
        editingProfileId = null;
      }

      // Edit existing profile
      async function editProductCostProfile(profileId) {
        const profile = productCostProfiles.find(p => p.id === profileId);
        if (!profile) {
          showNotification('Profile not found', 'error');
          return;
        }

        editingProfileId = profileId;
        document.getElementById('productCostProfileModalTitle').textContent = 'Edit Product Cost Profile';
        document.querySelector('#productCostProfileModal .pcp-modal-title i').className = 'ri-edit-line';
        document.getElementById('saveProfileBtn').innerHTML = '<i class="ri-save-line"></i> <span>Update Profile</span>';
        document.getElementById('profileId').value = profileId;
        document.getElementById('profileProductId').value = profile.productId || '';
        
        // Load products for dropdown
        await loadProductsForCostProfile();
        
        // Try to select the matching product in dropdown
        const select = document.getElementById('profileProductSelect');
        if (select && profile.productId) {
          select.value = profile.productId;
        } else {
          select.value = '';
        }
        
        // Populate form
        document.getElementById('profileProductName').value = profile.productName || '';
        document.getElementById('profileSellingPrice').value = profile.sellingPrice || 0;
        document.getElementById('profileProductCost').value = profile.productCost || 0;
        document.getElementById('profileExportPrice').value = profile.exportPrice || 0;
        document.getElementById('profilePackagingCost').value = profile.packagingCost || 0;
        document.getElementById('profileThankYouCardCost').value = profile.thankYouCardCost || 0;
        document.getElementById('profileRoundStickerCost').value = profile.roundStickerCost || 0;
        document.getElementById('profileParcelEnvelopeCost').value = profile.parcelEnvelopeCost || 0;
        document.getElementById('profileBillPrintingCost').value = profile.billPrintingCost || 0;
        document.getElementById('profileMiscCost').value = profile.miscCost || 0;
        document.getElementById('profileShippingCharges').value = profile.shippingCharges || 0;

        updateLivePreview();
        document.getElementById('productCostProfileModal').style.display = 'flex';
      }

      // Delete profile
      async function deleteProductCostProfile(profileId) {
        const profile = productCostProfiles.find(p => p.id === profileId);
        if (!profile) {
          showNotification('Profile not found', 'error');
          return;
        }

        const confirmed = await showConfirmModal({
          title: 'Delete Cost Profile',
          message: `Are you sure you want to delete the cost profile for "<strong>${escapeHtml(profile.productName)}</strong>"? This action cannot be undone.`,
          confirmText: 'Yes, Delete',
          cancelText: 'Cancel',
          type: 'danger'
        });

        if (!confirmed) return;

        try {
          showNotification('Deleting profile...', 'info');
          const response = await apiRequest(`/settings/product-cost-profiles/${profileId}`, {
            method: 'DELETE'
          });

          if (response.success) {
            showNotification('Cost profile deleted successfully!', 'success');
            await loadProductCostProfiles();
          } else {
            showNotification(response.error || 'Failed to delete profile', 'error');
          }
        } catch (error) {
          console.error('Failed to delete profile:', error);
          showNotification('Failed to delete profile. Please try again.', 'error');
        }
      }

      // Save or update profile
      async function saveProductCostProfile(e) {
        e.preventDefault();

        const profileData = {
          productName: document.getElementById('profileProductName').value.trim(),
          productId: document.getElementById('profileProductId').value || null,
          sellingPrice: parseFloat(document.getElementById('profileSellingPrice').value) || 0,
          productCost: parseFloat(document.getElementById('profileProductCost').value) || 0,
          exportPrice: parseFloat(document.getElementById('profileExportPrice').value) || 0,
          packagingCost: parseFloat(document.getElementById('profilePackagingCost').value) || 0,
          thankYouCardCost: parseFloat(document.getElementById('profileThankYouCardCost').value) || 0,
          roundStickerCost: parseFloat(document.getElementById('profileRoundStickerCost').value) || 0,
          parcelEnvelopeCost: parseFloat(document.getElementById('profileParcelEnvelopeCost').value) || 0,
          billPrintingCost: parseFloat(document.getElementById('profileBillPrintingCost').value) || 0,
          miscCost: parseFloat(document.getElementById('profileMiscCost').value) || 0,
          shippingCharges: parseFloat(document.getElementById('profileShippingCharges').value) || 0
        };

        if (!profileData.productName) {
          showNotification('Product name is required', 'error');
          return;
        }

        if (profileData.sellingPrice <= 0) {
          showNotification('Please enter a valid selling price', 'warning');
          return;
        }

        try {
          showNotification(editingProfileId ? 'Updating profile...' : 'Creating profile...', 'info');
          let response;
          if (editingProfileId) {
            // Update existing profile
            response = await apiRequest(`/settings/product-cost-profiles/${editingProfileId}`, {
              method: 'PUT',
              body: JSON.stringify(profileData)
            });
          } else {
            // Create new profile
            response = await apiRequest('/settings/product-cost-profiles', {
              method: 'POST',
              body: JSON.stringify(profileData)
            });
          }

          if (response.success) {
            showNotification(editingProfileId ? 'Profile updated successfully!' : 'Profile created successfully!', 'success');
            closeProductCostProfileModal();
            await loadProductCostProfiles();
            // Reload sales data to update profit/loss calculations
            if (typeof loadSalesData === 'function') {
              await loadSalesData();
            }
          } else {
            showNotification(response.error || 'Failed to save profile', 'error');
          }
        } catch (error) {
          console.error('Failed to save profile:', error);
          showNotification('Failed to save profile', 'error');
        }
      }

      // Save default costs
      async function saveDefaultCosts() {
        const defaultData = {
          productCost: parseFloat(document.getElementById('defaultProductCost').value) || 0,
          exportPrice: parseFloat(document.getElementById('defaultExportPrice').value) || 0,
          packagingCost: parseFloat(document.getElementById('defaultPackagingCost').value) || 0,
          thankYouCardCost: parseFloat(document.getElementById('defaultThankYouCardCost').value) || 0,
          roundStickerCost: parseFloat(document.getElementById('defaultRoundStickerCost').value) || 0,
          parcelEnvelopeCost: parseFloat(document.getElementById('defaultParcelEnvelopeCost').value) || 0,
          billPrintingCost: parseFloat(document.getElementById('defaultBillPrintingCost').value) || 0,
          shippingCharges: parseFloat(document.getElementById('defaultShippingCharges').value) || 0,
          miscCost: parseFloat(document.getElementById('defaultMiscCost').value) || 0
        };

        try {
          showNotification('Saving default costs...', 'info');
          const response = await apiRequest('/settings/product-cost-profiles/defaults', {
            method: 'PUT',
            body: JSON.stringify(defaultData)
          });

          if (response.success) {
            defaultProductCosts = response.defaultCosts;
            showNotification('Default costs saved successfully!', 'success');
          } else {
            showNotification(response.error || 'Failed to save default costs', 'error');
          }
        } catch (error) {
          console.error('Failed to save default costs:', error);
          showNotification('Failed to save default costs. Please try again.', 'error');
        }
      }

      // Live preview calculation
      function updateLivePreview() {
        const sellingPrice = parseFloat(document.getElementById('profileSellingPrice')?.value) || 0;
        const productCost = parseFloat(document.getElementById('profileProductCost')?.value) || 0;
        const exportPrice = parseFloat(document.getElementById('profileExportPrice')?.value) || 0;
        const packagingCost = parseFloat(document.getElementById('profilePackagingCost')?.value) || 0;
        const thankYouCardCost = parseFloat(document.getElementById('profileThankYouCardCost')?.value) || 0;
        const roundStickerCost = parseFloat(document.getElementById('profileRoundStickerCost')?.value) || 0;
        const parcelEnvelopeCost = parseFloat(document.getElementById('profileParcelEnvelopeCost')?.value) || 0;
        const billPrintingCost = parseFloat(document.getElementById('profileBillPrintingCost')?.value) || 0;
        const miscCost = parseFloat(document.getElementById('profileMiscCost')?.value) || 0;
        const shippingCharges = parseFloat(document.getElementById('profileShippingCharges')?.value) || 0;

        const totalCost = productCost + exportPrice + packagingCost + thankYouCardCost + 
                          roundStickerCost + parcelEnvelopeCost + billPrintingCost + 
                          miscCost + shippingCharges;
        const profit = sellingPrice - totalCost;
        const margin = sellingPrice > 0 ? ((profit / sellingPrice) * 100).toFixed(1) : 0;

        const totalCostEl = document.getElementById('livePreviewTotalCost');
        const profitEl = document.getElementById('livePreviewProfit');
        const marginEl = document.getElementById('livePreviewMargin');
        
        if (totalCostEl) totalCostEl.textContent = '' + totalCost.toFixed(2);
        if (profitEl) {
          profitEl.textContent = (profit >= 0 ? '' : '-') + Math.abs(profit).toFixed(2);
          profitEl.style.color = profit >= 0 ? '#4ade80' : '#f87171';
        }
        if (marginEl) {
          marginEl.textContent = margin + '%';
          marginEl.style.color = margin >= 20 ? '#4ade80' : (margin >= 0 ? '#60a5fa' : '#f87171');
        }
      }

      // Get cost for a specific product (used in profit/loss calculation)
      function getProductCost(productName) {
        if (!productName) return defaultProductCosts;
        
        // Try exact match
        let profile = productCostProfiles.find(p => 
          p.productName.toLowerCase() === productName.toLowerCase()
        );
        
        // Try partial match
        if (!profile) {
          profile = productCostProfiles.find(p => 
            productName.toLowerCase().includes(p.productName.toLowerCase()) ||
            p.productName.toLowerCase().includes(productName.toLowerCase())
          );
        }
        
        return profile || defaultProductCosts;
      }

      // Setup event listeners for product cost profiles
      function setupProductCostProfilesEventListeners() {
        // Add new profile button
        const addBtn = document.getElementById('addNewProductCostBtn');
        if (addBtn) {
          addBtn.addEventListener('click', openAddProductCostProfileModal);
        }

        // Refresh button
        const refreshBtn = document.getElementById('refreshProductCostsBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', async () => {
            await loadProductCostProfiles();
            showNotification('Product costs refreshed', 'info');
          });
        }

        // Save default costs button
        const saveDefaultBtn = document.getElementById('saveDefaultCostsBtn');
        if (saveDefaultBtn) {
          saveDefaultBtn.addEventListener('click', saveDefaultCosts);
        }

        // Form submission
        const form = document.getElementById('productCostProfileForm');
        if (form) {
          form.addEventListener('submit', saveProductCostProfile);
        }

        // Live preview on input change
        const formInputs = document.querySelectorAll('#productCostProfileForm input[type="number"]');
        formInputs.forEach(input => {
          input.addEventListener('input', updateLivePreview);
        });

        // Close modal on outside click
        const modal = document.getElementById('productCostProfileModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeProductCostProfileModal();
            }
          });
        }
      }

      // ===============================
      // SALES INSIGHTS FUNCTIONS
      // ===============================

      let salesData = {
        orders: [],
        returns: [],
        currentPeriod: 7
      };

      async function initializeSalesInsights() {
        await loadSalesData();
        setupSalesEventListeners();
      }

      async function loadSalesData() {
        try {
          // Fetch orders and returns data
          const [ordersResponse, returnsResponse] = await Promise.all([
            apiRequest('/orders'),
            apiRequest('/returns')
          ]);
          
          salesData.orders = ordersResponse.orders || [];
          salesData.returns = returnsResponse.returns || [];
          
          renderSalesInsights();
        } catch (error) {
          console.error('Failed to load sales data:', error);
          showNotification('Failed to load sales insights', 'error');
        }
      }

      function renderSalesInsights() {
        const orders = salesData.orders;
        const returns = salesData.returns;
        
        // Calculate date ranges
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        const monthAgo = new Date(today);
        monthAgo.setDate(monthAgo.getDate() - 30);
        const prevMonthStart = new Date(monthAgo);
        prevMonthStart.setDate(prevMonthStart.getDate() - 30);
        
        // Calculate totals
        const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
        const totalOrders = orders.length;
        const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
        
        // Today's sales
        const todayOrders = orders.filter(o => new Date(o.createdAt) >= today);
        const todaySales = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        
        // This week's sales
        const weekOrders = orders.filter(o => new Date(o.createdAt) >= weekAgo);
        const weekSales = weekOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        
        // This month's sales
        const monthOrders = orders.filter(o => new Date(o.createdAt) >= monthAgo);
        const monthSales = monthOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        
        // Previous month for comparison
        const prevMonthOrders = orders.filter(o => {
          const d = new Date(o.createdAt);
          return d >= prevMonthStart && d < monthAgo;
        });
        const prevMonthSales = prevMonthOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        
        // Revenue change percentage
        const revenueChangePercent = prevMonthSales > 0 
          ? (((monthSales - prevMonthSales) / prevMonthSales) * 100).toFixed(1) 
          : 0;
        
        // Update stat cards
        document.getElementById('totalRevenue').textContent = '' + totalRevenue.toLocaleString();
        document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
        document.getElementById('avgOrderValue').textContent = '' + Math.round(avgOrderValue).toLocaleString();
        document.getElementById('todaySales').textContent = '' + todaySales.toLocaleString();
        document.getElementById('weekSales').textContent = '' + weekSales.toLocaleString();
        document.getElementById('monthSales').textContent = '' + monthSales.toLocaleString();
        
        // Revenue change indicator
        const revenueChangeEl = document.getElementById('revenueChange');
        if (revenueChangeEl) {
          const isUp = revenueChangePercent >= 0;
          revenueChangeEl.innerHTML = `<i class="ri-arrow-${isUp ? 'up' : 'down'}-line"></i> ${Math.abs(revenueChangePercent)}%`;
          revenueChangeEl.className = `stat-change ${isUp ? 'up' : 'down'}`;
        }
        
        // Order status breakdown
        const statusCounts = {
          'Pending': 0,
          'Confirmed': 0,
          'Shipped': 0,
          'Delivered': 0,
          'Cancelled': 0
        };
        orders.forEach(o => {
          const status = o.status || 'Pending';
          if (statusCounts.hasOwnProperty(status)) {
            statusCounts[status]++;
          }
        });
        document.getElementById('pendingOrders').textContent = statusCounts['Pending'];
        document.getElementById('confirmedOrders').textContent = statusCounts['Confirmed'];
        document.getElementById('shippedOrders').textContent = statusCounts['Shipped'];
        document.getElementById('deliveredOrders').textContent = statusCounts['Delivered'];
        document.getElementById('cancelledOrders').textContent = statusCounts['Cancelled'];
        
        // Payment summary
        const paidOrders = orders.filter(o => o.paymentStatus === 'paid' || o.paymentStatus === 'Paid').length;
        const unpaidOrders = orders.length - paidOrders;
        const upiOrders = orders.filter(o => o.paymentMethod === 'upi').length;
        const codOrders = orders.filter(o => o.paymentMethod === 'cod').length;
        
        document.getElementById('paidOrders').textContent = paidOrders;
        document.getElementById('unpaidOrders').textContent = unpaidOrders;
        document.getElementById('upiOrders').textContent = upiOrders;
        document.getElementById('codOrders').textContent = codOrders;
        
        // Revenue breakdown
        const totalSubtotal = orders.reduce((sum, o) => sum + (o.subtotal || 0), 0);
        const totalShipping = orders.reduce((sum, o) => sum + (o.shipping || 0), 0);
        const totalReturnsValue = returns.reduce((sum, r) => {
          return sum + (r.items?.reduce((s, i) => s + ((i.price || 0) * (i.quantity || 1)), 0) || 0);
        }, 0);
        const netRevenue = totalRevenue - totalReturnsValue;
        
        document.getElementById('totalSubtotal').textContent = '' + totalSubtotal.toLocaleString();
        document.getElementById('totalShipping').textContent = '' + totalShipping.toLocaleString();
        document.getElementById('totalReturns').textContent = '-' + totalReturnsValue.toLocaleString();
        document.getElementById('netRevenue').textContent = '' + netRevenue.toLocaleString();
        
        // ===============================
        // PROFIT / LOSS CALCULATION
        // ===============================
        // Count total items sold and calculate per-product costs
        let totalItemsSold = 0;
        let estimatedCostOfGoods = 0;
        let operationalCosts = 0;
        let costCalculationMode = 'profiles'; // 'profiles' or 'default'
        let profilesUsed = 0;

        orders.forEach(order => {
          if (!order.items || !Array.isArray(order.items)) return;
          
          order.items.forEach(item => {
            const quantity = item.quantity || 1;
            totalItemsSold += quantity;
            
            // Get the cost profile for this product
            const productName = item.name || item.productName || '';
            const costProfile = getProductCost(productName);
            
            if (costProfile && costProfile.id) {
              // Using a specific product cost profile
              profilesUsed++;
              const productCost = (costProfile.productCost || 0) +
                                  (costProfile.exportPrice || 0) +
                                  (costProfile.packagingCost || 0) +
                                  (costProfile.thankYouCardCost || 0) +
                                  (costProfile.roundStickerCost || 0) +
                                  (costProfile.parcelEnvelopeCost || 0) +
                                  (costProfile.billPrintingCost || 0) +
                                  (costProfile.miscCost || 0);
              
              estimatedCostOfGoods += productCost * quantity;
              operationalCosts += (costProfile.shippingCharges || 0) * quantity;
            } else {
              // Using default costs
              const defaultCost = (defaultProductCosts.productCost || 0) +
                                  (defaultProductCosts.exportPrice || 0) +
                                  (defaultProductCosts.packagingCost || 0) +
                                  (defaultProductCosts.thankYouCardCost || 0) +
                                  (defaultProductCosts.roundStickerCost || 0) +
                                  (defaultProductCosts.parcelEnvelopeCost || 0) +
                                  (defaultProductCosts.billPrintingCost || 0) +
                                  (defaultProductCosts.miscCost || 0);
              
              estimatedCostOfGoods += defaultCost * quantity;
              operationalCosts += (defaultProductCosts.shippingCharges || 0) * quantity;
            }
          });
        });

        // Determine cost mode indicator
        if (productCostProfiles.length > 0 && profilesUsed > 0) {
          costCalculationMode = 'profiles';
        } else if (totalItemsSold > 0) {
          costCalculationMode = 'default';
        }
        
        estimatedCostOfGoods = Math.round(estimatedCostOfGoods);
        operationalCosts = Math.round(operationalCosts);
        
        // Calculate gross profit
        const grossProfit = totalRevenue - estimatedCostOfGoods - operationalCosts - totalReturnsValue;
        const profitMargin = totalRevenue > 0 
          ? ((grossProfit / totalRevenue) * 100).toFixed(1)
          : 0;
        
        // Update Profit/Loss card
        const plTotalRevenueEl = document.getElementById('plTotalRevenue');
        const plCostOfGoodsEl = document.getElementById('plCostOfGoods');
        const plOperationalCostsEl = document.getElementById('plOperationalCosts');
        const plRefundsEl = document.getElementById('plRefunds');
        const plGrossProfitEl = document.getElementById('plGrossProfit');
        const plProfitMarginEl = document.getElementById('plProfitMargin');
        const plItemsSoldEl = document.getElementById('plItemsSold');
        const plCostModeEl = document.getElementById('plCostMode');
        
        if (plTotalRevenueEl) plTotalRevenueEl.textContent = '' + totalRevenue.toLocaleString();
        if (plCostOfGoodsEl) plCostOfGoodsEl.textContent = '-' + estimatedCostOfGoods.toLocaleString();
        if (plOperationalCostsEl) plOperationalCostsEl.textContent = '-' + operationalCosts.toLocaleString();
        if (plRefundsEl) plRefundsEl.textContent = '-' + totalReturnsValue.toLocaleString();
        if (plItemsSoldEl) plItemsSoldEl.textContent = totalItemsSold.toLocaleString();
        
        // Update cost mode indicator
        if (plCostModeEl) {
          if (costCalculationMode === 'profiles') {
            plCostModeEl.textContent = `${profilesUsed} Profiles`;
            plCostModeEl.style.background = '#dcfce7';
            plCostModeEl.style.color = '#16a34a';
          } else {
            plCostModeEl.textContent = 'Default';
            plCostModeEl.style.background = '#fef3c7';
            plCostModeEl.style.color = '#d97706';
          }
        }
        
        if (plGrossProfitEl) {
          const isProfit = grossProfit >= 0;
          plGrossProfitEl.textContent = (isProfit ? '' : '-') + Math.abs(grossProfit).toLocaleString();
          plGrossProfitEl.className = `value ${isProfit ? 'success' : 'danger'}`;
          plGrossProfitEl.style.fontSize = '1.1rem';
        }
        
        if (plProfitMarginEl) {
          const isPositiveMargin = profitMargin >= 0;
          plProfitMarginEl.textContent = profitMargin + '%';
          plProfitMarginEl.className = `value ${isPositiveMargin ? 'success' : 'danger'}`;
        }
        
        // Render charts and top products
        renderSalesChart(salesData.currentPeriod);
        renderTopProducts();
        renderTopLocations();
      }

      function renderSalesChart(days = 7) {
        salesData.currentPeriod = days;
        const orders = salesData.orders;
        const chartContainer = document.getElementById('salesBarChart');
        const labelsContainer = document.getElementById('salesChartLabels');
        
        if (!chartContainer || !labelsContainer) return;
        
        // Generate daily data for the period
        const dailyData = [];
        const now = new Date();
        
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(now);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          
          const dayOrders = orders.filter(o => {
            const orderDate = new Date(o.createdAt).toISOString().split('T')[0];
            return orderDate === dateStr;
          });
          
          const dayRevenue = dayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
          
          dailyData.push({
            date: date,
            revenue: dayRevenue,
            orders: dayOrders.length
          });
        }
        
        // Find max revenue for scaling
        const maxRevenue = Math.max(...dailyData.map(d => d.revenue), 1);
        
        // Render bars
        chartContainer.innerHTML = dailyData.map((d, i) => {
          const height = (d.revenue / maxRevenue) * 100;
          return `
            <div class="sales-bar-wrapper">
              <div class="sales-bar" style="height: ${Math.max(height, 2)}%" data-value="${d.revenue.toLocaleString()}"></div>
              <span class="sales-bar-label">${d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
            </div>
          `;
        }).join('');
      }

      function renderTopProducts() {
        const container = document.getElementById('topProductsList');
        if (!container) return;
        
        // Aggregate product sales
        const productSales = {};
        salesData.orders.forEach(order => {
          order.items?.forEach(item => {
            const name = item.name || 'Unknown Product';
            if (!productSales[name]) {
              productSales[name] = { name, quantity: 0, revenue: 0 };
            }
            productSales[name].quantity += (item.quantity || 1);
            productSales[name].revenue += (item.price || 0) * (item.quantity || 1);
          });
        });
        
        // Sort by revenue and get top 5
        const topProducts = Object.values(productSales)
          .sort((a, b) => b.revenue - a.revenue)
          .slice(0, 5);
        
        if (topProducts.length === 0) {
          container.innerHTML = '<div class="summary-item"><span class="label">No product sales yet</span></div>';
          return;
        }
        
        container.innerHTML = topProducts.map((product, i) => {
          const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'default';
          return `
            <div class="top-product-item">
              <div class="top-product-rank ${rankClass}">${i + 1}</div>
              <div class="top-product-info">
                <div class="top-product-name">${product.name}</div>
                <div class="top-product-stats">
                  <span><i class="ri-shopping-cart-2-line"></i> ${product.quantity} sold</span>
                </div>
              </div>
              <div class="top-product-revenue">${product.revenue.toLocaleString()}</div>
            </div>
          `;
        }).join('');
      }

      function renderTopLocations() {
        const container = document.getElementById('topLocationsList');
        if (!container) return;
        
        // Aggregate by state
        const locationSales = {};
        salesData.orders.forEach(order => {
          const state = order.shippingInfo?.state || order.address?.state || 'Unknown';
          if (!locationSales[state]) {
            locationSales[state] = { state, orders: 0, revenue: 0 };
          }
          locationSales[state].orders++;
          locationSales[state].revenue += (order.total || 0);
        });
        
        // Sort by orders and get top 5
        const topLocations = Object.values(locationSales)
          .sort((a, b) => b.orders - a.orders)
          .slice(0, 5);
        
        if (topLocations.length === 0) {
          container.innerHTML = '<div class="summary-item"><span class="label">No location data yet</span></div>';
          return;
        }
        
        container.innerHTML = topLocations.map(loc => `
          <div class="summary-item">
            <span class="label"><i class="ri-map-pin-2-line"></i> ${loc.state}</span>
            <span class="value">${loc.orders} orders (${loc.revenue.toLocaleString()})</span>
          </div>
        `).join('');
      }

      function setupSalesEventListeners() {
        // Refresh button
        const refreshBtn = document.getElementById('refreshSalesBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            loadSalesData();
            showNotification('Sales data refreshed', 'info');
          });
        }
        
        // Export button
        const exportBtn = document.getElementById('exportSalesBtn');
        if (exportBtn) {
          exportBtn.addEventListener('click', exportSalesReport);
        }
        
        // Period selector buttons
        const periodSelector = document.getElementById('salesPeriodSelector');
        if (periodSelector) {
          periodSelector.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
              periodSelector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              renderSalesChart(parseInt(btn.dataset.days));
            });
          });
        }
      }

      function exportSalesReport() {
        const orders = salesData.orders;
        const returns = salesData.returns;
        
        // Calculate totals
        const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
        const totalOrders = orders.length;
        const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
        
        // Create CSV content
        let csvContent = 'Sales Report - Generated on ' + new Date().toLocaleString() + '\n\n';
        csvContent += 'SUMMARY\n';
        csvContent += 'Total Revenue,' + totalRevenue.toLocaleString() + '\n';
        csvContent += 'Total Orders,' + totalOrders + '\n';
        csvContent += 'Average Order Value,' + Math.round(avgOrderValue).toLocaleString() + '\n';
        csvContent += 'Total Returns,' + returns.length + '\n\n';
        
        csvContent += 'ORDER DETAILS\n';
        csvContent += 'Order ID,Date,Customer,Items,Subtotal,Shipping,Total,Status,Payment Method,Payment Status\n';
        orders.forEach(o => {
          const items = o.items?.map(i => i.name).join('; ') || '-';
          csvContent += `${o.id},${new Date(o.createdAt).toLocaleDateString()},${o.shippingInfo?.name || o.userName || '-'},"${items}",${o.subtotal || 0},${o.shipping || 0},${o.total || 0},${o.status || '-'},${o.paymentMethod || '-'},${o.paymentStatus || '-'}\n`;
        });
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `sales-report-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('Sales report exported successfully', 'success');
      }

      // ========================================
      // Mobile Responsive Handler for Admin Sections
      // Overrides inline grid styles on mobile devices
      // ========================================
      function initMobileResponsiveAdmin() {
        const MOBILE_BREAKPOINT = 768;
        
        function applyMobileStyles() {
          const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
          
          // Select all elements with inline grid styles that need override
          const gridElements = document.querySelectorAll(`
            [style*="grid-template-columns: repeat(auto-fit"],
            .product-costs-container,
            .default-costs-grid,
            .ai-engines-grid,
            .payment-ai-stats,
            #shippingSettingsForm,
            #taxSettingsForm,
            #invoiceSettingsForm,
            #giftCardForm,
            #company-tax [style*="display: grid"],
            .tax-summary-grid
          `);
          
          gridElements.forEach(el => {
            if (isMobile) {
              // Store original style if not already stored
              if (!el.dataset.originalGridStyle) {
                el.dataset.originalGridStyle = el.style.gridTemplateColumns || '';
              }
              // Apply mobile-friendly single column
              el.style.gridTemplateColumns = '1fr';
            } else {
              // Restore original style on desktop
              if (el.dataset.originalGridStyle) {
                el.style.gridTemplateColumns = el.dataset.originalGridStyle;
              }
            }
          });
          
          // Handle flex containers that need wrapping
          const flexElements = document.querySelectorAll(`
            #company-tax [style*="display: flex"],
            .section-header,
            .section-header-right
          `);
          
          flexElements.forEach(el => {
            if (isMobile) {
              el.style.flexWrap = 'wrap';
            }
          });
          
          // Fix section headers on mobile
          const sectionHeaders = document.querySelectorAll('.admin-section .section-header');
          sectionHeaders.forEach(header => {
            if (isMobile) {
              header.style.flexDirection = 'column';
              header.style.alignItems = 'stretch';
              header.style.gap = '12px';
            } else {
              header.style.flexDirection = '';
              header.style.alignItems = '';
              header.style.gap = '';
            }
          });
        }
        
        // Apply on load
        applyMobileStyles();
        
        // Apply on resize with debounce
        let resizeTimer;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(applyMobileStyles, 100);
        });
      }

      // Initialize product search when DOM loads
      document.addEventListener('DOMContentLoaded', () => {
        initializeProductSearch();
        initializeSearchAndFilters();
        initializeBulkActions();
        initializeExport();
        initializeTrafficAnalytics(); // Initialize traffic analytics
        initializeSalesInsights(); // Initialize sales insights
        setupPasswordResetListeners(); // Initialize password reset management
        
        // Initialize mobile responsive overrides
        initMobileResponsiveAdmin();
        
        // Initialize product cost profiles
        loadProductCostProfiles();
        setupProductCostProfilesEventListeners();

        // Attach save button handlers
        document.getElementById('saveOrderChangesBtn')?.addEventListener('click', saveAllOrderChanges);
        document.getElementById('saveReturnChangesBtn')?.addEventListener('click', saveAllReturnChanges);
        document.getElementById('saveExchangeChangesBtn')?.addEventListener('click', saveExchangeChanges);
        document.getElementById('saveCancellationChangesBtn')?.addEventListener('click', saveCancellationChanges);

        // Attach refresh button handlers for exchanges and cancellations
        document.getElementById('refreshExchangesBtn')?.addEventListener('click', () => {
          fetchExchanges();
          showNotification('Exchanges refreshed', 'info');
        });
        document.getElementById('refreshCancellationsBtn')?.addEventListener('click', () => {
          fetchCancellations();
          showNotification('Cancellations refreshed', 'info');
        });

        // Initialize user filters and search
        const userRoleFilter = document.getElementById('userRoleFilter');
        const userSortBy = document.getElementById('userSortBy');
        const userSearch = document.getElementById('userSearch');
        const clearUserSearch = document.getElementById('clearUserSearch');

        if (userRoleFilter) {
          userRoleFilter.addEventListener('change', renderUsers);
        }
        if (userSortBy) {
          userSortBy.addEventListener('change', renderUsers);
        }
        if (userSearch) {
          userSearch.addEventListener('input', debounce(() => {
            renderUsers();
          }, 300));
        }
        if (clearUserSearch) {
          clearUserSearch.addEventListener('click', () => {
            if (userSearch) userSearch.value = '';
            renderUsers();
          });
        }

        // Initialize returns search and filters
        initializeReturnsSearchAndFilters();

        // Initialize exchanges search and filters
        initializeExchangesSearchAndFilters();

        // Initialize cancellations search and filters
        initializeCancellationsSearchAndFilters();

        // Initialize messages management
        initializeMessagesManagement();

        // Initialize slider management
        loadSlides();

        // Attach slide form submit handler and refresh button (DOM ready)
        const slideForm = document.getElementById('slideForm');
        if (slideForm) {
          slideForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('slideId').value;
            const slideData = {
              type: document.getElementById('slideType').value,
              src: document.getElementById('slideSrc').value,
              title: document.getElementById('slideTitle').value,
              position: parseInt(document.getElementById('slidePosition').value) || 1,
              active: document.getElementById('slideActive').value === 'true'
            };

            try {
              if (id) {
                // Update existing slide
                await apiRequest(`/slides/${id}`, {
                  method: 'PUT',
                  body: JSON.stringify(slideData)
                });

                const idx = slidesData.findIndex(s => s.id === id);
                if (idx !== -1) {
                  slidesData[idx] = { ...slidesData[idx], ...slideData };
                }

                showNotification('Slide updated successfully', 'success');
              } else {
                // Create new slide
                const response = await apiRequest('/slides', {
                  method: 'POST',
                  body: JSON.stringify(slideData)
                });
                slidesData.push(response.slide);

                showNotification('Slide added successfully', 'success');
              }

              closeSlideModal();
              renderSlides();
            } catch (error) {
              console.error('Failed to save slide:', error);
              showNotification('Failed to save slide', 'error');
            }
          });
        }

        const refreshSlidesBtn = document.getElementById('refreshSlidesBtn');
        if (refreshSlidesBtn) refreshSlidesBtn.addEventListener('click', () => {
          loadSlides();
          showNotification('Slides refreshed', 'info');
        });
        
        // Slide modal cancel button
        const slideCancelBtn = document.getElementById('slideCancelBtn');
        if (slideCancelBtn) slideCancelBtn.addEventListener('click', closeSlideModal);
        
        // Slide modal close button (X)
        const slideModalCloseBtn = document.getElementById('slideModalCloseBtn');
        if (slideModalCloseBtn) slideModalCloseBtn.addEventListener('click', closeSlideModal);
        
        // Slide type dropdown - update preview on change
        const slideTypeSelect = document.getElementById('slideType');
        if (slideTypeSelect) slideTypeSelect.addEventListener('change', updateSlidePreview);
        
        // Slide file upload handler
        const slideFileInput = document.getElementById('slideFile');
        if (slideFileInput) slideFileInput.addEventListener('change', handleSlideFileUpload);
        
        // Slide source URL input - update preview on input
        const slideSrcInput = document.getElementById('slideSrc');
        if (slideSrcInput) slideSrcInput.addEventListener('input', updateSlidePreview);
        
        // Slide modal delete button
        const slideDeleteBtn = document.getElementById('slideDeleteBtn');
        if (slideDeleteBtn) {
          slideDeleteBtn.addEventListener('click', async function(e) {
            const slideId = this.dataset.id;
            if (slideId) {
              const confirmed = await showConfirmModal({
                title: 'Delete Slide',
                message: 'Are you sure you want to delete this slide? This action cannot be undone.',
                confirmText: 'Yes, Delete',
                cancelText: 'Cancel',
                type: 'danger',
                event: e
              });
              if (confirmed) {
                await deleteSlide(slideId, true); // skipConfirm = true since we already confirmed
                closeSlideModal();
              }
            }
          });
        }

        // Slide cards event delegation for edit, toggle, delete, and add actions
        const slideCardsContainer = document.getElementById('slideCards');
        if (slideCardsContainer) {
          slideCardsContainer.addEventListener('click', function(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.dataset.action;
            const slideId = target.dataset.slideId;
            
            switch(action) {
              case 'edit':
                editSlide(slideId);
                break;
              case 'toggle':
                const newState = target.dataset.newState === 'true';
                toggleSlide(slideId, newState);
                break;
              case 'delete':
                deleteSlide(slideId, false, e);
                break;
              case 'add-slide':
                openSlideModal();
                break;
            }
          });
        }

        // ===============================
        // SIDEBAR NAVIGATION - SECTION TOGGLE
        // ===============================
        initializeSidebarNavigation();
      });

      // New sidebar navigation with section show/hide (profile page style)
      function initializeSidebarNavigation() {
        const sidebar = document.getElementById('adminSidebar');
        const mobileFab = document.getElementById('mobileFab');
        const mobileFabBtn = document.getElementById('mobileFabBtn');
        const mobileQuickMenu = document.getElementById('mobileQuickMenu');
        const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
        
        if (!sidebar) {
          console.error('[Admin] Sidebar not found');
          return;
        }

        // Mobile floating menu toggle
        function toggleMobileMenu() {
          const isOpen = mobileQuickMenu?.classList.contains('open');
          const openIcon = mobileFabBtn?.querySelector('.fab-icon-open');
          const closeIcon = mobileFabBtn?.querySelector('.fab-icon-close');
          
          if (isOpen) {
            mobileQuickMenu?.classList.remove('open');
            mobileFabBtn?.classList.remove('active');
            mobileMenuOverlay?.classList.remove('active');
            if (openIcon) openIcon.style.display = 'block';
            if (closeIcon) closeIcon.style.display = 'none';
          } else {
            mobileQuickMenu?.classList.add('open');
            mobileFabBtn?.classList.add('active');
            mobileMenuOverlay?.classList.add('active');
            if (openIcon) openIcon.style.display = 'none';
            if (closeIcon) closeIcon.style.display = 'block';
          }
        }
        
        if (mobileFabBtn) {
          mobileFabBtn.addEventListener('click', toggleMobileMenu);
        }
        if (mobileMenuOverlay) {
          mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
        }

        // Get all sidebar links and sections
        const sidebarLinks = sidebar.querySelectorAll('a[data-section]');
        const mobileMenuItems = document.querySelectorAll('.mobile-menu-item[data-section]');
        const sections = document.querySelectorAll('.admin-section');
        const loadedSections = new Set(['dashboard']); // Dashboard is pre-loaded
        
        console.log('[Admin] Sidebar initialized with', sidebarLinks.length, 'menu items and', sections.length, 'sections');

        // Function to show a section
        function showSection(sectionName) {
          // Hide all sections
          sections.forEach(section => {
            section.classList.remove('active');
          });
          
          // Show target section
          const targetSection = document.getElementById(sectionName);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          
          // Update sidebar active state
          sidebarLinks.forEach(link => {
            link.classList.remove('active');
            if (link.dataset.section === sectionName) {
              link.classList.add('active');
            }
          });
          
          // Update mobile menu active state
          mobileMenuItems.forEach(item => {
            item.classList.remove('active');
            if (item.dataset.section === sectionName) {
              item.classList.add('active');
            }
          });
          
          // Scroll to top of content area
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          // Load section-specific data if not already loaded
          if (!loadedSections.has(sectionName)) {
            loadedSections.add(sectionName);
            loadSectionData(sectionName);
          }
          
          // Close mobile menu if open
          if (mobileQuickMenu?.classList.contains('open')) {
            toggleMobileMenu();
          }
        }
        
        // Function to load data for specific sections
        function loadSectionData(sectionId) {
          switch(sectionId) {
            case 'sku-management':
              if (typeof loadSkuData === 'function') loadSkuData();
              break;
            case 'inventory-management':
              if (typeof loadInventoryData === 'function') loadInventoryData();
              break;
            case 'marketing-management':
              if (typeof loadMarketingSettings === 'function') loadMarketingSettings();
              if (typeof loadCoupons === 'function') loadCoupons();
              break;
            case 'shipping-management':
              if (typeof loadShippingSettings === 'function') loadShippingSettings();
              break;
            case 'tax-management':
              if (typeof loadTaxSettings === 'function') loadTaxSettings();
              break;
            case 'company-tax':
              if (typeof loadCompanyTaxData === 'function') loadCompanyTaxData();
              break;
            case 'gift-cards':
              if (typeof loadGiftCards === 'function') loadGiftCards();
              break;
            case 'messages':
              if (typeof loadAndRenderMessages === 'function') loadAndRenderMessages();
              break;
            case 'returns':
              if (typeof loadReturns === 'function') loadReturns();
              break;
            case 'exchanges':
              if (typeof loadExchanges === 'function') loadExchanges();
              break;
            case 'cancellations':
              if (typeof loadCancellations === 'function') loadCancellations();
              break;
            case 'orders':
              if (typeof loadOrders === 'function') loadOrders();
              break;
            case 'products':
              if (typeof loadProducts === 'function') loadProducts();
              break;
            case 'users':
              if (typeof loadUsers === 'function') loadUsers();
              break;
            case 'deleted-users':
              if (typeof loadDeletedUsers === 'function') loadDeletedUsers();
              break;
            case 'slider':
              if (typeof loadSlides === 'function') loadSlides();
              break;
          }
        }
        
        // Make functions globally available
        window.showSection = showSection;
        window.loadSectionData = loadSectionData;

        // Add click handlers to sidebar links
        sidebarLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.dataset.section;
            if (sectionId) {
              showSection(sectionId);
            }
          });
        });
        
        // Add click handlers to mobile menu items
        mobileMenuItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.dataset.section;
            if (sectionId) {
              showSection(sectionId);
            }
          });
        });
        
        // Handle URL hash for direct section access
        function handleHashChange() {
          const hash = window.location.hash.slice(1);
          if (hash) {
            const section = document.getElementById(hash);
            if (section && section.classList.contains('admin-section')) {
              showSection(hash);
            }
          }
        }
        
        window.addEventListener('hashchange', handleHashChange);
        
        // Check initial hash on load
        if (window.location.hash) {
          handleHashChange();
        }
      }

      // ===============================
      // MESSAGES MANAGEMENT FUNCTIONS
      // ===============================

      let messagesSearchTerm = '';

      function initializeMessagesManagement() {
        loadAndRenderMessages();
        updateMessageNotificationBadge();

        const refreshMessagesBtn = document.getElementById('refreshMessagesBtn');
        if (refreshMessagesBtn) {
          refreshMessagesBtn.addEventListener('click', () => {
            loadAndRenderMessages();
            updateMessageNotificationBadge();
          });
        }

        // Query search functionality
        const querySearchInput = document.getElementById('querySearch');
        const clearQuerySearchBtn = document.getElementById('clearQuerySearch');
        
        if (querySearchInput) {
          querySearchInput.addEventListener('input', (e) => {
            messagesSearchTerm = e.target.value.trim();
            loadAndRenderMessages(messagesSearchTerm);
          });
          
          querySearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              messagesSearchTerm = e.target.value.trim();
              loadAndRenderMessages(messagesSearchTerm);
            }
          });
        }
        
        if (clearQuerySearchBtn) {
          clearQuerySearchBtn.addEventListener('click', () => {
            if (querySearchInput) querySearchInput.value = '';
            messagesSearchTerm = '';
            loadAndRenderMessages();
          });
        }

        // Auto-refresh message notification badge every 5 seconds
        setInterval(updateMessageNotificationBadge, 5000);
      }

      async function updateMessageNotificationBadge() {
        try {
          let unreadCount = 0;
          
          try {
            const data = await apiRequest('/contact/stats/unread');
            unreadCount = data.unread || 0;
          } catch (e) {
            console.error('Failed to fetch unread count:', e);
          }
          
          const badge = document.getElementById('messagesNotificationBadge');
          
          if (!badge) return;

          if (unreadCount > 0) {
            // Add notification dot with count
            let dot = badge.querySelector('.notification-dot');
            if (!dot) {
              dot = document.createElement('span');
              dot.className = 'notification-dot';
              badge.appendChild(dot);
            }
            dot.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.classList.add('has-notification');
          } else {
            // Remove notification dot
            const dot = badge.querySelector('.notification-dot');
            if (dot) dot.remove();
            badge.classList.remove('has-notification');
          }
        } catch (error) {
          console.error('Error updating notification badge:', error);
        }
      }

      async function loadAndRenderMessages(searchQuery = '') {
        try {
          let messagesData = [];
          
          try {
            // Include search query if provided
            const endpoint = searchQuery 
              ? `/contact?query=${encodeURIComponent(searchQuery)}`
              : '/contact';
            const data = await apiRequest(endpoint);
            messagesData = data.messages || [];
          } catch (e) {
            console.error('Failed to fetch messages:', e);
            showNotification('Failed to load messages', 'error');
          }

          console.log('Loaded messages:', messagesData);
          renderMessages(messagesData);
        } catch (error) {
          console.error('Error loading messages:', error);
          const tbody = document.getElementById('messagesTableBody');
          if (tbody) {
            tbody.innerHTML = '';
          }
        }
      }

      function renderMessages(messages) {
        const tbody = document.getElementById('messagesTableBody');
        const noMessagesMsg = document.getElementById('noMessagesMsg');

        if (!tbody) return;

        if (!messages || messages.length === 0) {
          tbody.innerHTML = '';
          if (noMessagesMsg) noMessagesMsg.style.display = 'block';
          return;
        }

        if (noMessagesMsg) noMessagesMsg.style.display = 'none';

        // Sort messages by date (newest first)
        const sortedMessages = [...messages].sort((a, b) => {
          return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
        });

        tbody.innerHTML = sortedMessages.map(msg => {
          const date = new Date(msg.timestamp || msg.createdAt).toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const isRead = msg.status === 'read' || msg.read;
          const statusClass = isRead ? 'status-read' : 'status-unread';
          
          // Query number display
          const queryNum = msg.queryNumber || 'N/A';
          
          // Query status (pending, open, solved)
          const hasReplies = msg.replies && msg.replies.length > 0;
          const hasAdminReply = hasReplies && msg.replies.some(r => !r.isUserReply);
          let queryStatus = msg.status || 'pending';
          if (queryStatus === 'read' || queryStatus === 'unread') {
            // Legacy status - determine from replies
            if (hasAdminReply) {
              queryStatus = 'open';
            } else {
              queryStatus = 'pending';
            }
          }
          
          const queryStatusLabels = {
            'pending': { label: 'Pending', class: 'badge-warning', icon: 'ri-time-line' },
            'open': { label: 'Open', class: 'badge-info', icon: 'ri-chat-3-line' },
            'solved': { label: 'Closed', class: 'badge-success', icon: 'ri-checkbox-circle-line' }
          };
          const statusInfo = queryStatusLabels[queryStatus] || queryStatusLabels['pending'];

          return `
            <tr class="${statusClass}">
              <td data-label="Query #"><code style="background:#f1f5f9;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;color:#1e40af;">${queryNum}</code></td>
              <td data-label="Name"><strong>${msg.name || 'N/A'}</strong></td>
              <td data-label="Email" title="${msg.email || 'N/A'}">${msg.email || 'N/A'}</td>
              <td data-label="Phone">${msg.phone || 'N/A'}</td>
              <td data-label="Subject" title="${msg.subject || 'No Subject'}">${msg.subject || 'No Subject'}</td>
              <td data-label="Date"><small>${date}</small></td>
              <td data-label="Status">
                <select class="query-status-select" data-id="${msg.id}" style="padding:4px 8px;border-radius:6px;border:1px solid #e5e7eb;font-size:12px;cursor:pointer;">
                  <option value="pending" ${queryStatus === 'pending' ? 'selected' : ''}> Pending</option>
                  <option value="open" ${queryStatus === 'open' ? 'selected' : ''}> Open</option>
                  <option value="solved" ${queryStatus === 'solved' ? 'selected' : ''}> Closed</option>
                </select>
              </td>
              <td data-label="Actions">
                <div class="action-buttons" style="display: flex; gap: 4px;">
                  <button class="action-btn edit-btn" data-action="view" data-id="${msg.id}" title="View message">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button class="action-btn ${isRead ? 'secondary' : 'edit-btn'}" data-action="toggle-read" data-id="${msg.id}" data-mark-read="${!isRead}" title="${isRead ? 'Mark as unread' : 'Mark as read'}">
                    <i class="ri-${isRead ? 'mail-line' : 'mail-check-line'}"></i>
                  </button>
                  <button class="action-btn delete-btn" data-action="delete" data-id="${msg.id}" title="Delete message">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        // Attach status change handlers
        document.querySelectorAll('.query-status-select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const msgId = e.target.dataset.id;
            const newStatus = e.target.value;
            await updateQueryStatus(msgId, newStatus);
          });
        });
      }
      
      // Update query status
      async function updateQueryStatus(msgId, status) {
        try {
          await apiRequest(`/contact/${msgId}/status`, {
            method: 'PATCH',
            body: JSON.stringify({ status })
          });
          showNotification(`Query marked as ${status === 'solved' ? 'closed' : status}`, 'success');
        } catch (error) {
          console.error('Error updating query status:', error);
          showNotification('Failed to update status', 'error');
          loadAndRenderMessages(); // Refresh to revert
        }
      }

      // Attach delegated handler (idempotent)
      function messagesTableClickHandler(e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (!action || !id) return;

        if (action === 'view') {
          viewMessage(id, e);
          return;
        }

        if (action === 'toggle-read') {
          const markRead = String(btn.dataset.markRead) === 'true';
          toggleMessageRead(id, markRead);
          return;
        }

        if (action === 'delete') {
          deleteMessage(id, e);
          return;
        }
      }

      // Ensure single delegated listener (idempotent)
      try {
        const tbodyEl = document.getElementById('messagesTableBody');
        if (tbodyEl && !tbodyEl.dataset.messagesHandlerAttached) {
          tbodyEl.addEventListener('click', messagesTableClickHandler);
          tbodyEl.dataset.messagesHandlerAttached = '1';
        }
      } catch (e) {
        // ignore
      }

      async function toggleMessageRead(msgId, read) {
        try {
          await apiRequest(`/contact/${msgId}/read`, {
            method: 'PATCH',
            body: JSON.stringify({ read })
          });
          loadAndRenderMessages();
          updateMessageNotificationBadge();
        } catch (error) {
          console.error('Error toggling message read status:', error);
          showNotification('Failed to update message status', 'error');
        }
      }

      async function viewMessage(msgId, e = null) {
        try {
          let message;
          
          try {
            const data = await apiRequest(`/contact/${msgId}`);
            message = data.message;
          } catch (err) {
            console.error('Failed to fetch message:', err);
            showNotification('Failed to load message', 'error');
            return;
          }

          if (!message) {
            showNotification('Message not found', 'warning');
            return;
          }

          // Mark as read
          if (message.status !== 'read' && !message.read) {
            await toggleMessageRead(msgId, true);
            // Refresh the message data
            try {
              const data = await apiRequest(`/contact/${msgId}`);
              message = data.message || message;
            } catch (err) {
              console.error('Failed to refresh message:', err);
            }
          }

          // Initialize replies array if not exists
          if (!message.replies) {
            message.replies = [];
          }
          
          // Build attachments HTML if present
          let attachmentsHTML = '';
          if (message.attachments && message.attachments.length > 0) {
            attachmentsHTML = `
              <div class="detail-row full-width">
                <label>Attachments:</label>
                <div class="message-attachments" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                  ${message.attachments.map(att => `
                    <a href="${att.url}" target="_blank" style="display: block;">
                      <img src="${att.url}" alt="Attachment" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    </a>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // Show modal with message details
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100000;';
          
          let repliesHTML = '';
          if (message.replies && message.replies.length > 0) {
            repliesHTML = `
              <div class="replies-section">
                <h4><i class="ri-reply-line"></i> Replies (${message.replies.length})</h4>
                <div class="replies-list">
                  ${message.replies.map(reply => `
                    <div class="reply-item ${reply.isUserReply ? 'user-reply' : 'admin-reply'}" style="${reply.isUserReply ? 'background: #f0f9ff; border-left: 3px solid #3b82f6;' : ''}">
                      <div class="reply-header">
                        <strong>${reply.isUserReply ? (reply.userName || 'Customer') : 'Admin Response'}</strong>
                        <small>${new Date(reply.timestamp || reply.createdAt).toLocaleString()}</small>
                      </div>
                      <p class="reply-content">${reply.text}</p>
                      ${reply.attachments && reply.attachments.length > 0 ? `
                        <div class="reply-attachments" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                          ${reply.attachments.map(att => `
                            <a href="${att.url}" target="_blank">
                              <img src="${att.url}" alt="Attachment" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;">
                            </a>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }

          modal.innerHTML = `
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
              <div class="modal-header">
                <h3><i class="ri-mail-open-line"></i> Message Details</h3>
                <button class="modal-close" id="messageModalClose"></button>
              </div>
              <div class="modal-body">
                <div class="message-detail">
                  <div class="detail-row">
                    <label>Name:</label>
                    <p>${message.name || 'N/A'}</p>
                  </div>
                  <div class="detail-row">
                    <label>Email:</label>
                    <p><a href="mailto:${message.email}">${message.email || 'N/A'}</a></p>
                  </div>
                  <div class="detail-row">
                    <label>Phone:</label>
                    <p><a href="tel:${message.phone}">${message.phone || 'N/A'}</a></p>
                  </div>
                  <div class="detail-row">
                    <label>Subject:</label>
                    <p><strong>${message.subject || 'No Subject'}</strong></p>
                  </div>
                  <div class="detail-row">
                    <label>Date:</label>
                    <p>${new Date(message.timestamp || message.createdAt).toLocaleString()}</p>
                  </div>
                  <div class="detail-row full-width">
                    <label>Message:</label>
                    <p class="message-content" style="white-space: pre-wrap;">${message.message || 'No content'}</p>
                  </div>
                  ${attachmentsHTML}
                </div>
                ${repliesHTML}
                <div class="reply-form-section">
                  <h4><i class="ri-edit-line"></i> Add Reply</h4>
                  <textarea id="replyText" class="reply-textarea" placeholder="Type your reply to the customer..."></textarea>
                  <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="secondary" id="messageModalCloseBtn">Close</button>
                    <button type="button" class="secondary" id="messageModalCopyBtn"><i class="ri-file-copy-line"></i> Copy</button>
                    <button type="button" class="primary" id="messageModalSendBtn"><i class="ri-send-plane-line"></i> Send Reply</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);
          
          // Attach event listeners for modal buttons
          const closeModal = () => {
            if (modal && modal.parentNode) {
              modal.remove();
            }
          };
          
          document.getElementById('messageModalClose').addEventListener('click', closeModal);
          document.getElementById('messageModalCloseBtn').addEventListener('click', closeModal);
          document.getElementById('messageModalCopyBtn').addEventListener('click', () => copyMessageToClipboard(msgId));
          document.getElementById('messageModalSendBtn').addEventListener('click', () => saveMessageReply(msgId));
          
          // Close on overlay click (outside modal content)
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeModal();
            }
          });
        } catch (error) {
          console.error('Error viewing message:', error);
          showNotification('Error opening message', 'error');
        }
      }

      async function saveMessageReply(msgId) {
        try {
          const replyTextEl = document.getElementById('replyText');
          if (!replyTextEl) {
            showNotification('Reply field not found', 'error');
            return;
          }
          
          const replyText = replyTextEl.value.trim();
          
          if (!replyText) {
            showNotification('Please type a reply', 'warning');
            return;
          }

          await apiRequest(`/contact/${msgId}/reply`, {
            method: 'POST',
            body: JSON.stringify({ reply: replyText })
          });
          showNotification('Reply sent successfully!', 'success');
          
          // Close modal safely
          const modal = document.querySelector('.modal-overlay');
          if (modal) modal.remove();
          
          // Reopen modal to show the new reply
          viewMessage(msgId);
        } catch (error) {
          console.error('Error saving reply:', error);
          showNotification('Failed to send reply', 'error');
        }
      }

      async function deleteMessage(msgId, e = null) {
        const confirmed = await showConfirmModal({
          title: 'Delete Message',
          message: 'Are you sure you want to delete this message? This action cannot be undone.',
          confirmText: 'Yes, Delete',
          cancelText: 'Cancel',
          type: 'danger',
          event: e
        });
        if (!confirmed) return;

        try {
          await apiRequest(`/contact/${msgId}`, { method: 'DELETE' });
          loadAndRenderMessages();
          updateMessageNotificationBadge();
          showNotification('Message deleted successfully', 'success');
        } catch (error) {
          console.error('Error deleting message:', error);
          showNotification('Failed to delete message', 'error');
        }
      }

      async function copyMessageToClipboard(msgId) {
        try {
          let message;
          try {
            const data = await apiRequest(`/contact/${msgId}`);
            message = data.message;
          } catch (e) {
            console.error('Failed to fetch message:', e);
            showNotification('Failed to load message', 'error');
            return;
          }

          if (!message) return;

          const textToCopy = `Name: ${message.name}
Email: ${message.email}
Phone: ${message.phone}
Subject: ${message.subject}
Date: ${new Date(message.timestamp).toLocaleString()}

Message:
${message.message}`;

          navigator.clipboard.writeText(textToCopy).then(() => {
            showNotification('Message copied to clipboard', 'success');
          }).catch(() => {
            // Fallback method
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('Message copied to clipboard', 'success');
          });
        } catch (error) {
          console.error('Error copying message:', error);
        }
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          document.getElementById('orderSearch')?.focus();
        }
        // Ctrl/Cmd + R to refresh orders
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
          e.preventDefault();
          fetchOrders();
        }
        // Escape to close modal
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      // ===============================
      // RETURNS SEARCH AND FILTER FUNCTIONALITY
      // ===============================

      let returnsFilters = {
        search: '',
        status: '',
        reason: ''
      };
      let selectedReturns = new Set();

      function initializeReturnsSearchAndFilters() {
        const searchInput = document.getElementById('returnSearch');
        const clearSearchBtn = document.getElementById('clearReturnSearch');
        const statusFilter = document.getElementById('returnStatusFilter');
        const reasonFilter = document.getElementById('returnReasonFilter');
        const selectAllCheckbox = document.getElementById('selectAllReturns');
        const selectAllBtn = document.getElementById('selectAllReturnsBtn');
        const bulkStatusBtn = document.getElementById('bulkReturnStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkReturnDeleteBtn');

        // Search functionality
        if (searchInput) {
          searchInput.addEventListener('input', debounce(() => {
            returnsFilters.search = searchInput.value.toLowerCase();
            renderFilteredReturns();
          }, 300));
        }

        if (clearSearchBtn) {
          clearSearchBtn.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';
            returnsFilters.search = '';
            renderFilteredReturns();
          });
        }

        // Filter functionality
        if (statusFilter) {
          statusFilter.addEventListener('change', () => {
            returnsFilters.status = statusFilter.value;
            renderFilteredReturns();
          });
        }

        if (reasonFilter) {
          reasonFilter.addEventListener('change', () => {
            returnsFilters.reason = reasonFilter.value;
            renderFilteredReturns();
          });
        }

        // Select all checkbox
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', () => {
            const checkboxes = document.querySelectorAll('.return-checkbox');
            checkboxes.forEach(cb => {
              cb.checked = selectAllCheckbox.checked;
              updateReturnSelection(cb.dataset.id, cb.checked);
            });
            updateReturnsBulkActionsState();
          });
        }

        // Select all button
        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', () => {
            const allCheckboxes = document.querySelectorAll('.return-checkbox');
            const allSelected = selectedReturns.size === allCheckboxes.length;
            const newState = !allSelected;

            allCheckboxes.forEach(cb => {
              cb.checked = newState;
              updateReturnSelection(cb.dataset.id, newState);
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = newState;
            updateReturnsBulkActionsState();
          });
        }

        // Bulk status update button
        if (bulkStatusBtn) {
          bulkStatusBtn.addEventListener('click', (e) => {
            if (selectedReturns.size === 0) return;

            const statusOptions = `
              <label for="bulkReturnStatusSelect" style="font-weight:600; display:block; margin-bottom:6px;">Status:</label>
              <select id="bulkReturnStatusSelect" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 10px; width: 100%;">
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Processing">Processing</option>
                <option value="Completed">Completed</option>
              </select>
              <div style="margin-top: 12px;">
                <label style="font-weight: 600; margin-bottom: 6px; display: block;">Admin Notes (optional):</label>
                <textarea id="bulkReturnNotes" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; min-height: 80px;" placeholder="Add notes for these returns..."></textarea>
              </div>
            `;

            showModal(
              `Update ${selectedReturns.size} Return${selectedReturns.size > 1 ? 's' : ''}`,
              `Select new status for ${selectedReturns.size} selected return${selectedReturns.size > 1 ? 's' : ''}: ${statusOptions}`,
              async () => {
                const newStatus = document.getElementById('bulkReturnStatusSelect').value;
                const notes = document.getElementById('bulkReturnNotes').value.trim();
                await bulkUpdateReturnStatus(newStatus, notes);
                closeModal();
              },
              e
            );
          });
        }

        // Bulk delete button
        if (bulkDeleteBtn) {
          bulkDeleteBtn.addEventListener('click', (e) => {
            if (selectedReturns.size === 0) return;

            showModal(
              `Delete ${selectedReturns.size} Return${selectedReturns.size > 1 ? 's' : ''}`,
              `Are you sure you want to delete ${selectedReturns.size} selected return${selectedReturns.size > 1 ? 's' : ''}? This action cannot be undone.`,
              async () => {
                await bulkDeleteReturns();
                closeModal();
              },
              e
            );
          });
        }
      }

      function updateReturnSelection(returnId, selected) {
        if (selected) {
          selectedReturns.add(returnId);
        } else {
          selectedReturns.delete(returnId);
        }
        updateReturnsBulkActionsState();
      }

      function updateReturnsBulkActionsState() {
        const bulkStatusBtn = document.getElementById('bulkReturnStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkReturnDeleteBtn');

        const hasSelection = selectedReturns.size > 0;
        if (bulkStatusBtn) {
          bulkStatusBtn.disabled = !hasSelection;
          bulkStatusBtn.textContent = hasSelection ? `Update ${selectedReturns.size}` : 'Bulk Update Status';
        }
        if (bulkDeleteBtn) {
          bulkDeleteBtn.disabled = !hasSelection;
          bulkDeleteBtn.textContent = hasSelection ? `Delete ${selectedReturns.size}` : 'Delete Selected';
        }
      }

      async function bulkUpdateReturnStatus(newStatus, adminNotes = '') {
        let success = 0, failed = 0;
        for (const returnId of selectedReturns) {
          if (await updateReturnStatus(returnId, newStatus, adminNotes)) {
            success++;
          } else {
            failed++;
          }
        }
        
        showNotification(`Updated ${success} return(s)${failed ? `, ${failed} failed` : ''}`, failed ? 'warning' : 'success');
        selectedReturns.clear();
        updateReturnsBulkActionsState();
        await fetchReturns();
        await renderStatsAsync();
      }

      async function bulkDeleteReturns() {
        try {
          for (const returnId of selectedReturns) {
            await apiRequest(`/returns/${returnId}`, { method: 'DELETE' });
          }
          showNotification('Returns deleted successfully', 'success');
        } catch (e) {
          console.error('Failed to delete returns:', e);
          showNotification('Failed to delete some returns', 'error');
        }
        selectedReturns.clear();
        updateReturnsBulkActionsState();
        await fetchReturns();
        await renderStatsAsync();
      }

      function renderFilteredReturns() {
        const filteredReturns = returns.filter(ret => {
          // Search filter
          if (returnsFilters.search) {
            const searchTerm = returnsFilters.search;
            const matchesSearch =
              (ret.id || '').toLowerCase().includes(searchTerm) ||
              (ret.orderId || '').toLowerCase().includes(searchTerm) ||
              (ret.customer?.name || '').toLowerCase().includes(searchTerm) ||
              (ret.customer?.email || '').toLowerCase().includes(searchTerm);
            if (!matchesSearch) return false;
          }

          // Status filter
          if (returnsFilters.status && ret.status !== returnsFilters.status) {
            return false;
          }

          // Reason filter
          if (returnsFilters.reason && (ret.reason || '').toLowerCase() !== returnsFilters.reason) {
            return false;
          }

          return true;
        });

        renderReturnsTableFiltered(filteredReturns);
      }

      function renderReturnsTableFiltered(returnsList) {
        if (!returnsList || !returnsList.length) {
          const hasFilters = returnsFilters.search || returnsFilters.status || returnsFilters.reason;
          const message = hasFilters ? 'No returns found matching your filters' : 'No return requests yet';
          returnsBody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:#9ca3af;"><i class="ri-inbox-line" style="font-size:2rem;display:block;margin-bottom:8px;"></i>${message}</td></tr>`;
          return;
        }

        returnsBody.innerHTML = returnsList
          .map(ret => {
            const dateStr = ret.requestedAt || ret.createdAt ? new Date(ret.requestedAt || ret.createdAt).toLocaleDateString() : '-';
            const timeStr = ret.requestedAt || ret.createdAt ? new Date(ret.requestedAt || ret.createdAt).toLocaleTimeString() : '';

            const itemsHtml = ret.items?.map(i =>
              `<div class="item">${i.name || 'Product'} <small>(${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1}</small></div>`
            ).join('') || '<div class="item">-</div>';

            const cust = ret.customer || {};
            const customerHtml = `<strong>${cust.name || '-'}</strong><div style="font-size:0.75rem;color:#6b7280;">${cust.email || ''}</div><div style="font-size:0.75rem;color:#9ca3af;">${cust.phone || ''}</div>`;

            const reason = ret.reason || ret.reasonText || '-';
            const status = ret.status || 'Pending';
            const isSelected = selectedReturns.has(ret.id);

            return `
              <tr class="${isSelected ? 'selected' : ''}">
                <td><input type="checkbox" class="return-checkbox" data-id="${ret.id}" ${isSelected ? 'checked' : ''} aria-label="Select return ${ret.id}" /></td>
                <td data-label="Return ID">
                  <strong>${ret.id}</strong>
                  <div class="last-activity">${timeStr}</div>
                </td>
                <td data-label="Order ID"><strong>${ret.orderId || '-'}</strong></td>
                <td data-label="Customer">${customerHtml}</td>
                <td data-label="Items">
                  <div class="order-items-detail">${itemsHtml}</div>
                </td>
                <td data-label="Reason"><span class="return-reason-badge">${reason}</span></td>
                <td data-label="Status">
                  <select class="return-status" data-id="${ret.id}" aria-label="Return ${ret.id} status">
                    <option value="Pending" ${status === 'Pending' ? 'selected' : ''}> Pending</option>
                    <option value="Approved" ${status === 'Approved' ? 'selected' : ''}> Approved</option>
                    <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}> Rejected</option>
                    <option value="Pickup Scheduled" ${status === 'Pickup Scheduled' ? 'selected' : ''}> Pickup Scheduled</option>
                    <option value="Picked Up" ${status === 'Picked Up' ? 'selected' : ''}> Picked Up</option>
                    <option value="Processing" ${status === 'Processing' ? 'selected' : ''}> Processing</option>
                    <option value="Refunded" ${status === 'Refunded' ? 'selected' : ''}> Refunded</option>
                    <option value="Completed" ${status === 'Completed' ? 'selected' : ''}> Completed</option>
                  </select>
                </td>
                <td data-label="Requested">${dateStr}</td>
                <td data-label="Actions" class="actions">
                  <button type="button" data-action="view-return" data-id="${ret.id}" aria-label="View" title="View return details">
                    <i class="ri-eye-line"></i>
                  </button>
                  <button type="button" data-action="delete-return" data-id="${ret.id}" aria-label="Delete" title="Delete return">
                    <i class="ri-delete-bin-6-line"></i>
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        attachReturnsEventListeners();
      }

      function attachReturnsEventListeners() {
        // Status change handlers - track pending changes
        document.querySelectorAll('.return-status').forEach(select => {
          // Store original value for comparison
          select.dataset.originalStatus = select.value;
          
          select.addEventListener('change', (e) => {
            const returnId = e.target.dataset.id;
            const newStatus = e.target.value;
            const originalStatus = e.target.dataset.originalStatus;
            
            if (newStatus !== originalStatus) {
              // Add to pending changes
              pendingReturnChanges.set(returnId, { status: newStatus, adminNotes: '' });
              e.target.classList.add('status-changed');
            } else {
              // Remove from pending if reverted to original
              pendingReturnChanges.delete(returnId);
              e.target.classList.remove('status-changed');
            }
            updatePendingReturnUI();
          });
        });

        // Checkbox handlers
        document.querySelectorAll('.return-checkbox').forEach(cb => {
          cb.addEventListener('change', (e) => {
            updateReturnSelection(e.target.dataset.id, e.target.checked);
            const allCheckboxes = document.querySelectorAll('.return-checkbox');
            const checkedBoxes = document.querySelectorAll('.return-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllReturns');
            if (selectAllCheckbox) {
              selectAllCheckbox.checked = allCheckboxes.length === checkedBoxes.length;
            }
          });
        });

        // View return handler
        document.querySelectorAll('[data-action="view-return"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const returnId = btn.dataset.id;
            const r = returns.find(x => x.id === returnId);
            if (r) {
              // Look up the order to get customer info
              const order = orders.find(o => o.id === r.orderId) || {};
              const customerName = order.shippingInfo?.name || order.userName || r.customer?.name || '-';
              const customerEmail = order.shippingInfo?.email || order.userEmail || r.customer?.email || '-';
              const customerPhone = order.shippingInfo?.phone || r.customer?.phone || '-';
              const refundAmount = r.refundAmount || (r.items?.reduce((sum, i) => sum + ((i.price || 0) * (i.quantity || 1)), 0)) || 0;
              const details = `
<div class="message-detail">
  <div class="detail-row">
    <label>Return ID:</label>
    <p>${r.id}</p>
  </div>
  <div class="detail-row">
    <label>Order ID:</label>
    <p>${r.orderId || '-'}</p>
  </div>
  <div class="detail-row">
    <label>Status:</label>
    <p><span class="return-status-badge return-status-${(r.status || 'pending').toLowerCase()}">${r.status || 'Pending'}</span></p>
  </div>
  <div class="detail-row">
    <label>Requested:</label>
    <p>${r.requestedAt || r.createdAt ? new Date(r.requestedAt || r.createdAt).toLocaleString() : '-'}</p>
  </div>
  <div class="detail-row">
    <label>Customer:</label>
    <p><strong>${customerName}</strong><br>${customerEmail}<br>${customerPhone}</p>
  </div>
  <div class="detail-row full-width">
    <label>Items:</label>
    <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
      ${r.items?.map(i => `<div class="item" style="padding: 8px; margin-bottom: 4px; background: white; border-radius: 4px;"><strong>${i.name}</strong> (${i.size || '-'}/${i.color || '-'}) x${i.quantity || 1} = ${((i.price || 0) * (i.quantity || 1)).toLocaleString()}</div>`).join('') || '<p>No items</p>'}
    </div>
  </div>
  <div class="detail-row">
    <label>Reason:</label>
    <p><span class="return-reason-badge">${r.reason || r.reasonText || '-'}</span></p>
  </div>
  <div class="detail-row full-width">
    <label>Comments:</label>
    <p>${r.comments || r.description || 'No additional comments'}</p>
  </div>
  <div class="detail-row">
    <label>Refund Amount:</label>
    <p><strong style="color: #059669;">${refundAmount.toLocaleString()}</strong></p>
  </div>
  ${r.adminNotes ? `<div class="detail-row full-width"><label>Admin Notes:</label><p style="background: #fef3c7;">${r.adminNotes}</p></div>` : ''}
</div>
              `;
              showModal('Return Request Details', details, null, e);
            }
          });
        });

        // Delete return handler
        document.querySelectorAll('[data-action="delete-return"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const returnId = btn.dataset.id;
            showModal(
              'Delete Return Request',
              `Are you sure you want to delete return ${returnId}? This action cannot be undone.`,
              async () => {
                try {
                  await apiRequest(`/returns/${returnId}`, { method: 'DELETE' });
                  showNotification('Return deleted successfully', 'success');
                } catch (e) {
                  console.error('Failed to delete return:', e);
                  showNotification('Failed to delete return', 'error');
                }
                closeModal();
                await fetchReturns();
                await renderStatsAsync();
              }
            );
          });
        });
      }

      // Override renderReturns to use filtered version
      const originalRenderReturns = renderReturns;
      renderReturns = function() {
        renderFilteredReturns();
      };

      // ==========================================
      // EXCHANGES SEARCH AND FILTERS
      // ==========================================

      let exchangesFilters = {
        search: '',
        status: '',
        reason: ''
      };
      let selectedExchanges = new Set();

      function initializeExchangesSearchAndFilters() {
        const searchInput = document.getElementById('exchangeSearch');
        const clearSearchBtn = document.getElementById('clearExchangeSearch');
        const statusFilter = document.getElementById('exchangeStatusFilter');
        const reasonFilter = document.getElementById('exchangeReasonFilter');
        const selectAllCheckbox = document.getElementById('selectAllExchanges');
        const selectAllBtn = document.getElementById('selectAllExchangesBtn');
        const bulkStatusBtn = document.getElementById('bulkExchangeStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkExchangeDeleteBtn');

        // Search functionality
        if (searchInput) {
          searchInput.addEventListener('input', debounce(() => {
            exchangesFilters.search = searchInput.value.toLowerCase();
            renderFilteredExchanges();
          }, 300));
        }

        if (clearSearchBtn) {
          clearSearchBtn.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';
            exchangesFilters.search = '';
            renderFilteredExchanges();
          });
        }

        // Filter functionality
        if (statusFilter) {
          statusFilter.addEventListener('change', () => {
            exchangesFilters.status = statusFilter.value;
            renderFilteredExchanges();
          });
        }

        if (reasonFilter) {
          reasonFilter.addEventListener('change', () => {
            exchangesFilters.reason = reasonFilter.value;
            renderFilteredExchanges();
          });
        }

        // Select all checkbox
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', () => {
            const checkboxes = document.querySelectorAll('.exchange-checkbox');
            checkboxes.forEach(cb => {
              cb.checked = selectAllCheckbox.checked;
              updateExchangeSelection(cb.dataset.id, cb.checked);
            });
            updateExchangesBulkActionsState();
          });
        }

        // Select all button
        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', () => {
            const allCheckboxes = document.querySelectorAll('.exchange-checkbox');
            const allSelected = selectedExchanges.size === allCheckboxes.length;
            const newState = !allSelected;

            allCheckboxes.forEach(cb => {
              cb.checked = newState;
              updateExchangeSelection(cb.dataset.id, newState);
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = newState;
            updateExchangesBulkActionsState();
          });
        }

        // Bulk delete button
        if (bulkDeleteBtn) {
          bulkDeleteBtn.addEventListener('click', async () => {
            if (selectedExchanges.size === 0) return;
            const confirmed = await showConfirmModal({
              title: 'Delete Selected Exchanges',
              message: `Are you sure you want to delete ${selectedExchanges.size} selected exchange(s)? This action cannot be undone.`,
              confirmText: 'Yes, Delete',
              cancelText: 'Cancel',
              type: 'danger'
            });
            if (!confirmed) return;

            for (const id of selectedExchanges) {
              try {
                await apiRequest(`/exchanges/${id}`, { method: 'DELETE' });
              } catch (e) {
                console.error(`Failed to delete exchange ${id}:`, e);
              }
            }
            showNotification('Selected exchanges deleted successfully', 'success');
            selectedExchanges.clear();
            updateExchangesBulkActionsState();
            await fetchExchanges();
          });
        }

        // Bulk status update button
        if (bulkStatusBtn) {
          bulkStatusBtn.addEventListener('click', async () => {
            if (selectedExchanges.size === 0) return;
            
            // Create status selection modal
            const statusOptions = ['Pending', 'Approved', 'Processing', 'Shipped', 'Completed', 'Rejected'];
            const statusSelect = statusOptions.map(s => `<option value="${s}">${s}</option>`).join('');
            
            const modalContent = `
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select new status for ${selectedExchanges.size} exchange(s):</label>
                <select id="bulkExchangeStatusSelect" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                  ${statusSelect}
                </select>
              </div>
            `;
            
            showModal('Bulk Update Status', modalContent, async () => {
              const newStatus = document.getElementById('bulkExchangeStatusSelect')?.value;
              if (!newStatus) return;
              
              let success = 0, failed = 0;
              for (const id of selectedExchanges) {
                try {
                  await apiRequest(`/exchanges/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus })
                  });
                  success++;
                } catch (e) {
                  console.error(`Failed to update exchange ${id}:`, e);
                  failed++;
                }
              }
              
              selectedExchanges.clear();
              updateExchangesBulkActionsState();
              await fetchExchanges();
              showNotification(`Updated ${success} exchange(s)${failed ? `, ${failed} failed` : ''}`, failed ? 'warning' : 'success');
            });
          });
        }
      }

      function updateExchangeSelection(exchangeId, selected) {
        if (selected) {
          selectedExchanges.add(exchangeId);
        } else {
          selectedExchanges.delete(exchangeId);
        }
        updateExchangesBulkActionsState();
      }

      function updateExchangesBulkActionsState() {
        const bulkStatusBtn = document.getElementById('bulkExchangeStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkExchangeDeleteBtn');
        const hasSelection = selectedExchanges.size > 0;
        if (bulkStatusBtn) bulkStatusBtn.disabled = !hasSelection;
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !hasSelection;
      }

      function renderFilteredExchanges() {
        let filtered = [...exchanges];

        if (exchangesFilters.search) {
          filtered = filtered.filter(exc => {
            const searchStr = exchangesFilters.search;
            return (
              (exc.id || '').toLowerCase().includes(searchStr) ||
              (exc.orderId || '').toLowerCase().includes(searchStr) ||
              (exc.customer?.name || '').toLowerCase().includes(searchStr) ||
              (exc.customer?.email || '').toLowerCase().includes(searchStr)
            );
          });
        }

        if (exchangesFilters.status) {
          filtered = filtered.filter(exc => exc.status === exchangesFilters.status);
        }

        if (exchangesFilters.reason) {
          filtered = filtered.filter(exc => exc.reason === exchangesFilters.reason);
        }

        renderExchangesTable(filtered);
      }

      // Override renderExchanges to use filtered version
      const originalRenderExchanges = renderExchanges;
      renderExchanges = function() {
        renderFilteredExchanges();
      };

      // ==========================================
      // CANCELLATIONS SEARCH AND FILTERS
      // ==========================================

      let cancellationsFilters = {
        search: '',
        status: '',
        reason: ''
      };
      let selectedCancellations = new Set();

      function initializeCancellationsSearchAndFilters() {
        const searchInput = document.getElementById('cancellationSearch');
        const clearSearchBtn = document.getElementById('clearCancellationSearch');
        const statusFilter = document.getElementById('cancellationStatusFilter');
        const reasonFilter = document.getElementById('cancellationReasonFilter');
        const selectAllCheckbox = document.getElementById('selectAllCancellationsCheckbox');
        const selectAllBtn = document.getElementById('selectAllCancellationsBtn');
        const bulkStatusBtn = document.getElementById('bulkCancellationStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkCancellationDeleteBtn');

        // Search functionality
        if (searchInput) {
          searchInput.addEventListener('input', debounce(() => {
            cancellationsFilters.search = searchInput.value.toLowerCase();
            renderFilteredCancellations();
          }, 300));
        }

        if (clearSearchBtn) {
          clearSearchBtn.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';
            cancellationsFilters.search = '';
            renderFilteredCancellations();
          });
        }

        // Filter functionality
        if (statusFilter) {
          statusFilter.addEventListener('change', () => {
            cancellationsFilters.status = statusFilter.value;
            renderFilteredCancellations();
          });
        }

        if (reasonFilter) {
          reasonFilter.addEventListener('change', () => {
            cancellationsFilters.reason = reasonFilter.value;
            renderFilteredCancellations();
          });
        }

        // Select all checkbox
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', () => {
            const checkboxes = document.querySelectorAll('.cancellation-checkbox');
            checkboxes.forEach(cb => {
              cb.checked = selectAllCheckbox.checked;
              updateCancellationSelection(cb.dataset.id, cb.checked);
            });
            updateCancellationsBulkActionsState();
          });
        }

        // Select all button
        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', () => {
            const allCheckboxes = document.querySelectorAll('.cancellation-checkbox');
            const allSelected = selectedCancellations.size === allCheckboxes.length;
            const newState = !allSelected;

            allCheckboxes.forEach(cb => {
              cb.checked = newState;
              updateCancellationSelection(cb.dataset.id, newState);
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = newState;
            updateCancellationsBulkActionsState();
          });
        }

        // Bulk delete button
        if (bulkDeleteBtn) {
          bulkDeleteBtn.addEventListener('click', async () => {
            if (selectedCancellations.size === 0) return;
            const confirmed = await showConfirmModal({
              title: 'Delete Selected Cancellations',
              message: `Are you sure you want to delete ${selectedCancellations.size} selected cancellation(s)? This action cannot be undone.`,
              confirmText: 'Yes, Delete',
              cancelText: 'Cancel',
              type: 'danger'
            });
            if (!confirmed) return;

            for (const id of selectedCancellations) {
              try {
                await apiRequest(`/cancellations/${id}`, { method: 'DELETE' });
              } catch (e) {
                console.error(`Failed to delete cancellation ${id}:`, e);
              }
            }
            showNotification('Selected cancellations deleted successfully', 'success');
            selectedCancellations.clear();
            updateCancellationsBulkActionsState();
            await fetchCancellations();
          });
        }

        // Bulk status update button
        if (bulkStatusBtn) {
          bulkStatusBtn.addEventListener('click', async () => {
            if (selectedCancellations.size === 0) return;
            
            // Create status selection modal
            const statusOptions = ['Pending', 'Approved', 'Rejected', 'Refunded', 'Completed'];
            const statusSelect = statusOptions.map(s => `<option value="${s}">${s}</option>`).join('');
            
            const modalContent = `
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select new status for ${selectedCancellations.size} cancellation(s):</label>
                <select id="bulkCancellationStatusSelect" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                  ${statusSelect}
                </select>
              </div>
            `;
            
            showModal('Bulk Update Status', modalContent, async () => {
              const newStatus = document.getElementById('bulkCancellationStatusSelect')?.value;
              if (!newStatus) return;
              
              let success = 0, failed = 0;
              for (const id of selectedCancellations) {
                try {
                  await apiRequest(`/cancellations/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus })
                  });
                  success++;
                } catch (e) {
                  console.error(`Failed to update cancellation ${id}:`, e);
                  failed++;
                }
              }
              
              selectedCancellations.clear();
              updateCancellationsBulkActionsState();
              await fetchCancellations();
              showNotification(`Updated ${success} cancellation(s)${failed ? `, ${failed} failed` : ''}`, failed ? 'warning' : 'success');
            });
          });
        }
      }

      function updateCancellationSelection(cancellationId, selected) {
        if (selected) {
          selectedCancellations.add(cancellationId);
        } else {
          selectedCancellations.delete(cancellationId);
        }
        updateCancellationsBulkActionsState();
      }

      function updateCancellationsBulkActionsState() {
        const bulkStatusBtn = document.getElementById('bulkCancellationStatusBtn');
        const bulkDeleteBtn = document.getElementById('bulkCancellationDeleteBtn');
        const hasSelection = selectedCancellations.size > 0;
        if (bulkStatusBtn) bulkStatusBtn.disabled = !hasSelection;
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !hasSelection;
      }

      function renderFilteredCancellations() {
        let filtered = [...cancellations];

        if (cancellationsFilters.search) {
          filtered = filtered.filter(canc => {
            const searchStr = cancellationsFilters.search;
            return (
              (canc.id || '').toLowerCase().includes(searchStr) ||
              (canc.orderId || '').toLowerCase().includes(searchStr) ||
              (canc.customer?.name || '').toLowerCase().includes(searchStr) ||
              (canc.customer?.email || '').toLowerCase().includes(searchStr)
            );
          });
        }

        if (cancellationsFilters.status) {
          filtered = filtered.filter(canc => canc.status === cancellationsFilters.status);
        }

        if (cancellationsFilters.reason) {
          filtered = filtered.filter(canc => canc.reason === cancellationsFilters.reason);
        }

        renderCancellationsTable(filtered);
      }

      // Override renderCancellations to use filtered version
      const originalRenderCancellations = renderCancellations;
      renderCancellations = function() {
        renderFilteredCancellations();
      };

      // ==========================================
      // HEALTH MONITORING FUNCTIONALITY
      // ==========================================
      
      let healthData = null;
      let healthCheckInterval = null;
      const HEALTH_CHECK_INTERVAL = 30000; // Check every 30 seconds

      // Fetch detailed health data from API
      async function fetchHealthData() {
        try {
          const startTime = Date.now();
          const response = await fetch(`${API_BASE}/health/detailed`, {
            credentials: 'include',
            cache: 'no-cache'
          });
          const latency = Date.now() - startTime;
          
          if (!response.ok) throw new Error('Health check failed');
          
          healthData = await response.json();
          healthData.clientLatency = latency + 'ms';
          
          return healthData;
        } catch (error) {
          console.error('Health check error:', error);
          return {
            status: 'error',
            error: error.message,
            timestamp: new Date().toISOString()
          };
        }
      }

      // Check individual API endpoint
      async function checkEndpoint(endpoint) {
        try {
          const startTime = Date.now();
          const response = await fetch(`${API_BASE}${endpoint}`, {
            method: 'GET',
            credentials: 'include',
            cache: 'no-cache'
          });
          const latency = Date.now() - startTime;
          
          // 401 is expected for protected endpoints when checking without auth
          // 200, 201, 401, 403 all indicate the endpoint is working
          const isHealthy = response.ok || response.status === 401 || response.status === 403;
          
          return {
            endpoint,
            healthy: isHealthy,
            latency: latency + 'ms',
            status: response.status
          };
        } catch (error) {
          return {
            endpoint,
            healthy: false,
            latency: '--',
            error: error.message
          };
        }
      }

      // Render health overview cards
      function renderHealthOverview(data) {
        const statusBadge = document.getElementById('healthStatusBadge');
        const statusText = statusBadge?.querySelector('.status-text');
        
        // Update main status badge
        statusBadge?.classList.remove('healthy', 'degraded', 'error');
        if (data.status === 'healthy') {
          statusBadge?.classList.add('healthy');
          statusText && (statusText.textContent = 'All Systems Operational');
        } else if (data.status === 'degraded') {
          statusBadge?.classList.add('degraded');
          statusText && (statusText.textContent = 'Some Issues Detected');
        } else {
          statusBadge?.classList.add('error');
          statusText && (statusText.textContent = 'System Error');
        }

        // Server Status Card
        const serverCard = document.getElementById('serverStatusCard');
        serverCard?.classList.remove('healthy', 'degraded', 'error');
        serverCard?.classList.add(data.status || 'error');
        document.getElementById('serverStatus').textContent = data.status === 'healthy' ? 'Online' : data.status === 'degraded' ? 'Degraded' : 'Offline';
        document.getElementById('serverUptime').textContent = 'Uptime: ' + (data.server?.uptime || '--');

        // Database Status Card
        const dbCard = document.getElementById('databaseStatusCard');
        const dbHealthy = data.database?.healthy;
        dbCard?.classList.remove('healthy', 'degraded', 'error');
        dbCard?.classList.add(dbHealthy ? 'healthy' : 'error');
        document.getElementById('databaseStatus').textContent = dbHealthy ? 'Healthy' : 'Issues';
        document.getElementById('databaseSize').textContent = 'Size: ' + (data.database?.totalSize || '--');

        // Uploads Status Card
        const uploadsCard = document.getElementById('uploadsStatusCard');
        const uploadsHealthy = data.uploads?.healthy;
        uploadsCard?.classList.remove('healthy', 'degraded', 'error');
        uploadsCard?.classList.add(uploadsHealthy ? 'healthy' : 'error');
        document.getElementById('uploadsStatus').textContent = uploadsHealthy ? 'Healthy' : 'Issues';
        document.getElementById('uploadsCount').textContent = 'Files: ' + (data.uploads?.totalFiles || 0) + ' (' + (data.uploads?.totalSize || '0 B') + ')';

        // Response Time Card
        const responseCard = document.getElementById('responseTimeCard');
        const responseTime = parseInt(data.clientLatency || data.responseTime || '0');
        responseCard?.classList.remove('healthy', 'degraded', 'error');
        responseCard?.classList.add(responseTime < 200 ? 'healthy' : responseTime < 500 ? 'degraded' : 'error');
        document.getElementById('responseTime').textContent = data.clientLatency || data.responseTime || '--';
      }

      // Render system resources
      function renderSystemResources(data) {
        // CPU
        const cpuPercent = parseFloat(data.cpu?.usagePercent || '0');
        document.getElementById('cpuUsage').textContent = data.cpu?.usagePercent || '--%';
        const cpuBar = document.getElementById('cpuBar');
        cpuBar.style.width = cpuPercent + '%';
        cpuBar.classList.remove('warning', 'critical');
        if (cpuPercent > 80) cpuBar.classList.add('critical');
        else if (cpuPercent > 60) cpuBar.classList.add('warning');
        document.getElementById('cpuDetails').textContent = `Cores: ${data.cpu?.cores || '--'} | ${data.cpu?.model || 'Unknown'}`;

        // Memory
        const memPercent = parseFloat(data.memory?.system?.usedPercent || '0');
        document.getElementById('memoryUsage').textContent = data.memory?.system?.usedPercent || '--%';
        const memBar = document.getElementById('memoryBar');
        memBar.style.width = memPercent + '%';
        memBar.classList.remove('warning', 'critical');
        if (memPercent > 90) memBar.classList.add('critical');
        else if (memPercent > 70) memBar.classList.add('warning');
        document.getElementById('memoryDetails').textContent = `Used: ${data.memory?.system?.used || '--'} / Total: ${data.memory?.system?.total || '--'}`;

        // Heap Memory
        const heapPercent = parseFloat(data.memory?.process?.heapUsedPercent || '0');
        document.getElementById('heapUsage').textContent = data.memory?.process?.heapUsedPercent || '--%';
        document.getElementById('heapBar').style.width = heapPercent + '%';
        document.getElementById('heapDetails').textContent = `Used: ${data.memory?.process?.heapUsed || '--'} / Total: ${data.memory?.process?.heapTotal || '--'}`;
      }

      // Render API endpoints status
      async function renderApiEndpoints(endpoints) {
        const grid = document.getElementById('apiEndpointsGrid');
        if (!grid) return;

        const endpointsList = endpoints?.list || [
          '/auth/me', '/products', '/orders', '/users', 
          '/cart', '/returns', '/contact', '/slides', '/wishlist', '/health'
        ];

        // Initial render with checking state
        grid.innerHTML = endpointsList.map(ep => `
          <div class="endpoint-card checking" data-endpoint="${ep}">
            <div class="endpoint-status-dot checking"></div>
            <span class="endpoint-name">${ep}</span>
            <span class="endpoint-latency">checking...</span>
          </div>
        `).join('');

        // Check each endpoint
        for (const ep of endpointsList) {
          const result = await checkEndpoint(ep);
          const card = grid.querySelector(`[data-endpoint="${ep}"]`);
          if (card) {
            card.classList.remove('checking');
            card.classList.add(result.healthy ? 'healthy' : 'error');
            card.querySelector('.endpoint-status-dot').classList.remove('checking');
            card.querySelector('.endpoint-status-dot').classList.add(result.healthy ? 'healthy' : 'error');
            card.querySelector('.endpoint-latency').textContent = result.healthy ? result.latency : 'error';
          }
        }
      }

      // Render database files status
      function renderDatabaseFiles(database) {
        const grid = document.getElementById('databaseFilesGrid');
        if (!grid || !database?.files) return;

        grid.innerHTML = Object.entries(database.files).map(([name, info]) => `
          <div class="file-card ${info.status}">
            <div class="file-card-icon">
              <i class="ri-file-text-line"></i>
            </div>
            <div class="file-card-name">${name}</div>
            <div class="file-card-meta">
              ${info.status === 'ok' ? info.size : info.status === 'missing' ? 'Not found' : 'Error'}
            </div>
          </div>
        `).join('');
      }

      // Render upload folders status
      function renderUploadFolders(uploads) {
        const grid = document.getElementById('uploadFoldersGrid');
        if (!grid || !uploads?.folders) return;

        grid.innerHTML = Object.entries(uploads.folders).map(([name, info]) => `
          <div class="folder-card ${info.status}">
            <div class="folder-card-icon">
              <i class="ri-folder-${info.status === 'ok' ? 'open' : 'warning'}-line"></i>
            </div>
            <div class="folder-card-name">/uploads/${name}</div>
            <div class="folder-card-meta">
              ${info.status === 'ok' ? `${info.fileCount} files (${info.size})` : info.status}
            </div>
          </div>
        `).join('');
      }

      // Render server info
      function renderServerInfo(data) {
        document.getElementById('infoPlatform').textContent = data.system?.platform || '--';
        document.getElementById('infoArch').textContent = data.system?.arch || '--';
        document.getElementById('infoNodeVersion').textContent = data.system?.nodeVersion || '--';
        document.getElementById('infoEnv').textContent = data.server?.environment || '--';
        document.getElementById('infoStartedAt').textContent = data.server?.startedAt 
          ? new Date(data.server.startedAt).toLocaleString() 
          : '--';
        
        // Calculate and display uptime duration with live updates
        const uptimeEl = document.getElementById('infoUptimeDuration');
        if (uptimeEl && data.server?.startedAt) {
          // Show the uptime from server
          uptimeEl.textContent = data.server.uptime || '--';
          
          // Store the start time for live updates
          uptimeEl.dataset.startTime = data.server.startedAt;
          
          // Start live uptime counter if not already running
          if (!window.uptimeInterval) {
            window.uptimeInterval = setInterval(() => {
              const el = document.getElementById('infoUptimeDuration');
              if (el && el.dataset.startTime) {
                const startTime = new Date(el.dataset.startTime).getTime();
                const now = Date.now();
                const diff = now - startTime;
                el.textContent = formatUptimeDuration(diff);
              }
            }, 1000);
          }
        } else {
          uptimeEl.textContent = data.server?.uptime || '--';
        }
        
        document.getElementById('infoLastChecked').textContent = new Date().toLocaleString();
      }
      
      // Format uptime duration in human readable format
      function formatUptimeDuration(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
          return `${days}d ${hours % 24}h ${minutes % 60}m ${seconds % 60}s`;
        }
        if (hours > 0) {
          return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
        }
        if (minutes > 0) {
          return `${minutes}m ${seconds % 60}s`;
        }
        return `${seconds}s`;
      }

      // Main health check function
      async function runHealthCheck() {
        const refreshBtn = document.getElementById('refreshHealthBtn');
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Checking...';
        }

        const data = await fetchHealthData();
        
        if (data && !data.error) {
          renderHealthOverview(data);
          renderSystemResources(data);
          renderApiEndpoints(data.endpoints);
          renderDatabaseFiles(data.database);
          renderUploadFolders(data.uploads);
          renderServerInfo(data);
        } else {
          // Show error state
          const statusBadge = document.getElementById('healthStatusBadge');
          statusBadge?.classList.remove('healthy', 'degraded');
          statusBadge?.classList.add('error');
          const statusText = statusBadge?.querySelector('.status-text');
          statusText && (statusText.textContent = 'Connection Failed');
        }

        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="ri-refresh-line"></i> Refresh';
        }
      }

      // Initialize health monitoring
      function initializeHealthMonitoring() {
        // Initial check
        runHealthCheck();

        // Set up auto-refresh
        if (healthCheckInterval) clearInterval(healthCheckInterval);
        healthCheckInterval = setInterval(runHealthCheck, HEALTH_CHECK_INTERVAL);

        // Refresh button handler
        document.getElementById('refreshHealthBtn')?.addEventListener('click', runHealthCheck);

        // Stop auto-refresh when leaving the health section
        window.addEventListener('hashchange', () => {
          if (window.location.hash !== '#health') {
            clearInterval(healthCheckInterval);
            healthCheckInterval = null;
          } else if (!healthCheckInterval) {
            runHealthCheck();
            healthCheckInterval = setInterval(runHealthCheck, HEALTH_CHECK_INTERVAL);
          }
        });
      }

      // Initialize health monitoring when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeHealthMonitoring);
      } else {
        initializeHealthMonitoring();
      }
    </script>

    <!-- New Admin Sections JavaScript -->
    <script>
      // Helper to get full API URL (handles Live Server port mismatch)
      const getApiUrl = (path) => {
        const baseUrl = (typeof API !== 'undefined' && typeof API.getBaseUrl === 'function') 
          ? API.getBaseUrl() 
          : window.location.origin;
        return `${baseUrl}${path}`;
      };

      // ===============================
      // SKU & BARCODE MANAGEMENT
      // ===============================
      async function loadSkuData() {
        try {
          const response = await fetch(getApiUrl(`/api/inventory/sku?_=${Date.now()}`), { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const products = data.products || [];
            const withSku = products.filter(p => p.sku);
            const withoutSku = products.filter(p => !p.sku);
            const withBarcode = products.filter(p => p.barcode);
            
            document.getElementById('skuProductCount').textContent = withSku.length;
            document.getElementById('noSkuCount').textContent = withoutSku.length;
            document.getElementById('barcodeCount').textContent = withBarcode.length;
            
            renderSkuTable(products);
          } else {
            console.error('Failed to load SKU data:', data.error);
            document.getElementById('skuTableBody').innerHTML = `<tr><td colspan="5" style="text-align:center; color:#ef4444;">Error: ${data.error || 'Failed to load data'}</td></tr>`;
          }
        } catch (error) {
          console.error('Error loading SKU data:', error);
          document.getElementById('skuTableBody').innerHTML = `<tr><td colspan="5" style="text-align:center; color:#ef4444;">Connection error. Is the server running?</td></tr>`;
        }
      }
      
      function renderSkuTable(products) {
        const tbody = document.getElementById('skuTableBody');
        if (!products.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6b7280;">No products found</td></tr>';
          return;
        }
        
        tbody.innerHTML = products.map(p => {
          const createdDate = p.skuCreatedAt || p.createdAt || p.updatedAt;
          const escapedName = (p.name || 'Unnamed').replace(/'/g, "\\'");
          return `
            <tr>
              <td>${p.name || 'Unnamed'}</td>
              <td><code style="background:#f3f4f6;padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="editManualSku('${p.id}', '${p.sku || ''}')" title="Click to edit manually">${p.sku || '<span style="color:#9ca3af">Not Set</span>'}</code></td>
              <td><code style="background:#f3f4f6;padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="editManualBarcode('${p.id}', '${p.barcode || ''}')" title="Click to edit manually">${p.barcode || '<span style="color:#9ca3af">Not Set</span>'}</code></td>
              <td>${createdDate ? new Date(createdDate).toLocaleDateString() : '-'}</td>
              <td class="actions">
                <button onclick="generateSku('${p.id}')" title="${p.sku ? 'Regenerate' : 'Generate'} SKU"><i class="ri-qr-code-line"></i></button>
                <button onclick="generateBarcode('${p.id}')" title="${p.barcode ? 'Regenerate' : 'Generate'} Barcode"><i class="ri-barcode-line"></i></button>
              </td>
            </tr>
          `;
        }).join('');
      }

      async function editManualSku(productId, currentSku) {
        const newSku = await AdminUniModal.prompt('Edit SKU', 'Enter a manual SKU for this product', currentSku, 'Enter SKU code');
        if (newSku === null) return;
        
        try {
          const response = await fetch(`/api/inventory/sku/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ sku: newSku })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('SKU updated successfully', 'success');
            loadSkuData();
          } else {
            showNotification(data.error || 'Failed to update SKU', 'error');
          }
        } catch (error) {
          showNotification('Error updating SKU', 'error');
        }
      }

      async function editManualBarcode(productId, currentBarcode) {
        const newBarcode = await AdminUniModal.prompt('Edit Barcode', 'Enter a manual barcode for this product', currentBarcode, 'Enter barcode');
        if (newBarcode === null) return;
        
        try {
          const response = await fetch(`/api/inventory/barcode/${productId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ barcode: newBarcode })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Barcode updated successfully', 'success');
            loadSkuData();
          } else {
            showNotification(data.error || 'Failed to update barcode', 'error');
          }
        } catch (error) {
          showNotification('Error updating barcode', 'error');
        }
      }
      
      async function generateSku(productId) {
        try {
          const response = await fetch(`/api/inventory/sku/${productId}`, {
            method: 'POST',
            credentials: 'include'
          });
          const data = await response.json();
          if (data.success) {
            showNotification('SKU generated successfully', 'success');
            loadSkuData();
          } else {
            showNotification(data.error || 'Failed to generate SKU', 'error');
          }
        } catch (error) {
          showNotification('Error generating SKU', 'error');
        }
      }
      
      async function generateBarcode(productId) {
        try {
          const response = await fetch(`/api/inventory/barcode/${productId}`, {
            method: 'POST',
            credentials: 'include'
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Barcode generated successfully', 'success');
            loadSkuData();
          } else {
            showNotification(data.error || 'Failed to generate barcode', 'error');
          }
        } catch (error) {
          showNotification('Error generating barcode', 'error');
        }
      }
      
      document.getElementById('generateAllSkuBtn')?.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/inventory/sku/generate-all', {
            method: 'POST',
            credentials: 'include'
          });
          const data = await response.json();
          if (data.success) {
            showNotification(`Generated ${data.generated} SKUs`, 'success');
            loadSkuData();
          }
        } catch (error) {
          showNotification('Error generating SKUs', 'error');
        }
      });

      // ===============================
      // INVENTORY & STOCK MANAGEMENT
      // ===============================
      async function loadInventoryData() {
        try {
          const response = await fetch(getApiUrl(`/api/inventory/stock?_=${Date.now()}`), { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const products = data.inventory?.products || data.products || [];
            const threshold = parseInt(document.getElementById('lowStockThreshold')?.value) || 10;
            const inStock = products.filter(p => p.stock > threshold);
            const lowStock = products.filter(p => p.stock > 0 && p.stock <= threshold);
            const outOfStock = products.filter(p => p.stock === 0);
            const totalUnits = products.reduce((sum, p) => sum + (p.stock || 0), 0);
            
            document.getElementById('inStockCount').textContent = inStock.length;
            document.getElementById('lowStockCount').textContent = lowStock.length;
            document.getElementById('outOfStockCount').textContent = outOfStock.length;
            document.getElementById('totalUnitsCount').textContent = totalUnits;
            
            renderInventoryTable(products, threshold);
          } else {
            console.error('Failed to load inventory:', data.error);
            document.getElementById('inventoryTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ef4444;">Error: ${data.error || 'Failed to load data'}</td></tr>`;
          }
        } catch (error) {
          console.error('Error loading inventory:', error);
          document.getElementById('inventoryTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ef4444;">Connection error. Is the server running?</td></tr>`;
        }
      }
      
      function renderInventoryTable(products, threshold = 10) {
        const tbody = document.getElementById('inventoryTableBody');
        if (!products.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No products found</td></tr>';
          return;
        }
        
        tbody.innerHTML = products.map(p => {
          let statusClass = 'status-active';
          let statusText = 'In Stock';
          if (p.stock === 0) {
            statusClass = 'status-inactive';
            statusText = 'Out of Stock';
          } else if (p.stock <= threshold) {
            statusClass = 'status-expired';
            statusText = 'Low Stock';
          }
          
          const escapedName = (p.name || 'Unnamed').replace(/'/g, "\\'");
          const lastUpdated = p.stockUpdatedAt || p.lastRestocked || p.updatedAt;
          
          return `
            <tr>
              <td>${p.name || 'Unnamed'}</td>
              <td><code style="background:#f3f4f6;padding:4px 8px;border-radius:4px;">${p.sku || '-'}</code></td>
              <td><strong>${p.stock || 0}</strong></td>
              <td><span class="${statusClass}">${statusText}</span></td>
              <td>${lastUpdated ? new Date(lastUpdated).toLocaleDateString() : '-'}</td>
              <td class="actions">
                <button onclick="openStockModal('${p.id}', '${escapedName}', ${p.stock || 0})" title="Update Stock">
                  <i class="ri-edit-line"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      function openStockModal(productId, productName, currentStock) {
        document.getElementById('stockProductId').value = productId;
        document.getElementById('stockProductName').value = productName;
        document.getElementById('newStockValue').value = currentStock;
        document.getElementById('stockUpdateModal').style.display = 'flex';
      }
      
      function closeStockModal() {
        document.getElementById('stockUpdateModal').style.display = 'none';
      }
      
      document.getElementById('saveStockBtn')?.addEventListener('click', async () => {
        const productId = document.getElementById('stockProductId').value;
        const newStock = document.getElementById('newStockValue').value;
        const reason = document.getElementById('stockUpdateReason').value;
        
        try {
          const response = await fetch(`/api/inventory/stock/${productId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ stock: parseInt(newStock), reason })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Stock updated successfully', 'success');
            closeStockModal();
            loadInventoryData();
          } else {
            showNotification(data.error || 'Failed to update stock', 'error');
          }
        } catch (error) {
          showNotification('Error updating stock', 'error');
        }
      });
      
      // Update low stock threshold button handler
      document.getElementById('updateThresholdBtn')?.addEventListener('click', async () => {
        const threshold = parseInt(document.getElementById('lowStockThreshold').value) || 10;
        try {
          // Update threshold for all products
          const response = await fetch('/api/inventory/threshold/bulk', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ threshold })
          });
          showNotification(`Low stock threshold updated to ${threshold}`, 'success');
          loadInventoryData();
        } catch (error) {
          // Local update as fallback
          showNotification(`Threshold set to ${threshold}`, 'success');
          loadInventoryData();
        }
      });
      
      // Export inventory button handler
      document.getElementById('exportInventoryBtn')?.addEventListener('click', () => {
        try {
          // Get current inventory data and export as CSV
          const rows = [['Product Name', 'SKU', 'Stock', 'Status', 'Last Updated']];
          document.querySelectorAll('#inventoryTableBody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
              rows.push([
                cells[0]?.textContent?.trim() || '',
                cells[1]?.textContent?.trim() || '',
                cells[2]?.textContent?.trim() || '',
                cells[3]?.textContent?.trim() || '',
                new Date().toLocaleDateString()
              ]);
            }
          });
          
          const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `inventory-export-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          
          showNotification('Inventory exported successfully', 'success');
        } catch (error) {
          showNotification('Error exporting inventory', 'error');
        }
      });

      // ===============================
      // MARKETING & PROMOTIONS
      // ===============================
      let marketingSettings = {};
      
      async function loadMarketingSettings() {
        try {
          const response = await fetch(getApiUrl('/api/marketing/settings'), { credentials: 'include' });
          const data = await response.json();
          if (data.success) {
            marketingSettings = data.settings;
            const toggleCoupons = document.getElementById('toggleCoupons');
            const toggleSales = document.getElementById('toggleSales');
            const toggleBundles = document.getElementById('toggleBundles');
            const toggleGiftCards = document.getElementById('toggleGiftCards');
            const togglePopups = document.getElementById('togglePopups');
            
            if (toggleCoupons) toggleCoupons.checked = data.settings.couponsEnabled || false;
            if (toggleSales) toggleSales.checked = data.settings.salesEnabled || false;
            if (toggleBundles) toggleBundles.checked = data.settings.bundlesEnabled || false;
            if (toggleGiftCards) toggleGiftCards.checked = data.settings.giftCardsEnabled || false;
            if (togglePopups) togglePopups.checked = data.settings.popupsEnabled || false;
          }
        } catch (error) {
          // Silently handle - marketing settings will use defaults
        }
      }
      
      // Marketing toggle handlers
      document.querySelectorAll('.marketing-toggle').forEach(toggle => {
        toggle.addEventListener('change', async (e) => {
          const feature = e.target.dataset.feature;
          const enabled = e.target.checked;
          
          try {
            const response = await fetch('/api/marketing/settings', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ [feature]: enabled })
            });
            const data = await response.json();
            if (data.success) {
              showNotification(`${feature.replace('Enabled', '')} ${enabled ? 'enabled' : 'disabled'}`, 'success');
            }
          } catch (error) {
            e.target.checked = !enabled;
            showNotification('Failed to update setting', 'error');
          }
        });
      });
      
      // Marketing tab switching
      document.querySelectorAll('.marketing-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.marketing-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.marketing-tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
          loadMarketingTab(btn.dataset.tab);
        });
      });
      
      async function loadMarketingTab(tab) {
        switch(tab) {
          case 'coupons': loadCoupons(); break;
          case 'sales': loadSales(); break;
          case 'bundles': loadBundles(); break;
          case 'giftcards': loadMarketingGiftCards(); break;
          case 'popups': loadPopups(); break;
        }
      }
      
      async function loadCoupons() {
        try {
          const response = await fetch('/api/marketing/coupons', { credentials: 'include' });
          const data = await response.json();
          renderCouponsTable(data.coupons || []);
        } catch (error) {
          console.error('Error loading coupons:', error);
        }
      }
      
      function renderCouponsTable(coupons) {
        const tbody = document.getElementById('couponsTableBody');
        if (!coupons.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#6b7280;">No coupons created yet</td></tr>';
          return;
        }
        tbody.innerHTML = coupons.map(c => `
          <tr>
            <td><code style="font-weight:600;">${c.code}</code></td>
            <td>${c.type === 'percentage' ? 'Percentage' : 'Fixed Amount'}</td>
            <td>${c.type === 'percentage' ? c.value + '%' : '' + c.value}</td>
            <td>${c.minOrderValue || 0}</td>
            <td>${c.usedCount || 0} / ${c.maxUses || ''}</td>
            <td>${c.expiresAt ? new Date(c.expiresAt).toLocaleDateString() : 'Never'}</td>
            <td><span class="${c.active ? 'status-active' : 'status-inactive'}">${c.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deleteCoupon('${c.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteCoupon(id) {
        const confirmed = await AdminUniModal.danger('Delete Coupon', 'Are you sure you want to delete this coupon?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/marketing/coupons/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Coupon deleted', 'success');
          loadCoupons();
        } catch (error) {
          showNotification('Error deleting coupon', 'error');
        }
      }
      
      async function loadSales() {
        try {
          const response = await fetch('/api/marketing/sales', { credentials: 'include' });
          const data = await response.json();
          renderSalesTable(data.sales || []);
        } catch (error) {
          console.error('Error loading sales:', error);
        }
      }
      
      function renderSalesTable(sales) {
        const tbody = document.getElementById('salesTableBody');
        if (!sales.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No sales created yet</td></tr>';
          return;
        }
        tbody.innerHTML = sales.map(s => `
          <tr>
            <td>${s.name}</td>
            <td>${s.discountPercentage}%</td>
            <td>${new Date(s.startDate).toLocaleDateString()}</td>
            <td>${new Date(s.endDate).toLocaleDateString()}</td>
            <td>${s.productIds?.length || 'All'}</td>
            <td><span class="${s.active ? 'status-active' : 'status-inactive'}">${s.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deleteSale('${s.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteSale(id) {
        const confirmed = await AdminUniModal.danger('Delete Sale', 'Are you sure you want to delete this sale?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/marketing/sales/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Sale deleted', 'success');
          loadSales();
        } catch (error) {
          showNotification('Error deleting sale', 'error');
        }
      }
      
      async function loadBundles() {
        try {
          const response = await fetch('/api/marketing/bundles', { credentials: 'include' });
          const data = await response.json();
          renderBundlesTable(data.bundles || []);
        } catch (error) {
          console.error('Error loading bundles:', error);
        }
      }
      
      function renderBundlesTable(bundles) {
        const tbody = document.getElementById('bundlesTableBody');
        if (!bundles.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No bundles created yet</td></tr>';
          return;
        }
        tbody.innerHTML = bundles.map(b => `
          <tr>
            <td>${b.name}</td>
            <td>${b.productIds?.length || 0} items</td>
            <td>${b.bundlePrice}</td>
            <td>${b.savings || 0}</td>
            <td><span class="${b.active ? 'status-active' : 'status-inactive'}">${b.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deleteBundle('${b.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteBundle(id) {
        const confirmed = await AdminUniModal.danger('Delete Bundle', 'Are you sure you want to delete this bundle?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/marketing/bundles/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Bundle deleted', 'success');
          loadBundles();
        } catch (error) {
          showNotification('Error deleting bundle', 'error');
        }
      }
      
      async function loadMarketingGiftCards() {
        try {
          const response = await fetch('/api/marketing/giftcards', { credentials: 'include' });
          const data = await response.json();
          renderMarketingGiftCardsTable(data.giftCards || []);
        } catch (error) {
          console.error('Error loading gift cards:', error);
        }
      }
      
      function renderMarketingGiftCardsTable(cards) {
        const tbody = document.getElementById('giftCardsTableBody');
        if (!cards.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No gift cards created yet</td></tr>';
          return;
        }
        tbody.innerHTML = cards.map(c => `
          <tr>
            <td><code style="font-weight:600;">${c.code}</code></td>
            <td>${c.value}</td>
            <td>${c.balance}</td>
            <td>${c.recipientEmail || '-'}</td>
            <td>${c.expiresAt ? new Date(c.expiresAt).toLocaleDateString() : 'Never'}</td>
            <td><span class="${c.active ? 'status-active' : 'status-inactive'}">${c.active ? 'Active' : 'Used'}</span></td>
            <td class="actions">
              <button onclick="deleteMarketingGiftCard('${c.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteMarketingGiftCard(id) {
        const confirmed = await AdminUniModal.danger('Delete Gift Card', 'Are you sure you want to delete this gift card?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/marketing/giftcards/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Gift card deleted', 'success');
          loadMarketingGiftCards();
        } catch (error) {
          showNotification('Error deleting gift card', 'error');
        }
      }
      
      async function loadPopups() {
        try {
          const response = await fetch('/api/marketing/popups', { credentials: 'include' });
          const data = await response.json();
          renderPopupsTable(data.popups || []);
        } catch (error) {
          console.error('Error loading popups:', error);
        }
      }
      
      function renderPopupsTable(popups) {
        const tbody = document.getElementById('popupsTableBody');
        if (!popups.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No popups created yet</td></tr>';
          return;
        }
        tbody.innerHTML = popups.map(p => `
          <tr>
            <td>${p.title}</td>
            <td>${p.type || 'promo'}</td>
            <td>${p.delaySeconds || 5}s</td>
            <td>${p.startDate ? new Date(p.startDate).toLocaleDateString() : 'Now'}</td>
            <td>${p.endDate ? new Date(p.endDate).toLocaleDateString() : 'Never'}</td>
            <td><span class="${p.active ? 'status-active' : 'status-inactive'}">${p.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deletePopup('${p.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deletePopup(id) {
        const confirmed = await AdminUniModal.danger('Delete Popup', 'Are you sure you want to delete this popup?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/marketing/popups/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Popup deleted', 'success');
          loadPopups();
        } catch (error) {
          showNotification('Error deleting popup', 'error');
        }
      }
      
      // Add button handlers for marketing section
      document.getElementById('addCouponBtn')?.addEventListener('click', () => showAddModal('coupon'));
      document.getElementById('addSaleBtn')?.addEventListener('click', () => showAddModal('sale'));
      document.getElementById('addBundleBtn')?.addEventListener('click', () => showAddModal('bundle'));
      document.getElementById('addGiftCardBtn')?.addEventListener('click', () => showAddModal('giftcard'));
      document.getElementById('addPopupBtn')?.addEventListener('click', () => showAddModal('popup'));
      
      // Generic add modal for marketing items
      function showAddModal(type) {
        var fields = '';
        var title = '';
        
        switch(type) {
          case 'coupon':
            title = 'Add Coupon';
            fields = '<label>Coupon Code<input type="text" id="modalCode" placeholder="e.g. SAVE20" required></label>' +
              '<label>Discount Type<select id="modalType"><option value="percentage">Percentage</option><option value="fixed">Fixed Amount</option></select></label>' +
              '<label>Value<input type="number" id="modalValue" placeholder="20" required></label>' +
              '<label>Min Order Value<input type="number" id="modalMinOrder" placeholder="500" value="0"></label>' +
              '<label>Max Uses<input type="number" id="modalMaxUses" placeholder="100" value="100"></label>' +
              '<label>Expiry Date<input type="date" id="modalExpiry"></label>';
            break;
          case 'sale':
            title = 'Create Sale';
            fields = '<label>Sale Name<input type="text" id="modalName" placeholder="Summer Sale" required></label>' +
              '<label>Discount %<input type="number" id="modalDiscount" placeholder="20" required></label>' +
              '<label>Start Date<input type="date" id="modalStart" required></label>' +
              '<label>End Date<input type="date" id="modalEnd" required></label>';
            break;
          case 'bundle':
            title = 'Create Bundle';
            fields = '<label>Bundle Name<input type="text" id="modalName" placeholder="Summer Combo" required></label>' +
              '<label>Bundle Price<input type="number" id="modalPrice" placeholder="999" required></label>' +
              '<label>Product IDs (comma separated)<input type="text" id="modalProducts" placeholder="prod1,prod2"></label>';
            break;
          case 'giftcard':
            title = 'Create Gift Card';
            fields = '<label>Value ()<input type="number" id="modalValue" placeholder="500" required></label>' +
              '<label>Quantity<input type="number" id="modalQty" placeholder="1" value="1"></label>' +
              '<label>Expiry Days<input type="number" id="modalDays" placeholder="365" value="365"></label>';
            break;
          case 'popup':
            title = 'Create Popup';
            fields = '<label>Title<input type="text" id="modalTitle" placeholder="Special Offer!" required></label>' +
              '<label>Content<textarea id="modalContent" placeholder="Get 20% off your first order!"></textarea></label>' +
              '<label>Delay (seconds)<input type="number" id="modalDelay" placeholder="5" value="5"></label>';
            break;
        }
        
        var modalHtml = '<div class="modal-overlay" id="addModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">' +
          '<div class="modal-content" style="background:#fff;padding:24px;border-radius:16px;width:90%;max-width:450px;">' +
            '<h3 style="margin:0 0 20px;">' + title + '</h3>' +
            '<form id="addModalForm" style="display:grid;gap:14px;">' +
              fields +
              '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:10px;">' +
                '<button type="button" onclick="closeAddModal()" class="secondary">Cancel</button>' +
                '<button type="submit" class="primary">Create</button>' +
              '</div>' +
            '</form>' +
          '</div>' +
        '</div>';
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Style labels
        document.querySelectorAll('#addModal label').forEach(function(l) {
          l.style.cssText = 'display:flex;flex-direction:column;gap:6px;font-weight:500;';
        });
        document.querySelectorAll('#addModal input, #addModal select, #addModal textarea').forEach(function(i) {
          i.style.cssText = 'padding:10px;border:1px solid #e5e7eb;border-radius:8px;';
        });
        
        document.getElementById('addModalForm').addEventListener('submit', function(e) {
          e.preventDefault();
          saveModalItem(type);
        });
      }
      
      function closeAddModal() {
        document.getElementById('addModal')?.remove();
      }
      
      async function saveModalItem(type) {
        var payload = {};
        var endpoint = '';
        
        switch(type) {
          case 'coupon':
            endpoint = '/api/marketing/coupons';
            payload = {
              code: document.getElementById('modalCode').value.toUpperCase(),
              type: document.getElementById('modalType').value,
              value: parseFloat(document.getElementById('modalValue').value),
              minOrderValue: parseFloat(document.getElementById('modalMinOrder').value) || 0,
              maxUses: parseInt(document.getElementById('modalMaxUses').value) || 100,
              expiresAt: document.getElementById('modalExpiry').value || null,
              active: true
            };
            break;
          case 'sale':
            endpoint = '/api/marketing/sales';
            payload = {
              name: document.getElementById('modalName').value,
              discountPercentage: parseFloat(document.getElementById('modalDiscount').value),
              startDate: document.getElementById('modalStart').value,
              endDate: document.getElementById('modalEnd').value,
              active: true
            };
            break;
          case 'bundle':
            endpoint = '/api/marketing/bundles';
            payload = {
              name: document.getElementById('modalName').value,
              bundlePrice: parseFloat(document.getElementById('modalPrice').value),
              productIds: (document.getElementById('modalProducts').value || '').split(',').map(function(s) { return s.trim(); }).filter(Boolean),
              active: true
            };
            break;
          case 'giftcard':
            endpoint = '/api/gift-cards';
            var qty = parseInt(document.getElementById('modalQty').value) || 1;
            var value = parseFloat(document.getElementById('modalValue').value);
            var days = parseInt(document.getElementById('modalDays').value) || 365;
            var cards = [];
            for (var i = 0; i < qty; i++) {
              var exp = new Date();
              exp.setDate(exp.getDate() + days);
              // Added code generation for gift cards
              var gcCode = 'BLK-' + Math.random().toString(36).substring(2, 6).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
              cards.push({ 
                code: gcCode,
                value: value, 
                balance: value, 
                expiresAt: exp.toISOString(), 
                status: 'active' 
              });
            }
            payload = { cards: cards };
            break;
          case 'popup':
            endpoint = '/api/marketing/popups';
            payload = {
              title: document.getElementById('modalTitle').value,
              content: document.getElementById('modalContent').value,
              delaySeconds: parseInt(document.getElementById('modalDelay').value) || 5,
              active: true
            };
            break;
        }
        
        try {
          var response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          var data = await response.json();
          if (data.success || response.ok) {
            showNotification(type.charAt(0).toUpperCase() + type.slice(1) + ' created!', 'success');
            closeAddModal();
            // Reload the appropriate table
            switch(type) {
              case 'coupon': loadCoupons(); break;
              case 'sale': loadSales(); break;
              case 'bundle': loadBundles(); break;
              case 'giftcard': loadMarketingGiftCards(); break;
              case 'popup': loadPopups(); break;
            }
          } else {
            showNotification(data.error || 'Failed to create ' + type, 'error');
          }
        } catch (error) {
          console.error('Error creating ' + type + ':', error);
          showNotification('Error creating ' + type, 'error');
        }
      }

      // ===============================
      // SHIPPING & LOGISTICS
      // ===============================
      async function loadShippingSettings() {
        try {
          const response = await fetch(getApiUrl('/api/shipping/settings'), { credentials: 'include' });
          const data = await response.json();
          if (data.success && data.settings) {
            document.getElementById('freeShippingThreshold').value = data.settings.freeShippingThreshold || 999;
            document.getElementById('defaultShippingRate').value = data.settings.defaultShippingRate || 49;
            document.getElementById('expressShippingRate').value = data.settings.expressShippingRate || 99;
            document.getElementById('codCharges').value = data.settings.codCharges || 40;
            document.getElementById('estimatedDaysStandard').value = data.settings.estimatedDaysStandard || '5-7';
            document.getElementById('estimatedDaysExpress').value = data.settings.estimatedDaysExpress || '2-3';
          }
        } catch (error) {
          console.error('Error loading shipping settings:', error);
        }
      }
      
      document.getElementById('shippingSettingsForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/shipping/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              freeShippingThreshold: parseFloat(document.getElementById('freeShippingThreshold').value),
              defaultShippingRate: parseFloat(document.getElementById('defaultShippingRate').value),
              expressShippingRate: parseFloat(document.getElementById('expressShippingRate').value),
              codCharges: parseFloat(document.getElementById('codCharges').value),
              estimatedDaysStandard: document.getElementById('estimatedDaysStandard').value,
              estimatedDaysExpress: document.getElementById('estimatedDaysExpress').value
            })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Shipping settings saved', 'success');
          } else {
            showNotification(data.error || 'Failed to save settings', 'error');
          }
        } catch (error) {
          showNotification('Error saving settings', 'error');
        }
      });
      
      // Shipping tab switching
      document.querySelectorAll('.shipping-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.shipping-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.shipping-tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
          loadShippingTab(btn.dataset.tab);
        });
      });
      
      async function loadShippingTab(tab) {
        switch(tab) {
          case 'shipping-settings': loadShippingSettings(); break;
          case 'shipping-zones': loadZones(); break;
          case 'shipping-couriers': loadCouriers(); break;
          case 'shipping-tracking': loadShipments(); break;
          case 'shipping-sla': loadSlaStats(); break;
          case 'shipping-rto': loadRtoRecords(); break;
        }
      }
      
      async function loadZones() {
        try {
          const response = await fetch('/api/shipping/zones', { credentials: 'include' });
          const data = await response.json();
          renderZonesTable(data.zones || []);
        } catch (error) {
          console.error('Error loading zones:', error);
        }
      }
      
      function renderZonesTable(zones) {
        const tbody = document.getElementById('zonesTableBody');
        if (!zones.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No zones created yet</td></tr>';
          return;
        }
        tbody.innerHTML = zones.map(z => `
          <tr>
            <td>${z.name}</td>
            <td>${z.states?.join(', ') || '-'}</td>
            <td>${z.rate}</td>
            <td>${z.estimatedDays} days</td>
            <td><span class="${z.active ? 'status-active' : 'status-inactive'}">${z.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deleteZone('${z.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteZone(id) {
        const confirmed = await AdminUniModal.danger('Delete Zone', 'Are you sure you want to delete this shipping zone?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/shipping/zones/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Zone deleted', 'success');
          loadZones();
        } catch (error) {
          showNotification('Error deleting zone', 'error');
        }
      }
      
      // Add Zone button handler
      document.getElementById('addZoneBtn')?.addEventListener('click', function() {
        var modalHtml = '<div class="modal-overlay" id="addZoneModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">' +
          '<div class="modal-content" style="background:#fff;padding:24px;border-radius:16px;width:90%;max-width:450px;">' +
            '<h3 style="margin:0 0 20px;">Add Shipping Zone</h3>' +
            '<form id="addZoneForm" style="display:grid;gap:14px;">' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Zone Name<input type="text" id="zoneName" placeholder="e.g. North India" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">States (comma separated)<input type="text" id="zoneStates" placeholder="e.g. Delhi, Punjab, Haryana" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Shipping Rate ()<input type="number" id="zoneRate" placeholder="49" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Estimated Days<input type="text" id="zoneDays" placeholder="3-5" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:10px;">' +
                '<button type="button" onclick="document.getElementById(\'addZoneModal\').remove()" class="secondary">Cancel</button>' +
                '<button type="submit" class="primary">Create Zone</button>' +
              '</div>' +
            '</form>' +
          '</div>' +
        '</div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('addZoneForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          try {
            var response = await fetch('/api/shipping/zones', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                name: document.getElementById('zoneName').value,
                states: document.getElementById('zoneStates').value.split(',').map(function(s) { return s.trim(); }).filter(Boolean),
                rate: parseFloat(document.getElementById('zoneRate').value),
                estimatedDays: document.getElementById('zoneDays').value,
                active: true
              })
            });
            if (response.ok) {
              showNotification('Zone created!', 'success');
              document.getElementById('addZoneModal').remove();
              loadZones();
            } else {
              const data = await response.json();
              showNotification(data.error || 'Failed to create zone', 'error');
            }
          } catch (error) {
            showNotification('Error creating zone', 'error');
          }
        });
      });
      
      async function loadCouriers() {
        try {
          const response = await fetch('/api/shipping/couriers', { credentials: 'include' });
          const data = await response.json();
          renderCouriersGrid(data.couriers || []);
        } catch (error) {
          console.error('Error loading couriers:', error);
        }
      }
      
      function renderCouriersGrid(couriers) {
        const grid = document.getElementById('couriersGrid');
        grid.innerHTML = couriers.map(c => `
          <div class="courier-card ${c.active ? 'active' : ''}">
            <div class="courier-card-header">
              <h4>${c.name}</h4>
              <span class="courier-priority">Priority: ${c.priority}</span>
            </div>
            <label class="toggle-switch-label">
              <input type="checkbox" ${c.active ? 'checked' : ''} onchange="toggleCourier('${c.id}', this.checked)">
              <span class="toggle-switch"></span>
              <span>${c.active ? 'Active' : 'Inactive'}</span>
            </label>
          </div>
        `).join('');
      }
      
      async function toggleCourier(id, active) {
        try {
          await fetch(`/api/shipping/couriers/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ active })
          });
          showNotification(`Courier ${active ? 'enabled' : 'disabled'}`, 'success');
          loadCouriers();
        } catch (error) {
          showNotification('Error updating courier', 'error');
        }
      }
      
      async function loadShipments() {
        try {
          const response = await fetch('/api/shipping/shipments', { credentials: 'include' });
          const data = await response.json();
          renderShipmentsTable(data.shipments || []);
        } catch (error) {
          console.error('Error loading shipments:', error);
        }
      }
      
      function renderShipmentsTable(shipments) {
        const tbody = document.getElementById('shipmentsTableBody');
        if (!shipments.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No shipments yet</td></tr>';
          return;
        }
        tbody.innerHTML = shipments.map(s => `
          <tr>
            <td><code>${s.trackingNumber}</code></td>
            <td>${s.orderId}</td>
            <td>${s.courier}</td>
            <td><span class="status-badge status-${s.status}">${s.status}</span></td>
            <td>${new Date(s.createdAt).toLocaleDateString()}</td>
            <td class="actions">
              <button onclick="viewShipment('${s.id}')" title="View"><i class="ri-eye-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function loadSlaStats() {
        try {
          const response = await fetch('/api/shipping/sla', { credentials: 'include' });
          const data = await response.json();
          if (data.success && data.sla) {
            document.getElementById('slaTotalShipments').textContent = data.sla.totalShipments;
            document.getElementById('slaDelivered').textContent = data.sla.delivered;
            document.getElementById('slaOnTimeRate').textContent = data.sla.onTimeRate + '%';
            document.getElementById('slaAvgDays').textContent = data.sla.avgDeliveryDays + ' days';
          }
        } catch (error) {
          console.error('Error loading SLA stats:', error);
        }
      }
      
      async function loadRtoRecords() {
        try {
          const response = await fetch('/api/shipping/rto', { credentials: 'include' });
          const data = await response.json();
          renderRtoTable(data.rtoRecords || []);
        } catch (error) {
          console.error('Error loading RTO records:', error);
        }
      }
      
      function renderRtoTable(records) {
        const tbody = document.getElementById('rtoTableBody');
        if (!records.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No RTO records</td></tr>';
          return;
        }
        tbody.innerHTML = records.map(r => `
          <tr>
            <td>${r.orderId}</td>
            <td>${r.reason}</td>
            <td><span class="status-badge">${r.status}</span></td>
            <td>${new Date(r.initiatedAt).toLocaleDateString()}</td>
            <td>${r.resolvedAt ? new Date(r.resolvedAt).toLocaleDateString() : '-'}</td>
            <td class="actions">
              ${r.status !== 'resolved' ? `<button onclick="resolveRto('${r.id}')" title="Resolve"><i class="ri-check-line"></i></button>` : ''}
            </td>
          </tr>
        `).join('');
      }
      
      async function resolveRto(id) {
        try {
          await fetch(`/api/shipping/rto/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'resolved', resolution: 'Resolved by admin' })
          });
          showNotification('RTO resolved', 'success');
          loadRtoRecords();
        } catch (error) {
          showNotification('Error resolving RTO', 'error');
        }
      }
      
      // Create Shipment button handler
      document.getElementById('createShipmentBtn')?.addEventListener('click', () => {
        openCreateShipmentModal();
      });
      
      async function openCreateShipmentModal() {
        // Get pending orders for shipment
        try {
          const response = await fetch('/api/orders?status=Processing,Confirmed', { credentials: 'include' });
          const data = await response.json();
          const orders = data.orders || [];
          
          const ordersOptions = orders.length > 0 
            ? orders.map(o => `<option value="${o.id}">#${o.orderNumber || o.id} - ${o.shippingAddress?.name || 'Customer'}</option>`).join('')
            : '<option value="">No pending orders</option>';
          
          // Get active couriers
          const courierRes = await fetch('/api/shipping/couriers', { credentials: 'include' });
          const courierData = await courierRes.json();
          const couriers = (courierData.couriers || []).filter(c => c.active);
          const courierOptions = couriers.length > 0 
            ? couriers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')
            : '<option value="manual">Manual Entry</option>';
          
          const modalHTML = `
            <div id="createShipmentModal" class="modal" style="display: flex;">
              <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                  <h3><i class="ri-truck-line"></i> Create Shipment</h3>
                  <button type="button" class="modal-close" onclick="closeShipmentModal()">&times;</button>
                </div>
                <form id="createShipmentForm">
                  <div class="modal-body">
                    <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                      Select Order
                      <select id="shipmentOrderId" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                        ${ordersOptions}
                      </select>
                    </label>
                    <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                      Courier Partner
                      <select id="shipmentCourier" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                        ${courierOptions}
                      </select>
                    </label>
                    <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                      Tracking Number
                      <input type="text" id="shipmentTrackingNumber" placeholder="Enter or auto-generate" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                      <label style="display: flex; flex-direction: column; gap: 8px;">
                        Weight (kg)
                        <input type="number" id="shipmentWeight" step="0.1" min="0.1" value="0.5" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                      </label>
                      <label style="display: flex; flex-direction: column; gap: 8px;">
                        Package Type
                        <select id="shipmentPackageType" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                          <option value="box">Box</option>
                          <option value="envelope">Envelope</option>
                          <option value="parcel">Parcel</option>
                        </select>
                      </label>
                    </div>
                  </div>
                  <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="secondary" onclick="closeShipmentModal()">Cancel</button>
                    <button type="submit" class="primary"><i class="ri-check-line"></i> Create Shipment</button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          // Remove any existing modal and add new one
          document.getElementById('createShipmentModal')?.remove();
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          
          // Add form submit handler
          document.getElementById('createShipmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createShipment();
          });
          
        } catch (error) {
          console.error('Error loading shipment data:', error);
          showNotification('Error loading orders', 'error');
        }
      }
      
      function closeShipmentModal() {
        document.getElementById('createShipmentModal')?.remove();
      }
      
      async function createShipment() {
        const orderId = document.getElementById('shipmentOrderId').value;
        const courier = document.getElementById('shipmentCourier').value;
        let trackingNumber = document.getElementById('shipmentTrackingNumber').value;
        const weight = document.getElementById('shipmentWeight').value;
        const packageType = document.getElementById('shipmentPackageType').value;
        
        if (!orderId) {
          showNotification('Please select an order', 'error');
          return;
        }
        
        // Auto-generate tracking number if not provided
        if (!trackingNumber) {
          trackingNumber = 'BLK' + Date.now().toString(36).toUpperCase();
        }
        
        try {
          const response = await fetch('/api/shipping/shipments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              orderId,
              courier,
              trackingNumber,
              weight: parseFloat(weight) || 0.5,
              dimensions: { type: packageType }
            })
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification('Shipment created successfully', 'success');
            closeShipmentModal();
            loadShipments();
          } else {
            showNotification(data.error || 'Failed to create shipment', 'error');
          }
        } catch (error) {
          console.error('Error creating shipment:', error);
          showNotification('Error creating shipment', 'error');
        }
      }

      // ===============================
      // TAX & GST SETTINGS
      // ===============================
      async function loadTaxSettings() {
        try {
          const response = await fetch(getApiUrl(`/api/tax/settings?_=${Date.now()}`), { credentials: 'include' });
          const data = await response.json();
          if (data.success) {
            // Populate state codes dropdown
            const stateSelect = document.getElementById('businessStateCode');
            if (data.stateCodes && data.stateCodes.length > 0) {
              stateSelect.innerHTML = data.stateCodes.map(state => 
                `<option value="${state.code}">${state.name}</option>`
              ).join('');
            } else {
              // Fallback state codes if backend fails to provide them
              const fallbackStates = [
                { code: '01', name: 'Jammu & Kashmir' }, { code: '02', name: 'Himachal Pradesh' },
                { code: '03', name: 'Punjab' }, { code: '04', name: 'Chandigarh' },
                { code: '05', name: 'Uttarakhand' }, { code: '06', name: 'Haryana' },
                { code: '07', name: 'Delhi' }, { code: '08', name: 'Rajasthan' },
                { code: '09', name: 'Uttar Pradesh' }, { code: '10', name: 'Bihar' },
                { code: '11', name: 'Sikkim' }, { code: '12', name: 'Arunachal Pradesh' },
                { code: '13', name: 'Nagaland' }, { code: '14', name: 'Manipur' },
                { code: '15', name: 'Mizoram' }, { code: '16', name: 'Tripura' },
                { code: '17', name: 'Meghalaya' }, { code: '18', name: 'Assam' },
                { code: '19', name: 'West Bengal' }, { code: '20', name: 'Jharkhand' },
                { code: '21', name: 'Odisha' }, { code: '22', name: 'Chhattisgarh' },
                { code: '23', name: 'Madhya Pradesh' }, { code: '24', name: 'Gujarat' },
                { code: '26', name: 'Dadra & Nagar Haveli and Daman & Diu' },
                { code: '27', name: 'Maharashtra' }, { code: '29', name: 'Karnataka' },
                { code: '30', name: 'Goa' }, { code: '31', name: 'Lakshadweep' },
                { code: '32', name: 'Kerala' }, { code: '33', name: 'Tamil Nadu' },
                { code: '34', name: 'Puducherry' }, { code: '35', name: 'Andaman and Nicobar Islands' },
                { code: '36', name: 'Telangana' }, { code: '37', name: 'Andhra Pradesh (New)' },
                { code: '38', name: 'Ladakh' }
              ];
              stateSelect.innerHTML = fallbackStates.map(state => 
                `<option value="${state.code}">${state.name}</option>`
              ).join('');
            }
            
            if (data.settings) {
              document.getElementById('gstEnabled').checked = data.settings.gstEnabled === true;
              document.getElementById('businessName').value = data.settings.businessName || '';
              document.getElementById('gstNumber').value = data.settings.gstNumber || '';
              document.getElementById('businessStateCode').value = data.settings.stateCode || '19';
              document.getElementById('businessAddress').value = data.settings.businessAddress || '';
              document.getElementById('inclusiveGst').checked = data.settings.inclusiveGst === true;
              document.getElementById('showGstOnInvoice').checked = data.settings.showGstOnInvoice === true;
              
              // Sync both invoice toggles
              const invoiceEnabledValue = data.settings.invoiceEnabled === true;
              document.getElementById('toggleInvoice').checked = invoiceEnabledValue;
              if (document.getElementById('invoiceEnabled')) {
                document.getElementById('invoiceEnabled').checked = invoiceEnabledValue;
              }
              
              // Invoice Setup fields
              document.getElementById('invoicePrefix').value = data.settings.invoicePrefix || 'INV';
              document.getElementById('lastInvoiceNumber').value = data.settings.lastInvoiceNumber || 0;
              document.getElementById('invoiceFooter').value = data.settings.invoiceFooter || '';
              document.getElementById('invoiceTerms').value = data.settings.invoiceTerms || '';
              document.getElementById('invoiceSignature').value = data.settings.invoiceSignature || '';
              document.getElementById('invoiceLogo').value = data.settings.invoiceLogo || '';
              document.getElementById('businessPan').value = data.settings.businessPan || '';
              
              // Bank details
              if (data.settings.bankDetails) {
                document.getElementById('bankName').value = data.settings.bankDetails.bankName || '';
                document.getElementById('bankAccountNumber').value = data.settings.bankDetails.accountNumber || '';
                document.getElementById('bankIfsc').value = data.settings.bankDetails.ifscCode || '';
                document.getElementById('bankAccountHolder').value = data.settings.bankDetails.accountHolder || '';
              }
              
              // Update preview
              const nextNum = (parseInt(data.settings.lastInvoiceNumber) || 0) + 1;
              const year = new Date().getFullYear().toString().slice(-2);
              const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
              document.getElementById('nextInvoicePreview').textContent = `${data.settings.invoicePrefix || 'INV'}-${year}${month}-${nextNum.toString().padStart(5, '0')}`;
            }
          }
        } catch (error) {
          console.error('Error loading tax settings:', error);
        }
      }
      
      // Sync invoice toggles when either one changes
      document.getElementById('toggleInvoice')?.addEventListener('change', function() {
        const invoiceEnabledCheckbox = document.getElementById('invoiceEnabled');
        if (invoiceEnabledCheckbox) {
          invoiceEnabledCheckbox.checked = this.checked;
        }
      });
      
      document.getElementById('invoiceEnabled')?.addEventListener('change', function() {
        const toggleInvoice = document.getElementById('toggleInvoice');
        if (toggleInvoice) {
          toggleInvoice.checked = this.checked;
        }
      });
      
      document.getElementById('taxSettingsForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/tax/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              gstEnabled: document.getElementById('gstEnabled').checked,
              businessName: document.getElementById('businessName').value,
              gstNumber: document.getElementById('gstNumber').value,
              stateCode: document.getElementById('businessStateCode').value,
              businessAddress: document.getElementById('businessAddress').value,
              inclusiveGst: document.getElementById('inclusiveGst').checked,
              showGstOnInvoice: document.getElementById('showGstOnInvoice').checked,
              invoiceEnabled: document.getElementById('toggleInvoice').checked
            })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Tax settings saved', 'success');
          } else {
            showNotification(data.error || 'Failed to save settings', 'error');
          }
        } catch (error) {
          showNotification('Error saving settings', 'error');
        }
      });
      
      // Tax tab switching
      document.querySelectorAll('.tax-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tax-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tax-tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
          loadTaxTab(btn.dataset.tab);
        });
      });
      
      async function loadTaxTab(tab) {
        switch(tab) {
          case 'tax-settings': loadTaxSettings(); break;
          case 'tax-invoice-config': loadInvoiceSettings(); break;
          case 'tax-slabs': loadTaxSlabs(); break;
          case 'tax-hsn': loadHsnCodes(); break;
          case 'tax-invoices': loadInvoices(); break;
          case 'tax-report': loadGstReport(); break;
        }
      }
      
      // Invoice Settings
      async function loadInvoiceSettings() {
        try {
          const response = await fetch('/api/tax/invoice-settings', { credentials: 'include' });
          const data = await response.json();
          if (data.success && data.settings) {
            const invoiceEnabledVal = data.settings.invoiceEnabled === true;
            document.getElementById('invoiceEnabled').checked = invoiceEnabledVal;
            // Also sync the toggle in Tax Settings tab
            if (document.getElementById('toggleInvoice')) {
              document.getElementById('toggleInvoice').checked = invoiceEnabledVal;
            }
            document.getElementById('invoicePrefix').value = data.settings.invoicePrefix || 'INV';
            document.getElementById('lastInvoiceNumber').value = data.settings.lastInvoiceNumber || 0;
            document.getElementById('invoiceFooter').value = data.settings.invoiceFooter || '';
            document.getElementById('invoiceTerms').value = data.settings.invoiceTerms || '';
            document.getElementById('invoiceSignature').value = data.settings.invoiceSignature || '';
            document.getElementById('invoiceLogo').value = data.settings.invoiceLogo || '';
            document.getElementById('businessPan').value = data.settings.businessPan || '';
            
            if (data.settings.bankDetails) {
              document.getElementById('bankName').value = data.settings.bankDetails.bankName || '';
              document.getElementById('bankAccountNumber').value = data.settings.bankDetails.accountNumber || '';
              document.getElementById('bankIfsc').value = data.settings.bankDetails.ifscCode || '';
              document.getElementById('bankAccountHolder').value = data.settings.bankDetails.accountHolder || '';
            }
            
            updateInvoicePreview();
          }
        } catch (error) {
          console.error('Error loading invoice settings:', error);
        }
      }
      
      function updateInvoicePreview() {
        const prefix = document.getElementById('invoicePrefix').value || 'INV';
        const lastNum = parseInt(document.getElementById('lastInvoiceNumber').value) || 0;
        const date = new Date();
        const year = date.getFullYear().toString().slice(-2);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const nextNum = String(lastNum + 1).padStart(5, '0');
        document.getElementById('nextInvoicePreview').textContent = `${prefix}-${year}${month}-${nextNum}`;
      }
      
      document.getElementById('invoicePrefix')?.addEventListener('input', updateInvoicePreview);
      
      document.getElementById('invoiceSettingsForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          const response = await fetch('/api/tax/invoice-settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              invoiceEnabled: document.getElementById('invoiceEnabled').checked,
              invoicePrefix: document.getElementById('invoicePrefix').value,
              invoiceFooter: document.getElementById('invoiceFooter').value,
              invoiceTerms: document.getElementById('invoiceTerms').value,
              invoiceSignature: document.getElementById('invoiceSignature').value,
              invoiceLogo: document.getElementById('invoiceLogo').value,
              businessPan: document.getElementById('businessPan').value,
              bankDetails: {
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('bankAccountNumber').value,
                ifscCode: document.getElementById('bankIfsc').value,
                accountHolder: document.getElementById('bankAccountHolder').value
              }
            })
          });
          const data = await response.json();
          if (data.success) {
            showNotification('Invoice settings saved', 'success');
          } else {
            showNotification(data.error || 'Failed to save settings', 'error');
          }
        } catch (error) {
          showNotification('Error saving invoice settings', 'error');
        }
      });
      
      async function loadTaxSlabs() {
        try {
          const response = await fetch('/api/tax/slabs', { credentials: 'include' });
          const data = await response.json();
          renderTaxSlabsTable(data.slabs || []);
        } catch (error) {
          console.error('Error loading tax slabs:', error);
        }
      }
      
      function renderTaxSlabsTable(slabs) {
        const tbody = document.getElementById('taxSlabsTableBody');
        if (!slabs.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#6b7280;">No tax slabs found</td></tr>';
          return;
        }
        tbody.innerHTML = slabs.map(s => `
          <tr>
            <td>${s.name}</td>
            <td>${s.minPrice} - ${s.maxPrice > 999999 ? '' : s.maxPrice}</td>
            <td>${s.cgstRate}%</td>
            <td>${s.sgstRate}%</td>
            <td>${s.igstRate}%</td>
            <td>${s.hsnCode}</td>
            <td><span class="${s.active ? 'status-active' : 'status-inactive'}">${s.active ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button onclick="deleteTaxSlab('${s.id}')" title="Delete"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function deleteTaxSlab(id) {
        const confirmed = await AdminUniModal.danger('Delete Tax Slab', 'Are you sure you want to delete this tax slab?', 'Yes, Delete');
        if (!confirmed) return;
        try {
          await fetch(`/api/tax/slabs/${id}`, { method: 'DELETE', credentials: 'include' });
          showNotification('Tax slab deleted', 'success');
          loadTaxSlabs();
        } catch (error) {
          showNotification('Error deleting tax slab', 'error');
        }
      }
      
      // Add Tax Slab button handler
      document.getElementById('addTaxSlabBtn')?.addEventListener('click', function() {
        var modalHtml = '<div class="modal-overlay" id="addSlabModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">' +
          '<div class="modal-content" style="background:#fff;padding:24px;border-radius:16px;width:90%;max-width:450px;">' +
            '<h3 style="margin:0 0 20px;">Add Tax Slab</h3>' +
            '<form id="addSlabForm" style="display:grid;gap:14px;">' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Slab Name<input type="text" id="slabName" placeholder="e.g. Premium Products" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Min Price ()<input type="number" id="slabMin" placeholder="0" value="0" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Max Price ()<input type="number" id="slabMax" placeholder="999" value="999" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">CGST Rate (%)<input type="number" id="slabCgst" placeholder="2.5" step="0.5" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">SGST Rate (%)<input type="number" id="slabSgst" placeholder="2.5" step="0.5" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">HSN Code<input type="text" id="slabHsn" placeholder="6109" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:10px;">' +
                '<button type="button" onclick="document.getElementById(\'addSlabModal\').remove()" class="secondary">Cancel</button>' +
                '<button type="submit" class="primary">Create Slab</button>' +
              '</div>' +
            '</form>' +
          '</div>' +
        '</div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('addSlabForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          var cgst = parseFloat(document.getElementById('slabCgst').value);
          var sgst = parseFloat(document.getElementById('slabSgst').value);
          try {
            var response = await fetch('/api/tax/slabs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                name: document.getElementById('slabName').value,
                minPrice: parseFloat(document.getElementById('slabMin').value) || 0,
                maxPrice: parseFloat(document.getElementById('slabMax').value) || 999999,
                cgstRate: cgst,
                sgstRate: sgst,
                igstRate: cgst + sgst,
                hsnCode: document.getElementById('slabHsn').value || '6109',
                active: true
              })
            });
            if (response.ok) {
              showNotification('Tax slab created!', 'success');
              document.getElementById('addSlabModal').remove();
              loadTaxSlabs();
            } else {
              const data = await response.json();
              showNotification(data.error || 'Failed to create tax slab', 'error');
            }
          } catch (error) {
            showNotification('Error creating tax slab', 'error');
          }
        });
      });
      
      // Add HSN Code button handler
      document.getElementById('addHsnBtn')?.addEventListener('click', function() {
        var modalHtml = '<div class="modal-overlay" id="addHsnModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">' +
          '<div class="modal-content" style="background:#fff;padding:24px;border-radius:16px;width:90%;max-width:450px;">' +
            '<h3 style="margin:0 0 20px;">Add HSN Code</h3>' +
            '<form id="addHsnForm" style="display:grid;gap:14px;">' +
              '<label style="display:flex;flex-direction:column;gap:6px;">HSN Code<input type="text" id="hsnCode" placeholder="e.g. 6109" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Description<input type="text" id="hsnDesc" placeholder="e.g. T-shirts, singlets" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Category<input type="text" id="hsnCategory" placeholder="e.g. T-Shirts" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:10px;">' +
                '<button type="button" onclick="document.getElementById(\'addHsnModal\').remove()" class="secondary">Cancel</button>' +
                '<button type="submit" class="primary">Add HSN</button>' +
              '</div>' +
            '</form>' +
          '</div>' +
        '</div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('addHsnForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          try {
            var response = await fetch('/api/tax/hsn', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                code: document.getElementById('hsnCode').value,
                description: document.getElementById('hsnDesc').value,
                category: document.getElementById('hsnCategory').value
              })
            });
            if (response.ok) {
              showNotification('HSN code added!', 'success');
              document.getElementById('addHsnModal').remove();
              loadHsnCodes();
            } else {
              const data = await response.json();
              showNotification(data.error || 'Failed to add HSN code', 'error');
            }
          } catch (error) {
            showNotification('Error adding HSN code', 'error');
          }
        });
      });
      
      async function loadHsnCodes() {
        try {
          const response = await fetch('/api/tax/hsn', { credentials: 'include' });
          const data = await response.json();
          renderHsnTable(data.hsnCodes || []);
        } catch (error) {
          console.error('Error loading HSN codes:', error);
        }
      }
      
      function renderHsnTable(codes) {
        const tbody = document.getElementById('hsnTableBody');
        if (!codes.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#6b7280;">No HSN codes found</td></tr>';
          return;
        }
        tbody.innerHTML = codes.map(h => `
          <tr data-id="${h.id || h.code}">
            <td><input type="text" value="${h.code}" class="hsn-code-input" data-field="code" style="width:80px;padding:6px;border:1px solid #e5e7eb;border-radius:4px;font-family:monospace;font-weight:600;"></td>
            <td><input type="text" value="${h.description}" class="hsn-desc-input" data-field="description" style="width:100%;padding:6px;border:1px solid #e5e7eb;border-radius:4px;"></td>
            <td><input type="text" value="${h.category}" class="hsn-cat-input" data-field="category" style="width:120px;padding:6px;border:1px solid #e5e7eb;border-radius:4px;"></td>
            <td class="actions">
              <button onclick="saveHsnCode('${h.id || h.code}')" title="Save"><i class="ri-save-line"></i></button>
              <button onclick="deleteHsnCode('${h.id || h.code}')" title="Delete" style="color:#dc2626;"><i class="ri-delete-bin-line"></i></button>
            </td>
          </tr>
        `).join('');
      }
      
      async function saveHsnCode(hsnId) {
        const row = document.querySelector(`tr[data-id="${hsnId}"]`);
        if (!row) return;
        
        const code = row.querySelector('.hsn-code-input').value;
        const description = row.querySelector('.hsn-desc-input').value;
        const category = row.querySelector('.hsn-cat-input').value;
        
        try {
          const response = await fetch(`/api/tax/hsn/${hsnId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ code, description, category })
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification('HSN code saved', 'success');
            loadHsnCodes();
          } else {
            showNotification(data.error || 'Failed to save HSN code', 'error');
          }
        } catch (error) {
          showNotification('Error saving HSN code', 'error');
        }
      }
      
      async function deleteHsnCode(hsnId) {
        const confirmed = await AdminUniModal.danger('Delete HSN Code', 'Are you sure you want to delete this HSN code?', 'Yes, Delete');
        if (!confirmed) return;
        
        try {
          const response = await fetch(`/api/tax/hsn/${hsnId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification('HSN code deleted', 'success');
            loadHsnCodes();
          } else {
            showNotification(data.error || 'Failed to delete HSN code', 'error');
          }
        } catch (error) {
          showNotification('Error deleting HSN code', 'error');
        }
      }
      
      async function loadInvoices() {
        try {
          const response = await fetch('/api/tax/invoices', { credentials: 'include' });
          const data = await response.json();
          renderInvoicesTable(data.invoices || []);
        } catch (error) {
          console.error('Error loading invoices:', error);
        }
      }
      
      function renderInvoicesTable(invoices) {
        const tbody = document.getElementById('invoicesTableBody');
        if (!invoices.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#6b7280;">No invoices generated yet</td></tr>';
          return;
        }
        tbody.innerHTML = invoices.map(i => {
          // Calculate total GST from cgst, sgst, igst
          const totalGst = (i.cgst || 0) + (i.sgst || 0) + (i.igst || 0);
          // Use total or calculate from subtotal
          const grandTotal = i.total || i.grandTotal || ((i.subtotal || 0) + totalGst);
          // Use createdAt or invoiceDate
          const invoiceDate = i.createdAt || i.invoiceDate;
          const dateStr = invoiceDate ? new Date(invoiceDate).toLocaleDateString() : '-';
          
          return `
          <tr>
            <td><code>${i.invoiceNumber || '-'}</code></td>
            <td>${i.orderId || i.orderNumber || '-'}</td>
            <td>${i.customerName || i.buyer?.name || '-'}</td>
            <td>${(i.subtotal || 0).toLocaleString()}</td>
            <td>${totalGst.toLocaleString()}</td>
            <td>${grandTotal.toLocaleString()}</td>
            <td>${dateStr}</td>
            <td class="actions">
              <button onclick="viewInvoice('${i.id}')" title="View"><i class="ri-eye-line"></i></button>
            </td>
          </tr>
        `;
        }).join('');
      }
      
      // View invoice details in a modal or new window
      async function viewInvoice(invoiceId) {
        try {
          const response = await fetch(`/api/tax/invoices/${invoiceId}`, { credentials: 'include' });
          const data = await response.json();
          if (!data.success || !data.invoice) {
            showNotification('Invoice not found', 'error');
            return;
          }
          const inv = data.invoice;
          const totalGst = (inv.cgst || 0) + (inv.sgst || 0) + (inv.igst || 0);
          const invoiceDate = inv.createdAt || inv.invoiceDate;
          const dateStr = invoiceDate ? new Date(invoiceDate).toLocaleString() : '-';
          
          // Create modal content
          const modalContent = `
            <div style="padding: 20px; max-width: 600px;">
              <h3 style="margin: 0 0 20px 0; border-bottom: 2px solid #000; padding-bottom: 10px;">Invoice ${inv.invoiceNumber}</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div><strong>Order ID:</strong> ${inv.orderId || inv.orderNumber || '-'}</div>
                <div><strong>Date:</strong> ${dateStr}</div>
                <div><strong>Customer:</strong> ${inv.customerName || '-'}</div>
                <div><strong>Email:</strong> ${inv.customerEmail || '-'}</div>
              </div>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                  <tr style="background: #f3f4f6;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Item</th>
                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Qty</th>
                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Price</th>
                    <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${(inv.items || []).map(item => `
                    <tr>
                      <td style="padding: 10px; border: 1px solid #e5e7eb;">${item.name || 'Product'}</td>
                      <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${item.quantity || 1}</td>
                      <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${(item.price || 0).toLocaleString()}</td>
                      <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${(item.lineTotal || 0).toLocaleString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              <div style="text-align: right; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                <div style="margin-bottom: 8px;"><strong>Subtotal:</strong> ${(inv.subtotal || 0).toLocaleString()}</div>
                ${inv.cgst ? `<div style="margin-bottom: 8px; color: #6b7280;">CGST: ${inv.cgst.toLocaleString()}</div>` : ''}
                ${inv.sgst ? `<div style="margin-bottom: 8px; color: #6b7280;">SGST: ${inv.sgst.toLocaleString()}</div>` : ''}
                ${inv.igst ? `<div style="margin-bottom: 8px; color: #6b7280;">IGST: ${inv.igst.toLocaleString()}</div>` : ''}
                <div style="font-size: 1.2rem; font-weight: bold; margin-top: 10px;">Total: ${(inv.total || 0).toLocaleString()}</div>
              </div>
              <div style="margin-top: 20px; text-align: center;">
                <button onclick="this.closest('.modal-overlay').remove()" style="padding: 10px 30px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer;">Close</button>
              </div>
            </div>
          `;
          
          // Show in modal
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
          modal.innerHTML = `<div style="background:#fff;border-radius:12px;max-height:90vh;overflow:auto;">${modalContent}</div>`;
          modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
          document.body.appendChild(modal);
        } catch (error) {
          console.error('Error viewing invoice:', error);
          showNotification('Error loading invoice', 'error');
        }
      }
      
      async function loadGstReport() {
        try {
          const startDate = document.getElementById('gstReportStart')?.value || '';
          const endDate = document.getElementById('gstReportEnd')?.value || '';
          const url = `/api/tax/gst-report?startDate=${startDate}&endDate=${endDate}`;
          const response = await fetch(url, { credentials: 'include' });
          const data = await response.json();
          if (data.success && data.report) {
            document.getElementById('reportTotalInvoices').textContent = data.report.totalInvoices;
            document.getElementById('reportTotalSales').textContent = '' + data.report.totalSales;
            document.getElementById('reportTotalGst').textContent = '' + data.report.totalGst;
            document.getElementById('reportCgstSgst').textContent = `${data.report.totalCgst} / ${data.report.totalSgst}`;
          }
        } catch (error) {
          console.error('Error loading GST report:', error);
        }
      }
      
      document.getElementById('generateGstReportBtn')?.addEventListener('click', loadGstReport);

      // ===============================
      // COMPANY TAX SECTION
      // ===============================
      let companyTaxData = {
        income: [],
        expenses: [],
        financialYear: '2024-25'
      };
      
      function initCompanyTax() {
        // Tab switching for company tax section
        document.querySelectorAll('#company-tax .tax-tabs .tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('#company-tax .tax-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#company-tax .tax-tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab + '-tab')?.classList.add('active');
          });
        });
        
        // Financial year selector
        document.getElementById('financialYearSelect')?.addEventListener('change', function() {
          companyTaxData.financialYear = this.value;
          loadCompanyTaxData();
        });
        
        // Refresh button
        document.getElementById('refreshCompanyTaxBtn')?.addEventListener('click', loadCompanyTaxData);
        
        // Export button
        document.getElementById('exportTaxReportBtn')?.addEventListener('click', exportCompanyTaxReport);
        
        // Add income/expense buttons
        document.getElementById('addIncomeBtn')?.addEventListener('click', () => showIncomeExpenseModal('income'));
        document.getElementById('addExpenseBtn')?.addEventListener('click', () => showIncomeExpenseModal('expense'));
        
        // Business type and tax regime changes
        document.getElementById('businessTypeSelect')?.addEventListener('change', calculateCompanyTax);
        document.getElementById('taxRegimeSelect')?.addEventListener('change', calculateCompanyTax);
      }
      
      async function loadCompanyTaxData() {
        try {
          // Use existing tax settings endpoint instead of non-existent company-tax
          const response = await fetch(getApiUrl('/api/tax/settings'), { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.settings) {
              // Load any saved company tax data from settings
              companyTaxData.income = data.settings.companyIncome || [];
              companyTaxData.expenses = data.settings.companyExpenses || [];
            }
          }
          renderIncomeTable();
          renderExpensesTable();
          calculateCompanyTax();
        } catch (error) {
          // Silently handle - company tax data will be tracked locally
          renderIncomeTable();
          renderExpensesTable();
          calculateCompanyTax();
        }
      }
      
      function renderIncomeTable() {
        const tbody = document.getElementById('incomeTableBody');
        if (!companyTaxData.income.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No income entries. Click "Add Income" to start.</td></tr>';
          return;
        }
        tbody.innerHTML = companyTaxData.income.map(item => 
          '<tr>' +
            '<td>' + formatDate(item.date) + '</td>' +
            '<td>' + escapeHtml(item.description) + '</td>' +
            '<td><span class="category-badge">' + escapeHtml(item.category) + '</span></td>' +
            '<td>' + formatNumber(item.amount) + '</td>' +
            '<td>' + formatNumber(item.gst || 0) + '</td>' +
            '<td><strong>' + formatNumber((item.amount || 0) - (item.gst || 0)) + '</strong></td>' +
            '<td><button onclick="deleteIncomeEntry(\'' + item.id + '\')" title="Delete"><i class="ri-delete-bin-line"></i></button></td>' +
          '</tr>'
        ).join('');
      }
      
      function renderExpensesTable() {
        const tbody = document.getElementById('expensesTableBody');
        if (!companyTaxData.expenses.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No expense entries. Click "Add Expense" to start.</td></tr>';
          return;
        }
        tbody.innerHTML = companyTaxData.expenses.map(item =>
          '<tr>' +
            '<td>' + formatDate(item.date) + '</td>' +
            '<td>' + escapeHtml(item.description) + '</td>' +
            '<td><span class="category-badge">' + escapeHtml(item.category) + '</span></td>' +
            '<td>' + formatNumber(item.amount) + '</td>' +
            '<td>' + formatNumber(item.gst || 0) + '</td>' +
            '<td><strong>' + formatNumber((item.amount || 0) - (item.gst || 0)) + '</strong></td>' +
            '<td><button onclick="deleteExpenseEntry(\'' + item.id + '\')" title="Delete"><i class="ri-delete-bin-line"></i></button></td>' +
          '</tr>'
        ).join('');
      }
      
      function calculateCompanyTax() {
        const grossRevenue = companyTaxData.income.reduce((sum, i) => sum + (i.amount || 0), 0);
        const totalExpenses = companyTaxData.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const netProfit = grossRevenue - totalExpenses;
        const outputGst = companyTaxData.income.reduce((sum, i) => sum + (i.gst || 0), 0);
        const inputGst = companyTaxData.expenses.reduce((sum, e) => sum + (e.gst || 0), 0);
        const netGst = Math.max(0, outputGst - inputGst);
        
        // Update summary cards
        document.getElementById('companyGrossRevenue').textContent = '' + formatNumber(grossRevenue);
        document.getElementById('companyTotalExpenses').textContent = '' + formatNumber(totalExpenses);
        document.getElementById('companyNetProfit').textContent = (netProfit >= 0 ? '' : '-') + formatNumber(Math.abs(netProfit));
        document.getElementById('companyNetProfit').style.color = netProfit >= 0 ? '#22c55e' : '#ef4444';
        
        // Calculate income tax based on business type
        const businessType = document.getElementById('businessTypeSelect')?.value || 'proprietorship';
        const taxRegime = document.getElementById('taxRegimeSelect')?.value || 'new';
        
        let taxRate = 0;
        let taxAmount = 0;
        
        if (netProfit > 0) {
          if (businessType === 'pvt-ltd' || businessType === 'opc') {
            // Company tax - flat 25% for turnover < 400 Cr
            taxRate = 25;
            taxAmount = netProfit * 0.25;
          } else if (businessType === 'llp' || businessType === 'partnership') {
            // Partnership/LLP - flat 30%
            taxRate = 30;
            taxAmount = netProfit * 0.30;
          } else {
            // Proprietorship - individual slab rates
            if (taxRegime === 'new') {
              // New regime FY 2024-25
              if (netProfit <= 300000) { taxRate = 0; taxAmount = 0; }
              else if (netProfit <= 700000) { taxRate = 5; taxAmount = (netProfit - 300000) * 0.05; }
              else if (netProfit <= 1000000) { taxRate = 10; taxAmount = 20000 + (netProfit - 700000) * 0.10; }
              else if (netProfit <= 1200000) { taxRate = 15; taxAmount = 50000 + (netProfit - 1000000) * 0.15; }
              else if (netProfit <= 1500000) { taxRate = 20; taxAmount = 80000 + (netProfit - 1200000) * 0.20; }
              else { taxRate = 30; taxAmount = 140000 + (netProfit - 1500000) * 0.30; }
            } else {
              // Old regime
              if (netProfit <= 250000) { taxRate = 0; taxAmount = 0; }
              else if (netProfit <= 500000) { taxRate = 5; taxAmount = (netProfit - 250000) * 0.05; }
              else if (netProfit <= 1000000) { taxRate = 20; taxAmount = 12500 + (netProfit - 500000) * 0.20; }
              else { taxRate = 30; taxAmount = 112500 + (netProfit - 1000000) * 0.30; }
            }
          }
        }
        
        const cess = taxAmount * 0.04;
        const totalIncomeTax = taxAmount + cess;
        const grandTotal = totalIncomeTax + netGst;
        
        // Update tax calculation display
        document.getElementById('taxableIncome').textContent = '' + formatNumber(Math.max(0, netProfit));
        document.getElementById('effectiveTaxRate').textContent = taxRate + '%';
        document.getElementById('incomeTaxAmount').textContent = '' + formatNumber(taxAmount);
        document.getElementById('cessAmount').textContent = '' + formatNumber(cess);
        document.getElementById('outputGst').textContent = '' + formatNumber(outputGst);
        document.getElementById('inputGst').textContent = '' + formatNumber(inputGst);
        document.getElementById('netGstPayable').textContent = '' + formatNumber(netGst);
        document.getElementById('totalIncomeTax').textContent = '' + formatNumber(totalIncomeTax);
        document.getElementById('totalGstPayable').textContent = '' + formatNumber(netGst);
        document.getElementById('grandTotalTax').textContent = '' + formatNumber(grandTotal);
        document.getElementById('companyTaxLiability').textContent = '' + formatNumber(grandTotal);
      }
      
      function showIncomeExpenseModal(type) {
        const isIncome = type === 'income';
        const categories = isIncome 
          ? ['Product Sales', 'Gift Card Sales', 'Shipping Charges', 'Other Income']
          : ['Inventory Purchase', 'Marketing', 'Shipping', 'Salaries', 'Rent', 'Utilities', 'Professional Fees', 'Miscellaneous'];
        
        const modalHtml = '<div class="modal-overlay" id="incomeExpenseModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">' +
          '<div class="modal-content" style="background:#fff;padding:24px;border-radius:16px;width:90%;max-width:500px;">' +
            '<h3 style="margin:0 0 20px;">Add ' + (isIncome ? 'Income' : 'Expense') + '</h3>' +
            '<form id="incomeExpenseForm" style="display:grid;gap:16px;">' +
              '<input type="hidden" id="entryType" value="' + type + '">' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Date<input type="date" id="entryDate" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Description<input type="text" id="entryDesc" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Category<select id="entryCategory" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;">' +
                categories.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('') +
              '</select></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">Amount ()<input type="number" id="entryAmount" min="0" step="0.01" required style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<label style="display:flex;flex-direction:column;gap:6px;">GST Amount ()<input type="number" id="entryGst" min="0" step="0.01" value="0" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;"></label>' +
              '<div style="display:flex;gap:12px;justify-content:flex-end;">' +
                '<button type="button" onclick="closeIncomeExpenseModal()" class="secondary">Cancel</button>' +
                '<button type="submit" class="primary">Save Entry</button>' +
              '</div>' +
            '</form>' +
          '</div>' +
        '</div>';
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('incomeExpenseForm').addEventListener('submit', saveIncomeExpenseEntry);
      }
      
      function closeIncomeExpenseModal() {
        document.getElementById('incomeExpenseModal')?.remove();
      }
      
      async function saveIncomeExpenseEntry(e) {
        e.preventDefault();
        const type = document.getElementById('entryType').value;
        const entry = {
          id: 'entry_' + Date.now(),
          date: document.getElementById('entryDate').value,
          description: document.getElementById('entryDesc').value,
          category: document.getElementById('entryCategory').value,
          amount: parseFloat(document.getElementById('entryAmount').value) || 0,
          gst: parseFloat(document.getElementById('entryGst').value) || 0
        };
        
        if (type === 'income') {
          companyTaxData.income.push(entry);
          renderIncomeTable();
        } else {
          companyTaxData.expenses.push(entry);
          renderExpensesTable();
        }
        
        calculateCompanyTax();
        closeIncomeExpenseModal();
        showNotification('Entry added successfully', 'success');
        
        // Save company tax data locally - no backend endpoint needed
        // Data is stored in companyTaxData object and persists in session
      }
      
      window.deleteIncomeEntry = async function(id) {
        companyTaxData.income = companyTaxData.income.filter(function(i) { return i.id !== id; });
        renderIncomeTable();
        calculateCompanyTax();
        showNotification('Income entry deleted', 'success');
      };
      
      window.deleteExpenseEntry = async function(id) {
        companyTaxData.expenses = companyTaxData.expenses.filter(function(e) { return e.id !== id; });
        renderExpensesTable();
        calculateCompanyTax();
        showNotification('Expense entry deleted', 'success');
      };
      
      function exportCompanyTaxReport() {
        const report = {
          financialYear: companyTaxData.financialYear,
          generatedAt: new Date().toISOString(),
          income: companyTaxData.income,
          expenses: companyTaxData.expenses,
          summary: {
            grossRevenue: document.getElementById('companyGrossRevenue').textContent,
            totalExpenses: document.getElementById('companyTotalExpenses').textContent,
            netProfit: document.getElementById('companyNetProfit').textContent,
            taxLiability: document.getElementById('companyTaxLiability').textContent
          }
        };
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'blackonn-tax-report-' + companyTaxData.financialYear + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Tax report exported', 'success');
      }
      
      // ===============================
      // GIFT CARDS SECTION
      // ===============================
      let giftCards = [];
      
      function initGiftCards() {
        document.getElementById('createGiftCardBtn')?.addEventListener('click', () => {
          document.getElementById('giftCardFormContainer').style.display = 'block';
        });
        document.getElementById('cancelGiftCardBtn')?.addEventListener('click', () => {
          document.getElementById('giftCardFormContainer').style.display = 'none';
        });
        document.getElementById('giftCardForm')?.addEventListener('submit', createGiftCards);
      }
      
      async function loadGiftCards() {
        try {
          const response = await fetch('/api/gift-cards', { credentials: 'include' });
          const data = await response.json();
          if (data.success) {
            giftCards = data.giftCards || [];
            renderGiftCardsTable();
            updateGiftCardStats();
          }
        } catch (error) {
          console.log('Gift cards will be tracked locally');
          renderGiftCardsTable();
        }
      }
      
      function renderGiftCardsTable() {
        const tbody = document.getElementById('giftCardsTableBody');
        if (!giftCards.length) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6b7280;">No gift cards found. Click "Create Gift Card" to start.</td></tr>';
          return;
        }
        tbody.innerHTML = giftCards.map(function(card) {
          var statusClass = card.status === 'active' ? 'status-active' : (card.status === 'expired' ? 'status-inactive' : 'status-pending');
          var recipientInfo = card.recipientEmail ? 
            '<div style="font-size: 12px; color: #374151;">' + (card.recipientName || 'N/A') + '</div><div style="font-size: 11px; color: #6b7280;">' + card.recipientEmail + '</div>' : 
            '<span style="color: #9ca3af;">Admin Created</span>';
          var senderInfo = card.senderEmail ? 
            '<div style="font-size: 12px; color: #374151;">' + (card.senderName || 'N/A') + '</div><div style="font-size: 11px; color: #6b7280;">' + card.senderEmail + '</div>' : 
            '<span style="color: #9ca3af;">-</span>';
          var isPurchased = card.recipientEmail ? '<span style="background:#dcfce7;color:#16a34a;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:4px;">Purchased</span>' : '';
          return '<tr>' +
            '<td><code style="font-weight:600;letter-spacing:1px;">' + card.code + '</code>' + isPurchased + '</td>' +
            '<td>' + formatNumber(card.value) + '</td>' +
            '<td>' + formatNumber(card.balance) + '</td>' +
            '<td>' + recipientInfo + '</td>' +
            '<td>' + senderInfo + '</td>' +
            '<td>' + formatDate(card.createdAt) + '</td>' +
            '<td>' + formatDate(card.expiresAt) + '</td>' +
            '<td><span class="' + statusClass + '">' + card.status + '</span></td>' +
            '<td class="actions">' +
              '<button onclick="deactivateGiftCard(\'' + card.id + '\')" title="Deactivate"><i class="ri-forbid-line"></i></button>' +
              '<button onclick="deleteGiftCard(\'' + card.id + '\')" title="Delete"><i class="ri-delete-bin-line"></i></button>' +
            '</td>' +
          '</tr>';
        }).join('');
      }
      
      function updateGiftCardStats() {
        var total = giftCards.length;
        var active = giftCards.filter(function(c) { return c.status === 'active'; }).length;
        var totalValue = giftCards.reduce(function(sum, c) { return sum + (c.value || 0); }, 0);
        var redeemed = giftCards.reduce(function(sum, c) { return sum + ((c.value || 0) - (c.balance || 0)); }, 0);
        
        document.getElementById('totalGiftCards').textContent = total;
        document.getElementById('activeGiftCards').textContent = active;
        document.getElementById('totalGiftCardValue').textContent = '' + formatNumber(totalValue);
        document.getElementById('redeemedGiftCards').textContent = '' + formatNumber(redeemed);
      }
      
      async function createGiftCards(e) {
        e.preventDefault();
        var value = parseFloat(document.getElementById('giftCardValue').value) || 500;
        var qty = parseInt(document.getElementById('giftCardQty').value) || 1;
        var expiryDays = parseInt(document.getElementById('giftCardExpiry').value) || 365;
        
        var newCards = [];
        for (var i = 0; i < qty; i++) {
          var code = 'BLK-' + generateCode(4) + '-' + generateCode(4);
          var expiresAt = new Date();
          expiresAt.setDate(expiresAt.getDate() + expiryDays);
          newCards.push({
            id: 'gc_' + Date.now() + '_' + i,
            code: code,
            value: value,
            balance: value,
            status: 'active',
            createdAt: new Date().toISOString(),
            expiresAt: expiresAt.toISOString()
          });
        }
        
        giftCards = giftCards.concat(newCards);
        renderGiftCardsTable();
        updateGiftCardStats();
        document.getElementById('giftCardFormContainer').style.display = 'none';
        document.getElementById('giftCardForm').reset();
        showNotification(qty + ' gift card(s) created!', 'success');
        
        // Try to save to backend
        try {
          await fetch('/api/gift-cards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ cards: newCards })
          });
        } catch (err) {
          console.log('Gift cards saved locally');
        }
      }
      
      function generateCode(length) {
        var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        var result = '';
        for (var i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }
      
      window.deactivateGiftCard = function(id) {
        giftCards = giftCards.map(function(c) {
          if (c.id === id) c.status = 'inactive';
          return c;
        });
        renderGiftCardsTable();
        updateGiftCardStats();
        showNotification('Gift card deactivated', 'success');
      };
      
      window.deleteGiftCard = async function(id) {
        const confirmed = await AdminUniModal.danger('Delete Gift Card', 'Are you sure you want to delete this gift card?', 'Yes, Delete');
        if (!confirmed) return;
        giftCards = giftCards.filter(function(c) { return c.id !== id; });
        renderGiftCardsTable();
        updateGiftCardStats();
        showNotification('Gift card deleted', 'success');
      };
      
      // Helper functions
      function formatNumber(num) {
        return (num || 0).toLocaleString('en-IN');
      }
      
      function formatDate(dateStr) {
        if (!dateStr) return '-';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      }
      
      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      // ===============================
      // MASTER SECTION TOGGLES
      // ===============================
      
      // Section body element IDs mapped to toggle data-section values
      const sectionBodyMap = {
        skuManagement: 'skuSectionBody',
        inventory: 'inventorySectionBody',
        marketing: 'marketingSectionBody',
        shipping: 'shippingSectionBody',
        tax: 'taxSectionBody',
        giftCards: 'giftCardsSectionBody',
        companyTax: 'companyTaxSectionBody'
      };
      
      // Load section enabled states from server
      async function loadSectionToggles() {
        try {
          const response = await fetch(getApiUrl('/api/settings'), { credentials: 'include' });
          const data = await response.json();
          
          if (data.success && data.settings && data.settings.sections) {
            const sections = data.settings.sections;
            
            Object.entries(sections).forEach(([key, value]) => {
              // Find the toggle for this section
              const toggle = document.querySelector(`.master-section-toggle[data-section="${key}"]`);
              if (toggle) {
                toggle.checked = value.enabled !== false;
                updateSectionState(key, toggle.checked);
              }
            });
          }
        } catch (error) {
          console.error('Error loading section toggles:', error);
        }
      }
      
      // Update section enabled/disabled visual state
      function updateSectionState(sectionKey, enabled) {
        const bodyId = sectionBodyMap[sectionKey];
        const body = document.getElementById(bodyId);
        
        if (body) {
          if (enabled) {
            body.classList.remove('section-disabled');
          } else {
            body.classList.add('section-disabled');
          }
        }
      }
      
      // Handle master toggle changes
      async function handleMasterToggle(event) {
        const toggle = event.target;
        const sectionKey = toggle.dataset.section;
        const enabled = toggle.checked;
        
        // Update UI immediately
        updateSectionState(sectionKey, enabled);
        
        // Save to server
        try {
          const response = await fetch(getApiUrl(`/api/settings/sections/${sectionKey}`), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ enabled })
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification(`${sectionKey} section ${enabled ? 'enabled' : 'disabled'}`, 'success');
          } else {
            // Revert on failure
            toggle.checked = !enabled;
            updateSectionState(sectionKey, !enabled);
            showNotification('Failed to update section', 'error');
          }
        } catch (error) {
          console.error('Error updating section:', error);
          // Revert on error
          toggle.checked = !enabled;
          updateSectionState(sectionKey, !enabled);
          showNotification('Failed to update section', 'error');
        }
      }
      
      // Initialize master toggles
      function initMasterToggles() {
        document.querySelectorAll('.master-section-toggle').forEach(toggle => {
          toggle.addEventListener('change', handleMasterToggle);
        });
        
        // Load initial states
        loadSectionToggles();
      }

      // ===============================
      // NEWSLETTER MANAGEMENT FUNCTIONS
      // ===============================
      let newsletters = [];
      let subscribers = [];
      let currentNewsletterId = null;

      // Load newsletters
      async function loadNewsletters() {
        try {
          const res = await fetch(getApiUrl('/api/newsletter'), { credentials: 'include' });
          const data = await res.json();
          if (data.success) {
            newsletters = data.newsletters || [];
            renderNewslettersTable();
            updateNewsletterStats();
          }
        } catch (error) {
          console.error('Failed to load newsletters:', error);
        }
      }

      // Load subscribers
      async function loadSubscribers() {
        try {
          const res = await fetch(getApiUrl('/api/newsletter/subscribers/list'), { credentials: 'include' });
          const data = await res.json();
          if (data.success) {
            subscribers = data.subscribers || [];
            renderSubscribersTable();
            updateNewsletterStats();
          }
        } catch (error) {
          console.error('Failed to load subscribers:', error);
        }
      }

      // Load newsletter stats
      async function loadNewsletterStats() {
        try {
          const res = await fetch(getApiUrl('/api/newsletter/stats/overview'), { credentials: 'include' });
          const data = await res.json();
          if (data.success) {
            document.getElementById('totalNewsletters').textContent = data.stats.totalNewsletters || 0;
            document.getElementById('sentNewsletters').textContent = data.stats.sentNewsletters || 0;
            document.getElementById('activeSubscribers').textContent = data.stats.activeSubscribers || 0;
            document.getElementById('newsletterOpenRate').textContent = data.stats.averageOpenRate + '%' || '0%';
          }
        } catch (error) {
          console.error('Failed to load stats:', error);
        }
      }

      // Render newsletters table
      function renderNewslettersTable() {
        const tbody = document.getElementById('newslettersTableBody');
        if (!newsletters || newsletters.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                <i class="ri-mail-line" style="font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.3;"></i>
                No newsletters yet. Create your first newsletter!
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = newsletters.map(n => {
          const statusClass = n.status === 'sent' ? 'success' : n.status === 'draft' ? 'warning' : 'info';
          const statusText = n.status.charAt(0).toUpperCase() + n.status.slice(1);
          const createdDate = new Date(n.createdAt).toLocaleDateString();
          
          return `
            <tr>
              <td><strong>${escapeHtml(n.subject)}</strong></td>
              <td><span class="pill ${statusClass}">${statusText}</span></td>
              <td>${createdDate}</td>
              <td>${n.recipientCount || 0}</td>
              <td>${n.openCount || 0} (${n.recipientCount > 0 ? Math.round((n.openCount / n.recipientCount) * 100) : 0}%)</td>
              <td>
                <button class="icon-btn" onclick="editNewsletter('${n.id}')" title="Edit">
                  <i class="ri-edit-line"></i>
                </button>
                ${n.status !== 'sent' ? `
                  <button class="icon-btn success" onclick="previewAndSendNewsletter('${n.id}')" title="Send">
                    <i class="ri-send-plane-line"></i>
                  </button>
                ` : ''}
                <button class="icon-btn danger" onclick="deleteNewsletter('${n.id}')" title="Delete">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render subscribers table
      function renderSubscribersTable() {
        const tbody = document.getElementById('subscribersTableBody');
        if (!subscribers || subscribers.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                <i class="ri-user-follow-line" style="font-size: 48px; display: block; margin-bottom: 12px; opacity: 0.3;"></i>
                No subscribers yet
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = subscribers.map(s => {
          const statusClass = s.status === 'active' ? 'success' : 'danger';
          const statusText = s.status.charAt(0).toUpperCase() + s.status.slice(1);
          const subscribedDate = new Date(s.subscribedAt).toLocaleDateString();
          
          return `
            <tr>
              <td>${escapeHtml(s.email)}</td>
              <td>${s.name ? escapeHtml(s.name) : '-'}</td>
              <td><span class="pill ${statusClass}">${statusText}</span></td>
              <td>${subscribedDate}</td>
              <td><span class="pill">${s.source || 'website'}</span></td>
              <td>
                <button class="icon-btn danger" onclick="deleteSubscriber('${s.id}')" title="Delete">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Update newsletter stats
      function updateNewsletterStats() {
        const activeCount = subscribers.filter(s => s.status === 'active').length;
        const sentCount = newsletters.filter(n => n.status === 'sent').length;
        
        document.getElementById('totalNewsletters').textContent = newsletters.length;
        document.getElementById('sentNewsletters').textContent = sentCount;
        document.getElementById('activeSubscribers').textContent = activeCount;
      }

      // Show create newsletter modal
      function showCreateNewsletterModal() {
        currentNewsletterId = null;
        document.getElementById('newsletterModalTitle').innerHTML = '<i class="ri-mail-add-line"></i> Create Newsletter';
        document.getElementById('newsletterId').value = '';
        document.getElementById('newsletterSubject').value = '';
        document.getElementById('newsletterContent').value = '';
        document.getElementById('newsletterStatus').value = 'draft';
        document.getElementById('newsletterDeleteBtn').style.display = 'none';
        document.getElementById('newsletterModal').style.display = 'flex';
      }

      // Edit newsletter
      window.editNewsletter = async function(id) {
        currentNewsletterId = id;
        const newsletter = newsletters.find(n => n.id === id);
        if (!newsletter) return;

        document.getElementById('newsletterModalTitle').innerHTML = '<i class="ri-edit-line"></i> Edit Newsletter';
        document.getElementById('newsletterId').value = newsletter.id;
        document.getElementById('newsletterSubject').value = newsletter.subject;
        document.getElementById('newsletterContent').value = newsletter.content;
        document.getElementById('newsletterStatus').value = newsletter.status;
        document.getElementById('newsletterDeleteBtn').style.display = newsletter.status === 'sent' ? 'none' : 'block';
        document.getElementById('newsletterModal').style.display = 'flex';
      };

      // Save newsletter
      async function saveNewsletter(andSend = false) {
        const subject = document.getElementById('newsletterSubject').value.trim();
        const content = document.getElementById('newsletterContent').value.trim();
        const status = andSend ? 'sent' : document.getElementById('newsletterStatus').value;

        if (!subject || !content) {
          showNotification('Subject and content are required', 'error');
          return;
        }

        try {
          const isEdit = currentNewsletterId !== null;
          const url = isEdit ? `/api/newsletter/${currentNewsletterId}` : '/api/newsletter';
          const method = isEdit ? 'PUT' : 'POST';

          const res = await fetch(getApiUrl(url), {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ subject, content, status })
          });

          const data = await res.json();
          if (data.success) {
            if (andSend) {
              // Send the newsletter
              await sendNewsletter(data.newsletter.id);
            } else {
              showNotification(isEdit ? 'Newsletter updated!' : 'Newsletter created!', 'success');
              document.getElementById('newsletterModal').style.display = 'none';
              await loadNewsletters();
            }
          } else {
            showNotification(data.error || 'Failed to save newsletter', 'error');
          }
        } catch (error) {
          console.error('Failed to save newsletter:', error);
          showNotification('Failed to save newsletter', 'error');
        }
      }

      // Preview and send newsletter
      window.previewAndSendNewsletter = async function(id) {
        const newsletter = newsletters.find(n => n.id === id);
        if (!newsletter) return;

        const activeCount = subscribers.filter(s => s.status === 'active').length;
        if (activeCount === 0) {
          showNotification('No active subscribers to send to', 'error');
          return;
        }

        document.getElementById('previewSubject').textContent = newsletter.subject;
        document.getElementById('previewContent').innerHTML = newsletter.content;
        document.getElementById('previewRecipients').textContent = activeCount;
        
        document.getElementById('confirmSendBtn').onclick = () => sendNewsletter(id);
        document.getElementById('newsletterPreviewModal').style.display = 'flex';
      };

      // Send newsletter
      async function sendNewsletter(id) {
        try {
          const res = await fetch(getApiUrl(`/api/newsletter/${id}/send`), {
            method: 'POST',
            credentials: 'include'
          });

          const data = await res.json();
          if (data.success) {
            showNotification(data.message, 'success');
            document.getElementById('newsletterPreviewModal').style.display = 'none';
            document.getElementById('newsletterModal').style.display = 'none';
            await loadNewsletters();
          } else {
            showNotification(data.error || 'Failed to send newsletter', 'error');
          }
        } catch (error) {
          console.error('Failed to send newsletter:', error);
          showNotification('Failed to send newsletter', 'error');
        }
      }

      // Delete newsletter
      window.deleteNewsletter = async function(id) {
        const confirmed = await AdminUniModal.danger('Delete Newsletter', 'Are you sure you want to delete this newsletter?', 'Yes, Delete');
        if (!confirmed) return;

        try {
          const res = await fetch(getApiUrl(`/api/newsletter/${id}`), {
            method: 'DELETE',
            credentials: 'include'
          });

          const data = await res.json();
          if (data.success) {
            showNotification('Newsletter deleted', 'success');
            document.getElementById('newsletterModal').style.display = 'none';
            await loadNewsletters();
          } else {
            showNotification(data.error || 'Failed to delete newsletter', 'error');
          }
        } catch (error) {
          console.error('Failed to delete newsletter:', error);
          showNotification('Failed to delete newsletter', 'error');
        }
      };

      // Delete subscriber
      window.deleteSubscriber = async function(id) {
        const confirmed = await AdminUniModal.danger('Delete Subscriber', 'Are you sure you want to delete this subscriber?', 'Yes, Delete');
        if (!confirmed) return;

        try {
          const res = await fetch(getApiUrl(`/api/newsletter/subscribers/${id}`), {
            method: 'DELETE',
            credentials: 'include'
          });

          const data = await res.json();
          if (data.success) {
            showNotification('Subscriber deleted', 'success');
            await loadSubscribers();
          } else {
            showNotification(data.error || 'Failed to delete subscriber', 'error');
          }
        } catch (error) {
          console.error('Failed to delete subscriber:', error);
          showNotification('Failed to delete subscriber', 'error');
        }
      };

      // Newsletter tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          
          // Remove active class from all tabs and buttons
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked button and corresponding tab
          this.classList.add('active');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // Event listeners for newsletter
      document.getElementById('createNewsletterBtn')?.addEventListener('click', showCreateNewsletterModal);
      document.getElementById('refreshNewsletterBtn')?.addEventListener('click', () => {
        loadNewsletters();
        loadSubscribers();
        loadNewsletterStats();
      });

      document.getElementById('newsletterForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        saveNewsletter(false);
      });

      document.getElementById('newsletterSendBtn')?.addEventListener('click', () => {
        saveNewsletter(true);
      });

      document.getElementById('newsletterModalCloseBtn')?.addEventListener('click', () => {
        document.getElementById('newsletterModal').style.display = 'none';
      });

      document.getElementById('newsletterCancelBtn')?.addEventListener('click', () => {
        document.getElementById('newsletterModal').style.display = 'none';
      });

      document.getElementById('newsletterDeleteBtn')?.addEventListener('click', () => {
        if (currentNewsletterId) deleteNewsletter(currentNewsletterId);
      });

      document.getElementById('newsletterPreviewCloseBtn')?.addEventListener('click', () => {
        document.getElementById('newsletterPreviewModal').style.display = 'none';
      });

      document.getElementById('cancelSendBtn')?.addEventListener('click', () => {
        document.getElementById('newsletterPreviewModal').style.display = 'none';
      });

      // ===============================
      // AI ANALYTICS FUNCTIONS
      // ===============================
      
      // AI Health Dashboard Functions
      async function loadAiHealthDashboard() {
        try {
          // Load full health check
          const healthRes = await fetch(getApiUrl('/api/ai/health/full'), { credentials: 'include' });
          const healthData = await healthRes.json();
          
          if (healthData) {
            renderSystemHealth(healthData.system || {});
            renderAiEngines(healthData.ai_engines || healthData.aiEngines || {});
            updateAiHealthStatus(healthData.overall_status || healthData.status || 'unknown');
          }
          
          // Load AI capabilities
          const capRes = await fetch(getApiUrl('/api/ai/capabilities'), { credentials: 'include' });
          const capData = await capRes.json();
          
          if (capData && capData.engines) {
            updateEngineCount(capData.engines);
          }
          
          // Load payment verification stats
          await loadPaymentAiStats();
        } catch (error) {
          console.error('[AI-Health] Error loading:', error);
          updateAiHealthStatus('error');
        }
      }
      
      function renderSystemHealth(system) {
        const resources = system.resources || {};
        const cpu = resources.cpu || {};
        const memory = resources.memory || {};
        const disk = resources.disk || {};
        
        // Update CPU
        const cpuUsage = cpu.percent || cpu.usage || 0;
        document.getElementById('systemCpuUsage').textContent = cpuUsage.toFixed(1) + '%';
        updateStatCardStatus('systemCpuCard', cpuUsage, 70, 90);
        
        // Update Memory
        const memUsage = memory.percent || memory.usage || 0;
        document.getElementById('systemMemoryUsage').textContent = memUsage.toFixed(1) + '%';
        updateStatCardStatus('systemMemoryCard', memUsage, 70, 90);
        
        // Update Disk
        const diskUsage = disk.percent || disk.usage || 0;
        document.getElementById('systemDiskUsage').textContent = diskUsage.toFixed(1) + '%';
        updateStatCardStatus('systemDiskCard', diskUsage, 80, 95);
      }
      
      function updateStatCardStatus(cardId, value, warnThreshold, critThreshold) {
        const card = document.getElementById(cardId);
        if (!card) return;
        
        card.classList.remove('stat-success', 'stat-warning', 'stat-danger');
        if (value >= critThreshold) {
          card.classList.add('stat-danger');
        } else if (value >= warnThreshold) {
          card.classList.add('stat-warning');
        } else {
          card.classList.add('stat-success');
        }
      }
      
      function renderAiEngines(enginesData) {
        const grid = document.getElementById('aiEnginesGrid');
        if (!grid) return;
        
        const engines = enginesData.engines || enginesData || [];
        const engineArray = Array.isArray(engines) ? engines : Object.entries(engines).map(([name, data]) => ({
          name,
          ...data
        }));
        
        if (engineArray.length === 0) {
          grid.innerHTML = '<div class="engine-card"><div class="engine-icon"><i class="ri-information-line"></i></div><div class="engine-info"><h4>No Engines Found</h4><p>AI engines are not responding</p></div></div>';
          return;
        }
        
        let healthyCount = 0;
        const totalCount = engineArray.length;
        
        grid.innerHTML = engineArray.map(engine => {
          const isHealthy = engine.status === 'healthy' || engine.healthy === true || engine.status === 'ok';
          if (isHealthy) healthyCount++;
          
          const statusClass = isHealthy ? 'healthy' : 'unhealthy';
          const statusIcon = isHealthy ? 'ri-checkbox-circle-line' : 'ri-error-warning-line';
          const statusColor = isHealthy ? '#16a34a' : '#dc2626';
          const bgColor = isHealthy ? '#f0fdf4' : '#fef2f2';
          
          const engineIcons = {
            analytics: 'ri-bar-chart-box-line',
            fraud: 'ri-shield-check-line',
            email: 'ri-mail-line',
            search: 'ri-search-line',
            recommend: 'ri-star-line',
            price: 'ri-price-tag-3-line',
            image: 'ri-image-line',
            payment: 'ri-bank-card-line',
            health: 'ri-heart-pulse-line',
            analysis: 'ri-pie-chart-line',
            neural: 'ri-cpu-line',
            emotion: 'ri-emotion-line',
            performance: 'ri-speed-up-line',
            errors: 'ri-bug-line',
            ml: 'ri-brain-line',
            security: 'ri-lock-password-line',
            realtime: 'ri-flashlight-line',
            seo: 'ri-global-line',
            sales: 'ri-money-dollar-box-line'
          };
          
          const engineName = engine.name || engine.engine || 'Unknown';
          const icon = engineIcons[engineName.toLowerCase()] || 'ri-robot-2-line';
          
          return `
            <div class="engine-card ${statusClass}" style="background: ${bgColor}; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
              <div class="engine-icon" style="font-size: 1.5rem; color: ${statusColor};">
                <i class="${icon}"></i>
              </div>
              <div class="engine-info" style="flex: 1;">
                <h4 style="margin: 0; font-size: 0.95rem; color: #0f172a; text-transform: capitalize;">${engineName}</h4>
                <p style="margin: 4px 0 0; font-size: 0.8rem; color: #64748b;">${engine.message || (isHealthy ? 'Running' : 'Error')}</p>
              </div>
              <div class="engine-status">
                <i class="${statusIcon}" style="font-size: 1.25rem; color: ${statusColor};"></i>
              </div>
            </div>
          `;
        }).join('');
        
        // Update engines count
        document.getElementById('aiEnginesStatus').textContent = `${healthyCount}/${totalCount}`;
        document.getElementById('aiEnginesHealthBadge').textContent = healthyCount === totalCount ? 'All Healthy' : `${totalCount - healthyCount} Issues`;
        document.getElementById('aiEnginesHealthBadge').className = 'ai-badge ' + (healthyCount === totalCount ? 'success' : 'warning');
      }
      
      function updateAiHealthStatus(status) {
        const badge = document.getElementById('aiHealthStatusBadge');
        const statusText = document.getElementById('aiHealthStatus');
        if (!badge || !statusText) return;
        
        badge.classList.remove('healthy', 'warning', 'error');
        
        if (status === 'healthy' || status === 'ok') {
          badge.classList.add('healthy');
          badge.style.background = '#dcfce7';
          badge.style.color = '#16a34a';
          statusText.textContent = 'All Systems OK';
        } else if (status === 'warning' || status === 'degraded') {
          badge.classList.add('warning');
          badge.style.background = '#fef3c7';
          badge.style.color = '#d97706';
          statusText.textContent = 'Degraded';
        } else {
          badge.classList.add('error');
          badge.style.background = '#fef2f2';
          badge.style.color = '#dc2626';
          statusText.textContent = 'Issues Detected';
        }
      }
      
      function updateEngineCount(engines) {
        const count = Array.isArray(engines) ? engines.length : Object.keys(engines).length;
        const statusEl = document.getElementById('aiEnginesStatus');
        if (statusEl && statusEl.textContent === '0/0') {
          statusEl.textContent = `?/${count}`;
        }
      }
      
      async function loadPaymentAiStats() {
        try {
          const ordersRes = await fetch(getApiUrl('/api/orders'), { credentials: 'include' });
          const ordersData = await ordersRes.json();
          
          if (ordersData.success && ordersData.orders) {
            let approved = 0, flagged = 0, blocked = 0, review = 0;
            
            ordersData.orders.forEach(order => {
              const verification = order.aiVerification || {};
              switch (verification.action) {
                case 'APPROVE': approved++; break;
                case 'FLAG': flagged++; break;
                case 'BLOCK': blocked++; break;
                case 'MANUAL_REVIEW': review++; break;
                default: if (verification.verified) approved++;
              }
            });
            
            document.getElementById('paymentsApproved').textContent = approved;
            document.getElementById('paymentsFlagged').textContent = flagged;
            document.getElementById('paymentsBlocked').textContent = blocked;
            document.getElementById('paymentsReview').textContent = review;
          }
        } catch (error) {
          console.error('[Payment-AI] Error loading stats:', error);
        }
      }
      
      async function runAiDiagnostics() {
        const output = document.getElementById('debugOutput');
        const diagnosticsList = document.getElementById('diagnosticsList');
        
        if (output) {
          output.innerHTML = '<div class="debug-line" style="color: #89b4fa;">> Running full diagnostics...</div>';
        }
        
        try {
          const res = await fetch(getApiUrl('/api/ai/diagnostics'), { credentials: 'include' });
          const data = await res.json();
          
          if (output) {
            let lines = ['<div class="debug-line" style="color: #a6e3a1;">> Diagnostics complete</div>'];
            
            // System health
            const sys = data.fullHealth?.system || {};
            const res = sys.resources || {};
            lines.push(`<div class="debug-line" style="color: #cdd6f4;">> CPU: ${(res.cpu?.percent || 0).toFixed(1)}% | Memory: ${(res.memory?.percent || 0).toFixed(1)}% | Disk: ${(res.disk?.percent || 0).toFixed(1)}%</div>`);
            
            // Engine diagnostics
            const engines = data.engineDiagnostics || {};
            Object.entries(engines).forEach(([name, diag]) => {
              const status = diag.status === 'healthy' || diag.healthy ? '' : '';
              const color = diag.status === 'healthy' || diag.healthy ? '#a6e3a1' : '#f38ba8';
              lines.push(`<div class="debug-line" style="color: ${color};">> [${status}] ${name}: ${diag.message || diag.status || 'unknown'}</div>`);
            });
            
            output.innerHTML = lines.join('');
          }
          
          // Add to diagnostics list
          if (diagnosticsList) {
            const timestamp = new Date().toLocaleString();
            const summary = data.fullHealth?.overall_status || 'completed';
            const item = `
              <div class="diagnostic-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
                <i class="ri-stethoscope-line" style="color: #3b82f6;"></i>
                <span style="flex: 1; color: #374151;">Full System Diagnostics - <strong style="text-transform: capitalize;">${summary}</strong></span>
                <span style="font-size: 0.8rem; color: #9ca3af;">${timestamp}</span>
              </div>
            `;
            diagnosticsList.insertAdjacentHTML('afterbegin', item);
          }
          
          showNotification('Diagnostics completed', 'success');
        } catch (error) {
          console.error('[AI-Diagnostics] Error:', error);
          if (output) {
            output.innerHTML += `<div class="debug-line" style="color: #f38ba8;">> Error: ${error.message}</div>`;
          }
          showNotification('Diagnostics failed: ' + error.message, 'error');
        }
      }
      
      async function analyzeRecentErrors() {
        const output = document.getElementById('debugOutput');
        
        if (output) {
          output.innerHTML = '<div class="debug-line" style="color: #89b4fa;">> Fetching error logs...</div>';
        }
        
        try {
          // Fetch client errors
          const res = await fetch(getApiUrl('/api/logs/client-errors'), { credentials: 'include' });
          const errors = await res.json();
          
          if (output) {
            output.innerHTML += '<div class="debug-line" style="color: #cdd6f4;">> Sending to AI for analysis...</div>';
          }
          
          // Send to AI for analysis
          const analysisRes = await fetch(getApiUrl('/api/ai/debug/logs'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ logs: errors.errors || errors || [] })
          });
          
          const analysis = await analysisRes.json();
          
          if (output) {
            let lines = ['<div class="debug-line" style="color: #a6e3a1;">> Analysis complete</div>'];
            
            const issues = analysis.issues || analysis.patterns || [];
            if (issues.length === 0) {
              lines.push('<div class="debug-line" style="color: #a6e3a1;">> No significant issues found!</div>');
            } else {
              issues.forEach((issue, i) => {
                lines.push(`<div class="debug-line" style="color: #fab387;">> Issue ${i + 1}: ${issue.type || issue.pattern || issue}</div>`);
                if (issue.suggestion) {
                  lines.push(`<div class="debug-line" style="color: #94e2d5; margin-left: 16px;">   Fix: ${issue.suggestion}</div>`);
                }
              });
            }
            
            output.innerHTML = lines.join('');
          }
          
          showNotification('Error analysis completed', 'info');
        } catch (error) {
          console.error('[AI-Debug] Error:', error);
          if (output) {
            output.innerHTML += `<div class="debug-line" style="color: #f38ba8;">> Error: ${error.message}</div>`;
          }
        }
      }
      
      async function loadAiAnalytics() {
        try {
          // Load AI insights
          const insightsRes = await fetch(getApiUrl('/api/analytics/ai-insights'), { credentials: 'include' });
          const insightsData = await insightsRes.json();
          
          if (insightsData.success) {
            renderAiInsights(insightsData.insights || []);
            renderAnomalies(insightsData.anomalies || []);
          }
          
          // Load predictions
          const predictRes = await fetch(getApiUrl('/api/analytics/predictions'), { credentials: 'include' });
          const predictData = await predictRes.json();
          
          if (predictData.success && predictData.predictions) {
            renderPredictions(predictData.predictions.traffic || []);
          }
          
          // Load segments
          const segmentsRes = await fetch(getApiUrl('/api/analytics/segments'), { credentials: 'include' });
          const segmentsData = await segmentsRes.json();
          
          if (segmentsData.success && segmentsData.segmentation) {
            renderSegments(segmentsData.segmentation.stats || {});
          }
          
          // Load funnel
          const funnelRes = await fetch(getApiUrl('/api/analytics/funnel'), { credentials: 'include' });
          const funnelData = await funnelRes.json();
          
          if (funnelData.success && funnelData.funnel) {
            renderFunnel(funnelData.funnel);
          }
        } catch (error) {
          console.error('[AI-Analytics] Error loading:', error);
        }
      }
      
      function renderAiInsights(insights) {
        const grid = document.getElementById('aiInsightsGrid');
        if (!grid) return;
        
        if (insights.length === 0) {
          grid.innerHTML = '<div class="ai-insight-card"><div class="insight-icon"><i class="ri-information-line"></i></div><div class="insight-content"><h4>No Insights Yet</h4><p>Need more data to generate insights</p></div></div>';
          return;
        }
        
        grid.innerHTML = insights.slice(0, 6).map(insight => {
          const icons = {
            'TRAFFIC_HIGH': 'ri-line-chart-line',
            'TRAFFIC_GROWING': 'ri-arrow-up-circle-line',
            'TRAFFIC_DECLINING': 'ri-arrow-down-circle-line',
            'LOW_CONVERSION': 'ri-shopping-cart-line',
            'HIGH_BOUNCE': 'ri-logout-circle-line',
            'ENGAGED_USERS': 'ri-user-heart-line'
          };
          const icon = icons[insight.type] || 'ri-lightbulb-flash-line';
          const severity = insight.severity || 'positive';
          
          return `
            <div class="ai-insight-card ${severity}">
              <div class="insight-icon"><i class="${icon}"></i></div>
              <div class="insight-content">
                <h4>${insight.title}</h4>
                <p>${insight.description}</p>
                <span class="insight-confidence"><i class="ri-sparkling-line"></i> ${Math.round((insight.confidence || 0.8) * 100)}% confidence</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      function renderAnomalies(anomalies) {
        const list = document.getElementById('anomaliesList');
        const count = document.getElementById('anomalyCount');
        if (!list) return;
        
        if (count) count.textContent = `${anomalies.length} detected`;
        
        if (anomalies.length === 0) {
          list.innerHTML = '<div class="no-anomalies"><i class="ri-checkbox-circle-line"></i><span>No anomalies detected - everything looks normal!</span></div>';
          return;
        }
        
        list.innerHTML = anomalies.map(anomaly => `
          <div class="anomaly-item ${anomaly.type === 'CRITICAL' ? '' : 'warning'}">
            <i class="ri-error-warning-line"></i>
            <div class="anomaly-info">
              <div class="metric">${anomaly.metric} on ${anomaly.date}</div>
              <div class="details">Value: ${anomaly.value} (expected ~${anomaly.expected}) - ${anomaly.deviation}</div>
            </div>
          </div>
        `).join('');
      }
      
      function renderPredictions(predictions) {
        const chart = document.getElementById('predictionsChart');
        if (!chart) return;
        
        if (predictions.length === 0) {
          chart.innerHTML = '<div class="prediction-loading">Need more historical data for predictions</div>';
          return;
        }
        
        const maxValue = Math.max(...predictions.map(p => p.predicted), 1);
        
        chart.innerHTML = predictions.map(pred => {
          const height = Math.max(10, (pred.predicted / maxValue) * 150);
          const date = new Date(pred.date);
          const dayName = date.toLocaleDateString('en', { weekday: 'short' });
          
          return `
            <div class="prediction-bar">
              <div class="value">${pred.predicted}</div>
              <div class="bar" style="height: ${height}px" title="Confidence: ${Math.round(pred.confidence * 100)}%"></div>
              <div class="date">${dayName}</div>
            </div>
          `;
        }).join('');
      }
      
      function renderSegments(stats) {
        const elements = {
          championsCount: stats.champions?.count || 0,
          loyalCount: stats.loyalCustomers?.count || 0,
          atRiskCount: stats.atRisk?.count || 0,
          newCustomersCount: stats.newCustomers?.count || 0
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        });
      }
      
      function renderFunnel(funnel) {
        const stages = funnel.stages || [];
        const rate = document.getElementById('conversionRate');
        const bottleneck = document.getElementById('bottleneckStage');
        
        if (rate) rate.textContent = funnel.overallConversionRate + '%';
        if (bottleneck) bottleneck.textContent = funnel.bottleneck || 'None';
        
        stages.forEach((stage, i) => {
          const ids = ['funnelPageViews', 'funnelProductViews', 'funnelAddToCart', 'funnelCheckout', 'funnelPurchase'];
          const el = document.getElementById(ids[i]);
          if (el) el.textContent = stage.count || 0;
        });
      }
      
      // ===============================
      // AI SEO FUNCTIONS
      // ===============================
      async function loadAiSeo() {
        try {
          // Load SEO overview
          const seoRes = await fetch(getApiUrl('/api/seo'), { credentials: 'include' });
          const seoData = await seoRes.json();
          
          if (seoData.success) {
            const keywordCount = document.getElementById('seoKeywordCount');
            if (keywordCount) keywordCount.textContent = seoData.keywordCount || 0;
          }
          
          // Load keywords for categories
          const keywordsRes = await fetch(getApiUrl('/api/seo/keywords'), { credentials: 'include' });
          const keywordsData = await keywordsRes.json();
          
          if (keywordsData.success && keywordsData.keywords) {
            renderKeywordCategories(keywordsData.keywords);
            renderTrendingKeywords(keywordsData.keywords);
          }
          
          // Load SEO report
          const reportRes = await fetch(getApiUrl('/api/seo/report'), { credentials: 'include' });
          const reportData = await reportRes.json();
          
          if (reportData.success && reportData.report) {
            renderSeoScore(reportData.report);
            renderSeoRecommendations(reportData.report.recommendations || []);
          }
        } catch (error) {
          console.error('[AI-SEO] Error loading:', error);
        }
      }
      
      function renderKeywordCategories(keywords) {
        const counts = {
          productKeywords: (keywords.products || []).length + (keywords.brand || []).length,
          localKeywords: (keywords.localSEO || []).length,
          seasonalKeywords: (keywords.seasonal || []).length,
          intentKeywords: (keywords.buyingIntent || []).length
        };
        
        Object.entries(counts).forEach(([id, count]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = count;
        });
      }
      
      function renderTrendingKeywords(keywords) {
        const container = document.getElementById('trendingKeywords');
        if (!container) return;
        
        // Flatten and pick random trending keywords
        const allKeywords = Object.values(keywords).flat().slice(0, 20);
        const trending = allKeywords.sort(() => Math.random() - 0.5).slice(0, 12);
        
        container.innerHTML = trending.map((kw, i) => 
          `<span class="keyword-tag ${i < 3 ? 'hot' : ''}">${i < 3 ? ' ' : ''}${kw}</span>`
        ).join('');
      }
      
      function renderSeoScore(report) {
        const score = report.score || 75;
        const scoreEl = document.getElementById('seoScore');
        const descEl = document.getElementById('seoScoreDesc');
        const circle = document.getElementById('seoScoreCircle');
        
        if (scoreEl) scoreEl.textContent = score;
        if (descEl) {
          if (score >= 80) descEl.textContent = 'Excellent! Your SEO is well optimized.';
          else if (score >= 60) descEl.textContent = 'Good, but there\'s room for improvement.';
          else descEl.textContent = 'Needs attention. Follow the recommendations below.';
        }
        
        if (circle) {
          // Animate the circle (283 is the circumference of r=45 circle)
          const offset = 283 - (283 * score / 100);
          circle.style.strokeDashoffset = offset;
        }
      }
      
      function renderSeoRecommendations(recommendations) {
        const container = document.getElementById('seoRecommendations');
        if (!container) return;
        
        if (recommendations.length === 0) {
          container.innerHTML = '<div class="recommendation-item success"><i class="ri-checkbox-circle-line"></i><span>All SEO checks passed! Great job.</span></div>';
          return;
        }
        
        container.innerHTML = recommendations.map(rec => {
          const type = rec.priority === 'high' ? 'warning' : '';
          const icon = rec.priority === 'high' ? 'ri-alert-line' : 'ri-information-line';
          return `<div class="recommendation-item ${type}"><i class="${icon}"></i><span>${rec.message || rec}</span></div>`;
        }).join('');
      }
      
      // Initialize AI sections
      function initAiSections() {
        // Refresh buttons
        document.getElementById('refreshAiAnalyticsBtn')?.addEventListener('click', () => {
          loadAiAnalytics();
          showNotification('AI Analytics refreshed', 'info');
        });
        document.getElementById('refreshSeoBtn')?.addEventListener('click', () => {
          loadAiSeo();
          showNotification('SEO settings refreshed', 'info');
        });
        document.getElementById('refreshAiHealthBtn')?.addEventListener('click', () => {
          loadAiHealthDashboard();
          showNotification('AI Health refreshed', 'info');
        });
        document.getElementById('runDiagnosticsBtn')?.addEventListener('click', () => {
          runAiDiagnostics();
        });
        document.getElementById('analyzeErrorsBtn')?.addEventListener('click', () => {
          analyzeRecentErrors();
        });
        
        // Load on section view
        window.addEventListener('hashchange', () => {
          const hash = window.location.hash;
          if (hash === '#ai-analytics') loadAiAnalytics();
          if (hash === '#ai-seo') loadAiSeo();
          if (hash === '#ai-health-dashboard') loadAiHealthDashboard();
        });
        
        // Initial load if on AI section
        const hash = window.location.hash;
        if (hash === '#ai-analytics') loadAiAnalytics();
        if (hash === '#ai-seo') loadAiSeo();
        if (hash === '#ai-health-dashboard') loadAiHealthDashboard();
      }

      // ===============================
      // INITIALIZE NEW SECTIONS
      // ===============================
      function initializeNewSections() {
        // Initialize master toggles
        initMasterToggles();
        
        // Initialize company tax and gift cards
        initCompanyTax();
        initGiftCards();
        
        // Initialize newsletter management
        if (typeof loadNewsletters === 'function') {
          loadNewsletters();
          loadSubscribers();
          loadNewsletterStats();
        }
        
        // Initialize AI sections
        initAiSections();
        
        // Load data when section becomes visible
        window.addEventListener('hashchange', () => {
          const hash = window.location.hash;
          switch(hash) {
            case '#sku-management': loadSkuData(); break;
            case '#inventory-management': loadInventoryData(); break;
            case '#marketing-management': loadMarketingSettings(); loadCoupons(); break;
            case '#shipping-management': loadShippingSettings(); break;
            case '#tax-management': loadTaxSettings(); break;
            case '#company-tax': loadCompanyTaxData(); break;
            case '#gift-cards': loadGiftCards(); break;
            case '#newsletter': loadNewsletters(); loadSubscribers(); loadNewsletterStats(); break;
            case '#ai-analytics': loadAiAnalytics(); break;
            case '#ai-seo': loadAiSeo(); break;
            case '#ai-health-dashboard': loadAiHealthDashboard(); break;
          }
        });
        
        // Initial load if already on a new section
        const hash = window.location.hash;
        if (hash === '#sku-management') loadSkuData();
        if (hash === '#inventory-management') loadInventoryData();
        if (hash === '#marketing-management') { loadMarketingSettings(); loadCoupons(); }
        if (hash === '#shipping-management') loadShippingSettings();
        if (hash === '#tax-management') loadTaxSettings();
        if (hash === '#company-tax') loadCompanyTaxData();
        if (hash === '#gift-cards') loadGiftCards();
        if (hash === '#newsletter') { loadNewsletters(); loadSubscribers(); loadNewsletterStats(); }
        if (hash === '#ai-analytics') loadAiAnalytics();
        if (hash === '#ai-seo') loadAiSeo();
      }
      
      // ===============================
      // AUTO-REFRESH FUNCTIONALITY (2 MINUTE INTERVALS)
      // ===============================
      const autoRefreshIntervals = {};
      const AUTO_REFRESH_DELAY = 2 * 60 * 1000; // 2 minutes in milliseconds
      
      function startAutoRefresh(sectionId, refreshFunction) {
        // Clear any existing interval for this section
        if (autoRefreshIntervals[sectionId]) {
          clearInterval(autoRefreshIntervals[sectionId]);
        }
        
        // Only set up interval if function exists
        if (typeof refreshFunction === 'function') {
          autoRefreshIntervals[sectionId] = setInterval(() => {
            console.log(`[AUTO-REFRESH] Refreshing ${sectionId}`);
            try {
              refreshFunction();
            } catch (error) {
              console.error(`[AUTO-REFRESH] Error refreshing ${sectionId}:`, error);
            }
          }, AUTO_REFRESH_DELAY);
        }
      }
      
      function stopAutoRefresh(sectionId) {
        if (autoRefreshIntervals[sectionId]) {
          clearInterval(autoRefreshIntervals[sectionId]);
          delete autoRefreshIntervals[sectionId];
        }
      }
      
      function initializeAutoRefresh() {
        // Start auto-refresh for all sections that need it
        // Using actual function names that exist in the codebase
        startAutoRefresh('messages', () => {
          if (typeof loadAndRenderMessages === 'function') loadAndRenderMessages();
        });
        startAutoRefresh('health', () => {
          if (typeof runHealthCheck === 'function') runHealthCheck();
        });
        startAutoRefresh('ai-analytics', () => {
          if (typeof loadAiAnalytics === 'function') loadAiAnalytics();
        });
        startAutoRefresh('ai-seo', () => {
          if (typeof loadAiSeo === 'function') loadAiSeo();
        });
        startAutoRefresh('sku-management', () => {
          if (typeof loadSkuData === 'function') loadSkuData();
        });
        startAutoRefresh('inventory', () => {
          if (typeof loadInventoryData === 'function') loadInventoryData();
        });
        startAutoRefresh('marketing', () => {
          if (typeof loadMarketingSettings === 'function') loadMarketingSettings();
          if (typeof loadCoupons === 'function') loadCoupons();
        });
        startAutoRefresh('shipping', () => {
          if (typeof loadShippingSettings === 'function') loadShippingSettings();
        });
        startAutoRefresh('tax', () => {
          if (typeof loadTaxSettings === 'function') loadTaxSettings();
        });
        startAutoRefresh('company-tax', () => {
          if (typeof loadCompanyTaxData === 'function') loadCompanyTaxData();
        });
        startAutoRefresh('gift-cards', () => {
          if (typeof loadGiftCards === 'function') loadGiftCards();
        });
        
        // Set up manual refresh button handlers
        document.getElementById('refreshProductsBtn')?.addEventListener('click', () => {
          if (typeof fetchProducts === 'function') fetchProducts();
          showNotification('Products refreshed', 'info');
        });
        document.getElementById('refreshMessagesBtn')?.addEventListener('click', () => {
          if (typeof loadAndRenderMessages === 'function') loadAndRenderMessages();
          showNotification('Messages refreshed', 'info');
        });
        document.getElementById('refreshHealthBtn')?.addEventListener('click', () => {
          if (typeof runHealthCheck === 'function') runHealthCheck();
          showNotification('System health checked', 'info');
        });
        document.getElementById('refreshSkuBtn')?.addEventListener('click', () => {
          if (typeof loadSkuData === 'function') loadSkuData();
          showNotification('SKU data refreshed', 'info');
        });
        document.getElementById('refreshInventoryBtn')?.addEventListener('click', () => {
          if (typeof loadInventoryData === 'function') loadInventoryData();
          showNotification('Inventory data refreshed', 'info');
        });
        document.getElementById('refreshMarketingBtn')?.addEventListener('click', () => {
          if (typeof loadMarketingSettings === 'function') loadMarketingSettings();
          if (typeof loadCoupons === 'function') loadCoupons();
          showNotification('Marketing settings refreshed', 'info');
        });
        document.getElementById('refreshShippingBtn')?.addEventListener('click', () => {
          if (typeof loadShippingSettings === 'function') loadShippingSettings();
          showNotification('Shipping settings refreshed', 'info');
        });
        document.getElementById('refreshTaxBtn')?.addEventListener('click', () => {
          if (typeof loadTaxSettings === 'function') loadTaxSettings();
          showNotification('Tax settings refreshed', 'info');
        });
        document.getElementById('refreshCompanyTaxBtn')?.addEventListener('click', () => {
          if (typeof loadCompanyTaxData === 'function') loadCompanyTaxData();
          showNotification('Company tax data refreshed', 'info');
        });
        document.getElementById('refreshCompanyTaxBtnAlt')?.addEventListener('click', () => {
          if (typeof loadCompanyTaxData === 'function') loadCompanyTaxData();
          showNotification('Company tax data refreshed', 'info');
        });
        document.getElementById('refreshGiftCardsBtn')?.addEventListener('click', () => {
          if (typeof loadGiftCards === 'function') loadGiftCards();
          showNotification('Gift cards refreshed', 'info');
        });
        
        // Initialize advanced systems statistics
        updateAdvancedSystemsStats();
      }
      
      // Update statistics for advanced systems sections
      function updateAdvancedSystemsStats() {
        // Real-Time Manager
        if (window.realtimeManager) {
          try {
            document.getElementById('realtimeConnections').textContent = window.realtimeManager.connectedClients?.size || 0;
            document.getElementById('realtimeMessages').textContent = window.realtimeManager.messageCount || 0;
            document.getElementById('wsStatus').textContent = window.realtimeManager.isConnected ? 'Connected' : 'Disconnected';
            document.getElementById('wsStatus').className = window.realtimeManager.isConnected ? 'pill success' : 'pill danger';
          } catch (e) { /* ignore */ }
        }
        
        // Security Manager
        if (window.securityManager) {
          try {
            const stats = window.securityManager.getStats?.() || {};
            document.getElementById('blockedAttempts').textContent = stats.blockedAttempts || 0;
            document.getElementById('secureRequests').textContent = stats.secureRequests || 0;
            document.getElementById('spamDetected').textContent = stats.spamDetected || 0;
          } catch (e) { /* ignore */ }
        }
        
        // ML Engine
        if (window.mlEngine) {
          try {
            const stats = window.mlEngine.getStats?.() || {};
            document.getElementById('mlPredictions').textContent = stats.predictions || 0;
            document.getElementById('mlTrainingData').textContent = stats.trainingData || 0;
          } catch (e) { /* ignore */ }
        }
        
        // Error Tracker
        if (window.errorTracker) {
          try {
            const errors = window.errorTracker.getErrors?.() || [];
            document.getElementById('totalErrors').textContent = errors.length;
            const today = errors.filter(e => {
              const errorDate = new Date(e.timestamp);
              const todayDate = new Date();
              return errorDate.toDateString() === todayDate.toDateString();
            });
            document.getElementById('errorsToday').textContent = today.length;
          } catch (e) { /* ignore */ }
        }
        
        // A/B Testing
        if (window.abTesting) {
          try {
            const tests = window.abTesting.getActiveTests?.() || [];
            document.getElementById('activeTests').textContent = tests.length;
          } catch (e) { /* ignore */ }
        }
        
        // Emotion AI
        if (window.emotionAI) {
          try {
            const stats = window.emotionAI.getStats?.() || {};
            document.getElementById('emotionDetections').textContent = stats.detections || 0;
            document.getElementById('uxAdaptations').textContent = stats.adaptations || 0;
          } catch (e) { /* ignore */ }
        }
        
        // Biometric Auth
        if (window.biometricAuth) {
          try {
            const stats = window.biometricAuth.getStats?.() || {};
            document.getElementById('biometricUsers').textContent = stats.registeredUsers || 0;
            document.getElementById('biometricLogins').textContent = stats.loginsToday || 0;
          } catch (e) { /* ignore */ }
        }
        
        // Neural Commerce
        if (window.neuralCommerce) {
          try {
            const stats = window.neuralCommerce.getStats?.() || {};
            document.getElementById('intentPredictions').textContent = stats.predictions || 0;
            document.getElementById('purchaseIntents').textContent = stats.purchaseIntents || 0;
          } catch (e) { /* ignore */ }
        }
      }
      
      // Auto-refresh advanced systems stats every 5 seconds
      setInterval(updateAdvancedSystemsStats, 5000);
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          initializeNewSections();
          initializeAutoRefresh();
          initializeAdvancedSystems();
        });
      } else {
        initializeNewSections();
        initializeAutoRefresh();
        initializeAdvancedSystems();
      }
    </script>

    <script>
      // ========================================
      // ADVANCED SYSTEMS FUNCTIONALITY
      // ========================================
      
      function initializeAdvancedSystems() {
        // Real-Time Manager
        initRealtimeManager();
        
        // Security Manager
        initSecurityManager();
        
        // ML Engine
        initMLEngine();
        
        // Error Tracker
        initErrorTracker();
        
        // A/B Testing
        initABTesting();
        
        // Performance Optimizer
        initPerformanceOptimizer();
        
        // PWA Manager
        initPWAManager();
        
        // Emotion AI
        initEmotionAI();
        
        // Biometric Auth
        initBiometricAuth();
        
        // Neural Commerce
        initNeuralCommerce();
        
        // Load Deleted Users
        loadDeletedUsers();
        
        console.log('[Admin] All advanced systems initialized');
      }
      
      // ========================================
      // REAL-TIME MANAGER
      // ========================================
      let realtimeManagerInitialized = false;
      function initRealtimeManager() {
        if (realtimeManagerInitialized) return;
        realtimeManagerInitialized = true;
        
        document.getElementById('refreshRealtimeBtn')?.addEventListener('click', () => {
          updateRealtimeStats();
          showNotification('Real-time stats refreshed', 'success');
        });
        
        document.getElementById('reconnectRealtimeBtn')?.addEventListener('click', () => {
          if (window.realtimeManager && window.realtimeManager.init) {
            window.realtimeManager.init();
            showNotification('Reconnecting to WebSocket...', 'info');
            setTimeout(() => {
              updateRealtimeStats();
              if (window.realtimeManager.isConnected) {
                showNotification('WebSocket reconnected successfully', 'success');
              } else {
                showNotification('WebSocket connection failed', 'error');
              }
            }, 1000);
          } else {
            showNotification('Real-time manager not available', 'warning');
          }
        });
        
        updateRealtimeStats();
      }
      
      function updateRealtimeStats() {
        if (window.realtimeManager) {
          try {
            const isConnected = window.realtimeManager.isConnected || false;
            const connections = window.realtimeManager.connectedClients?.size || 0;
            const messages = window.realtimeManager.messageCount || 0;
            const events = window.realtimeManager.eventCount || 0;
            
            document.getElementById('realtimeConnections').textContent = connections;
            document.getElementById('realtimeMessages').textContent = messages;
            document.getElementById('realtimeEvents').textContent = events;
            document.getElementById('wsStatus').textContent = isConnected ? 'Connected' : 'Disconnected';
            document.getElementById('wsStatus').className = isConnected ? 'pill success' : 'pill danger';
            
            // Calculate uptime
            if (window.realtimeManager.startTime) {
              const uptime = Date.now() - window.realtimeManager.startTime;
              const hours = Math.floor(uptime / 3600000);
              const minutes = Math.floor((uptime % 3600000) / 60000);
              document.getElementById('realtimeUptime').textContent = `${hours}h ${minutes}m`;
            }
          } catch (e) {
            console.log('[Admin] Real-time manager not fully initialized');
          }
        } else {
          // Show demo data
          document.getElementById('realtimeConnections').textContent = Math.floor(Math.random() * 50);
          document.getElementById('realtimeMessages').textContent = Math.floor(Math.random() * 1000);
          document.getElementById('realtimeEvents').textContent = Math.floor(Math.random() * 500);
          document.getElementById('wsStatus').textContent = 'Simulated';
          document.getElementById('wsStatus').className = 'pill info';
        }
      }
      
      // ========================================
      // SECURITY MANAGER
      // ========================================
      let securityManagerInitialized = false;
      function initSecurityManager() {
        if (securityManagerInitialized) return;
        securityManagerInitialized = true;
        
        document.getElementById('refreshSecurityBtn')?.addEventListener('click', async () => {
          await updateSecurityStats();
          showNotification('Security stats refreshed', 'success');
        });
        
        // Dev Console toggle - save to settings API
        document.getElementById('allowDevConsoleEnabled')?.addEventListener('change', async (e) => {
          await updateDevConsoleSetting(e.target.checked);
          showNotification(`Developer Console ${e.target.checked ? 'allowed' : 'blocked'} for users`, 'success');
        });
        
        // Security toggles - save to backend
        document.getElementById('rateLimitEnabled')?.addEventListener('change', async (e) => {
          await updateSecuritySettings({ rateLimitEnabled: e.target.checked });
          showNotification(`Rate limiting ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('csrfProtectionEnabled')?.addEventListener('change', async (e) => {
          await updateSecuritySettings({ csrfProtectionEnabled: e.target.checked });
          showNotification(`CSRF protection ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('xssProtectionEnabled')?.addEventListener('change', async (e) => {
          await updateSecuritySettings({ xssProtectionEnabled: e.target.checked });
          showNotification(`XSS protection ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        // Load dev console setting on init
        loadDevConsoleSetting();
        updateSecurityStats();
      }
      
      async function loadDevConsoleSetting() {
        try {
          const response = await fetch('/api/settings/security', { credentials: 'include' });
          const data = await response.json();
          if (data.success && data.security) {
            const toggle = document.getElementById('allowDevConsoleEnabled');
            if (toggle) toggle.checked = data.security.allowDevConsole === true;
          }
        } catch (e) {
          console.log('[Admin] Could not load dev console setting');
        }
      }
      
      async function updateDevConsoleSetting(allowed) {
        try {
          await fetch('/api/settings/security', {
            method: 'PATCH',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ allowDevConsole: allowed })
          });
        } catch (e) {
          console.error('Failed to update dev console setting:', e);
        }
      }
      
      async function updateSecuritySettings(settings) {
        try {
          await fetch('/api/admin/security/settings', {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
        } catch (e) {
          console.error('Failed to update security settings:', e);
        }
      }
      
      async function updateSecurityStats() {
        try {
          const response = await fetch('/api/admin/security', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('blockedAttempts').textContent = stats.blockedAttempts || 0;
            document.getElementById('secureRequests').textContent = stats.secureRequests || 0;
            document.getElementById('spamDetected').textContent = stats.spamDetected || 0;
            document.getElementById('securityScore').textContent = `${stats.securityScore || 95}%`;
            
            // Update toggles based on saved settings
            if (data.settings) {
              const rateLimit = document.getElementById('rateLimitEnabled');
              const csrf = document.getElementById('csrfProtectionEnabled');
              const xss = document.getElementById('xssProtectionEnabled');
              if (rateLimit) rateLimit.checked = data.settings.rateLimitEnabled !== false;
              if (csrf) csrf.checked = data.settings.csrfProtectionEnabled !== false;
              if (xss) xss.checked = data.settings.xssProtectionEnabled !== false;
            }
            
            // Render recent security events
            renderSecurityEvents(data.recentEvents || []);
          }
        } catch (e) {
          console.log('[Admin] Security API unavailable, showing defaults');
          document.getElementById('blockedAttempts').textContent = '0';
          document.getElementById('secureRequests').textContent = '0';
          document.getElementById('spamDetected').textContent = '0';
        }
      }
      
      function renderSecurityEvents(events) {
        const container = document.getElementById('securityEventsList');
        if (!container) return;
        
        if (events.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No security events recorded</div>';
          return;
        }
        
        container.innerHTML = events.slice(0, 10).map(event => `
          <div style="padding: 12px 16px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${event.type === 'blocked' ? '#ef4444' : event.type === 'warning' ? '#f59e0b' : '#10b981'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600;">${event.message}</div>
                <div style="font-size: 0.85rem; color: #6b7280;">${event.ip || 'Unknown IP'} - ${new Date(event.timestamp).toLocaleString()}</div>
              </div>
              <span class="pill ${event.type === 'blocked' ? 'danger' : event.type === 'warning' ? 'warning' : 'success'}">${event.type}</span>
            </div>
          </div>
        `).join('');
      }
      
      // ========================================
      // ML ENGINE
      // ========================================
      function initMLEngine() {
        document.getElementById('trainModelsBtn')?.addEventListener('click', async () => {
          showNotification('Training ML models...', 'info');
          
          try {
            const response = await fetch('/api/admin/ml/train', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (data.success) {
              showNotification(`Models trained! Accuracy: ${(data.trainingResult.accuracy * 100).toFixed(1)}%`, 'success');
              await updateMLStats();
            } else {
              showNotification(data.error || 'Training failed', 'error');
            }
          } catch (e) {
            showNotification('Model training failed: ' + e.message, 'error');
          }
        });
        
        updateMLStats();
      }
      
      async function updateMLStats() {
        try {
          const response = await fetch('/api/admin/ml', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('mlAccuracy').textContent = `${Math.round(stats.avgAccuracy * 100) || 87}%`;
            document.getElementById('mlPredictions').textContent = stats.predictions || 0;
            document.getElementById('mlTrainingData').textContent = stats.trainingDataPoints || 0;
            document.getElementById('mlModels').textContent = stats.activeModels || 0;
            
            // Render models list
            renderMLModels(data.models || []);
          }
        } catch (e) {
          console.log('[Admin] ML API unavailable');
          document.getElementById('mlPredictions').textContent = '0';
          document.getElementById('mlTrainingData').textContent = '0';
        }
      }
      
      function renderMLModels(models) {
        const container = document.getElementById('mlModelsList');
        if (!container) return;
        
        if (models.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No ML models configured</div>';
          return;
        }
        
        container.innerHTML = models.map(model => `
          <div style="padding: 12px 16px; background: white; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600;">${model.name}</div>
              <div style="font-size: 0.85rem; color: #6b7280;">Last trained: ${model.lastTrained ? new Date(model.lastTrained).toLocaleDateString() : 'Never'}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600; color: ${model.accuracy >= 0.8 ? '#10b981' : '#f59e0b'};">${(model.accuracy * 100).toFixed(1)}%</div>
              <span class="pill ${model.status === 'active' ? 'success' : 'warning'}">${model.status}</span>
            </div>
          </div>
        `).join('');
      }
      
      // ========================================
      // ERROR TRACKER
      // ========================================
      let errorTrackerInitialized = false;
      function initErrorTracker() {
        if (errorTrackerInitialized) return;
        errorTrackerInitialized = true;
        
        document.getElementById('clearErrorsBtn')?.addEventListener('click', async () => {
          const confirmed = await AdminUniModal.danger('Clear All Errors', 'Are you sure you want to clear all error logs? This cannot be undone.', 'Clear All', 'Cancel');
          if (!confirmed) return;
          
          try {
            const response = await fetch('/api/admin/errors', {
              method: 'DELETE',
              credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
              await updateErrorTrackerStats();
              renderErrorsTable();
              showNotification('All errors cleared', 'success');
            }
          } catch (e) {
            showNotification('Failed to clear errors', 'error');
          }
        });
        
        updateErrorTrackerStats();
        renderErrorsTable();
      }
      
      async function updateErrorTrackerStats() {
        try {
          const response = await fetch('/api/admin/errors', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('totalErrors').textContent = stats.total || 0;
            document.getElementById('errorsToday').textContent = stats.today || 0;
            document.getElementById('affectedUsers').textContent = stats.uniqueUsers || 0;
            document.getElementById('errorRate').textContent = `${stats.errorRate || '0.0'}%`;
            
            // Store errors for table rendering
            window._errorsList = data.errors || [];
          }
        } catch (e) {
          console.log('[Admin] Error tracker API unavailable');
          document.getElementById('totalErrors').textContent = '0';
          document.getElementById('errorsToday').textContent = '0';
        }
      }
      
      function renderErrorsTable() {
        const tbody = document.getElementById('errorsTableBody');
        if (!tbody) return;
        
        const errors = window._errorsList || [];
        
        if (errors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No errors tracked</td></tr>';
          return;
        }
        
        tbody.innerHTML = errors.slice(-20).reverse().map(error => `
          <tr>
            <td>${new Date(error.timestamp).toLocaleTimeString()}</td>
            <td><span class="pill danger">${error.type || 'Error'}</span></td>
            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${error.message}</td>
            <td>${error.page || '-'}</td>
            <td>${error.userId || 'Guest'}</td>
            <td>
              <button class="secondary" style="padding: 4px 8px; font-size: 0.85rem;" onclick="viewErrorDetails('${error.id}')">
                <i class="ri-eye-line"></i>
              </button>
              <button class="secondary" style="padding: 4px 8px; font-size: 0.85rem; background: #d1fae5; color: #059669;" onclick="resolveError('${error.id}')">
                <i class="ri-check-line"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }
      
      window.viewErrorDetails = function(errorId) {
        const errors = window._errorsList || [];
        const error = errors.find(e => e.id === errorId);
        if (error) {
          const details = `<div style="text-align:left;font-size:0.95rem;line-height:1.6;">
            <p><strong>Type:</strong> ${error.type}</p>
            <p><strong>Message:</strong> ${error.message}</p>
            <p><strong>Page:</strong> ${error.page}</p>
            <p><strong>Time:</strong> ${new Date(error.timestamp).toLocaleString()}</p>
            <p><strong>Stack:</strong> <code style="font-size:0.85rem;word-break:break-all;">${error.stack || 'N/A'}</code></p>
            <p><strong>User Agent:</strong> <span style="font-size:0.85rem;word-break:break-all;">${error.userAgent || 'N/A'}</span></p>
          </div>`;
          AdminUniModal.info('Error Details', details);
        }
      };
      
      window.resolveError = async function(errorId) {
        try {
          const response = await fetch(`/api/admin/errors/${errorId}/resolve`, {
            method: 'PUT',
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            showNotification('Error marked as resolved', 'success');
            await updateErrorTrackerStats();
            renderErrorsTable();
          }
        } catch (e) {
          showNotification('Failed to resolve error', 'error');
        }
      };
      
      // ========================================
      // A/B TESTING
      // ========================================
      let abTestingInitialized = false;
      function initABTesting() {
        if (abTestingInitialized) return;
        abTestingInitialized = true;
        
        document.getElementById('createTestBtn')?.addEventListener('click', () => {
          showCreateTestModal();
        });
        
        updateABTestingStats();
        renderABTests();
      }
      
      async function updateABTestingStats() {
        try {
          const response = await fetch('/api/admin/ab-testing', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('activeTests').textContent = stats.activeTests || 0;
            document.getElementById('completedTests').textContent = stats.completedTests || 0;
            document.getElementById('testParticipants').textContent = stats.totalParticipants || 0;
            document.getElementById('avgLift').textContent = `${stats.avgLift >= 0 ? '+' : ''}${(stats.avgLift || 0).toFixed(1)}%`;
            
            // Store tests for rendering
            window._abTests = data.tests || [];
          }
        } catch (e) {
          console.log('[Admin] A/B testing API unavailable');
          document.getElementById('activeTests').textContent = '0';
          document.getElementById('testParticipants').textContent = '0';
        }
      }
      
      function renderABTests() {
        const container = document.getElementById('abTestsList');
        if (!container) return;
        
        const tests = window._abTests || [];
        
        if (tests.length === 0) {
          container.innerHTML = '<div style="padding: 12px; background: white; border-radius: 8px; text-align: center; color: #6b7280;">No A/B tests configured</div>';
          return;
        }
        
        container.innerHTML = tests.map(test => `
          <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${test.name}</div>
                <div style="font-size: 0.85rem; color: #6b7280;">
                  Participants: ${test.participants || 0} | Conversions: ${test.conversions || 0} | Lift: ${(test.lift || 0) >= 0 ? '+' : ''}${(test.lift || 0).toFixed(1)}%
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="pill ${test.status === 'active' ? 'success' : test.status === 'completed' ? 'primary' : 'warning'}">${test.status}</span>
                ${test.status === 'active' ? `<button onclick="completeABTest('${test.id}')" style="padding: 6px 10px; background: #d1fae5; color: #059669; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"><i class="ri-check-line"></i> Complete</button>` : ''}
                <button onclick="deleteABTest('${test.id}')" style="padding: 6px 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"><i class="ri-delete-bin-line"></i></button>
              </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 12px;">
              ${test.variants?.map((v, i) => `
                <div style="flex: 1; padding: 8px 12px; background: ${i === 0 ? '#f3f4f6' : '#eff6ff'}; border-radius: 6px;">
                  <div style="font-weight: 500; font-size: 0.9rem;">${v.name || `Variant ${v.id}`}</div>
                  <div style="font-size: 0.8rem; color: #6b7280;">Weight: ${(v.weight * 100).toFixed(0)}% | Views: ${v.views || 0}</div>
                </div>
              `).join('') || ''}
            </div>
          </div>
        `).join('');
      }
      
      function showCreateTestModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
              <h3><i class="ri-test-tube-line"></i> Create A/B Test</h3>
              <button type="button" class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">
              <form id="createTestForm">
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Test Name
                  <input type="text" id="testName" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </label>
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Variant A (Control)
                  <input type="text" id="variantA" placeholder="Original version" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </label>
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Variant B (Test)
                  <input type="text" id="variantB" placeholder="New version" required style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </label>
                <label style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                  Traffic Split (%)
                  <input type="number" id="trafficSplit" value="50" min="0" max="100" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;" />
                </label>
              </form>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" class="secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button type="button" class="primary" onclick="createABTest()">Create Test</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      window.createABTest = async function() {
        const name = document.getElementById('testName').value;
        const variantA = document.getElementById('variantA').value;
        const variantB = document.getElementById('variantB').value;
        const split = document.getElementById('trafficSplit').value;
        
        try {
          const response = await fetch('/api/admin/ab-testing', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name,
              variants: [
                { id: 'A', name: variantA, weight: (100 - parseInt(split)) / 100 },
                { id: 'B', name: variantB, weight: parseInt(split) / 100 }
              ]
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            document.querySelector('.modal-overlay').remove();
            await updateABTestingStats();
            renderABTests();
            showNotification(`A/B Test "${name}" created successfully`, 'success');
          } else {
            showNotification(data.error || 'Failed to create test', 'error');
          }
        } catch (e) {
          showNotification('Failed to create A/B test', 'error');
        }
      };
      
      window.completeABTest = async function(testId) {
        try {
          const response = await fetch(`/api/admin/ab-testing/${testId}/complete`, {
            method: 'PUT',
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            showNotification(`Test completed. Winner: ${data.winner || 'Inconclusive'}`, 'success');
            await updateABTestingStats();
            renderABTests();
          }
        } catch (e) {
          showNotification('Failed to complete test', 'error');
        }
      };
      
      window.deleteABTest = async function(testId) {
        const confirmed = await AdminUniModal.danger('Delete A/B Test', 'Are you sure you want to delete this A/B test? All associated data will be lost.', 'Delete', 'Cancel');
        if (!confirmed) return;
        
        try {
          const response = await fetch(`/api/admin/ab-testing/${testId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await response.json();
          
          if (data.success) {
            showNotification('A/B test deleted', 'success');
            await updateABTestingStats();
            renderABTests();
          }
        } catch (e) {
          showNotification('Failed to delete test', 'error');
        }
      };
      
      // ========================================
      // PERFORMANCE OPTIMIZER
      // ========================================
      let performanceOptimizerInitialized = false;
      function initPerformanceOptimizer() {
        if (performanceOptimizerInitialized) return;
        performanceOptimizerInitialized = true;
        
        document.getElementById('analyzePerformanceBtn')?.addEventListener('click', async () => {
          showNotification('Analyzing performance...', 'info');
          
          try {
            const response = await fetch('/api/admin/performance/analyze', {
              method: 'POST',
              credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
              showNotification(`Analysis complete! Score: ${data.analysis.overallScore}`, 'success');
              await updatePerformanceStats();
            }
          } catch (e) {
            showNotification('Analysis failed', 'error');
          }
        });
        
        updatePerformanceStats();
      }
      
      async function updatePerformanceStats() {
        try {
          const response = await fetch('/api/admin/performance', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('perfScore').textContent = Math.round(stats.avgScore || 92);
            document.getElementById('avgLoadTime').textContent = `${(stats.avgLoadTime || 1.2).toFixed(1)}s`;
            document.getElementById('pageSize').textContent = `${(stats.avgPageSize || 2.5).toFixed(1)} MB`;
            document.getElementById('numRequests').textContent = stats.avgRequests || 45;
            
            // Render performance history
            renderPerformanceHistory(data.metrics || []);
          }
        } catch (e) {
          // Fallback to browser performance data
          if (window.performance && window.performance.timing) {
            const loadTime = (window.performance.timing.loadEventEnd - window.performance.timing.navigationStart) / 1000;
            document.getElementById('avgLoadTime').textContent = `${loadTime.toFixed(1)}s`;
          }
        }
      }
      
      function renderPerformanceHistory(metrics) {
        const container = document.getElementById('performanceHistory');
        if (!container) return;
        
        if (metrics.length === 0) return;
        
        container.innerHTML = `
          <div style="padding: 12px; background: white; border-radius: 8px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px;">Recent Metrics</h4>
            ${metrics.slice(-5).reverse().map(m => `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span>${m.page || 'Unknown'}</span>
                <span style="color: ${m.score >= 80 ? '#10b981' : m.score >= 60 ? '#f59e0b' : '#ef4444'};">${m.score}/100</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      // ========================================
      // PWA MANAGER
      // ========================================
      let pwaManagerInitialized = false;
      function initPWAManager() {
        if (pwaManagerInitialized) return;
        pwaManagerInitialized = true;
        
        // PWA toggles - save to backend
        document.getElementById('pwaEnabled')?.addEventListener('change', async (e) => {
          await updatePWASettings({ pwaEnabled: e.target.checked });
          showNotification(`PWA ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('pushNotifications')?.addEventListener('change', async (e) => {
          if (e.target.checked && 'Notification' in window) {
            Notification.requestPermission();
          }
          await updatePWASettings({ pushNotifications: e.target.checked });
          showNotification(`Push notifications ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('offlineMode')?.addEventListener('change', async (e) => {
          await updatePWASettings({ offlineMode: e.target.checked });
          showNotification(`Offline mode ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('autoUpdate')?.addEventListener('change', async (e) => {
          await updatePWASettings({ autoUpdate: e.target.checked });
          showNotification(`Auto update ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        updatePWAStats();
      }
      
      async function updatePWASettings(settings) {
        try {
          await fetch('/api/admin/pwa/settings', {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
        } catch (e) {
          console.error('Failed to update PWA settings:', e);
        }
      }
      
      async function updatePWAStats() {
        try {
          const response = await fetch('/api/admin/pwa', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('pwaInstalls').textContent = stats.installs || 0;
            document.getElementById('pushSubscribers').textContent = stats.pushSubscribers || 0;
            document.getElementById('cacheSize').textContent = `${(stats.cacheSize || 0).toFixed(1)} MB`;
            document.getElementById('offlineReady').textContent = stats.offlineReady ? 'Yes' : 'No';
            
            // Update toggles based on saved settings
            if (data.settings) {
              const pwa = document.getElementById('pwaEnabled');
              const push = document.getElementById('pushNotifications');
              const offline = document.getElementById('offlineMode');
              const autoUpd = document.getElementById('autoUpdate');
              if (pwa) pwa.checked = data.settings.pwaEnabled !== false;
              if (push) push.checked = data.settings.pushNotifications !== false;
              if (offline) offline.checked = data.settings.offlineMode !== false;
              if (autoUpd) autoUpd.checked = data.settings.autoUpdate !== false;
            }
          }
        } catch (e) {
          // Fallback to browser data
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              document.getElementById('offlineReady').textContent = registrations.length > 0 ? 'Yes' : 'No';
            });
          }
          
          if ('storage' in navigator && 'estimate' in navigator.storage) {
            navigator.storage.estimate().then(estimate => {
              const sizeInMB = (estimate.usage / (1024 * 1024)).toFixed(1);
              document.getElementById('cacheSize').textContent = `${sizeInMB} MB`;
            });
          }
        }
      }
      
      // ========================================
      // EMOTION AI
      // ========================================
      let emotionAIInitialized = false;
      function initEmotionAI() {
        // Prevent duplicate initialization
        if (emotionAIInitialized) return;
        emotionAIInitialized = true;
        
        // Emotion AI toggles - save to backend
        document.getElementById('facialDetection')?.addEventListener('change', async (e) => {
          await updateEmotionAIConfig({ facialDetection: e.target.checked });
          showNotification(`Facial detection ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('textSentiment')?.addEventListener('change', async (e) => {
          await updateEmotionAIConfig({ textSentiment: e.target.checked });
          showNotification(`Text sentiment ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('behaviorAnalysis')?.addEventListener('change', async (e) => {
          await updateEmotionAIConfig({ behaviorAnalysis: e.target.checked });
          showNotification(`Behavior analysis ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('adaptiveUx')?.addEventListener('change', async (e) => {
          await updateEmotionAIConfig({ adaptiveUx: e.target.checked });
          showNotification(`Adaptive UX ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        updateEmotionAIStats();
      }
      
      async function updateEmotionAIConfig(config) {
        try {
          await fetch('/api/admin/emotion-ai/config', {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });
        } catch (e) {
          console.error('Failed to update Emotion AI config:', e);
        }
      }
      
      async function updateEmotionAIStats() {
        try {
          const response = await fetch('/api/admin/emotion-ai', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('emotionDetections').textContent = stats.totalDetections || 0;
            document.getElementById('uxAdaptations').textContent = stats.adaptations || 0;
            document.getElementById('happyUsers').textContent = `${Math.round((stats.happyUsersPercent || 68))}%`;
            document.getElementById('sentimentScore').textContent = (stats.avgSentiment || 0.7).toFixed(1);
            
            // Update toggles based on saved config
            if (data.config) {
              const facial = document.getElementById('facialDetection');
              const text = document.getElementById('textSentiment');
              const behavior = document.getElementById('behaviorAnalysis');
              const adaptive = document.getElementById('adaptiveUx');
              if (facial) facial.checked = data.config.facialDetection !== false;
              if (text) text.checked = data.config.textSentiment !== false;
              if (behavior) behavior.checked = data.config.behaviorAnalysis !== false;
              if (adaptive) adaptive.checked = data.config.adaptiveUx !== false;
            }
            
            // Render emotion distribution
            renderEmotionDistribution(data.distribution || {});
          }
        } catch (e) {
          console.log('[Admin] Emotion AI API unavailable');
        }
      }
      
      function renderEmotionDistribution(distribution) {
        const container = document.getElementById('emotionDistribution');
        if (!container) return;
        
        const emotions = Object.entries(distribution);
        if (emotions.length === 0) return;
        
        container.innerHTML = `
          <div style="padding: 12px; background: white; border-radius: 8px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px;">Emotion Distribution</h4>
            ${emotions.map(([emotion, percent]) => `
              <div style="margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="text-transform: capitalize;">${emotion}</span>
                  <span>${percent.toFixed(1)}%</span>
                </div>
                <div style="height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden;">
                  <div style="height: 100%; width: ${percent}%; background: ${emotion === 'happy' ? '#10b981' : emotion === 'sad' ? '#3b82f6' : emotion === 'angry' ? '#ef4444' : '#f59e0b'}; border-radius: 4px;"></div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      // ========================================
      // BIOMETRIC AUTH (Already has real API)
      // ========================================
      let allBiometricUsers = [];
      
      function initBiometricAuth() {
        updateBiometricStats();
        loadBiometricUsers();
      }
      
      async function updateBiometricStats() {
        try {
          const response = await fetch('/api/users/biometric/summary', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            document.getElementById('biometricUsers').textContent = data.totalEnabled || 0;
            document.getElementById('biometricLogins').textContent = data.loginsToday || 0;
            document.getElementById('avgLoginTime').textContent = `${(data.avgLoginTime || 0.8).toFixed(1)}s`;
            document.getElementById('biometricSuccess').textContent = `${(data.successRate || 98.5).toFixed(1)}%`;
          }
        } catch (e) {
          console.log('[Admin] Biometric stats unavailable');
        }
      }

      async function loadBiometricUsers() {
        try {
          const response = await fetch('/api/users/biometric/summary', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            allBiometricUsers = data.users || [];
            document.getElementById('biometricUsers').textContent = data.totalEnabled || 0;
            renderBiometricUsersList();
          }
        } catch (error) {
          console.error('Error loading biometric users:', error);
          document.getElementById('biometricUsersList').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #dc2626;">
              <i class="ri-error-warning-line" style="font-size: 2rem;"></i>
              <p style="margin: 16px 0 0;">Failed to load biometric users</p>
            </div>
          `;
        }
      }

      function renderBiometricUsersList() {
        const container = document.getElementById('biometricUsersList');
        if (allBiometricUsers.length === 0) {
          container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: #6b7280;">
              <i class="ri-fingerprint-line" style="font-size: 2rem; color: #d1d5db;"></i>
              <p style="margin: 16px 0 0;">No users with biometric authentication</p>
            </div>
          `;
          return;
        }

        container.innerHTML = allBiometricUsers.map(user => `
          <div style="display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f3f4f6; gap: 12px; flex-wrap: wrap;" data-user-id="${user.id}">
            <div style="width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">
              ${user.name ? user.name.charAt(0).toUpperCase() : 'U'}
            </div>
            <div style="flex: 1; min-width: 120px;">
              <div style="font-weight: 600; color: #1f2937;">${user.name || 'Unknown'}</div>
              <div style="font-size: 0.85rem; color: #6b7280; word-break: break-all;">${user.email}</div>
            </div>
            <div style="text-align: center; padding: 0 12px;">
              <div style="font-size: 1.25rem; font-weight: 700; color: ${user.biometricEnabled ? '#10b981' : '#9ca3af'};">${user.credentialCount || 0}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">Credentials</div>
            </div>
            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
              <span style="padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; ${user.biometricEnabled ? 'background: #d1fae5; color: #059669;' : 'background: #f3f4f6; color: #6b7280;'}">
                ${user.biometricEnabled ? 'Enabled' : 'Disabled'}
              </span>
              ${user.biometricResetRequired ? '<span style="padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: #fef3c7; color: #b45309;">Reset Required</span>' : ''}
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap; width: 100%; margin-top: 8px; justify-content: flex-end;" class="biometric-actions">
              <button onclick="resetUserBiometric('${user.id}')" style="padding: 6px 10px; background: #fef3c7; color: #b45309; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Require re-authentication">
                <i class="ri-restart-line"></i> Reset
              </button>
              <button onclick="clearUserBiometric('${user.id}')" style="padding: 6px 10px; background: #e0e7ff; color: #4f46e5; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Clear all credentials">
                <i class="ri-eraser-line"></i> Clear
              </button>
              <button onclick="deleteUserBiometric('${user.id}', '${(user.name || user.email || '').replace(/'/g, "\\'")}')" style="padding: 6px 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Remove biometric data (user account remains)">
                <i class="ri-fingerprint-line"></i> Remove
              </button>
            </div>
          </div>
        `).join('');
      }

      function filterBiometricUsers() {
        const search = document.getElementById('biometricUserSearch')?.value.toLowerCase() || '';
        const container = document.getElementById('biometricUsersList');
        const rows = container.querySelectorAll('[data-user-id]');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? 'flex' : 'none';
        });
      }

      async function resetUserBiometric(userId) {
        const confirmed = await AdminUniModal.confirm('Reset Biometric Auth', 'This will require the user to re-authenticate with their password before using biometric login again. Continue?', { confirmText: 'Reset', cancelText: 'Cancel' });
        if (!confirmed) return;
        
        try {
          const response = await fetch(`/api/users/${userId}/biometric/reset`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification('Biometric reset required for user', 'success');
            loadBiometricUsers();
          } else {
            showNotification(data.error || 'Failed to reset biometric', 'error');
          }
        } catch (error) {
          console.error('Reset biometric error:', error);
          showNotification('Error resetting biometric', 'error');
        }
      }

      async function clearUserBiometric(userId) {
        const confirmed = await AdminUniModal.danger('Delete All Biometrics', 'This will DELETE all biometric credentials for this user. They will need to register again. Continue?', 'Delete All');
        if (!confirmed) return;
        
        try {
          const response = await fetch(`/api/users/${userId}/biometric/all`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification('All biometric credentials cleared', 'success');
            loadBiometricUsers();
          } else {
            showNotification(data.error || 'Failed to clear biometrics', 'error');
          }
        } catch (error) {
          console.error('Clear biometric error:', error);
          showNotification('Error clearing biometrics', 'error');
        }
      }

      async function deleteUserBiometric(userId, userName) {
        const confirmed = await AdminUniModal.danger(
          'Remove Biometric Data', 
          `This will remove "${userName}" from the Biometric Authentication section by deleting all their biometric credentials. The user account will remain intact. They can register their biometric again later. Continue?`, 
          'Remove Biometric'
        );
        if (!confirmed) return;
        
        try {
          // Delete biometric data only (user account remains)
          const response = await fetch(`/api/users/${userId}/biometric/delete`, {
            method: 'DELETE',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification(`Biometric data for "${userName}" removed. User can re-register biometrics later.`, 'success');
            // Reload fresh data from API to ensure UI is in sync
            await loadBiometricUsers();
          } else {
            showNotification(data.error || 'Failed to remove biometric data', 'error');
          }
        } catch (error) {
          console.error('Delete biometric error:', error);
          showNotification('Error removing biometric data', 'error');
        }
      }

      // ========================================
      // DELETED USERS
      // ========================================
      let allDeletedUsers = [];

      async function loadDeletedUsers() {
        try {
          const response = await fetch('/api/users/deleted/all', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            allDeletedUsers = data.deletedUsers || [];
            document.getElementById('deletedUserCount').innerHTML = `<i class="ri-user-unfollow-line"></i> Deleted users: ${allDeletedUsers.length}`;
            renderDeletedUsersList();
          }
        } catch (error) {
          console.error('Error loading deleted users:', error);
          document.getElementById('deletedUsersBody').innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #dc2626;">
                <i class="ri-error-warning-line" style="font-size: 2rem;"></i>
                <p style="margin: 16px 0 0;">Failed to load deleted users</p>
              </td>
            </tr>
          `;
        }
      }

      function renderDeletedUsersList() {
        const tbody = document.getElementById('deletedUsersBody');
        
        if (allDeletedUsers.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                <i class="ri-user-smile-line" style="font-size: 2rem; color: #10b981;"></i>
                <p style="margin: 16px 0 0;">No deleted users</p>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = allDeletedUsers.map(user => `
          <tr data-deleted-id="${user.deletedId}">
            <td style="font-family: monospace; font-size: 0.85rem; color: #6b7280;">${user.originalId || 'N/A'}</td>
            <td>
              <div style="font-weight: 600;">${user.userData?.name || user.userData?.firstName || 'Unknown'}</div>
            </td>
            <td>${user.userData?.email || 'N/A'}</td>
            <td>${user.userData?.phone || 'N/A'}</td>
            <td style="white-space: nowrap;">${new Date(user.deletedAt).toLocaleDateString()}</td>
            <td>
              <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background: ${user.deletionReason === 'admin_deleted' ? '#fee2e2' : '#fef3c7'}; color: ${user.deletionReason === 'admin_deleted' ? '#dc2626' : '#b45309'};">
                ${user.deletionReason === 'admin_deleted' ? 'Admin Deleted' : 'Self Deleted'}
              </span>
            </td>
            <td>
              <div style="display: flex; gap: 6px;">
                <button onclick="viewDeletedUser('${user.deletedId}')" style="padding: 6px 10px; background: #eff6ff; color: #3b82f6; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                  <i class="ri-eye-line"></i> View
                </button>
                <button onclick="permanentlyDeleteUser('${user.deletedId}')" style="padding: 6px 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                  <i class="ri-delete-bin-line"></i> Delete
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function filterDeletedUsers() {
        const search = document.getElementById('deletedUserSearch')?.value.toLowerCase() || '';
        const rows = document.querySelectorAll('#deletedUsersBody tr[data-deleted-id]');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(search) ? '' : 'none';
        });
      }

      async function viewDeletedUser(deletedId) {
        try {
          const response = await fetch(`/api/users/deleted/${deletedId}`, { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const user = data.deletedUser;
            const details = `<div style="text-align:left;font-size:0.95rem;line-height:1.8;">
              <p><strong>Name:</strong> ${user.userData?.name || user.userData?.firstName || 'Unknown'}</p>
              <p><strong>Email:</strong> ${user.userData?.email || 'N/A'}</p>
              <p><strong>Phone:</strong> ${user.userData?.phone || 'N/A'}</p>
              <p><strong>Deleted:</strong> ${new Date(user.deletedAt).toLocaleString()}</p>
              <p><strong>Reason:</strong> ${user.deletionReason || 'Unknown'}</p>
              <p><strong>Deleted By:</strong> ${user.deletedBy || 'Self'}</p>
              <hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb;">
              <p><strong>Orders:</strong> ${user.userData?.ordersCount || 0}</p>
              <p><strong>Addresses:</strong> ${user.userData?.addressesCount || 0}</p>
              <p><strong>Biometric Credentials:</strong> ${user.userData?.biometricCredentials?.length || 0}</p>
            </div>`;
            AdminUniModal.info('Deleted User Details', details);
          } else {
            showNotification(data.error || 'Failed to load user details', 'error');
          }
        } catch (error) {
          console.error('View deleted user error:', error);
          showNotification('Error loading user details', 'error');
        }
      }

      async function permanentlyDeleteUser(deletedId) {
        const confirmed = await AdminUniModal.danger('Permanently Delete User', 'This will PERMANENTLY delete all data for this user. This action cannot be undone!', 'Delete Forever', 'Cancel');
        if (!confirmed) return;
        
        try {
          const response = await fetch(`/api/users/deleted/${deletedId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification('User permanently deleted', 'success');
            loadDeletedUsers();
          } else {
            showNotification(data.error || 'Failed to delete user', 'error');
          }
        } catch (error) {
          console.error('Permanent delete error:', error);
          showNotification('Error deleting user', 'error');
        }
      }

      function downloadDeletedUsersCSV() {
        if (allDeletedUsers.length === 0) {
          showNotification('No deleted users to export', 'warning');
          return;
        }
        
        const headers = ['Original ID', 'Name', 'Email', 'Phone', 'Deleted Date', 'Reason', 'Deleted By'];
        const rows = allDeletedUsers.map(u => [
          u.originalId || '',
          u.userData?.name || u.userData?.firstName || '',
          u.userData?.email || '',
          u.userData?.phone || '',
          new Date(u.deletedAt).toLocaleDateString(),
          u.deletionReason || '',
          u.deletedBy || 'Self'
        ]);
        
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deleted_users_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      // ========================================
      // NEURAL COMMERCE
      // ========================================
      function initNeuralCommerce() {
        // Neural toggles - save to backend
        document.getElementById('intentPrediction')?.addEventListener('change', async (e) => {
          await updateNeuralConfig({ intentPrediction: e.target.checked });
          showNotification(`Intent prediction ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('eyeTracking')?.addEventListener('change', async (e) => {
          await updateNeuralConfig({ eyeTracking: e.target.checked });
          showNotification(`Eye tracking ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
        });
        
        document.getElementById('brainState')?.addEventListener('change', async (e) => {
          await updateNeuralConfig({ brainState: e.target.checked });
          showNotification(`Brain state tracking ${e.target.checked ? 'enabled' : 'disabled'}`, 'success');
        });
        
        document.getElementById('bciReady')?.addEventListener('change', async (e) => {
          await updateNeuralConfig({ bciReady: e.target.checked });
          showNotification(`BCI integration ${e.target.checked ? 'ready' : 'disabled'}`, 'info');
        });
        
        updateNeuralStats();
      }
      
      async function updateNeuralConfig(config) {
        try {
          await fetch('/api/admin/neural-commerce/config', {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });
        } catch (e) {
          console.error('Failed to update Neural Commerce config:', e);
        }
      }
      
      async function updateNeuralStats() {
        try {
          const response = await fetch('/api/admin/neural-commerce', { credentials: 'include' });
          const data = await response.json();
          
          if (data.success) {
            const stats = data.stats;
            document.getElementById('intentPredictions').textContent = stats.totalPredictions || 0;
            document.getElementById('purchaseIntents').textContent = stats.purchaseIntents || 0;
            document.getElementById('avgAttention').textContent = `${Math.round(stats.avgAttention || 75)}%`;
            document.getElementById('neuralAccuracy').textContent = `${Math.round(stats.accuracy || 82)}%`;
            
            // Update toggles based on saved config
            if (data.config) {
              const intent = document.getElementById('intentPrediction');
              const eye = document.getElementById('eyeTracking');
              const brain = document.getElementById('brainState');
              const bci = document.getElementById('bciReady');
              if (intent) intent.checked = data.config.intentPrediction !== false;
              if (eye) eye.checked = data.config.eyeTracking !== false;
              if (brain) brain.checked = data.config.brainState !== false;
              if (bci) bci.checked = data.config.bciReady !== false;
            }
            
            // Render predictions list
            renderNeuralPredictions(data.recentPredictions || []);
          }
        } catch (e) {
          console.log('[Admin] Neural Commerce API unavailable');
        }
      }
      
      function renderNeuralPredictions(predictions) {
        const container = document.getElementById('neuralPredictions');
        if (!container) return;
        
        if (predictions.length === 0) return;
        
        container.innerHTML = `
          <div style="padding: 12px; background: white; border-radius: 8px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px;">Recent Predictions</h4>
            ${predictions.slice(0, 5).map(p => `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                <span>${p.intent || 'Unknown'}</span>
                <span style="color: ${p.confidence >= 0.8 ? '#10b981' : '#f59e0b'};">${(p.confidence * 100).toFixed(0)}%</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      // Update all advanced systems stats every 30 seconds with staggered timing
      // This prevents a burst of network requests and UI micro-freezes
      setInterval(async () => {
        const tasks = [
          updateRealtimeStats,
          updateSecurityStats,
          updateMLStats,
          updateErrorTrackerStats,
          updateABTestingStats,
          updatePerformanceStats,
          updatePWAStats,
          updateEmotionAIStats,
          updateBiometricStats,
          updateNeuralStats
        ];
        
        for (let i = 0; i < tasks.length; i++) {
          // Stagger each task by 500ms
          setTimeout(async () => {
            try {
              await tasks[i]();
            } catch (e) {
              console.warn(`[Admin] Staggered task ${i} failed:`, e.message);
            }
          }, i * 500);
        }
      }, 30000);
      
      // ========================================
      // BACK TO TOP BUTTON FUNCTIONALITY
      // ========================================
      const backToTopBtn = document.getElementById('backToTop');
      const mainContent = document.querySelector('.admin-content');
      
      function handleScroll() {
        // Check both window scroll and main content scroll
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || 
                          (mainContent ? mainContent.scrollTop : 0);
        
        if (scrollTop > 300) {
          backToTopBtn?.classList.add('visible');
        } else {
          backToTopBtn?.classList.remove('visible');
        }
      }
      
      function scrollToTop() {
        // Smooth scroll to top for both window and main content
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if (mainContent) {
          mainContent.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      
      // Listen to both window and main content scroll
      window.addEventListener('scroll', handleScroll, { passive: true });
      if (mainContent) {
        mainContent.addEventListener('scroll', handleScroll, { passive: true });
      }
      
      // Make scrollToTop globally available
      window.scrollToTop = scrollToTop;
    </script>

    <!--  NEXT-GENERATION ADVANCED SYSTEMS -->
    <!-- Real-time & Communication -->
    <script src="assets/js/realtime-manager.js"></script>

    <!-- Security & Error Tracking -->
    <script src="assets/js/security-manager.js"></script>
    <script src="assets/js/error-tracker.js"></script>

    <!-- Machine Learning & Personalization -->
    <script src="assets/js/ml-engine.js"></script>

    <!-- User Experience -->
    <script src="assets/js/form-manager.js"></script>
    <script src="assets/js/image-optimizer.js"></script>
    <script src="assets/js/i18n-manager.js"></script>

    <!-- Experimentation -->
    <script src="assets/js/ab-testing.js"></script>

    <!--  WORLD-FIRST CUTTING-EDGE TECHNOLOGIES -->
    <!-- AI & Biometrics -->
    <script src="assets/js/emotion-ai.js"></script>
    <script src="assets/js/biometric-auth.js"></script>
    
    <!-- Future Tech -->
    <script src="assets/js/neural-commerce.js"></script>

    <script src="assets/js/advanced-cache.js"></script>
    <script src="assets/js/state-manager.js"></script>
    <script src="assets/js/performance-optimizer.js"></script>
    <script src="assets/js/pwa-manager.js"></script>
    <!-- console-block.js disabled for admin page -->
    <!-- auto-debugger.js disabled for admin page -->
    <script src="assets/js/main.js"></script>
  </body>
</html>
